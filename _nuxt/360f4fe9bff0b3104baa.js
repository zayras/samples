(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{215:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return OrbitControls})),void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){var t=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var output=Object(e),r=1;r<arguments.length;r++){var source=t[r];if(null!=source)for(var n in source)Object.prototype.hasOwnProperty.call(source,n)&&(output[n]=source[n])}return output});var _Math={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){for(var e=[],i=0;i<256;i++)e[i]=(i<16?"0":"")+i.toString(16);return function(){var t=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0,o=4294967295*Math.random()|0;return(e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&r]+e[r>>8&255]+"-"+e[r>>16&15|64]+e[r>>24&255]+"-"+e[63&n|128]+e[n>>8&255]+"-"+e[n>>16&255]+e[n>>24&255]+e[255&o]+e[o>>8&255]+e[o>>16&255]+e[o>>24&255]).toUpperCase()}}(),clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,n,o){return n+(e-t)*(o-n)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*_Math.DEG2RAD},radToDeg:function(e){return e*_Math.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}},vector,matrix,x,y,z,zero,one,v1,min,max,quaternion,q;function Matrix4(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("Matrix4: the constructor no longer reads arguments. use .set() instead.")}function Vector3(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}function Quaternion(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==n?n:1}function EventDispatcher(){}function Euler(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._order=n||Euler.DefaultOrder}function Layers(){this.mask=1}function Matrix3(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("Matrix3: the constructor no longer reads arguments. use .set() instead.")}Object.assign(Matrix4.prototype,{isMatrix4:!0,set:function(e,t,r,n,o,l,c,h,d,f,m,v,y,x,w,M){var S=this.elements;return S[0]=e,S[4]=t,S[8]=r,S[12]=n,S[1]=o,S[5]=l,S[9]=c,S[13]=h,S[2]=d,S[6]=f,S[10]=m,S[14]=v,S[3]=y,S[7]=x,S[11]=w,S[15]=M,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new Matrix4).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractBasis:function(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this},extractRotation:(v1=new Vector3,function(e){var t=this.elements,r=e.elements,n=1/v1.setFromMatrixColumn(e,0).length(),o=1/v1.setFromMatrixColumn(e,1).length(),l=1/v1.setFromMatrixColumn(e,2).length();return t[0]=r[0]*n,t[1]=r[1]*n,t[2]=r[2]*n,t[3]=0,t[4]=r[4]*o,t[5]=r[5]*o,t[6]=r[6]*o,t[7]=0,t[8]=r[8]*l,t[9]=r[9]*l,t[10]=r[10]*l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}),makeRotationFromEuler:function(e){e&&e.isEuler||console.error("Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,n=e.y,o=e.z,a=Math.cos(r),b=Math.sin(r),l=Math.cos(n),c=Math.sin(n),h=Math.cos(o),d=Math.sin(o);if("XYZ"===e.order){var f=a*h,m=a*d,v=b*h,y=b*d;t[0]=l*h,t[4]=-l*d,t[8]=c,t[1]=m+v*c,t[5]=f-y*c,t[9]=-b*l,t[2]=y-f*c,t[6]=v+m*c,t[10]=a*l}else if("YXZ"===e.order){var x=l*h,w=l*d,M=c*h,S=c*d;t[0]=x+S*b,t[4]=M*b-w,t[8]=a*c,t[1]=a*d,t[5]=a*h,t[9]=-b,t[2]=w*b-M,t[6]=S+x*b,t[10]=a*l}else if("ZXY"===e.order){x=l*h,w=l*d,M=c*h,S=c*d;t[0]=x-S*b,t[4]=-a*d,t[8]=M+w*b,t[1]=w+M*b,t[5]=a*h,t[9]=S-x*b,t[2]=-a*c,t[6]=b,t[10]=a*l}else if("ZYX"===e.order){f=a*h,m=a*d,v=b*h,y=b*d;t[0]=l*h,t[4]=v*c-m,t[8]=f*c+y,t[1]=l*d,t[5]=y*c+f,t[9]=m*c-v,t[2]=-c,t[6]=b*l,t[10]=a*l}else if("YZX"===e.order){var A=a*l,T=a*c,_=b*l,L=b*c;t[0]=l*h,t[4]=L-A*d,t[8]=_*d+T,t[1]=d,t[5]=a*h,t[9]=-b*h,t[2]=-c*h,t[6]=T*d+_,t[10]=A-L*d}else if("XZY"===e.order){A=a*l,T=a*c,_=b*l,L=b*c;t[0]=l*h,t[4]=-d,t[8]=c*h,t[1]=A*d+L,t[5]=a*h,t[9]=T*d-_,t[2]=_*d-T,t[6]=b*h,t[10]=L*d+A}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:(zero=new Vector3(0,0,0),one=new Vector3(1,1,1),function(q){return this.compose(zero,q,one)}),lookAt:(x=new Vector3,y=new Vector3,z=new Vector3,function(e,t,r){var n=this.elements;return z.subVectors(e,t),0===z.lengthSq()&&(z.z=1),z.normalize(),x.crossVectors(r,z),0===x.lengthSq()&&(1===Math.abs(r.z)?z.x+=1e-4:z.z+=1e-4,z.normalize(),x.crossVectors(r,z)),x.normalize(),y.crossVectors(z,x),n[0]=x.x,n[4]=y.x,n[8]=z.x,n[1]=x.y,n[5]=y.y,n[9]=z.y,n[2]=x.z,n[6]=y.z,n[10]=z.z,this}),multiply:function(e,t){return void 0!==t?(console.warn("Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(a,b){var e=a.elements,t=b.elements,r=this.elements,n=e[0],o=e[4],l=e[8],c=e[12],h=e[1],d=e[5],f=e[9],m=e[13],v=e[2],y=e[6],x=e[10],w=e[14],M=e[3],S=e[7],A=e[11],T=e[15],_=t[0],L=t[4],C=t[8],N=t[12],P=t[1],E=t[5],D=t[9],F=t[13],R=t[2],O=t[6],B=t[10],I=t[14],U=t[3],V=t[7],k=t[11],G=t[15];return r[0]=n*_+o*P+l*R+c*U,r[4]=n*L+o*E+l*O+c*V,r[8]=n*C+o*D+l*B+c*k,r[12]=n*N+o*F+l*I+c*G,r[1]=h*_+d*P+f*R+m*U,r[5]=h*L+d*E+f*O+m*V,r[9]=h*C+d*D+f*B+m*k,r[13]=h*N+d*F+f*I+m*G,r[2]=v*_+y*P+x*R+w*U,r[6]=v*L+y*E+x*O+w*V,r[10]=v*C+y*D+x*B+w*k,r[14]=v*N+y*F+x*I+w*G,r[3]=M*_+S*P+A*R+T*U,r[7]=M*L+S*E+A*O+T*V,r[11]=M*C+S*D+A*B+T*k,r[15]=M*N+S*F+A*I+T*G,this},multiplyScalar:function(s){var e=this.elements;return e[0]*=s,e[4]*=s,e[8]*=s,e[12]*=s,e[1]*=s,e[5]*=s,e[9]*=s,e[13]*=s,e[2]*=s,e[6]*=s,e[10]*=s,e[14]*=s,e[3]*=s,e[7]*=s,e[11]*=s,e[15]*=s,this},applyToBufferAttribute:function(){var e=new Vector3;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],r=e[4],n=e[8],o=e[12],l=e[1],c=e[5],h=e[9],d=e[13],f=e[2],m=e[6],v=e[10],y=e[14];return e[3]*(+o*h*m-n*d*m-o*c*v+r*d*v+n*c*y-r*h*y)+e[7]*(+t*h*y-t*d*v+o*l*v-n*l*y+n*d*f-o*h*f)+e[11]*(+t*d*m-t*c*y-o*l*m+r*l*y+o*c*f-r*d*f)+e[15]*(-n*c*f-t*h*m+t*c*v+n*l*m-r*l*v+r*h*f)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,n=e.elements,o=n[0],l=n[1],c=n[2],h=n[3],d=n[4],f=n[5],m=n[6],v=n[7],y=n[8],x=n[9],w=n[10],M=n[11],S=n[12],A=n[13],T=n[14],_=n[15],L=x*T*v-A*w*v+A*m*M-f*T*M-x*m*_+f*w*_,C=S*w*v-y*T*v-S*m*M+d*T*M+y*m*_-d*w*_,N=y*A*v-S*x*v+S*f*M-d*A*M-y*f*_+d*x*_,P=S*x*m-y*A*m-S*f*w+d*A*w+y*f*T-d*x*T,E=o*L+l*C+c*N+h*P;if(0===E){var D="Matrix4: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(D);return console.warn(D),this.identity()}var F=1/E;return r[0]=L*F,r[1]=(A*w*h-x*T*h-A*c*M+l*T*M+x*c*_-l*w*_)*F,r[2]=(f*T*h-A*m*h+A*c*v-l*T*v-f*c*_+l*m*_)*F,r[3]=(x*m*h-f*w*h-x*c*v+l*w*v+f*c*M-l*m*M)*F,r[4]=C*F,r[5]=(y*T*h-S*w*h+S*c*M-o*T*M-y*c*_+o*w*_)*F,r[6]=(S*m*h-d*T*h-S*c*v+o*T*v+d*c*_-o*m*_)*F,r[7]=(d*w*h-y*m*h+y*c*v-o*w*v-d*c*M+o*m*M)*F,r[8]=N*F,r[9]=(S*x*h-y*A*h-S*l*M+o*A*M+y*l*_-o*x*_)*F,r[10]=(d*A*h-S*f*h+S*l*v-o*A*v-d*l*_+o*f*_)*F,r[11]=(y*f*h-d*x*h-y*l*v+o*x*v+d*l*M-o*f*M)*F,r[12]=P*F,r[13]=(y*A*c-S*x*c+S*l*w-o*A*w-y*l*T+o*x*T)*F,r[14]=(S*f*c-d*A*c-S*l*m+o*A*m+d*l*T-o*f*T)*F,r[15]=(d*x*c-y*f*c+y*l*m-o*x*m-d*l*w+o*f*w)*F,this},scale:function(e){var t=this.elements,r=e.x,n=e.y,o=e.z;return t[0]*=r,t[4]*=n,t[8]*=o,t[1]*=r,t[5]*=n,t[9]*=o,t[2]*=r,t[6]*=n,t[10]*=o,t[3]*=r,t[7]*=n,t[11]*=o,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),s=Math.sin(e);return this.set(1,0,0,0,0,t,-s,0,0,s,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),s=Math.sin(e);return this.set(t,0,s,0,0,1,0,0,-s,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),s=Math.sin(e);return this.set(t,-s,0,0,s,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),s=Math.sin(t),n=1-r,o=e.x,l=e.y,c=e.z,h=n*o,d=n*l;return this.set(h*o+r,h*l-s*c,h*c+s*l,0,h*l+s*c,d*l+r,d*c-s*o,0,h*c-s*l,d*c+s*o,n*c*c+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},makeShear:function(e,t,r){return this.set(1,t,r,0,e,1,r,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,r){var n=this.elements,o=t._x,l=t._y,c=t._z,h=t._w,d=o+o,f=l+l,m=c+c,v=o*d,y=o*f,x=o*m,w=l*f,M=l*m,S=c*m,A=h*d,T=h*f,_=h*m,L=r.x,C=r.y,N=r.z;return n[0]=(1-(w+S))*L,n[1]=(y+_)*L,n[2]=(x-T)*L,n[3]=0,n[4]=(y-_)*C,n[5]=(1-(v+S))*C,n[6]=(M+A)*C,n[7]=0,n[8]=(x+T)*N,n[9]=(M-A)*N,n[10]=(1-(v+w))*N,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this},decompose:(vector=new Vector3,matrix=new Matrix4,function(e,t,r){var n=this.elements,o=vector.set(n[0],n[1],n[2]).length(),l=vector.set(n[4],n[5],n[6]).length(),c=vector.set(n[8],n[9],n[10]).length();this.determinant()<0&&(o=-o),e.x=n[12],e.y=n[13],e.z=n[14],matrix.copy(this);var h=1/o,d=1/l,f=1/c;return matrix.elements[0]*=h,matrix.elements[1]*=h,matrix.elements[2]*=h,matrix.elements[4]*=d,matrix.elements[5]*=d,matrix.elements[6]*=d,matrix.elements[8]*=f,matrix.elements[9]*=f,matrix.elements[10]*=f,t.setFromRotationMatrix(matrix),r.x=o,r.y=l,r.z=c,this}),makePerspective:function(e,t,r,n,o,l){void 0===l&&console.warn("Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var c=this.elements,h=2*o/(t-e),d=2*o/(r-n),a=(t+e)/(t-e),b=(r+n)/(r-n),f=-(l+o)/(l-o),m=-2*l*o/(l-o);return c[0]=h,c[4]=0,c[8]=a,c[12]=0,c[1]=0,c[5]=d,c[9]=b,c[13]=0,c[2]=0,c[6]=0,c[10]=f,c[14]=m,c[3]=0,c[7]=0,c[11]=-1,c[15]=0,this},makeOrthographic:function(e,t,r,n,o,l){var c=this.elements,h=1/(t-e),d=1/(r-n),p=1/(l-o),f=(t+e)*h,m=(r+n)*d,v=(l+o)*p;return c[0]=2*h,c[4]=0,c[8]=0,c[12]=-f,c[1]=0,c[5]=2*d,c[9]=0,c[13]=-m,c[2]=0,c[6]=0,c[10]=-2*p,c[14]=-v,c[3]=0,c[7]=0,c[11]=0,c[15]=1,this},equals:function(e){for(var t=this.elements,r=e.elements,i=0;i<16;i++)if(t[i]!==r[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<16;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}),Object.assign(Vector3.prototype,{isVector3:!0,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(s){return this.x+=s,this.y+=s,this.z+=s,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},addScaledVector:function(e,s){return this.x+=e.x*s,this.y+=e.y*s,this.z+=e.z*s,this},sub:function(e,t){return void 0!==t?(console.warn("Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(s){return this.x-=s,this.y-=s,this.z-=s,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},multiply:function(e,t){return void 0!==t?(console.warn("Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},applyEuler:(quaternion=new Quaternion,function(e){return e&&e.isEuler||console.error("Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(quaternion.setFromEuler(e))}),applyAxisAngle:function(){var e=new Quaternion;return function(t,r){return this.applyQuaternion(e.setFromAxisAngle(t,r))}}(),applyMatrix3:function(e){var t=this.x,r=this.y,n=this.z,o=e.elements;return this.x=o[0]*t+o[3]*r+o[6]*n,this.y=o[1]*t+o[4]*r+o[7]*n,this.z=o[2]*t+o[5]*r+o[8]*n,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,o=e.elements,l=1/(o[3]*t+o[7]*r+o[11]*n+o[15]);return this.x=(o[0]*t+o[4]*r+o[8]*n+o[12])*l,this.y=(o[1]*t+o[5]*r+o[9]*n+o[13])*l,this.z=(o[2]*t+o[6]*r+o[10]*n+o[14])*l,this},applyQuaternion:function(q){var e=this.x,t=this.y,r=this.z,n=q.x,o=q.y,l=q.z,c=q.w,h=c*e+o*r-l*t,d=c*t+l*e-n*r,f=c*r+n*t-o*e,m=-n*e-o*t-l*r;return this.x=h*c+m*-n+d*-l-f*-o,this.y=d*c+m*-o+f*-n-h*-l,this.z=f*c+m*-l+h*-o-d*-n,this},project:function(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)},unproject:function(){var e=new Matrix4;return function(t){return this.applyMatrix4(e.getInverse(t.projectionMatrix)).applyMatrix4(t.matrixWorld)}}(),transformDirection:function(e){var t=this.x,r=this.y,n=this.z,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*n,this.y=o[1]*t+o[5]*r+o[9]*n,this.z=o[2]*t+o[6]*r+o[10]*n,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:(min=new Vector3,max=new Vector3,function(e,t){return min.set(e,e,e),max.set(t,t,t),this.clamp(min,max)}),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},cross:function(e,t){return void 0!==t?(console.warn("Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t)):this.crossVectors(this,e)},crossVectors:function(a,b){var e=a.x,t=a.y,r=a.z,n=b.x,o=b.y,l=b.z;return this.x=t*l-r*o,this.y=r*n-e*l,this.z=e*o-t*n,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e=new Vector3;return function(t){return e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e=new Vector3;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(_Math.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return t*t+r*r+n*n},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(s){return this.setFromSphericalCoords(s.radius,s.phi,s.theta)},setFromSphericalCoords:function(e,t,r){var n=Math.sin(t)*e;return this.x=n*Math.sin(r),this.y=Math.cos(t)*e,this.z=n*Math.cos(r),this},setFromCylindrical:function(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)},setFromCylindricalCoords:function(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this},setFromMatrixPosition:function(e){var t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=n,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(Quaternion,{slerp:function(e,t,r,n){return r.copy(e).slerp(t,n)},slerpFlat:function(e,t,r,n,o,l,c){var h=r[n+0],d=r[n+1],f=r[n+2],m=r[n+3],v=o[l+0],y=o[l+1],x=o[l+2],w=o[l+3];if(m!==w||h!==v||d!==y||f!==x){var s=1-c,M=h*v+d*y+f*x+m*w,S=M>=0?1:-1,A=1-M*M;if(A>Number.EPSILON){var T=Math.sqrt(A),_=Math.atan2(T,M*S);s=Math.sin(s*_)/T,c=Math.sin(c*_)/T}var L=c*S;if(h=h*s+v*L,d=d*s+y*L,f=f*s+x*L,m=m*s+w*L,s===1-c){var C=1/Math.sqrt(h*h+d*d+f*f+m*m);h*=C,d*=C,f*=C,m*=C}}e[t]=h,e[t+1]=d,e[t+2]=f,e[t+3]=m}}),Object.defineProperties(Quaternion.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(Quaternion.prototype,{isQuaternion:!0,set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!e||!e.isEuler)throw new Error("Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e._x,n=e._y,o=e._z,l=e.order,c=Math.cos,h=Math.sin,d=c(r/2),f=c(n/2),m=c(o/2),v=h(r/2),y=h(n/2),x=h(o/2);return"XYZ"===l?(this._x=v*f*m+d*y*x,this._y=d*y*m-v*f*x,this._z=d*f*x+v*y*m,this._w=d*f*m-v*y*x):"YXZ"===l?(this._x=v*f*m+d*y*x,this._y=d*y*m-v*f*x,this._z=d*f*x-v*y*m,this._w=d*f*m+v*y*x):"ZXY"===l?(this._x=v*f*m-d*y*x,this._y=d*y*m+v*f*x,this._z=d*f*x+v*y*m,this._w=d*f*m-v*y*x):"ZYX"===l?(this._x=v*f*m-d*y*x,this._y=d*y*m+v*f*x,this._z=d*f*x-v*y*m,this._w=d*f*m+v*y*x):"YZX"===l?(this._x=v*f*m+d*y*x,this._y=d*y*m+v*f*x,this._z=d*f*x-v*y*m,this._w=d*f*m-v*y*x):"XZY"===l&&(this._x=v*f*m-d*y*x,this._y=d*y*m-v*f*x,this._z=d*f*x+v*y*m,this._w=d*f*m+v*y*x),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var r=t/2,s=Math.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(r),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var s,t=e.elements,r=t[0],n=t[4],o=t[8],l=t[1],c=t[5],h=t[9],d=t[2],f=t[6],m=t[10],v=r+c+m;return v>0?(s=.5/Math.sqrt(v+1),this._w=.25/s,this._x=(f-h)*s,this._y=(o-d)*s,this._z=(l-n)*s):r>c&&r>m?(s=2*Math.sqrt(1+r-c-m),this._w=(f-h)/s,this._x=.25*s,this._y=(n+l)/s,this._z=(o+d)/s):c>m?(s=2*Math.sqrt(1+c-r-m),this._w=(o-d)/s,this._x=(n+l)/s,this._y=.25*s,this._z=(h+f)/s):(s=2*Math.sqrt(1+m-r-c),this._w=(l-n)/s,this._x=(o+d)/s,this._y=(h+f)/s,this._z=.25*s),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new Vector3;return function(r,n){return void 0===t&&(t=new Vector3),(e=r.dot(n)+1)<1e-6?(e=0,Math.abs(r.x)>Math.abs(r.z)?t.set(-r.y,r.x,0):t.set(0,-r.z,r.y)):t.crossVectors(r,n),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),angleTo:function(q){return 2*Math.acos(Math.abs(_Math.clamp(this.dot(q),-1,1)))},rotateTowards:function(q,e){var t=this.angleTo(q);if(0===t)return this;var r=Math.min(1,e/t);return this.slerp(q,r),this},inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(q,p){return void 0!==p?(console.warn("Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(q,p)):this.multiplyQuaternions(this,q)},premultiply:function(q){return this.multiplyQuaternions(q,this)},multiplyQuaternions:function(a,b){var e=a._x,t=a._y,r=a._z,n=a._w,o=b._x,l=b._y,c=b._z,h=b._w;return this._x=e*h+n*o+t*c-r*l,this._y=t*h+n*l+r*o-e*c,this._z=r*h+n*c+e*l-t*o,this._w=n*h-e*o-t*l-r*c,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,n=this._y,o=this._z,l=this._w,c=l*e._w+r*e._x+n*e._y+o*e._z;if(c<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,c=-c):this.copy(e),c>=1)return this._w=l,this._x=r,this._y=n,this._z=o,this;var h=1-c*c;if(h<=Number.EPSILON){var s=1-t;return this._w=s*l+t*this._w,this._x=s*r+t*this._x,this._y=s*n+t*this._y,this._z=s*o+t*this._z,this.normalize()}var d=Math.sqrt(h),f=Math.atan2(d,c),m=Math.sin((1-t)*f)/d,v=Math.sin(t*f)/d;return this._w=l*m+this._w*v,this._x=r*m+this._x*v,this._y=n*m+this._y*v,this._z=o*m+this._z*v,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(EventDispatcher.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners[e];if(void 0!==r){var n=r.indexOf(t);-1!==n&&r.splice(n,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var r=t.slice(0),i=0,n=r.length;i<n;i++)r[i].call(this,e)}}}}),Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="XYZ",Object.defineProperties(Euler.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(Euler.prototype,{isEuler:!0,set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._order=n||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){var n=_Math.clamp,o=e.elements,l=o[0],c=o[4],h=o[8],d=o[1],f=o[5],m=o[9],v=o[2],y=o[6],x=o[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-m,x),this._z=Math.atan2(-c,l)):(this._x=Math.atan2(y,f),this._z=0)):"YXZ"===t?(this._x=Math.asin(-n(m,-1,1)),Math.abs(m)<.99999?(this._y=Math.atan2(h,x),this._z=Math.atan2(d,f)):(this._y=Math.atan2(-v,l),this._z=0)):"ZXY"===t?(this._x=Math.asin(n(y,-1,1)),Math.abs(y)<.99999?(this._y=Math.atan2(-v,x),this._z=Math.atan2(-c,f)):(this._y=0,this._z=Math.atan2(d,l))):"ZYX"===t?(this._y=Math.asin(-n(v,-1,1)),Math.abs(v)<.99999?(this._x=Math.atan2(y,x),this._z=Math.atan2(d,l)):(this._x=0,this._z=Math.atan2(-c,f))):"YZX"===t?(this._z=Math.asin(n(d,-1,1)),Math.abs(d)<.99999?(this._x=Math.atan2(-m,f),this._y=Math.atan2(-v,l)):(this._x=0,this._y=Math.atan2(h,x))):"XZY"===t?(this._z=Math.asin(-n(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(y,f),this._y=Math.atan2(h,l)):(this._x=Math.atan2(-m,x),this._y=0)):console.warn("Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==r&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new Matrix4;return function(q,t,r){return e.makeRotationFromQuaternion(q),this.setFromRotationMatrix(e,t,r)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:(q=new Quaternion,function(e){return q.setFromEuler(this),this.setFromQuaternion(q,e)}),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(Layers.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}}),Object.assign(Matrix3.prototype,{isMatrix3:!0,set:function(e,t,r,n,o,l,c,h,d){var f=this.elements;return f[0]=e,f[1]=n,f[2]=c,f[3]=t,f[4]=o,f[5]=h,f[6]=r,f[7]=l,f[8]=d,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new Vector3;return function(t){for(var i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix3(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(a,b){var e=a.elements,t=b.elements,r=this.elements,n=e[0],o=e[3],l=e[6],c=e[1],h=e[4],d=e[7],f=e[2],m=e[5],v=e[8],y=t[0],x=t[3],w=t[6],M=t[1],S=t[4],A=t[7],T=t[2],_=t[5],L=t[8];return r[0]=n*y+o*M+l*T,r[3]=n*x+o*S+l*_,r[6]=n*w+o*A+l*L,r[1]=c*y+h*M+d*T,r[4]=c*x+h*S+d*_,r[7]=c*w+h*A+d*L,r[2]=f*y+m*M+v*T,r[5]=f*x+m*S+v*_,r[8]=f*w+m*A+v*L,this},multiplyScalar:function(s){var e=this.elements;return e[0]*=s,e[3]*=s,e[6]*=s,e[1]*=s,e[4]*=s,e[7]*=s,e[2]*=s,e[5]*=s,e[8]*=s,this},determinant:function(){var e=this.elements,a=e[0],b=e[1],t=e[2],r=e[3],n=e[4],o=e[5],g=e[6],l=e[7],i=e[8];return a*n*i-a*o*l-b*r*i+b*o*g+t*r*l-t*n*g},getInverse:function(e,t){e&&e.isMatrix4&&console.error("Matrix3: .getInverse() no longer takes a Matrix4 argument.");var r=e.elements,n=this.elements,o=r[0],l=r[1],c=r[2],h=r[3],d=r[4],f=r[5],m=r[6],v=r[7],y=r[8],x=y*d-f*v,w=f*m-y*h,M=v*h-d*m,S=o*x+l*w+c*M;if(0===S){var A="Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(A);return console.warn(A),this.identity()}var T=1/S;return n[0]=x*T,n[1]=(c*v-y*l)*T,n[2]=(f*l-c*d)*T,n[3]=w*T,n[4]=(y*o-c*m)*T,n[5]=(c*h-f*o)*T,n[6]=M*T,n[7]=(l*m-v*o)*T,n[8]=(d*o-l*h)*T,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},setUvTransform:function(e,t,r,n,o,l,c){var h=Math.cos(o),s=Math.sin(o);this.set(r*h,r*s,-r*(h*l+s*c)+l+e,-n*s,n*h,-n*(-s*l+h*c)+c+t,0,0,1)},scale:function(e,t){var r=this.elements;return r[0]*=e,r[3]*=e,r[6]*=e,r[1]*=t,r[4]*=t,r[7]*=t,this},rotate:function(e){var t=Math.cos(e),s=Math.sin(e),r=this.elements,n=r[0],o=r[3],l=r[6],c=r[1],h=r[4],d=r[7];return r[0]=t*n+s*c,r[3]=t*o+s*h,r[6]=t*l+s*d,r[1]=-s*n+t*c,r[4]=-s*o+t*h,r[7]=-s*l+t*d,this},translate:function(e,t){var r=this.elements;return r[0]+=e*r[2],r[3]+=e*r[5],r[6]+=e*r[8],r[1]+=t*r[2],r[4]+=t*r[5],r[7]+=t*r[8],this},equals:function(e){for(var t=this.elements,r=e.elements,i=0;i<9;i++)if(t[i]!==r[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<9;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}});var REVISION="102",MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},CullFaceNone=0,CullFaceBack=1,CullFaceFront=2,CullFaceFrontBack=3,FrontFaceDirectionCW=0,FrontFaceDirectionCCW=1,BasicShadowMap=0,PCFShadowMap=1,PCFSoftShadowMap=2,FrontSide=0,BackSide=1,DoubleSide=2,FlatShading=1,SmoothShading=2,NoColors=0,FaceColors=1,VertexColors=2,NoBlending=0,NormalBlending=1,AdditiveBlending=2,SubtractiveBlending=3,MultiplyBlending=4,CustomBlending=5,AddEquation=100,SubtractEquation=101,ReverseSubtractEquation=102,MinEquation=103,MaxEquation=104,ZeroFactor=200,OneFactor=201,SrcColorFactor=202,OneMinusSrcColorFactor=203,SrcAlphaFactor=204,OneMinusSrcAlphaFactor=205,DstAlphaFactor=206,OneMinusDstAlphaFactor=207,DstColorFactor=208,OneMinusDstColorFactor=209,SrcAlphaSaturateFactor=210,NeverDepth=0,AlwaysDepth=1,LessDepth=2,LessEqualDepth=3,EqualDepth=4,GreaterEqualDepth=5,GreaterDepth=6,NotEqualDepth=7,MultiplyOperation=0,MixOperation=1,AddOperation=2,NoToneMapping=0,LinearToneMapping=1,ReinhardToneMapping=2,Uncharted2ToneMapping=3,CineonToneMapping=4,ACESFilmicToneMapping=5,UVMapping=300,CubeReflectionMapping=301,CubeRefractionMapping=302,EquirectangularReflectionMapping=303,EquirectangularRefractionMapping=304,SphericalReflectionMapping=305,CubeUVReflectionMapping=306,CubeUVRefractionMapping=307,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,NearestFilter=1003,NearestMipMapNearestFilter=1004,NearestMipMapLinearFilter=1005,LinearFilter=1006,LinearMipMapNearestFilter=1007,LinearMipMapLinearFilter=1008,UnsignedByteType=1009,ByteType=1010,ShortType=1011,UnsignedShortType=1012,IntType=1013,UnsignedIntType=1014,FloatType=1015,HalfFloatType=1016,UnsignedShort4444Type=1017,UnsignedShort5551Type=1018,UnsignedShort565Type=1019,UnsignedInt248Type=1020,AlphaFormat=1021,RGBFormat=1022,RGBAFormat=1023,LuminanceFormat=1024,LuminanceAlphaFormat=1025,RGBEFormat=RGBAFormat,DepthFormat=1026,DepthStencilFormat=1027,RedFormat=1028,RGB_S3TC_DXT1_Format=33776,RGBA_S3TC_DXT1_Format=33777,RGBA_S3TC_DXT3_Format=33778,RGBA_S3TC_DXT5_Format=33779,RGB_PVRTC_4BPPV1_Format=35840,RGB_PVRTC_2BPPV1_Format=35841,RGBA_PVRTC_4BPPV1_Format=35842,RGBA_PVRTC_2BPPV1_Format=35843,RGB_ETC1_Format=36196,RGBA_ASTC_4x4_Format=37808,RGBA_ASTC_5x4_Format=37809,RGBA_ASTC_5x5_Format=37810,RGBA_ASTC_6x5_Format=37811,RGBA_ASTC_6x6_Format=37812,RGBA_ASTC_8x5_Format=37813,RGBA_ASTC_8x6_Format=37814,RGBA_ASTC_8x8_Format=37815,RGBA_ASTC_10x5_Format=37816,RGBA_ASTC_10x6_Format=37817,RGBA_ASTC_10x8_Format=37818,RGBA_ASTC_10x10_Format=37819,RGBA_ASTC_12x10_Format=37820,RGBA_ASTC_12x12_Format=37821,LoopOnce=2200,LoopRepeat=2201,LoopPingPong=2202,InterpolateDiscrete=2300,InterpolateLinear=2301,InterpolateSmooth=2302,ZeroCurvatureEnding=2400,ZeroSlopeEnding=2401,WrapAroundEnding=2402,TrianglesDrawMode=0,TriangleStripDrawMode=1,TriangleFanDrawMode=2,LinearEncoding=3e3,sRGBEncoding=3001,GammaEncoding=3007,RGBEEncoding=3002,LogLuvEncoding=3003,RGBM7Encoding=3004,RGBM16Encoding=3005,RGBDEncoding=3006,BasicDepthPacking=3200,RGBADepthPacking=3201,TangentSpaceNormalMap=0,ObjectSpaceNormalMap=1,object3DId=0,position,scale,m1,q1;function Object3D(){Object.defineProperty(this,"id",{value:object3DId++}),this.uuid=_Math.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DefaultUp.clone();var e=new Vector3,t=new Euler,r=new Quaternion,n=new Vector3(1,1,1);t.onChange((function(){r.setFromEuler(t,!1)})),r.onChange((function(){t.setFromQuaternion(r,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}Object3D.DefaultUp=new Vector3(0,1,0),Object3D.DefaultMatrixAutoUpdate=!0,Object3D.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Object3D,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(q){return this.quaternion.premultiply(q),this},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(q){this.quaternion.copy(q)},rotateOnAxis:(q1=new Quaternion,function(e,t){return q1.setFromAxisAngle(e,t),this.quaternion.multiply(q1),this}),rotateOnWorldAxis:function(){var e=new Quaternion;return function(t,r){return e.setFromAxisAngle(t,r),this.quaternion.premultiply(e),this}}(),rotateX:function(){var e=new Vector3(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new Vector3(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new Vector3(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new Vector3;return function(t,r){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(r)),this}}(),translateX:function(){var e=new Vector3(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new Vector3(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new Vector3(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:(m1=new Matrix4,function(e){return e.applyMatrix4(m1.getInverse(this.matrixWorld))}),lookAt:function(){var e=new Quaternion,t=new Matrix4,r=new Vector3,n=new Vector3;return function(o,l,c){o.isVector3?r.copy(o):r.set(o,l,c);var h=this.parent;this.updateWorldMatrix(!0,!1),n.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?t.lookAt(n,r,this.up):t.lookAt(r,n,this.up),this.quaternion.setFromRotationMatrix(t),h&&(t.extractRotation(h.matrixWorld),e.setFromRotationMatrix(t),this.quaternion.premultiply(e.inverse()))}}(),add:function(object){var e=arguments,t=this;if(arguments.length>1){for(var i=0;i<arguments.length;i++)t.add(e[i]);return this}return object===this?(console.error("Object3D.add: object can't be added as a child of itself.",object),this):(object&&object.isObject3D?(null!==object.parent&&object.parent.remove(object),object.parent=this,object.dispatchEvent({type:"added"}),this.children.push(object)):console.error("Object3D.add: object not an instance of Object3D.",object),this)},remove:function(object){var e=arguments,t=this;if(arguments.length>1){for(var i=0;i<arguments.length;i++)t.remove(e[i]);return this}var r=this.children.indexOf(object);return-1!==r&&(object.parent=null,object.dispatchEvent({type:"removed"}),this.children.splice(r,1)),this},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var i=0,r=this.children.length;i<r;i++){var object=this.children[i].getObjectByProperty(e,t);if(void 0!==object)return object}},getWorldPosition:function(e){return void 0===e&&(console.warn("Object3D: .getWorldPosition() target is now required"),e=new Vector3),this.updateMatrixWorld(!0),e.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:(position=new Vector3,scale=new Vector3,function(e){return void 0===e&&(console.warn("Object3D: .getWorldQuaternion() target is now required"),e=new Quaternion),this.updateMatrixWorld(!0),this.matrixWorld.decompose(position,e,scale),e}),getWorldScale:function(){var e=new Vector3,t=new Quaternion;return function(r){return void 0===r&&(console.warn("Object3D: .getWorldScale() target is now required"),r=new Vector3),this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,r),r}}(),getWorldDirection:function(e){void 0===e&&(console.warn("Object3D: .getWorldDirection() target is now required"),e=new Vector3),this.updateMatrixWorld(!0);var t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()},raycast:function(){},traverse:function(e){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,i=0,r=t.length;i<r;i++)t[i].updateMatrixWorld(e)},updateWorldMatrix:function(e,t){var r=this.parent;if(!0===e&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t)for(var n=this.children,i=0,o=n.length;i<o;i++)n[i].updateWorldMatrix(!1,!0)},toJSON:function(meta){var e=void 0===meta||"string"==typeof meta,output={};e&&(meta={geometries:{},materials:{},textures:{},images:{},shapes:{}},output.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var object={};function t(e,element){return void 0===e[element.uuid]&&(e[element.uuid]=element.toJSON(meta)),element.uuid}if(object.uuid=this.uuid,object.type=this.type,""!==this.name&&(object.name=this.name),!0===this.castShadow&&(object.castShadow=!0),!0===this.receiveShadow&&(object.receiveShadow=!0),!1===this.visible&&(object.visible=!1),!1===this.frustumCulled&&(object.frustumCulled=!1),0!==this.renderOrder&&(object.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(object.userData=this.userData),object.layers=this.layers.mask,object.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(object.matrixAutoUpdate=!1),this.isMesh&&this.drawMode!==TrianglesDrawMode&&(object.drawMode=this.drawMode),this.isMesh||this.isLine||this.isPoints){object.geometry=t(meta.geometries,this.geometry);var r=this.geometry.parameters;if(void 0!==r&&void 0!==r.shapes){var n=r.shapes;if(Array.isArray(n))for(var i=0,o=n.length;i<o;i++){var l=n[i];t(meta.shapes,l)}else t(meta.shapes,n)}}if(void 0!==this.material)if(Array.isArray(this.material)){var c=[];for(i=0,o=this.material.length;i<o;i++)c.push(t(meta.materials,this.material[i]));object.material=c}else object.material=t(meta.materials,this.material);if(this.children.length>0){object.children=[];for(i=0;i<this.children.length;i++)object.children.push(this.children[i].toJSON(meta).object)}if(e){var h=v(meta.geometries),d=v(meta.materials),f=v(meta.textures),m=v(meta.images);n=v(meta.shapes);h.length>0&&(output.geometries=h),d.length>0&&(output.materials=d),f.length>0&&(output.textures=f),m.length>0&&(output.images=m),n.length>0&&(output.shapes=n)}return output.object=object,output;function v(e){var t=[];for(var r in e){var data=e[r];delete data.metadata,t.push(data)}return t}},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(source,e){if(void 0===e&&(e=!0),this.name=source.name,this.up.copy(source.up),this.position.copy(source.position),this.quaternion.copy(source.quaternion),this.scale.copy(source.scale),this.matrix.copy(source.matrix),this.matrixWorld.copy(source.matrixWorld),this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrixWorldNeedsUpdate=source.matrixWorldNeedsUpdate,this.layers.mask=source.layers.mask,this.visible=source.visible,this.castShadow=source.castShadow,this.receiveShadow=source.receiveShadow,this.frustumCulled=source.frustumCulled,this.renderOrder=source.renderOrder,this.userData=JSON.parse(JSON.stringify(source.userData)),!0===e)for(var i=0;i<source.children.length;i++){var t=source.children[i];this.add(t.clone())}return this}});var ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},hslA,hslB,hsl,points,closestPoint,box;function Color(e,g,b){return void 0===g&&void 0===b?this.set(e):this.setRGB(e,g,b)}function Face3(a,b,e,t,r,n){this.a=a,this.b=b,this.c=e,this.normal=t&&t.isVector3?t:new Vector3,this.vertexNormals=Array.isArray(t)?t:[],this.color=r&&r.isColor?r:new Color,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=void 0!==n?n:0}function Box3(e,t){this.min=void 0!==e?e:new Vector3(1/0,1/0,1/0),this.max=void 0!==t?t:new Vector3(-1/0,-1/0,-1/0)}function Sphere(e,t){this.center=void 0!==e?e:new Vector3,this.radius=void 0!==t?t:0}function Vector2(e,t){this.x=e||0,this.y=t||0}Object.assign(Color.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,g,b){return this.r=e,this.g=g,this.b=b,this},setHSL:function(){function e(p,q,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?p+6*(q-p)*e:e<.5?q:e<2/3?p+6*(q-p)*(2/3-e):p}return function(t,s,r){if(t=_Math.euclideanModulo(t,1),s=_Math.clamp(s,0,1),r=_Math.clamp(r,0,1),0===s)this.r=this.g=this.b=r;else{var p=r<=.5?r*(1+s):r+s-r*s,q=2*r-p;this.r=e(q,p,t+1/3),this.g=e(q,p,t),this.b=e(q,p,t-1/3)}return this}}(),setStyle:function(style){function e(e){void 0!==e&&parseFloat(e)<1&&console.warn("Color: Alpha component of "+style+" will be ignored.")}var t;if(t=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(style)){var r,n=t[1],o=t[2];switch(n){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,e(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,e(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o)){var l=parseFloat(r[1])/360,s=parseInt(r[2],10)/100,c=parseInt(r[3],10)/100;return e(r[5]),this.setHSL(l,s,c)}}}else if(t=/^\#([A-Fa-f0-9]+)$/.exec(style)){var h,d=(h=t[1]).length;if(3===d)return this.r=parseInt(h.charAt(0)+h.charAt(0),16)/255,this.g=parseInt(h.charAt(1)+h.charAt(1),16)/255,this.b=parseInt(h.charAt(2)+h.charAt(2),16)/255,this;if(6===d)return this.r=parseInt(h.charAt(0)+h.charAt(1),16)/255,this.g=parseInt(h.charAt(2)+h.charAt(3),16)/255,this.b=parseInt(h.charAt(4)+h.charAt(5),16)/255,this}style&&style.length>0&&(void 0!==(h=ColorKeywords[style])?this.setHex(h):console.warn("Color: Unknown color "+style));return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var r=t>0?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this},convertGammaToLinear:function(e){return this.copyGammaToLinear(this,e),this},convertLinearToGamma:function(e){return this.copyLinearToGamma(this,e),this},copySRGBToLinear:function(){function e(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}return function(t){return this.r=e(t.r),this.g=e(t.g),this.b=e(t.b),this}}(),copyLinearToSRGB:function(){function e(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}return function(t){return this.r=e(t.r),this.g=e(t.g),this.b=e(t.b),this}}(),convertSRGBToLinear:function(){return this.copySRGBToLinear(this),this},convertLinearToSRGB:function(){return this.copyLinearToSRGB(this),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){void 0===e&&(console.warn("Color: .getHSL() target is now required"),e={h:0,s:0,l:0});var t,r,n=this.r,g=this.g,b=this.b,o=Math.max(n,g,b),l=Math.min(n,g,b),c=(l+o)/2;if(l===o)t=0,r=0;else{var h=o-l;switch(r=c<=.5?h/(o+l):h/(2-o-l),o){case n:t=(g-b)/h+(g<b?6:0);break;case g:t=(b-n)/h+2;break;case b:t=(n-g)/h+4}t/=6}return e.h=t,e.s=r,e.l=c,e},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:(hsl={},function(e,s,t){return this.getHSL(hsl),hsl.h+=e,hsl.s+=s,hsl.l+=t,this.setHSL(hsl.h,hsl.s,hsl.l),this}),add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(s){return this.r+=s,this.g+=s,this.b+=s,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(s){return this.r*=s,this.g*=s,this.b*=s,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},lerpHSL:(hslA={h:0,s:0,l:0},hslB={h:0,s:0,l:0},function(e,t){this.getHSL(hslA),e.getHSL(hslB);var r=_Math.lerp(hslA.h,hslB.h,t),s=_Math.lerp(hslA.s,hslB.s,t),n=_Math.lerp(hslA.l,hslB.l,t);return this.setHSL(r,s,n),this}),equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}}),Object.assign(Face3.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(source){this.a=source.a,this.b=source.b,this.c=source.c,this.normal.copy(source.normal),this.color.copy(source.color),this.materialIndex=source.materialIndex;for(var i=0,e=source.vertexNormals.length;i<e;i++)this.vertexNormals[i]=source.vertexNormals[i].clone();for(i=0,e=source.vertexColors.length;i<e;i++)this.vertexColors[i]=source.vertexColors[i].clone();return this}}),Object.assign(Box3.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,r=1/0,n=1/0,o=-1/0,l=-1/0,c=-1/0,i=0,h=e.length;i<h;i+=3){var d=e[i],f=e[i+1],m=e[i+2];d<t&&(t=d),f<r&&(r=f),m<n&&(n=m),d>o&&(o=d),f>l&&(l=f),m>c&&(c=m)}return this.min.set(t,r,n),this.max.set(o,l,c),this},setFromBufferAttribute:function(e){for(var t=1/0,r=1/0,n=1/0,o=-1/0,l=-1/0,c=-1/0,i=0,h=e.count;i<h;i++){var d=e.getX(i),f=e.getY(i),m=e.getZ(i);d<t&&(t=d),f<r&&(r=f),m<n&&(n=m),d>o&&(o=d),f>l&&(l=f),m>c&&(c=m)}return this.min.set(t,r,n),this.max.set(o,l,c),this},setFromPoints:function(e){this.makeEmpty();for(var i=0,t=e.length;i<t;i++)this.expandByPoint(e[i]);return this},setFromCenterAndSize:function(){var e=new Vector3;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),setFromObject:function(object){return this.makeEmpty(),this.expandByObject(object)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){return void 0===e&&(console.warn("Box3: .getCenter() target is now required"),e=new Vector3),this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){return void 0===e&&(console.warn("Box3: .getSize() target is now required"),e=new Vector3),this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e,i,t,r=new Vector3;function n(n){var o=n.geometry;if(void 0!==o)if(o.isGeometry){var l=o.vertices;for(i=0,t=l.length;i<t;i++)r.copy(l[i]),r.applyMatrix4(n.matrixWorld),e.expandByPoint(r)}else if(o.isBufferGeometry){var c=o.attributes.position;if(void 0!==c)for(i=0,t=c.count;i<t;i++)r.fromBufferAttribute(c,i).applyMatrix4(n.matrixWorld),e.expandByPoint(r)}}return function(object){return e=this,object.updateMatrixWorld(!0),object.traverse(n),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return void 0===t&&(console.warn("Box3: .getParameter() target is now required"),t=new Vector3),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:(closestPoint=new Vector3,function(e){return this.clampPoint(e.center,closestPoint),closestPoint.distanceToSquared(e.center)<=e.radius*e.radius}),intersectsPlane:function(e){var t,r;return e.normal.x>0?(t=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=-e.constant&&r>=-e.constant},intersectsTriangle:function(){var e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector3,o=new Vector3,l=new Vector3,c=new Vector3,h=new Vector3,d=new Vector3,f=new Vector3;function m(n){var i,o;for(i=0,o=n.length-3;i<=o;i+=3){c.fromArray(n,i);var l=d.x*Math.abs(c.x)+d.y*Math.abs(c.y)+d.z*Math.abs(c.z),h=e.dot(c),f=t.dot(c),m=r.dot(c);if(Math.max(-Math.max(h,f,m),Math.min(h,f,m))>l)return!1}return!0}return function(c){if(this.isEmpty())return!1;this.getCenter(h),d.subVectors(this.max,h),e.subVectors(c.a,h),t.subVectors(c.b,h),r.subVectors(c.c,h),n.subVectors(t,e),o.subVectors(r,t),l.subVectors(e,r);var v=[0,-n.z,n.y,0,-o.z,o.y,0,-l.z,l.y,n.z,0,-n.x,o.z,0,-o.x,l.z,0,-l.x,-n.y,n.x,0,-o.y,o.x,0,-l.y,l.x,0];return!!m(v)&&(!!m(v=[1,0,0,0,1,0,0,0,1])&&(f.crossVectors(n,o),m(v=[f.x,f.y,f.z])))}}(),clampPoint:function(e,t){return void 0===t&&(console.warn("Box3: .clampPoint() target is now required"),t=new Vector3),t.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector3;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new Vector3;return function(t){return void 0===t&&(console.warn("Box3: .getBoundingSphere() target is now required"),t=new Sphere),this.getCenter(t.center),t.radius=.5*this.getSize(e).length(),t}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:(points=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],function(e){return this.isEmpty()?this:(points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(points),this)}),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(Sphere.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:(box=new Box3,function(e,t){var r=this.center;void 0!==t?r.copy(t):box.setFromPoints(e).getCenter(r);for(var n=0,i=0,o=e.length;i<o;i++)n=Math.max(n,r.distanceToSquared(e[i]));return this.radius=Math.sqrt(n),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius},clampPoint:function(e,t){var r=this.center.distanceToSquared(e);return void 0===t&&(console.warn("Sphere: .clampPoint() target is now required"),t=new Vector3),t.copy(e),r>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t},getBoundingBox:function(e){return void 0===e&&(console.warn("Sphere: .getBoundingBox() target is now required"),e=new Box3),e.set(this.center,this.center),e.expandByScalar(this.radius),e},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.defineProperties(Vector2.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(Vector2.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(s){return this.x+=s,this.y+=s,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},addScaledVector:function(e,s){return this.x+=e.x*s,this.y+=e.y*s,this},sub:function(e,t){return void 0!==t?(console.warn("Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(s){return this.x-=s,this.y-=s,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},applyMatrix3:function(e){var t=this.x,r=this.y,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6],this.y=n[1]*t+n[4]*r+n[7],this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e=new Vector2,t=new Vector2;return function(r,n){return e.set(r,r),t.set(n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},cross:function(e){return this.x*e.y-this.y*e.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},manhattanDistanceTo:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var r=Math.cos(t),s=Math.sin(t),n=this.x-e.x,o=this.y-e.y;return this.x=n*r-o*s+e.x,this.y=n*s+o*r+e.y,this}});var geometryId=0,offset,obj;function Geometry(){Object.defineProperty(this,"id",{value:geometryId+=2}),this.uuid=_Math.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function Vector4(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==n?n:1}function BufferAttribute(e,t,r){if(Array.isArray(e))throw new TypeError("BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function Int8BufferAttribute(e,t,r){BufferAttribute.call(this,new Int8Array(e),t,r)}function Uint8BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8Array(e),t,r)}function Uint8ClampedBufferAttribute(e,t,r){BufferAttribute.call(this,new Uint8ClampedArray(e),t,r)}function Int16BufferAttribute(e,t,r){BufferAttribute.call(this,new Int16Array(e),t,r)}function Uint16BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint16Array(e),t,r)}function Int32BufferAttribute(e,t,r){BufferAttribute.call(this,new Int32Array(e),t,r)}function Uint32BufferAttribute(e,t,r){BufferAttribute.call(this,new Uint32Array(e),t,r)}function Float32BufferAttribute(e,t,r){BufferAttribute.call(this,new Float32Array(e),t,r)}function Float64BufferAttribute(e,t,r){BufferAttribute.call(this,new Float64Array(e),t,r)}function DirectGeometry(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function arrayMin(e){if(0===e.length)return 1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]<t&&(t=e[i]);return t}function arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]>t&&(t=e[i]);return t}Geometry.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Geometry,isGeometry:!0,applyMatrix:function(e){for(var t=(new Matrix3).getNormalMatrix(e),i=0,r=this.vertices.length;i<r;i++){this.vertices[i].applyMatrix4(e)}for(i=0,r=this.faces.length;i<r;i++){var n=this.faces[i];n.normal.applyMatrix3(t).normalize();for(var o=0,l=n.vertexNormals.length;o<l;o++)n.vertexNormals[o].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new Matrix4;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new Matrix4;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new Matrix4;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new Matrix4;return function(t,r,n){return e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e=new Matrix4;return function(t,r,n){return e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:(obj=new Object3D,function(e){obj.lookAt(e),obj.updateMatrix(),this.applyMatrix(obj.matrix)}),fromBufferGeometry:function(e){var t=this,r=null!==e.index?e.index.array:void 0,n=e.attributes,o=n.position.array,l=void 0!==n.normal?n.normal.array:void 0,c=void 0!==n.color?n.color.array:void 0,h=void 0!==n.uv?n.uv.array:void 0,d=void 0!==n.uv2?n.uv2.array:void 0;void 0!==d&&(this.faceVertexUvs[1]=[]);for(var i=0,f=0;i<o.length;i+=3,f+=2)t.vertices.push((new Vector3).fromArray(o,i)),void 0!==c&&t.colors.push((new Color).fromArray(c,i));function m(a,b,e,r){var n=void 0===c?[]:[t.colors[a].clone(),t.colors[b].clone(),t.colors[e].clone()],o=new Face3(a,b,e,void 0===l?[]:[(new Vector3).fromArray(l,3*a),(new Vector3).fromArray(l,3*b),(new Vector3).fromArray(l,3*e)],n,r);t.faces.push(o),void 0!==h&&t.faceVertexUvs[0].push([(new Vector2).fromArray(h,2*a),(new Vector2).fromArray(h,2*b),(new Vector2).fromArray(h,2*e)]),void 0!==d&&t.faceVertexUvs[1].push([(new Vector2).fromArray(d,2*a),(new Vector2).fromArray(d,2*b),(new Vector2).fromArray(d,2*e)])}var v=e.groups;if(v.length>0)for(i=0;i<v.length;i++)for(var y=v[i],x=y.start,w=(f=x,x+y.count);f<w;f+=3)void 0!==r?m(r[f],r[f+1],r[f+2],y.materialIndex):m(f,f+1,f+2,y.materialIndex);else if(void 0!==r)for(i=0;i<r.length;i+=3)m(r[i],r[i+1],r[i+2]);else for(i=0;i<o.length/3;i+=3)m(i,i+1,i+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:(offset=new Vector3,function(){return this.computeBoundingBox(),this.boundingBox.getCenter(offset).negate(),this.translate(offset.x,offset.y,offset.z),this}),normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,s=0===t?1:1/t,r=new Matrix4;return r.set(s,0,0,-s*e.x,0,s,0,-s*e.y,0,0,s,-s*e.z,0,0,0,1),this.applyMatrix(r),this},computeFaceNormals:function(){for(var e=new Vector3,t=new Vector3,r=0,n=this.faces.length;r<n;r++){var o=this.faces[r],l=this.vertices[o.a],c=this.vertices[o.b],h=this.vertices[o.c];e.subVectors(h,c),t.subVectors(l,c),e.cross(t),e.normalize(),o.normal.copy(e)}},computeVertexNormals:function(e){var t,r,n,o,l,c;for(void 0===e&&(e=!0),c=new Array(this.vertices.length),t=0,r=this.vertices.length;t<r;t++)c[t]=new Vector3;if(e){var h,d,f,m=new Vector3,v=new Vector3;for(n=0,o=this.faces.length;n<o;n++)l=this.faces[n],h=this.vertices[l.a],d=this.vertices[l.b],f=this.vertices[l.c],m.subVectors(f,d),v.subVectors(h,d),m.cross(v),c[l.a].add(m),c[l.b].add(m),c[l.c].add(m)}else for(this.computeFaceNormals(),n=0,o=this.faces.length;n<o;n++)c[(l=this.faces[n]).a].add(l.normal),c[l.b].add(l.normal),c[l.c].add(l.normal);for(t=0,r=this.vertices.length;t<r;t++)c[t].normalize();for(n=0,o=this.faces.length;n<o;n++){var y=(l=this.faces[n]).vertexNormals;3===y.length?(y[0].copy(c[l.a]),y[1].copy(c[l.b]),y[2].copy(c[l.c])):(y[0]=c[l.a].clone(),y[1]=c[l.b].clone(),y[2]=c[l.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,r;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){var n=(r=this.faces[e]).vertexNormals;3===n.length?(n[0].copy(r.normal),n[1].copy(r.normal),n[2].copy(r.normal)):(n[0]=r.normal.clone(),n[1]=r.normal.clone(),n[2]=r.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var i,e,t,r,n;for(t=0,r=this.faces.length;t<r;t++)for((n=this.faces[t]).__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),i=0,e=n.vertexNormals.length;i<e;i++)n.__originalVertexNormals[i]?n.__originalVertexNormals[i].copy(n.vertexNormals[i]):n.__originalVertexNormals[i]=n.vertexNormals[i].clone();var o=new Geometry;for(o.faces=this.faces,i=0,e=this.morphTargets.length;i<e;i++){if(!this.morphNormals[i]){this.morphNormals[i]={},this.morphNormals[i].faceNormals=[],this.morphNormals[i].vertexNormals=[];var l=this.morphNormals[i].faceNormals,c=this.morphNormals[i].vertexNormals;for(t=0,r=this.faces.length;t<r;t++)h=new Vector3,d={a:new Vector3,b:new Vector3,c:new Vector3},l.push(h),c.push(d)}var h,d,f=this.morphNormals[i];for(o.vertices=this.morphTargets[i].vertices,o.computeFaceNormals(),o.computeVertexNormals(),t=0,r=this.faces.length;t<r;t++)n=this.faces[t],h=f.faceNormals[t],d=f.vertexNormals[t],h.copy(n.normal),d.a.copy(n.vertexNormals[0]),d.b.copy(n.vertexNormals[1]),d.c.copy(n.vertexNormals[2])}for(t=0,r=this.faces.length;t<r;t++)(n=this.faces[t]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,r){if(e&&e.isGeometry){var n,o=this.vertices.length,l=this.vertices,c=e.vertices,h=this.faces,d=e.faces,f=this.faceVertexUvs[0],m=e.faceVertexUvs[0],v=this.colors,y=e.colors;void 0===r&&(r=0),void 0!==t&&(n=(new Matrix3).getNormalMatrix(t));for(var i=0,x=c.length;i<x;i++){var w=c[i].clone();void 0!==t&&w.applyMatrix4(t),l.push(w)}for(i=0,x=y.length;i<x;i++)v.push(y[i].clone());for(i=0,x=d.length;i<x;i++){var M,S,A,T=d[i],_=T.vertexNormals,L=T.vertexColors;(M=new Face3(T.a+o,T.b+o,T.c+o)).normal.copy(T.normal),void 0!==n&&M.normal.applyMatrix3(n).normalize();for(var C=0,N=_.length;C<N;C++)S=_[C].clone(),void 0!==n&&S.applyMatrix3(n).normalize(),M.vertexNormals.push(S);M.color.copy(T.color);for(C=0,N=L.length;C<N;C++)A=L[C],M.vertexColors.push(A.clone());M.materialIndex=T.materialIndex+r,h.push(M)}for(i=0,x=m.length;i<x;i++){var P=m[i],E=[];if(void 0!==P){for(C=0,N=P.length;C<N;C++)E.push(P[C].clone());f.push(E)}}}else console.error("Geometry.merge(): geometry not an instance of Geometry.",e)},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("Geometry.mergeMesh(): mesh not an instance of Mesh.",e)},mergeVertices:function(){var e,t,i,r,n,o,l,c,h={},d=[],f=[],m=Math.pow(10,4);for(i=0,r=this.vertices.length;i<r;i++)e=this.vertices[i],void 0===h[t=Math.round(e.x*m)+"_"+Math.round(e.y*m)+"_"+Math.round(e.z*m)]?(h[t]=i,d.push(this.vertices[i]),f[i]=d.length-1):f[i]=f[h[t]];var v=[];for(i=0,r=this.faces.length;i<r;i++){(n=this.faces[i]).a=f[n.a],n.b=f[n.b],n.c=f[n.c],o=[n.a,n.b,n.c];for(var y=0;y<3;y++)if(o[y]===o[(y+1)%3]){v.push(i);break}}for(i=v.length-1;i>=0;i--){var x=v[i];for(this.faces.splice(x,1),l=0,c=this.faceVertexUvs.length;l<c;l++)this.faceVertexUvs[l].splice(x,1)}var w=this.vertices.length-d.length;return this.vertices=d,w},setFromPoints:function(e){this.vertices=[];for(var i=0,t=e.length;i<t;i++){var r=e[i];this.vertices.push(new Vector3(r.x,r.y,r.z||0))}return this},sortFacesByMaterialIndex:function(){for(var e=this.faces,t=e.length,i=0;i<t;i++)e[i]._id=i;e.sort((function(a,b){return a.materialIndex-b.materialIndex}));var r,n,o=this.faceVertexUvs[0],l=this.faceVertexUvs[1];o&&o.length===t&&(r=[]),l&&l.length===t&&(n=[]);for(i=0;i<t;i++){var c=e[i]._id;r&&r.push(o[c]),n&&n.push(l[c])}r&&(this.faceVertexUvs[0]=r),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){var data={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(data.uuid=this.uuid,data.type=this.type,""!==this.name&&(data.name=this.name),void 0!==this.parameters){var e=this.parameters;for(var t in e)void 0!==e[t]&&(data[t]=e[t]);return data}for(var r=[],i=0;i<this.vertices.length;i++){var n=this.vertices[i];r.push(n.x,n.y,n.z)}var o=[],l=[],c={},h=[],d={},f=[],m={};for(i=0;i<this.faces.length;i++){var v=this.faces[i],y=void 0!==this.faceVertexUvs[0][i],x=v.normal.length()>0,w=v.vertexNormals.length>0,M=1!==v.color.r||1!==v.color.g||1!==v.color.b,S=v.vertexColors.length>0,A=0;if(A=C(A,0,0),A=C(A,1,!0),A=C(A,2,!1),A=C(A,3,y),A=C(A,4,x),A=C(A,5,w),A=C(A,6,M),A=C(A,7,S),o.push(A),o.push(v.a,v.b,v.c),o.push(v.materialIndex),y){var T=this.faceVertexUvs[0][i];o.push(E(T[0]),E(T[1]),E(T[2]))}if(x&&o.push(N(v.normal)),w){var _=v.vertexNormals;o.push(N(_[0]),N(_[1]),N(_[2]))}if(M&&o.push(P(v.color)),S){var L=v.vertexColors;o.push(P(L[0]),P(L[1]),P(L[2]))}}function C(e,t,r){return r?e|1<<t:e&~(1<<t)}function N(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==c[t]?c[t]:(c[t]=l.length/3,l.push(e.x,e.y,e.z),c[t])}function P(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==d[t]?d[t]:(d[t]=h.length,h.push(e.getHex()),d[t])}function E(e){var t=e.x.toString()+e.y.toString();return void 0!==m[t]?m[t]:(m[t]=f.length/2,f.push(e.x,e.y),m[t])}return data.data={},data.data.vertices=r,data.data.normals=l,h.length>0&&(data.data.colors=h),f.length>0&&(data.data.uvs=[f]),data.data.faces=o,data},clone:function(){return(new Geometry).copy(this)},copy:function(source){var i,e,t,r,n,o;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=source.name;var l=source.vertices;for(i=0,e=l.length;i<e;i++)this.vertices.push(l[i].clone());var c=source.colors;for(i=0,e=c.length;i<e;i++)this.colors.push(c[i].clone());var h=source.faces;for(i=0,e=h.length;i<e;i++)this.faces.push(h[i].clone());for(i=0,e=source.faceVertexUvs.length;i<e;i++){var d=source.faceVertexUvs[i];for(void 0===this.faceVertexUvs[i]&&(this.faceVertexUvs[i]=[]),t=0,r=d.length;t<r;t++){var f=d[t],m=[];for(n=0,o=f.length;n<o;n++){var v=f[n];m.push(v.clone())}this.faceVertexUvs[i].push(m)}}var y=source.morphTargets;for(i=0,e=y.length;i<e;i++){var x={};if(x.name=y[i].name,void 0!==y[i].vertices)for(x.vertices=[],t=0,r=y[i].vertices.length;t<r;t++)x.vertices.push(y[i].vertices[t].clone());if(void 0!==y[i].normals)for(x.normals=[],t=0,r=y[i].normals.length;t<r;t++)x.normals.push(y[i].normals[t].clone());this.morphTargets.push(x)}var w=source.morphNormals;for(i=0,e=w.length;i<e;i++){var M={};if(void 0!==w[i].vertexNormals)for(M.vertexNormals=[],t=0,r=w[i].vertexNormals.length;t<r;t++){var S=w[i].vertexNormals[t],A={};A.a=S.a.clone(),A.b=S.b.clone(),A.c=S.c.clone(),M.vertexNormals.push(A)}if(void 0!==w[i].faceNormals)for(M.faceNormals=[],t=0,r=w[i].faceNormals.length;t<r;t++)M.faceNormals.push(w[i].faceNormals[t].clone());this.morphNormals.push(M)}var T=source.skinWeights;for(i=0,e=T.length;i<e;i++)this.skinWeights.push(T[i].clone());var _=source.skinIndices;for(i=0,e=_.length;i<e;i++)this.skinIndices.push(_[i].clone());var L=source.lineDistances;for(i=0,e=L.length;i<e;i++)this.lineDistances.push(L[i]);var C=source.boundingBox;null!==C&&(this.boundingBox=C.clone());var N=source.boundingSphere;return null!==N&&(this.boundingSphere=N.clone()),this.elementsNeedUpdate=source.elementsNeedUpdate,this.verticesNeedUpdate=source.verticesNeedUpdate,this.uvsNeedUpdate=source.uvsNeedUpdate,this.normalsNeedUpdate=source.normalsNeedUpdate,this.colorsNeedUpdate=source.colorsNeedUpdate,this.lineDistancesNeedUpdate=source.lineDistancesNeedUpdate,this.groupsNeedUpdate=source.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.assign(Vector4.prototype,{isVector4:!0,set:function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(s){return this.x+=s,this.y+=s,this.z+=s,this.w+=s,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},addScaledVector:function(e,s){return this.x+=e.x*s,this.y+=e.y*s,this.z+=e.z*s,this.w+=e.w*s,this},sub:function(e,t){return void 0!==t?(console.warn("Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(s){return this.x-=s,this.y-=s,this.z-=s,this.w-=s,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,o=this.w,l=e.elements;return this.x=l[0]*t+l[4]*r+l[8]*n+l[12]*o,this.y=l[1]*t+l[5]*r+l[9]*n+l[13]*o,this.z=l[2]*t+l[6]*r+l[10]*n+l[14]*o,this.w=l[3]*t+l[7]*r+l[11]*n+l[15]*o,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(q){this.w=2*Math.acos(q.w);var s=Math.sqrt(1-q.w*q.w);return s<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=q.x/s,this.y=q.y/s,this.z=q.z/s),this},setAxisAngleFromRotationMatrix:function(e){var t,r,n,o,l=e.elements,c=l[0],h=l[4],d=l[8],f=l[1],m=l[5],v=l[9],y=l[2],x=l[6],w=l[10];if(Math.abs(h-f)<.01&&Math.abs(d-y)<.01&&Math.abs(v-x)<.01){if(Math.abs(h+f)<.1&&Math.abs(d+y)<.1&&Math.abs(v+x)<.1&&Math.abs(c+m+w-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var M=(c+1)/2,S=(m+1)/2,A=(w+1)/2,T=(h+f)/4,_=(d+y)/4,L=(v+x)/4;return M>S&&M>A?M<.01?(r=0,n=.707106781,o=.707106781):(n=T/(r=Math.sqrt(M)),o=_/r):S>A?S<.01?(r=.707106781,n=0,o=.707106781):(r=T/(n=Math.sqrt(S)),o=L/n):A<.01?(r=.707106781,n=.707106781,o=0):(r=_/(o=Math.sqrt(A)),n=L/o),this.set(r,n,o,t),this}var s=Math.sqrt((x-v)*(x-v)+(d-y)*(d-y)+(f-h)*(f-h));return Math.abs(s)<.001&&(s=1),this.x=(x-v)/s,this.y=(d-y)/s,this.z=(f-h)/s,this.w=Math.acos((c+m+w-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e,t;return function(r,n){return void 0===e&&(e=new Vector4,t=new Vector4),e.set(r,r,r,r),t.set(n,n,n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(e){return this.normalize().multiplyScalar(e)},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,r){return void 0!==r&&console.warn("Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.defineProperty(BufferAttribute.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(BufferAttribute.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setArray:function(e){if(Array.isArray(e))throw new TypeError("BufferAttribute: array should be a Typed Array.");return this.count=void 0!==e?e.length/this.itemSize:0,this.array=e,this},setDynamic:function(e){return this.dynamic=e,this},copy:function(source){return this.name=source.name,this.array=new source.array.constructor(source.array),this.itemSize=source.itemSize,this.count=source.count,this.normalized=source.normalized,this.dynamic=source.dynamic,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(var i=0,n=this.itemSize;i<n;i++)this.array[e+i]=t.array[r+i];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var o=e[i];void 0===o&&(console.warn("BufferAttribute.copyColorsArray(): color is undefined",i),o=new Color),t[r++]=o.r,t[r++]=o.g,t[r++]=o.b}return this},copyVector2sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var o=e[i];void 0===o&&(console.warn("BufferAttribute.copyVector2sArray(): vector is undefined",i),o=new Vector2),t[r++]=o.x,t[r++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var o=e[i];void 0===o&&(console.warn("BufferAttribute.copyVector3sArray(): vector is undefined",i),o=new Vector3),t[r++]=o.x,t[r++]=o.y,t[r++]=o.z}return this},copyVector4sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var o=e[i];void 0===o&&(console.warn("BufferAttribute.copyVector4sArray(): vector is undefined",i),o=new Vector4),t[r++]=o.x,t[r++]=o.y,t[r++]=o.z,t[r++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this},setXYZW:function(e,t,r,n,o){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=o,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),Int8BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int8BufferAttribute.prototype.constructor=Int8BufferAttribute,Uint8BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint8BufferAttribute.prototype.constructor=Uint8BufferAttribute,Uint8ClampedBufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint8ClampedBufferAttribute.prototype.constructor=Uint8ClampedBufferAttribute,Int16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int16BufferAttribute.prototype.constructor=Int16BufferAttribute,Uint16BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint16BufferAttribute.prototype.constructor=Uint16BufferAttribute,Int32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Int32BufferAttribute.prototype.constructor=Int32BufferAttribute,Uint32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Uint32BufferAttribute.prototype.constructor=Uint32BufferAttribute,Float32BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float32BufferAttribute.prototype.constructor=Float32BufferAttribute,Float64BufferAttribute.prototype=Object.create(BufferAttribute.prototype),Float64BufferAttribute.prototype.constructor=Float64BufferAttribute,Object.assign(DirectGeometry.prototype,{computeGroups:function(e){for(var t,r=[],n=void 0,o=e.faces,i=0;i<o.length;i++){var l=o[i];l.materialIndex!==n&&(n=l.materialIndex,void 0!==t&&(t.count=3*i-t.start,r.push(t)),t={start:3*i,materialIndex:n})}void 0!==t&&(t.count=3*i-t.start,r.push(t)),this.groups=r},fromGeometry:function(e){var t,r=e.faces,n=e.vertices,o=e.faceVertexUvs,l=o[0]&&o[0].length>0,c=o[1]&&o[1].length>0,h=e.morphTargets,d=h.length;if(d>0){t=[];for(var i=0;i<d;i++)t[i]={name:h[i].name,data:[]};this.morphTargets.position=t}var f,m=e.morphNormals,v=m.length;if(v>0){f=[];for(i=0;i<v;i++)f[i]={name:m[i].name,data:[]};this.morphTargets.normal=f}var y=e.skinIndices,x=e.skinWeights,w=y.length===n.length,M=x.length===n.length;n.length>0&&0===r.length&&console.error("DirectGeometry: Faceless geometries are not supported.");for(i=0;i<r.length;i++){var S=r[i];this.vertices.push(n[S.a],n[S.b],n[S.c]);var A=S.vertexNormals;if(3===A.length)this.normals.push(A[0],A[1],A[2]);else{var T=S.normal;this.normals.push(T,T,T)}var _,L=S.vertexColors;if(3===L.length)this.colors.push(L[0],L[1],L[2]);else{var C=S.color;this.colors.push(C,C,C)}if(!0===l)void 0!==(_=o[0][i])?this.uvs.push(_[0],_[1],_[2]):(console.warn("DirectGeometry.fromGeometry(): Undefined vertexUv ",i),this.uvs.push(new Vector2,new Vector2,new Vector2));if(!0===c)void 0!==(_=o[1][i])?this.uvs2.push(_[0],_[1],_[2]):(console.warn("DirectGeometry.fromGeometry(): Undefined vertexUv2 ",i),this.uvs2.push(new Vector2,new Vector2,new Vector2));for(var N=0;N<d;N++){var P=h[N].vertices;t[N].data.push(P[S.a],P[S.b],P[S.c])}for(N=0;N<v;N++){var E=m[N].vertexNormals[i];f[N].data.push(E.a,E.b,E.c)}w&&this.skinIndices.push(y[S.a],y[S.b],y[S.c]),M&&this.skinWeights.push(x[S.a],x[S.b],x[S.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var bufferGeometryId=1;function BufferGeometry(){Object.defineProperty(this,"id",{value:bufferGeometryId+=2}),this.uuid=_Math.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}function SphereGeometry(e,t,r,n,o,l,c){Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:o,thetaStart:l,thetaLength:c},this.fromBufferGeometry(new SphereBufferGeometry(e,t,r,n,o,l,c)),this.mergeVertices()}function SphereBufferGeometry(e,t,r,n,o,l,c){BufferGeometry.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:o,thetaStart:l,thetaLength:c},e=e||1,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI;var h,d,f=(l=void 0!==l?l:0)+(c=void 0!==c?c:Math.PI),m=0,v=[],y=new Vector3,x=new Vector3,w=[],M=[],S=[],A=[];for(d=0;d<=r;d++){var T=[],_=d/r;for(h=0;h<=t;h++){var u=h/t;y.x=-e*Math.cos(n+u*o)*Math.sin(l+_*c),y.y=e*Math.cos(l+_*c),y.z=e*Math.sin(n+u*o)*Math.sin(l+_*c),M.push(y.x,y.y,y.z),x.set(y.x,y.y,y.z).normalize(),S.push(x.x,x.y,x.z),A.push(u,1-_),T.push(m++)}v.push(T)}for(d=0;d<r;d++)for(h=0;h<t;h++){var a=v[d][h+1],b=v[d][h],L=v[d+1][h],C=v[d+1][h+1];(0!==d||l>0)&&w.push(a,b,C),(d!==r-1||f<Math.PI)&&w.push(b,L,C)}this.setIndex(w),this.addAttribute("position",new Float32BufferAttribute(M,3)),this.addAttribute("normal",new Float32BufferAttribute(S,3)),this.addAttribute("uv",new Float32BufferAttribute(A,2))}BufferGeometry.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:BufferGeometry,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(arrayMax(e)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):this.index=e},addAttribute:function(e,t){return t&&t.isBufferAttribute||t&&t.isInterleavedBufferAttribute?"index"===e?(console.warn("BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(t),this):(this.attributes[e]=t,this):(console.warn("BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.addAttribute(e,new BufferAttribute(arguments[1],arguments[2])))},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var r=this.attributes.normal;void 0!==r&&((new Matrix3).getNormalMatrix(e).applyToBufferAttribute(r),r.needsUpdate=!0);var n=this.attributes.tangent;void 0!==n&&((new Matrix3).getNormalMatrix(e).applyToBufferAttribute(n),n.needsUpdate=!0);return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new Matrix4;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new Matrix4;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new Matrix4;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new Matrix4;return function(t,r,n){return e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e=new Matrix4;return function(t,r,n){return e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:function(){var e=new Object3D;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){var e=new Vector3;return function(){return this.computeBoundingBox(),this.boundingBox.getCenter(e).negate(),this.translate(e.x,e.y,e.z),this}}(),setFromObject:function(object){var e=object.geometry;if(object.isPoints||object.isLine){var t=new Float32BufferAttribute(3*e.vertices.length,3),r=new Float32BufferAttribute(3*e.colors.length,3);if(this.addAttribute("position",t.copyVector3sArray(e.vertices)),this.addAttribute("color",r.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length){var n=new Float32BufferAttribute(e.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(e.lineDistances))}null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone())}else object.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i];t.push(n.x,n.y,n.z||0)}return this.addAttribute("position",new Float32BufferAttribute(t,3)),this},updateFromObject:function(object){var e,t=object.geometry;if(object.isMesh){var r=t.__directGeometry;if(!0===t.elementsNeedUpdate&&(r=void 0,t.elementsNeedUpdate=!1),void 0===r)return this.fromGeometry(t);r.verticesNeedUpdate=t.verticesNeedUpdate,r.normalsNeedUpdate=t.normalsNeedUpdate,r.colorsNeedUpdate=t.colorsNeedUpdate,r.uvsNeedUpdate=t.uvsNeedUpdate,r.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=r}return!0===t.verticesNeedUpdate&&(void 0!==(e=this.attributes.position)&&(e.copyVector3sArray(t.vertices),e.needsUpdate=!0),t.verticesNeedUpdate=!1),!0===t.normalsNeedUpdate&&(void 0!==(e=this.attributes.normal)&&(e.copyVector3sArray(t.normals),e.needsUpdate=!0),t.normalsNeedUpdate=!1),!0===t.colorsNeedUpdate&&(void 0!==(e=this.attributes.color)&&(e.copyColorsArray(t.colors),e.needsUpdate=!0),t.colorsNeedUpdate=!1),t.uvsNeedUpdate&&(void 0!==(e=this.attributes.uv)&&(e.copyVector2sArray(t.uvs),e.needsUpdate=!0),t.uvsNeedUpdate=!1),t.lineDistancesNeedUpdate&&(void 0!==(e=this.attributes.lineDistance)&&(e.copyArray(t.lineDistances),e.needsUpdate=!0),t.lineDistancesNeedUpdate=!1),t.groupsNeedUpdate&&(t.computeGroups(object.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new DirectGeometry).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new BufferAttribute(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var r=new Float32Array(3*e.normals.length);this.addAttribute("normal",new BufferAttribute(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var n=new Float32Array(3*e.colors.length);this.addAttribute("color",new BufferAttribute(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var o=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new BufferAttribute(o,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var l=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new BufferAttribute(l,2).copyVector2sArray(e.uvs2))}for(var c in this.groups=e.groups,e.morphTargets){for(var h=[],d=e.morphTargets[c],i=0,f=d.length;i<f;i++){var m=d[i],v=new Float32BufferAttribute(3*m.data.length,3);v.name=m.name,h.push(v.copyVector3sArray(m.data))}this.morphAttributes[c]=h}if(e.skinIndices.length>0){var y=new Float32BufferAttribute(4*e.skinIndices.length,4);this.addAttribute("skinIndex",y.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var x=new Float32BufferAttribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",x.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new Box3,t=new Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);var r=this.attributes.position;if(r){var n=this.boundingSphere.center;e.setFromBufferAttribute(r),e.getCenter(n);for(var o=0,i=0,l=r.count;i<l;i++)t.x=r.getX(i),t.y=r.getY(i),t.z=r.getZ(i),o=Math.max(o,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes;if(t.position){var r=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(r.length),3));else for(var n=t.normal.array,i=0,o=n.length;i<o;i++)n[i]=0;var l,c,h,d=t.normal.array,f=new Vector3,m=new Vector3,v=new Vector3,y=new Vector3,x=new Vector3;if(e){var w=e.array;for(i=0,o=e.count;i<o;i+=3)l=3*w[i+0],c=3*w[i+1],h=3*w[i+2],f.fromArray(r,l),m.fromArray(r,c),v.fromArray(r,h),y.subVectors(v,m),x.subVectors(f,m),y.cross(x),d[l]+=y.x,d[l+1]+=y.y,d[l+2]+=y.z,d[c]+=y.x,d[c+1]+=y.y,d[c+2]+=y.z,d[h]+=y.x,d[h+1]+=y.y,d[h+2]+=y.z}else for(i=0,o=r.length;i<o;i+=9)f.fromArray(r,i),m.fromArray(r,i+3),v.fromArray(r,i+6),y.subVectors(v,m),x.subVectors(f,m),y.cross(x),d[i]=y.x,d[i+1]=y.y,d[i+2]=y.z,d[i+3]=y.x,d[i+4]=y.y,d[i+5]=y.z,d[i+6]=y.x,d[i+7]=y.y,d[i+8]=y.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(e&&e.isBufferGeometry){void 0===t&&(t=0,console.warn("BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));var r=this.attributes;for(var n in r)if(void 0!==e.attributes[n])for(var o=r[n].array,l=e.attributes[n],c=l.array,i=0,h=l.itemSize*t;i<c.length;i++,h++)o[h]=c[i];return this}console.error("BufferGeometry.merge(): geometry not an instance of BufferGeometry.",e)},normalizeNormals:function(){var e=new Vector3;return function(){for(var t=this.attributes.normal,i=0,r=t.count;i<r;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.normalize(),t.setXYZ(i,e.x,e.y,e.z)}}(),toNonIndexed:function(){function e(e,t){for(var r=e.array,n=e.itemSize,o=new r.constructor(t.length*n),l=0,c=0,i=0,h=t.length;i<h;i++){l=t[i]*n;for(var d=0;d<n;d++)o[c++]=r[l++]}return new BufferAttribute(o,n)}if(null===this.index)return console.warn("BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var t=new BufferGeometry,r=this.index.array,n=this.attributes;for(var o in n){var l=e(n[o],r);t.addAttribute(o,l)}var c=this.morphAttributes;for(o in c){for(var h=[],d=c[o],i=0,f=d.length;i<f;i++){l=e(d[i],r);h.push(l)}t.morphAttributes[o]=h}for(var m=this.groups,v=(i=0,m.length);i<v;i++){var y=m[i];t.addGroup(y.start,y.count,y.materialIndex)}return t},toJSON:function(){var data={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(data.uuid=this.uuid,data.type=this.type,""!==this.name&&(data.name=this.name),Object.keys(this.userData).length>0&&(data.userData=this.userData),void 0!==this.parameters){var e=this.parameters;for(var t in e)void 0!==e[t]&&(data[t]=e[t]);return data}data.data={attributes:{}};var r=this.index;null!==r&&(data.data.index={type:r.array.constructor.name,array:Array.prototype.slice.call(r.array)});var n=this.attributes;for(var t in n){var o={itemSize:(m=n[t]).itemSize,type:m.array.constructor.name,array:Array.prototype.slice.call(m.array),normalized:m.normalized};""!==m.name&&(o.name=m.name),data.data.attributes[t]=o}var l={},c=!1;for(var t in this.morphAttributes){for(var h=this.morphAttributes[t],d=[],i=0,f=h.length;i<f;i++){var m;o={itemSize:(m=h[i]).itemSize,type:m.array.constructor.name,array:Array.prototype.slice.call(m.array),normalized:m.normalized};""!==m.name&&(o.name=m.name),d.push(o)}d.length>0&&(l[t]=d,c=!0)}c&&(data.data.morphAttributes=l);var v=this.groups;v.length>0&&(data.data.groups=JSON.parse(JSON.stringify(v)));var y=this.boundingSphere;return null!==y&&(data.data.boundingSphere={center:y.center.toArray(),radius:y.radius}),data},clone:function(){return(new BufferGeometry).copy(this)},copy:function(source){var e,i,t;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=source.name;var r=source.index;null!==r&&this.setIndex(r.clone());var n=source.attributes;for(e in n){var o=n[e];this.addAttribute(e,o.clone())}var l=source.morphAttributes;for(e in l){var c=[],h=l[e];for(i=0,t=h.length;i<t;i++)c.push(h[i].clone());this.morphAttributes[e]=c}var d=source.groups;for(i=0,t=d.length;i<t;i++){var f=d[i];this.addGroup(f.start,f.count,f.materialIndex)}var m=source.boundingBox;null!==m&&(this.boundingBox=m.clone());var v=source.boundingSphere;return null!==v&&(this.boundingSphere=v.clone()),this.drawRange.start=source.drawRange.start,this.drawRange.count=source.drawRange.count,this.userData=source.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),SphereGeometry.prototype=Object.create(Geometry.prototype),SphereGeometry.prototype.constructor=SphereGeometry,SphereBufferGeometry.prototype=Object.create(BufferGeometry.prototype),SphereBufferGeometry.prototype.constructor=SphereBufferGeometry;var materialId=0,v,segCenter,segDir,diff,barycoord,v0,vab,vac,vbc,vap,vbp,vcp,inverseMatrix,ray,sphere,start,end;function Material$1(){Object.defineProperty(this,"id",{value:materialId++}),this.uuid=_Math.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=NormalBlending,this.side=FrontSide,this.flatShading=!1,this.vertexTangents=!1,this.vertexColors=NoColors,this.opacity=1,this.transparent=!1,this.blendSrc=SrcAlphaFactor,this.blendDst=OneMinusSrcAlphaFactor,this.blendEquation=AddEquation,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.userData={},this.needsUpdate=!0}function MeshBasicMaterial(e){Material$1.call(this),this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function LineBasicMaterial(e){Material$1.call(this),this.type="LineBasicMaterial",this.color=new Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function Ray(e,t){this.origin=void 0!==e?e:new Vector3,this.direction=void 0!==t?t:new Vector3}function Triangle(a,b,e){this.a=void 0!==a?a:new Vector3,this.b=void 0!==b?b:new Vector3,this.c=void 0!==e?e:new Vector3}function Mesh(e,t){Object3D.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new MeshBasicMaterial({color:16777215*Math.random()}),this.drawMode=TrianglesDrawMode,this.updateMorphTargets()}function Line(e,t,r){1===r&&console.error("Line: parameter LinePieces no longer supported. Use LineSegments instead."),Object3D.call(this),this.type="Line",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new LineBasicMaterial({color:16777215*Math.random()})}Material$1.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Material$1,isMaterial:!0,onBeforeCompile:function(){},setValues:function(e){if(void 0!==e)for(var t in e){var r=e[t];if(void 0!==r)if("shading"!==t){var n=this[t];void 0!==n?n&&n.isColor?n.set(r):n&&n.isVector3&&r&&r.isVector3?n.copy(r):this[t]=r:console.warn(this.type+": '"+t+"' is not a property of this material.")}else console.warn(this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=r===FlatShading;else console.warn("Material: '"+t+"' parameter is undefined.")}},toJSON:function(meta){var e=void 0===meta||"string"==typeof meta;e&&(meta={textures:{},images:{}});var data={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function t(e){var t=[];for(var r in e){var data=e[r];delete data.metadata,t.push(data)}return t}if(data.uuid=this.uuid,data.type=this.type,""!==this.name&&(data.name=this.name),this.color&&this.color.isColor&&(data.color=this.color.getHex()),void 0!==this.roughness&&(data.roughness=this.roughness),void 0!==this.metalness&&(data.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(data.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(data.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(data.specular=this.specular.getHex()),void 0!==this.shininess&&(data.shininess=this.shininess),void 0!==this.clearCoat&&(data.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(data.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(data.map=this.map.toJSON(meta).uuid),this.alphaMap&&this.alphaMap.isTexture&&(data.alphaMap=this.alphaMap.toJSON(meta).uuid),this.lightMap&&this.lightMap.isTexture&&(data.lightMap=this.lightMap.toJSON(meta).uuid),this.aoMap&&this.aoMap.isTexture&&(data.aoMap=this.aoMap.toJSON(meta).uuid,data.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(data.bumpMap=this.bumpMap.toJSON(meta).uuid,data.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(data.normalMap=this.normalMap.toJSON(meta).uuid,data.normalMapType=this.normalMapType,data.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(data.displacementMap=this.displacementMap.toJSON(meta).uuid,data.displacementScale=this.displacementScale,data.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(data.roughnessMap=this.roughnessMap.toJSON(meta).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(data.metalnessMap=this.metalnessMap.toJSON(meta).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(data.emissiveMap=this.emissiveMap.toJSON(meta).uuid),this.specularMap&&this.specularMap.isTexture&&(data.specularMap=this.specularMap.toJSON(meta).uuid),this.envMap&&this.envMap.isTexture&&(data.envMap=this.envMap.toJSON(meta).uuid,data.reflectivity=this.reflectivity,void 0!==this.combine&&(data.combine=this.combine),void 0!==this.envMapIntensity&&(data.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(data.gradientMap=this.gradientMap.toJSON(meta).uuid),void 0!==this.size&&(data.size=this.size),void 0!==this.sizeAttenuation&&(data.sizeAttenuation=this.sizeAttenuation),this.blending!==NormalBlending&&(data.blending=this.blending),!0===this.flatShading&&(data.flatShading=this.flatShading),this.side!==FrontSide&&(data.side=this.side),this.vertexColors!==NoColors&&(data.vertexColors=this.vertexColors),this.opacity<1&&(data.opacity=this.opacity),!0===this.transparent&&(data.transparent=this.transparent),data.depthFunc=this.depthFunc,data.depthTest=this.depthTest,data.depthWrite=this.depthWrite,0!==this.rotation&&(data.rotation=this.rotation),!0===this.polygonOffset&&(data.polygonOffset=!0),0!==this.polygonOffsetFactor&&(data.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(data.polygonOffsetUnits=this.polygonOffsetUnits),1!==this.linewidth&&(data.linewidth=this.linewidth),void 0!==this.dashSize&&(data.dashSize=this.dashSize),void 0!==this.gapSize&&(data.gapSize=this.gapSize),void 0!==this.scale&&(data.scale=this.scale),!0===this.dithering&&(data.dithering=!0),this.alphaTest>0&&(data.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(data.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(data.wireframe=this.wireframe),this.wireframeLinewidth>1&&(data.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(data.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(data.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(data.morphTargets=!0),!0===this.skinning&&(data.skinning=!0),!1===this.visible&&(data.visible=!1),"{}"!==JSON.stringify(this.userData)&&(data.userData=this.userData),e){var r=t(meta.textures),n=t(meta.images);r.length>0&&(data.textures=r),n.length>0&&(data.images=n)}return data},clone:function(){return(new this.constructor).copy(this)},copy:function(source){this.name=source.name,this.fog=source.fog,this.lights=source.lights,this.blending=source.blending,this.side=source.side,this.flatShading=source.flatShading,this.vertexColors=source.vertexColors,this.opacity=source.opacity,this.transparent=source.transparent,this.blendSrc=source.blendSrc,this.blendDst=source.blendDst,this.blendEquation=source.blendEquation,this.blendSrcAlpha=source.blendSrcAlpha,this.blendDstAlpha=source.blendDstAlpha,this.blendEquationAlpha=source.blendEquationAlpha,this.depthFunc=source.depthFunc,this.depthTest=source.depthTest,this.depthWrite=source.depthWrite,this.colorWrite=source.colorWrite,this.precision=source.precision,this.polygonOffset=source.polygonOffset,this.polygonOffsetFactor=source.polygonOffsetFactor,this.polygonOffsetUnits=source.polygonOffsetUnits,this.dithering=source.dithering,this.alphaTest=source.alphaTest,this.premultipliedAlpha=source.premultipliedAlpha,this.visible=source.visible,this.userData=JSON.parse(JSON.stringify(source.userData)),this.clipShadows=source.clipShadows,this.clipIntersection=source.clipIntersection;var e=source.clippingPlanes,t=null;if(null!==e){var r=e.length;t=new Array(r);for(var i=0;i!==r;++i)t[i]=e[i].clone()}return this.clippingPlanes=t,this.shadowSide=source.shadowSide,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),MeshBasicMaterial.prototype=Object.create(Material$1.prototype),MeshBasicMaterial.prototype.constructor=MeshBasicMaterial,MeshBasicMaterial.prototype.isMeshBasicMaterial=!0,MeshBasicMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.map=source.map,this.lightMap=source.lightMap,this.lightMapIntensity=source.lightMapIntensity,this.aoMap=source.aoMap,this.aoMapIntensity=source.aoMapIntensity,this.specularMap=source.specularMap,this.alphaMap=source.alphaMap,this.envMap=source.envMap,this.combine=source.combine,this.reflectivity=source.reflectivity,this.refractionRatio=source.refractionRatio,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.wireframeLinecap=source.wireframeLinecap,this.wireframeLinejoin=source.wireframeLinejoin,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this},LineBasicMaterial.prototype=Object.create(Material$1.prototype),LineBasicMaterial.prototype.constructor=LineBasicMaterial,LineBasicMaterial.prototype.isLineBasicMaterial=!0,LineBasicMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.linewidth=source.linewidth,this.linecap=source.linecap,this.linejoin=source.linejoin,this},Object.assign(Ray.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return void 0===t&&(console.warn("Ray: .at() target is now required"),t=new Vector3),t.copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new Vector3;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){void 0===t&&(console.warn("Ray: .closestPointToPoint() target is now required"),t=new Vector3),t.subVectors(e,this.origin);var r=t.dot(this.direction);return r<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(r).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new Vector3;return function(t){var r=e.subVectors(t,this.origin).dot(this.direction);return r<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(r).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:(segCenter=new Vector3,segDir=new Vector3,diff=new Vector3,function(e,t,r,n){segCenter.copy(e).add(t).multiplyScalar(.5),segDir.copy(t).sub(e).normalize(),diff.copy(this.origin).sub(segCenter);var o,l,c,h,d=.5*e.distanceTo(t),f=-this.direction.dot(segDir),m=diff.dot(this.direction),v=-diff.dot(segDir),y=diff.lengthSq(),x=Math.abs(1-f*f);if(x>0)if(l=f*m-v,h=d*x,(o=f*v-m)>=0)if(l>=-h)if(l<=h){var w=1/x;c=(o*=w)*(o+f*(l*=w)+2*m)+l*(f*o+l+2*v)+y}else l=d,c=-(o=Math.max(0,-(f*l+m)))*o+l*(l+2*v)+y;else l=-d,c=-(o=Math.max(0,-(f*l+m)))*o+l*(l+2*v)+y;else l<=-h?c=-(o=Math.max(0,-(-f*d+m)))*o+(l=o>0?-d:Math.min(Math.max(-d,-v),d))*(l+2*v)+y:l<=h?(o=0,c=(l=Math.min(Math.max(-d,-v),d))*(l+2*v)+y):c=-(o=Math.max(0,-(f*d+m)))*o+(l=o>0?d:Math.min(Math.max(-d,-v),d))*(l+2*v)+y;else l=f>0?-d:d,c=-(o=Math.max(0,-(f*l+m)))*o+l*(l+2*v)+y;return r&&r.copy(this.direction).multiplyScalar(o).add(this.origin),n&&n.copy(segDir).multiplyScalar(l).add(segCenter),c}),intersectSphere:function(){var e=new Vector3;return function(t,r){e.subVectors(t.center,this.origin);var n=e.dot(this.direction),o=e.dot(e)-n*n,l=t.radius*t.radius;if(o>l)return null;var c=Math.sqrt(l-o),h=n-c,d=n+c;return h<0&&d<0?null:h<0?this.at(d,r):this.at(h,r)}}(),intersectsSphere:function(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var r,n,o,l,c,h,d=1/this.direction.x,f=1/this.direction.y,m=1/this.direction.z,v=this.origin;return d>=0?(r=(e.min.x-v.x)*d,n=(e.max.x-v.x)*d):(r=(e.max.x-v.x)*d,n=(e.min.x-v.x)*d),f>=0?(o=(e.min.y-v.y)*f,l=(e.max.y-v.y)*f):(o=(e.max.y-v.y)*f,l=(e.min.y-v.y)*f),r>l||o>n?null:((o>r||r!=r)&&(r=o),(l<n||n!=n)&&(n=l),m>=0?(c=(e.min.z-v.z)*m,h=(e.max.z-v.z)*m):(c=(e.max.z-v.z)*m,h=(e.min.z-v.z)*m),r>h||c>n?null:((c>r||r!=r)&&(r=c),(h<n||n!=n)&&(n=h),n<0?null:this.at(r>=0?r:n,t)))},intersectsBox:(v=new Vector3,function(e){return null!==this.intersectBox(e,v)}),intersectTriangle:function(){var e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector3;return function(a,b,o,l,c){t.subVectors(b,a),r.subVectors(o,a),n.crossVectors(t,r);var h,d=this.direction.dot(n);if(d>0){if(l)return null;h=1}else{if(!(d<0))return null;h=-1,d=-d}e.subVectors(this.origin,a);var f=h*this.direction.dot(r.crossVectors(e,r));if(f<0)return null;var m=h*this.direction.dot(t.cross(e));if(m<0)return null;if(f+m>d)return null;var v=-h*e.dot(n);return v<0?null:this.at(v/d,c)}}(),applyMatrix4:function(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),Object.assign(Triangle,{getNormal:(v0=new Vector3,function(a,b,e,t){void 0===t&&(console.warn("Triangle: .getNormal() target is now required"),t=new Vector3),t.subVectors(e,b),v0.subVectors(a,b),t.cross(v0);var r=t.lengthSq();return r>0?t.multiplyScalar(1/Math.sqrt(r)):t.set(0,0,0)}),getBarycoord:function(){var e=new Vector3,t=new Vector3,r=new Vector3;return function(n,a,b,o,l){e.subVectors(o,a),t.subVectors(b,a),r.subVectors(n,a);var c=e.dot(e),h=e.dot(t),d=e.dot(r),f=t.dot(t),m=t.dot(r),v=c*f-h*h;if(void 0===l&&(console.warn("Triangle: .getBarycoord() target is now required"),l=new Vector3),0===v)return l.set(-2,-1,-1);var y=1/v,u=(f*d-h*m)*y,x=(c*m-h*d)*y;return l.set(1-u-x,x,u)}}(),containsPoint:function(){var e=new Vector3;return function(t,a,b,r){return Triangle.getBarycoord(t,a,b,r,e),e.x>=0&&e.y>=0&&e.x+e.y<=1}}(),getUV:(barycoord=new Vector3,function(e,t,r,n,o,l,c,h){return this.getBarycoord(e,t,r,n,barycoord),h.set(0,0),h.addScaledVector(o,barycoord.x),h.addScaledVector(l,barycoord.y),h.addScaledVector(c,barycoord.z),h})}),Object.assign(Triangle.prototype,{set:function(a,b,e){return this.a.copy(a),this.b.copy(b),this.c.copy(e),this},setFromPointsAndIndices:function(e,t,r,n){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},getArea:function(){var e=new Vector3,t=new Vector3;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),getMidpoint:function(e){return void 0===e&&(console.warn("Triangle: .getMidpoint() target is now required"),e=new Vector3),e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},getNormal:function(e){return Triangle.getNormal(this.a,this.b,this.c,e)},getPlane:function(e){return void 0===e&&(console.warn("Triangle: .getPlane() target is now required"),e=new Vector3),e.setFromCoplanarPoints(this.a,this.b,this.c)},getBarycoord:function(e,t){return Triangle.getBarycoord(e,this.a,this.b,this.c,t)},containsPoint:function(e){return Triangle.containsPoint(e,this.a,this.b,this.c)},getUV:function(e,t,r,n,o){return Triangle.getUV(e,this.a,this.b,this.c,t,r,n,o)},intersectsBox:function(e){return e.intersectsTriangle(this)},closestPointToPoint:(vab=new Vector3,vac=new Vector3,vbc=new Vector3,vap=new Vector3,vbp=new Vector3,vcp=new Vector3,function(p,e){void 0===e&&(console.warn("Triangle: .closestPointToPoint() target is now required"),e=new Vector3);var t,r,a=this.a,b=this.b,n=this.c;vab.subVectors(b,a),vac.subVectors(n,a),vap.subVectors(p,a);var o=vab.dot(vap),l=vac.dot(vap);if(o<=0&&l<=0)return e.copy(a);vbp.subVectors(p,b);var c=vab.dot(vbp),h=vac.dot(vbp);if(c>=0&&h<=c)return e.copy(b);var d=o*h-c*l;if(d<=0&&o>=0&&c<=0)return t=o/(o-c),e.copy(a).addScaledVector(vab,t);vcp.subVectors(p,n);var f=vab.dot(vcp),m=vac.dot(vcp);if(m>=0&&f<=m)return e.copy(n);var v=f*l-o*m;if(v<=0&&l>=0&&m<=0)return r=l/(l-m),e.copy(a).addScaledVector(vac,r);var y=c*m-f*h;if(y<=0&&h-c>=0&&f-m>=0)return vbc.subVectors(n,b),r=(h-c)/(h-c+(f-m)),e.copy(b).addScaledVector(vbc,r);var x=1/(y+v+d);return t=v*x,r=d*x,e.copy(a).addScaledVector(vab,t).addScaledVector(vac,r)}),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Mesh.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Mesh,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(source){return Object3D.prototype.copy.call(this,source),this.drawMode=source.drawMode,void 0!==source.morphTargetInfluences&&(this.morphTargetInfluences=source.morphTargetInfluences.slice()),void 0!==source.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},source.morphTargetDictionary)),this},updateMorphTargets:function(){var e,t,r,n=this.geometry;if(n.isBufferGeometry){var o=n.morphAttributes,l=Object.keys(o);if(l.length>0){var c=o[l[0]];if(void 0!==c)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},e=0,t=c.length;e<t;e++)r=c[e].name||String(e),this.morphTargetInfluences.push(0),this.morphTargetDictionary[r]=e}}else{var h=n.morphTargets;void 0!==h&&h.length>0&&console.error("Mesh.updateMorphTargets() no longer supports Geometry. Use BufferGeometry instead.")}},raycast:function(){var e=new Matrix4,t=new Ray,r=new Sphere,n=new Vector3,o=new Vector3,l=new Vector3,c=new Vector3,h=new Vector3,d=new Vector3,f=new Vector2,m=new Vector2,v=new Vector2,y=new Vector3,x=new Vector3;function w(object,e,t,r,n,o,l,c){if(null===(e.side===BackSide?r.intersectTriangle(l,o,n,!0,c):r.intersectTriangle(n,o,l,e.side!==DoubleSide,c)))return null;x.copy(c),x.applyMatrix4(object.matrixWorld);var h=t.ray.origin.distanceTo(x);return h<t.near||h>t.far?null:{distance:h,point:x.clone(),object:object}}function M(object,e,t,r,c,h,a,b,d){n.fromBufferAttribute(c,a),o.fromBufferAttribute(c,b),l.fromBufferAttribute(c,d);var x=w(object,e,t,r,n,o,l,y);if(x){h&&(f.fromBufferAttribute(h,a),m.fromBufferAttribute(h,b),v.fromBufferAttribute(h,d),x.uv=Triangle.getUV(y,n,o,l,f,m,v,new Vector2));var M=new Face3(a,b,d);Triangle.getNormal(n,o,l,M.normal),x.face=M}return x}return function(x,S){var A,T=this.geometry,_=this.material,L=this.matrixWorld;if(void 0!==_&&(null===T.boundingSphere&&T.computeBoundingSphere(),r.copy(T.boundingSphere),r.applyMatrix4(L),!1!==x.ray.intersectsSphere(r)&&(e.getInverse(L),t.copy(x.ray).applyMatrix4(e),null===T.boundingBox||!1!==t.intersectsBox(T.boundingBox))))if(T.isBufferGeometry){var a,b,C,i,N,P,E,D,F,R=T.index,O=T.attributes.position,B=T.attributes.uv,I=T.groups,U=T.drawRange;if(null!==R)if(Array.isArray(_))for(i=0,P=I.length;i<P;i++)for(F=_[(D=I[i]).materialIndex],N=Math.max(D.start,U.start),E=Math.min(D.start+D.count,U.start+U.count);N<E;N+=3)a=R.getX(N),b=R.getX(N+1),C=R.getX(N+2),(A=M(this,F,x,t,O,B,a,b,C))&&(A.faceIndex=Math.floor(N/3),A.face.materialIndex=D.materialIndex,S.push(A));else for(i=Math.max(0,U.start),P=Math.min(R.count,U.start+U.count);i<P;i+=3)a=R.getX(i),b=R.getX(i+1),C=R.getX(i+2),(A=M(this,_,x,t,O,B,a,b,C))&&(A.faceIndex=Math.floor(i/3),S.push(A));else if(void 0!==O)if(Array.isArray(_))for(i=0,P=I.length;i<P;i++)for(F=_[(D=I[i]).materialIndex],N=Math.max(D.start,U.start),E=Math.min(D.start+D.count,U.start+U.count);N<E;N+=3)(A=M(this,F,x,t,O,B,a=N,b=N+1,C=N+2))&&(A.faceIndex=Math.floor(N/3),A.face.materialIndex=D.materialIndex,S.push(A));else for(i=Math.max(0,U.start),P=Math.min(O.count,U.start+U.count);i<P;i+=3)(A=M(this,_,x,t,O,B,a=i,b=i+1,C=i+2))&&(A.faceIndex=Math.floor(i/3),S.push(A))}else if(T.isGeometry){var V,k,G,z,j=Array.isArray(_),W=T.vertices,H=T.faces,X=T.faceVertexUvs[0];X.length>0&&(z=X);for(var Y=0,Q=H.length;Y<Q;Y++){var K=H[Y],J=j?_[K.materialIndex]:_;if(void 0!==J){if(V=W[K.a],k=W[K.b],G=W[K.c],!0===J.morphTargets){var Z=T.morphTargets,$=this.morphTargetInfluences;n.set(0,0,0),o.set(0,0,0),l.set(0,0,0);for(var ee=0,te=Z.length;ee<te;ee++){var re=$[ee];if(0!==re){var ie=Z[ee].vertices;n.addScaledVector(c.subVectors(ie[K.a],V),re),o.addScaledVector(h.subVectors(ie[K.b],k),re),l.addScaledVector(d.subVectors(ie[K.c],G),re)}}n.add(V),o.add(k),l.add(G),V=n,k=o,G=l}if(A=w(this,J,x,t,V,k,G,y)){if(z&&z[Y]){var ne=z[Y];f.copy(ne[0]),m.copy(ne[1]),v.copy(ne[2]),A.uv=Triangle.getUV(y,V,k,G,f,m,v,new Vector2)}A.face=K,A.faceIndex=Y,S.push(A)}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Line.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Line,isLine:!0,computeLineDistances:(start=new Vector3,end=new Vector3,function(){var e=this.geometry;if(e.isBufferGeometry)if(null===e.index){for(var t=e.attributes.position,r=[0],i=1,n=t.count;i<n;i++)start.fromBufferAttribute(t,i-1),end.fromBufferAttribute(t,i),r[i]=r[i-1],r[i]+=start.distanceTo(end);e.addAttribute("lineDistance",new Float32BufferAttribute(r,1))}else console.warn("Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(e.isGeometry){var o=e.vertices;for((r=e.lineDistances)[0]=0,i=1,n=o.length;i<n;i++)r[i]=r[i-1],r[i]+=o[i-1].distanceTo(o[i])}return this}),raycast:(inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere,function(e,t){var r=e.linePrecision,n=this.geometry,o=this.matrixWorld;if(null===n.boundingSphere&&n.computeBoundingSphere(),sphere.copy(n.boundingSphere),sphere.applyMatrix4(o),sphere.radius+=r,!1!==e.ray.intersectsSphere(sphere)){inverseMatrix.getInverse(o),ray.copy(e.ray).applyMatrix4(inverseMatrix);var l=r/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,h=new Vector3,d=new Vector3,f=new Vector3,m=new Vector3,v=this&&this.isLineSegments?2:1;if(n.isBufferGeometry){var y=n.index,x=n.attributes.position.array;if(null!==y)for(var w=y.array,i=0,M=w.length-1;i<M;i+=v){var a=w[i],b=w[i+1];h.fromArray(x,3*a),d.fromArray(x,3*b),ray.distanceSqToSegment(h,d,m,f)>c||(m.applyMatrix4(this.matrixWorld),(T=e.ray.origin.distanceTo(m))<e.near||T>e.far||t.push({distance:T,point:f.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this}))}else for(i=0,M=x.length/3-1;i<M;i+=v)h.fromArray(x,3*i),d.fromArray(x,3*i+3),ray.distanceSqToSegment(h,d,m,f)>c||(m.applyMatrix4(this.matrixWorld),(T=e.ray.origin.distanceTo(m))<e.near||T>e.far||t.push({distance:T,point:f.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this}))}else if(n.isGeometry){var S=n.vertices,A=S.length;for(i=0;i<A-1;i+=v){var T;ray.distanceSqToSegment(S[i],S[i+1],m,f)>c||(m.applyMatrix4(this.matrixWorld),(T=e.ray.origin.distanceTo(m))<e.near||T>e.far||t.push({distance:T,point:f.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this}))}}}}),copy:function(source){return Object3D.prototype.copy.call(this,source),this.geometry.copy(source.geometry),this.material.copy(source.material),this},clone:function(){return(new this.constructor).copy(this)}});var CCDIKSolver=function(){function e(e,t){this.mesh=e,this.iks=t||[],this._valid()}function t(e,t){Object3D.call(this),this.root=e,this.iks=t||[],this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.sphereGeometry=new SphereBufferGeometry(.25,16,8),this.targetSphereMaterial=new MeshBasicMaterial({color:new Color(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new MeshBasicMaterial({color:new Color(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new MeshBasicMaterial({color:new Color(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new LineBasicMaterial({color:new Color(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init()}return e.prototype={constructor:e,update:function(){var q=new Quaternion,e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector3,o=new Vector3,l=new Quaternion,c=new Vector3,h=new Vector3,d=new Vector3;return function(){for(var f=this.mesh.skeleton.bones,m=this.iks,v=Math,i=0,y=m.length;i<y;i++){var x=m[i],w=f[x.effector],M=f[x.target];e.setFromMatrixPosition(M.matrixWorld);for(var S=x.links,A=void 0!==x.iteration?x.iteration:1,T=0;T<A;T++){for(var _=!1,L=0,C=S.length;L<C;L++){var link=f[S[L].index];if(!1===S[L].enabled)break;var N=S[L].limitation,P=S[L].rotationMin,E=S[L].rotationMax;link.matrixWorld.decompose(o,l,c),l.inverse(),r.setFromMatrixPosition(w.matrixWorld),n.subVectors(r,o),n.applyQuaternion(l),n.normalize(),t.subVectors(e,o),t.applyQuaternion(l),t.normalize();var D=t.dot(n);if(D>1?D=1:D<-1&&(D=-1),!((D=v.acos(D))<1e-5)){if(void 0!==x.minAngle&&D<x.minAngle&&(D=x.minAngle),void 0!==x.maxAngle&&D>x.maxAngle&&(D=x.maxAngle),h.crossVectors(n,t),h.normalize(),q.setFromAxisAngle(h,D),link.quaternion.multiply(q),void 0!==N){var F=link.quaternion.w;F>1&&(F=1);var R=v.sqrt(1-F*F);link.quaternion.set(N.x*R,N.y*R,N.z*R,F)}void 0!==P&&link.rotation.setFromVector3(link.rotation.toVector3(d).max(P)),void 0!==E&&link.rotation.setFromVector3(link.rotation.toVector3(d).min(E)),link.updateMatrixWorld(!0),_=!0}}if(!_)break}}return this}}(),createHelper:function(){return new t(this.mesh,this.mesh.geometry.userData.MMD.iks)},_valid:function(){for(var e=this.iks,t=this.mesh.skeleton.bones,i=0,r=e.length;i<r;i++){var n,o,l=e[i],c=t[l.effector],h=l.links;n=c;for(var d=0,f=h.length;d<f;d++)o=t[h[d].index],n.parent!==o&&console.warn("CCDIKSolver: bone "+n.name+" is not the child of bone "+o.name),n=o}}},t.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:t,updateMatrixWorld:function(){var e=new Matrix4,t=new Vector3;function r(e,r){return t.setFromMatrixPosition(e.matrixWorld).applyMatrix4(r)}function n(e,t,n,o){var l=r(n,o);e[3*t+0]=l.x,e[3*t+1]=l.y,e[3*t+2]=l.z}return function(t){var o=this.root;if(this.visible){var l=0,c=this.iks,h=o.skeleton.bones;e.getInverse(o.matrixWorld);for(var i=0,d=c.length;i<d;i++){var f=c[i],m=h[f.target],v=h[f.effector],y=this.children[l++],x=this.children[l++];y.position.copy(r(m,e)),x.position.copy(r(v,e));for(var w=0,M=f.links.length;w<M;w++){var S=h[f.links[w].index];this.children[l++].position.copy(r(S,e))}var line=this.children[l++],A=line.geometry.attributes.position.array;n(A,0,m,e),n(A,1,v,e);for(w=0,M=f.links.length;w<M;w++){n(A,w+2,S=h[f.links[w].index],e)}line.geometry.attributes.position.needsUpdate=!0}}this.matrix.copy(o.matrixWorld),Object3D.prototype.updateMatrixWorld.call(this,t)}}(),_init:function(){var e=this,t=this.iks;function r(t){return new Line(function(e){var t=new BufferGeometry,r=new Float32Array(3*(2+e.links.length));return t.addAttribute("position",new BufferAttribute(r,3)),t}(t),e.lineMaterial)}for(var i=0,n=t.length;i<n;i++){var o=t[i];this.add(new Mesh(e.sphereGeometry,e.targetSphereMaterial)),this.add(new Mesh(e.sphereGeometry,e.effectorSphereMaterial));for(var l=0,c=o.links.length;l<c;l++)this.add(new Mesh(e.sphereGeometry,e.linkSphereMaterial));this.add(r(o))}}}),e}();function AnimationAction(e,t,r){this._mixer=e,this._clip=t,this._localRoot=r||null;for(var n=t.tracks,o=n.length,l=new Array(o),c={endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding},i=0;i!==o;++i){var h=n[i].createInterpolant(null);l[i]=h,h.settings=c}this._interpolantSettings=c,this._interpolants=l,this._propertyBindings=new Array(o),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=LoopRepeat,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function Interpolant(e,t,r,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(r),this.sampleValues=t,this.valueSize=r}function LinearInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}Object.assign(AnimationAction.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(time){return this._startTime=time,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,r){if(e.fadeOut(t),this.fadeIn(t),r){var n=this._clip.duration,o=e._clip.duration,l=o/n,c=n/o;e.warp(1,l,t),this.warp(c,1,t)}return this},crossFadeTo:function(e,t,r){return e.crossFadeFrom(this,t,r)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,r){var n=this._mixer,o=n.time,l=this._timeScaleInterpolant,c=this.timeScale;null===l&&(l=n._lendControlInterpolant(),this._timeScaleInterpolant=l);var h=l.parameterPositions,d=l.sampleValues;return h[0]=o,h[1]=o+r,d[0]=e/c,d[1]=t/c,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(time,e,t,r){if(this.enabled){var n=this._startTime;if(null!==n){var o=(time-n)*t;if(o<0||0===t)return;this._startTime=null,e=t*o}e*=this._updateTimeScale(time);var l=this._updateTime(e),c=this._updateWeight(time);if(c>0)for(var h=this._interpolants,d=this._propertyBindings,f=0,m=h.length;f!==m;++f)h[f].evaluate(l),d[f].accumulate(r,c)}else this._updateWeight(time)},_updateWeight:function(time){var e=0;if(this.enabled){e=this.weight;var t=this._weightInterpolant;if(null!==t){var r=t.evaluate(time)[0];e*=r,time>t.parameterPositions[1]&&(this.stopFading(),0===r&&(this.enabled=!1))}}return this._effectiveWeight=e,e},_updateTimeScale:function(time){var e=0;if(!this.paused){e=this.timeScale;var t=this._timeScaleInterpolant;if(null!==t)e*=t.evaluate(time)[0],time>t.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}return this._effectiveTimeScale=e,e},_updateTime:function(e){var time=this.time+e,t=this._clip.duration,r=this.loop,n=this._loopCount,o=r===LoopPingPong;if(0===e)return-1===n?time:o&&1==(1&n)?t-time:time;if(r===LoopOnce){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(time>=t)time=t;else{if(!(time<0))break e;time=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===n&&(e>=0?(n=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),time>=t||time<0){var l=Math.floor(time/t);time-=t*l,n+=Math.abs(l);var c=this.repetitions-n;if(c<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,time=e>0?t:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===c){var h=e<0;this._setEndings(h,!h,o)}else this._setEndings(!1,!1,o);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:l})}}if(o&&1==(1&n))return this.time=time,t-time}return this.time=time,time},_setEndings:function(e,t,r){var n=this._interpolantSettings;r?(n.endingStart=ZeroSlopeEnding,n.endingEnd=ZeroSlopeEnding):(n.endingStart=e?this.zeroSlopeAtStart?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding,n.endingEnd=t?this.zeroSlopeAtEnd?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding)},_scheduleFading:function(e,t,r){var n=this._mixer,o=n.time,l=this._weightInterpolant;null===l&&(l=n._lendControlInterpolant(),this._weightInterpolant=l);var c=l.parameterPositions,h=l.sampleValues;return c[0]=o,h[0]=t,c[1]=o+e,h[1]=r,this}}),Object.assign(Interpolant.prototype,{evaluate:function(e){var t=this.parameterPositions,r=this._cachedIndex,n=t[r],o=t[r-1];e:{t:{var l;r:{i:if(!(e<n)){for(var c=r+2;;){if(void 0===n){if(e<o)break i;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,o)}if(r===c)break;if(o=n,e<(n=t[++r]))break t}l=t.length;break r}if(e>=o)break e;var h=t[1];e<h&&(r=2,o=h);for(c=r-2;;){if(void 0===o)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(r===c)break;if(n=o,e>=(o=t[--r-1]))break t}l=r,r=0}for(;r<l;){var d=r+l>>>1;e<t[d]?l=d:r=d+1}if(n=t[r],void 0===(o=t[r-1]))return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,o,e)}this._cachedIndex=r,this.intervalChanged_(r,o,n)}return this.interpolate_(r,o,e,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,o=e*n,i=0;i!==n;++i)t[i]=r[o+i];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(Interpolant.prototype,{beforeStart_:Interpolant.prototype.copySampleValue_,afterEnd_:Interpolant.prototype.copySampleValue_}),LinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:LinearInterpolant,interpolate_:function(e,t,r,n){for(var o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,h=e*c,d=h-c,f=(r-t)/(n-t),m=1-f,i=0;i!==c;++i)o[i]=l[d+i]*m+l[h+i]*f;return o}});var RESERVED_CHARS_RE="\\[\\]\\.:\\/",wordChar,wordCharOrDot,directoryRe,nodeRe,objectRe,propertyRe,trackRe,supportedObjectNames,reservedRe;function Composite(e,path,t){var r=t||PropertyBinding.parseTrackName(path);this._targetGroup=e,this._bindings=e.subscribe_(path,r)}function PropertyBinding(e,path,t){this.path=path,this.parsedPath=t||PropertyBinding.parseTrackName(path),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function PropertyMixer(e,t,r){this.binding=e,this.valueSize=r;var n,o=Float64Array;switch(t){case"quaternion":n=this._slerp;break;case"string":case"bool":o=Array,n=this._select;break;default:n=this._lerp}this.buffer=new o(4*r),this._mixBufferRegion=n,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}Object.assign(Composite.prototype,{getValue:function(e,t){this.bind();var r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(e,t)},setValue:function(e,t){for(var r=this._bindings,i=this._targetGroup.nCachedObjects_,n=r.length;i!==n;++i)r[i].setValue(e,t)},bind:function(){for(var e=this._bindings,i=this._targetGroup.nCachedObjects_,t=e.length;i!==t;++i)e[i].bind()},unbind:function(){for(var e=this._bindings,i=this._targetGroup.nCachedObjects_,t=e.length;i!==t;++i)e[i].unbind()}}),Object.assign(PropertyBinding,{Composite:Composite,create:function(e,path,t){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,path,t):new PropertyBinding(e,path,t)},sanitizeNodeName:(reservedRe=new RegExp("["+RESERVED_CHARS_RE+"]","g"),function(e){return e.replace(/\s/g,"_").replace(reservedRe,"")}),parseTrackName:(wordChar="[^"+RESERVED_CHARS_RE+"]",wordCharOrDot="[^"+RESERVED_CHARS_RE.replace("\\.","")+"]",directoryRe=/((?:WC+[\/:])*)/.source.replace("WC",wordChar),nodeRe=/(WCOD+)?/.source.replace("WCOD",wordCharOrDot),objectRe=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",wordChar),propertyRe=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",wordChar),trackRe=new RegExp("^"+directoryRe+nodeRe+objectRe+propertyRe+"$"),supportedObjectNames=["material","materials","bones"],function(e){var t=trackRe.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var r={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){var o=r.nodeName.substring(n+1);-1!==supportedObjectNames.indexOf(o)&&(r.nodeName=r.nodeName.substring(0,n),r.objectName=o)}if(null===r.propertyName||0===r.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return r}),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var r=e.skeleton.getBoneByName(t);if(void 0!==r)return r}if(e.children){var n=function(e){for(var i=0;i<e.length;i++){var r=e[i];if(r.name===t||r.uuid===t)return r;var o=n(r.children);if(o)return o}return null},o=n(e.children);if(o)return o}return null}}),Object.assign(PropertyBinding.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var source=this.resolvedProperty,i=0,r=source.length;i!==r;++i)e[t++]=source[i]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.targetObject[this.propertyName]=e[t]},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++]},function(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,r=t.objectName,n=t.propertyName,o=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,e){if(r){var l=t.objectIndex;switch(r){case"materials":if(!e.material)return void console.error("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(var i=0;i<e.length;i++)if(e[i].name===l){l=i;break}break;default:if(void 0===e[r])return void console.error("PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==l){if(void 0===e[l])return void console.error("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[l]}}var c=e[n];if(void 0!==c){var h=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?h=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(h=this.Versioning.MatrixWorldNeedsUpdate);var d=this.BindingType.Direct;if(void 0!==o){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(e.geometry.isBufferGeometry){if(!e.geometry.morphAttributes)return void console.error("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);for(i=0;i<this.node.geometry.morphAttributes.position.length;i++)if(e.geometry.morphAttributes.position[i].name===o){o=i;break}}else{if(!e.geometry.morphTargets)return void console.error("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphTargets.",this);for(i=0;i<this.node.geometry.morphTargets.length;i++)if(e.geometry.morphTargets[i].name===o){o=i;break}}}d=this.BindingType.ArrayElement,this.resolvedProperty=c,this.propertyIndex=o}else void 0!==c.fromArray&&void 0!==c.toArray?(d=this.BindingType.HasFromToArray,this.resolvedProperty=c):Array.isArray(c)?(d=this.BindingType.EntireArray,this.resolvedProperty=c):this.propertyName=n;this.getValue=this.GetterByBindingType[d],this.setValue=this.SetterByBindingTypeAndVersioning[d][h]}else{var f=t.nodeName;console.error("PropertyBinding: Trying to update property for track: "+f+"."+n+" but it wasn't found.",e)}}else console.error("PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(PropertyBinding.prototype,{_getValue_unbound:PropertyBinding.prototype.getValue,_setValue_unbound:PropertyBinding.prototype.setValue}),Object.assign(PropertyMixer.prototype,{accumulate:function(e,t){var r=this.buffer,n=this.valueSize,o=e*n+n,l=this.cumulativeWeight;if(0===l){for(var i=0;i!==n;++i)r[o+i]=r[i];l=t}else{var c=t/(l+=t);this._mixBufferRegion(r,o,0,c,n)}this.cumulativeWeight=l},apply:function(e){var t=this.valueSize,r=this.buffer,n=e*t+t,o=this.cumulativeWeight,l=this.binding;if(this.cumulativeWeight=0,o<1){var c=3*t;this._mixBufferRegion(r,n,c,1-o,t)}for(var i=t,h=t+t;i!==h;++i)if(r[i]!==r[i+t]){l.setValue(r,n);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,r=this.valueSize,n=3*r;e.getValue(t,n);for(var i=r,o=n;i!==o;++i)t[i]=t[n+i%r];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,r,n,o){if(n>=.5)for(var i=0;i!==o;++i)e[t+i]=e[r+i]},_slerp:function(e,t,r,n){Quaternion.slerpFlat(e,t,e,t,e,r,n)},_lerp:function(e,t,r,n,o){for(var s=1-n,i=0;i!==o;++i){var l=t+i;e[l]=e[l]*s+e[r+i]*n}}});var AnimationUtils={arraySlice:function(e,t,r){return AnimationUtils.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==r?r:e.length)):e.slice(t,r)},convertArray:function(e,t,r){return!e||!r&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(object){return ArrayBuffer.isView(object)&&!(object instanceof DataView)},getKeyframeOrder:function(e){for(var t=e.length,r=new Array(t),i=0;i!==t;++i)r[i]=i;return r.sort((function(i,t){return e[i]-e[t]})),r},sortedArray:function(e,t,r){for(var n=e.length,o=new e.constructor(n),i=0,l=0;l!==n;++i)for(var c=r[i]*t,h=0;h!==t;++h)o[l++]=e[c+h];return o},flattenJSON:function(e,t,r,n){for(var i=1,o=e[0];void 0!==o&&void 0===o[n];)o=e[i++];if(void 0!==o){var l=o[n];if(void 0!==l)if(Array.isArray(l))do{void 0!==(l=o[n])&&(t.push(o.time),r.push.apply(r,l)),o=e[i++]}while(void 0!==o);else if(void 0!==l.toArray)do{void 0!==(l=o[n])&&(t.push(o.time),l.toArray(r,r.length)),o=e[i++]}while(void 0!==o);else do{void 0!==(l=o[n])&&(t.push(o.time),r.push(l)),o=e[i++]}while(void 0!==o)}}};function CubicInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function DiscreteInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}function KeyframeTrack(e,t,r,n){if(void 0===e)throw new Error("KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=AnimationUtils.convertArray(t,this.TimeBufferType),this.values=AnimationUtils.convertArray(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}function BooleanKeyframeTrack(e,t,r){KeyframeTrack.call(this,e,t,r)}function ColorKeyframeTrack(e,t,r,n){KeyframeTrack.call(this,e,t,r,n)}function NumberKeyframeTrack(e,t,r,n){KeyframeTrack.call(this,e,t,r,n)}function QuaternionLinearInterpolant(e,t,r,n){Interpolant.call(this,e,t,r,n)}function QuaternionKeyframeTrack(e,t,r,n){KeyframeTrack.call(this,e,t,r,n)}function StringKeyframeTrack(e,t,r,n){KeyframeTrack.call(this,e,t,r,n)}function VectorKeyframeTrack(e,t,r,n){KeyframeTrack.call(this,e,t,r,n)}function AnimationClip(e,t,r){this.name=e,this.tracks=r,this.duration=void 0!==t?t:-1,this.uuid=_Math.generateUUID(),this.duration<0&&this.resetDuration()}function getTrackTypeForValueTypeName(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("KeyframeTrack: Unsupported typeName: "+e)}function parseKeyframeTrack(e){if(void 0===e.type)throw new Error("KeyframeTrack: track type undefined, can not parse");var t=getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var r=[],n=[];AnimationUtils.flattenJSON(e.keys,r,n,"value"),e.times=r,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}function AnimationMixer(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Bone(){Object3D.call(this),this.type="Bone"}function BoxGeometry(e,t,r,n,o,l){Geometry.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:o,depthSegments:l},this.fromBufferGeometry(new BoxBufferGeometry(e,t,r,n,o,l)),this.mergeVertices()}function BoxBufferGeometry(e,t,r,n,o,l){BufferGeometry.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:o,depthSegments:l};var c=this;e=e||1,t=t||1,r=r||1,n=Math.floor(n)||1,o=Math.floor(o)||1,l=Math.floor(l)||1;var h=[],d=[],f=[],m=[],v=0,y=0;function x(u,e,t,r,n,o,l,x,w,M,S){var A,T,_=o/w,L=l/M,C=o/2,N=l/2,P=x/2,E=w+1,D=M+1,F=0,R=0,O=new Vector3;for(T=0;T<D;T++){var B=T*L-N;for(A=0;A<E;A++){var I=A*_-C;O[u]=I*r,O[e]=B*n,O[t]=P,d.push(O.x,O.y,O.z),O[u]=0,O[e]=0,O[t]=x>0?1:-1,f.push(O.x,O.y,O.z),m.push(A/w),m.push(1-T/M),F+=1}}for(T=0;T<M;T++)for(A=0;A<w;A++){var a=v+A+E*T,b=v+A+E*(T+1),U=v+(A+1)+E*(T+1),V=v+(A+1)+E*T;h.push(a,b,V),h.push(b,U,V),R+=6}c.addGroup(y,R,S),y+=R,v+=F}x("z","y","x",-1,-1,r,t,e,l,o,0),x("z","y","x",1,-1,r,t,-e,l,o,1),x("x","z","y",1,1,e,r,t,n,l,2),x("x","z","y",1,-1,e,r,-t,n,l,3),x("x","y","z",1,-1,e,t,r,n,o,4),x("x","y","z",-1,-1,e,t,-r,n,o,5),this.setIndex(h),this.addAttribute("position",new Float32BufferAttribute(d,3)),this.addAttribute("normal",new Float32BufferAttribute(f,3)),this.addAttribute("uv",new Float32BufferAttribute(m,2))}function CylinderGeometry(e,t,r,n,o,l,c,h){Geometry.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:o,openEnded:l,thetaStart:c,thetaLength:h},this.fromBufferGeometry(new CylinderBufferGeometry(e,t,r,n,o,l,c,h)),this.mergeVertices()}function CylinderBufferGeometry(e,t,r,n,o,l,c,h){BufferGeometry.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:o,openEnded:l,thetaStart:c,thetaLength:h};var d=this;e=void 0!==e?e:1,t=void 0!==t?t:1,r=r||1,n=Math.floor(n)||8,o=Math.floor(o)||1,l=void 0!==l&&l,c=void 0!==c?c:0,h=void 0!==h?h:2*Math.PI;var f=[],m=[],v=[],y=[],x=0,w=[],M=r/2,S=0;function A(r){var o,l,w,A=new Vector2,T=new Vector3,_=0,L=!0===r?e:t,C=!0===r?1:-1;for(l=x,o=1;o<=n;o++)m.push(0,M*C,0),v.push(0,C,0),y.push(.5,.5),x++;for(w=x,o=0;o<=n;o++){var N=o/n*h+c,P=Math.cos(N),E=Math.sin(N);T.x=L*E,T.y=M*C,T.z=L*P,m.push(T.x,T.y,T.z),v.push(0,C,0),A.x=.5*P+.5,A.y=.5*E*C+.5,y.push(A.x,A.y),x++}for(o=0;o<n;o++){var D=l+o,i=w+o;!0===r?f.push(i,i+1,D):f.push(i+1,i,D),_+=3}d.addGroup(S,_,!0===r?1:2),S+=_}!function(){var l,A,T=new Vector3,_=new Vector3,L=0,C=(t-e)/r;for(A=0;A<=o;A++){var N=[],P=A/o,E=P*(t-e)+e;for(l=0;l<=n;l++){var u=l/n,D=u*h+c,F=Math.sin(D),R=Math.cos(D);_.x=E*F,_.y=-P*r+M,_.z=E*R,m.push(_.x,_.y,_.z),T.set(F,C,R).normalize(),v.push(T.x,T.y,T.z),y.push(u,1-P),N.push(x++)}w.push(N)}for(l=0;l<n;l++)for(A=0;A<o;A++){var a=w[A][l],b=w[A+1][l],O=w[A+1][l+1],B=w[A][l+1];f.push(a,b,B),f.push(b,O,B),L+=6}d.addGroup(S,L,0),S+=L}(),!1===l&&(e>0&&A(!0),t>0&&A(!1)),this.setIndex(f),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(y,2))}CubicInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:CubicInterpolant,DefaultSettings_:{endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding},intervalChanged_:function(e,t,r){var n=this.parameterPositions,o=e-2,l=e+1,c=n[o],h=n[l];if(void 0===c)switch(this.getSettings_().endingStart){case ZeroSlopeEnding:o=e,c=2*t-r;break;case WrapAroundEnding:c=t+n[o=n.length-2]-n[o+1];break;default:o=e,c=r}if(void 0===h)switch(this.getSettings_().endingEnd){case ZeroSlopeEnding:l=e,h=2*r-t;break;case WrapAroundEnding:l=1,h=r+n[1]-n[0];break;default:l=e-1,h=t}var d=.5*(r-t),f=this.valueSize;this._weightPrev=d/(t-c),this._weightNext=d/(h-r),this._offsetPrev=o*f,this._offsetNext=l*f},interpolate_:function(e,t,r,n){for(var o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,h=e*c,d=h-c,f=this._offsetPrev,m=this._offsetNext,v=this._weightPrev,y=this._weightNext,p=(r-t)/(n-t),x=p*p,w=x*p,M=-v*w+2*v*x-v*p,S=(1+v)*w+(-1.5-2*v)*x+(-.5+v)*p+1,A=(-1-y)*w+(1.5+y)*x+.5*p,T=y*w-y*x,i=0;i!==c;++i)o[i]=M*l[f+i]+S*l[d+i]+A*l[h+i]+T*l[m+i];return o}}),DiscreteInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:DiscreteInterpolant,interpolate_:function(e){return this.copySampleValue_(e-1)}}),Object.assign(KeyframeTrack,{toJSON:function(track){var e,t=track.constructor;if(void 0!==t.toJSON)e=t.toJSON(track);else{e={name:track.name,times:AnimationUtils.convertArray(track.times,Array),values:AnimationUtils.convertArray(track.values,Array)};var r=track.getInterpolation();r!==track.DefaultInterpolation&&(e.interpolation=r)}return e.type=track.ValueTypeName,e}}),Object.assign(KeyframeTrack.prototype,{constructor:KeyframeTrack,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:InterpolateLinear,InterpolantFactoryMethodDiscrete:function(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case InterpolateDiscrete:t=this.InterpolantFactoryMethodDiscrete;break;case InterpolateLinear:t=this.InterpolantFactoryMethodLinear;break;case InterpolateSmooth:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){var r="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(r);this.setInterpolation(this.DefaultInterpolation)}return console.warn("KeyframeTrack:",r),this}return this.createInterpolant=t,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return InterpolateDiscrete;case this.InterpolantFactoryMethodLinear:return InterpolateLinear;case this.InterpolantFactoryMethodSmooth:return InterpolateSmooth}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,i=0,r=t.length;i!==r;++i)t[i]*=e;return this},trim:function(e,t){for(var r=this.times,n=r.length,o=0,l=n-1;o!==n&&r[o]<e;)++o;for(;-1!==l&&r[l]>t;)--l;if(++l,0!==o||l!==n){o>=l&&(o=(l=Math.max(l,1))-1);var c=this.getValueSize();this.times=AnimationUtils.arraySlice(r,o,l),this.values=AnimationUtils.arraySlice(this.values,o*c,l*c)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("KeyframeTrack: Invalid value size in track.",this),e=!1);var r=this.times,n=this.values,o=r.length;0===o&&(console.error("KeyframeTrack: Track is empty.",this),e=!1);for(var l=null,i=0;i!==o;i++){var c=r[i];if("number"==typeof c&&isNaN(c)){console.error("KeyframeTrack: Time is not a valid number.",this,i,c),e=!1;break}if(null!==l&&l>c){console.error("KeyframeTrack: Out of order keys.",this,i,c,l),e=!1;break}l=c}if(void 0!==n&&AnimationUtils.isTypedArray(n)){i=0;for(var h=n.length;i!==h;++i){var d=n[i];if(isNaN(d)){console.error("KeyframeTrack: Value is not a valid number.",this,i,d),e=!1;break}}}return e},optimize:function(){for(var e=this.times,t=this.values,r=this.getValueSize(),n=this.getInterpolation()===InterpolateSmooth,o=1,l=e.length-1,i=1;i<l;++i){var c=!1,time=e[i];if(time!==e[i+1]&&(1!==i||time!==time[0]))if(n)c=!0;else for(var h=i*r,d=h-r,f=h+r,m=0;m!==r;++m){var v=t[h+m];if(v!==t[d+m]||v!==t[f+m]){c=!0;break}}if(c){if(i!==o){e[o]=e[i];var y=i*r,x=o*r;for(m=0;m!==r;++m)t[x+m]=t[y+m]}++o}}if(l>0){e[o]=e[l];for(y=l*r,x=o*r,m=0;m!==r;++m)t[x+m]=t[y+m];++o}return o!==e.length&&(this.times=AnimationUtils.arraySlice(e,0,o),this.values=AnimationUtils.arraySlice(t,0,o*r)),this},clone:function(){var e=AnimationUtils.arraySlice(this.times,0),t=AnimationUtils.arraySlice(this.values,0),track=new(0,this.constructor)(this.name,e,t);return track.createInterpolant=this.createInterpolant,track}}),BooleanKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:BooleanKeyframeTrack,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:InterpolateDiscrete,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ColorKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:ColorKeyframeTrack,ValueTypeName:"color"}),NumberKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:NumberKeyframeTrack,ValueTypeName:"number"}),QuaternionLinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:QuaternionLinearInterpolant,interpolate_:function(e,t,r,n){for(var o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,h=e*c,d=(r-t)/(n-t),f=h+c;h!==f;h+=4)Quaternion.slerpFlat(o,0,l,h-c,l,h,d);return o}}),QuaternionKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:QuaternionKeyframeTrack,ValueTypeName:"quaternion",DefaultInterpolation:InterpolateLinear,InterpolantFactoryMethodLinear:function(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),StringKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:StringKeyframeTrack,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:InterpolateDiscrete,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),VectorKeyframeTrack.prototype=Object.assign(Object.create(KeyframeTrack.prototype),{constructor:VectorKeyframeTrack,ValueTypeName:"vector"}),Object.assign(AnimationClip,{parse:function(e){for(var t=[],r=e.tracks,n=1/(e.fps||1),i=0,o=r.length;i!==o;++i)t.push(parseKeyframeTrack(r[i]).scale(n));return new AnimationClip(e.name,e.duration,t)},toJSON:function(e){for(var t=[],r=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid},i=0,o=r.length;i!==o;++i)t.push(KeyframeTrack.toJSON(r[i]));return n},CreateFromMorphTargetSequence:function(e,t,r,n){for(var o=t.length,l=[],i=0;i<o;i++){var c=[],h=[];c.push((i+o-1)%o,i,(i+1)%o),h.push(0,1,0);var d=AnimationUtils.getKeyframeOrder(c);c=AnimationUtils.sortedArray(c,1,d),h=AnimationUtils.sortedArray(h,1,d),n||0!==c[0]||(c.push(o),h.push(h[0])),l.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[i].name+"]",c,h).scale(1/r))}return new AnimationClip(e,-1,l)},findByName:function(e,t){var r=e;if(!Array.isArray(e)){var n=e;r=n.geometry&&n.geometry.animations||n.animations}for(var i=0;i<r.length;i++)if(r[i].name===t)return r[i];return null},CreateClipsFromMorphTargetSequences:function(e,t,r){for(var n={},pattern=/^([\w-]*?)([\d]+)$/,i=0,o=e.length;i<o;i++){var l=e[i],c=l.name.match(pattern);if(c&&c.length>1){var h=n[f=c[1]];h||(n[f]=h=[]),h.push(l)}}var d=[];for(var f in n)d.push(AnimationClip.CreateFromMorphTargetSequence(f,n[f],t,r));return d},parseAnimation:function(e,t){if(!e)return console.error("AnimationClip: No animation in JSONLoader data."),null;for(var r=function(e,t,r,n,o){if(0!==r.length){var l=[],c=[];AnimationUtils.flattenJSON(r,l,c,n),0!==l.length&&o.push(new e(t,l,c))}},n=[],o=e.name||"default",l=e.length||-1,c=e.fps||30,h=e.hierarchy||[],d=0;d<h.length;d++){var f=h[d].keys;if(f&&0!==f.length)if(f[0].morphTargets){for(var m={},v=0;v<f.length;v++)if(f[v].morphTargets)for(var y=0;y<f[v].morphTargets.length;y++)m[f[v].morphTargets[y]]=-1;for(var x in m){var w=[],M=[];for(y=0;y!==f[v].morphTargets.length;++y){var S=f[v];w.push(S.time),M.push(S.morphTarget===x?1:0)}n.push(new NumberKeyframeTrack(".morphTargetInfluence["+x+"]",w,M))}l=m.length*(c||1)}else{var A=".bones["+t[d].name+"]";r(VectorKeyframeTrack,A+".position",f,"pos",n),r(QuaternionKeyframeTrack,A+".quaternion",f,"rot",n),r(VectorKeyframeTrack,A+".scale",f,"scl",n)}}return 0===n.length?null:new AnimationClip(o,l,n)}}),Object.assign(AnimationClip.prototype,{resetDuration:function(){for(var e=0,i=0,t=this.tracks.length;i!==t;++i){var track=this.tracks[i];e=Math.max(e,track.times[track.times.length-1])}return this.duration=e,this},trim:function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].trim(0,this.duration);return this},validate:function(){for(var e=!0,i=0;i<this.tracks.length;i++)e=e&&this.tracks[i].validate();return e},optimize:function(){for(var i=0;i<this.tracks.length;i++)this.tracks[i].optimize();return this},clone:function(){for(var e=[],i=0;i<this.tracks.length;i++)e.push(this.tracks[i].clone());return new AnimationClip(this.name,this.duration,e)}}),AnimationMixer.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:AnimationMixer,_bindAction:function(e,t){var r=e._localRoot||this._root,n=e._clip.tracks,o=n.length,l=e._propertyBindings,c=e._interpolants,h=r.uuid,d=this._bindingsByRootAndName,f=d[h];void 0===f&&(f={},d[h]=f);for(var i=0;i!==o;++i){var track=n[i],m=track.name,v=f[m];if(void 0!==v)l[i]=v;else{if(void 0!==(v=l[i])){null===v._cacheIndex&&(++v.referenceCount,this._addInactiveBinding(v,h,m));continue}var path=t&&t._propertyBindings[i].binding.parsedPath;++(v=new PropertyMixer(PropertyBinding.create(r,m,path),track.ValueTypeName,track.getValueSize())).referenceCount,this._addInactiveBinding(v,h,m),l[i]=v}c[i].resultBuffer=v.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,r=e._clip.uuid,n=this._actionsByClip[r];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,r,t)}for(var o=e._propertyBindings,i=0,l=o.length;i!==l;++i){var c=o[i];0==c.useCount++&&(this._lendBinding(c),c.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0==--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,r){var n=this._actions,o=this._actionsByClip,l=o[t];if(void 0===l)l={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,o[t]=l;else{var c=l.knownActions;e._byClipCacheIndex=c.length,c.push(e)}e._cacheIndex=n.length,n.push(e),l.actionByRoot[r]=e},_removeInactiveAction:function(e){var t=this._actions,r=t[t.length-1],n=e._cacheIndex;r._cacheIndex=n,t[n]=r,t.pop(),e._cacheIndex=null;var o=e._clip.uuid,l=this._actionsByClip,c=l[o],h=c.knownActions,d=h[h.length-1],f=e._byClipCacheIndex;d._byClipCacheIndex=f,h[f]=d,h.pop(),e._byClipCacheIndex=null,delete c.actionByRoot[(e._localRoot||this._root).uuid],0===h.length&&delete l[o],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,i=0,r=t.length;i!==r;++i){var n=t[i];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(e){var t=this._actions,r=e._cacheIndex,n=this._nActiveActions++,o=t[n];e._cacheIndex=n,t[n]=e,o._cacheIndex=r,t[r]=o},_takeBackAction:function(e){var t=this._actions,r=e._cacheIndex,n=--this._nActiveActions,o=t[n];e._cacheIndex=n,t[n]=e,o._cacheIndex=r,t[r]=o},_addInactiveBinding:function(e,t,r){var n=this._bindingsByRootAndName,o=n[t],l=this._bindings;void 0===o&&(o={},n[t]=o),o[r]=e,e._cacheIndex=l.length,l.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,r=e.binding,n=r.rootNode.uuid,o=r.path,l=this._bindingsByRootAndName,c=l[n],h=t[t.length-1],d=e._cacheIndex;h._cacheIndex=d,t[d]=h,t.pop(),delete c[o];e:{for(var f in c)break e;delete l[n]}},_lendBinding:function(e){var t=this._bindings,r=e._cacheIndex,n=this._nActiveBindings++,o=t[n];e._cacheIndex=n,t[n]=e,o._cacheIndex=r,t[r]=o},_takeBackBinding:function(e){var t=this._bindings,r=e._cacheIndex,n=--this._nActiveBindings,o=t[n];e._cacheIndex=n,t[n]=e,o._cacheIndex=r,t[r]=o},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,r=e[t];return void 0===r&&((r=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t,e[t]=r),r},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,r=e.__cacheIndex,n=--this._nActiveControlInterpolants,o=t[n];e.__cacheIndex=n,t[n]=e,o.__cacheIndex=r,t[r]=o},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var r=t||this._root,n=r.uuid,o="string"==typeof e?AnimationClip.findByName(r,e):e,l=null!==o?o.uuid:e,c=this._actionsByClip[l],h=null;if(void 0!==c){var d=c.actionByRoot[n];if(void 0!==d)return d;h=c.knownActions[0],null===o&&(o=h._clip)}if(null===o)return null;var f=new AnimationAction(this,o,t);return this._bindAction(f,h),this._addInactiveAction(f,l,n),f},existingAction:function(e,t){var r=t||this._root,n=r.uuid,o="string"==typeof e?AnimationClip.findByName(r,e):e,l=o?o.uuid:e,c=this._actionsByClip[l];return void 0!==c&&c.actionByRoot[n]||null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,r=this._bindings,n=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var i=0;i!==t;++i)e[i].reset();for(i=0;i!==n;++i)r[i].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,r=this._nActiveActions,time=this.time+=e,n=Math.sign(e),o=this._accuIndex^=1,i=0;i!==r;++i){t[i]._update(time,e,n,o)}var l=this._bindings,c=this._nActiveBindings;for(i=0;i!==c;++i)l[i].apply(o);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,r=e.uuid,n=this._actionsByClip,o=n[r];if(void 0!==o){for(var l=o.knownActions,i=0,c=l.length;i!==c;++i){var h=l[i];this._deactivateAction(h);var d=h._cacheIndex,f=t[t.length-1];h._cacheIndex=null,h._byClipCacheIndex=null,f._cacheIndex=d,t[d]=f,t.pop(),this._removeInactiveBindingsForAction(h)}delete n[r]}},uncacheRoot:function(e){var t=e.uuid,r=this._actionsByClip;for(var n in r){var o=r[n].actionByRoot[t];void 0!==o&&(this._deactivateAction(o),this._removeInactiveAction(o))}var l=this._bindingsByRootAndName[t];if(void 0!==l)for(var c in l){var h=l[c];h.restoreOriginalState(),this._removeInactiveBinding(h)}},uncacheAction:function(e,t){var r=this.existingAction(e,t);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}),Bone.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Bone,isBone:!0}),BoxGeometry.prototype=Object.create(Geometry.prototype),BoxGeometry.prototype.constructor=BoxGeometry,BoxBufferGeometry.prototype=Object.create(BufferGeometry.prototype),BoxBufferGeometry.prototype.constructor=BoxBufferGeometry,CylinderGeometry.prototype=Object.create(Geometry.prototype),CylinderGeometry.prototype.constructor=CylinderGeometry,CylinderBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CylinderBufferGeometry.prototype.constructor=CylinderBufferGeometry;var MMDPhysics=function(){function e(e,r,n,o){if("undefined"==typeof Ammo)throw new Error("MMDPhysics: Import ammo.js https://github.com/kripken/ammo.js");n=n||[],o=o||{},this.manager=new t,this.mesh=e,this.unitStep=void 0!==o.unitStep?o.unitStep:1/65,this.maxStepNum=void 0!==o.maxStepNum?o.maxStepNum:3,this.gravity=new Vector3(0,-98,0),void 0!==o.gravity&&this.gravity.copy(o.gravity),this.world=void 0!==o.world?o.world:null,this.bodies=[],this.constraints=[],this._init(e,r,n)}function t(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[],this.transforms=[],this.quaternions=[],this.vector3s=[]}function r(e,t,r,n){this.mesh=e,this.world=t,this.params=r,this.manager=n,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this._init()}function n(e,t,r,n,o,l){this.mesh=e,this.world=t,this.bodyA=r,this.bodyB=n,this.params=o,this.manager=l,this.constraint=null,this._init()}function o(e,t){Object3D.call(this),this.root=e,this.physics=t,this.matrix.copy(e.matrixWorld),this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new MeshBasicMaterial({color:new Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new MeshBasicMaterial({color:new Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init()}return e.prototype={constructor:e,update:function(e){var t,r=this.manager,n=this.mesh,o=!1,l=r.allocThreeVector3(),c=r.allocThreeQuaternion(),h=r.allocThreeVector3();return n.matrixWorld.decompose(l,c,h),1===h.x&&1===h.y&&1===h.z||(o=!0),o&&(null!==(t=n.parent)&&(n.parent=null),h.copy(this.mesh.scale),n.scale.set(1,1,1),n.updateMatrixWorld(!0)),this._updateRigidBodies(),this._stepSimulation(e),this._updateBones(),o&&(null!==t&&(n.parent=t),n.scale.copy(h)),r.freeThreeVector3(h),r.freeThreeQuaternion(c),r.freeThreeVector3(l),this},reset:function(){for(var i=0,e=this.bodies.length;i<e;i++)this.bodies[i].reset();return this},warmup:function(e){for(var i=0;i<e;i++)this.update(1/60);return this},setGravity:function(e){return this.world.setGravity(new Ammo.btVector3(e.x,e.y,e.z)),this.gravity.copy(e),this},createHelper:function(){return new o(this.mesh,this)},_init:function(e,t,r){var n=this.manager,o=e.parent;null!==o&&(o=null);var l=n.allocThreeVector3(),c=n.allocThreeQuaternion(),h=n.allocThreeVector3();l.copy(e.position),c.copy(e.quaternion),h.copy(e.scale),e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.scale.set(1,1,1),e.updateMatrixWorld(!0),null===this.world&&(this.world=this._createWorld(),this.setGravity(this.gravity)),this._initRigidBodies(t),this._initConstraints(r),null!==o&&(e.parent=o),e.position.copy(l),e.quaternion.copy(c),e.scale.copy(h),e.updateMatrixWorld(!0),this.reset(),n.freeThreeVector3(l),n.freeThreeQuaternion(c),n.freeThreeVector3(h)},_createWorld:function(){var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),r=new Ammo.btDbvtBroadphase,n=new Ammo.btSequentialImpulseConstraintSolver;return new Ammo.btDiscreteDynamicsWorld(t,r,n,e)},_initRigidBodies:function(e){for(var i=0,t=e.length;i<t;i++)this.bodies.push(new r(this.mesh,this.world,e[i],this.manager))},_initConstraints:function(e){for(var i=0,t=e.length;i<t;i++){var r=e[i],o=this.bodies[r.rigidBodyIndex1],l=this.bodies[r.rigidBodyIndex2];this.constraints.push(new n(this.mesh,this.world,o,l,r,this.manager))}},_stepSimulation:function(e){var t=this.unitStep,r=e,n=1+(e/t|0);r<t&&(r=t,n=1),n>this.maxStepNum&&(n=this.maxStepNum),this.world.stepSimulation(r,n,t)},_updateRigidBodies:function(){for(var i=0,e=this.bodies.length;i<e;i++)this.bodies[i].updateFromBone()},_updateBones:function(){for(var i=0,e=this.bodies.length;i<e;i++)this.bodies[i].updateBone()}},t.prototype={constructor:t,allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new Vector3},freeThreeVector3:function(e){this.threeVector3s.push(e)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new Matrix4},freeThreeMatrix4:function(e){this.threeMatrix4s.push(e)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new Quaternion},freeThreeQuaternion:function(q){this.threeQuaternions.push(q)},allocThreeEuler:function(){return this.threeEulers.length>0?this.threeEulers.pop():new Euler},freeThreeEuler:function(e){this.threeEulers.push(e)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(e){this.transforms.push(e)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(q){this.quaternions.push(q)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(e){this.vector3s.push(e)},setIdentity:function(e){e.setIdentity()},getBasis:function(e){var q=this.allocQuaternion();return e.getBasis().getRotation(q),q},getBasisAsMatrix3:function(e){var q=this.getBasis(e),t=this.quaternionToMatrix3(q);return this.freeQuaternion(q),t},getOrigin:function(e){return e.getOrigin()},setOrigin:function(e,t){e.getOrigin().setValue(t.x(),t.y(),t.z())},copyOrigin:function(e,t){var r=t.getOrigin();this.setOrigin(e,r)},setBasis:function(e,q){e.setRotation(q)},setBasisFromMatrix3:function(e,t){var q=this.matrix3ToQuaternion(t);this.setBasis(e,q),this.freeQuaternion(q)},setOriginFromArray3:function(e,a){e.getOrigin().setValue(a[0],a[1],a[2])},setOriginFromThreeVector3:function(e,t){e.getOrigin().setValue(t.x,t.y,t.z)},setBasisFromArray3:function(e,a){var t=this.allocThreeQuaternion(),r=this.allocThreeEuler();r.set(a[0],a[1],a[2]),this.setBasisFromThreeQuaternion(e,t.setFromEuler(r)),this.freeThreeEuler(r),this.freeThreeQuaternion(t)},setBasisFromThreeQuaternion:function(e,a){var q=this.allocQuaternion();q.setX(a.x),q.setY(a.y),q.setZ(a.z),q.setW(a.w),this.setBasis(e,q),this.freeQuaternion(q)},multiplyTransforms:function(e,t){var r=this.allocTransform();this.setIdentity(r);var n=this.getBasisAsMatrix3(e),o=this.getBasisAsMatrix3(t),l=this.getOrigin(e),c=this.getOrigin(t),h=this.multiplyMatrix3ByVector3(n,c),d=this.addVector3(h,l);this.setOrigin(r,d);var f=this.multiplyMatrices3(n,o);return this.setBasisFromMatrix3(r,f),this.freeVector3(h),this.freeVector3(d),r},inverseTransform:function(e){var t=this.allocTransform(),r=this.getBasisAsMatrix3(e),n=this.getOrigin(e),o=this.transposeMatrix3(r),l=this.negativeVector3(n),c=this.multiplyMatrix3ByVector3(o,l);return this.setOrigin(t,c),this.setBasisFromMatrix3(t,o),this.freeVector3(l),this.freeVector3(c),t},multiplyMatrices3:function(e,t){var r=[],n=this.rowOfMatrix3(e,0),o=this.rowOfMatrix3(e,1),l=this.rowOfMatrix3(e,2),c=this.columnOfMatrix3(t,0),h=this.columnOfMatrix3(t,1),d=this.columnOfMatrix3(t,2);return r[0]=this.dotVectors3(n,c),r[1]=this.dotVectors3(n,h),r[2]=this.dotVectors3(n,d),r[3]=this.dotVectors3(o,c),r[4]=this.dotVectors3(o,h),r[5]=this.dotVectors3(o,d),r[6]=this.dotVectors3(l,c),r[7]=this.dotVectors3(l,h),r[8]=this.dotVectors3(l,d),this.freeVector3(n),this.freeVector3(o),this.freeVector3(l),this.freeVector3(c),this.freeVector3(h),this.freeVector3(d),r},addVector3:function(e,t){var r=this.allocVector3();return r.setValue(e.x()+t.x(),e.y()+t.y(),e.z()+t.z()),r},dotVectors3:function(e,t){return e.x()*t.x()+e.y()*t.y()+e.z()*t.z()},rowOfMatrix3:function(e,i){var t=this.allocVector3();return t.setValue(e[3*i+0],e[3*i+1],e[3*i+2]),t},columnOfMatrix3:function(e,i){var t=this.allocVector3();return t.setValue(e[i+0],e[i+3],e[i+6]),t},negativeVector3:function(e){var t=this.allocVector3();return t.setValue(-e.x(),-e.y(),-e.z()),t},multiplyMatrix3ByVector3:function(e,t){var r=this.allocVector3(),n=this.rowOfMatrix3(e,0),o=this.rowOfMatrix3(e,1),l=this.rowOfMatrix3(e,2),c=this.dotVectors3(n,t),h=this.dotVectors3(o,t),d=this.dotVectors3(l,t);return r.setValue(c,h,d),this.freeVector3(n),this.freeVector3(o),this.freeVector3(l),r},transposeMatrix3:function(e){var t=[];return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},quaternionToMatrix3:function(q){var e=[],t=q.x(),r=q.y(),n=q.z(),o=q.w(),l=t*t,c=r*r,h=n*n,d=t*r,f=r*n,m=n*t,v=t*o,y=r*o,x=n*o;return e[0]=1-2*(c+h),e[1]=2*(d-x),e[2]=2*(m+y),e[3]=2*(d+x),e[4]=1-2*(h+l),e[5]=2*(f-v),e[6]=2*(m-y),e[7]=2*(f+v),e[8]=1-2*(l+c),e},matrix3ToQuaternion:function(e){var s,t,r,n,o,l=e[0]+e[4]+e[8];l>0?(o=.25*(s=2*Math.sqrt(l+1)),t=(e[7]-e[5])/s,r=(e[2]-e[6])/s,n=(e[3]-e[1])/s):e[0]>e[4]&&e[0]>e[8]?(s=2*Math.sqrt(1+e[0]-e[4]-e[8]),o=(e[7]-e[5])/s,t=.25*s,r=(e[1]+e[3])/s,n=(e[2]+e[6])/s):e[4]>e[8]?(s=2*Math.sqrt(1+e[4]-e[0]-e[8]),o=(e[2]-e[6])/s,t=(e[1]+e[3])/s,r=.25*s,n=(e[5]+e[7])/s):(s=2*Math.sqrt(1+e[8]-e[0]-e[4]),o=(e[3]-e[1])/s,t=(e[2]+e[6])/s,r=(e[5]+e[7])/s,n=.25*s);var q=this.allocQuaternion();return q.setX(t),q.setY(r),q.setZ(n),q.setW(o),q}},r.prototype={constructor:e.RigidBody,reset:function(){return this._setTransformFromBone(),this},updateFromBone:function(){return-1!==this.params.boneIndex&&0===this.params.type&&this._setTransformFromBone(),this},updateBone:function(){return 0===this.params.type||-1===this.params.boneIndex?this:(this._updateBoneRotation(),1===this.params.type&&this._updateBonePosition(),this.bone.updateMatrixWorld(!0),2===this.params.type&&this._setPositionFromBone(),this)},_init:function(){var e=this.manager,t=this.params,r=this.mesh.skeleton.bones,n=-1===t.boneIndex?new Bone:r[t.boneIndex],o=function(p){switch(p.shapeType){case 0:return new Ammo.btSphereShape(p.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(p.width,p.height,p.depth));case 2:return new Ammo.btCapsuleShape(p.width,p.height);default:throw"unknown shape type "+p.shapeType}}(t),l=0===t.type?0:t.weight,c=e.allocVector3();c.setValue(0,0,0),0!==l&&o.calculateLocalInertia(l,c);var h=e.allocTransform();e.setIdentity(h),e.setOriginFromArray3(h,t.position),e.setBasisFromArray3(h,t.rotation);var d=e.allocThreeVector3(),f=e.allocTransform();e.setIdentity(f),e.setOriginFromThreeVector3(f,n.getWorldPosition(d));var form=e.multiplyTransforms(f,h),m=new Ammo.btDefaultMotionState(form),v=new Ammo.btRigidBodyConstructionInfo(l,m,o,c);v.set_m_friction(t.friction),v.set_m_restitution(t.restitution);var body=new Ammo.btRigidBody(v);0===t.type&&(body.setCollisionFlags(2|body.getCollisionFlags()),body.setActivationState(4)),body.setDamping(t.positionDamping,t.rotationDamping),body.setSleepingThresholds(0,0),this.world.addRigidBody(body,1<<t.groupIndex,t.groupTarget),this.body=body,this.bone=n,this.boneOffsetForm=h,this.boneOffsetFormInverse=e.inverseTransform(h),e.freeVector3(c),e.freeTransform(form),e.freeTransform(f),e.freeThreeVector3(d)},_getBoneTransform:function(){var e=this.manager,p=e.allocThreeVector3(),q=e.allocThreeQuaternion(),s=e.allocThreeVector3();this.bone.matrixWorld.decompose(p,q,s);var tr=e.allocTransform();e.setOriginFromThreeVector3(tr,p),e.setBasisFromThreeQuaternion(tr,q);var form=e.multiplyTransforms(tr,this.boneOffsetForm);return e.freeTransform(tr),e.freeThreeVector3(s),e.freeThreeQuaternion(q),e.freeThreeVector3(p),form},_getWorldTransformForBone:function(){var e=this.manager,tr=e.allocTransform();this.body.getMotionState().getWorldTransform(tr);var t=e.multiplyTransforms(tr,this.boneOffsetFormInverse);return e.freeTransform(tr),t},_setTransformFromBone:function(){var e=this.manager,form=this._getBoneTransform();this.body.setCenterOfMassTransform(form),this.body.getMotionState().setWorldTransform(form),e.freeTransform(form)},_setPositionFromBone:function(){var e=this.manager,form=this._getBoneTransform(),tr=e.allocTransform();this.body.getMotionState().getWorldTransform(tr),e.copyOrigin(tr,form),this.body.setCenterOfMassTransform(tr),this.body.getMotionState().setWorldTransform(tr),e.freeTransform(tr),e.freeTransform(form)},_updateBoneRotation:function(){var e=this.manager,tr=this._getWorldTransformForBone(),q=e.getBasis(tr),t=e.allocThreeQuaternion(),r=e.allocThreeQuaternion(),n=e.allocThreeQuaternion();t.set(q.x(),q.y(),q.z(),q.w()),r.setFromRotationMatrix(this.bone.matrixWorld),r.conjugate(),r.multiply(t),n.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(r.multiply(n)),e.freeThreeQuaternion(t),e.freeThreeQuaternion(r),e.freeThreeQuaternion(n),e.freeQuaternion(q),e.freeTransform(tr)},_updateBonePosition:function(){var e=this.manager,t=this.body.getCenterOfMassTransform().getOrigin(),r=e.allocThreeMatrix4();r.copy(this.bone.parent.matrixWorld).getInverse(r);var n=e.allocThreeVector3();n.set(t.x(),t.y(),t.z()).applyMatrix4(r),this.bone.position.copy(n),e.freeThreeVector3(n),e.freeThreeMatrix4(r)}},n.prototype={constructor:n,_init:function(){var e=this.manager,t=this.params,r=this.bodyA,n=this.bodyB,form=e.allocTransform();e.setIdentity(form),e.setOriginFromArray3(form,t.position),e.setBasisFromArray3(form,t.rotation);var o=e.allocTransform(),l=e.allocTransform();r.body.getMotionState().getWorldTransform(o),n.body.getMotionState().getWorldTransform(l);var c=e.inverseTransform(o),h=e.inverseTransform(l),d=e.multiplyTransforms(c,form),f=e.multiplyTransforms(h,form),m=new Ammo.btGeneric6DofSpringConstraint(r.body,n.body,d,f,!0),v=e.allocVector3(),y=e.allocVector3(),x=e.allocVector3(),w=e.allocVector3();v.setValue(t.translationLimitation1[0],t.translationLimitation1[1],t.translationLimitation1[2]),y.setValue(t.translationLimitation2[0],t.translationLimitation2[1],t.translationLimitation2[2]),x.setValue(t.rotationLimitation1[0],t.rotationLimitation1[1],t.rotationLimitation1[2]),w.setValue(t.rotationLimitation2[0],t.rotationLimitation2[1],t.rotationLimitation2[2]),m.setLinearLowerLimit(v),m.setLinearUpperLimit(y),m.setAngularLowerLimit(x),m.setAngularUpperLimit(w);for(var i=0;i<3;i++)0!==t.springPosition[i]&&(m.enableSpring(i,!0),m.setStiffness(i,t.springPosition[i]));for(i=0;i<3;i++)0!==t.springRotation[i]&&(m.enableSpring(i+3,!0),m.setStiffness(i+3,t.springRotation[i]));if(void 0!==m.setParam)for(i=0;i<6;i++)m.setParam(2,.475,i);this.world.addConstraint(m,!0),this.constraint=m,e.freeTransform(form),e.freeTransform(o),e.freeTransform(l),e.freeTransform(c),e.freeTransform(h),e.freeTransform(d),e.freeTransform(f),e.freeVector3(v),e.freeVector3(y),e.freeVector3(x),e.freeVector3(w)}},o.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:o,updateMatrixWorld:function(){var e=new Vector3,t=new Quaternion,r=new Vector3,n=new Matrix4;return function(o){var l=this.root;if(this.visible){var c=this.physics.bodies;n.copy(l.matrixWorld).decompose(e,t,r).compose(e,t,r.set(1,1,1)).getInverse(n);for(var i=0,h=c.length;i<h;i++){var body=c[i].body,d=this.children[i],tr=body.getCenterOfMassTransform(),f=tr.getOrigin(),m=tr.getRotation();d.position.set(f.x(),f.y(),f.z()).applyMatrix4(n),d.quaternion.setFromRotationMatrix(n).multiply(t.set(m.x(),m.y(),m.z(),m.w()))}}this.matrix.copy(l.matrixWorld).decompose(e,t,r).compose(e,t,r.set(1,1,1)),Object3D.prototype.updateMatrixWorld.call(this,o)}}(),_init:function(){var e=this.physics.bodies;function t(param){switch(param.shapeType){case 0:return new SphereBufferGeometry(param.width,16,8);case 1:return new BoxBufferGeometry(2*param.width,2*param.height,2*param.depth,8,8,8);case 2:return new r(param.width,param.height,16,8);default:return null}}function r(e,t,r,n){var o=new CylinderBufferGeometry(e,e,t,r,n,!0),l=new Mesh(new SphereBufferGeometry(e,r,n,0,2*Math.PI,0,Math.PI/2)),c=new Mesh(new SphereBufferGeometry(e,r,n,0,2*Math.PI,Math.PI/2,Math.PI/2));return l.position.set(0,t/2,0),c.position.set(0,-t/2,0),l.updateMatrix(),c.updateMatrix(),o.merge(l.geometry,l.matrix),o.merge(c.geometry,c.matrix),o}for(var i=0,n=e.length;i<n;i++){var param=e[i].params;this.add(new Mesh(t(param),this.materials[param.type]))}}}),e}(),MMDAnimationHelper=function(){function e(e){e=e||{},this.meshes=[],this.camera=null,this.cameraTarget=new Object3D,this.cameraTarget.name="target",this.audio=null,this.audioManager=null,this.objects=new WeakMap,this.configuration={sync:void 0===e.sync||e.sync,afterglow:void 0!==e.afterglow?e.afterglow:0,resetPhysicsOnLoop:void 0===e.resetPhysicsOnLoop||e.resetPhysicsOnLoop},this.enabled={animation:!0,ik:!0,grant:!0,physics:!0,cameraAnimation:!0},this.onBeforePhysics=function(e){},this.sharedPhysics=!1,this.masterPhysics=null}function t(audio,e){e=e||{},this.audio=audio,this.elapsedTime=0,this.currentTime=0,this.delayTime=void 0!==e.delayTime?e.delayTime:0,this.audioDuration=this.audio.buffer.duration,this.duration=this.audioDuration+this.delayTime}function r(e,t){this.mesh=e,this.grants=t||[]}return e.prototype={constructor:e,add:function(object,e){if(e=e||{},object.isSkinnedMesh)this._addMesh(object,e);else if(object.isCamera)this._setupCamera(object,e);else{if("Audio"!==object.type)throw new Error("MMDAnimationHelper.add: accepts only SkinnedMesh or Camera or Audio instance.");this._setupAudio(object,e)}return this.configuration.sync&&this._syncDuration(),this},remove:function(object){if(object.isSkinnedMesh)this._removeMesh(object);else if(object.isCamera)this._clearCamera(object);else{if("Audio"!==object.type)throw new Error("MMDAnimationHelper.remove: accepts only SkinnedMesh or Camera or Audio instance.");this._clearAudio(object)}return this.configuration.sync&&this._syncDuration(),this},update:function(e){null!==this.audioManager&&this.audioManager.control(e);for(var i=0;i<this.meshes.length;i++)this._animateMesh(this.meshes[i],e);return this.sharedPhysics&&this._updateSharedPhysics(e),null!==this.camera&&this._animateCamera(this.camera,e),this},pose:function(e,t,r){!1!==(r=r||{}).resetPose&&e.pose();for(var n=e.skeleton.bones,o=t.bones,l={},i=0,c=n.length;i<c;i++)l[n[i].name]=i;var h=new Vector3,d=new Quaternion;for(i=0,c=o.length;i<c;i++){var f=o[i],m=l[f.name];if(void 0!==m){var v=n[m];v.position.add(h.fromArray(f.translation)),v.quaternion.multiply(d.fromArray(f.quaternion))}}return e.updateMatrixWorld(!0),!1!==r.ik&&this._createCCDIKSolver(e).update(r.saveOriginalBonesBeforeIK),!1!==r.grant&&this.createGrantSolver(e).update(),this},enable:function(e,t){if(void 0===this.enabled[e])throw new Error("MMDAnimationHelper.enable: unknown key "+e);if(this.enabled[e]=t,"physics"===e)for(var i=0,r=this.meshes.length;i<r;i++)this._optimizeIK(this.meshes[i],t);return this},createGrantSolver:function(e){return new r(e,e.geometry.userData.MMD.grants)},_addMesh:function(e,t){if(this.meshes.indexOf(e)>=0)throw new Error("MMDAnimationHelper._addMesh: SkinnedMesh '"+e.name+"' has already been added.");return this.meshes.push(e),this.objects.set(e,{looped:!1}),this._setupMeshAnimation(e,t.animation),!1!==t.physics&&this._setupMeshPhysics(e,t),this},_setupCamera:function(e,t){if(this.camera===e)throw new Error("MMDAnimationHelper._setupCamera: Camera '"+e.name+"' has already been set.");return this.camera&&this.clearCamera(this.camera),this.camera=e,e.add(this.cameraTarget),this.objects.set(e,{}),void 0!==t.animation&&this._setupCameraAnimation(e,t.animation),this},_setupAudio:function(audio,e){if(this.audio===audio)throw new Error("MMDAnimationHelper._setupAudio: Audio '"+audio.name+"' has already been set.");return this.audio&&this.clearAudio(this.audio),this.audio=audio,this.audioManager=new t(audio,e),this.objects.set(this.audioManager,{duration:this.audioManager.duration}),this},_removeMesh:function(e){for(var t=!1,r=0,i=0,n=this.meshes.length;i<n;i++)this.meshes[i]!==e?this.meshes[r++]=this.meshes[i]:(this.objects.delete(e),t=!0);if(!t)throw new Error("MMDAnimationHelper._removeMesh: SkinnedMesh '"+e.name+"' has not been added yet.");return this.meshes.length=r,this},_clearCamera:function(e){if(e!==this.camera)throw new Error("MMDAnimationHelper._clearCamera: Camera '"+e.name+"' has not been set yet.");return this.camera.remove(this.cameraTarget),this.objects.delete(this.camera),this.camera=null,this},_clearAudio:function(audio){if(audio!==this.audio)throw new Error("MMDAnimationHelper._clearAudio: Audio '"+audio.name+"' has not been set yet.");return this.objects.delete(this.audioManager),this.audio=null,this.audioManager=null,this},_setupMeshAnimation:function(e,t){var r=this.objects.get(e);if(void 0!==t){var n=Array.isArray(t)?t:[t];r.mixer=new AnimationMixer(e);for(var i=0,o=n.length;i<o;i++)r.mixer.clipAction(n[i]).play();r.mixer.addEventListener("loop",(function(e){var t=e.action._clip.tracks;t.length>0&&".bones"!==t[0].name.slice(0,6)||(r.looped=!0)}))}return r.ikSolver=this._createCCDIKSolver(e),r.grantSolver=this.createGrantSolver(e),this},_setupCameraAnimation:function(e,t){var r=Array.isArray(t)?t:[t],n=this.objects.get(e);n.mixer=new AnimationMixer(e);for(var i=0,o=r.length;i<o;i++)n.mixer.clipAction(r[i]).play()},_setupMeshPhysics:function(e,t){var r=this.objects.get(e);if(void 0===t.world&&this.sharedPhysics){var n=this._getMasterPhysics();null!==n&&(world=n.world)}r.physics=this._createMMDPhysics(e,t),r.mixer&&!1!==t.animationWarmup&&(this._animateMesh(e,0),r.physics.reset()),r.physics.warmup(void 0!==t.warmup?t.warmup:60),this._optimizeIK(e,!0)},_animateMesh:function(e,t){var r=this.objects.get(e),n=r.mixer,o=r.ikSolver,l=r.grantSolver,c=r.physics,h=r.looped;n&&this.enabled.animation&&(this._restoreBones(e),n.update(t),this._saveBones(e),o&&this.enabled.ik&&(e.updateMatrixWorld(!0),o.update()),l&&this.enabled.grant&&l.update()),!0===h&&this.enabled.physics&&(c&&this.configuration.resetPhysicsOnLoop&&c.reset(),r.looped=!1),c&&this.enabled.physics&&!this.sharedPhysics&&(this.onBeforePhysics(e),c.update(t))},_animateCamera:function(e,t){var r=this.objects.get(e).mixer;r&&this.enabled.cameraAnimation&&(r.update(t),e.updateProjectionMatrix(),e.up.set(0,1,0),e.up.applyQuaternion(e.quaternion),e.lookAt(this.cameraTarget.position))},_optimizeIK:function(e,t){for(var r=e.geometry.userData.MMD.iks,n=e.geometry.userData.MMD.bones,i=0,o=r.length;i<o;i++)for(var l=r[i].links,c=0,h=l.length;c<h;c++){var link=l[c];link.enabled=!0!==t||!(n[link.index].rigidBodyType>0)}},_createCCDIKSolver:function(e){if(void 0===CCDIKSolver)throw new Error("MMDAnimationHelper: Import CCDIKSolver.");return new CCDIKSolver(e,e.geometry.userData.MMD.iks)},_createMMDPhysics:function(e,t){if(void 0===MMDPhysics)throw new Error("MMDPhysics: Import MMDPhysics.");return new MMDPhysics(e,e.geometry.userData.MMD.rigidBodies,e.geometry.userData.MMD.constraints,t)},_syncDuration:function(){for(var e=0,t=this.objects,r=this.meshes,n=this.camera,o=this.audioManager,i=0,l=r.length;i<l;i++){if(void 0!==(d=this.objects.get(r[i]).mixer))for(var c=0;c<d._actions.length;c++){var h=d._actions[c]._clip;t.has(h)||t.set(h,{duration:h.duration}),e=Math.max(e,t.get(h).duration)}}if(null!==n&&void 0!==(d=this.objects.get(n).mixer))for(i=0,l=d._actions.length;i<l;i++){h=d._actions[i]._clip;t.has(h)||t.set(h,{duration:h.duration}),e=Math.max(e,t.get(h).duration)}null!==o&&(e=Math.max(e,t.get(o).duration)),e+=this.configuration.afterglow;for(i=0,l=this.meshes.length;i<l;i++){var d;if(void 0!==(d=this.objects.get(this.meshes[i]).mixer)){c=0;for(var f=d._actions.length;c<f;c++)d._actions[c]._clip.duration=e}}if(null!==n&&void 0!==(d=this.objects.get(n).mixer))for(i=0,l=d._actions.length;i<l;i++)d._actions[i]._clip.duration=e;null!==o&&(o.duration=e)},_updatePropertyMixersBuffer:function(e){for(var t=this.objects.get(e).mixer,r=t._bindings,n=t._accuIndex,i=0,o=r.length;i<o;i++){var l=r[i],c=l.buffer,h=(n+1)*l.valueSize;l.binding.getValue(c,h)}},_saveBones:function(e){var t=this.objects.get(e),r=e.skeleton.bones,n=t.backupBones;void 0===n&&(n=new Float32Array(7*r.length),t.backupBones=n);for(var i=0,o=r.length;i<o;i++){var l=r[i];l.position.toArray(n,7*i),l.quaternion.toArray(n,7*i+3)}},_restoreBones:function(e){var t=this.objects.get(e).backupBones;if(void 0!==t)for(var r=e.skeleton.bones,i=0,n=r.length;i<n;i++){var o=r[i];o.position.fromArray(t,7*i),o.quaternion.fromArray(t,7*i+3)}},_getMasterPhysics:function(){if(null!==this.masterPhysics)return this.masterPhysics;for(var i=0,e=this.meshes.length;i<e;i++){var t=this.meshes[i].physics;if(null!=t)return this.masterPhysics=t,this.masterPhysics}return null},_updateSharedPhysics:function(e){if(0!==this.meshes.length&&this.enabled.physics&&this.sharedPhysics){var t=this._getMasterPhysics();if(null!==t){for(var i=0,r=this.meshes.length;i<r;i++){null!=(p=this.meshes[i].physics)&&p.updateRigidBodies()}t.stepSimulation(e);for(i=0,r=this.meshes.length;i<r;i++){var p;null!=(p=this.meshes[i].physics)&&p.updateBones()}}}}},t.prototype={constructor:t,control:function(e){return this.elapsed+=e,this.currentTime+=e,this._shouldStopAudio()&&this.audio.stop(),this._shouldStartAudio()&&this.audio.play(),this},_shouldStartAudio:function(){if(this.audio.isPlaying)return!1;for(;this.currentTime>=this.duration;)this.currentTime-=this.duration;return!(this.currentTime<this.delayTime)&&(!(this.currentTime-this.delayTime>this.audioDuration)&&(this.audio.startTime=this.currentTime-this.delayTime,!0))},_shouldStopAudio:function(){return this.audio.isPlaying&&this.currentTime>=this.duration}},r.prototype={constructor:r,update:function(){var e=new Quaternion;return function(){for(var t=this.mesh.skeleton.bones,r=this.grants,i=0,n=r.length;i<n;i++){var o=r[i],l=t[o.index],c=t[o.parentIndex];o.isLocal?(o.affectPosition,o.affectRotation):(o.affectPosition,o.affectRotation&&(e.set(0,0,0,1),e.slerp(c.quaternion,o.ratio),l.quaternion.multiply(e)))}return this}}()},e}(),AnimationClipCreator=function(){};function Camera(){Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.projectionMatrixInverse=new Matrix4}function PerspectiveCamera(e,t,r,n){Camera.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==r?r:.1,this.far=void 0!==n?n:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function cloneUniforms(e){var t={};for(var u in e)for(var p in t[u]={},e[u]){var r=e[u][p];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?t[u][p]=r.clone():Array.isArray(r)?t[u][p]=r.slice():t[u][p]=r}return t}function mergeUniforms(e){for(var t={},u=0;u<e.length;u++){var r=cloneUniforms(e[u]);for(var p in r)t[p]=r[p]}return t}AnimationClipCreator.CreateRotationAnimation=function(e,t){return new AnimationClip(null,e,[new NumberKeyframeTrack(".rotation["+(t=t||"x")+"]",[0,e],[0,360])])},AnimationClipCreator.CreateScaleAxisAnimation=function(e,t){return new AnimationClip(null,e,[new NumberKeyframeTrack(".scale["+(t=t||"x")+"]",[0,e],[0,1])])},AnimationClipCreator.CreateShakeAnimation=function(e,t){for(var r=[],n=[],o=new Vector3,i=0;i<10*e;i++)r.push(i/10),o.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1).multiply(t).toArray(n,n.length);return new AnimationClip(null,e,[new VectorKeyframeTrack(".position",r,n)])},AnimationClipCreator.CreatePulsationAnimation=function(e,t){for(var r=[],n=[],o=new Vector3,i=0;i<10*e;i++){r.push(i/10);var l=Math.random()*t;o.set(l,l,l).toArray(n,n.length)}return new AnimationClip(null,e,[new VectorKeyframeTrack(".scale",r,n)])},AnimationClipCreator.CreateVisibilityAnimation=function(e){return new AnimationClip(null,e,[new BooleanKeyframeTrack(".visible",[0,e/2,e],[!0,!1,!0])])},AnimationClipCreator.CreateMaterialColorAnimation=function(e,t){for(var r=[],n=[],o=e/t.length,i=0;i<=t.length;i++)r.push(i*o),n.push(t[i%t.length]);return new AnimationClip(null,e,[new ColorKeyframeTrack(".material[0].color",r,n)])},Camera.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Camera,isCamera:!0,copy:function(source,e){return Object3D.prototype.copy.call(this,source,e),this.matrixWorldInverse.copy(source.matrixWorldInverse),this.projectionMatrix.copy(source.projectionMatrix),this.projectionMatrixInverse.copy(source.projectionMatrixInverse),this},getWorldDirection:function(e){void 0===e&&(console.warn("Camera: .getWorldDirection() target is now required"),e=new Vector3),this.updateMatrixWorld(!0);var t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()},updateMatrixWorld:function(e){Object3D.prototype.updateMatrixWorld.call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),PerspectiveCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:PerspectiveCamera,isPerspectiveCamera:!0,copy:function(source,e){return Camera.prototype.copy.call(this,source,e),this.fov=source.fov,this.zoom=source.zoom,this.near=source.near,this.far=source.far,this.focus=source.focus,this.aspect=source.aspect,this.view=null===source.view?null:Object.assign({},source.view),this.filmGauge=source.filmGauge,this.filmOffset=source.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*_Math.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*_Math.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*_Math.RAD2DEG*Math.atan(Math.tan(.5*_Math.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,r,n,o,l){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=o,this.view.height=l,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*_Math.DEG2RAD*this.fov)/this.zoom,r=2*t,n=this.aspect*r,o=-.5*n,view=this.view;if(null!==this.view&&this.view.enabled){var l=view.fullWidth,c=view.fullHeight;o+=view.offsetX*n/l,t-=view.offsetY*r/c,n*=view.width/l,r*=view.height/c}var h=this.filmOffset;0!==h&&(o+=e*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(o,o+n,t,t-r,e,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(meta){var data=Object3D.prototype.toJSON.call(this,meta);return data.object.fov=this.fov,data.object.zoom=this.zoom,data.object.near=this.near,data.object.far=this.far,data.object.focus=this.focus,data.object.aspect=this.aspect,null!==this.view&&(data.object.view=Object.assign({},this.view)),data.object.filmGauge=this.filmGauge,data.object.filmOffset=this.filmOffset,data}});var UniformsUtils={clone:cloneUniforms,merge:mergeUniforms},default_vertex="\nvoid main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",default_fragment="\nvoid main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}\n",_canvas;function ShaderMaterial(e){Material$1.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=default_vertex,this.fragmentShader=default_fragment,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,void 0!==e&&(void 0!==e.attributes&&console.error("ShaderMaterial: attributes should now be defined in BufferGeometry instead."),this.setValues(e))}function Scene(){Object3D.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function OrthographicCamera(e,t,r,n,o,l){Camera.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=void 0!==e?e:-1,this.right=void 0!==t?t:1,this.top=void 0!==r?r:1,this.bottom=void 0!==n?n:-1,this.near=void 0!==o?o:.1,this.far=void 0!==l?l:2e3,this.updateProjectionMatrix()}ShaderMaterial.prototype=Object.create(Material$1.prototype),ShaderMaterial.prototype.constructor=ShaderMaterial,ShaderMaterial.prototype.isShaderMaterial=!0,ShaderMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.fragmentShader=source.fragmentShader,this.vertexShader=source.vertexShader,this.uniforms=cloneUniforms(source.uniforms),this.defines=Object.assign({},source.defines),this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.lights=source.lights,this.clipping=source.clipping,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this.extensions=source.extensions,this},ShaderMaterial.prototype.toJSON=function(meta){var data=Material$1.prototype.toJSON.call(this,meta);for(var e in data.uniforms={},this.uniforms){var t=this.uniforms[e].value;t&&t.isTexture?data.uniforms[e]={type:"t",value:t.toJSON(meta).uuid}:t&&t.isColor?data.uniforms[e]={type:"c",value:t.getHex()}:t&&t.isVector2?data.uniforms[e]={type:"v2",value:t.toArray()}:t&&t.isVector3?data.uniforms[e]={type:"v3",value:t.toArray()}:t&&t.isVector4?data.uniforms[e]={type:"v4",value:t.toArray()}:t&&t.isMatrix3?data.uniforms[e]={type:"m3",value:t.toArray()}:t&&t.isMatrix4?data.uniforms[e]={type:"m4",value:t.toArray()}:data.uniforms[e]={value:t}}Object.keys(this.defines).length>0&&(data.defines=this.defines),data.vertexShader=this.vertexShader,data.fragmentShader=this.fragmentShader;var r={};for(var n in this.extensions)!0===this.extensions[n]&&(r[n]=!0);return Object.keys(r).length>0&&(data.extensions=r),data},Scene.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Scene,isScene:!0,copy:function(source,e){return Object3D.prototype.copy.call(this,source,e),null!==source.background&&(this.background=source.background.clone()),null!==source.fog&&(this.fog=source.fog.clone()),null!==source.overrideMaterial&&(this.overrideMaterial=source.overrideMaterial.clone()),this.autoUpdate=source.autoUpdate,this.matrixAutoUpdate=source.matrixAutoUpdate,this},toJSON:function(meta){var data=Object3D.prototype.toJSON.call(this,meta);return null!==this.background&&(data.object.background=this.background.toJSON(meta)),null!==this.fog&&(data.object.fog=this.fog.toJSON()),data},dispose:function(){this.dispatchEvent({type:"dispose"})}}),OrthographicCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:OrthographicCamera,isOrthographicCamera:!0,copy:function(source,e){return Camera.prototype.copy.call(this,source,e),this.left=source.left,this.right=source.right,this.top=source.top,this.bottom=source.bottom,this.near=source.near,this.far=source.far,this.zoom=source.zoom,this.view=null===source.view?null:Object.assign({},source.view),this},setViewOffset:function(e,t,r,n,o,l){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=n,this.view.width=o,this.view.height=l,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2,o=r-e,l=r+e,c=n+t,h=n-t;if(null!==this.view&&this.view.enabled){var d=this.zoom/(this.view.width/this.view.fullWidth),f=this.zoom/(this.view.height/this.view.fullHeight),m=(this.right-this.left)/this.view.width,v=(this.top-this.bottom)/this.view.height;l=(o+=m*(this.view.offsetX/d))+m*(this.view.width/d),h=(c-=v*(this.view.offsetY/f))-v*(this.view.height/f)}this.projectionMatrix.makeOrthographic(o,l,c,h,this.near,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(meta){var data=Object3D.prototype.toJSON.call(this,meta);return data.object.zoom=this.zoom,data.object.left=this.left,data.object.right=this.right,data.object.top=this.top,data.object.bottom=this.bottom,data.object.near=this.near,data.object.far=this.far,null!==this.view&&(data.object.view=Object.assign({},this.view)),data}});var ImageUtils={getDataURL:function(image){var canvas;if("undefined"==typeof HTMLCanvasElement)return image.src;if(image instanceof HTMLCanvasElement)canvas=image;else{void 0===_canvas&&(_canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),_canvas.width=image.width,_canvas.height=image.height;var e=_canvas.getContext("2d");image instanceof ImageData?e.putImageData(image,0,0):e.drawImage(image,0,0,image.width,image.height),canvas=_canvas}return canvas.width>2048||canvas.height>2048?canvas.toDataURL("image/jpeg",.6):canvas.toDataURL("image/png")}},textureId=0;function Texture(image,e,t,r,n,o,l,c,h,d){Object.defineProperty(this,"id",{value:textureId++}),this.uuid=_Math.generateUUID(),this.name="",this.image=void 0!==image?image:Texture.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==e?e:Texture.DEFAULT_MAPPING,this.wrapS=void 0!==t?t:ClampToEdgeWrapping,this.wrapT=void 0!==r?r:ClampToEdgeWrapping,this.magFilter=void 0!==n?n:LinearFilter,this.minFilter=void 0!==o?o:LinearMipMapLinearFilter,this.anisotropy=void 0!==h?h:1,this.format=void 0!==l?l:RGBAFormat,this.type=void 0!==c?c:UnsignedByteType,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==d?d:LinearEncoding,this.version=0,this.onUpdate=null}function WebGLRenderTarget(e,t,r){this.width=e,this.height=t,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t),r=r||{},this.texture=new Texture(void 0,void 0,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.encoding),this.texture.generateMipmaps=void 0!==r.generateMipmaps&&r.generateMipmaps,this.texture.minFilter=void 0!==r.minFilter?r.minFilter:LinearFilter,this.depthBuffer=void 0===r.depthBuffer||r.depthBuffer,this.stencilBuffer=void 0===r.stencilBuffer||r.stencilBuffer,this.depthTexture=void 0!==r.depthTexture?r.depthTexture:null}function PlaneGeometry(e,t,r,n){Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n},this.fromBufferGeometry(new PlaneBufferGeometry(e,t,r,n)),this.mergeVertices()}function PlaneBufferGeometry(e,t,r,n){BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n};var o,l,c=(e=e||1)/2,h=(t=t||1)/2,d=Math.floor(r)||1,f=Math.floor(n)||1,m=d+1,v=f+1,y=e/d,x=t/f,w=[],M=[],S=[],A=[];for(l=0;l<v;l++){var T=l*x-h;for(o=0;o<m;o++){var _=o*y-c;M.push(_,-T,0),S.push(0,0,1),A.push(o/d),A.push(1-l/f)}}for(l=0;l<f;l++)for(o=0;o<d;o++){var a=o+m*l,b=o+m*(l+1),L=o+1+m*(l+1),C=o+1+m*l;w.push(a,b,C),w.push(b,L,C)}this.setIndex(w),this.addAttribute("position",new Float32BufferAttribute(M,3)),this.addAttribute("normal",new Float32BufferAttribute(S,3)),this.addAttribute("uv",new Float32BufferAttribute(A,2))}Texture.DEFAULT_IMAGE=void 0,Texture.DEFAULT_MAPPING=UVMapping,Texture.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:Texture,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(source){return this.name=source.name,this.image=source.image,this.mipmaps=source.mipmaps.slice(0),this.mapping=source.mapping,this.wrapS=source.wrapS,this.wrapT=source.wrapT,this.magFilter=source.magFilter,this.minFilter=source.minFilter,this.anisotropy=source.anisotropy,this.format=source.format,this.type=source.type,this.offset.copy(source.offset),this.repeat.copy(source.repeat),this.center.copy(source.center),this.rotation=source.rotation,this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrix.copy(source.matrix),this.generateMipmaps=source.generateMipmaps,this.premultiplyAlpha=source.premultiplyAlpha,this.flipY=source.flipY,this.unpackAlignment=source.unpackAlignment,this.encoding=source.encoding,this},toJSON:function(meta){var e=void 0===meta||"string"==typeof meta;if(!e&&void 0!==meta.textures[this.uuid])return meta.textures[this.uuid];var output={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){var image=this.image;if(void 0===image.uuid&&(image.uuid=_Math.generateUUID()),!e&&void 0===meta.images[image.uuid]){var t;if(Array.isArray(image)){t=[];for(var i=0,r=image.length;i<r;i++)t.push(ImageUtils.getDataURL(image[i]))}else t=ImageUtils.getDataURL(image);meta.images[image.uuid]={uuid:image.uuid,url:t}}output.image=image.uuid}return e||(meta.textures[this.uuid]=output),output},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(this.mapping!==UVMapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case RepeatWrapping:e.x=e.x-Math.floor(e.x);break;case ClampToEdgeWrapping:e.x=e.x<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case RepeatWrapping:e.y=e.y-Math.floor(e.y);break;case ClampToEdgeWrapping:e.y=e.y<0?0:1;break;case MirroredRepeatWrapping:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}}),Object.defineProperty(Texture.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),WebGLRenderTarget.prototype=Object.assign(Object.create(EventDispatcher.prototype),{constructor:WebGLRenderTarget,isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(source){return this.width=source.width,this.height=source.height,this.viewport.copy(source.viewport),this.texture=source.texture.clone(),this.depthBuffer=source.depthBuffer,this.stencilBuffer=source.stencilBuffer,this.depthTexture=source.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),PlaneGeometry.prototype=Object.create(Geometry.prototype),PlaneGeometry.prototype.constructor=PlaneGeometry,PlaneBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PlaneBufferGeometry.prototype.constructor=PlaneBufferGeometry;var BokehShader={defines:{DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tColor:{value:null},tDepth:{value:null},focus:{value:1},aspect:{value:1},aperture:{value:.025},maxblur:{value:1},nearClip:{value:1},farClip:{value:1e3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float nearClip;","uniform float farClip;","uniform float focus;","uniform float aspect;","#include <packing>","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, nearClip, farClip );","\t#else","\treturn orthographicDepthToViewZ( depth, nearClip, farClip );","\t#endif","}","void main() {","vec2 aspectcorrect = vec2( 1.0, aspect );","float viewZ = getViewZ( getDepth( vUv ) );","float factor = ( focus + viewZ );","vec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","vec2 dofblur9 = dofblur * 0.9;","vec2 dofblur7 = dofblur * 0.7;","vec2 dofblur4 = dofblur * 0.4;","vec4 col = vec4( 0.0 );","col += texture2D( tColor, vUv.xy );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","gl_FragColor = col / 41.0;","gl_FragColor.a = 1.0;","}"].join("\n")},BokehShader2={uniforms:{textureWidth:{value:1},textureHeight:{value:1},focalDepth:{value:1},focalLength:{value:24},fstop:{value:.9},tColor:{value:null},tDepth:{value:null},maxblur:{value:1},showFocus:{value:0},manualdof:{value:0},vignetting:{value:0},depthblur:{value:0},threshold:{value:.5},gain:{value:2},bias:{value:.5},fringe:{value:.7},znear:{value:.1},zfar:{value:100},noise:{value:1},dithering:{value:1e-4},pentagon:{value:0},shaderFocus:{value:1},focusCoords:{value:new Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float textureWidth;","uniform float textureHeight;","uniform float focalDepth;  //focal distance value in meters, but you may use autofocus option below","uniform float focalLength; //focal length in mm","uniform float fstop; //f-stop value","uniform bool showFocus; //show debug focus point and focal range (red = focal point, green = focal range)","","uniform float znear; // camera clipping start","uniform float zfar; // camera clipping end","//------------------------------------------","//user variables","const int samples = SAMPLES; //samples on the first ring","const int rings = RINGS; //ring count","const int maxringsamples = rings * samples;","uniform bool manualdof; // manual dof calculation","float ndofstart = 1.0; // near dof blur start","float ndofdist = 2.0; // near dof blur falloff distance","float fdofstart = 1.0; // far dof blur start","float fdofdist = 3.0; // far dof blur falloff distance","float CoC = 0.03; //circle of confusion size in mm (35mm film = 0.03mm)","uniform bool vignetting; // use optical lens vignetting","float vignout = 1.3; // vignetting outer border","float vignin = 0.0; // vignetting inner border","float vignfade = 22.0; // f-stops till vignete fades","uniform bool shaderFocus;","// disable if you use external focalDepth value","uniform vec2 focusCoords;","// autofocus point on screen (0.0,0.0 - left lower corner, 1.0,1.0 - upper right)","// if center of screen use vec2(0.5, 0.5);","uniform float maxblur;","//clamp value of max blur (0.0 = no blur, 1.0 default)","uniform float threshold; // highlight threshold;","uniform float gain; // highlight gain;","uniform float bias; // bokeh edge bias","uniform float fringe; // bokeh chromatic aberration / fringing","uniform bool noise; //use noise instead of pattern for sample dithering","uniform float dithering;","uniform bool depthblur; // blur the depth buffer","float dbsize = 1.25; // depth blur size","","uniform bool pentagon; //use pentagon as bokeh shape?","float feather = 0.4; //pentagon shape feather","//------------------------------------------","float penta(vec2 coords) {","//pentagonal shape","float scale = float(rings) - 1.3;","vec4  HS0 = vec4( 1.0,         0.0,         0.0,  1.0);","vec4  HS1 = vec4( 0.309016994, 0.951056516, 0.0,  1.0);","vec4  HS2 = vec4(-0.809016994, 0.587785252, 0.0,  1.0);","vec4  HS3 = vec4(-0.809016994,-0.587785252, 0.0,  1.0);","vec4  HS4 = vec4( 0.309016994,-0.951056516, 0.0,  1.0);","vec4  HS5 = vec4( 0.0        ,0.0         , 1.0,  1.0);","vec4  one = vec4( 1.0 );","vec4 P = vec4((coords),vec2(scale, scale));","vec4 dist = vec4(0.0);","float inorout = -4.0;","dist.x = dot( P, HS0 );","dist.y = dot( P, HS1 );","dist.z = dot( P, HS2 );","dist.w = dot( P, HS3 );","dist = smoothstep( -feather, feather, dist );","inorout += dot( dist, one );","dist.x = dot( P, HS4 );","dist.y = HS5.w - abs( P.z );","dist = smoothstep( -feather, feather, dist );","inorout += dist.x;","return clamp( inorout, 0.0, 1.0 );","}","float bdepth(vec2 coords) {","// Depth buffer blur","float d = 0.0;","float kernel[9];","vec2 offset[9];","vec2 wh = vec2(1.0/textureWidth,1.0/textureHeight) * dbsize;","offset[0] = vec2(-wh.x,-wh.y);","offset[1] = vec2( 0.0, -wh.y);","offset[2] = vec2( wh.x -wh.y);","offset[3] = vec2(-wh.x,  0.0);","offset[4] = vec2( 0.0,   0.0);","offset[5] = vec2( wh.x,  0.0);","offset[6] = vec2(-wh.x, wh.y);","offset[7] = vec2( 0.0,  wh.y);","offset[8] = vec2( wh.x, wh.y);","kernel[0] = 1.0/16.0;   kernel[1] = 2.0/16.0;   kernel[2] = 1.0/16.0;","kernel[3] = 2.0/16.0;   kernel[4] = 4.0/16.0;   kernel[5] = 2.0/16.0;","kernel[6] = 1.0/16.0;   kernel[7] = 2.0/16.0;   kernel[8] = 1.0/16.0;","for( int i=0; i<9; i++ ) {","float tmp = texture2D(tDepth, coords + offset[i]).r;","d += tmp * kernel[i];","}","return d;","}","vec3 color(vec2 coords,float blur) {","//processing the sample","vec3 col = vec3(0.0);","vec2 texel = vec2(1.0/textureWidth,1.0/textureHeight);","col.r = texture2D(tColor,coords + vec2(0.0,1.0)*texel*fringe*blur).r;","col.g = texture2D(tColor,coords + vec2(-0.866,-0.5)*texel*fringe*blur).g;","col.b = texture2D(tColor,coords + vec2(0.866,-0.5)*texel*fringe*blur).b;","vec3 lumcoeff = vec3(0.299,0.587,0.114);","float lum = dot(col.rgb, lumcoeff);","float thresh = max((lum-threshold)*gain, 0.0);","return col+mix(vec3(0.0),col,thresh*blur);","}","vec3 debugFocus(vec3 col, float blur, float depth) {","float edge = 0.002*depth; //distance based edge smoothing","float m = clamp(smoothstep(0.0,edge,blur),0.0,1.0);","float e = clamp(smoothstep(1.0-edge,1.0,blur),0.0,1.0);","col = mix(col,vec3(1.0,0.5,0.0),(1.0-m)*0.6);","col = mix(col,vec3(0.0,0.5,1.0),((1.0-e)-(1.0-m))*0.2);","return col;","}","float linearize(float depth) {","return -zfar * znear / (depth * (zfar - znear) - zfar);","}","float vignette() {","float dist = distance(vUv.xy, vec2(0.5,0.5));","dist = smoothstep(vignout+(fstop/vignfade), vignin+(fstop/vignfade), dist);","return clamp(dist,0.0,1.0);","}","float gather(float i, float j, int ringsamples, inout vec3 col, float w, float h, float blur) {","float rings2 = float(rings);","float step = PI*2.0 / float(ringsamples);","float pw = cos(j*step)*i;","float ph = sin(j*step)*i;","float p = 1.0;","if (pentagon) {","p = penta(vec2(pw,ph));","}","col += color(vUv.xy + vec2(pw*w,ph*h), blur) * mix(1.0, i/rings2, bias) * p;","return 1.0 * mix(1.0, i /rings2, bias) * p;","}","void main() {","//scene depth calculation","float depth = linearize(texture2D(tDepth,vUv.xy).x);","// Blur depth?","if ( depthblur ) {","depth = linearize(bdepth(vUv.xy));","}","//focal plane calculation","float fDepth = focalDepth;","if (shaderFocus) {","fDepth = linearize(texture2D(tDepth,focusCoords).x);","}","// dof blur factor calculation","float blur = 0.0;","if (manualdof) {","float a = depth-fDepth; // Focal plane","float b = (a-fdofstart)/fdofdist; // Far DoF","float c = (-a-ndofstart)/ndofdist; // Near Dof","blur = (a>0.0) ? b : c;","} else {","float f = focalLength; // focal length in mm","float d = fDepth*1000.0; // focal plane in mm","float o = depth*1000.0; // depth in mm","float a = (o*f)/(o-f);","float b = (d*f)/(d-f);","float c = (d-f)/(d*fstop*CoC);","blur = abs(a-b)*c;","}","blur = clamp(blur,0.0,1.0);","// calculation of pattern for dithering","vec2 noise = vec2(rand(vUv.xy), rand( vUv.xy + vec2( 0.4, 0.6 ) ) )*dithering*blur;","// getting blur x and y step factor","float w = (1.0/textureWidth)*blur*maxblur+noise.x;","float h = (1.0/textureHeight)*blur*maxblur+noise.y;","// calculation of final color","vec3 col = vec3(0.0);","if(blur < 0.05) {","//some optimization thingy","col = texture2D(tColor, vUv.xy).rgb;","} else {","col = texture2D(tColor, vUv.xy).rgb;","float s = 1.0;","int ringsamples;","for (int i = 1; i <= rings; i++) {","","ringsamples = i * samples;","for (int j = 0 ; j < maxringsamples ; j++) {","if (j >= ringsamples) break;","s += gather(float(i), float(j), ringsamples, col, w, h, blur);","}","","}","col /= s; //divide by sample count","}","if (showFocus) {","col = debugFocus(col, blur, depth);","}","if (vignetting) {","col *= vignette();","}","gl_FragColor.rgb = col;","gl_FragColor.a = 1.0;","} "].join("\n")},BokehDepthShader={uniforms:{mNear:{value:1},mFar:{value:1e3}},vertexShader:["varying float vViewZDepth;","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\tvViewZDepth = - mvPosition.z;","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","varying float vViewZDepth;","void main() {","\tfloat color = 1.0 - smoothstep( mNear, mFar, vViewZDepth );","\tgl_FragColor = vec4( vec3( color ), 1.0 );","} "].join("\n")},CinematicCamera=function(e,t,r,n){PerspectiveCamera.call(this,e,t,r,n),this.type="CinematicCamera",this.postprocessing={enabled:!0},this.shaderSettings={rings:3,samples:4};var o=BokehDepthShader;this.materialDepth=new ShaderMaterial({uniforms:o.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}),this.materialDepth.uniforms.mNear.value=r,this.materialDepth.uniforms.mFar.value=n,this.setLens(),this.initPostProcessing()};function Group(){Object3D.call(this),this.type="Group"}CinematicCamera.prototype=Object.create(PerspectiveCamera.prototype),CinematicCamera.prototype.constructor=CinematicCamera,CinematicCamera.prototype.setLens=function(e,t,r,n){void 0===e&&(e=35),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e),void 0===r&&(r=8),void 0===n&&(n=.019),this.fNumber=r,this.coc=n,this.aperture=e/this.fNumber,this.hyperFocal=e*e/(this.aperture*this.coc)},CinematicCamera.prototype.linearize=function(e){var t=this.far,r=this.near;return-t*r/(e*(t-r)-t)},CinematicCamera.prototype.smoothstep=function(e,t,r){var n=this.saturate((r-e)/(t-e));return n*n*(3-2*n)},CinematicCamera.prototype.saturate=function(e){return Math.max(0,Math.min(1,e))},CinematicCamera.prototype.focusAt=function(e){void 0===e&&(e=20);var t=this.getFocalLength();this.focus=e,this.nearPoint=this.hyperFocal*this.focus/(this.hyperFocal+(this.focus-t)),this.farPoint=this.hyperFocal*this.focus/(this.hyperFocal-(this.focus-t)),this.depthOfField=this.farPoint-this.nearPoint,this.depthOfField<0&&(this.depthOfField=0),this.sdistance=this.smoothstep(this.near,this.far,this.focus),this.ldistance=this.linearize(1-this.sdistance),this.postprocessing.bokeh_uniforms.focalDepth.value=this.ldistance},CinematicCamera.prototype.initPostProcessing=function(){if(this.postprocessing.enabled){this.postprocessing.scene=new Scene,this.postprocessing.camera=new OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4),this.postprocessing.scene.add(this.postprocessing.camera);var e={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat};this.postprocessing.rtTextureDepth=new WebGLRenderTarget(window.innerWidth,window.innerHeight,e),this.postprocessing.rtTextureColor=new WebGLRenderTarget(window.innerWidth,window.innerHeight,e);var t=BokehShader;this.postprocessing.bokeh_uniforms=UniformsUtils.clone(t.uniforms),this.postprocessing.bokeh_uniforms.tColor.value=this.postprocessing.rtTextureColor.texture,this.postprocessing.bokeh_uniforms.tDepth.value=this.postprocessing.rtTextureDepth.texture,this.postprocessing.bokeh_uniforms.manualdof.value=0,this.postprocessing.bokeh_uniforms.shaderFocus.value=0,this.postprocessing.bokeh_uniforms.fstop.value=2.8,this.postprocessing.bokeh_uniforms.showFocus.value=1,this.postprocessing.bokeh_uniforms.focalDepth.value=.1,this.postprocessing.bokeh_uniforms.znear.value=this.near,this.postprocessing.bokeh_uniforms.zfar.value=this.near,this.postprocessing.bokeh_uniforms.textureWidth.value=window.innerWidth,this.postprocessing.bokeh_uniforms.textureHeight.value=window.innerHeight,this.postprocessing.materialBokeh=new ShaderMaterial({uniforms:this.postprocessing.bokeh_uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,defines:{RINGS:this.shaderSettings.rings,SAMPLES:this.shaderSettings.samples,DEPTH_PACKING:1}}),this.postprocessing.quad=new Mesh(new PlaneBufferGeometry(window.innerWidth,window.innerHeight),this.postprocessing.materialBokeh),this.postprocessing.quad.position.z=-500,this.postprocessing.scene.add(this.postprocessing.quad)}},CinematicCamera.prototype.renderCinematic=function(e,t){if(this.postprocessing.enabled){var r=t.getRenderTarget();t.clear(),e.overrideMaterial=null,t.setRenderTarget(this.postprocessing.rtTextureColor),t.clear(),t.render(e,camera),e.overrideMaterial=this.materialDepth,t.setRenderTarget(this.postprocessing.rtTextureDepth),t.clear(),t.render(e,camera),t.setRenderTarget(null),t.render(this.postprocessing.scene,this.postprocessing.camera),t.setRenderTarget(r)}},Group.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Group,isGroup:!0});var Car=function(){var e,t,r,n=0,o={LEFT:37,UP:38,RIGHT:39,DOWN:40,BRAKE:32},l=0,c=0,h=null,d=null,f=null,m=new Group,v=new Group,y=null,x=null,w=null,M=1,S=1,A=!1,T={brake:!1,moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function _(n,l,c,h,d){this.enabled=!0,this.elemNames={flWheel:"wheel_fl",frWheel:"wheel_fr",rlWheel:"wheel_rl",rrWheel:"wheel_rr",steeringWheel:"steering_wheel"},this.maxSpeed=n||180,e=.25*-this.maxSpeed,this.acceleration=l||10,t=.5*this.acceleration,this.turningRadius=h||6,r=2*this.acceleration,this.brakePower=c||10,this.speed=0,o=d||o,this.wheelRotationAxis="x",this.wheelTurnAxis="z",this.steeringWheelTurnAxis="y",document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1)}function L(e){return 1===e?1:1-Math.pow(2,-10*e)}return _.prototype={constructor:_,onKeyDown:function(e){switch(e.keyCode){case o.BRAKE:T.brake=!0,T.moveForward=!1,T.moveBackward=!1;break;case o.UP:T.moveForward=!0;break;case o.DOWN:T.moveBackward=!0;break;case o.LEFT:T.moveLeft=!0;break;case o.RIGHT:T.moveRight=!0}},onKeyUp:function(e){switch(e.keyCode){case o.BRAKE:T.brake=!1;break;case o.UP:T.moveForward=!1;break;case o.DOWN:T.moveBackward=!1;break;case o.LEFT:T.moveLeft=!1;break;case o.RIGHT:T.moveRight=!1}},dispose:function(){document.removeEventListener("keydown",this.onKeyDown,!1),document.removeEventListener("keyup",this.onKeyUp,!1)},update:function(o){if(A&&this.enabled){var _=1;if(T.brake&&(_=this.brakePower),T.moveForward&&(this.speed=_Math.clamp(this.speed+o*this.acceleration,e,this.maxSpeed),n=_Math.clamp(n+o,-1,1)),T.moveBackward&&(this.speed=_Math.clamp(this.speed-o*t,e,this.maxSpeed),n=_Math.clamp(n-o,-1,1)),T.moveLeft&&(l=_Math.clamp(l+1.5*o,-.6,.6)),T.moveRight&&(l=_Math.clamp(l-1.5*o,-.6,.6)),!T.moveForward&&!T.moveBackward)if(this.speed>0){var C=L(this.speed/this.maxSpeed);this.speed=_Math.clamp(this.speed-C*o*r*_,0,this.maxSpeed),n=_Math.clamp(n-C*o,0,1)}else{C=L(this.speed/e);this.speed=_Math.clamp(this.speed+C*o*t*_,e,0),n=_Math.clamp(n+C*o,-1,0)}T.moveLeft||T.moveRight||(l=l>0?_Math.clamp(l-1.5*o,0,.6):_Math.clamp(l+1.5*o,-.6,0));var N=-this.speed*o;c-=N*this.turningRadius*.02*l,h.position.x+=Math.sin(c)*N*S,h.position.z+=Math.cos(c)*N*S,h.rotation.y=c;var P=N*(-2/M)*S;m.rotation[this.wheelRotationAxis]-=P,v.rotation[this.wheelRotationAxis]-=P,y.rotation[this.wheelRotationAxis]-=P,x.rotation[this.wheelRotationAxis]-=P,d.rotation[this.wheelTurnAxis]=l,f.rotation[this.wheelTurnAxis]=l,w.rotation[this.steeringWheelTurnAxis]=6*-l}},setModel:function(e,t){t&&(this.elemNames=t),h=e,this.setupWheels(),this.computeDimensions(),A=!0},setupWheels:function(){for(d=h.getObjectByName(this.elemNames.flWheel),f=h.getObjectByName(this.elemNames.frWheel),y=h.getObjectByName(this.elemNames.rlWheel),x=h.getObjectByName(this.elemNames.rrWheel),null!==this.elemNames.steeringWheel&&(w=h.getObjectByName(this.elemNames.steeringWheel));d.children.length>0;)m.add(d.children[0]);for(;f.children.length>0;)v.add(f.children[0]);d.add(m),f.add(v)},computeDimensions:function(){var e=(new Box3).setFromObject(d),t=new Vector3;e.getSize(t),M=Math.max(t.x,t.y,t.z),e.setFromObject(h),t=e.getSize(t),S=Math.max(t.x,t.y,t.z)}},_}(),DeviceOrientationControls=function(object){var e=this;this.object=object,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0;var t=function(t){e.deviceOrientation=t},r=function(){e.screenOrientation=window.orientation||0},n=function(){var e=new Vector3(0,0,1),t=new Euler,r=new Quaternion,n=new Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(o,l,c,h,d){t.set(c,l,-h,"YXZ"),o.setFromEuler(t),o.multiply(n),o.multiply(r.setFromAxisAngle(e,-d))}}();this.connect=function(){r(),window.addEventListener("orientationchange",r,!1),window.addEventListener("deviceorientation",t,!1),e.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r,!1),window.removeEventListener("deviceorientation",t,!1),e.enabled=!1},this.update=function(){if(!1!==e.enabled){var t=e.deviceOrientation;if(t){var r=t.alpha?_Math.degToRad(t.alpha)+e.alphaOffset:0,o=t.beta?_Math.degToRad(t.beta):0,l=t.gamma?_Math.degToRad(t.gamma):0,c=e.screenOrientation?_Math.degToRad(e.screenOrientation):0;n(e.object.quaternion,r,o,l,c)}}},this.dispose=function(){e.disconnect()},this.connect()};function Plane(e,t){this.normal=void 0!==e?e:new Vector3(1,0,0),this.constant=void 0!==t?t:0}function Raycaster(e,t,r,n){this.ray=new Ray(e,t),this.near=r||0,this.far=n||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ascSort(a,b){return a.distance-b.distance}function intersectObject(object,e,t,r){if(!1!==object.visible&&(object.raycast(e,t),!0===r))for(var n=object.children,i=0,o=n.length;i<o;i++)intersectObject(n[i],e,t,!0)}Object.assign(Plane.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,n){return this.normal.set(e,t,r),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new Vector3,t=new Vector3;return function(a,b,r){var n=e.subVectors(r,b).cross(t.subVectors(a,b)).normalize();return this.setFromNormalAndCoplanarPoint(n,a),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return void 0===t&&(console.warn("Plane: .projectPoint() target is now required"),t=new Vector3),t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)},intersectLine:function(){var e=new Vector3;return function(line,t){void 0===t&&(console.warn("Plane: .intersectLine() target is now required"),t=new Vector3);var r=line.delta(e),n=this.normal.dot(r);if(0===n)return 0===this.distanceToPoint(line.start)?t.copy(line.start):void 0;var o=-(line.start.dot(this.normal)+this.constant)/n;return o<0||o>1?void 0:t.copy(r).multiplyScalar(o).add(line.start)}}(),intersectsLine:function(line){var e=this.distanceToPoint(line.start),t=this.distanceToPoint(line.end);return e<0&&t>0||t<0&&e>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return void 0===e&&(console.warn("Plane: .coplanarPoint() target is now required"),e=new Vector3),e.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new Vector3,t=new Matrix3;return function(r,n){var o=n||t.getNormalMatrix(r),l=this.coplanarPoint(e).applyMatrix4(r),c=this.normal.applyMatrix3(o).normalize();return this.constant=-l.dot(c),this}}(),translate:function(e){return this.constant-=e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(Raycaster.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("Raycaster: Unsupported camera type.")},intersectObject:function(object,e,t){var r=t||[];return intersectObject(object,this,r,e),r.sort(ascSort),r},intersectObjects:function(e,t,r){var n=r||[];if(!1===Array.isArray(e))return console.warn("Raycaster.intersectObjects: objects is not an Array."),n;for(var i=0,o=e.length;i<o;i++)intersectObject(e[i],this,n,t);return n.sort(ascSort),n}});var DragControls=function(e,t,r){if(e instanceof Camera){console.warn("DragControls: Constructor now expects ( objects, camera, domElement )");var n=e;e=t,t=n}var o=new Plane,l=new Raycaster,c=new Vector2,h=new Vector3,d=new Vector3,f=new Vector3,m=new Matrix4,v=null,y=null,x=this;function w(){r.addEventListener("mousemove",S,!1),r.addEventListener("mousedown",A,!1),r.addEventListener("mouseup",T,!1),r.addEventListener("mouseleave",T,!1),r.addEventListener("touchmove",_,!1),r.addEventListener("touchstart",L,!1),r.addEventListener("touchend",C,!1)}function M(){r.removeEventListener("mousemove",S,!1),r.removeEventListener("mousedown",A,!1),r.removeEventListener("mouseup",T,!1),r.removeEventListener("mouseleave",T,!1),r.removeEventListener("touchmove",_,!1),r.removeEventListener("touchstart",L,!1),r.removeEventListener("touchend",C,!1)}function S(n){n.preventDefault();var rect=r.getBoundingClientRect();if(c.x=(n.clientX-rect.left)/rect.width*2-1,c.y=-(n.clientY-rect.top)/rect.height*2+1,l.setFromCamera(c,t),v&&x.enabled)return l.ray.intersectPlane(o,d)&&v.position.copy(d.sub(h).applyMatrix4(m)),void x.dispatchEvent({type:"drag",object:v});l.setFromCamera(c,t);var w=l.intersectObjects(e);if(w.length>0){var object=w[0].object;o.setFromNormalAndCoplanarPoint(t.getWorldDirection(o.normal),f.setFromMatrixPosition(object.matrixWorld)),y!==object&&(x.dispatchEvent({type:"hoveron",object:object}),r.style.cursor="pointer",y=object)}else null!==y&&(x.dispatchEvent({type:"hoveroff",object:y}),r.style.cursor="auto",y=null)}function A(n){n.preventDefault(),l.setFromCamera(c,t);var y=l.intersectObjects(e);y.length>0&&(v=y[0].object,l.ray.intersectPlane(o,d)&&(m.getInverse(v.parent.matrixWorld),h.copy(d).sub(f.setFromMatrixPosition(v.matrixWorld))),r.style.cursor="move",x.dispatchEvent({type:"dragstart",object:v}))}function T(e){e.preventDefault(),v&&(x.dispatchEvent({type:"dragend",object:v}),v=null),r.style.cursor=y?"pointer":"auto"}function _(e){e.preventDefault(),e=e.changedTouches[0];var rect=r.getBoundingClientRect();if(c.x=(e.clientX-rect.left)/rect.width*2-1,c.y=-(e.clientY-rect.top)/rect.height*2+1,l.setFromCamera(c,t),v&&x.enabled)return l.ray.intersectPlane(o,d)&&v.position.copy(d.sub(h).applyMatrix4(m)),void x.dispatchEvent({type:"drag",object:v})}function L(n){n.preventDefault(),n=n.changedTouches[0];var rect=r.getBoundingClientRect();c.x=(n.clientX-rect.left)/rect.width*2-1,c.y=-(n.clientY-rect.top)/rect.height*2+1,l.setFromCamera(c,t);var y=l.intersectObjects(e);y.length>0&&(v=y[0].object,o.setFromNormalAndCoplanarPoint(t.getWorldDirection(o.normal),f.setFromMatrixPosition(v.matrixWorld)),l.ray.intersectPlane(o,d)&&(m.getInverse(v.parent.matrixWorld),h.copy(d).sub(f.setFromMatrixPosition(v.matrixWorld))),r.style.cursor="move",x.dispatchEvent({type:"dragstart",object:v}))}function C(e){e.preventDefault(),v&&(x.dispatchEvent({type:"dragend",object:v}),v=null),r.style.cursor="auto"}w(),this.enabled=!0,this.activate=w,this.deactivate=M,this.dispose=function(){M()},this.setObjects=function(){console.error("DragControls: setObjects() has been removed.")},this.on=function(e,t){console.warn("DragControls: on() has been deprecated. Use addEventListener() instead."),x.addEventListener(e,t)},this.off=function(e,t){console.warn("DragControls: off() has been deprecated. Use removeEventListener() instead."),x.removeEventListener(e,t)},this.notify=function(e){console.error("DragControls: notify() has been deprecated. Use dispatchEvent() instead."),x.dispatchEvent({type:e})}};function Spherical(e,t,r){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0,this}DragControls.prototype=Object.create(EventDispatcher.prototype),DragControls.prototype.constructor=DragControls,Object.assign(Spherical.prototype,{set:function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.setFromCartesianCoords(e.x,e.y,e.z)},setFromCartesianCoords:function(e,t,r){return this.radius=Math.sqrt(e*e+t*t+r*r),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,r),this.phi=Math.acos(_Math.clamp(t/this.radius,-1,1))),this}});var EditorControls=function(object,e){e=void 0!==e?e:document,this.enabled=!0,this.center=new Vector3,this.panSpeed=.001,this.zoomSpeed=.1,this.rotationSpeed=.005;var t=this,r=new Vector3,n=new Vector3,o=new Box3,l={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},c=l.NONE,h=this.center,d=new Matrix3,f=new Vector2,m=new Vector2,v=new Spherical,y=new Sphere,x={type:"change"};function w(r){!1!==t.enabled&&(0===r.button?c=l.ROTATE:1===r.button?c=l.ZOOM:2===r.button&&(c=l.PAN),m.set(r.clientX,r.clientY),e.addEventListener("mousemove",M,!1),e.addEventListener("mouseup",S,!1),e.addEventListener("mouseout",S,!1),e.addEventListener("dblclick",S,!1))}function M(e){if(!1!==t.enabled){f.set(e.clientX,e.clientY);var r=f.x-m.x,o=f.y-m.y;c===l.ROTATE?t.rotate(n.set(-r*t.rotationSpeed,-o*t.rotationSpeed,0)):c===l.ZOOM?t.zoom(n.set(0,0,o)):c===l.PAN&&t.pan(n.set(-r,o,0)),m.set(e.clientX,e.clientY)}}function S(t){e.removeEventListener("mousemove",M,!1),e.removeEventListener("mouseup",S,!1),e.removeEventListener("mouseout",S,!1),e.removeEventListener("dblclick",S,!1),c=l.NONE}function A(e){e.preventDefault(),t.zoom(n.set(0,0,e.deltaY>0?1:-1))}function T(e){e.preventDefault()}this.focus=function(e){var r;o.setFromObject(e),!1===o.isEmpty()?(o.getCenter(h),r=o.getBoundingSphere(y).radius):(h.setFromMatrixPosition(e.matrixWorld),r=.1),n.set(0,0,1),n.applyQuaternion(object.quaternion),n.multiplyScalar(4*r),object.position.copy(h).add(n),t.dispatchEvent(x)},this.pan=function(e){var r=object.position.distanceTo(h);e.multiplyScalar(r*t.panSpeed),e.applyMatrix3(d.getNormalMatrix(object.matrix)),object.position.add(e),h.add(e),t.dispatchEvent(x)},this.zoom=function(e){var r=object.position.distanceTo(h);e.multiplyScalar(r*t.zoomSpeed),e.length()>r||(e.applyMatrix3(d.getNormalMatrix(object.matrix)),object.position.add(e),t.dispatchEvent(x))},this.rotate=function(e){r.copy(object.position).sub(h),v.setFromVector3(r),v.theta+=e.x,v.phi+=e.y,v.makeSafe(),r.setFromSpherical(v),object.position.copy(h).add(r),object.lookAt(h),t.dispatchEvent(x)},this.dispose=function(){e.removeEventListener("contextmenu",T,!1),e.removeEventListener("mousedown",w,!1),e.removeEventListener("wheel",A,!1),e.removeEventListener("mousemove",M,!1),e.removeEventListener("mouseup",S,!1),e.removeEventListener("mouseout",S,!1),e.removeEventListener("dblclick",S,!1),e.removeEventListener("touchstart",N,!1),e.removeEventListener("touchmove",P,!1)},e.addEventListener("contextmenu",T,!1),e.addEventListener("mousedown",w,!1),e.addEventListener("wheel",A,!1);var _=[new Vector3,new Vector3,new Vector3],L=[new Vector3,new Vector3,new Vector3],C=null;function N(e){if(!1!==t.enabled){switch(e.touches.length){case 1:_[0].set(e.touches[0].pageX,e.touches[0].pageY,0),_[1].set(e.touches[0].pageX,e.touches[0].pageY,0);break;case 2:_[0].set(e.touches[0].pageX,e.touches[0].pageY,0),_[1].set(e.touches[1].pageX,e.touches[1].pageY,0),C=_[0].distanceTo(_[1])}L[0].copy(_[0]),L[1].copy(_[1])}}function P(e){if(!1!==t.enabled){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:_[0].set(e.touches[0].pageX,e.touches[0].pageY,0),_[1].set(e.touches[0].pageX,e.touches[0].pageY,0),t.rotate(_[0].sub(c(_[0],L)).multiplyScalar(-t.rotationSpeed));break;case 2:_[0].set(e.touches[0].pageX,e.touches[0].pageY,0),_[1].set(e.touches[1].pageX,e.touches[1].pageY,0);var r=_[0].distanceTo(_[1]);t.zoom(n.set(0,0,C-r)),C=r;var o=_[0].clone().sub(c(_[0],L)),l=_[1].clone().sub(c(_[1],L));o.x=-o.x,l.x=-l.x,t.pan(o.add(l).multiplyScalar(.5))}L[0].copy(_[0]),L[1].copy(_[1])}function c(e,t){var r=t[0];for(var i in t)r.distanceTo(e)>t[i].distanceTo(e)&&(r=t[i]);return r}}e.addEventListener("touchstart",N,!1),e.addEventListener("touchmove",P,!1)};EditorControls.prototype=Object.create(EventDispatcher.prototype),EditorControls.prototype.constructor=EditorControls;var FirstPersonControls=function(object,e){this.object=object,this.domElement=void 0!==e?e:document,this.enabled=!0,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0;var t,r=0,n=0,o=new Vector3,l=new Spherical,c=new Vector3;function h(e){e.preventDefault()}this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0},this.onMouseUp=function(e){if(e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1},this.onMouseMove=function(e){this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0}},this.onKeyUp=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}},this.lookAt=function(e,t,r){return e.isVector3?c.copy(e):c.set(e,t,r),this.object.lookAt(c),w(this),this},this.update=(t=new Vector3,function(e){if(!1!==this.enabled){if(this.heightSpeed){var o=_Math.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=e*(o*this.heightCoef)}else this.autoSpeedFactor=0;var l=e*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(l+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(l),this.moveLeft&&this.object.translateX(-l),this.moveRight&&this.object.translateX(l),this.moveUp&&this.object.translateY(l),this.moveDown&&this.object.translateY(-l);var c=e*this.lookSpeed;this.activeLook||(c=0);var h=1;this.constrainVertical&&(h=Math.PI/(this.verticalMax-this.verticalMin)),n-=this.mouseX*c,this.lookVertical&&(r-=this.mouseY*c*h),r=Math.max(-85,Math.min(85,r));var d=_Math.degToRad(90-r),f=_Math.degToRad(n);this.constrainVertical&&(d=_Math.mapLinear(d,0,Math.PI,this.verticalMin,this.verticalMax));var m=this.object.position;t.setFromSphericalCoords(1,d,f).add(m),this.object.lookAt(t)}}),this.dispose=function(){this.domElement.removeEventListener("contextmenu",h,!1),this.domElement.removeEventListener("mousedown",f,!1),this.domElement.removeEventListener("mousemove",d,!1),this.domElement.removeEventListener("mouseup",m,!1),window.removeEventListener("keydown",v,!1),window.removeEventListener("keyup",y,!1)};var d=x(this,this.onMouseMove),f=x(this,this.onMouseDown),m=x(this,this.onMouseUp),v=x(this,this.onKeyDown),y=x(this,this.onKeyUp);function x(e,t){return function(){t.apply(e,arguments)}}function w(e){var t=e.object.quaternion;o.set(0,0,-1).applyQuaternion(t),l.setFromVector3(o),r=90-_Math.radToDeg(l.phi),n=_Math.radToDeg(l.theta)}this.domElement.addEventListener("contextmenu",h,!1),this.domElement.addEventListener("mousemove",d,!1),this.domElement.addEventListener("mousedown",f,!1),this.domElement.addEventListener("mouseup",m,!1),window.addEventListener("keydown",v,!1),window.addEventListener("keyup",y,!1),this.handleResize(),w(this)},FlyControls=function(object,e){function t(e,t){return function(){t.apply(e,arguments)}}function r(e){e.preventDefault()}this.object=object,this.domElement=void 0!==e?e:document,e&&this.domElement.setAttribute("tabindex",-1),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this.tmpQuaternion=new Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new Vector3(0,0,0),this.rotationVector=new Vector3(0,0,0),this.keydown=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus++;else{switch(e.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1}this.updateMovementVector()}},this.mousemove=function(e){if(!this.dragToLook||this.mouseStatus>0){var t=this.getContainerDimensions(),r=t.size[0]/2,n=t.size[1]/2;this.moveState.yawLeft=-(e.pageX-t.offset[0]-r)/r,this.moveState.pitchDown=(e.pageY-t.offset[1]-n)/n,this.updateRotationVector()}},this.mouseup=function(e){if(e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(e.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0}this.updateMovementVector()}this.updateRotationVector()},this.update=function(e){var t=e*this.movementSpeed,r=e*this.rollSpeed;this.object.translateX(this.moveVector.x*t),this.object.translateY(this.moveVector.y*t),this.object.translateZ(this.moveVector.z*t),this.tmpQuaternion.set(this.rotationVector.x*r,this.rotationVector.y*r,this.rotationVector.z*r,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)},this.updateMovementVector=function(){var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.dispose=function(){this.domElement.removeEventListener("contextmenu",r,!1),this.domElement.removeEventListener("mousedown",o,!1),this.domElement.removeEventListener("mousemove",n,!1),this.domElement.removeEventListener("mouseup",l,!1),window.removeEventListener("keydown",c,!1),window.removeEventListener("keyup",h,!1)};var n=t(this,this.mousemove),o=t(this,this.mousedown),l=t(this,this.mouseup),c=t(this,this.keydown),h=t(this,this.keyup);this.domElement.addEventListener("contextmenu",r,!1),this.domElement.addEventListener("mousemove",n,!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mouseup",l,!1),window.addEventListener("keydown",c,!1),window.addEventListener("keyup",h,!1),this.updateMovementVector(),this.updateRotationVector()},MapControls=function(object,e){this.object=object,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.LEFT,MIDDLE:MOUSE.MIDDLE,RIGHT:MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return d.phi},this.getAzimuthalAngle=function(){return d.theta},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(r),t.update(),c=l.NONE},this.update=function(){var e=new Vector3,n=(new Quaternion).setFromUnitVectors(object.up,new Vector3(0,1,0)),o=n.clone().inverse(),x=new Vector3,w=new Quaternion;return function(){var M=t.object.position;return e.copy(M).sub(t.target),e.applyQuaternion(n),d.setFromVector3(e),t.autoRotate&&c===l.NONE&&O(2*Math.PI/60/60*t.autoRotateSpeed),d.theta+=f.theta,d.phi+=f.phi,d.theta=Math.max(t.minAzimuthAngle,Math.min(t.maxAzimuthAngle,d.theta)),d.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,d.phi)),d.makeSafe(),d.radius*=m,d.radius=Math.max(t.minDistance,Math.min(t.maxDistance,d.radius)),t.target.add(v),e.setFromSpherical(d),e.applyQuaternion(o),M.copy(t.target).add(e),t.object.lookAt(t.target),!0===t.enableDamping?(f.theta*=1-t.dampingFactor,f.phi*=1-t.dampingFactor,v.multiplyScalar(1-t.dampingFactor)):(f.set(0,0,0),v.set(0,0,0)),m=1,!!(y||x.distanceToSquared(t.object.position)>h||8*(1-w.dot(t.object.quaternion))>h)&&(t.dispatchEvent(r),x.copy(t.object.position),w.copy(t.object.quaternion),y=!1,!0)}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",re,!1),t.domElement.removeEventListener("mousedown",Y,!1),t.domElement.removeEventListener("wheel",J,!1),t.domElement.removeEventListener("touchstart",$,!1),t.domElement.removeEventListener("touchend",te,!1),t.domElement.removeEventListener("touchmove",ee,!1),document.removeEventListener("mousemove",Q,!1),document.removeEventListener("mouseup",K,!1),window.removeEventListener("keydown",Z,!1)};var t=this,r={type:"change"},n={type:"start"},o={type:"end"},l={NONE:0,ROTATE_UP:1,ROTATE_LEFT:2,ROTATE:3,DOLLY:4,DOLLY_ROTATE:7,PAN:8,DOLLY_PAN:12},c=l.NONE,h=1e-6,d=new Spherical,f=new Spherical,m=1,v=new Vector3,y=!1,x=new Vector2,w=new Vector2,M=new Vector2,S=new Vector2,A=new Vector2,T=new Vector2,_=new Vector2,L=new Vector2,C=new Vector2,N=new Vector2,P=new Vector2,E=new Vector2,D=new Vector2,F=new Vector2;function R(){return Math.pow(.95,t.zoomSpeed)}function O(e){f.theta-=e}function B(e){f.phi-=e}var I=function(){var e=new Vector3;return function(t,r){e.setFromMatrixColumn(r,0),e.multiplyScalar(-t),v.add(e)}}(),U=function(){var e=new Vector3;return function(r,n){!0===t.screenSpacePanning?e.setFromMatrixColumn(n,1):(e.setFromMatrixColumn(n,0),e.crossVectors(t.object.up,e)),e.multiplyScalar(r),v.add(e)}}(),V=function(){var e=new Vector3;return function(r,n){var element=t.domElement===document?t.domElement.body:t.domElement;if(t.object.isPerspectiveCamera){var o=t.object.position;e.copy(o).sub(t.target);var l=e.length();l*=Math.tan(t.object.fov/2*Math.PI/180),I(2*r*l/element.clientHeight,t.object.matrix),U(2*n*l/element.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(I(r*(t.object.right-t.object.left)/t.object.zoom/element.clientWidth,t.object.matrix),U(n*(t.object.top-t.object.bottom)/t.object.zoom/element.clientHeight,t.object.matrix)):(console.warn("WARNING: MapControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function k(e){t.object.isPerspectiveCamera?m/=e:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*e)),t.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function G(e){t.object.isPerspectiveCamera?m*=e:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/e)),t.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function z(e){x.set(e.clientX,e.clientY)}function j(e){if(!1!==t.enableRotate&&0!=(c&l.ROTATE)){if(M.set(e.touches[0].pageX,e.touches[0].pageY),S.set(e.touches[1].pageX,e.touches[1].pageY),A.subVectors(M,x),T.subVectors(S,w),_.subVectors(w,x),L.subVectors(S,M),function(){if(!H(_))return!1;if(!H(L))return!1;if(!X(A))return!1;if(!X(T))return!1;return A.dot(T)>0}()){var element=t.domElement===document?t.domElement.body:t.domElement;B(2*Math.PI*A.y/element.clientHeight),c=l.ROTATE_UP}else 0!=(c&l.ROTATE_LEFT)&&O((_.angle()-L.angle())*t.rotateSpeed);x.copy(M),w.copy(S)}}var W,H=(W=Math.sin(Math.PI/6),function(e){return Math.abs(Math.sin(e.angle()))<W}),X=function(){var e=Math.cos(Math.PI/2-Math.PI/6);return function(t){return Math.abs(Math.cos(t.angle()))<e}}();function Y(e){if(!1!==t.enabled){switch(e.preventDefault(),e.button){case t.mouseButtons.LEFT:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===t.enableRotate)return;z(e),c=l.ROTATE}else{if(!1===t.enablePan)return;!function(e){C.set(e.clientX,e.clientY)}(e),c=l.PAN}break;case t.mouseButtons.MIDDLE:if(!1===t.enableZoom)return;!function(e){E.set(e.clientX,e.clientY)}(e),c=l.DOLLY;break;case t.mouseButtons.RIGHT:if(!1===t.enableRotate)return;z(e),c=l.ROTATE}c!==l.NONE&&(document.addEventListener("mousemove",Q,!1),document.addEventListener("mouseup",K,!1),t.dispatchEvent(n))}}function Q(e){if(!1!==t.enabled)switch(e.preventDefault(),c){case l.ROTATE:if(!1===t.enableRotate)return;!function(e){M.set(e.clientX,e.clientY),A.subVectors(M,x).multiplyScalar(t.rotateSpeed);var element=t.domElement===document?t.domElement.body:t.domElement;O(2*Math.PI*A.x/element.clientHeight),B(2*Math.PI*A.y/element.clientHeight),x.copy(M),t.update()}(e);break;case l.DOLLY:if(!1===t.enableZoom)return;!function(e){D.set(e.clientX,e.clientY),F.subVectors(D,E),F.y>0?k(R()):F.y<0&&G(R()),E.copy(D),t.update()}(e);break;case l.PAN:if(!1===t.enablePan)return;!function(e){N.set(e.clientX,e.clientY),P.subVectors(N,C).multiplyScalar(t.panSpeed),V(P.x,P.y),C.copy(N),t.update()}(e)}}function K(e){!1!==t.enabled&&(document.removeEventListener("mousemove",Q,!1),document.removeEventListener("mouseup",K,!1),t.dispatchEvent(o),c=l.NONE)}function J(e){!1===t.enabled||!1===t.enableZoom||c!==l.NONE&&c!==l.ROTATE||(e.preventDefault(),e.stopPropagation(),t.dispatchEvent(n),function(e){e.deltaY<0?G(R()):e.deltaY>0&&k(R()),t.update()}(e),t.dispatchEvent(o))}function Z(e){!1!==t.enabled&&!1!==t.enableKeys&&!1!==t.enablePan&&function(e){switch(e.keyCode){case t.keys.UP:V(0,t.keyPanSpeed),t.update();break;case t.keys.BOTTOM:V(0,-t.keyPanSpeed),t.update();break;case t.keys.LEFT:V(t.keyPanSpeed,0),t.update();break;case t.keys.RIGHT:V(-t.keyPanSpeed,0),t.update()}}(e)}function $(e){if(!1!==t.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===t.enablePan)return;!function(e){t.enablePan&&C.set(e.touches[0].pageX,e.touches[0].pageY)}(e),c=l.PAN;break;case 2:if(!1===t.enableZoom&&!1===t.enableRotate)return;!function(e){x.set(e.touches[0].pageX,e.touches[0].pageY),w.set(e.touches[1].pageX,e.touches[1].pageY)}(e),function(e){if(t.enableZoom){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);E.set(0,o)}}(e),c=l.DOLLY_ROTATE;break;default:c=l.NONE}c!==l.NONE&&t.dispatchEvent(n)}}function ee(e){if(!1!==t.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===t.enablePan)return;if(c!==l.PAN)return;!function(e){!1!==t.enablePan&&0!=(c&l.PAN)&&(N.set(e.touches[0].pageX,e.touches[0].pageY),P.subVectors(N,C).multiplyScalar(t.panSpeed),V(P.x,P.y),C.copy(N))}(e),t.update();break;case 2:if(!1===t.enableZoom&&!1===t.enableRotate)return;if(0==(c&l.DOLLY_ROTATE))return;j(e),function(e){if(!1!==t.enableZoom&&0!=(c&l.DOLLY)){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);D.set(0,o),F.set(0,Math.pow(D.y/E.y,t.zoomSpeed)),k(F.y),E.copy(D)}}(e),t.update();break;default:c=l.NONE}}function te(e){!1!==t.enabled&&(t.dispatchEvent(o),c=l.NONE)}function re(e){!1!==t.enabled&&e.preventDefault()}t.domElement.addEventListener("contextmenu",re,!1),t.domElement.addEventListener("mousedown",Y,!1),t.domElement.addEventListener("wheel",J,!1),t.domElement.addEventListener("touchstart",$,!1),t.domElement.addEventListener("touchend",te,!1),t.domElement.addEventListener("touchmove",ee,!1),window.addEventListener("keydown",Z,!1),this.update()};MapControls.prototype=Object.create(EventDispatcher.prototype),MapControls.prototype.constructor=MapControls,Object.defineProperties(MapControls.prototype,{center:{get:function(){return console.warn("MapControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("MapControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("MapControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("MapControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("MapControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("MapControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("MapControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("MapControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("MapControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var OrbitControls=function(object,e){this.object=object,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:MOUSE.LEFT,MIDDLE:MOUSE.MIDDLE,RIGHT:MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return d.phi},this.getAzimuthalAngle=function(){return d.theta},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(r),t.update(),c=l.NONE},this.update=function(){var e=new Vector3,n=(new Quaternion).setFromUnitVectors(object.up,new Vector3(0,1,0)),o=n.clone().inverse(),x=new Vector3,w=new Quaternion;return function(){var M=t.object.position;return e.copy(M).sub(t.target),e.applyQuaternion(n),d.setFromVector3(e),t.autoRotate&&c===l.NONE&&P(2*Math.PI/60/60*t.autoRotateSpeed),d.theta+=f.theta,d.phi+=f.phi,d.theta=Math.max(t.minAzimuthAngle,Math.min(t.maxAzimuthAngle,d.theta)),d.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,d.phi)),d.makeSafe(),d.radius*=m,d.radius=Math.max(t.minDistance,Math.min(t.maxDistance,d.radius)),t.target.add(v),e.setFromSpherical(d),e.applyQuaternion(o),M.copy(t.target).add(e),t.object.lookAt(t.target),!0===t.enableDamping?(f.theta*=1-t.dampingFactor,f.phi*=1-t.dampingFactor,v.multiplyScalar(1-t.dampingFactor)):(f.set(0,0,0),v.set(0,0,0)),m=1,!!(y||x.distanceToSquared(t.object.position)>h||8*(1-w.dot(t.object.quaternion))>h)&&(t.dispatchEvent(r),x.copy(t.object.position),w.copy(t.object.quaternion),y=!1,!0)}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",X,!1),t.domElement.removeEventListener("mousedown",U,!1),t.domElement.removeEventListener("wheel",G,!1),t.domElement.removeEventListener("touchstart",j,!1),t.domElement.removeEventListener("touchend",H,!1),t.domElement.removeEventListener("touchmove",W,!1),document.removeEventListener("mousemove",V,!1),document.removeEventListener("mouseup",k,!1),window.removeEventListener("keydown",z,!1)};var t=this,r={type:"change"},n={type:"start"},o={type:"end"},l={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},c=l.NONE,h=1e-6,d=new Spherical,f=new Spherical,m=1,v=new Vector3,y=!1,x=new Vector2,w=new Vector2,M=new Vector2,S=new Vector2,A=new Vector2,T=new Vector2,_=new Vector2,L=new Vector2,C=new Vector2;function N(){return Math.pow(.95,t.zoomSpeed)}function P(e){f.theta-=e}function E(e){f.phi-=e}var D=function(){var e=new Vector3;return function(t,r){e.setFromMatrixColumn(r,0),e.multiplyScalar(-t),v.add(e)}}(),F=function(){var e=new Vector3;return function(r,n){!0===t.screenSpacePanning?e.setFromMatrixColumn(n,1):(e.setFromMatrixColumn(n,0),e.crossVectors(t.object.up,e)),e.multiplyScalar(r),v.add(e)}}(),R=function(){var e=new Vector3;return function(r,n){var element=t.domElement===document?t.domElement.body:t.domElement;if(t.object.isPerspectiveCamera){var o=t.object.position;e.copy(o).sub(t.target);var l=e.length();l*=Math.tan(t.object.fov/2*Math.PI/180),D(2*r*l/element.clientHeight,t.object.matrix),F(2*n*l/element.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(D(r*(t.object.right-t.object.left)/t.object.zoom/element.clientWidth,t.object.matrix),F(n*(t.object.top-t.object.bottom)/t.object.zoom/element.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function O(e){t.object.isPerspectiveCamera?m/=e:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*e)),t.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function B(e){t.object.isPerspectiveCamera?m*=e:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/e)),t.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function I(e){S.set(e.clientX,e.clientY)}function U(e){if(!1!==t.enabled){switch(e.preventDefault(),t.domElement.focus?t.domElement.focus():window.focus(),e.button){case t.mouseButtons.LEFT:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===t.enablePan)return;I(e),c=l.PAN}else{if(!1===t.enableRotate)return;!function(e){x.set(e.clientX,e.clientY)}(e),c=l.ROTATE}break;case t.mouseButtons.MIDDLE:if(!1===t.enableZoom)return;!function(e){_.set(e.clientX,e.clientY)}(e),c=l.DOLLY;break;case t.mouseButtons.RIGHT:if(!1===t.enablePan)return;I(e),c=l.PAN}c!==l.NONE&&(document.addEventListener("mousemove",V,!1),document.addEventListener("mouseup",k,!1),t.dispatchEvent(n))}}function V(e){if(!1!==t.enabled)switch(e.preventDefault(),c){case l.ROTATE:if(!1===t.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),M.subVectors(w,x).multiplyScalar(t.rotateSpeed);var element=t.domElement===document?t.domElement.body:t.domElement;P(2*Math.PI*M.x/element.clientHeight),E(2*Math.PI*M.y/element.clientHeight),x.copy(w),t.update()}(e);break;case l.DOLLY:if(!1===t.enableZoom)return;!function(e){L.set(e.clientX,e.clientY),C.subVectors(L,_),C.y>0?O(N()):C.y<0&&B(N()),_.copy(L),t.update()}(e);break;case l.PAN:if(!1===t.enablePan)return;!function(e){A.set(e.clientX,e.clientY),T.subVectors(A,S).multiplyScalar(t.panSpeed),R(T.x,T.y),S.copy(A),t.update()}(e)}}function k(e){!1!==t.enabled&&(document.removeEventListener("mousemove",V,!1),document.removeEventListener("mouseup",k,!1),t.dispatchEvent(o),c=l.NONE)}function G(e){!1===t.enabled||!1===t.enableZoom||c!==l.NONE&&c!==l.ROTATE||(e.preventDefault(),e.stopPropagation(),t.dispatchEvent(n),function(e){e.deltaY<0?B(N()):e.deltaY>0&&O(N()),t.update()}(e),t.dispatchEvent(o))}function z(e){!1!==t.enabled&&!1!==t.enableKeys&&!1!==t.enablePan&&function(e){var r=!1;switch(e.keyCode){case t.keys.UP:R(0,t.keyPanSpeed),r=!0;break;case t.keys.BOTTOM:R(0,-t.keyPanSpeed),r=!0;break;case t.keys.LEFT:R(t.keyPanSpeed,0),r=!0;break;case t.keys.RIGHT:R(-t.keyPanSpeed,0),r=!0}r&&(e.preventDefault(),t.update())}(e)}function j(e){if(!1!==t.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===t.enableRotate)return;!function(e){x.set(e.touches[0].pageX,e.touches[0].pageY)}(e),c=l.TOUCH_ROTATE;break;case 2:if(!1===t.enableZoom&&!1===t.enablePan)return;!function(e){if(t.enableZoom){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);_.set(0,o)}if(t.enablePan){var l=.5*(e.touches[0].pageX+e.touches[1].pageX),c=.5*(e.touches[0].pageY+e.touches[1].pageY);S.set(l,c)}}(e),c=l.TOUCH_DOLLY_PAN;break;default:c=l.NONE}c!==l.NONE&&t.dispatchEvent(n)}}function W(e){if(!1!==t.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===t.enableRotate)return;if(c!==l.TOUCH_ROTATE)return;!function(e){w.set(e.touches[0].pageX,e.touches[0].pageY),M.subVectors(w,x).multiplyScalar(t.rotateSpeed);var element=t.domElement===document?t.domElement.body:t.domElement;P(2*Math.PI*M.x/element.clientHeight),E(2*Math.PI*M.y/element.clientHeight),x.copy(w),t.update()}(e);break;case 2:if(!1===t.enableZoom&&!1===t.enablePan)return;if(c!==l.TOUCH_DOLLY_PAN)return;!function(e){if(t.enableZoom){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);L.set(0,o),C.set(0,Math.pow(L.y/_.y,t.zoomSpeed)),O(C.y),_.copy(L)}if(t.enablePan){var l=.5*(e.touches[0].pageX+e.touches[1].pageX),c=.5*(e.touches[0].pageY+e.touches[1].pageY);A.set(l,c),T.subVectors(A,S).multiplyScalar(t.panSpeed),R(T.x,T.y),S.copy(A)}t.update()}(e);break;default:c=l.NONE}}function H(e){!1!==t.enabled&&(t.dispatchEvent(o),c=l.NONE)}function X(e){!1!==t.enabled&&e.preventDefault()}t.domElement.addEventListener("contextmenu",X,!1),t.domElement.addEventListener("mousedown",U,!1),t.domElement.addEventListener("wheel",G,!1),t.domElement.addEventListener("touchstart",j,!1),t.domElement.addEventListener("touchend",H,!1),t.domElement.addEventListener("touchmove",W,!1),window.addEventListener("keydown",z,!1),this.update()};OrbitControls.prototype=Object.create(EventDispatcher.prototype),OrbitControls.prototype.constructor=OrbitControls,Object.defineProperties(OrbitControls.prototype,{center:{get:function(){return console.warn("OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var OrthographicTrackballControls=function(object,e){var t=this,r={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=object,this.domElement=void 0!==e?e:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.radius=0,this.rotateSpeed=1,this.zoomSpeed=1.2,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new Vector3;var n=!0,o=r.NONE,l=r.NONE,c=new Vector3,h=new Vector3,d=new Vector3,f=new Vector2,m=new Vector2,v=0,y=0,x=new Vector2,w=new Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom;var M={type:"change"},S={type:"start"},A={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.radius=.5*Math.min(this.screen.width,this.screen.height),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom};var T,_,L,C=function(){var e=new Vector2;return function(r,n){return e.set((r-t.screen.left)/t.screen.width,(n-t.screen.top)/t.screen.height),e}}(),N=function(){var e=new Vector3,r=new Vector3,n=new Vector3;return function(o,l){n.set((o-.5*t.screen.width-t.screen.left)/t.radius,(.5*t.screen.height+t.screen.top-l)/t.radius,0);var h=n.length();return t.noRoll?h<Math.SQRT1_2?n.z=Math.sqrt(1-h*h):n.z=.5/h:h>1?n.normalize():n.z=Math.sqrt(1-h*h),c.copy(t.object.position).sub(t.target),e.copy(t.object.up).setLength(n.y),e.add(r.copy(t.object.up).cross(c).setLength(n.x)),e.add(c.setLength(n.z)),e}}();function P(e){!1!==t.enabled&&(window.removeEventListener("keydown",P),l=o,o===r.NONE&&(e.keyCode!==t.keys[r.ROTATE]||t.noRotate?e.keyCode!==t.keys[r.ZOOM]||t.noZoom?e.keyCode!==t.keys[r.PAN]||t.noPan||(o=r.PAN):o=r.ZOOM:o=r.ROTATE))}function E(e){!1!==t.enabled&&(o=l,window.addEventListener("keydown",P,!1))}function D(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o===r.NONE&&(o=e.button),o!==r.ROTATE||t.noRotate?o!==r.ZOOM||t.noZoom?o!==r.PAN||t.noPan||(x.copy(C(e.pageX,e.pageY)),w.copy(x)):(f.copy(C(e.pageX,e.pageY)),m.copy(f)):(h.copy(N(e.pageX,e.pageY)),d.copy(h)),document.addEventListener("mousemove",F,!1),document.addEventListener("mouseup",R,!1),t.dispatchEvent(S))}function F(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o!==r.ROTATE||t.noRotate?o!==r.ZOOM||t.noZoom?o!==r.PAN||t.noPan||w.copy(C(e.pageX,e.pageY)):m.copy(C(e.pageX,e.pageY)):d.copy(N(e.pageX,e.pageY)))}function R(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o=r.NONE,document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",R),t.dispatchEvent(A))}function O(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),f.y+=.01*e.deltaY,t.dispatchEvent(S),t.dispatchEvent(A))}function B(e){if(!1!==t.enabled){switch(e.touches.length){case 1:o=r.TOUCH_ROTATE,h.copy(N(e.touches[0].pageX,e.touches[0].pageY)),d.copy(h);break;case 2:o=r.TOUCH_ZOOM_PAN;var n=e.touches[0].pageX-e.touches[1].pageX,l=e.touches[0].pageY-e.touches[1].pageY;y=v=Math.sqrt(n*n+l*l);var c=(e.touches[0].pageX+e.touches[1].pageX)/2,f=(e.touches[0].pageY+e.touches[1].pageY)/2;x.copy(C(c,f)),w.copy(x);break;default:o=r.NONE}t.dispatchEvent(S)}}function I(e){if(!1!==t.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:d.copy(N(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var n=e.touches[0].pageX-e.touches[1].pageX,l=e.touches[0].pageY-e.touches[1].pageY;y=Math.sqrt(n*n+l*l);var c=(e.touches[0].pageX+e.touches[1].pageX)/2,h=(e.touches[0].pageY+e.touches[1].pageY)/2;w.copy(C(c,h));break;default:o=r.NONE}}function U(e){if(!1!==t.enabled){switch(e.touches.length){case 1:d.copy(N(e.touches[0].pageX,e.touches[0].pageY)),h.copy(d);break;case 2:v=y=0;var n=(e.touches[0].pageX+e.touches[1].pageX)/2,l=(e.touches[0].pageY+e.touches[1].pageY)/2;w.copy(C(n,l)),x.copy(w)}o=r.NONE,t.dispatchEvent(A)}}function V(e){e.preventDefault()}this.rotateCamera=function(){var e=new Vector3,r=new Quaternion;return function(){var o=Math.acos(h.dot(d)/h.length()/d.length());o&&(e.crossVectors(h,d).normalize(),o*=t.rotateSpeed,r.setFromAxisAngle(e,-o),c.applyQuaternion(r),t.object.up.applyQuaternion(r),d.applyQuaternion(r),t.staticMoving?h.copy(d):(r.setFromAxisAngle(e,o*(t.dynamicDampingFactor-1)),h.applyQuaternion(r)),n=!0)}}(),this.zoomCamera=function(){if(o===r.TOUCH_ZOOM_PAN){var e=y/v;v=y,t.object.zoom*=e,n=!0}else{e=1+(m.y-f.y)*t.zoomSpeed;Math.abs(e-1)>1e-6&&e>0&&(t.object.zoom/=e,t.staticMoving?f.copy(m):f.y+=(m.y-f.y)*this.dynamicDampingFactor,n=!0)}},this.panCamera=(T=new Vector2,_=new Vector3,L=new Vector3,function(){if(T.copy(w).sub(x),T.lengthSq()){var e=(t.object.right-t.object.left)/t.object.zoom,r=(t.object.top-t.object.bottom)/t.object.zoom;T.x*=e,T.y*=r,L.copy(c).cross(t.object.up).setLength(T.x),L.add(_.copy(t.object.up).setLength(T.y)),t.object.position.add(L),t.target.add(L),t.staticMoving?x.copy(w):x.add(T.subVectors(w,x).multiplyScalar(t.dynamicDampingFactor)),n=!0}}),this.update=function(){c.subVectors(t.object.position,t.target),t.noRotate||t.rotateCamera(),t.noZoom||(t.zoomCamera(),n&&t.object.updateProjectionMatrix()),t.noPan||t.panCamera(),t.object.position.addVectors(t.target,c),t.object.lookAt(t.target),n&&(t.dispatchEvent(M),n=!1)},this.reset=function(){o=r.NONE,l=r.NONE,t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.up.copy(t.up0),c.subVectors(t.object.position,t.target),t.object.left=t.left0,t.object.right=t.right0,t.object.top=t.top0,t.object.bottom=t.bottom0,t.object.lookAt(t.target),t.dispatchEvent(M),n=!1},this.dispose=function(){this.domElement.removeEventListener("contextmenu",V,!1),this.domElement.removeEventListener("mousedown",D,!1),this.domElement.removeEventListener("wheel",O,!1),this.domElement.removeEventListener("touchstart",B,!1),this.domElement.removeEventListener("touchend",U,!1),this.domElement.removeEventListener("touchmove",I,!1),document.removeEventListener("mousemove",F,!1),document.removeEventListener("mouseup",R,!1),window.removeEventListener("keydown",P,!1),window.removeEventListener("keyup",E,!1)},this.domElement.addEventListener("contextmenu",V,!1),this.domElement.addEventListener("mousedown",D,!1),this.domElement.addEventListener("wheel",O,!1),this.domElement.addEventListener("touchstart",B,!1),this.domElement.addEventListener("touchend",U,!1),this.domElement.addEventListener("touchmove",I,!1),window.addEventListener("keydown",P,!1),window.addEventListener("keyup",E,!1),this.handleResize(),this.update()};OrthographicTrackballControls.prototype=Object.create(EventDispatcher.prototype),OrthographicTrackballControls.prototype.constructor=OrthographicTrackballControls;var PointerLockControls=function(e,t){var r=this;this.domElement=t||document.body,this.isLocked=!1,e.rotation.set(0,0,0);var n=new Object3D;n.add(e);var o=new Object3D;o.position.y=10,o.add(n);var l,c,h=Math.PI/2;function d(e){if(!1!==r.isLocked){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,l=e.movementY||e.mozMovementY||e.webkitMovementY||0;o.rotation.y-=.002*t,n.rotation.x-=.002*l,n.rotation.x=Math.max(-h,Math.min(h,n.rotation.x))}}function f(){document.pointerLockElement===r.domElement?(r.dispatchEvent({type:"lock"}),r.isLocked=!0):(r.dispatchEvent({type:"unlock"}),r.isLocked=!1)}function m(){console.error("PointerLockControls: Unable to use Pointer Lock API")}this.connect=function(){document.addEventListener("mousemove",d,!1),document.addEventListener("pointerlockchange",f,!1),document.addEventListener("pointerlockerror",m,!1)},this.disconnect=function(){document.removeEventListener("mousemove",d,!1),document.removeEventListener("pointerlockchange",f,!1),document.removeEventListener("pointerlockerror",m,!1)},this.dispose=function(){this.disconnect()},this.getObject=function(){return o},this.getDirection=(l=new Vector3(0,0,-1),c=new Euler(0,0,0,"YXZ"),function(e){return c.set(n.rotation.x,o.rotation.y,0),e.copy(l).applyEuler(c),e}),this.lock=function(){this.domElement.requestPointerLock()},this.unlock=function(){document.exitPointerLock()},this.connect()};PointerLockControls.prototype=Object.create(EventDispatcher.prototype),PointerLockControls.prototype.constructor=PointerLockControls;var TrackballControls=function(object,e){var t=this,r={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=object,this.domElement=void 0!==e?e:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new Vector3;var n=new Vector3,o=r.NONE,l=r.NONE,c=new Vector3,h=new Vector2,d=new Vector2,f=new Vector3,m=0,v=new Vector2,y=new Vector2,x=0,w=0,M=new Vector2,S=new Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var A={type:"change"},T={type:"start"},_={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}};var L,C,N,P=function(){var e=new Vector2;return function(r,n){return e.set((r-t.screen.left)/t.screen.width,(n-t.screen.top)/t.screen.height),e}}(),E=function(){var e=new Vector2;return function(r,n){return e.set((r-.5*t.screen.width-t.screen.left)/(.5*t.screen.width),(t.screen.height+2*(t.screen.top-n))/t.screen.width),e}}();function D(e){!1!==t.enabled&&(window.removeEventListener("keydown",D),l=o,o===r.NONE&&(e.keyCode!==t.keys[r.ROTATE]||t.noRotate?e.keyCode!==t.keys[r.ZOOM]||t.noZoom?e.keyCode!==t.keys[r.PAN]||t.noPan||(o=r.PAN):o=r.ZOOM:o=r.ROTATE))}function F(e){!1!==t.enabled&&(o=l,window.addEventListener("keydown",D,!1))}function R(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o===r.NONE&&(o=e.button),o!==r.ROTATE||t.noRotate?o!==r.ZOOM||t.noZoom?o!==r.PAN||t.noPan||(M.copy(P(e.pageX,e.pageY)),S.copy(M)):(v.copy(P(e.pageX,e.pageY)),y.copy(v)):(d.copy(E(e.pageX,e.pageY)),h.copy(d)),document.addEventListener("mousemove",O,!1),document.addEventListener("mouseup",B,!1),t.dispatchEvent(T))}function O(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o!==r.ROTATE||t.noRotate?o!==r.ZOOM||t.noZoom?o!==r.PAN||t.noPan||S.copy(P(e.pageX,e.pageY)):y.copy(P(e.pageX,e.pageY)):(h.copy(d),d.copy(E(e.pageX,e.pageY))))}function B(e){!1!==t.enabled&&(e.preventDefault(),e.stopPropagation(),o=r.NONE,document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",B),t.dispatchEvent(_))}function I(e){if(!1!==t.enabled&&!0!==t.noZoom){switch(e.preventDefault(),e.stopPropagation(),e.deltaMode){case 2:v.y-=.025*e.deltaY;break;case 1:v.y-=.01*e.deltaY;break;default:v.y-=25e-5*e.deltaY}t.dispatchEvent(T),t.dispatchEvent(_)}}function U(e){if(!1!==t.enabled){switch(e.preventDefault(),e.touches.length){case 1:o=r.TOUCH_ROTATE,d.copy(E(e.touches[0].pageX,e.touches[0].pageY)),h.copy(d);break;default:o=r.TOUCH_ZOOM_PAN;var n=e.touches[0].pageX-e.touches[1].pageX,l=e.touches[0].pageY-e.touches[1].pageY;w=x=Math.sqrt(n*n+l*l);var c=(e.touches[0].pageX+e.touches[1].pageX)/2,f=(e.touches[0].pageY+e.touches[1].pageY)/2;M.copy(P(c,f)),S.copy(M)}t.dispatchEvent(T)}}function V(e){if(!1!==t.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:h.copy(d),d.copy(E(e.touches[0].pageX,e.touches[0].pageY));break;default:var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;w=Math.sqrt(r*r+n*n);var o=(e.touches[0].pageX+e.touches[1].pageX)/2,l=(e.touches[0].pageY+e.touches[1].pageY)/2;S.copy(P(o,l))}}function k(e){if(!1!==t.enabled){switch(e.touches.length){case 0:o=r.NONE;break;case 1:o=r.TOUCH_ROTATE,d.copy(E(e.touches[0].pageX,e.touches[0].pageY)),h.copy(d)}t.dispatchEvent(_)}}function G(e){!1!==t.enabled&&e.preventDefault()}this.rotateCamera=function(){var e,r=new Vector3,n=new Quaternion,o=new Vector3,l=new Vector3,v=new Vector3,y=new Vector3;return function(){y.set(d.x-h.x,d.y-h.y,0),(e=y.length())?(c.copy(t.object.position).sub(t.target),o.copy(c).normalize(),l.copy(t.object.up).normalize(),v.crossVectors(l,o).normalize(),l.setLength(d.y-h.y),v.setLength(d.x-h.x),y.copy(l.add(v)),r.crossVectors(y,c).normalize(),e*=t.rotateSpeed,n.setFromAxisAngle(r,e),c.applyQuaternion(n),t.object.up.applyQuaternion(n),f.copy(r),m=e):!t.staticMoving&&m&&(m*=Math.sqrt(1-t.dynamicDampingFactor),c.copy(t.object.position).sub(t.target),n.setFromAxisAngle(f,m),c.applyQuaternion(n),t.object.up.applyQuaternion(n)),h.copy(d)}}(),this.zoomCamera=function(){var e;o===r.TOUCH_ZOOM_PAN?(e=x/w,x=w,c.multiplyScalar(e)):(1!==(e=1+(y.y-v.y)*t.zoomSpeed)&&e>0&&c.multiplyScalar(e),t.staticMoving?v.copy(y):v.y+=(y.y-v.y)*this.dynamicDampingFactor)},this.panCamera=(L=new Vector2,C=new Vector3,N=new Vector3,function(){L.copy(S).sub(M),L.lengthSq()&&(L.multiplyScalar(c.length()*t.panSpeed),N.copy(c).cross(t.object.up).setLength(L.x),N.add(C.copy(t.object.up).setLength(L.y)),t.object.position.add(N),t.target.add(N),t.staticMoving?M.copy(S):M.add(L.subVectors(S,M).multiplyScalar(t.dynamicDampingFactor)))}),this.checkDistances=function(){t.noZoom&&t.noPan||(c.lengthSq()>t.maxDistance*t.maxDistance&&(t.object.position.addVectors(t.target,c.setLength(t.maxDistance)),v.copy(y)),c.lengthSq()<t.minDistance*t.minDistance&&(t.object.position.addVectors(t.target,c.setLength(t.minDistance)),v.copy(y)))},this.update=function(){c.subVectors(t.object.position,t.target),t.noRotate||t.rotateCamera(),t.noZoom||t.zoomCamera(),t.noPan||t.panCamera(),t.object.position.addVectors(t.target,c),t.checkDistances(),t.object.lookAt(t.target),n.distanceToSquared(t.object.position)>1e-6&&(t.dispatchEvent(A),n.copy(t.object.position))},this.reset=function(){o=r.NONE,l=r.NONE,t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.up.copy(t.up0),c.subVectors(t.object.position,t.target),t.object.lookAt(t.target),t.dispatchEvent(A),n.copy(t.object.position)},this.dispose=function(){this.domElement.removeEventListener("contextmenu",G,!1),this.domElement.removeEventListener("mousedown",R,!1),this.domElement.removeEventListener("wheel",I,!1),this.domElement.removeEventListener("touchstart",U,!1),this.domElement.removeEventListener("touchend",k,!1),this.domElement.removeEventListener("touchmove",V,!1),document.removeEventListener("mousemove",O,!1),document.removeEventListener("mouseup",B,!1),window.removeEventListener("keydown",D,!1),window.removeEventListener("keyup",F,!1)},this.domElement.addEventListener("contextmenu",G,!1),this.domElement.addEventListener("mousedown",R,!1),this.domElement.addEventListener("wheel",I,!1),this.domElement.addEventListener("touchstart",U,!1),this.domElement.addEventListener("touchend",k,!1),this.domElement.addEventListener("touchmove",V,!1),window.addEventListener("keydown",D,!1),window.addEventListener("keyup",F,!1),this.handleResize(),this.update()};function PolyhedronGeometry(e,t,r,n){Geometry.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n},this.fromBufferGeometry(new PolyhedronBufferGeometry(e,t,r,n)),this.mergeVertices()}function PolyhedronBufferGeometry(e,t,r,n){BufferGeometry.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n},r=r||1;var o=[],l=[];function c(a,b,e,t){var i,r,n=Math.pow(2,t),o=[];for(i=0;i<=n;i++){o[i]=[];var l=a.clone().lerp(e,i/n),c=b.clone().lerp(e,i/n),d=n-i;for(r=0;r<=d;r++)o[i][r]=0===r&&i===n?l:l.clone().lerp(c,r/d)}for(i=0;i<n;i++)for(r=0;r<2*(n-i)-1;r++){var f=Math.floor(r/2);r%2==0?(h(o[i][f+1]),h(o[i+1][f]),h(o[i][f])):(h(o[i][f+1]),h(o[i+1][f+1]),h(o[i+1][f]))}}function h(e){o.push(e.x,e.y,e.z)}function d(t,r){var n=3*t;r.x=e[n+0],r.y=e[n+1],r.z=e[n+2]}function f(e,t,r,n){n<0&&1===e.x&&(l[t]=e.x-1),0===r.x&&0===r.z&&(l[t]=n/2/Math.PI+.5)}function m(e){return Math.atan2(e.z,-e.x)}function v(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){for(var a=new Vector3,b=new Vector3,r=new Vector3,i=0;i<t.length;i+=3)d(t[i+0],a),d(t[i+1],b),d(t[i+2],r),c(a,b,r,e)}(n=n||0),function(e){for(var t=new Vector3,i=0;i<o.length;i+=3)t.x=o[i+0],t.y=o[i+1],t.z=o[i+2],t.normalize().multiplyScalar(e),o[i+0]=t.x,o[i+1]=t.y,o[i+2]=t.z}(r),function(){for(var e=new Vector3,i=0;i<o.length;i+=3){e.x=o[i+0],e.y=o[i+1],e.z=o[i+2];var u=m(e)/2/Math.PI+.5,t=v(e)/Math.PI+.5;l.push(u,1-t)}(function(){for(var a=new Vector3,b=new Vector3,e=new Vector3,t=new Vector3,r=new Vector2,n=new Vector2,c=new Vector2,i=0,h=0;i<o.length;i+=9,h+=6){a.set(o[i+0],o[i+1],o[i+2]),b.set(o[i+3],o[i+4],o[i+5]),e.set(o[i+6],o[i+7],o[i+8]),r.set(l[h+0],l[h+1]),n.set(l[h+2],l[h+3]),c.set(l[h+4],l[h+5]),t.copy(a).add(b).add(e).divideScalar(3);var d=m(t);f(r,h+0,a,d),f(n,h+2,b,d),f(c,h+4,e,d)}})(),function(){for(var i=0;i<l.length;i+=6){var e=l[i+0],t=l[i+2],r=l[i+4],n=Math.max(e,t,r),o=Math.min(e,t,r);n>.9&&o<.1&&(e<.2&&(l[i+0]+=1),t<.2&&(l[i+2]+=1),r<.2&&(l[i+4]+=1))}}()}(),this.addAttribute("position",new Float32BufferAttribute(o,3)),this.addAttribute("normal",new Float32BufferAttribute(o.slice(),3)),this.addAttribute("uv",new Float32BufferAttribute(l,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}function OctahedronGeometry(e,t){Geometry.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new OctahedronBufferGeometry(e,t)),this.mergeVertices()}function OctahedronBufferGeometry(e,t){PolyhedronBufferGeometry.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function TorusGeometry(e,t,r,n,o){Geometry.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:o},this.fromBufferGeometry(new TorusBufferGeometry(e,t,r,n,o)),this.mergeVertices()}function TorusBufferGeometry(e,t,r,n,o){BufferGeometry.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:o},e=e||1,t=t||.4,r=Math.floor(r)||8,n=Math.floor(n)||6,o=o||2*Math.PI;var l,i,c=[],h=[],d=[],f=[],m=new Vector3,v=new Vector3,y=new Vector3;for(l=0;l<=r;l++)for(i=0;i<=n;i++){var u=i/n*o,x=l/r*Math.PI*2;v.x=(e+t*Math.cos(x))*Math.cos(u),v.y=(e+t*Math.cos(x))*Math.sin(u),v.z=t*Math.sin(x),h.push(v.x,v.y,v.z),m.x=e*Math.cos(u),m.y=e*Math.sin(u),y.subVectors(v,m).normalize(),d.push(y.x,y.y,y.z),f.push(i/n),f.push(l/r)}for(l=1;l<=r;l++)for(i=1;i<=n;i++){var a=(n+1)*l+i-1,b=(n+1)*(l-1)+i-1,w=(n+1)*(l-1)+i,M=(n+1)*l+i;c.push(a,b,M),c.push(b,w,M)}this.setIndex(c),this.addAttribute("position",new Float32BufferAttribute(h,3)),this.addAttribute("normal",new Float32BufferAttribute(d,3)),this.addAttribute("uv",new Float32BufferAttribute(f,2))}TrackballControls.prototype=Object.create(EventDispatcher.prototype),TrackballControls.prototype.constructor=TrackballControls,PolyhedronGeometry.prototype=Object.create(Geometry.prototype),PolyhedronGeometry.prototype.constructor=PolyhedronGeometry,PolyhedronBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PolyhedronBufferGeometry.prototype.constructor=PolyhedronBufferGeometry,OctahedronGeometry.prototype=Object.create(Geometry.prototype),OctahedronGeometry.prototype.constructor=OctahedronGeometry,OctahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),OctahedronBufferGeometry.prototype.constructor=OctahedronBufferGeometry,TorusGeometry.prototype=Object.create(Geometry.prototype),TorusGeometry.prototype.constructor=TorusGeometry,TorusBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusBufferGeometry.prototype.constructor=TorusBufferGeometry;var TransformControls=function(e,t){Object3D.call(this),t=void 0!==t?t:document,this.visible=!1;var r=new TransformControlsGizmo;this.add(r);var n=new TransformControlsPlane;this.add(n);var o=this;H("camera",e),H("object",void 0),H("enabled",!0),H("axis",null),H("mode","translate"),H("translationSnap",null),H("rotationSnap",null),H("space","world"),H("size",1),H("dragging",!1),H("showX",!0),H("showY",!0),H("showZ",!0);var l={type:"change"},c={type:"mouseDown"},h={type:"mouseUp",mode:o.mode},d={type:"objectChange"},f=new Raycaster,m=new Vector3,v=new Quaternion,y={X:new Vector3(1,0,0),Y:new Vector3(0,1,0),Z:new Vector3(0,0,1)},x=new Vector3,w=new Vector3,M=new Vector3,S=new Vector3,A=new Vector3,T=new Vector3,_=0,L=new Vector3,C=new Quaternion,N=new Vector3,P=new Vector3,E=new Quaternion,D=new Quaternion,F=new Vector3,R=new Vector3,O=new Quaternion,B=new Vector3,I=new Vector3,U=new Quaternion,V=new Quaternion,k=new Vector3,G=new Vector3,z=new Vector3,j=new Quaternion,W=new Vector3;function H(e,t){var c=t;Object.defineProperty(o,e,{get:function(){return void 0!==c?c:t},set:function(t){c!==t&&(c=t,n[e]=t,r[e]=t,o.dispatchEvent({type:e+"-changed",value:t}),o.dispatchEvent(l))}}),o[e]=t,n[e]=t,r[e]=t}function X(e){var r=e.changedTouches?e.changedTouches[0]:e,rect=t.getBoundingClientRect();return{x:(r.clientX-rect.left)/rect.width*2-1,y:-(r.clientY-rect.top)/rect.height*2+1,button:e.button}}function Y(e){o.enabled&&o.pointerHover(X(e))}function Q(e){o.enabled&&(document.addEventListener("mousemove",K,!1),o.pointerHover(X(e)),o.pointerDown(X(e)))}function K(e){o.enabled&&o.pointerMove(X(e))}function J(e){o.enabled&&(document.removeEventListener("mousemove",K,!1),o.pointerUp(X(e)))}H("worldPosition",I),H("worldPositionStart",R),H("worldQuaternion",U),H("worldQuaternionStart",O),H("cameraPosition",L),H("cameraQuaternion",C),H("pointStart",x),H("pointEnd",w),H("rotationAxis",S),H("rotationAngle",_),H("eye",G),t.addEventListener("mousedown",Q,!1),t.addEventListener("touchstart",Q,!1),t.addEventListener("mousemove",Y,!1),t.addEventListener("touchmove",Y,!1),t.addEventListener("touchmove",K,!1),document.addEventListener("mouseup",J,!1),t.addEventListener("touchend",J,!1),t.addEventListener("touchcancel",J,!1),t.addEventListener("touchleave",J,!1),this.dispose=function(){t.removeEventListener("mousedown",Q),t.removeEventListener("touchstart",Q),t.removeEventListener("mousemove",Y),t.removeEventListener("touchmove",Y),t.removeEventListener("touchmove",K),document.removeEventListener("mouseup",J),t.removeEventListener("touchend",J),t.removeEventListener("touchcancel",J),t.removeEventListener("touchleave",J)},this.attach=function(object){this.object=object,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(P,E,F),this.object.matrixWorld.decompose(I,U,k),D.copy(E).inverse(),V.copy(U).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(L,C,N),this.camera instanceof PerspectiveCamera?G.copy(L).sub(I).normalize():this.camera instanceof OrthographicCamera&&G.copy(L).normalize(),Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){f.setFromCamera(e,this.camera);var t=f.intersectObjects(r.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(!(void 0===this.object||!0===this.dragging||void 0!==e.button&&0!==e.button||0!==e.button&&void 0!==e.button||null===this.axis)){f.setFromCamera(e,this.camera);var t=f.intersectObjects([n],!0)[0]||!1;if(t){var r=this.space;if("scale"===this.mode?r="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(r="world"),"local"===r&&"rotate"===this.mode){var o=this.rotationSnap;"X"===this.axis&&o&&(this.object.rotation.x=Math.round(this.object.rotation.x/o)*o),"Y"===this.axis&&o&&(this.object.rotation.y=Math.round(this.object.rotation.y/o)*o),"Z"===this.axis&&o&&(this.object.rotation.z=Math.round(this.object.rotation.z/o)*o)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),z.copy(this.object.position),j.copy(this.object.quaternion),W.copy(this.object.scale),this.object.matrixWorld.decompose(R,O,B),x.copy(t.point).sub(R)}this.dragging=!0,c.mode=this.mode,this.dispatchEvent(c)}},this.pointerMove=function(e){var t=this.axis,r=this.mode,object=this.object,o=this.space;if("scale"===r?o="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(o="world"),void 0!==object&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){f.setFromCamera(e,this.camera);var c=f.intersectObjects([n],!0)[0]||!1;if(!1!==c){if(w.copy(c.point).sub(R),"translate"===r)M.copy(w).sub(x),"local"===o&&"XYZ"!==t&&M.applyQuaternion(V),-1===t.indexOf("X")&&(M.x=0),-1===t.indexOf("Y")&&(M.y=0),-1===t.indexOf("Z")&&(M.z=0),"local"===o&&"XYZ"!==t?M.applyQuaternion(j).divide(F):M.applyQuaternion(D).divide(F),object.position.copy(M).add(z),this.translationSnap&&("local"===o&&(object.position.applyQuaternion(v.copy(j).inverse()),-1!==t.search("X")&&(object.position.x=Math.round(object.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(object.position.y=Math.round(object.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(object.position.z=Math.round(object.position.z/this.translationSnap)*this.translationSnap),object.position.applyQuaternion(j)),"world"===o&&(object.parent&&object.position.add(m.setFromMatrixPosition(object.parent.matrixWorld)),-1!==t.search("X")&&(object.position.x=Math.round(object.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(object.position.y=Math.round(object.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(object.position.z=Math.round(object.position.z/this.translationSnap)*this.translationSnap),object.parent&&object.position.sub(m.setFromMatrixPosition(object.parent.matrixWorld))));else if("scale"===r){if(-1!==t.search("XYZ")){var h=w.length()/x.length();w.dot(x)<0&&(h*=-1),m.set(h,h,h)}else m.copy(w).divide(x),-1===t.search("X")&&(m.x=1),-1===t.search("Y")&&(m.y=1),-1===t.search("Z")&&(m.z=1);object.scale.copy(W).multiply(m)}else if("rotate"===r){M.copy(w).sub(x);var L=20/I.distanceTo(m.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(S.copy(G),_=w.angleTo(x),A.copy(x).normalize(),T.copy(w).normalize(),_*=T.cross(A).dot(G)<0?1:-1):"XYZE"===t?(S.copy(M).cross(G).normalize(),_=M.dot(m.copy(S).cross(this.eye))*L):"X"!==t&&"Y"!==t&&"Z"!==t||(S.copy(y[t]),m.copy(y[t]),"local"===o&&m.applyQuaternion(U),_=M.dot(m.cross(G).normalize())*L),this.rotationSnap&&(_=Math.round(_/this.rotationSnap)*this.rotationSnap),this.rotationAngle=_,"local"===o&&"E"!==t&&"XYZE"!==t?(object.quaternion.copy(j),object.quaternion.multiply(v.setFromAxisAngle(S,_)).normalize()):(S.applyQuaternion(D),object.quaternion.copy(v.setFromAxisAngle(S,_)),object.quaternion.multiply(j).normalize())}this.dispatchEvent(l),this.dispatchEvent(d)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(h.mode=this.mode,this.dispatchEvent(h)),this.dragging=!1,void 0===e.button&&(this.axis=null))},this.getMode=function(){return o.mode},this.setMode=function(e){o.mode=e},this.setTranslationSnap=function(e){o.translationSnap=e},this.setRotationSnap=function(e){o.rotationSnap=e},this.setSize=function(e){o.size=e},this.setSpace=function(e){o.space=e},this.update=function(){console.warn("TransformControls: update function has been depricated.")}};TransformControls.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:TransformControls,isTransformControls:!0});var TransformControlsGizmo=function(){Object3D.call(this),this.type="TransformControlsGizmo";var e=new MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:DoubleSide,fog:!1}),t=new LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),r=e.clone();r.opacity=.15;var n=e.clone();n.opacity=.33;var o=e.clone();o.color.set(16711680);var l=e.clone();l.color.set(65280);var c=e.clone();c.color.set(255);var h=e.clone();h.opacity=.25;var d=h.clone();d.color.set(16776960);var f=h.clone();f.color.set(65535);var m=h.clone();m.color.set(16711935),e.clone().color.set(16776960);var v=t.clone();v.color.set(16711680);var y=t.clone();y.color.set(65280);var x=t.clone();x.color.set(255);var w=t.clone();w.color.set(65535);var M=t.clone();M.color.set(16711935);var S=t.clone();S.color.set(16776960);var A=t.clone();A.color.set(7895160);var T=S.clone();T.opacity=.25;var _=new CylinderBufferGeometry(0,.05,.2,12,1,!1),L=new BoxBufferGeometry(.125,.125,.125),C=new BufferGeometry;C.addAttribute("position",new Float32BufferAttribute([0,0,0,1,0,0],3));var N=function(e,t){for(var r=new BufferGeometry,n=[],i=0;i<=64*t;++i)n.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return r.addAttribute("position",new Float32BufferAttribute(n,3)),r},P={X:[[new Mesh(_,o),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Mesh(_,o),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Line(C,v)]],Y:[[new Mesh(_,l),[0,1,0],null,null,"fwd"],[new Mesh(_,l),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Line(C,y),null,[0,0,Math.PI/2]]],Z:[[new Mesh(_,c),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Mesh(_,c),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Line(C,x),null,[0,-Math.PI/2,0]]],XYZ:[[new Mesh(new OctahedronBufferGeometry(.1,0),h),[0,0,0],[0,0,0]]],XY:[[new Mesh(new PlaneBufferGeometry(.295,.295),d),[.15,.15,0]],[new Line(C,S),[.18,.3,0],null,[.125,1,1]],[new Line(C,S),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Mesh(new PlaneBufferGeometry(.295,.295),f),[0,.15,.15],[0,Math.PI/2,0]],[new Line(C,w),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Line(C,w),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Mesh(new PlaneBufferGeometry(.295,.295),m),[.15,0,.15],[-Math.PI/2,0,0]],[new Line(C,M),[.18,0,.3],null,[.125,1,1]],[new Line(C,M),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},E={X:[[new Mesh(new CylinderBufferGeometry(.2,0,1,4,1,!1),r),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Mesh(new CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,.6,0]]],Z:[[new Mesh(new CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Mesh(new OctahedronBufferGeometry(.2,0),r)]],XY:[[new Mesh(new PlaneBufferGeometry(.4,.4),r),[.2,.2,0]]],YZ:[[new Mesh(new PlaneBufferGeometry(.4,.4),r),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Mesh(new PlaneBufferGeometry(.4,.4),r),[.2,0,.2],[-Math.PI/2,0,0]]]},D={START:[[new Mesh(new OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],END:[[new Mesh(new OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new Line(function(e,t){var r=new BufferGeometry;return r.addAttribute("position",new Float32BufferAttribute([0,0,0,1,1,1],3)),r}(),n),null,null,null,"helper"]],X:[[new Line(C,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Line(C,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Line(C,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},F={X:[[new Line(N(1,.5),v)],[new Mesh(new OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[1,3,1]]],Y:[[new Line(N(1,.5),y),null,[0,0,-Math.PI/2]],[new Mesh(new OctahedronBufferGeometry(.04,0),l),[0,0,.99],null,[3,1,1]]],Z:[[new Line(N(1,.5),x),null,[0,Math.PI/2,0]],[new Mesh(new OctahedronBufferGeometry(.04,0),c),[.99,0,0],null,[1,3,1]]],E:[[new Line(N(1.25,1),T),null,[0,Math.PI/2,0]],[new Mesh(new CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Mesh(new CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Mesh(new CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Mesh(new CylinderBufferGeometry(.03,0,.15,4,1,!1),T),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Line(N(1,1),A),null,[0,Math.PI/2,0]]]},R={AXIS:[[new Line(C,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},O={X:[[new Mesh(new TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Mesh(new TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Mesh(new TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Mesh(new TorusBufferGeometry(1.25,.1,2,24),r)]],XYZE:[[new Mesh(new SphereBufferGeometry(.7,10,8),r)]]},B={X:[[new Mesh(L,o),[.8,0,0],[0,0,-Math.PI/2]],[new Line(C,v),null,null,[.8,1,1]]],Y:[[new Mesh(L,l),[0,.8,0]],[new Line(C,y),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Mesh(L,c),[0,0,.8],[Math.PI/2,0,0]],[new Line(C,x),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Mesh(L,d),[.85,.85,0],null,[2,2,.2]],[new Line(C,S),[.855,.98,0],null,[.125,1,1]],[new Line(C,S),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Mesh(L,f),[0,.85,.85],null,[.2,2,2]],[new Line(C,w),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Line(C,w),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Mesh(L,m),[.85,0,.85],null,[2,.2,2]],[new Line(C,M),[.855,0,.98],null,[.125,1,1]],[new Line(C,M),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Mesh(new BoxBufferGeometry(.125,.125,.125),h),[1.1,0,0]]],XYZY:[[new Mesh(new BoxBufferGeometry(.125,.125,.125),h),[0,1.1,0]]],XYZZ:[[new Mesh(new BoxBufferGeometry(.125,.125,.125),h),[0,0,1.1]]]},I={X:[[new Mesh(new CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Mesh(new CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,.5,0]]],Z:[[new Mesh(new CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Mesh(L,r),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Mesh(L,r),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Mesh(L,r),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Mesh(new BoxBufferGeometry(.2,.2,.2),r),[1.1,0,0]]],XYZY:[[new Mesh(new BoxBufferGeometry(.2,.2,.2),r),[0,1.1,0]]],XYZZ:[[new Mesh(new BoxBufferGeometry(.2,.2,.2),r),[0,0,1.1]]]},U={X:[[new Line(C,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Line(C,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Line(C,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},V=function(e){var t=new Object3D;for(var r in e)for(var i=e[r].length;i--;){var object=e[r][i][0].clone(),n=e[r][i][1],o=e[r][i][2],l=e[r][i][3],c=e[r][i][4];object.name=r,object.tag=c,n&&object.position.set(n[0],n[1],n[2]),o&&object.rotation.set(o[0],o[1],o[2]),l&&object.scale.set(l[0],l[1],l[2]),object.updateMatrix();var h=object.geometry.clone();h.applyMatrix(object.matrix),object.geometry=h,object.position.set(0,0,0),object.rotation.set(0,0,0),object.scale.set(1,1,1),t.add(object)}return t},k=new Vector3(0,0,0),G=new Euler,z=new Vector3(0,1,0),j=new Vector3(0,0,0),W=new Matrix4,H=new Quaternion,X=new Quaternion,Y=new Quaternion,Q=new Vector3(1,0,0),K=new Vector3(0,1,0),J=new Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=V(P)),this.add(this.gizmo.rotate=V(F)),this.add(this.gizmo.scale=V(B)),this.add(this.picker.translate=V(E)),this.add(this.picker.rotate=V(O)),this.add(this.picker.scale=V(I)),this.add(this.helper.translate=V(D)),this.add(this.helper.rotate=V(R)),this.add(this.helper.scale=V(U)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:Y;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var r=[];r=(r=(r=r.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var i=0;i<r.length;i++){var n=r[i];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);var o=this.worldPosition.distanceTo(this.cameraPosition);if(n.scale.set(1,1,1).multiplyScalar(o*this.size/7),"helper"!==n.tag){if(n.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){"X"!==n.name&&"XYZX"!==n.name||Math.abs(z.copy(Q).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Y"!==n.name&&"XYZY"!==n.name||Math.abs(z.copy(K).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Z"!==n.name&&"XYZZ"!==n.name||Math.abs(z.copy(J).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XY"===n.name&&Math.abs(z.copy(J).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"YZ"===n.name&&Math.abs(z.copy(Q).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XZ"===n.name&&Math.abs(z.copy(K).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),-1!==n.name.search("X")&&(z.copy(Q).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===n.tag?n.visible=!1:n.scale.x*=-1:"bwd"===n.tag&&(n.visible=!1)),-1!==n.name.search("Y")&&(z.copy(K).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===n.tag?n.visible=!1:n.scale.y*=-1:"bwd"===n.tag&&(n.visible=!1)),-1!==n.name.search("Z")&&(z.copy(J).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===n.tag?n.visible=!1:n.scale.z*=-1:"bwd"===n.tag&&(n.visible=!1))}else"rotate"===this.mode&&(X.copy(t),z.copy(this.eye).applyQuaternion(H.copy(t).inverse()),-1!==n.name.search("E")&&n.quaternion.setFromRotationMatrix(W.lookAt(this.eye,j,K)),"X"===n.name&&(H.setFromAxisAngle(Q,Math.atan2(-z.y,z.z)),H.multiplyQuaternions(X,H),n.quaternion.copy(H)),"Y"===n.name&&(H.setFromAxisAngle(K,Math.atan2(z.x,z.z)),H.multiplyQuaternions(X,H),n.quaternion.copy(H)),"Z"===n.name&&(H.setFromAxisAngle(J,Math.atan2(z.y,z.x)),H.multiplyQuaternions(X,H),n.quaternion.copy(H)));n.visible=n.visible&&(-1===n.name.indexOf("X")||this.showX),n.visible=n.visible&&(-1===n.name.indexOf("Y")||this.showY),n.visible=n.visible&&(-1===n.name.indexOf("Z")||this.showZ),n.visible=n.visible&&(-1===n.name.indexOf("E")||this.showX&&this.showY&&this.showZ),n.material._opacity=n.material._opacity||n.material.opacity,n.material._color=n.material._color||n.material.color.clone(),n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled?this.axis&&(n.name===this.axis?(n.material.opacity=1,n.material.color.lerp(new Color(1,1,1),.5)):this.axis.split("").some((function(a){return n.name===a}))?(n.material.opacity=1,n.material.color.lerp(new Color(1,1,1),.5)):(n.material.opacity*=.25,n.material.color.lerp(new Color(1,1,1),.5))):(n.material.opacity*=.5,n.material.color.lerp(new Color(1,1,1),.5))}else n.visible=!1,"AXIS"===n.name?(n.position.copy(this.worldPositionStart),n.visible=!!this.axis,"X"===this.axis&&(H.setFromEuler(G.set(0,0,0)),n.quaternion.copy(t).multiply(H),Math.abs(z.copy(Q).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),"Y"===this.axis&&(H.setFromEuler(G.set(0,0,Math.PI/2)),n.quaternion.copy(t).multiply(H),Math.abs(z.copy(K).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),"Z"===this.axis&&(H.setFromEuler(G.set(0,Math.PI/2,0)),n.quaternion.copy(t).multiply(H),Math.abs(z.copy(J).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),"XYZE"===this.axis&&(H.setFromEuler(G.set(0,Math.PI/2,0)),z.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(W.lookAt(j,z,K)),n.quaternion.multiply(H),n.visible=this.dragging),"E"===this.axis&&(n.visible=!1)):"START"===n.name?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):"END"===n.name?(n.position.copy(this.worldPosition),n.visible=this.dragging):"DELTA"===n.name?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),k.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),k.applyQuaternion(this.worldQuaternionStart.clone().inverse()),n.scale.copy(k),n.visible=this.dragging):(n.quaternion.copy(t),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=-1!==this.axis.search(n.name)))}Object3D.prototype.updateMatrixWorld.call(this)}};TransformControlsGizmo.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:TransformControlsGizmo,isTransformControlsGizmo:!0});var TransformControlsPlane=function(){Mesh.call(this,new PlaneBufferGeometry(1e5,1e5,2,2),new MeshBasicMaterial({visible:!1,wireframe:!0,side:DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var e=new Vector3(1,0,0),t=new Vector3(0,1,0),r=new Vector3(0,0,1),n=new Vector3,o=new Vector3,l=new Vector3,c=new Matrix4,h=new Quaternion;this.updateMatrixWorld=function(){var d=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(d="local"),e.set(1,0,0).applyQuaternion("local"===d?this.worldQuaternion:h),t.set(0,1,0).applyQuaternion("local"===d?this.worldQuaternion:h),r.set(0,0,1).applyQuaternion("local"===d?this.worldQuaternion:h),l.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":l.copy(this.eye).cross(e),o.copy(e).cross(l);break;case"Y":l.copy(this.eye).cross(t),o.copy(t).cross(l);break;case"Z":l.copy(this.eye).cross(r),o.copy(r).cross(l);break;case"XY":o.copy(r);break;case"YZ":o.copy(e);break;case"XZ":l.copy(r),o.copy(t);break;case"XYZ":case"E":o.set(0,0,0)}break;case"rotate":default:o.set(0,0,0)}0===o.length()?this.quaternion.copy(this.cameraQuaternion):(c.lookAt(n.set(0,0,0),o,l),this.quaternion.setFromRotationMatrix(c)),Object3D.prototype.updateMatrixWorld.call(this)}},startP,startEnd;function Line3(e,t){this.start=void 0!==e?e:new Vector3,this.end=void 0!==t?t:new Vector3}TransformControlsPlane.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:TransformControlsPlane,isTransformControlsPlane:!0}),Object.assign(Line3.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(line){return this.start.copy(line.start),this.end.copy(line.end),this},getCenter:function(e){return void 0===e&&(console.warn("Line3: .getCenter() target is now required"),e=new Vector3),e.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return void 0===e&&(console.warn("Line3: .delta() target is now required"),e=new Vector3),e.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){return void 0===t&&(console.warn("Line3: .at() target is now required"),t=new Vector3),this.delta(t).multiplyScalar(e).add(this.start)},closestPointToPointParameter:(startP=new Vector3,startEnd=new Vector3,function(e,t){startP.subVectors(e,this.start),startEnd.subVectors(this.end,this.start);var r=startEnd.dot(startEnd),n=startEnd.dot(startP)/r;return t&&(n=_Math.clamp(n,0,1)),n}),closestPointToPoint:function(e,t,r){var n=this.closestPointToPointParameter(e,t);return void 0===r&&(console.warn("Line3: .closestPointToPoint() target is now required"),r=new Vector3),this.delta(r).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(line){return line.start.equals(this.start)&&line.end.equals(this.end)}});var Visible=0,Deleted=1,triangle;function QuickHull(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new VertexList,this.unassigned=new VertexList,this.vertices=[]}function Face(){this.normal=new Vector3,this.midpoint=new Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=Visible,this.edge=null}function HalfEdge(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}function VertexNode(e){this.point=e,this.prev=null,this.next=null,this.face=null}function VertexList(){this.head=null,this.tail=null}function ConvexGeometry(e){Geometry.call(this),this.fromBufferGeometry(new ConvexBufferGeometry(e)),this.mergeVertices()}function ConvexBufferGeometry(e){BufferGeometry.call(this);var t=[],r=[];void 0===QuickHull&&console.error("ConvexBufferGeometry: ConvexBufferGeometry relies on QuickHull");for(var n=(new QuickHull).setFromPoints(e).faces,i=0;i<n.length;i++){var o=n[i],l=o.edge;do{var c=l.head().point;t.push(c.x,c.y,c.z),r.push(o.normal.x,o.normal.y,o.normal.z),l=l.next}while(l!==o.edge)}this.addAttribute("position",new Float32BufferAttribute(t,3)),this.addAttribute("normal",new Float32BufferAttribute(r,3))}Object.assign(QuickHull.prototype,{setFromPoints:function(e){!0!==Array.isArray(e)&&console.error("QuickHull: Points parameter is not an array."),e.length<4&&console.error("QuickHull: The algorithm needs at least four points."),this.makeEmpty();for(var i=0,t=e.length;i<t;i++)this.vertices.push(new VertexNode(e[i]));return this.compute(),this},setFromObject:function(object){var e=[];return object.updateMatrixWorld(!0),object.traverse((function(t){var i,r,n,o=t.geometry;if(void 0!==o)if(o.isGeometry){var l=o.vertices;for(i=0,r=l.length;i<r;i++)(n=l[i].clone()).applyMatrix4(t.matrixWorld),e.push(n)}else if(o.isBufferGeometry){var c=o.attributes.position;if(void 0!==c)for(i=0,r=c.count;i<r;i++)(n=new Vector3).fromBufferAttribute(c,i).applyMatrix4(t.matrixWorld),e.push(n)}})),this.setFromPoints(e)},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this},removeVertexFromFace:function(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this},removeAllVerticesFromFace:function(e){if(null!==e.outside){for(var t=e.outside,r=e.outside;null!==r.next&&r.next.face===e;)r=r.next;return this.assigned.removeSubList(t,r),t.prev=r.next=null,e.outside=null,t}},deleteFaceVertices:function(e,t){var r=this.removeAllVerticesFromFace(e);if(void 0!==r)if(void 0===t)this.unassigned.appendChain(r);else{var n=r;do{var o=n.next;t.distanceToPoint(n.point)>this.tolerance?this.addVertexToFace(n,t):this.unassigned.append(n),n=o}while(null!==n)}return this},resolveUnassignedPoints:function(e){if(!1===this.unassigned.isEmpty()){var t=this.unassigned.first();do{for(var r=t.next,n=this.tolerance,o=null,i=0;i<e.length;i++){var l=e[i];if(l.mark===Visible){var c=l.distanceToPoint(t.point);if(c>n&&(n=c,o=l),n>1e3*this.tolerance)break}}null!==o&&this.addVertexToFace(t,o),t=r}while(null!==t)}return this},computeExtremes:function(){var i,e,t,r=new Vector3,n=new Vector3,o=[],l=[];for(i=0;i<3;i++)o[i]=l[i]=this.vertices[0];for(r.copy(this.vertices[0].point),n.copy(this.vertices[0].point),i=0,e=this.vertices.length;i<e;i++){var c=this.vertices[i],h=c.point;for(t=0;t<3;t++)h.getComponent(t)<r.getComponent(t)&&(r.setComponent(t,h.getComponent(t)),o[t]=c);for(t=0;t<3;t++)h.getComponent(t)>n.getComponent(t)&&(n.setComponent(t,h.getComponent(t)),l[t]=c)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(r.x),Math.abs(n.x))+Math.max(Math.abs(r.y),Math.abs(n.y))+Math.max(Math.abs(r.z),Math.abs(n.z))),{min:o,max:l}},computeInitialHull:function(){var e,t,r;return function(){void 0===e&&(e=new Line3,t=new Plane,r=new Vector3);var n,o,l,c,h,i,d,f,m,v=this.vertices,y=this.computeExtremes(),x=y.min,w=y.max,M=0,S=0;for(i=0;i<3;i++)(m=w[i].point.getComponent(i)-x[i].point.getComponent(i))>M&&(M=m,S=i);for(o=x[S],l=w[S],M=0,e.set(o.point,l.point),i=0,d=this.vertices.length;i<d;i++)(n=v[i])!==o&&n!==l&&(e.closestPointToPoint(n.point,!0,r),(m=r.distanceToSquared(n.point))>M&&(M=m,c=n));for(M=-1,t.setFromCoplanarPoints(o.point,l.point,c.point),i=0,d=this.vertices.length;i<d;i++)(n=v[i])!==o&&n!==l&&n!==c&&(m=Math.abs(t.distanceToPoint(n.point)))>M&&(M=m,h=n);var A=[];if(t.distanceToPoint(h.point)<0)for(A.push(Face.create(o,l,c),Face.create(h,l,o),Face.create(h,c,l),Face.create(h,o,c)),i=0;i<3;i++)f=(i+1)%3,A[i+1].getEdge(2).setTwin(A[0].getEdge(f)),A[i+1].getEdge(1).setTwin(A[f+1].getEdge(0));else for(A.push(Face.create(o,c,l),Face.create(h,o,l),Face.create(h,l,c),Face.create(h,c,o)),i=0;i<3;i++)f=(i+1)%3,A[i+1].getEdge(2).setTwin(A[0].getEdge((3-i)%3)),A[i+1].getEdge(0).setTwin(A[f+1].getEdge(1));for(i=0;i<4;i++)this.faces.push(A[i]);for(i=0,d=v.length;i<d;i++)if((n=v[i])!==o&&n!==l&&n!==c&&n!==h){M=this.tolerance;var T=null;for(f=0;f<4;f++)(m=this.faces[f].distanceToPoint(n.point))>M&&(M=m,T=this.faces[f]);null!==T&&this.addVertexToFace(n,T)}return this}}(),reindexFaces:function(){for(var e=[],i=0;i<this.faces.length;i++){var t=this.faces[i];t.mark===Visible&&e.push(t)}return this.faces=e,this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var e,t=0,r=this.assigned.first().face,n=r.outside;do{var o=r.distanceToPoint(n.point);o>t&&(t=o,e=n),n=n.next}while(null!==n&&n.face===r);return e}},computeHorizon:function(e,t,r,n){var o;this.deleteFaceVertices(r),r.mark=Deleted,o=null===t?t=r.getEdge(0):t.next;do{var l=o.twin,c=l.face;c.mark===Visible&&(c.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,l,c,n):n.push(o)),o=o.next}while(o!==t);return this},addAdjoiningFace:function(e,t){var r=Face.create(e,t.tail(),t.head());return this.faces.push(r),r.getEdge(-1).setTwin(t.twin),r.getEdge(0)},addNewFaces:function(e,t){this.newFaces=[];for(var r=null,n=null,i=0;i<t.length;i++){var o=t[i],l=this.addAdjoiningFace(e,o);null===r?r=l:l.next.setTwin(n),this.newFaces.push(l.face),n=l}return r.next.setTwin(n),this},addVertexToHull:function(e){var t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}),Object.assign(Face,{create:function(a,b,e){var t=new Face,r=new HalfEdge(a,t),n=new HalfEdge(b,t),o=new HalfEdge(e,t);return r.next=o.prev=n,n.next=r.prev=o,o.next=n.prev=r,t.edge=r,t.compute()}}),Object.assign(Face.prototype,{getEdge:function(i){for(var e=this.edge;i>0;)e=e.next,i--;for(;i<0;)e=e.prev,i++;return e},compute:function(){void 0===triangle&&(triangle=new Triangle);var a=this.edge.tail(),b=this.edge.head(),e=this.edge.next.head();return triangle.set(a.point,b.point,e.point),triangle.getNormal(this.normal),triangle.getMidpoint(this.midpoint),this.area=triangle.getArea(),this.constant=this.normal.dot(this.midpoint),this},distanceToPoint:function(e){return this.normal.dot(e)-this.constant}}),Object.assign(HalfEdge.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var head=this.head(),e=this.tail();return null!==e?e.point.distanceTo(head.point):-1},lengthSquared:function(){var head=this.head(),e=this.tail();return null!==e?e.point.distanceToSquared(head.point):-1},setTwin:function(e){return this.twin=e,e.twin=this,this}}),Object.assign(VertexList.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this},insertAfter:function(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this},append:function(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this},appendChain:function(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this},remove:function(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this},removeSubList:function(a,b){return null===a.prev?this.head=b.next:a.prev.next=b.next,null===b.next?this.tail=a.prev:b.next.prev=a.prev,this},isEmpty:function(){return null===this.head}}),ConvexGeometry.prototype=Object.create(Geometry.prototype),ConvexGeometry.prototype.constructor=ConvexGeometry,ConvexBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ConvexBufferGeometry.prototype.constructor=ConvexBufferGeometry;var ConvexObjectBreaker=function(e,t){this.minSizeForBreak=e||1.4,this.smallDelta=t||1e-4,this.tempLine1=new Line3,this.tempPlane1=new Plane,this.tempPlane2=new Plane,this.tempPlane_Cut=new Plane,this.tempCM1=new Vector3,this.tempCM2=new Vector3,this.tempVector3=new Vector3,this.tempVector3_2=new Vector3,this.tempVector3_3=new Vector3,this.tempVector3_P0=new Vector3,this.tempVector3_P1=new Vector3,this.tempVector3_P2=new Vector3,this.tempVector3_N0=new Vector3,this.tempVector3_N1=new Vector3,this.tempVector3_AB=new Vector3,this.tempVector3_CB=new Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var i=0;i<900;i++)this.segments[i]=!1};function Curve(){this.type="Curve",this.arcLengthDivisions=200}function GrannyKnot(){Curve.call(this)}function HeartCurve(e){Curve.call(this),this.scale=void 0===e?5:e}function VivianiCurve(e){Curve.call(this),this.scale=void 0===e?70:e}function KnotCurve(){Curve.call(this)}function HelixCurve(){Curve.call(this)}function TrefoilKnot(e){Curve.call(this),this.scale=void 0===e?10:e}function TorusKnot(e){Curve.call(this),this.scale=void 0===e?10:e}function CinquefoilKnot(e){Curve.call(this),this.scale=void 0===e?10:e}function TrefoilPolynomialKnot(e){Curve.call(this),this.scale=void 0===e?10:e}ConvexObjectBreaker.prototype={constructor:ConvexObjectBreaker,prepareBreakableObject:function(object,e,t,r,n){object.geometry.isBufferGeometry||console.error("ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");var o=object.userData;o.mass=e,o.velocity=t.clone(),o.angularVelocity=r.clone(),o.breakable=n},subdivideByImpact:function(object,e,t,r,n){var o=[],l=this.tempPlane1,c=this.tempPlane2;this.tempVector3.addVectors(e,t),l.setFromCoplanarPoints(e,object.position,this.tempVector3);var h=n+r,d=this;return function n(f,m,v,y){if(Math.random()<.05*y||y>h)o.push(f);else{var x=Math.PI;0===y?(c.normal.copy(l.normal),c.constant=l.constant):y<=r?(x=(v-m)*(.2+.6*Math.random())+m,d.tempVector3_2.copy(object.position).sub(e).applyAxisAngle(t,x).add(e),c.setFromCoplanarPoints(e,d.tempVector3,d.tempVector3_2)):(x=(.5*(1&y)+.2*(2-Math.random()))*Math.PI,d.tempVector3_2.copy(e).sub(f.position).applyAxisAngle(t,x).add(f.position),d.tempVector3_3.copy(t).add(f.position),c.setFromCoplanarPoints(f.position,d.tempVector3_3,d.tempVector3_2)),d.cutByPlane(f,c,d.tempResultObjects);var w=d.tempResultObjects.object1,M=d.tempResultObjects.object2;w&&n(w,m,x,y+1),M&&n(M,x,v,y+1)}}(object,0,2*Math.PI,0),o},cutByPlane:function(object,e,output){var t=object.geometry,r=t.attributes.position.array,n=t.attributes.normal.array,o=r.length/3,l=o/3,c=t.getIndex();function h(e,t){var r=3*e+t;return c?c[r]:r}c&&(l=(c=c.array).length/3);for(var d=[],f=[],m=this.smallDelta,v=o*o,i=0;i<v;i++)this.segments[i]=!1;var y=this.tempVector3_P0,x=this.tempVector3_P1,w=this.tempVector3_N0,M=this.tempVector3_N1;for(i=0;i<l-1;i++){var S=h(i,0),A=h(i,1),T=h(i,2);w.set(n[S],n[S]+1,n[S]+2);for(var _=i+1;_<l;_++){var L=h(_,0),C=h(_,1),N=h(_,2);M.set(n[L],n[L]+1,n[L]+2),1-w.dot(M)<m&&(S===L||S===C||S===N?A===L||A===C||A===N?(this.segments[S*o+A]=!0,this.segments[A*o+S]=!0):(this.segments[T*o+S]=!0,this.segments[S*o+T]=!0):A!==L&&A!==C&&A!==N||(this.segments[T*o+A]=!0,this.segments[A*o+T]=!0))}}var P=this.tempPlane_Cut;object.updateMatrix(),ConvexObjectBreaker.transformPlaneToLocalSpace(e,object.matrix,P);for(i=0;i<l;i++)for(var E=h(i,0),D=h(i,1),F=h(i,2),R=0;R<3;R++){var O=0===R?E:1===R?D:F,B=0===R?D:1===R?F:E;if(!this.segments[O*o+B]){this.segments[O*o+B]=!0,this.segments[B*o+O]=!0,y.set(r[3*O],r[3*O+1],r[3*O+2]),x.set(r[3*B],r[3*B+1],r[3*B+2]);var I=0;(U=P.distanceToPoint(y))>m?(I=2,f.push(y.clone())):U<-m?(I=1,d.push(y.clone())):(I=3,d.push(y.clone()),f.push(y.clone()));var U,V=0;if((U=P.distanceToPoint(x))>m?(V=2,f.push(x.clone())):U<-m?(V=1,d.push(x.clone())):(V=3,d.push(x.clone()),f.push(x.clone())),1===I&&2===V||2===I&&1===V){this.tempLine1.start.copy(y),this.tempLine1.end.copy(x);var k=new Vector3;if(void 0===(k=P.intersectLine(this.tempLine1,k)))return console.error("Internal error: segment does not intersect plane."),output.segmentedObject1=null,output.segmentedObject2=null,0;d.push(k),f.push(k.clone())}}}var G=.5*object.userData.mass;this.tempCM1.set(0,0,0);var z=0,j=d.length;if(j>0){for(i=0;i<j;i++)this.tempCM1.add(d[i]);this.tempCM1.divideScalar(j);for(i=0;i<j;i++){(p=d[i]).sub(this.tempCM1),z=Math.max(z,p.x,p.y,p.z)}this.tempCM1.add(object.position)}this.tempCM2.set(0,0,0);var W=0,H=f.length;if(H>0){for(i=0;i<H;i++)this.tempCM2.add(f[i]);this.tempCM2.divideScalar(H);for(i=0;i<H;i++){var p;(p=f[i]).sub(this.tempCM2),W=Math.max(W,p.x,p.y,p.z)}this.tempCM2.add(object.position)}var X=null,Y=null,Q=0;return j>4&&((X=new Mesh(new ConvexBufferGeometry(d),object.material)).position.copy(this.tempCM1),X.quaternion.copy(object.quaternion),this.prepareBreakableObject(X,G,object.userData.velocity,object.userData.angularVelocity,2*z>this.minSizeForBreak),Q++),H>4&&((Y=new Mesh(new ConvexBufferGeometry(f),object.material)).position.copy(this.tempCM2),Y.quaternion.copy(object.quaternion),this.prepareBreakableObject(Y,G,object.userData.velocity,object.userData.angularVelocity,2*W>this.minSizeForBreak),Q++),output.object1=X,output.object2=Y,Q}},ConvexObjectBreaker.transformFreeVector=function(e,t){var r=e.x,n=e.y,o=e.z,l=t.elements;return e.x=l[0]*r+l[4]*n+l[8]*o,e.y=l[1]*r+l[5]*n+l[9]*o,e.z=l[2]*r+l[6]*n+l[10]*o,e},ConvexObjectBreaker.transformFreeVectorInverse=function(e,t){var r=e.x,n=e.y,o=e.z,l=t.elements;return e.x=l[0]*r+l[1]*n+l[2]*o,e.y=l[4]*r+l[5]*n+l[6]*o,e.z=l[8]*r+l[9]*n+l[10]*o,e},ConvexObjectBreaker.transformTiedVectorInverse=function(e,t){var r=e.x,n=e.y,o=e.z,l=t.elements;return e.x=l[0]*r+l[1]*n+l[2]*o-l[12],e.y=l[4]*r+l[5]*n+l[6]*o-l[13],e.z=l[8]*r+l[9]*n+l[10]*o-l[14],e},ConvexObjectBreaker.transformPlaneToLocalSpace=function(){var e=new Vector3;return function(t,r,n){n.normal.copy(t.normal),n.constant=t.constant;var o=ConvexObjectBreaker.transformTiedVectorInverse(t.coplanarPoint(e),r);ConvexObjectBreaker.transformFreeVectorInverse(n.normal,r),n.constant=-o.dot(n.normal)}}(),Object.assign(Curve.prototype,{getPoint:function(){return console.warn("Curve: .getPoint() not implemented."),null},getPointAt:function(u,e){var t=this.getUtoTmapping(u);return this.getPoint(t,e)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,p,r=[],n=this.getPoint(0),o=0;for(r.push(0),p=1;p<=e;p++)o+=(t=this.getPoint(p/e)).distanceTo(n),r.push(o),n=t;return this.cacheArcLengths=r,r},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(u,e){var t,r=this.getLengths(),i=0,n=r.length;t=e||u*r[n-1];for(var o,l=0,c=n-1;l<=c;)if((o=r[i=Math.floor(l+(c-l)/2)]-t)<0)l=i+1;else{if(!(o>0)){c=i;break}c=i-1}if(r[i=c]===t)return i/(n-1);var h=r[i];return(i+(t-h)/(r[i+1]-h))/(n-1)},getTangent:function(e){var t=e-1e-4,r=e+1e-4;t<0&&(t=0),r>1&&(r=1);var n=this.getPoint(t);return this.getPoint(r).clone().sub(n).normalize()},getTangentAt:function(u){var e=this.getUtoTmapping(u);return this.getTangent(e)},computeFrenetFrames:function(e,t){var i,u,r,n=new Vector3,o=[],l=[],c=[],h=new Vector3,d=new Matrix4;for(i=0;i<=e;i++)u=i/e,o[i]=this.getTangentAt(u),o[i].normalize();l[0]=new Vector3,c[0]=new Vector3;var f=Number.MAX_VALUE,m=Math.abs(o[0].x),v=Math.abs(o[0].y),y=Math.abs(o[0].z);for(m<=f&&(f=m,n.set(1,0,0)),v<=f&&(f=v,n.set(0,1,0)),y<=f&&n.set(0,0,1),h.crossVectors(o[0],n).normalize(),l[0].crossVectors(o[0],h),c[0].crossVectors(o[0],l[0]),i=1;i<=e;i++)l[i]=l[i-1].clone(),c[i]=c[i-1].clone(),h.crossVectors(o[i-1],o[i]),h.length()>Number.EPSILON&&(h.normalize(),r=Math.acos(_Math.clamp(o[i-1].dot(o[i]),-1,1)),l[i].applyMatrix4(d.makeRotationAxis(h,r))),c[i].crossVectors(o[i],l[i]);if(!0===t)for(r=Math.acos(_Math.clamp(l[0].dot(l[e]),-1,1)),r/=e,o[0].dot(h.crossVectors(l[0],l[e]))>0&&(r=-r),i=1;i<=e;i++)l[i].applyMatrix4(d.makeRotationAxis(o[i],r*i)),c[i].crossVectors(o[i],l[i]);return{tangents:o,normals:l,binormals:c}},clone:function(){return(new this.constructor).copy(this)},copy:function(source){return this.arcLengthDivisions=source.arcLengthDivisions,this},toJSON:function(){var data={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return data.arcLengthDivisions=this.arcLengthDivisions,data.type=this.type,data},fromJSON:function(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}),GrannyKnot.prototype=Object.create(Curve.prototype),GrannyKnot.prototype.constructor=GrannyKnot,GrannyKnot.prototype.getPoint=function(e,t){var r=t||new Vector3;e=2*Math.PI*e;var n=-.22*Math.cos(e)-1.28*Math.sin(e)-.44*Math.cos(3*e)-.78*Math.sin(3*e),o=-.1*Math.cos(2*e)-.27*Math.sin(2*e)+.38*Math.cos(4*e)+.46*Math.sin(4*e),l=.7*Math.cos(3*e)-.4*Math.sin(3*e);return r.set(n,o,l).multiplyScalar(20)},HeartCurve.prototype=Object.create(Curve.prototype),HeartCurve.prototype.constructor=HeartCurve,HeartCurve.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=16*Math.pow(Math.sin(e),3),o=13*Math.cos(e)-5*Math.cos(2*e)-2*Math.cos(3*e)-Math.cos(4*e);return r.set(n,o,0).multiplyScalar(this.scale)},VivianiCurve.prototype=Object.create(Curve.prototype),VivianiCurve.prototype.constructor=VivianiCurve,VivianiCurve.prototype.getPoint=function(e,t){var r=t||new Vector3;e=4*e*Math.PI;var a=this.scale/2,n=a*(1+Math.cos(e)),o=a*Math.sin(e),l=2*a*Math.sin(e/2);return r.set(n,o,l)},KnotCurve.prototype=Object.create(Curve.prototype),KnotCurve.prototype.constructor=KnotCurve,KnotCurve.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=50*Math.sin(e),o=Math.cos(e)*(10+50*Math.cos(e)),l=Math.sin(e)*(10+50*Math.cos(e));return r.set(n,o,l)},HelixCurve.prototype=Object.create(Curve.prototype),HelixCurve.prototype.constructor=HelixCurve,HelixCurve.prototype.getPoint=function(e,t){var r=t||new Vector3,n=2*Math.PI*e*150/30,o=30*Math.cos(n),l=30*Math.sin(n),c=150*e;return r.set(o,l,c)},TrefoilKnot.prototype=Object.create(Curve.prototype),TrefoilKnot.prototype.constructor=TrefoilKnot,TrefoilKnot.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=(2+Math.cos(3*e))*Math.cos(2*e),o=(2+Math.cos(3*e))*Math.sin(2*e),l=Math.sin(3*e);return r.set(n,o,l).multiplyScalar(this.scale)},TorusKnot.prototype=Object.create(Curve.prototype),TorusKnot.prototype.constructor=TorusKnot,TorusKnot.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=(2+Math.cos(4*e))*Math.cos(3*e),o=(2+Math.cos(4*e))*Math.sin(3*e),l=Math.sin(4*e);return r.set(n,o,l).multiplyScalar(this.scale)},CinquefoilKnot.prototype=Object.create(Curve.prototype),CinquefoilKnot.prototype.constructor=CinquefoilKnot,CinquefoilKnot.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=(2+Math.cos(5*e))*Math.cos(2*e),o=(2+Math.cos(5*e))*Math.sin(2*e),l=Math.sin(5*e);return r.set(n,o,l).multiplyScalar(this.scale)},TrefoilPolynomialKnot.prototype=Object.create(Curve.prototype),TrefoilPolynomialKnot.prototype.constructor=TrefoilPolynomialKnot,TrefoilPolynomialKnot.prototype.getPoint=function(e,t){var r=t||new Vector3;e=4*e-2;var n=Math.pow(e,3)-3*e,o=Math.pow(e,4)-4*e*e,l=.2*Math.pow(e,5)-2*e;return r.set(n,o,l).multiplyScalar(this.scale)};var scaleTo=function(e,t,r){return r*(t-e)+e};function FigureEightPolynomialKnot(e){Curve.call(this),this.scale=void 0===e?1:e}function DecoratedTorusKnot4a(e){Curve.call(this),this.scale=void 0===e?40:e}function DecoratedTorusKnot4b(e){Curve.call(this),this.scale=void 0===e?40:e}function DecoratedTorusKnot5a(e){Curve.call(this),this.scale=void 0===e?40:e}function DecoratedTorusKnot5c(e){Curve.call(this),this.scale=void 0===e?40:e}FigureEightPolynomialKnot.prototype=Object.create(Curve.prototype),FigureEightPolynomialKnot.prototype.constructor=FigureEightPolynomialKnot,FigureEightPolynomialKnot.prototype.getPoint=function(e,t){var r=t||new Vector3,n=.4*(e=scaleTo(-4,4,e))*(e*e-7)*(e*e-10),o=Math.pow(e,4)-13*e*e,l=.1*e*(e*e-4)*(e*e-9)*(e*e-12);return r.set(n,o,l).multiplyScalar(this.scale)},DecoratedTorusKnot4a.prototype=Object.create(Curve.prototype),DecoratedTorusKnot4a.prototype.constructor=DecoratedTorusKnot4a,DecoratedTorusKnot4a.prototype.getPoint=function(e,t){var r=t||new Vector3;e*=2*Math.PI;var n=Math.cos(2*e)*(1+.6*(Math.cos(5*e)+.75*Math.cos(10*e))),o=Math.sin(2*e)*(1+.6*(Math.cos(5*e)+.75*Math.cos(10*e))),l=.35*Math.sin(5*e);return r.set(n,o,l).multiplyScalar(this.scale)},DecoratedTorusKnot4b.prototype=Object.create(Curve.prototype),DecoratedTorusKnot4b.prototype.constructor=DecoratedTorusKnot4b,DecoratedTorusKnot4b.prototype.getPoint=function(e,t){var r=t||new Vector3,n=e*Math.PI*2,o=Math.cos(2*n)*(1+.45*Math.cos(3*n)+.4*Math.cos(9*n)),l=Math.sin(2*n)*(1+.45*Math.cos(3*n)+.4*Math.cos(9*n)),c=.2*Math.sin(9*n);return r.set(o,l,c).multiplyScalar(this.scale)},DecoratedTorusKnot5a.prototype=Object.create(Curve.prototype),DecoratedTorusKnot5a.prototype.constructor=DecoratedTorusKnot5a,DecoratedTorusKnot5a.prototype.getPoint=function(e,t){var r=t||new Vector3,n=e*Math.PI*2,o=Math.cos(3*n)*(1+.3*Math.cos(5*n)+.5*Math.cos(10*n)),l=Math.sin(3*n)*(1+.3*Math.cos(5*n)+.5*Math.cos(10*n)),c=.2*Math.sin(20*n);return r.set(o,l,c).multiplyScalar(this.scale)},DecoratedTorusKnot5c.prototype=Object.create(Curve.prototype),DecoratedTorusKnot5c.prototype.constructor=DecoratedTorusKnot5c,DecoratedTorusKnot5c.prototype.getPoint=function(e,t){var r=t||new Vector3,n=e*Math.PI*2,o=Math.cos(4*n)*(1+.5*(Math.cos(5*n)+.4*Math.cos(20*n))),l=Math.sin(4*n)*(1+.5*(Math.cos(5*n)+.4*Math.cos(20*n))),c=.35*Math.sin(15*n);return r.set(o,l,c).multiplyScalar(this.scale)};var NURBSUtils={findSpan:function(p,u,e){var t=e.length-p-1;if(u>=e[t])return t-1;if(u<=e[p])return p;for(var r=p,n=t,o=Math.floor((r+n)/2);u<e[o]||u>=e[o+1];)u<e[o]?n=o:r=o,o=Math.floor((r+n)/2);return o},calcBasisFunctions:function(span,u,p,e){var t=[],r=[],n=[];t[0]=1;for(var o=1;o<=p;++o){r[o]=u-e[span+1-o],n[o]=e[span+o]-u;for(var l=0,c=0;c<o;++c){var h=n[c+1],d=r[o-c],f=t[c]/(h+d);t[c]=l+h*f,l=d*f}t[o]=l}return t},calcBSplinePoint:function(p,e,t,u){for(var span=this.findSpan(p,u,e),r=this.calcBasisFunctions(span,u,p,e),n=new Vector4(0,0,0,0),o=0;o<=p;++o){var l=t[span-p+o],c=r[o],h=l.w*c;n.x+=l.x*h,n.y+=l.y*h,n.z+=l.z*h,n.w+=l.w*c}return n},calcBasisFunctionDerivatives:function(span,u,p,e,t){for(var r=[],i=0;i<=p;++i)r[i]=0;var n=[];for(i=0;i<=e;++i)n[i]=r.slice(0);var o=[];for(i=0;i<=p;++i)o[i]=r.slice(0);o[0][0]=1;for(var l=r.slice(0),c=r.slice(0),h=1;h<=p;++h){l[h]=u-t[span+1-h],c[h]=t[span+h]-u;for(var d=0,f=0;f<h;++f){var m=c[f+1],v=l[h-f];o[h][f]=m+v;var y=o[f][h-1]/o[h][f];o[f][h]=d+m*y,d=v*y}o[h][h]=d}for(h=0;h<=p;++h)n[0][h]=o[h][p];for(f=0;f<=p;++f){var x=0,w=1,a=[];for(i=0;i<=p;++i)a[i]=r.slice(0);a[0][0]=1;for(var M=1;M<=e;++M){var S=0,A=f-M,T=p-M;f>=M&&(a[w][0]=a[x][0]/o[T+1][A],S=a[w][0]*o[A][T]);var _=f-1<=T?M-1:p-f;for(h=A>=-1?1:-A;h<=_;++h)a[w][h]=(a[x][h]-a[x][h-1])/o[T+1][A+h],S+=a[w][h]*o[A+h][T];f<=T&&(a[w][M]=-a[x][M-1]/o[T+1][f],S+=a[w][M]*o[f][T]),n[M][f]=S;h=x;x=w,w=h}}for(f=p,M=1;M<=e;++M){for(h=0;h<=p;++h)n[M][h]*=f;f*=p-M}return n},calcBSplineDerivatives:function(p,e,t,u,r){for(var n=r<p?r:p,o=[],span=this.findSpan(p,u,e),l=this.calcBasisFunctionDerivatives(span,u,p,n,e),c=[],i=0;i<t.length;++i){var h=(f=t[i].clone()).w;f.x*=h,f.y*=h,f.z*=h,c[i]=f}for(var d=0;d<=n;++d){for(var f=c[span-p].clone().multiplyScalar(l[d][0]),m=1;m<=p;++m)f.add(c[span-p+m].clone().multiplyScalar(l[d][m]));o[d]=f}for(d=n+1;d<=r+1;++d)o[d]=new Vector4(0,0,0);return o},calcKoverI:function(e,i){for(var t=1,r=2;r<=e;++r)t*=r;var n=1;for(r=2;r<=i;++r)n*=r;for(r=2;r<=e-i;++r)n*=r;return t/n},calcRationalCurveDerivatives:function(e){for(var t=e.length,r=[],n=[],i=0;i<t;++i){var o=e[i];r[i]=new Vector3(o.x,o.y,o.z),n[i]=o.w}for(var l=[],c=0;c<t;++c){var h=r[c].clone();for(i=1;i<=c;++i)h.sub(l[c-i].clone().multiplyScalar(this.calcKoverI(c,i)*n[i]));l[c]=h.divideScalar(n[0])}return l},calcNURBSDerivatives:function(p,e,t,u,r){var n=this.calcBSplineDerivatives(p,e,t,u,r);return this.calcRationalCurveDerivatives(n)},calcSurfacePoint:function(p,q,e,t,r,u,n,o){for(var l=this.findSpan(p,u,e),c=this.findSpan(q,n,t),h=this.calcBasisFunctions(l,u,p,e),d=this.calcBasisFunctions(c,n,q,t),f=[],m=0;m<=q;++m){f[m]=new Vector4(0,0,0,0);for(var v=0;v<=p;++v){var y=r[l-p+v][c-q+m].clone(),x=y.w;y.x*=x,y.y*=x,y.z*=x,f[m].add(y.multiplyScalar(h[v]))}}var w=new Vector4(0,0,0,0);for(m=0;m<=q;++m)w.add(f[m].multiplyScalar(d[m]));w.divideScalar(w.w),o.set(w.x,w.y,w.z)}},NURBSCurve=function(e,t,r,n,o){Curve.call(this),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=o||this.knots.length-1;for(var i=0;i<r.length;++i){var l=r[i];this.controlPoints[i]=new Vector4(l.x,l.y,l.z,l.w)}};NURBSCurve.prototype=Object.create(Curve.prototype),NURBSCurve.prototype.constructor=NURBSCurve,NURBSCurve.prototype.getPoint=function(e){var u=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),t=NURBSUtils.calcBSplinePoint(this.degree,this.knots,this.controlPoints,u);return 1!=t.w&&t.divideScalar(t.w),new Vector3(t.x,t.y,t.z)},NURBSCurve.prototype.getTangent=function(e){var u=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),t=NURBSUtils.calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,u,1)[1].clone();return t.normalize(),t};var NURBSSurface=function(e,t,r,n,o){this.degree1=e,this.degree2=t,this.knots1=r,this.knots2=n,this.controlPoints=[];for(var l=r.length-e-1,c=n.length-t-1,i=0;i<l;++i){this.controlPoints[i]=[];for(var h=0;h<c;++h){var d=o[i][h];this.controlPoints[i][h]=new Vector4(d.x,d.y,d.z,d.w)}}},instance,focus,fov,aspect,near,far,zoom,eyeSep,eyeRight,eyeLeft;function StereoCamera(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}NURBSSurface.prototype={constructor:NURBSSurface,getPoint:function(e,t,r){var u=this.knots1[0]+e*(this.knots1[this.knots1.length-1]-this.knots1[0]),n=this.knots2[0]+t*(this.knots2[this.knots2.length-1]-this.knots2[0]);NURBSUtils.calcSurfacePoint(this.degree1,this.degree2,this.knots1,this.knots2,this.controlPoints,u,n,r)}},Object.assign(StereoCamera.prototype,{update:(eyeRight=new Matrix4,eyeLeft=new Matrix4,function(e){if(instance!==this||focus!==e.focus||fov!==e.fov||aspect!==e.aspect*this.aspect||near!==e.near||far!==e.far||zoom!==e.zoom||eyeSep!==this.eyeSep){instance=this,focus=e.focus,fov=e.fov,aspect=e.aspect*this.aspect,near=e.near,far=e.far,zoom=e.zoom;var t,r,n=e.projectionMatrix.clone(),o=(eyeSep=this.eyeSep/2)*near/focus,l=near*Math.tan(_Math.DEG2RAD*fov*.5)/zoom;eyeLeft.elements[12]=-eyeSep,eyeRight.elements[12]=eyeSep,t=-l*aspect+o,r=l*aspect+o,n.elements[0]=2*near/(r-t),n.elements[8]=(r+t)/(r-t),this.cameraL.projectionMatrix.copy(n),t=-l*aspect-o,r=l*aspect-o,n.elements[0]=2*near/(r-t),n.elements[8]=(r+t)/(r-t),this.cameraR.projectionMatrix.copy(n)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(eyeLeft),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(eyeRight)})});var AnaglyphEffect=function(e,t,r){this.colorMatrixLeft=(new Matrix3).fromArray([1.0671679973602295,-.0016435992438346148,.0001777536963345483,-.028107794001698494,-.00019593400065787137,-.0002875397040043026,-.04279090091586113,15809757314855233e-21,-.00024287120322696865]),this.colorMatrixRight=(new Matrix3).fromArray([-.0355340838432312,-.06440307199954987,.018319187685847282,-.10269022732973099,.8079727292060852,-.04835830628871918,.0001224992738571018,-.009558862075209618,.567823588848114]);var n=new OrthographicCamera(-1,1,1,-1,0,1),o=new Scene,l=new StereoCamera,c={minFilter:LinearFilter,magFilter:NearestFilter,format:RGBAFormat};void 0===t&&(t=512),void 0===r&&(r=512);var h=new WebGLRenderTarget(t,r,c),d=new WebGLRenderTarget(t,r,c),f=new ShaderMaterial({uniforms:{mapLeft:{value:h.texture},mapRight:{value:d.texture},colorMatrixLeft:{value:this.colorMatrixLeft},colorMatrixRight:{value:this.colorMatrixRight}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = vec2( uv.x, uv.y );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","uniform mat3 colorMatrixLeft;","uniform mat3 colorMatrixRight;","float lin( float c ) {","\treturn c <= 0.04045 ? c * 0.0773993808 :","\t\t\tpow( c * 0.9478672986 + 0.0521327014, 2.4 );","}","vec4 lin( vec4 c ) {","\treturn vec4( lin( c.r ), lin( c.g ), lin( c.b ), c.a );","}","float dev( float c ) {","\treturn c <= 0.0031308 ? c * 12.92","\t\t\t: pow( c, 0.41666 ) * 1.055 - 0.055;","}","void main() {","\tvec2 uv = vUv;","\tvec4 colorL = lin( texture2D( mapLeft, uv ) );","\tvec4 colorR = lin( texture2D( mapRight, uv ) );","\tvec3 color = clamp(","\t\t\tcolorMatrixLeft * colorL.rgb +","\t\t\tcolorMatrixRight * colorR.rgb, 0., 1. );","\tgl_FragColor = vec4(","\t\t\tdev( color.r ), dev( color.g ), dev( color.b ),","\t\t\tmax( colorL.a, colorR.a ) );","}"].join("\n")}),m=new Mesh(new PlaneBufferGeometry(2,2),f);o.add(m),this.setSize=function(t,r){e.setSize(t,r);var n=e.getPixelRatio();h.setSize(t*n,r*n),d.setSize(t*n,r*n)},this.render=function(t,r){var c=e.getRenderTarget();t.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),l.update(r),e.setRenderTarget(h),e.clear(),e.render(t,l.cameraL),e.setRenderTarget(d),e.clear(),e.render(t,l.cameraR),e.setRenderTarget(null),e.render(o,n),e.setRenderTarget(c)},this.dispose=function(){h&&h.dispose(),d&&d.dispose(),m&&m.geometry.dispose(),f&&f.dispose()}},AsciiEffect=function(e,t,r){t=void 0===t?" .:-=+*#%@":t,r||(r={});var n,o,l=r.resolution?r.resolution:.15,c=r.scale?r.scale:1,h=!!r.color&&r.color,d=!!r.alpha&&r.alpha,f=!!r.block&&r.block,m=!!r.invert&&r.invert,v=document.createElement("div");v.style.cursor="default";var y,x,w,M=document.createElement("table");v.appendChild(M),this.setSize=function(t,r){n=t,o=r,e.setSize(t,r),function(){y=Math.round(n*P),x=Math.round(o*P),L.width=y,L.height=x,(w=e.domElement).style.backgroundColor&&(M.rows[0].cells[0].style.backgroundColor=w.style.backgroundColor,M.rows[0].cells[0].style.color=w.style.color);M.cellSpacing=0,M.cellPadding=0;var t=M.style;t.display="inline",t.width=Math.round(y/P*c)+"px",t.height=Math.round(x/P*c)+"px",t.whiteSpace="pre",t.margin="0px",t.padding="0px",t.letterSpacing=F+"px",t.fontFamily=T,t.fontSize=E+"px",t.lineHeight=D+"px",t.textAlign="left",t.textDecoration="none"}()},this.render=function(t,r){e.render(t,r),function(e,t){C.clearRect(0,0,y,x),C.drawImage(_,0,0,y,x);for(var r=C.getImageData(0,0,y,x).data,n="",o=0;o<x;o+=2){for(var l=0;l<y;l++){var c,v,w=4*(o*y+l),M=r[w],S=r[w+1],A=r[w+2],T=r[w+3];v=(.3*M+.59*S+.11*A)/255,0==T&&(v=1),c=Math.floor((1-v)*(N.length-1)),m&&(c=N.length-c-1);var L=N[c];void 0!==L&&" "!=L||(L="&nbsp;"),n+=h?"<span style='color:rgb("+M+","+S+","+A+");"+(f?"background-color:rgb("+M+","+S+","+A+");":"")+(d?"opacity:"+T/255+";":"")+"'>"+L+"</span>":L}n+="<br/>"}t.innerHTML="<tr><td>"+n+"</td></tr>"}(0,M)},this.domElement=v;var S=" .,:;i1tfLCG08@".split(""),A=" CGO08@".split(""),T="courier new, monospace",_=e.domElement,L=document.createElement("canvas");if(L.getContext){var C=L.getContext("2d");if(C.getImageData){var N=h?A:S;t&&(N=t);var P=.5;P=.25,l&&(P=l);var E=2/P*c,D=2/P*c,F=0;switch(c){case 1:F=-1;break;case 2:case 3:F=-2.1;break;case 4:F=-3.1;break;case 5:F=-4.15}}}},alphamap_fragment="\n#ifdef USE_ALPHAMAP\n\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n\n#endif\n",alphamap_pars_fragment="\n#ifdef USE_ALPHAMAP\n\n\tuniform sampler2D alphaMap;\n\n#endif\n",alphatest_fragment="\n#ifdef ALPHATEST\n\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n\n#endif\n",aomap_fragment="\n#ifdef USE_AOMAP\n\n\t// reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\n\t#endif\n\n#endif\n",aomap_pars_fragment="\n#ifdef USE_AOMAP\n\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n\n#endif\n",begin_vertex="\nvec3 transformed = vec3( position );\n",beginnormal_vertex="\nvec3 objectNormal = vec3( normal );\n\n#ifdef USE_TANGENT\n\n\tvec3 objectTangent = vec3( tangent.xyz );\n\n#endif\n",bsdfs='\n\n// Analytical approximation of the DFG LUT, one half of the\n// split-sum approximation used in indirect specular lighting.\n// via \'environmentBRDF\' from "Physically Based Shading on Mobile"\n// https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile\nvec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\n\tvec4 r = roughness * c0 + c1;\n\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n\n}\n\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\n\t// based upon Frostbite 3 Moving to Physically-based Rendering\n\t// page 32, equation 26: E[window1]\n\t// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\n\t// this is intended to be used on spot and point lights who are represented as luminous intensity\n\t// but who must be converted to luminous irradiance for surface lighting calculation\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\n\tif( cutoffDistance > 0.0 ) {\n\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\n\t}\n\n\treturn distanceFalloff;\n\n#else\n\n\tif( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\n\t}\n\n\treturn 1.0;\n\n#endif\n\n}\n\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\n\treturn RECIPROCAL_PI * diffuseColor;\n\n} // validated\n\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\n\t// Original approximation by Christophe Schlick \'94\n\t// float fresnel = pow( 1.0 - dotLH, 5.0 );\n\n\t// Optimized variant (presented by Epic at SIGGRAPH \'13)\n\t// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n\n} // validated\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (34)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is "roughness squared" in Disney’s reparameterization\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\n\t// geometry term (normalized) = G(l)⋅G(v) / 4(n⋅l)(n⋅v)\n\t// also see #12151\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\n\treturn 1.0 / ( gl * gv );\n\n} // validated\n\n// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2\n// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\n\tfloat a2 = pow2( alpha );\n\n\t// dotNL and dotNV are explicitly swapped. This is not a mistake.\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\n\treturn 0.5 / max( gv + gl, EPSILON );\n\n}\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is "roughness squared" in Disney’s reparameterization\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\n\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n\n}\n\n// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n\tfloat alpha = pow2( roughness ); // UE4\'s roughness\n\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\n\tfloat D = D_GGX( alpha, dotNH );\n\n\treturn F * ( G * D );\n\n} // validated\n\n// Rect Area Light\n\n// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines\n// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt\n// code: https://github.com/selfshadow/ltc_code/\n\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\n\tfloat dotNV = saturate( dot( N, V ) );\n\n\t// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\n\treturn uv;\n\n}\n\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\n\t// Real-Time Area Lighting: a Journey from Research to Production (p.102)\n\t// An approximation of the form factor of a horizon-clipped rectangle.\n\n\tfloat l = length( f );\n\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n\n}\n\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\n\tfloat x = dot( v1, v2 );\n\n\tfloat y = abs( x );\n\n\t// rational polynomial approximation to theta / sin( theta ) / 2PI\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\n\treturn cross( v1, v2 ) * theta_sintheta;\n\n}\n\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\n\t// bail if point is on back side of plane of light\n\t// assumes ccw winding order of light vertices\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\n\t// construct orthonormal basis around N\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system\n\n\t// compute transform\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\n\t// transform rect\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\n\t// project rect onto sphere\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\n\t// calculate vector form factor\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\n\t// adjust for horizon clipping\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n\n}\n\n// End Rect Area Light\n\n// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\n\treturn specularColor * brdf.x + brdf.y;\n\n} // validated\n\n// Fdez-Agüera\'s "Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting"\n// Approximates multiscattering in order to preserve energy.\n// http://www.jcgt.org/published/0008/01/03/\nvoid BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n\tvec3 F = F_Schlick( specularColor, dotNV );\n\tvec2 brdf = integrateSpecularBRDF( dotNV, roughness );\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\n\t// Paper incorrect indicates coefficient is PI/21, and will\n\t// be corrected to 1/21 in future updates.\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619; // 1/21\n\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n\n}\n\nfloat G_BlinnPhong_Implicit(  ) {\n\n\t// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\n\treturn 0.25;\n\n}\n\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n\n}\n\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\n\t//float dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\t//float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\n\tfloat G = G_BlinnPhong_Implicit(  );\n\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\n\treturn F * ( G * D );\n\n} // validated\n\n// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\n\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n',bumpmap_pars_fragment="\n#ifdef USE_BUMPMAP\n\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\n\t// Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen\n\t// http://api.unrealengine.com/attachments/Engine/Rendering/LightingAndShadows/BumpMappingWithoutTangentSpace/mm_sfgrad_bump.pdf\n\n\t// Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)\n\n\tvec2 dHdxy_fwd() {\n\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\n\t\treturn vec2( dBx, dBy );\n\n\t}\n\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\n\t\t// Workaround for Adreno 3XX dFd*( vec3 ) bug. See #9988\n\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\t\t// normalized\n\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\n\t}\n\n#endif\n",clipping_planes_fragment="\n#if NUM_CLIPPING_PLANES > 0\n\n\tvec4 plane;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\n\t}\n\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\n\t\tbool clipped = true;\n\n\t\t#pragma unroll_loop\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\n\t\t}\n\n\t\tif ( clipped ) discard;\n\n\t#endif\n\n#endif\n",clipping_planes_pars_fragment="\n#if NUM_CLIPPING_PLANES > 0\n\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n\n#endif\n",clipping_planes_pars_vertex="\n#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex="\n#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG ) && ! defined( MATCAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment="\n#ifdef USE_COLOR\n\n\tdiffuseColor.rgb *= vColor;\n\n#endif\n",color_pars_fragment="\n#ifdef USE_COLOR\n\n\tvarying vec3 vColor;\n\n#endif\n",color_pars_vertex="\n#ifdef USE_COLOR\n\n\tvarying vec3 vColor;\n\n#endif\n",color_vertex="\n#ifdef USE_COLOR\n\n\tvColor.xyz = color.xyz;\n\n#endif\n",common="\n#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\n// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.\n// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\n\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\n\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\n\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n}\n\n// http://en.wikibooks.org/wiki/GLSL_Programming/Applying_Matrix_Transformations\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n\n}\n\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\n\treturn - distance * planeNormal + point;\n\n}\n\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n\n}\n\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n\n}\n\nmat3 transposeMat3( const in mat3 m ) {\n\n\tmat3 tmp;\n\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\n\treturn tmp;\n\n}\n\n// https://en.wikipedia.org/wiki/Relative_luminance\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\n\treturn dot( weights, color.rgb );\n\n}\n",cube_uv_reflection_fragment="\n#ifdef ENVMAP_TYPE_CUBE_UV\n\n#define cubeUV_textureSize (1024.0)\n\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\n\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\t// Clamp the value to the max mip level counts. hard coded to 6 mips\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\n\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\t// float powScale = exp2(roughnessLevel + mipLevel);\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\t// float scale =  1.0 / exp2(roughnessLevel + 2.0 + mipLevel);\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\t// float mipOffset = 0.75*(1.0 - 1.0/exp2(mipLevel))/exp2(roughnessLevel);\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\n\tfloat rcpPowScale = 1.0 / powScale;\n\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\n\nvec4 textureCubeUV( sampler2D envMap, vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\n\t// round to nearest mipmap if we are not interpolating.\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\n\t// Tri linear interpolation.\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\n\tvec4 result = mix(color10, color20, t);\n\n\treturn vec4(result.rgb, 1.0);\n}\n\n#endif\n",defaultnormal_vertex="\nvec3 transformedNormal = normalMatrix * objectNormal;\n\n#ifdef FLIP_SIDED\n\n\ttransformedNormal = - transformedNormal;\n\n#endif\n\n#ifdef USE_TANGENT\n\n\tvec3 transformedTangent = normalMatrix * objectTangent;\n\n\t#ifdef FLIP_SIDED\n\n\t\ttransformedTangent = - transformedTangent;\n\n\t#endif\n\n#endif\n",displacementmap_pars_vertex="\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n\n#endif\n",displacementmap_vertex="\n#ifdef USE_DISPLACEMENTMAP\n\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n\n#endif\n",emissivemap_fragment="\n#ifdef USE_EMISSIVEMAP\n\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n\n#endif\n",emissivemap_pars_fragment="\n#ifdef USE_EMISSIVEMAP\n\n\tuniform sampler2D emissiveMap;\n\n#endif\n",encodings_fragment="\ngl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment="\n// For a discussion of what this is, please read this: http://lousodrome.net/blog/light/2013/05/26/gamma-correct-and-hdr-rendering-in-a-32-bits-buffer/\n\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\n\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );\n}\n\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );\n}\n\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\n\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\n\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\n\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n//  return vec4( value.brg, ( 3.0 + 128.0 ) / 256.0 );\n}\n\n// reference: http://iwasbeingirony.blogspot.ca/2010/06/difference-between-rgbm-and-rgbd.html\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * value.a * maxRange, 1.0 );\n}\n\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\n\n// reference: http://iwasbeingirony.blogspot.ca/2010/06/difference-between-rgbm-and-rgbd.html\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\n\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.r, max( value.g, value.b ) );\n\tfloat D = max( maxRange / maxRGB, 1.0 );\n\tD = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\n\n// LogLuv reference: http://graphicrants.blogspot.ca/2009/04/rgbm-color-encoding.html\n\n// M matrix, for encoding\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;\n\tXp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract( Le );\n\tvResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;\n\treturn vResult;\n}\n\n// Inverse M matrix, for decoding\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;\n\treturn vec4( max( vRGB, 0.0 ), 1.0 );\n}\n",envmap_fragment="\n#ifdef USE_ENVMAP\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\n\t\t// Transforming Normal Vectors with the Inverse Transformation\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\n\t\t#else\n\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\n\t\t#endif\n\n\t#else\n\n\t\tvec3 reflectVec = vReflect;\n\n\t#endif\n\n\t#ifdef ENVMAP_TYPE_CUBE\n\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\n\t\tvec2 sampleUV;\n\n\t\treflectVec = normalize( reflectVec );\n\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\n\t\treflectVec = normalize( reflectVec );\n\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\n\t#else\n\n\t\tvec4 envColor = vec4( 0.0 );\n\n\t#endif\n\n\tenvColor = envMapTexelToLinear( envColor );\n\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\n\t#endif\n\n#endif\n",envmap_pars_fragment="\n#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n\n#ifdef USE_ENVMAP\n\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n\n#endif\n",envmap_pars_vertex="\n#ifdef USE_ENVMAP\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\n\t#else\n\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\n\t#endif\n\n#endif\n",envmap_vertex="\n#ifdef USE_ENVMAP\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\n\t\tvWorldPosition = worldPosition.xyz;\n\n\t#else\n\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\n\t\t#else\n\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\n\t\t#endif\n\n\t#endif\n\n#endif\n",fog_vertex="\n#ifdef USE_FOG\n\n\tfogDepth = -mvPosition.z;\n\n#endif\n",fog_pars_vertex="\n#ifdef USE_FOG\n\n\tvarying float fogDepth;\n\n#endif\n",fog_fragment="\n#ifdef USE_FOG\n\n\t#ifdef FOG_EXP2\n\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\n\t#else\n\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\n\t#endif\n\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\n#endif\n",fog_pars_fragment="\n#ifdef USE_FOG\n\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\n\t#ifdef FOG_EXP2\n\n\t\tuniform float fogDensity;\n\n\t#else\n\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\n\t#endif\n\n#endif\n",gradientmap_pars_fragment="\n#ifdef TOON\n\n\tuniform sampler2D gradientMap;\n\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\n\t\t// dotNL will be from -1.0 to 1.0\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\n\t\t#ifdef USE_GRADIENTMAP\n\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\n\t\t#else\n\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\n\t\t#endif\n\t}\n\n#endif\n",lightmap_fragment="\n#ifdef USE_LIGHTMAP\n\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity; // factor of PI should not be present; included here to prevent breakage\n\n#endif\n",lightmap_pars_fragment="\n#ifdef USE_LIGHTMAP\n\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n\n#endif\n",lights_lambert_vertex="\nvec3 diffuse = vec3( 1.0 );\n\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\n\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\n\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\n\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n\n#if NUM_POINT_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\n\t}\n\n#endif\n\n#if NUM_SPOT_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\t}\n\n#endif\n#if NUM_DIR_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\n\t}\n\n#endif\n\n#if NUM_HEMI_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\n\t\t#endif\n\n\t}\n\n#endif\n",lights_pars_begin="\nuniform vec3 ambientLightColor;\n\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\n\tvec3 irradiance = ambientLightColor;\n\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\tirradiance *= PI;\n\n\t#endif\n\n\treturn irradiance;\n\n}\n\n#if NUM_DIR_LIGHTS > 0\n\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\n\t}\n\n#endif\n#if NUM_POINT_LIGHTS > 0\n\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\n\t}\n\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\n\t\tif ( angleCos > spotLight.coneCos ) {\n\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\n\t\t} else {\n\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\n\t\t}\n\t}\n\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\n\t// Pre-computed values of LinearTransformedCosine approximation of BRDF\n\t// BRDF approximation Texture is 64x64\n\tuniform sampler2D ltc_1; // RGBA Float\n\tuniform sampler2D ltc_2; // RGBA Float\n\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\t\tirradiance *= PI;\n\n\t\t#endif\n\n\t\treturn irradiance;\n\n\t}\n\n#endif\n",envmap_physical_pars_fragment="\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\n\tvec3 getLightProbeIndirectIrradiance(  const in GeometricContext geometry, const in int maxMIPLevel ) {\n\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\n\t\t\t// TODO: replace with properly filtered cubemaps and access the irradiance LOD level, be it the last LOD level\n\t\t\t// of a specular cubemap, or just the default level of a specially created irradiance cubemap.\n\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\n\t\t\t#else\n\n\t\t\t\t// force the bias high to get the last LOD level as it is the most blurred.\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\n\t\t\t#endif\n\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, queryVec, 1.0 );\n\n\t\t#else\n\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\n\t\t#endif\n\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\n\t}\n\n\t// taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n\t\t//float envMapWidth = pow( 2.0, maxMIPLevelScalar );\n\t\t//float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n\t\t// clamp to allowable LOD ranges.\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\n\t}\n\n\tvec3 getLightProbeIndirectRadiance(  const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\n\t\t#else\n\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\n\t\t#endif\n\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\n\t\t\t#else\n\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\n\t\t\t#endif\n\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent ));\n\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\n\t\t\t#else\n\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\n\t\t\t#endif\n\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\n\t\t\t#else\n\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\n\t\t\t#endif\n\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\n\t\t#endif\n\n\t\treturn envMapColor.rgb * envMapIntensity;\n\n\t}\n\n#endif\n",lights_phong_fragment="\nBlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment="\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\nstruct BlinnPhongMaterial {\n\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n\n};\n\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\n\t#ifdef TOON\n\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\n\t#else\n\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\n\t#endif\n\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\tirradiance *= PI; // punctual light\n\n\t#endif\n\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n\n}\n\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n}\n\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment="\nPhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat ); // Burley clearcoat model\n\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment="\nstruct PhysicalMaterial {\n\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n\n};\n\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\n\n// Clear coat directional hemishperical reflectance (this approximation should be improved)\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n\n}\n\n#if NUM_RECT_AREA_LIGHTS > 0\n\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight; // counterclockwise; light shines in local neg z direction\n\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\n\t\t// LTC Fresnel Approximation by Stephen Hill\n\t\t// http://blog.selfshadow.com/publications/s2016-advances/s2016_ltc_fresnel.pdf\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\n\t}\n\n#endif\n\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\n\tvec3 irradiance = dotNL * directLight.color;\n\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\tirradiance *= PI; // punctual light\n\n\t#endif\n\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n\t#ifndef STANDARD\n\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\n\t#endif\n\n}\n\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\t// Defer to the IndirectSpecular function to compute\n\t// the indirectDiffuse if energy preservation is enabled.\n\t#ifndef ENVMAP_TYPE_CUBE_UV\n\n\t\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n\t#endif\n\n}\n\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\n\tfloat clearCoatInv = 1.0 - clearCoatDHR;\n\n\t// Both indirect specular and diffuse light accumulate here\n\t// if energy preservation enabled, and PMREM provided.\n\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\tvec3 singleScattering = vec3( 0.0 );\n\t\tvec3 multiScattering = vec3( 0.0 );\n\t\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\n\t\tBRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );\n\n\t\t// The multiscattering paper uses the below formula for calculating diffuse \n\t\t// for dielectrics, but this is already handled when initially computing the \n\t\t// specular and diffuse color, so we can just use the diffuseColor directly.\n\t\t//vec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\t\tvec3 diffuse = material.diffuseColor;\n\n\t\treflectedLight.indirectSpecular += clearCoatInv * radiance * singleScattering;\n\t\treflectedLight.indirectDiffuse += multiScattering * cosineWeightedIrradiance;\n\t\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n\n\t#else\n\n\t\treflectedLight.indirectSpecular += clearCoatInv * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\n\t#endif\n\n\t#ifndef STANDARD\n\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\n\t#endif\n}\n\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\n\n// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n\n}\n",lights_fragment_begin="\nGeometricContext geometry;\n\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\n\t}\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\n\t\t}\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearCoatRadiance = vec3( 0.0 );\n\n#endif\n",lights_fragment_maps="\n#if defined( RE_IndirectDiffuse )\n\n\t#ifdef USE_LIGHTMAP\n\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\n\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage\n\n\t\t#endif\n\n\t\tirradiance += lightMapIrradiance;\n\n\t#endif\n\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\tirradiance += getLightProbeIndirectIrradiance(  geometry, maxMipLevel );\n\n\t#endif\n\n#endif\n\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\n\tradiance += getLightProbeIndirectRadiance(  geometry, Material_BlinnShininessExponent( material ), maxMipLevel );\n\n\t#ifndef STANDARD\n\t\tclearCoatRadiance += getLightProbeIndirectRadiance(  geometry, Material_ClearCoat_BlinnShininessExponent( material ), maxMipLevel );\n\t#endif\n\n#endif\n",lights_fragment_end="\n#if defined( RE_IndirectDiffuse )\n\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight );\n\n#endif\n",logdepthbuf_fragment="\n#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\n\tgl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;\n\n#endif\n",logdepthbuf_pars_fragment="\n#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\n#endif\n",logdepthbuf_pars_vertex="\n#ifdef USE_LOGDEPTHBUF\n\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\n\t\tvarying float vFragDepth;\n\n\t#else\n\n\t\tuniform float logDepthBufFC;\n\n\t#endif\n\n#endif\n",logdepthbuf_vertex="\n#ifdef USE_LOGDEPTHBUF\n\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\n\t#else\n\n\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\n\t\tgl_Position.z *= gl_Position.w;\n\n\t#endif\n\n#endif\n",map_fragment="\n#ifdef USE_MAP\n\n\tvec4 texelColor = texture2D( map, vUv );\n\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n\n#endif\n",map_pars_fragment="\n#ifdef USE_MAP\n\n\tuniform sampler2D map;\n\n#endif\n",map_particle_fragment="\n#ifdef USE_MAP\n\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n\n#endif\n",map_particle_pars_fragment="\n#ifdef USE_MAP\n\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n\n#endif\n",metalnessmap_fragment="\nfloat metalnessFactor = metalness;\n\n#ifdef USE_METALNESSMAP\n\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\n\t// reads channel B, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\tmetalnessFactor *= texelMetalness.b;\n\n#endif\n",metalnessmap_pars_fragment="\n#ifdef USE_METALNESSMAP\n\n\tuniform sampler2D metalnessMap;\n\n#endif\n",morphnormal_vertex="\n#ifdef USE_MORPHNORMALS\n\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n\n#endif\n",morphtarget_pars_vertex="\n#ifdef USE_MORPHTARGETS\n\n\t#ifndef USE_MORPHNORMALS\n\n\tuniform float morphTargetInfluences[ 8 ];\n\n\t#else\n\n\tuniform float morphTargetInfluences[ 4 ];\n\n\t#endif\n\n#endif\n",morphtarget_vertex="\n#ifdef USE_MORPHTARGETS\n\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\n\t#ifndef USE_MORPHNORMALS\n\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\n\t#endif\n\n#endif\n",normal_fragment_begin="\n#ifdef FLAT_SHADED\n\n\t// Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...\n\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n\n#else\n\n\tvec3 normal = normalize( vNormal );\n\n\t#ifdef DOUBLE_SIDED\n\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\n\t#endif\n\n\t#ifdef USE_TANGENT\n\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\ttangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\tbitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\n\t\t#endif\n\n\t#endif\n\n#endif\n",normal_fragment_maps="\n#ifdef USE_NORMALMAP\n\n\t#ifdef OBJECTSPACE_NORMALMAP\n\n\t\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n\t\t#ifdef FLIP_SIDED\n\n\t\t\tnormal = - normal;\n\n\t\t#endif\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\n\t\t#endif\n\n\t\tnormal = normalize( normalMatrix * normal );\n\n\t#else // tangent-space normal map\n\n\t\t#ifdef USE_TANGENT\n\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\t\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t\tmapN.xy = normalScale * mapN.xy;\n\t\t\tnormal = normalize( vTBN * mapN );\n\n\t\t#else\n\n\t\t\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n\n\t\t#endif\n\n\t#endif\n\n#elif defined( USE_BUMPMAP )\n\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n\n#endif\n",normalmap_pars_fragment="\n#ifdef USE_NORMALMAP\n\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\n\t#ifdef OBJECTSPACE_NORMALMAP\n\n\t\tuniform mat3 normalMatrix;\n\n\t#else\n\n\t\t// Per-Pixel Tangent Space Normal Mapping\n\t\t// http://hacksoflife.blogspot.ch/2009/11/per-pixel-tangent-space-normal-mapping.html\n\n\t\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\n\t\t\t// Workaround for Adreno 3XX dFd*( vec3 ) bug. See #9988\n\n\t\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\t\tvec2 st0 = dFdx( vUv.st );\n\t\t\tvec2 st1 = dFdy( vUv.st );\n\n\t\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s ); // we do not care about the magnitude\n\n\t\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\t\tvec3 N = normalize( surf_norm );\n\t\t\tmat3 tsn = mat3( S, T, N );\n\n\t\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\n\t\t\tmapN.xy *= normalScale;\n\t\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\n\t\t\treturn normalize( tsn * mapN );\n\n\t\t}\n\n\t#endif\n\n#endif\n",packing="\nvec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\n\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\n\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8; // tidy overflow\n\treturn r * PackUpscale;\n}\n\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\n\n// NOTE: viewZ/eyeZ is < 0 when in front of the camera per OpenGL conventions\n\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\n\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment="\n#ifdef PREMULTIPLIED_ALPHA\n\n\t// Get get normal blending with premultipled, use with CustomBlending, OneFactor, OneMinusSrcAlphaFactor, AddEquation.\n\tgl_FragColor.rgb *= gl_FragColor.a;\n\n#endif\n",project_vertex="\nvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment="\n#if defined( DITHERING )\n\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n\n#endif\n",dithering_pars_fragment="\n#if defined( DITHERING )\n\n\t// based on https://www.shadertoy.com/view/MslGR8\n\tvec3 dithering( vec3 color ) {\n\t\t//Calculate grid position\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\n\t\t//Shift the individual colors differently, thus making it even harder to see the dithering pattern\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\n\t\t//modify shift acording to grid position.\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\n\t\t//shift the color by dither_shift\n\t\treturn color + dither_shift_RGB;\n\t}\n\n#endif\n",roughnessmap_fragment="\nfloat roughnessFactor = roughness;\n\n#ifdef USE_ROUGHNESSMAP\n\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\n\t// reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\troughnessFactor *= texelRoughness.g;\n\n#endif\n",roughnessmap_pars_fragment="\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform sampler2D roughnessMap;\n\n#endif\n",shadowmap_pars_fragment="\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHTS > 0\n\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHTS > 0\n\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHTS > 0\n\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\n\t}\n\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\n\t\tvec2 f = fract( uv * size + 0.5 );\n\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\n\t\treturn c;\n\n\t}\n\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\t// if ( something && something ) breaks ATI OpenGL shader compiler\n\t\t// if ( all( something, something ) ) using this instead\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\n\t\tif ( frustumTest ) {\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#else // no percentage-closer filtering:\n\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#endif\n\n\t\t}\n\n\t\treturn shadow;\n\n\t}\n\n\t// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D\n\t// vector suitable for 2D texture mapping. This code uses the following layout for the\n\t// 2D texture:\n\t//\n\t// xzXZ\n\t//  y Y\n\t//\n\t// Y - Positive y direction\n\t// y - Negative y direction\n\t// X - Positive x direction\n\t// x - Negative x direction\n\t// Z - Positive z direction\n\t// z - Negative z direction\n\t//\n\t// Source and test bed:\n\t// https://gist.github.com/tschw/da10c43c467ce8afd0c4\n\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n\t\t// Number of texels to avoid at the edge of each square\n\n\t\tvec3 absV = abs( v );\n\n\t\t// Intersect unit cube\n\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\n\t\t// Apply scale to avoid seams\n\n\t\t// two texels less per square (one texel will do for NEAREST)\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n\t\t// Unwrap\n\n\t\t// space: -1 ... 1 range for each square\n\t\t//\n\t\t// #X##\t\tdim    := ( 4 , 2 )\n\t\t//  # #\t\tcenter := ( 1 , 1 )\n\n\t\tvec2 planar = v.xy;\n\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\n\t\tif ( absV.z >= almostOne ) {\n\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\n\t\t} else if ( absV.x >= almostOne ) {\n\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\n\t\t} else if ( absV.y >= almostOne ) {\n\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\n\t\t}\n\n\t\t// Transform to UV space\n\n\t\t// scale := 0.5 / dim\n\t\t// translate := ( center + 0.5 ) / dim\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n\t}\n\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\n\t\t// for point lights, the uniform @vShadowCoord is re-purposed to hold\n\t\t// the vector from the light to the world-space position of the fragment.\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\n\t\t// dp = normalized distance from light to fragment position\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\n\t\tdp += shadowBias;\n\n\t\t// bd3D = base direction 3D\n\t\tvec3 bd3D = normalize( lightToPosition );\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#else // no percentage-closer filtering\n\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\n\t\t#endif\n\n\t}\n\n#endif\n",shadowmap_pars_vertex="\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHTS > 0\n\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHTS > 0\n\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHTS > 0\n\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\n\t#endif\n#endif\n",shadowmap_vertex="\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\n\t}\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\n\t}\n\n\t#endif\n\n\t#if NUM_POINT_LIGHTS > 0\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\n\t}\n\n\t#endif\n#endif\n",shadowmask_pars_fragment="\nfloat getShadowMask() {\n\n\tfloat shadow = 1.0;\n\n\t#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHTS > 0\n\n\tDirectionalLight directionalLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t}\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHTS > 0\n\n\tSpotLight spotLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\n\t}\n\n\t#endif\n\n\t#if NUM_POINT_LIGHTS > 0\n\n\tPointLight pointLight;\n\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\n\t}\n\n\t#endif\n\t#endif\n\n\treturn shadow;\n\n}\n",skinbase_vertex="\n#ifdef USE_SKINNING\n\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n\n#endif\n",skinning_pars_vertex="\n#ifdef USE_SKINNING\n\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\n\t#ifdef BONE_TEXTURE\n\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\n\t\tmat4 getBoneMatrix( const in float i ) {\n\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\n\t\t\ty = dy * ( y + 0.5 );\n\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\n\t\t\treturn bone;\n\n\t\t}\n\n\t#else\n\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\n\t\tmat4 getBoneMatrix( const in float i ) {\n\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\n\t\t}\n\n\t#endif\n\n#endif\n",skinning_vertex="\n#ifdef USE_SKINNING\n\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n\n#endif\n",skinnormal_vertex="\n#ifdef USE_SKINNING\n\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\n\t#ifdef USE_TANGENT\n\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\n\t#endif\n\n#endif\n",specularmap_fragment="\nfloat specularStrength;\n\n#ifdef USE_SPECULARMAP\n\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n\n#else\n\n\tspecularStrength = 1.0;\n\n#endif\n",specularmap_pars_fragment="\n#ifdef USE_SPECULARMAP\n\n\tuniform sampler2D specularMap;\n\n#endif\n",tonemapping_fragment="\n#if defined( TONE_MAPPING )\n\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n\n#endif\n",tonemapping_pars_fragment="\n#ifndef saturate\n\t#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\n\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\n\n// exposure only\nvec3 LinearToneMapping( vec3 color ) {\n\n\treturn toneMappingExposure * color;\n\n}\n\n// source: https://www.cs.utah.edu/~reinhard/cdrom/\nvec3 ReinhardToneMapping( vec3 color ) {\n\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n\n}\n\n// source: http://filmicgames.com/archives/75\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\n\t// John Hable's filmic operator from Uncharted 2 video game\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n\n}\n\n// source: http://filmicgames.com/archives/75\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\n\t// optimized filmic operator by Jim Hejl and Richard Burgess-Dawson\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n\n}\n\n// source: https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\n\tcolor *= toneMappingExposure;\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\n\n}\n",uv_pars_fragment="\n#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\n\tvarying vec2 vUv;\n\n#endif\n",uv_pars_vertex="\n#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n\n#endif\n",uv_vertex="\n#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n#endif\n",uv2_pars_fragment="\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tvarying vec2 vUv2;\n\n#endif\n",uv2_pars_vertex="\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\n#endif\n",uv2_vertex="\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tvUv2 = uv2;\n\n#endif\n",worldpos_vertex="\n#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\n#endif\n",background_frag="\nuniform sampler2D t2D;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tvec4 texColor = texture2D( t2D, vUv );\n\n\tgl_FragColor = mapTexelToLinear( texColor );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",background_vert="\nvarying vec2 vUv;\nuniform mat3 uvTransform;\n\nvoid main() {\n\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n\n}\n",cube_frag="\nuniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\n\nvarying vec3 vWorldDirection;\n\nvoid main() {\n\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\n\tgl_FragColor = mapTexelToLinear( texColor );\n\tgl_FragColor.a *= opacity;\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",cube_vert="\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\n\tgl_Position.z = gl_Position.w; // set z to camera.far\n\n}\n",depth_frag="\n#if DEPTH_PACKING == 3200\n\n\tuniform float opacity;\n\n#endif\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tdiffuseColor.a = opacity;\n\n\t#endif\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\t#include <logdepthbuf_fragment>\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tgl_FragColor = vec4( vec3( 1.0 - gl_FragCoord.z ), opacity );\n\n\t#elif DEPTH_PACKING == 3201\n\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\n\t#endif\n\n}\n",depth_vert="\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <skinbase_vertex>\n\n\t#ifdef USE_DISPLACEMENTMAP\n\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n",distanceRGBA_frag="\n#define DISTANCE\n\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main () {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist ); // clamp to [ 0, 1 ]\n\n\tgl_FragColor = packDepthToRGBA( dist );\n\n}\n",distanceRGBA_vert="\n#define DISTANCE\n\nvarying vec3 vWorldPosition;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <skinbase_vertex>\n\n\t#ifdef USE_DISPLACEMENTMAP\n\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvWorldPosition = worldPosition.xyz;\n\n}\n",equirect_frag="\nuniform sampler2D tEquirect;\n\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvec3 direction = normalize( vWorldDirection );\n\n\tvec2 sampleUV;\n\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\n\tvec4 texColor = texture2D( tEquirect, sampleUV );\n\n\tgl_FragColor = mapTexelToLinear( texColor );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",equirect_vert="\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\n}\n",linedashed_frag="\nuniform vec3 diffuse;\nuniform float opacity;\n\nuniform float dashSize;\nuniform float totalSize;\n\nvarying float vLineDistance;\n\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\n\t\tdiscard;\n\n\t}\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\n\toutgoingLight = diffuseColor.rgb; // simple shader\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",linedashed_vert="\nuniform float scale;\nattribute float lineDistance;\n\nvarying float vLineDistance;\n\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <color_vertex>\n\n\tvLineDistance = scale * lineDistance;\n\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n}\n",meshbasic_frag="\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\n\t#else\n\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\n\t#endif\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",meshbasic_vert="\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\n\t#ifdef USE_ENVMAP\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n\n}\n",meshlambert_frag="\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\n\t#ifdef DOUBLE_SIDED\n\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\n\t#else\n\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\n\t#endif\n\n\t#include <lightmap_fragment>\n\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\n\t#ifdef DOUBLE_SIDED\n\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\n\t#else\n\n\t\treflectedLight.directDiffuse = vLightFront;\n\n\t#endif\n\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\n\t#include <envmap_fragment>\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert="\n#define LAMBERT\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshmatcap_frag="\n#define MATCAP\n\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n\n#include <fog_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks\n\n\t#ifdef USE_MATCAP\n\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t\tmatcapColor = matcapTexelToLinear( matcapColor );\n\n\t#else\n\n\t\tvec4 matcapColor = vec4( 1.0 );\n\n\t#endif\n\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",meshmatcap_vert="\n#define MATCAP\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n\t#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\n\n\t\tvNormal = normalize( transformedNormal );\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n}\n",meshphong_frag="\n#define PHONG\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n\t#include <envmap_fragment>\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshphong_vert="\n#define PHONG\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\n\n\tvNormal = normalize( transformedNormal );\n\n#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",meshphysical_frag="\n#define PHYSICAL\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshphysical_vert="\n#define PHYSICAL\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\n\n\tvNormal = normalize( transformedNormal );\n\n\t#ifdef USE_TANGENT\n\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\n\t#endif\n\n#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",normal_frag="\n#define NORMAL\n\nuniform float opacity;\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\n\tvarying vec3 vViewPosition;\n\n#endif\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\n}\n",normal_vert="\n#define NORMAL\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\n\tvarying vec3 vViewPosition;\n\n#endif\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\n\n\tvNormal = normalize( transformedNormal );\n\n\t#ifdef USE_TANGENT\n\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\n\t#endif\n\n#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\n\tvViewPosition = - mvPosition.xyz;\n\n#endif\n\n}\n",points_frag="\nuniform vec3 diffuse;\nuniform float opacity;\n\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\n\toutgoingLight = diffuseColor.rgb;\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",points_vert="\nuniform float size;\nuniform float scale;\n\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\n\tgl_PointSize = size;\n\n\t#ifdef USE_SIZEATTENUATION\n\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\n\t#endif\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n\n}\n",shadow_frag="\nuniform vec3 color;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n\nvoid main() {\n\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\n\t#include <fog_fragment>\n\n}\n",shadow_vert="\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n\nvoid main() {\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",sprite_frag="\nuniform vec3 diffuse;\nuniform float opacity;\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphatest_fragment>\n\n\toutgoingLight = diffuseColor.rgb;\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",sprite_vert="\nuniform float rotation;\nuniform vec2 center;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\n\t#ifndef USE_SIZEATTENUATION\n\n\t\tbool isPerspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 );\n\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\n\t#endif\n\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\n\tmvPosition.xy += rotatedPosition;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n}\n",ShaderChunk={alphamap_fragment:alphamap_fragment,alphamap_pars_fragment:alphamap_pars_fragment,alphatest_fragment:alphatest_fragment,aomap_fragment:aomap_fragment,aomap_pars_fragment:aomap_pars_fragment,begin_vertex:begin_vertex,beginnormal_vertex:beginnormal_vertex,bsdfs:bsdfs,bumpmap_pars_fragment:bumpmap_pars_fragment,clipping_planes_fragment:clipping_planes_fragment,clipping_planes_pars_fragment:clipping_planes_pars_fragment,clipping_planes_pars_vertex:clipping_planes_pars_vertex,clipping_planes_vertex:clipping_planes_vertex,color_fragment:color_fragment,color_pars_fragment:color_pars_fragment,color_pars_vertex:color_pars_vertex,color_vertex:color_vertex,common:common,cube_uv_reflection_fragment:cube_uv_reflection_fragment,defaultnormal_vertex:defaultnormal_vertex,displacementmap_pars_vertex:displacementmap_pars_vertex,displacementmap_vertex:displacementmap_vertex,emissivemap_fragment:emissivemap_fragment,emissivemap_pars_fragment:emissivemap_pars_fragment,encodings_fragment:encodings_fragment,encodings_pars_fragment:encodings_pars_fragment,envmap_fragment:envmap_fragment,envmap_pars_fragment:envmap_pars_fragment,envmap_pars_vertex:envmap_pars_vertex,envmap_physical_pars_fragment:envmap_physical_pars_fragment,envmap_vertex:envmap_vertex,fog_vertex:fog_vertex,fog_pars_vertex:fog_pars_vertex,fog_fragment:fog_fragment,fog_pars_fragment:fog_pars_fragment,gradientmap_pars_fragment:gradientmap_pars_fragment,lightmap_fragment:lightmap_fragment,lightmap_pars_fragment:lightmap_pars_fragment,lights_lambert_vertex:lights_lambert_vertex,lights_pars_begin:lights_pars_begin,lights_phong_fragment:lights_phong_fragment,lights_phong_pars_fragment:lights_phong_pars_fragment,lights_physical_fragment:lights_physical_fragment,lights_physical_pars_fragment:lights_physical_pars_fragment,lights_fragment_begin:lights_fragment_begin,lights_fragment_maps:lights_fragment_maps,lights_fragment_end:lights_fragment_end,logdepthbuf_fragment:logdepthbuf_fragment,logdepthbuf_pars_fragment:logdepthbuf_pars_fragment,logdepthbuf_pars_vertex:logdepthbuf_pars_vertex,logdepthbuf_vertex:logdepthbuf_vertex,map_fragment:map_fragment,map_pars_fragment:map_pars_fragment,map_particle_fragment:map_particle_fragment,map_particle_pars_fragment:map_particle_pars_fragment,metalnessmap_fragment:metalnessmap_fragment,metalnessmap_pars_fragment:metalnessmap_pars_fragment,morphnormal_vertex:morphnormal_vertex,morphtarget_pars_vertex:morphtarget_pars_vertex,morphtarget_vertex:morphtarget_vertex,normal_fragment_begin:normal_fragment_begin,normal_fragment_maps:normal_fragment_maps,normalmap_pars_fragment:normalmap_pars_fragment,packing:packing,premultiplied_alpha_fragment:premultiplied_alpha_fragment,project_vertex:project_vertex,dithering_fragment:dithering_fragment,dithering_pars_fragment:dithering_pars_fragment,roughnessmap_fragment:roughnessmap_fragment,roughnessmap_pars_fragment:roughnessmap_pars_fragment,shadowmap_pars_fragment:shadowmap_pars_fragment,shadowmap_pars_vertex:shadowmap_pars_vertex,shadowmap_vertex:shadowmap_vertex,shadowmask_pars_fragment:shadowmask_pars_fragment,skinbase_vertex:skinbase_vertex,skinning_pars_vertex:skinning_pars_vertex,skinning_vertex:skinning_vertex,skinnormal_vertex:skinnormal_vertex,specularmap_fragment:specularmap_fragment,specularmap_pars_fragment:specularmap_pars_fragment,tonemapping_fragment:tonemapping_fragment,tonemapping_pars_fragment:tonemapping_pars_fragment,uv_pars_fragment:uv_pars_fragment,uv_pars_vertex:uv_pars_vertex,uv_vertex:uv_vertex,uv2_pars_fragment:uv2_pars_fragment,uv2_pars_vertex:uv2_pars_vertex,uv2_vertex:uv2_vertex,worldpos_vertex:worldpos_vertex,background_frag:background_frag,background_vert:background_vert,cube_frag:cube_frag,cube_vert:cube_vert,depth_frag:depth_frag,depth_vert:depth_vert,distanceRGBA_frag:distanceRGBA_frag,distanceRGBA_vert:distanceRGBA_vert,equirect_frag:equirect_frag,equirect_vert:equirect_vert,linedashed_frag:linedashed_frag,linedashed_vert:linedashed_vert,meshbasic_frag:meshbasic_frag,meshbasic_vert:meshbasic_vert,meshlambert_frag:meshlambert_frag,meshlambert_vert:meshlambert_vert,meshmatcap_frag:meshmatcap_frag,meshmatcap_vert:meshmatcap_vert,meshphong_frag:meshphong_frag,meshphong_vert:meshphong_vert,meshphysical_frag:meshphysical_frag,meshphysical_vert:meshphysical_vert,normal_frag:normal_frag,normal_vert:normal_vert,points_frag:points_frag,points_vert:points_vert,shadow_frag:shadow_frag,shadow_vert:shadow_vert,sprite_frag:sprite_frag,sprite_vert:sprite_vert},UniformsLib={common:{diffuse:{value:new Color(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new Matrix3},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new Color(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},uvTransform:{value:new Matrix3}},sprite:{diffuse:{value:new Color(15658734)},opacity:{value:1},center:{value:new Vector2(.5,.5)},rotation:{value:0},map:{value:null},uvTransform:{value:new Matrix3}}},ShaderLib={basic:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.fog]),vertexShader:ShaderChunk.meshbasic_vert,fragmentShader:ShaderChunk.meshbasic_frag},lambert:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshlambert_vert,fragmentShader:ShaderChunk.meshlambert_frag},phong:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.gradientmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:ShaderChunk.meshphong_vert,fragmentShader:ShaderChunk.meshphong_frag},standard:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.roughnessmap,UniformsLib.metalnessmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag},matcap:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,{matcap:{value:null}}]),vertexShader:ShaderChunk.meshmatcap_vert,fragmentShader:ShaderChunk.meshmatcap_frag},points:{uniforms:mergeUniforms([UniformsLib.points,UniformsLib.fog]),vertexShader:ShaderChunk.points_vert,fragmentShader:ShaderChunk.points_frag},dashed:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ShaderChunk.linedashed_vert,fragmentShader:ShaderChunk.linedashed_frag},depth:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap]),vertexShader:ShaderChunk.depth_vert,fragmentShader:ShaderChunk.depth_frag},normal:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,{opacity:{value:1}}]),vertexShader:ShaderChunk.normal_vert,fragmentShader:ShaderChunk.normal_frag},sprite:{uniforms:mergeUniforms([UniformsLib.sprite,UniformsLib.fog]),vertexShader:ShaderChunk.sprite_vert,fragmentShader:ShaderChunk.sprite_frag},background:{uniforms:{uvTransform:{value:new Matrix3},t2D:{value:null}},vertexShader:ShaderChunk.background_vert,fragmentShader:ShaderChunk.background_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:ShaderChunk.cube_vert,fragmentShader:ShaderChunk.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ShaderChunk.equirect_vert,fragmentShader:ShaderChunk.equirect_frag},distanceRGBA:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap,{referencePosition:{value:new Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ShaderChunk.distanceRGBA_vert,fragmentShader:ShaderChunk.distanceRGBA_frag},shadow:{uniforms:mergeUniforms([UniformsLib.lights,UniformsLib.fog,{color:{value:new Color(0)},opacity:{value:1}}]),vertexShader:ShaderChunk.shadow_vert,fragmentShader:ShaderChunk.shadow_frag}};ShaderLib.physical={uniforms:mergeUniforms([ShaderLib.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag};var OutlineEffect=function(e,t){t=t||{},this.enabled=!0;var r=void 0!==t.defaultThickness?t.defaultThickness:.003,n=(new Color).fromArray(void 0!==t.defaultColor?t.defaultColor:[0,0,0]),o=void 0!==t.defaultAlpha?t.defaultAlpha:1,l=void 0!==t.defaultKeepAlive&&t.defaultKeepAlive,c={},h=60,d={},f={},m={MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical"},v={outlineThickness:{type:"f",value:r},outlineColor:{type:"c",value:n},outlineAlpha:{type:"f",value:o}},y=["#include <fog_pars_vertex>","uniform float outlineThickness;","vec4 calculateOutline( vec4 pos, vec3 objectNormal, vec4 skinned ) {","\tfloat thickness = outlineThickness;","\tconst float ratio = 1.0;","\tvec4 pos2 = projectionMatrix * modelViewMatrix * vec4( skinned.xyz + objectNormal, 1.0 );","\tvec4 norm = normalize( pos - pos2 );","\treturn pos + norm * thickness * pos.w * ratio;","}"].join("\n"),x=["#if ! defined( LAMBERT ) && ! defined( PHONG ) && ! defined( TOON ) && ! defined( PHYSICAL )","\t#ifndef USE_ENVMAP","\t\tvec3 objectNormal = normalize( normal );","\t#endif","#endif","#ifdef FLIP_SIDED","\tobjectNormal = -objectNormal;","#endif","#ifdef DECLARE_TRANSFORMED","\tvec3 transformed = vec3( position );","#endif","gl_Position = calculateOutline( gl_Position, objectNormal, vec4( transformed, 1.0 ) );","#include <fog_vertex>"].join("\n"),w=["#include <common>","#include <fog_pars_fragment>","uniform vec3 outlineColor;","uniform float outlineAlpha;","void main() {","\tgl_FragColor = vec4( outlineColor, outlineAlpha );","\t#include <fog_fragment>","}"].join("\n");function M(){return new ShaderMaterial({name:"invisible",visible:!1})}function S(e){var t,r,n=m[e.type];e.userData.outlineParameters;if(void 0!==n){var o=ShaderLib[n];t=o.uniforms,r=o.vertexShader}else if(!0===e.isRawShaderMaterial){if(t=e.uniforms,r=e.vertexShader,!/attribute\s+vec3\s+position\s*;/.test(r)||!/attribute\s+vec3\s+normal\s*;/.test(r))return console.warn("OutlineEffect requires both vec3 position and normal attributes in vertex shader, does not draw outline for "+e.name+"(uuid:"+e.uuid+") material."),M()}else{if(!0!==e.isShaderMaterial)return M();t=e.uniforms,r=e.vertexShader}var l=Object.assign({},t,v),c=r.replace(/void\s+main\s*\(\s*\)/,y+"\nvoid main()").replace(/\}\s*$/,x+"\n}").replace(/#include\s+<[\w_]*light[\w_]*>/g,""),h={};return/vec3\s+transformed\s*=/.test(r)||/#include\s+<begin_vertex>/.test(r)||(h.DECLARE_TRANSFORMED=!0),new ShaderMaterial({defines:h,uniforms:l,vertexShader:c,fragmentShader:w,side:BackSide,skinning:!1,morphTargets:!1,morphNormals:!1,fog:!1})}function A(e){var t=function(e){var data=c[e.uuid];return void 0===data&&(data={material:S(e),used:!0,keepAlive:l,count:0},c[e.uuid]=data),data.used=!0,data.material}(e);return d[t.uuid]=e,function(e,t){if("invisible"===e.name)return;var r=t.userData.outlineParameters;e.skinning=t.skinning,e.morphTargets=t.morphTargets,e.morphNormals=t.morphNormals,e.fog=t.fog,void 0!==r?(!1===t.visible?e.visible=!1:e.visible=void 0===r.visible||r.visible,e.transparent=void 0!==r.alpha&&r.alpha<1||t.transparent,void 0!==r.keepAlive&&(c[t.uuid].keepAlive=r.keepAlive)):(e.transparent=t.transparent,e.visible=t.visible);!0!==t.wireframe&&!1!==t.depthTest||(e.visible=!1)}(t,e),t}function T(object){if(void 0!==object.material){if(Array.isArray(object.material))for(var i=0,e=object.material.length;i<e;i++)object.material[i]=A(object.material[i]);else object.material=A(object.material);f[object.uuid]=object.onBeforeRender,object.onBeforeRender=L}}function _(object){if(void 0!==object.material){if(Array.isArray(object.material))for(var i=0,e=object.material.length;i<e;i++)object.material[i]=d[object.material[i].uuid];else object.material=d[object.material.uuid];object.onBeforeRender=f[object.uuid]}}function L(e,t,r,n,o,l){var c=d[o.uuid];void 0!==c&&function(e,t){var r=t.userData.outlineParameters;e.uniforms.outlineAlpha.value=t.opacity,void 0!==r&&(void 0!==r.thickness&&(e.uniforms.outlineThickness.value=r.thickness),void 0!==r.color&&e.uniforms.outlineColor.value.fromArray(r.color),void 0!==r.alpha&&(e.uniforms.outlineAlpha.value=r.alpha))}(o,c)}function C(){for(var e,i=0,t=(e=Object.keys(d)).length;i<t;i++)d[e[i]]=void 0;for(i=0,t=(e=Object.keys(f)).length;i<t;i++)f[e[i]]=void 0;for(i=0,t=(e=Object.keys(c)).length;i<t;i++){var r=e[i];!1===c[r].used?(c[r].count++,!1===c[r].keepAlive&&c[r].count>h&&delete c[r]):(c[r].used=!1,c[r].count=0)}}this.render=function(t,r){var n=null,o=!1;if(void 0!==arguments[2]&&(console.warn("OutlineEffect.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),n=arguments[2]),void 0!==arguments[3]&&(console.warn("OutlineEffect.render(): the forceClear argument has been removed. Use .clear() instead."),o=arguments[3]),e.setRenderTarget(n),o&&e.clear(),!1!==this.enabled){var l=e.autoClear;e.autoClear=this.autoClear,e.render(t,r);var c=t.autoUpdate,h=t.background,d=e.shadowMap.enabled;t.autoUpdate=!1,t.background=null,e.autoClear=!1,e.shadowMap.enabled=!1,t.traverse(T),e.render(t,r),t.traverse(_),C(),t.autoUpdate=c,t.background=h,e.autoClear=l,e.shadowMap.enabled=d}else e.render(t,r)},this.autoClear=e.autoClear,this.domElement=e.domElement,this.shadowMap=e.shadowMap,this.clear=function(t,r,n){e.clear(t,r,n)},this.getPixelRatio=function(){return e.getPixelRatio()},this.setPixelRatio=function(t){e.setPixelRatio(t)},this.getSize=function(t){return e.getSize(t)},this.setSize=function(t,r,n){e.setSize(t,r,n)},this.setViewport=function(t,r,n,o){e.setViewport(t,r,n,o)},this.setScissor=function(t,r,n,o){e.setScissor(t,r,n,o)},this.setScissorTest=function(t){e.setScissorTest(t)},this.setRenderTarget=function(t){e.setRenderTarget(t)}},ParallaxBarrierEffect=function(e){var t=new OrthographicCamera(-1,1,1,-1,0,1),r=new Scene,n=new StereoCamera,o={minFilter:LinearFilter,magFilter:NearestFilter,format:RGBAFormat},l=new WebGLRenderTarget(512,512,o),c=new WebGLRenderTarget(512,512,o),h=new ShaderMaterial({uniforms:{mapLeft:{value:l.texture},mapRight:{value:c.texture}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = vec2( uv.x, uv.y );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D mapLeft;","uniform sampler2D mapRight;","varying vec2 vUv;","void main() {","\tvec2 uv = vUv;","\tif ( ( mod( gl_FragCoord.y, 2.0 ) ) > 1.00 ) {","\t\tgl_FragColor = texture2D( mapLeft, uv );","\t} else {","\t\tgl_FragColor = texture2D( mapRight, uv );","\t}","}"].join("\n")}),d=new Mesh(new PlaneBufferGeometry(2,2),h);r.add(d),this.setSize=function(t,r){e.setSize(t,r);var n=e.getPixelRatio();l.setSize(t*n,r*n),c.setSize(t*n,r*n)},this.render=function(o,h){o.updateMatrixWorld(),null===h.parent&&h.updateMatrixWorld(),n.update(h),e.setRenderTarget(l),e.clear(),e.render(o,n.cameraL),e.setRenderTarget(c),e.clear(),e.render(o,n.cameraR),e.setRenderTarget(null),e.render(r,t)}},PeppersGhostEffect=function(e){var t,r,n,o=this;o.cameraDistance=15,o.reflectFromAbove=!1;var l=new PerspectiveCamera,c=new PerspectiveCamera,h=new PerspectiveCamera,d=new PerspectiveCamera,f=new Vector3,m=new Quaternion,v=new Vector3;e.autoClear=!1,this.setSize=function(o,l){t=o/2,o<l?(r=o/3,n=o/3):(r=l/3,n=l/3),e.setSize(o,l)},this.render=function(y,x){y.updateMatrixWorld(),null===x.parent&&x.updateMatrixWorld(),x.matrixWorld.decompose(f,m,v),l.position.copy(f),l.quaternion.copy(m),l.translateZ(o.cameraDistance),l.lookAt(y.position),c.position.copy(f),c.quaternion.copy(m),c.translateZ(-o.cameraDistance),c.lookAt(y.position),c.rotation.z+=Math.PI/180*180,h.position.copy(f),h.quaternion.copy(m),h.translateX(-o.cameraDistance),h.lookAt(y.position),h.rotation.x+=Math.PI/180*90,d.position.copy(f),d.quaternion.copy(m),d.translateX(o.cameraDistance),d.lookAt(y.position),d.rotation.x+=Math.PI/180*90,e.clear(),e.setScissorTest(!0),e.setScissor(t-r/2,2*n,r,n),e.setViewport(t-r/2,2*n,r,n),o.reflectFromAbove?e.render(y,c):e.render(y,l),e.setScissor(t-r/2,0,r,n),e.setViewport(t-r/2,0,r,n),o.reflectFromAbove?e.render(y,l):e.render(y,c),e.setScissor(t-r/2-r,n,r,n),e.setViewport(t-r/2-r,n,r,n),o.reflectFromAbove?e.render(y,d):e.render(y,h),e.setScissor(t+r/2,n,r,n),e.setViewport(t+r/2,n,r,n),o.reflectFromAbove?e.render(y,h):e.render(y,d),e.setScissorTest(!1)}},StereoEffect=function(e){var t=new StereoCamera;t.aspect=.5;var r=new Vector2;this.setEyeSeparation=function(e){t.eyeSep=e},this.setSize=function(t,r){e.setSize(t,r)},this.render=function(n,o){n.updateMatrixWorld(),null===o.parent&&o.updateMatrixWorld(),t.update(o),e.getSize(r),e.autoClear&&e.clear(),e.setScissorTest(!0),e.setScissor(0,0,r.width/2,r.height),e.setViewport(0,0,r.width/2,r.height),e.render(n,t.cameraL),e.setScissor(r.width/2,0,r.width/2,r.height),e.setViewport(r.width/2,0,r.width/2,r.height),e.render(n,t.cameraR),e.setScissorTest(!1)}};function MeshLambertMaterial(e){Material$1.call(this),this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}MeshLambertMaterial.prototype=Object.create(Material$1.prototype),MeshLambertMaterial.prototype.constructor=MeshLambertMaterial,MeshLambertMaterial.prototype.isMeshLambertMaterial=!0,MeshLambertMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.map=source.map,this.lightMap=source.lightMap,this.lightMapIntensity=source.lightMapIntensity,this.aoMap=source.aoMap,this.aoMapIntensity=source.aoMapIntensity,this.emissive.copy(source.emissive),this.emissiveMap=source.emissiveMap,this.emissiveIntensity=source.emissiveIntensity,this.specularMap=source.specularMap,this.alphaMap=source.alphaMap,this.envMap=source.envMap,this.combine=source.combine,this.reflectivity=source.reflectivity,this.refractionRatio=source.refractionRatio,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.wireframeLinecap=source.wireframeLinecap,this.wireframeLinejoin=source.wireframeLinejoin,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this};var ColladaExporter=function(){};ColladaExporter.prototype={constructor:ColladaExporter,parse:function(object,e,t){void 0===t&&(t={}),""!==(t=Object.assign({version:"1.4.1",author:null,textureDirectory:""},t)).textureDirectory&&(t.textureDirectory=(t.textureDirectory+"/").replace(/\\/g,"/").replace(/\/+/g,"/"));var canvas,r,n=t.version;if("1.4.1"!==n&&"1.5.0"!==n)return console.warn("ColladaExporter : Version "+n+" not supported for export. Only 1.4.1 and 1.5.0."),null;function o(image,e){return canvas=canvas||document.createElement("canvas"),r=r||canvas.getContext("2d"),canvas.width=image.naturalWidth,canvas.height=image.naturalHeight,r.drawImage(image,0,0),function(e){for(var b=atob(e),t=new Uint8Array(b.length),i=0,r=t.length;i<r;i++)t[i]=b.charCodeAt(i);return t}(canvas.toDataURL("image/"+e,1).replace(/^data:image\/(png|jpg);base64,/,""))}var l,c=["getX","getY","getZ","getW"];function h(e){if(e.isInterleavedBufferAttribute){for(var t=new e.array.constructor(e.count*e.itemSize),r=e.itemSize,i=0,n=e.count;i<n;i++)for(var o=0;o<r;o++)t[i*r+o]=e[c[o]](i);return t}return e.array}function d(e,t,r,n){var o=h(e);return'<source id="'+t+'"><float_array id="'+t+'-array" count="'+o.length+'">'+o.join(" ")+'</float_array><technique_common><accessor source="#'+t+'-array" count="'+Math.floor(o.length/e.itemSize)+'" stride="'+e.itemSize+'">'+r.map((function(e){return'<param name="'+e+'" type="'+n+'" />'})).join("")+"</accessor></technique_common></source>"}function f(e){var r=y.get(e);if(null==r){r="image-"+(w.length+1);var l=e.name||r,c='<image id="'+r+'" name="'+l+'">';c+="1.5.0"===n?"<init_from><ref>"+t.textureDirectory+l+".png</ref></init_from>":"<init_from>"+t.textureDirectory+l+".png</init_from>",c+="</image>",w.push(c),y.set(e,r),x.push({directory:t.textureDirectory,name:l,ext:"png",data:o(e.image,"png"),original:e})}return r}var m=new WeakMap,v=new WeakMap,y=new WeakMap,x=[],w=[],M=[],S=[],A=[],T=function e(t){var r='<node name="'+t.name+'">';if(r+=function(e){return e.updateMatrix(),(l=l||new Matrix4).copy(e.matrix),l.transpose(),"<matrix>"+l.toArray().join(" ")+"</matrix>"}(t),t instanceof Mesh&&null!=t.geometry){var n=function(g){var e,t,r,n=m.get(g);if(!n){var o=g;o instanceof Geometry&&(o=(new BufferGeometry).fromGeometry(o));var l="Mesh"+(M.length+1),c=o.index?o.index.count*o.index.itemSize:o.attributes.position.count,f=null!=o.groups&&0!==o.groups.length?o.groups:[{start:0,count:c,materialIndex:0}],v='<geometry id="'+l+'" name="'+g.name+'"><mesh>',y=l+"-position",x=l+"-vertices";v+=d(o.attributes.position,y,["X","Y","Z"],"float"),v+='<vertices id="'+x+'"><input semantic="POSITION" source="#'+y+'" /></vertices>';var w='<input semantic="VERTEX" source="#'+x+'" offset="0" />';if("normal"in o.attributes){var S=l+"-normal";v+=d(o.attributes.normal,S,["X","Y","Z"],"float"),w+='<input semantic="NORMAL" source="#'+S+'" offset="0" />'}if("uv"in o.attributes){var A=l+"-texcoord";v+=d(o.attributes.uv,A,["S","T"],"float"),w+='<input semantic="TEXCOORD" source="#'+A+'" offset="0" set="0" />'}if("color"in o.attributes){var T=l+"-color";v+=d(o.attributes.color,T,["X","Y","Z"],"uint8"),w+='<input semantic="COLOR" source="#'+T+'" offset="0" />'}var _=null;if(o.index)_=h(o.index);else for(var i=0,L=(_=new Array(c)).length;i<L;i++)_[i]=i;for(i=0,L=f.length;i<L;i++){var C=f[i],N=(e=_,t=C.start,r=C.count,Array.isArray(e)?e.slice(t,t+r):new e.constructor(e.buffer,t*e.BYTES_PER_ELEMENT,r)),P=N.length/3;v+='<triangles material="MESH_MATERIAL_'+C.materialIndex+'" count="'+P+'">',v+=w,v+="<p>"+N.join(" ")+"</p>",v+="</triangles>"}v+="</mesh></geometry>",M.push(v),n={meshid:l,bufferGeometry:o},m.set(g,n)}return n}(t.geometry),o=n.meshid,c=n.bufferGeometry,y=null,x=t.material||new MeshBasicMaterial,w=Array.isArray(x)?x:[x];y=(c.groups.length>w.length?new Array(c.groups.length):new Array(w.length)).fill().map((function(e,i){return function(e){var t=v.get(e);if(null==t){t="Mat"+(S.length+1);var r="phong";e instanceof MeshLambertMaterial?r="lambert":e instanceof MeshBasicMaterial&&(r="constant",null!==e.map&&console.warn("ColladaExporter: Texture maps not supported with MeshBasicMaterial."));var n=e.emissive?e.emissive:new Color(0,0,0),o=e.color?e.color:new Color(0,0,0),l=e.specular?e.specular:new Color(1,1,1),c=e.shininess||0,h=e.reflectivity||0,d="";!0===e.transparent&&(d+="<transparent>"+(e.map?'<texture texture="diffuse-sampler"></texture>':"<float>1</float>")+"</transparent>",e.opacity<1&&(d+="<transparency><float>"+e.opacity+"</float></transparency>"));var m='<technique sid="common"><'+r+"><emission>"+(e.emissiveMap?'<texture texture="emissive-sampler" texcoord="TEXCOORD" />':'<color sid="emission">'+n.r+" "+n.g+" "+n.b+" 1</color>")+"</emission>"+("constant"!==r?"<diffuse>"+(e.map?'<texture texture="diffuse-sampler" texcoord="TEXCOORD" />':'<color sid="diffuse">'+o.r+" "+o.g+" "+o.b+" 1</color>")+"</diffuse>":"")+("phong"===r?'<specular><color sid="specular">'+l.r+" "+l.g+" "+l.b+" 1</color></specular><shininess>"+(e.specularMap?'<texture texture="specular-sampler" texcoord="TEXCOORD" />':'<float sid="shininess">'+c+"</float>")+"</shininess>":"")+"<reflective><color>"+o.r+" "+o.g+" "+o.b+" 1</color></reflective><reflectivity><float>"+h+"</float></reflectivity>"+d+"</"+r+"></technique>",y='<effect id="'+t+'-effect"><profile_COMMON>'+(e.map?'<newparam sid="diffuse-surface"><surface type="2D"><init_from>'+f(e.map)+'</init_from></surface></newparam><newparam sid="diffuse-sampler"><sampler2D><source>diffuse-surface</source></sampler2D></newparam>':"")+(e.specularMap?'<newparam sid="specular-surface"><surface type="2D"><init_from>'+f(e.specularMap)+'</init_from></surface></newparam><newparam sid="specular-sampler"><sampler2D><source>specular-surface</source></sampler2D></newparam>':"")+(e.emissiveMap?'<newparam sid="emissive-surface"><surface type="2D"><init_from>'+f(e.emissiveMap)+'</init_from></surface></newparam><newparam sid="emissive-sampler"><sampler2D><source>emissive-surface</source></sampler2D></newparam>':"")+m+(e.side===DoubleSide?'<extra><technique><double_sided sid="double_sided" type="int">1</double_sided></technique></extra>':"")+"</profile_COMMON></effect>";A.push('<material id="'+t+'" name="'+e.name+'"><instance_effect url="#'+t+'-effect" /></material>'),S.push(y),v.set(e,t)}return t}(w[i%w.length])})),r+='<instance_geometry url="#'+o+'">'+(null!=y?"<bind_material><technique_common>"+y.map((function(e,i){return'<instance_material symbol="MESH_MATERIAL_'+i+'" target="#'+e+'" ><bind_vertex_input semantic="TEXCOORD" input_semantic="TEXCOORD" input_set="0" /></instance_material>'})).join("")+"</technique_common></bind_material>":"")+"</instance_geometry>"}return t.children.forEach((function(t){return r+=e(t)})),r+="</node>"}(object),_='<?xml version="1.0" encoding="UTF-8" standalone="no" ?><COLLADA xmlns="'+("1.4.1"===n?"http://www.collada.org/2005/11/COLLADASchema":"https://www.khronos.org/collada/")+'" version="'+n+'"><asset><contributor><authoring_tool>js Collada Exporter</authoring_tool>'+(null!==t.author?"<author>"+t.author+"</author>":"")+"</contributor><created>"+(new Date).toISOString()+"</created><modified>"+(new Date).toISOString()+"</modified><up_axis>Y_UP</up_axis></asset>";_+="<library_images>"+w.join("")+"</library_images>",_+="<library_effects>"+S.join("")+"</library_effects>",_+="<library_materials>"+A.join("")+"</library_materials>",_+="<library_geometries>"+M.join("")+"</library_geometries>",_+='<library_visual_scenes><visual_scene id="Scene" name="scene">'+T+"</visual_scene></library_visual_scenes>",_+='<scene><instance_visual_scene url="#Scene"/></scene>';var L,C,N,P,E,D,F={data:(L=_+="</COLLADA>",C=/^<\//,N=/(\?>$)|(\/>$)/,P=/<[^>]+>[^<]*<\/[^<]+>/,E=function(e,t){return t>0?e+E(e,t-1):""},D=0,L.match(/(<[^>]+>[^<]+<\/[^<]+>)|(<[^>]+>)/g).map((function(e){P.test(e)||N.test(e)||!C.test(e)||D--;var t=""+E("  ",D)+e;return P.test(e)||N.test(e)||C.test(e)||D++,t})).join("\n")),textures:x};return"function"==typeof e&&requestAnimationFrame((function(){return e(F)})),F}};var WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},THREE_TO_WEBGL={};THREE_TO_WEBGL[NearestFilter]=WEBGL_CONSTANTS.NEAREST,THREE_TO_WEBGL[NearestMipMapNearestFilter]=WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,THREE_TO_WEBGL[NearestMipMapLinearFilter]=WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,THREE_TO_WEBGL[LinearFilter]=WEBGL_CONSTANTS.LINEAR,THREE_TO_WEBGL[LinearMipMapNearestFilter]=WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,THREE_TO_WEBGL[LinearMipMapLinearFilter]=WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR,THREE_TO_WEBGL[ClampToEdgeWrapping]=WEBGL_CONSTANTS.CLAMP_TO_EDGE,THREE_TO_WEBGL[RepeatWrapping]=WEBGL_CONSTANTS.REPEAT,THREE_TO_WEBGL[MirroredRepeatWrapping]=WEBGL_CONSTANTS.MIRRORED_REPEAT;var PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},GLTFExporter=function(){};GLTFExporter.prototype={constructor:GLTFExporter,parse:function(input,e,t){(t=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1},t)).animations.length>0&&(t.trs=!0);var r,n={asset:{version:"2.0",generator:"GLTFExporter"}},o=0,l=[],c=[],h=new Map,d=[],f={},m={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map};function v(e,t){return e.length===t.length&&e.every((function(element,e){return element===t[e]}))}function y(e){return 4*Math.ceil(e/4)}function x(e,t){t=t||0;var r=y(e.byteLength);if(r!==e.byteLength){var n=new Uint8Array(r);if(n.set(new Uint8Array(e)),0!==t)for(var i=e.byteLength;i<r;i++)n[i]=t;return n.buffer}return e}function w(object){try{return JSON.parse(JSON.stringify(object.userData))}catch(e){return console.warn("GLTFExporter: userData of '"+object.name+"' won't be serialized because of JSON.stringify error - "+e.message),{}}}function M(e,t){var r=!1,n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(n.rotation=t.rotation,r=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,f.KHR_texture_transform=!0)}function S(e){return n.buffers||(n.buffers=[{byteLength:0}]),l.push(e),0}function A(e,r,l,c){var h;if(e.array.constructor===Float32Array)h=WEBGL_CONSTANTS.FLOAT;else if(e.array.constructor===Uint32Array)h=WEBGL_CONSTANTS.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)h=WEBGL_CONSTANTS.UNSIGNED_SHORT;else{if(e.array.constructor!==Uint8Array)throw new Error("GLTFExporter: Unsupported bufferAttribute component type.");h=WEBGL_CONSTANTS.UNSIGNED_BYTE}if(void 0===l&&(l=0),void 0===c&&(c=e.count),t.truncateDrawRange&&void 0!==r&&null===r.index){var d=l+c,f=r.drawRange.count===1/0?e.count:r.drawRange.start+r.drawRange.count;l=Math.max(l,r.drawRange.start),(c=Math.min(d,f)-l)<0&&(c=0)}if(0===c)return null;var m,v=function(e,t,r){for(var output={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},i=t;i<t+r;i++)for(var a=0;a<e.itemSize;a++){var n=e.array[i*e.itemSize+a];output.min[a]=Math.min(output.min[a],n),output.max[a]=Math.max(output.max[a],n)}return output}(e,l,c);void 0!==r&&(m=e===r.index?WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER:WEBGL_CONSTANTS.ARRAY_BUFFER);var x=function(e,t,r,l,c){var h;n.bufferViews||(n.bufferViews=[]),h=t===WEBGL_CONSTANTS.UNSIGNED_BYTE?1:t===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4;for(var d=y(l*e.itemSize*h),f=new DataView(new ArrayBuffer(d)),m=0,i=r;i<r+l;i++)for(var a=0;a<e.itemSize;a++){var v=e.array[i*e.itemSize+a];t===WEBGL_CONSTANTS.FLOAT?f.setFloat32(m,v,!0):t===WEBGL_CONSTANTS.UNSIGNED_INT?f.setUint32(m,v,!0):t===WEBGL_CONSTANTS.UNSIGNED_SHORT?f.setUint16(m,v,!0):t===WEBGL_CONSTANTS.UNSIGNED_BYTE&&f.setUint8(m,v),m+=h}var x={buffer:S(f.buffer),byteOffset:o,byteLength:d};return void 0!==c&&(x.target=c),c===WEBGL_CONSTANTS.ARRAY_BUFFER&&(x.byteStride=e.itemSize*h),o+=d,n.bufferViews.push(x),{id:n.bufferViews.length-1,byteLength:0}}(e,h,l,c,m),w={bufferView:x.id,byteOffset:x.byteOffset,componentType:h,count:c,max:v.max,min:v.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return n.accessors||(n.accessors=[]),n.accessors.push(w),n.accessors.length-1}function T(image,e,l){m.images.has(image)||m.images.set(image,{});var h=m.images.get(image),d=e===RGBAFormat?"image/png":"image/jpeg",f=d+":flipY/"+l.toString();if(void 0!==h[f])return h[f];n.images||(n.images=[]);var v={mimeType:d};if(t.embedImages){var canvas=r=r||document.createElement("canvas");canvas.width=image.width,canvas.height=image.height,t.forcePowerOfTwoTextures&&!function(image){return _Math.isPowerOfTwo(image.width)&&_Math.isPowerOfTwo(image.height)}(image)&&(console.warn("GLTFExporter: Resized non-power-of-two image.",image),canvas.width=_Math.floorPowerOfTwo(canvas.width),canvas.height=_Math.floorPowerOfTwo(canvas.height));var y=canvas.getContext("2d");!0===l&&(y.translate(0,canvas.height),y.scale(1,-1)),y.drawImage(image,0,0,canvas.width,canvas.height),!0===t.binary?c.push(new Promise((function(e){canvas.toBlob((function(t){(function(e){return n.bufferViews||(n.bufferViews=[]),new Promise((function(t){var r=new window.FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){var e=x(r.result),l={buffer:S(e),byteOffset:o,byteLength:e.byteLength};o+=e.byteLength,n.bufferViews.push(l),t(n.bufferViews.length-1)}}))})(t).then((function(t){v.bufferView=t,e()}))}),d)}))):v.uri=canvas.toDataURL(d)}else v.uri=image.src;n.images.push(v);var w=n.images.length-1;return h[f]=w,w}function _(map){n.samplers||(n.samplers=[]);var e={magFilter:THREE_TO_WEBGL[map.magFilter],minFilter:THREE_TO_WEBGL[map.minFilter],wrapS:THREE_TO_WEBGL[map.wrapS],wrapT:THREE_TO_WEBGL[map.wrapT]};return n.samplers.push(e),n.samplers.length-1}function L(map){if(m.textures.has(map))return m.textures.get(map);n.textures||(n.textures=[]);var e={sampler:_(map),source:T(map.image,map.format,map.flipY)};n.textures.push(e);var t=n.textures.length-1;return m.textures.set(map,t),t}function C(e){if(m.materials.has(e))return m.materials.get(e);if(n.materials||(n.materials=[]),e.isShaderMaterial)return console.warn("GLTFExporter: ShaderMaterial not supported."),null;var t={pbrMetallicRoughness:{}};e.isMeshBasicMaterial?(t.extensions={KHR_materials_unlit:{}},f.KHR_materials_unlit=!0):e.isMeshStandardMaterial||console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var r=e.color.toArray().concat([e.opacity]);if(v(r,[1,1,1,1])||(t.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(t.pbrMetallicRoughness.metallicFactor=e.metalness,t.pbrMetallicRoughness.roughnessFactor=e.roughness):e.isMeshBasicMaterial?(t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9):(t.pbrMetallicRoughness.metallicFactor=.5,t.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){var o={index:L(e.metalnessMap)};M(o,e.metalnessMap),t.pbrMetallicRoughness.metallicRoughnessTexture=o}else console.warn("GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){var l={index:L(e.map)};M(l,e.map),t.pbrMetallicRoughness.baseColorTexture=l}if(e.isMeshBasicMaterial||e.isLineBasicMaterial||e.isPointsMaterial);else{var c=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(v(c,[0,0,0])||(t.emissiveFactor=c),e.emissiveMap){var h={index:L(e.emissiveMap)};M(h,e.emissiveMap),t.emissiveTexture=h}}if(e.normalMap){var d={index:L(e.normalMap)};-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),d.scale=e.normalScale.x),M(d,e.normalMap),t.normalTexture=d}if(e.aoMap){var y={index:L(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(y.strength=e.aoMapIntensity),M(y,e.aoMap),t.occlusionTexture=y}(e.transparent||e.alphaTest>0)&&(t.alphaMode=e.opacity<1?"BLEND":"MASK",e.alphaTest>0&&.5!==e.alphaTest&&(t.alphaCutoff=e.alphaTest)),e.side===DoubleSide&&(t.doubleSided=!0),""!==e.name&&(t.name=e.name),Object.keys(e.userData).length>0&&(t.extras=w(e)),n.materials.push(t);var x=n.materials.length-1;return m.materials.set(e,x),x}function N(e){var r=e.geometry.uuid+":"+e.material.uuid;if(m.meshes.has(r))return m.meshes.get(r);var o,l=e.geometry;if(e.isLineSegments)o=WEBGL_CONSTANTS.LINES;else if(e.isLineLoop)o=WEBGL_CONSTANTS.LINE_LOOP;else if(e.isLine)o=WEBGL_CONSTANTS.LINE_STRIP;else if(e.isPoints)o=WEBGL_CONSTANTS.POINTS;else{if(!l.isBufferGeometry){console.warn("GLTFExporter: Exporting Geometry will increase file size. Use BufferGeometry instead.");var c=new BufferGeometry;c.fromGeometry(l),l=c}e.drawMode===TriangleFanDrawMode?(console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible."),o=WEBGL_CONSTANTS.TRIANGLE_FAN):o=e.drawMode===TriangleStripDrawMode?e.material.wireframe?WEBGL_CONSTANTS.LINE_STRIP:WEBGL_CONSTANTS.TRIANGLE_STRIP:e.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES}var h={},d={},f=[],v=[],y={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},x=l.getAttribute("normal");void 0===x||function(e){if(m.attributesNormalized.has(e))return!1;for(var t=new Vector3,i=0,r=e.count;i<r;i++)if(Math.abs(t.fromArray(e.array,3*i).length()-1)>5e-4)return!1;return!0}(x)||(console.warn("GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.addAttribute("normal",function(e){if(m.attributesNormalized.has(e))return m.attributesNormalized.get(e);for(var t=e.clone(),r=new Vector3,i=0,n=t.count;i<n;i++)r.fromArray(t.array,3*i),0===r.x&&0===r.y&&0===r.z?r.setX(1):r.normalize(),r.toArray(t.array,3*i);return m.attributesNormalized.set(e,t),t}(x)));var M=null;for(var S in l.attributes){var T=l.attributes[S];if(S=y[S]||S.toUpperCase(),m.attributes.has(T))d[S]=m.attributes.get(T);else{M=null;var _=T.array;if("JOINTS_0"!==S||_ instanceof Uint16Array||_ instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),M=new BufferAttribute(new Uint16Array(_),T.itemSize,T.normalized)),"MORPH"!==S.substr(0,5)){var L=A(M||T,l);null!==L&&(d[S]=L,m.attributes.set(T,L))}}}if(void 0!==x&&l.addAttribute("normal",x),0===Object.keys(d).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var N=[],P=[],E={};if(void 0!==e.morphTargetDictionary)for(var D in e.morphTargetDictionary)E[e.morphTargetDictionary[D]]=D;for(var i=0;i<e.morphTargetInfluences.length;++i){var F={},R=!1;for(var S in l.morphAttributes)if("position"===S||"normal"===S){T=l.morphAttributes[S][i];var O=S.toUpperCase(),B=l.attributes[S];if(m.attributes.has(T))F[O]=m.attributes.get(T);else{for(var I=T.clone(),U=0,V=T.count;U<V;U++)I.setXYZ(U,T.getX(U)-B.getX(U),T.getY(U)-B.getY(U),T.getZ(U)-B.getZ(U));F[O]=A(I,l),m.attributes.set(B,F[O])}}else R||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),R=!0);v.push(F),N.push(e.morphTargetInfluences[i]),void 0!==e.morphTargetDictionary&&P.push(E[i])}h.weights=N,P.length>0&&(h.extras={},h.extras.targetNames=P)}var k=Object.keys(l.userData).length>0?w(l):void 0,G=t.forceIndices,z=Array.isArray(e.material);if(z&&0===l.groups.length)return null;!G&&null===l.index&&z&&(console.warn("GLTFExporter: Creating index for non-indexed multi-material mesh."),G=!0);var j=!1;if(null===l.index&&G){for(var W=[],H=(i=0,l.attributes.position.count);i<H;i++)W[i]=i;l.setIndex(W),j=!0}var X=z?e.material:[e.material],Y=z?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(i=0,H=Y.length;i<H;i++){var Q={mode:o,attributes:d};k&&(Q.extras=k),v.length>0&&(Q.targets=v),null!==l.index&&(m.attributes.has(l.index)?Q.indices=m.attributes.get(l.index):(Q.indices=A(l.index,l,Y[i].start,Y[i].count),m.attributes.set(l.index,Q.indices)));var K=C(X[Y[i].materialIndex]);null!==K&&(Q.material=K),f.push(Q)}j&&l.setIndex(null),h.primitives=f,n.meshes||(n.meshes=[]),n.meshes.push(h);var J=n.meshes.length-1;return m.meshes.set(r,J),J}function P(e,t){n.animations||(n.animations=[]);for(var r=(e=GLTFExporter.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,o=[],l=[],i=0;i<r.length;++i){var track=r[i],c=PropertyBinding.parseTrackName(track.name),d=PropertyBinding.findNode(t,c.nodeName),f=PATH_PROPERTIES[c.propertyName];if("bones"===c.objectName&&(d=!0===d.isSkinnedMesh?d.skeleton.getBoneByName(c.objectIndex):void 0),!d||!f)return console.warn('GLTFExporter: Could not export animation track "%s".',track.name),null;var m,v=track.values.length/track.times.length;f===PATH_PROPERTIES.morphTargetInfluences&&(v/=d.morphTargetInfluences.length),!0===track.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(m="CUBICSPLINE",v/=3):m=track.getInterpolation()===InterpolateDiscrete?"STEP":"LINEAR",l.push({input:A(new BufferAttribute(track.times,1)),output:A(new BufferAttribute(track.values,v)),interpolation:m}),o.push({sampler:l.length-1,target:{node:h.get(d),path:f}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:l,channels:o}),n.animations.length-1}function E(object){var e=n.nodes[h.get(object)],t=object.skeleton,r=object.skeleton.bones[0];if(void 0===r)return null;for(var o=[],l=new Float32Array(16*t.bones.length),i=0;i<t.bones.length;++i)o.push(h.get(t.bones[i])),t.boneInverses[i].toArray(l,16*i);return void 0===n.skins&&(n.skins=[]),n.skins.push({inverseBindMatrices:A(new BufferAttribute(l,16)),joints:o,skeleton:h.get(r)}),e.skin=n.skins.length-1}function D(e){var t={};e.name&&(t.name=e.name),t.color=e.color.toArray(),t.intensity=e.intensity,e.isDirectionalLight?t.type="directional":e.isPointLight?(t.type="point",e.distance>0&&(t.range=e.distance)):e.isSpotLight&&(t.type="spot",e.distance>0&&(t.range=e.distance),t.spot={},t.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,t.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1.");var r=n.extensions.KHR_lights_punctual.lights;return r.push(t),r.length-1}function F(object){n.nodes||(n.nodes=[]);var e={};if(t.trs){var r=object.quaternion.toArray(),o=object.position.toArray(),l=object.scale.toArray();v(r,[0,0,0,1])||(e.rotation=r),v(o,[0,0,0])||(e.translation=o),v(l,[1,1,1])||(e.scale=l)}else object.updateMatrix(),v(object.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(e.matrix=object.matrix.elements);if(""!==object.name&&(e.name=String(object.name)),object.userData&&Object.keys(object.userData).length>0&&(e.extras=w(object)),object.isMesh||object.isLine||object.isPoints){var c=N(object);null!==c&&(e.mesh=c)}else if(object.isCamera)e.camera=function(e){n.cameras||(n.cameras=[]);var t=e.isOrthographicCamera,r={type:t?"orthographic":"perspective"};return t?r.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:_Math.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(r.name=e.type),n.cameras.push(r),n.cameras.length-1}(object);else if(object.isDirectionalLight||object.isPointLight||object.isSpotLight)f.KHR_lights_punctual||(n.extensions=n.extensions||{},n.extensions.KHR_lights_punctual={lights:[]},f.KHR_lights_punctual=!0),e.extensions=e.extensions||{},e.extensions.KHR_lights_punctual={light:D(object)};else if(object.isLight)return console.warn("GLTFExporter: Only directional, point, and spot lights are supported."),null;if(object.isSkinnedMesh&&d.push(object),object.children.length>0){for(var m=[],i=0,y=object.children.length;i<y;i++){var x=object.children[i];if(x.visible||!1===t.onlyVisible){var M=F(x);null!==M&&m.push(M)}}m.length>0&&(e.children=m)}n.nodes.push(e);var S=n.nodes.length-1;return h.set(object,S),S}function R(e){n.scenes||(n.scenes=[],n.scene=0);var r={nodes:[]};""!==e.name&&(r.name=e.name),e.userData&&Object.keys(e.userData).length>0&&(r.extras=w(e)),n.scenes.push(r);for(var o=[],i=0,l=e.children.length;i<l;i++){var c=e.children[i];if(c.visible||!1===t.onlyVisible){var h=F(c);null!==h&&o.push(h)}}o.length>0&&(r.nodes=o)}!function(input){input=input instanceof Array?input:[input];for(var e=[],i=0;i<input.length;i++)input[i]instanceof Scene?R(input[i]):e.push(input[i]);for(e.length>0&&function(e){var t=new Scene;t.name="AuxScene";for(var i=0;i<e.length;i++)t.children.push(e[i]);R(t)}(e),i=0;i<d.length;++i)E(d[i]);for(i=0;i<t.animations.length;++i)P(t.animations[i],input[0])}(input),Promise.all(c).then((function(){var r=new Blob(l,{type:"application/octet-stream"}),o=Object.keys(f);if(o.length>0&&(n.extensionsUsed=o),n.buffers&&n.buffers.length>0){n.buffers[0].byteLength=r.size;var c=new window.FileReader;if(!0===t.binary){c.readAsArrayBuffer(r),c.onloadend=function(){var t=x(c.result),r=new DataView(new ArrayBuffer(8));r.setUint32(0,t.byteLength,!0),r.setUint32(4,5130562,!0);var o=x(function(text){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(text).buffer;for(var e=new Uint8Array(new ArrayBuffer(text.length)),i=0,t=text.length;i<t;i++){var r=text.charCodeAt(i);e[i]=r>255?32:r}return e.buffer}(JSON.stringify(n)),32),l=new DataView(new ArrayBuffer(8));l.setUint32(0,o.byteLength,!0),l.setUint32(4,1313821514,!0);var header=new ArrayBuffer(12),h=new DataView(header);h.setUint32(0,1179937895,!0),h.setUint32(4,2,!0);var d=12+l.byteLength+o.byteLength+r.byteLength+t.byteLength;h.setUint32(8,d,!0);var f=new Blob([header,l,o,r,t],{type:"application/octet-stream"}),m=new window.FileReader;m.readAsArrayBuffer(f),m.onloadend=function(){e(m.result)}}}else c.readAsDataURL(r),c.onloadend=function(){var t=c.result;n.buffers[0].uri=t,e(n)}}else e(n)}))}},GLTFExporter.Utils={insertKeyframe:function(track,time){var e,t=track.getValueSize(),r=new track.TimeBufferType(track.times.length+1),n=new track.ValueBufferType(track.values.length+t),o=track.createInterpolant(new track.ValueBufferType(t));if(0===track.times.length){r[0]=time;for(var i=0;i<t;i++)n[i]=0;e=0}else if(time<track.times[0]){if(Math.abs(track.times[0]-time)<.001)return 0;r[0]=time,r.set(track.times,1),n.set(o.evaluate(time),0),n.set(track.values,t),e=0}else if(time>track.times[track.times.length-1]){if(Math.abs(track.times[track.times.length-1]-time)<.001)return track.times.length-1;r[r.length-1]=time,r.set(track.times,0),n.set(track.values,0),n.set(o.evaluate(time),track.values.length),e=r.length-1}else for(i=0;i<track.times.length;i++){if(Math.abs(track.times[i]-time)<.001)return i;if(track.times[i]<time&&track.times[i+1]>time){r.set(track.times.slice(0,i+1),0),r[i+1]=time,r.set(track.times.slice(i+1),i+2),n.set(track.values.slice(0,(i+1)*t),0),n.set(o.evaluate(time),(i+1)*t),n.set(track.values.slice((i+1)*t),(i+2)*t),e=i+1;break}}return track.times=r,track.values=n,e},mergeMorphTargetTracks:function(e,t){for(var r=[],n={},o=e.tracks,i=0;i<o.length;++i){var l=o[i],c=PropertyBinding.parseTrackName(l.name),h=PropertyBinding.findNode(t,c.nodeName);if("morphTargetInfluences"===c.propertyName&&void 0!==c.propertyIndex){if(l.createInterpolant!==l.InterpolantFactoryMethodDiscrete&&l.createInterpolant!==l.InterpolantFactoryMethodLinear){if(l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(l=l.clone()).setInterpolation(InterpolateLinear)}var d,f=h.morphTargetInfluences.length,m=h.morphTargetDictionary[c.propertyIndex];if(void 0===m)throw new Error("GLTFExporter: Morph target name not found: "+c.propertyIndex);if(void 0!==n[h.uuid]){var v=l.createInterpolant(new l.ValueBufferType(1));d=n[h.uuid];for(w=0;w<d.times.length;w++)d.values[w*f+m]=v.evaluate(d.times[w]);for(w=0;w<l.times.length;w++){var y=this.insertKeyframe(d,l.times[w]);d.values[y*f+m]=l.values[w]}}else{for(var x=new((d=l.clone()).ValueBufferType)(f*d.times.length),w=0;w<d.times.length;w++)x[w*f+m]=d.values[w];d.name=".morphTargetInfluences",d.values=x,n[h.uuid]=d,r.push(d)}}else r.push(l)}return e.tracks=r,e}};var MMDExporter=function(){var e;this.parseVpd=function(t,r,n){if(!0!==t.isSkinnedMesh)return console.warn("MMDExporter: parseVpd() requires SkinnedMesh instance."),null;function o(e){Math.abs(e)<1e-6&&(e=0);var a=e.toString();-1===a.indexOf(".")&&(a+=".");var t=(a+="000000").indexOf(".");return a.slice(0,t)+"."+a.slice(t+1,t+7)}function l(e){for(var a=[],i=0,t=e.length;i<t;i++)a.push(o(e[i]));return a.join(",")}t.updateMatrixWorld(!0);var c=t.skeleton.bones,h=function(e){var t=e.clone();return t.pose(),t.skeleton.bones}(t),d=new Vector3,f=new Quaternion,m=new Quaternion,v=new Matrix4,y=[];y.push("Vocaloid Pose Data file"),y.push(""),y.push((""!==t.name?t.name.replace(/\s/g,"_"):"skin")+".osm;"),y.push(c.length+";"),y.push("");for(var i=0,x=c.length;i<x;i++){var w=c[i],M=h[i];!0===n&&void 0!==w.userData.ik&&void 0!==w.userData.ik.originalMatrix?v.fromArray(w.userData.ik.originalMatrix):v.copy(w.matrix),d.setFromMatrixPosition(v),f.setFromRotationMatrix(v);var S=d.sub(M.position).toArray(),A=m.copy(M.quaternion).conjugate().multiply(f).toArray();S[2]=-S[2],A[0]=-A[0],A[1]=-A[1],y.push("Bone"+i+"{"+w.name),y.push("  "+l(S)+";"),y.push("  "+l(A)+";"),y.push("}"),y.push("")}y.push("");var T=y.join("\n");return!0===r?function(t){if(void 0===e){var table=(new MMDParser.CharsetEncoder).s2uTable;e={};for(var r=Object.keys(table),i=0,n=r.length;i<n;i++){var o=r[i],l=table[o];o=parseInt(o),e[l]=o}}var c=[];for(i=0,n=t.length;i<n;i++){var code=t.charCodeAt(i);if(void 0===(l=e[code]))throw"cannot convert charcode 0x"+code.toString(16);l>255?(c.push(l>>8&255),c.push(255&l)):c.push(255&l)}return new Uint8Array(c)}(T):T}},OBJExporter=function(){};OBJExporter.prototype={constructor:OBJExporter,parse:function(object){var i,e,t,r,n,output="",o=0,l=0,c=0,h=new Vector3,d=new Vector3,f=new Vector2,m=[];return object.traverse((function(v){v instanceof Mesh&&function(t){var v=0,y=0,x=0,w=t.geometry,M=new Matrix3;if(w instanceof Geometry&&(w=(new BufferGeometry).setFromObject(t)),w instanceof BufferGeometry){var S=w.getAttribute("position"),A=w.getAttribute("normal"),T=w.getAttribute("uv"),_=w.getIndex();if(output+="o "+t.name+"\n",t.material&&t.material.name&&(output+="usemtl "+t.material.name+"\n"),void 0!==S)for(i=0,r=S.count;i<r;i++,v++)h.x=S.getX(i),h.y=S.getY(i),h.z=S.getZ(i),h.applyMatrix4(t.matrixWorld),output+="v "+h.x+" "+h.y+" "+h.z+"\n";if(void 0!==T)for(i=0,r=T.count;i<r;i++,x++)f.x=T.getX(i),f.y=T.getY(i),output+="vt "+f.x+" "+f.y+"\n";if(void 0!==A)for(M.getNormalMatrix(t.matrixWorld),i=0,r=A.count;i<r;i++,y++)d.x=A.getX(i),d.y=A.getY(i),d.z=A.getZ(i),d.applyMatrix3(M),output+="vn "+d.x+" "+d.y+" "+d.z+"\n";if(null!==_)for(i=0,r=_.count;i<r;i+=3){for(n=0;n<3;n++)e=_.getX(i+n)+1,m[n]=o+e+(A||T?"/"+(T?l+e:"")+(A?"/"+(c+e):""):"");output+="f "+m.join(" ")+"\n"}else for(i=0,r=S.count;i<r;i+=3){for(n=0;n<3;n++)e=i+n+1,m[n]=o+e+(A||T?"/"+(T?l+e:"")+(A?"/"+(c+e):""):"");output+="f "+m.join(" ")+"\n"}}else console.warn("OBJExporter.parseMesh(): geometry type unsupported",w);o+=v,l+=x,c+=y}(v),v instanceof Line&&function(line){var n=0,l=line.geometry,c=line.type;if(l instanceof Geometry&&(l=(new BufferGeometry).setFromObject(line)),l instanceof BufferGeometry){var d=l.getAttribute("position");if(output+="o "+line.name+"\n",void 0!==d)for(i=0,r=d.count;i<r;i++,n++)h.x=d.getX(i),h.y=d.getY(i),h.z=d.getZ(i),h.applyMatrix4(line.matrixWorld),output+="v "+h.x+" "+h.y+" "+h.z+"\n";if("Line"===c){for(output+="l ",e=1,r=d.count;e<=r;e++)output+=o+e+" ";output+="\n"}if("LineSegments"===c)for(t=(e=1)+1,r=d.count;e<r;t=(e+=2)+1)output+="l "+(o+e)+" "+(o+t)+"\n"}else console.warn("OBJExporter.parseLine(): geometry type unsupported",l);o+=n}(v)})),output}};var PLYExporter=function(){};PLYExporter.prototype={constructor:PLYExporter,parse:function(object,e,t){function r(e){object.traverse((function(t){if(!0===t.isMesh){var r=t,n=r.geometry;!0===n.isGeometry&&(n=o.get(n)),!0===n.isBufferGeometry&&void 0!==n.getAttribute("position")&&e(r,n)}}))}e&&"object"==typeof e&&(console.warn('PLYExporter: The options parameter is now the third argument to the "parse" function. See the documentation for the new API.'),t=e,e=void 0);var n=(t=Object.assign({binary:!1,excludeAttributes:[]},t)).excludeAttributes,o=new WeakMap,l=!1,c=!1,h=!1,d=0,f=0;object.traverse((function(e){if(!0===e.isMesh){var t=e,r=t.geometry;if(!0===r.isGeometry){var n=o.get(r)||(new BufferGeometry).setFromObject(t);o.set(r,n),r=n}if(!0===r.isBufferGeometry){var m=r.getAttribute("position"),v=r.getAttribute("normal"),y=r.getAttribute("uv"),x=r.getAttribute("color"),w=r.getIndex();if(void 0===m)return;d+=m.count,f+=w?w.count/3:m.count/3,void 0!==v&&(l=!0),void 0!==y&&(h=!0),void 0!==x&&(c=!0)}}}));var m=-1===n.indexOf("index");if(l=l&&-1===n.indexOf("normal"),c=c&&-1===n.indexOf("color"),h=h&&-1===n.indexOf("uv"),m&&f!==Math.floor(f))return console.error("PLYExporter: Failed to generate a valid PLY file with triangle indices because the number of indices is not divisible by 3."),null;var v=1;d>256&&(v=2),d>65536&&(v=4);var header="ply\nformat "+(t.binary?"binary_big_endian":"ascii")+" 1.0\nelement vertex "+d+"\nproperty float x\nproperty float y\nproperty float z\n";!0===l&&(header+="property float nx\nproperty float ny\nproperty float nz\n"),!0===h&&(header+="property float s\nproperty float t\n"),!0===c&&(header+="property uchar red\nproperty uchar green\nproperty uchar blue\n"),!0===m&&(header+="element face "+f+"\nproperty list uchar uint"+8*v+" vertex_index\n"),header+="end_header\n";var y=new Vector3,x=new Matrix3,w=null;if(!0===t.binary){var M=(new TextEncoder).encode(header),S=d*(12+(l?12:0)+(c?3:0)+(h?8:0)),A=m?f*(3*v+1):0,output=new DataView(new ArrayBuffer(M.length+S+A));new Uint8Array(output.buffer).set(M,0);var T=M.length,_=M.length+S,L=0;r((function(e,t){var r=t.getAttribute("position"),n=t.getAttribute("normal"),o=t.getAttribute("uv"),d=t.getAttribute("color"),f=t.getIndex();x.getNormalMatrix(e.matrixWorld);for(var i=0,w=r.count;i<w;i++)y.x=r.getX(i),y.y=r.getY(i),y.z=r.getZ(i),y.applyMatrix4(e.matrixWorld),output.setFloat32(T,y.x),T+=4,output.setFloat32(T,y.y),T+=4,output.setFloat32(T,y.z),T+=4,!0===l&&(null!=n?(y.x=n.getX(i),y.y=n.getY(i),y.z=n.getZ(i),y.applyMatrix3(x),output.setFloat32(T,y.x),T+=4,output.setFloat32(T,y.y),T+=4,output.setFloat32(T,y.z),T+=4):(output.setFloat32(T,0),T+=4,output.setFloat32(T,0),T+=4,output.setFloat32(T,0),T+=4)),!0===h&&(null!=o?(output.setFloat32(T,o.getX(i)),T+=4,output.setFloat32(T,o.getY(i)),T+=4):!1!==h&&(output.setFloat32(T,0),T+=4,output.setFloat32(T,0),T+=4)),!0===c&&(null!=d?(output.setUint8(T,Math.floor(255*d.getX(i))),T+=1,output.setUint8(T,Math.floor(255*d.getY(i))),T+=1,output.setUint8(T,Math.floor(255*d.getZ(i))),T+=1):(output.setUint8(T,255),T+=1,output.setUint8(T,255),T+=1,output.setUint8(T,255),T+=1));if(!0===m){var M="setUint"+8*v;if(null!==f)for(i=0,w=f.count;i<w;i+=3)output.setUint8(_,3),_+=1,output[M](_,f.getX(i+0)+L),_+=v,output[M](_,f.getX(i+1)+L),_+=v,output[M](_,f.getX(i+2)+L),_+=v;else for(i=0,w=r.count;i<w;i+=3)output.setUint8(_,3),_+=1,output[M](_,L+i),_+=v,output[M](_,L+i+1),_+=v,output[M](_,L+i+2),_+=v}L+=r.count})),w=output.buffer}else{L=0;var C="",N="";r((function(e,t){var r=t.getAttribute("position"),n=t.getAttribute("normal"),o=t.getAttribute("uv"),d=t.getAttribute("color"),v=t.getIndex();x.getNormalMatrix(e.matrixWorld);for(var i=0,w=r.count;i<w;i++){y.x=r.getX(i),y.y=r.getY(i),y.z=r.getZ(i),y.applyMatrix4(e.matrixWorld);var line=y.x+" "+y.y+" "+y.z;!0===l&&(null!=n?(y.x=n.getX(i),y.y=n.getY(i),y.z=n.getZ(i),y.applyMatrix3(x),line+=" "+y.x+" "+y.y+" "+y.z):line+=" 0 0 0"),!0===h&&(null!=o?line+=" "+o.getX(i)+" "+o.getY(i):!1!==h&&(line+=" 0 0")),!0===c&&(line+=null!=d?" "+Math.floor(255*d.getX(i))+" "+Math.floor(255*d.getY(i))+" "+Math.floor(255*d.getZ(i)):" 255 255 255"),C+=line+"\n"}if(!0===m){if(null!==v)for(i=0,w=v.count;i<w;i+=3)N+="3 "+(v.getX(i+0)+L),N+=" "+(v.getX(i+1)+L),N+=" "+(v.getX(i+2)+L)+"\n";else for(i=0,w=r.count;i<w;i+=3)N+="3 "+(L+i)+" "+(L+i+1)+" "+(L+i+2)+"\n";f+=v?v.count/3:r.count/3}L+=r.count})),w=""+header+C+"\n"+(m?N+"\n":"")}return"function"==typeof e&&requestAnimationFrame((function(){return e(w)})),w}};var STLExporter=function(){};STLExporter.prototype={constructor:STLExporter,parse:function(){var e=new Vector3,t=new Matrix3;return function(r,n){void 0===n&&(n={});var o=void 0!==n.binary&&n.binary,l=[],c=0;if(r.traverse((function(object){if(object.isMesh){var e=object.geometry;e.isBufferGeometry&&(e=(new Geometry).fromBufferGeometry(e)),e.isGeometry&&(c+=e.faces.length,l.push({geometry:e,matrixWorld:object.matrixWorld}))}})),o){var h=80,d=new ArrayBuffer(2*c+3*c*4*4+80+4);(output=new DataView(d)).setUint32(h,c,!0),h+=4;for(var i=0,f=l.length;i<f;i++){var m=(object=l[i]).geometry.vertices,v=object.geometry.faces,y=object.matrixWorld;t.getNormalMatrix(y);for(var x=0,w=v.length;x<w;x++){var M=v[x];e.copy(M.normal).applyMatrix3(t).normalize(),output.setFloat32(h,e.x,!0),h+=4,output.setFloat32(h,e.y,!0),h+=4,output.setFloat32(h,e.z,!0),h+=4;for(var S=[M.a,M.b,M.c],A=0;A<3;A++)e.copy(m[S[A]]).applyMatrix4(y),output.setFloat32(h,e.x,!0),h+=4,output.setFloat32(h,e.y,!0),h+=4,output.setFloat32(h,e.z,!0),h+=4;output.setUint16(h,0,!0),h+=2}}return output}var output="";output+="solid exported\n";for(i=0,f=l.length;i<f;i++){var object;m=(object=l[i]).geometry.vertices,v=object.geometry.faces,y=object.matrixWorld;t.getNormalMatrix(y);for(x=0,w=v.length;x<w;x++){M=v[x];e.copy(M.normal).applyMatrix3(t).normalize(),output+="\tfacet normal "+e.x+" "+e.y+" "+e.z+"\n",output+="\t\touter loop\n";for(S=[M.a,M.b,M.c],A=0;A<3;A++)e.copy(m[S[A]]).applyMatrix4(y),output+="\t\t\tvertex "+e.x+" "+e.y+" "+e.z+"\n";output+="\t\tendloop\n",output+="\tendfacet\n"}}return output+="endsolid exported\n"}}()};var TypedGeometryExporter=function(){};TypedGeometryExporter.prototype={constructor:TypedGeometryExporter,parse:function(e){var output={metadata:{version:4,type:"TypedGeometry",generator:"TypedGeometryExporter"}},t=["vertices","normals","uvs"];for(var r in t){for(var n=t[r],o=e[n],l=[],i=0,c=o.length;i<c;i++)l[i]=o[i];output[n]=l}var h=e.boundingSphere;return null!==h&&(output.boundingSphere={center:h.center.toArray(),radius:h.radius}),output}};var BoxLineGeometry=function(e,t,r,n,o,l){BufferGeometry.call(this);for(var c=(e=e||1)/2,h=(t=t||1)/2,d=(r=r||1)/2,f=e/(n=Math.floor(n)||1),m=t/(o=Math.floor(o)||1),v=r/(l=Math.floor(l)||1),y=[],x=-c,w=-h,M=-d,i=0;i<=n;i++)y.push(x,-h,-d,x,h,-d),y.push(x,h,-d,x,h,d),y.push(x,h,d,x,-h,d),y.push(x,-h,d,x,-h,-d),x+=f;for(i=0;i<=o;i++)y.push(-c,w,-d,c,w,-d),y.push(c,w,-d,c,w,d),y.push(c,w,d,-c,w,d),y.push(-c,w,d,-c,w,-d),w+=m;for(i=0;i<=l;i++)y.push(-c,-h,M,-c,h,M),y.push(-c,h,M,c,h,M),y.push(c,h,M,c,-h,M),y.push(c,-h,M,-c,-h,M),M+=v;this.addAttribute("position",new Float32BufferAttribute(y,3))};function DecalGeometry(e,t,r,n){BufferGeometry.call(this);var o=[],l=[],c=[],h=new Vector3,d=new Matrix4;d.makeRotationFromEuler(r),d.setPosition(t);var f=(new Matrix4).getInverse(d);function m(t,r,n){r.applyMatrix4(e.matrixWorld),r.applyMatrix4(f),t.push(new DecalVertex(r.clone(),n.clone()))}function v(e,t){for(var r=[],s=.5*Math.abs(n.dot(t)),i=0;i<e.length;i+=3){var o,l,c,h,d,f,m;switch(((o=e[i+0].position.dot(t)-s>0)?1:0)+((l=e[i+1].position.dot(t)-s>0)?1:0)+((c=e[i+2].position.dot(t)-s>0)?1:0)){case 0:r.push(e[i]),r.push(e[i+1]),r.push(e[i+2]);break;case 1:if(o&&(h=e[i+1],d=e[i+2],f=y(e[i],h,t,s),m=y(e[i],d,t,s)),l){h=e[i],d=e[i+2],f=y(e[i+1],h,t,s),m=y(e[i+1],d,t,s),r.push(f),r.push(d.clone()),r.push(h.clone()),r.push(d.clone()),r.push(f.clone()),r.push(m);break}c&&(h=e[i],d=e[i+1],f=y(e[i+2],h,t,s),m=y(e[i+2],d,t,s)),r.push(h.clone()),r.push(d.clone()),r.push(f),r.push(m),r.push(f.clone()),r.push(d.clone());break;case 2:o||(d=y(h=e[i].clone(),e[i+1],t,s),f=y(h,e[i+2],t,s),r.push(h),r.push(d),r.push(f)),l||(d=y(h=e[i+1].clone(),e[i+2],t,s),f=y(h,e[i],t,s),r.push(h),r.push(d),r.push(f)),c||(d=y(h=e[i+2].clone(),e[i],t,s),f=y(h,e[i+1],t,s),r.push(h),r.push(d),r.push(f))}}return r}function y(e,t,p,s){var r=e.position.dot(p)-s,n=r/(r-(t.position.dot(p)-s));return new DecalVertex(new Vector3(e.position.x+n*(t.position.x-e.position.x),e.position.y+n*(t.position.y-e.position.y),e.position.z+n*(t.position.z-e.position.z)),new Vector3(e.normal.x+n*(t.normal.x-e.normal.x),e.normal.y+n*(t.normal.y-e.normal.y),e.normal.z+n*(t.normal.z-e.normal.z)))}!function(){var i,t=new BufferGeometry,r=[],f=new Vector3,y=new Vector3;e.geometry.isGeometry?t.fromGeometry(e.geometry):t.copy(e.geometry);var x=t.attributes.position,w=t.attributes.normal;if(null!==t.index){var M=t.index;for(i=0;i<M.count;i++)f.fromBufferAttribute(x,M.getX(i)),y.fromBufferAttribute(w,M.getX(i)),m(r,f,y)}else for(i=0;i<x.count;i++)f.fromBufferAttribute(x,i),y.fromBufferAttribute(w,i),m(r,f,y);for(r=v(r,h.set(1,0,0)),r=v(r,h.set(-1,0,0)),r=v(r,h.set(0,1,0)),r=v(r,h.set(0,-1,0)),r=v(r,h.set(0,0,1)),r=v(r,h.set(0,0,-1)),i=0;i<r.length;i++){var S=r[i];c.push(.5+S.position.x/n.x,.5+S.position.y/n.y),S.position.applyMatrix4(d),o.push(S.position.x,S.position.y,S.position.z),l.push(S.normal.x,S.normal.y,S.normal.z)}}(),this.addAttribute("position",new Float32BufferAttribute(o,3)),this.addAttribute("normal",new Float32BufferAttribute(l,3)),this.addAttribute("uv",new Float32BufferAttribute(c,2))}function DecalVertex(e,t){this.position=e,this.normal=t}function hilbert2D(e,t,r,n,o,l,c){e=void 0!==e?e:new Vector3(0,0,0);var h=(t=void 0!==t?t:10)/2,d=(r=void 0!==r?r:1,n=void 0!==n?n:0,o=void 0!==o?o:1,l=void 0!==l?l:2,c=void 0!==c?c:3,[new Vector3(e.x-h,e.y,e.z-h),new Vector3(e.x-h,e.y,e.z+h),new Vector3(e.x+h,e.y,e.z+h),new Vector3(e.x+h,e.y,e.z-h)]),f=[d[n],d[o],d[l],d[c]];if(0<=--r){var m=[];return Array.prototype.push.apply(m,hilbert2D(f[0],h,r,n,c,l,o)),Array.prototype.push.apply(m,hilbert2D(f[1],h,r,n,o,l,c)),Array.prototype.push.apply(m,hilbert2D(f[2],h,r,n,o,l,c)),Array.prototype.push.apply(m,hilbert2D(f[3],h,r,l,o,n,c)),m}return f}function hilbert3D(e,t,r,n,o,l,c,h,d,f,m){e=void 0!==e?e:new Vector3(0,0,0);var v=(t=void 0!==t?t:10)/2,y=(r=void 0!==r?r:1,n=void 0!==n?n:0,o=void 0!==o?o:1,l=void 0!==l?l:2,c=void 0!==c?c:3,h=void 0!==h?h:4,d=void 0!==d?d:5,f=void 0!==f?f:6,m=void 0!==m?m:7,[new Vector3(e.x-v,e.y+v,e.z-v),new Vector3(e.x-v,e.y+v,e.z+v),new Vector3(e.x-v,e.y-v,e.z+v),new Vector3(e.x-v,e.y-v,e.z-v),new Vector3(e.x+v,e.y-v,e.z-v),new Vector3(e.x+v,e.y-v,e.z+v),new Vector3(e.x+v,e.y+v,e.z+v),new Vector3(e.x+v,e.y+v,e.z-v)]),x=[y[n],y[o],y[l],y[c],y[h],y[d],y[f],y[m]];if(--r>=0){var w=[];return Array.prototype.push.apply(w,hilbert3D(x[0],v,r,n,c,h,m,f,d,l,o)),Array.prototype.push.apply(w,hilbert3D(x[1],v,r,n,m,f,o,l,d,h,c)),Array.prototype.push.apply(w,hilbert3D(x[2],v,r,n,m,f,o,l,d,h,c)),Array.prototype.push.apply(w,hilbert3D(x[3],v,r,l,c,n,o,f,m,h,d)),Array.prototype.push.apply(w,hilbert3D(x[4],v,r,l,c,n,o,f,m,h,d)),Array.prototype.push.apply(w,hilbert3D(x[5],v,r,h,c,l,d,f,o,n,m)),Array.prototype.push.apply(w,hilbert3D(x[6],v,r,h,c,l,d,f,o,n,m)),Array.prototype.push.apply(w,hilbert3D(x[7],v,r,f,d,l,o,n,c,h,m)),w}return x}BoxLineGeometry.prototype=Object.create(BufferGeometry.prototype),BoxLineGeometry.prototype.constructor=BoxLineGeometry,DecalGeometry.prototype=Object.create(BufferGeometry.prototype),DecalGeometry.prototype.constructor=DecalGeometry,DecalVertex.prototype.clone=function(){return new DecalVertex(this.position.clone(),this.normal.clone())};var SimplexNoise=function(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var i=0;i<256;i++)this.p[i]=Math.floor(256*e.random());this.perm=[];for(i=0;i<512;i++)this.perm[i]=this.p[255&i];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};SimplexNoise.prototype.dot=function(g,e,t){return g[0]*e+g[1]*t},SimplexNoise.prototype.dot3=function(g,e,t,r){return g[0]*e+g[1]*t+g[2]*r},SimplexNoise.prototype.dot4=function(g,e,t,r,n){return g[0]*e+g[1]*t+g[2]*r+g[3]*n},SimplexNoise.prototype.noise=function(e,t){var r,n,s=(e+t)*(.5*(Math.sqrt(3)-1)),i=Math.floor(e+s),o=Math.floor(t+s),l=(3-Math.sqrt(3))/6,c=(i+o)*l,h=e-(i-c),d=t-(o-c);h>d?(r=1,n=0):(r=0,n=1);var f=h-r+l,m=d-n+l,v=h-1+2*l,y=d-1+2*l,x=255&i,w=255&o,M=this.perm[x+this.perm[w]]%12,S=this.perm[x+r+this.perm[w+n]]%12,A=this.perm[x+1+this.perm[w+1]]%12,T=.5-h*h-d*d,_=.5-f*f-m*m,L=.5-v*v-y*y;return 70*((T<0?0:(T*=T)*T*this.dot(this.grad3[M],h,d))+(_<0?0:(_*=_)*_*this.dot(this.grad3[S],f,m))+(L<0?0:(L*=L)*L*this.dot(this.grad3[A],v,y)))},SimplexNoise.prototype.noise3d=function(e,t,r){var n,o,l,c,h,d,s=(e+t+r)*(1/3),i=Math.floor(e+s),f=Math.floor(t+s),m=Math.floor(r+s),v=1/6,y=(i+f+m)*v,x=e-(i-y),w=t-(f-y),M=r-(m-y);x>=w?w>=M?(n=1,o=0,l=0,c=1,h=1,d=0):x>=M?(n=1,o=0,l=0,c=1,h=0,d=1):(n=0,o=0,l=1,c=1,h=0,d=1):w<M?(n=0,o=0,l=1,c=0,h=1,d=1):x<M?(n=0,o=1,l=0,c=0,h=1,d=1):(n=0,o=1,l=0,c=1,h=1,d=0);var S=x-n+v,A=w-o+v,T=M-l+v,_=x-c+2*v,L=w-h+2*v,C=M-d+2*v,N=x-1+.5,P=w-1+.5,E=M-1+.5,D=255&i,F=255&f,R=255&m,O=this.perm[D+this.perm[F+this.perm[R]]]%12,B=this.perm[D+n+this.perm[F+o+this.perm[R+l]]]%12,I=this.perm[D+c+this.perm[F+h+this.perm[R+d]]]%12,U=this.perm[D+1+this.perm[F+1+this.perm[R+1]]]%12,V=.6-x*x-w*w-M*M,k=.6-S*S-A*A-T*T,G=.6-_*_-L*L-C*C,z=.6-N*N-P*P-E*E;return 32*((V<0?0:(V*=V)*V*this.dot3(this.grad3[O],x,w,M))+(k<0?0:(k*=k)*k*this.dot3(this.grad3[B],S,A,T))+(G<0?0:(G*=G)*G*this.dot3(this.grad3[I],_,L,C))+(z<0?0:(z*=z)*z*this.dot3(this.grad3[U],N,P,E)))},SimplexNoise.prototype.noise4d=function(e,t,r,n){var o,l,c,h,d,f,m,v,y,x,w,M,S=this.grad4,A=this.simplex,T=this.perm,_=(Math.sqrt(5)-1)/4,L=(5-Math.sqrt(5))/20,s=(e+t+r+n)*_,i=Math.floor(e+s),C=Math.floor(t+s),N=Math.floor(r+s),P=Math.floor(n+s),E=(i+C+N+P)*L,D=e-(i-E),F=t-(C-E),R=r-(N-E),O=n-(P-E),B=(D>F?32:0)+(D>R?16:0)+(F>R?8:0)+(D>O?4:0)+(F>O?2:0)+(R>O?1:0),I=D-(o=A[B][0]>=3?1:0)+L,U=F-(l=A[B][1]>=3?1:0)+L,V=R-(c=A[B][2]>=3?1:0)+L,k=O-(h=A[B][3]>=3?1:0)+L,G=D-(d=A[B][0]>=2?1:0)+2*L,z=F-(f=A[B][1]>=2?1:0)+2*L,j=R-(m=A[B][2]>=2?1:0)+2*L,W=O-(v=A[B][3]>=2?1:0)+2*L,H=D-(y=A[B][0]>=1?1:0)+3*L,X=F-(x=A[B][1]>=1?1:0)+3*L,Y=R-(w=A[B][2]>=1?1:0)+3*L,Q=O-(M=A[B][3]>=1?1:0)+3*L,K=D-1+4*L,J=F-1+4*L,Z=R-1+4*L,$=O-1+4*L,ee=255&i,te=255&C,re=255&N,ie=255&P,ne=T[ee+T[te+T[re+T[ie]]]]%32,ae=T[ee+o+T[te+l+T[re+c+T[ie+h]]]]%32,oe=T[ee+d+T[te+f+T[re+m+T[ie+v]]]]%32,se=T[ee+y+T[te+x+T[re+w+T[ie+M]]]]%32,le=T[ee+1+T[te+1+T[re+1+T[ie+1]]]]%32,ce=.6-D*D-F*F-R*R-O*O,ue=.6-I*I-U*U-V*V-k*k,he=.6-G*G-z*z-j*j-W*W,de=.6-H*H-X*X-Y*Y-Q*Q,pe=.6-K*K-J*J-Z*Z-$*$;return 27*((ce<0?0:(ce*=ce)*ce*this.dot4(S[ne],D,F,R,O))+(ue<0?0:(ue*=ue)*ue*this.dot4(S[ae],I,U,V,k))+(he<0?0:(he*=he)*he*this.dot4(S[oe],G,z,j,W))+(de<0?0:(de*=de)*de*this.dot4(S[se],H,X,Y,Q))+(pe<0?0:(pe*=pe)*pe*this.dot4(S[le],K,J,Z,$)))};var LightningStrike=function(e){BufferGeometry.call(this),this.type="LightningStrike",e=e||{},this.init(LightningStrike.copyParameters(e,e)),this.createMesh()};LightningStrike.prototype=Object.create(BufferGeometry.prototype),LightningStrike.prototype.constructor=LightningStrike,LightningStrike.prototype.isLightningStrike=!0,LightningStrike.RAY_INITIALIZED=0,LightningStrike.RAY_UNBORN=1,LightningStrike.RAY_PROPAGATING=2,LightningStrike.RAY_STEADY=3,LightningStrike.RAY_VANISHING=4,LightningStrike.RAY_EXTINGUISHED=5,LightningStrike.COS30DEG=Math.cos(30*Math.PI/180),LightningStrike.SIN30DEG=Math.sin(30*Math.PI/180),LightningStrike.createRandomGenerator=function(){for(var e=[],i=0;i<2053;i++)e.push(Math.random());var t={currentSeed:0,random:function(){var r=e[t.currentSeed];return t.currentSeed=(t.currentSeed+1)%2053,r},getSeed:function(){return t.currentSeed/2053},setSeed:function(e){t.currentSeed=Math.floor(2053*e)%2053}};return t},LightningStrike.copyParameters=function(e,source){source=source||{};var t=function(t){return source===e?t:t.clone()};return(e=e||{}).sourceOffset=void 0!==source.sourceOffset?t(source.sourceOffset):new Vector3(0,100,0),e.destOffset=void 0!==source.destOffset?t(source.destOffset):new Vector3(0,0,0),e.timeScale=void 0!==source.timeScale?source.timeScale:1,e.roughness=void 0!==source.roughness?source.roughness:.9,e.straightness=void 0!==source.straightness?source.straightness:.7,e.up0=void 0!==source.up0?t(source.up0):new Vector3(0,0,1),e.up1=void 0!==source.up1?t(source.up1):new Vector3(0,0,1),e.radius0=void 0!==source.radius0?source.radius0:1,e.radius1=void 0!==source.radius1?source.radius1:1,e.radius0Factor=void 0!==source.radius0Factor?source.radius0Factor:.5,e.radius1Factor=void 0!==source.radius1Factor?source.radius1Factor:.2,e.minRadius=void 0!==source.minRadius?source.minRadius:.2,e.isEternal=void 0!==source.isEternal?source.isEternal:void 0===source.birthTime||void 0===source.deathTime,e.birthTime=source.birthTime,e.deathTime=source.deathTime,e.propagationTimeFactor=void 0!==source.propagationTimeFactor?source.propagationTimeFactor:.1,e.vanishingTimeFactor=void 0!==source.vanishingTimeFactor?source.vanishingTimeFactor:.9,e.subrayPeriod=void 0!==source.subrayPeriod?source.subrayPeriod:4,e.subrayDutyCycle=void 0!==source.subrayDutyCycle?source.subrayDutyCycle:.6,e.maxIterations=void 0!==source.maxIterations?source.maxIterations:9,e.isStatic=void 0!==source.isStatic&&source.isStatic,e.ramification=void 0!==source.ramification?source.ramification:5,e.maxSubrayRecursion=void 0!==source.maxSubrayRecursion?source.maxSubrayRecursion:3,e.recursionProbability=void 0!==source.recursionProbability?source.recursionProbability:.6,e.generateUVs=void 0!==source.generateUVs&&source.generateUVs,e.randomGenerator=source.randomGenerator,e.noiseSeed=source.noiseSeed,e.onDecideSubrayCreation=source.onDecideSubrayCreation,e.onSubrayCreation=source.onSubrayCreation,e},LightningStrike.prototype.update=function(time){this.isStatic||(this.rayParameters.isEternal||this.rayParameters.birthTime<=time&&time<=this.rayParameters.deathTime?(this.updateMesh(time),time<this.subrays[0].endPropagationTime?this.state=LightningStrike.RAY_PROPAGATING:time>this.subrays[0].beginVanishingTime?this.state=LightningStrike.RAY_VANISHING:this.state=LightningStrike.RAY_STEADY,this.visible=!0):(this.visible=!1,time<this.rayParameters.birthTime?this.state=LightningStrike.RAY_UNBORN:this.state=LightningStrike.RAY_EXTINGUISHED))},LightningStrike.prototype.init=function(e){this.rayParameters=e,this.maxIterations=void 0!==e.maxIterations?Math.floor(e.maxIterations):9,e.maxIterations=this.maxIterations,this.isStatic=void 0!==e.isStatic&&e.isStatic,e.isStatic=this.isStatic,this.ramification=void 0!==e.ramification?Math.floor(e.ramification):5,e.ramification=this.ramification,this.maxSubrayRecursion=void 0!==e.maxSubrayRecursion?Math.floor(e.maxSubrayRecursion):3,e.maxSubrayRecursion=this.maxSubrayRecursion,this.recursionProbability=void 0!==e.recursionProbability?e.recursionProbability:.6,e.recursionProbability=this.recursionProbability,this.generateUVs=void 0!==e.generateUVs&&e.generateUVs,e.generateUVs=this.generateUVs,void 0!==e.randomGenerator?(this.randomGenerator=e.randomGenerator,this.seedGenerator=e.randomGenerator,void 0!==e.noiseSeed&&this.seedGenerator.setSeed(e.noiseSeed)):(this.randomGenerator=LightningStrike.createRandomGenerator(),this.seedGenerator=Math),void 0!==e.onDecideSubrayCreation?this.onDecideSubrayCreation=e.onDecideSubrayCreation:(this.createDefaultSubrayCreationCallbacks(),void 0!==e.onSubrayCreation&&(this.onSubrayCreation=e.onSubrayCreation)),this.state=LightningStrike.RAY_INITIALIZED,this.maxSubrays=Math.ceil(1+Math.pow(this.ramification,Math.max(0,this.maxSubrayRecursion-1))),e.maxSubrays=this.maxSubrays,this.maxRaySegments=2*(1<<this.maxIterations),this.subrays=[];for(var i=0;i<this.maxSubrays;i++)this.subrays.push(this.createSubray());this.raySegments=[];for(i=0;i<this.maxRaySegments;i++)this.raySegments.push(this.createSegment());this.time=0,this.timeFraction=0,this.currentSegmentCallback=null,this.currentCreateTriangleVertices=this.generateUVs?this.createTriangleVerticesWithUVs:this.createTriangleVerticesWithoutUVs,this.numSubrays=0,this.currentSubray=null,this.currentSegmentIndex=0,this.isInitialSegment=!1,this.subrayProbability=0,this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.vertices=null,this.uvs=null,this.indices=null,this.positionAttribute=null,this.uvsAttribute=null,this.simplexX=new SimplexNoise(this.seedGenerator),this.simplexY=new SimplexNoise(this.seedGenerator),this.simplexZ=new SimplexNoise(this.seedGenerator),this.forwards=new Vector3,this.forwardsFill=new Vector3,this.side=new Vector3,this.down=new Vector3,this.middlePos=new Vector3,this.middleLinPos=new Vector3,this.newPos=new Vector3,this.vPos=new Vector3,this.cross1=new Vector3},LightningStrike.prototype.createMesh=function(){var e=1<<this.maxIterations,t=3*(e+1)*this.maxSubrays,r=18*e*this.maxSubrays;this.vertices=new Float32Array(3*t),this.indices=new Uint32Array(r),this.generateUVs&&(this.uvs=new Float32Array(2*t)),this.fillMesh(0),this.setIndex(new Uint32BufferAttribute(this.indices,1)),this.positionAttribute=new Float32BufferAttribute(this.vertices,3),this.addAttribute("position",this.positionAttribute),this.generateUVs&&(this.uvsAttribute=new Float32BufferAttribute(new Float32Array(this.uvs),2),this.addAttribute("uv",this.uvsAttribute)),this.isStatic||(this.index.dynamic=!0,this.positionAttribute.dynamic=!0,this.generateUVs&&(this.uvsAttribute.dynamic=!0)),this.vertices=this.positionAttribute.array,this.indices=this.index.array,this.generateUVs&&(this.uvs=this.uvsAttribute.array)},LightningStrike.prototype.updateMesh=function(time){this.fillMesh(time),this.drawRange.count=this.currentIndex,this.index.needsUpdate=!0,this.positionAttribute.needsUpdate=!0,this.generateUVs&&(this.uvsAttribute.needsUpdate=!0)},LightningStrike.prototype.fillMesh=function(time){var e=this;this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.fractalRay(time,(function(t){var r=e.currentSubray;time<r.birthTime||(this.rayParameters.isEternal&&0==e.currentSubray.recursion?(e.createPrism(t),e.onDecideSubrayCreation(t,e)):time<r.endPropagationTime?e.timeFraction>=t.fraction0*r.propagationTimeFactor&&(e.createPrism(t),e.onDecideSubrayCreation(t,e)):time<r.beginVanishingTime?(e.createPrism(t),e.onDecideSubrayCreation(t,e)):(e.timeFraction<=r.vanishingTimeFactor+t.fraction1*(1-r.vanishingTimeFactor)&&e.createPrism(t),e.onDecideSubrayCreation(t,e)))}))},LightningStrike.prototype.addNewSubray=function(e){return this.subrays[this.numSubrays++]},LightningStrike.prototype.initSubray=function(e,t){e.pos0.copy(t.sourceOffset),e.pos1.copy(t.destOffset),e.up0.copy(t.up0),e.up1.copy(t.up1),e.radius0=t.radius0,e.radius1=t.radius1,e.birthTime=t.birthTime,e.deathTime=t.deathTime,e.timeScale=t.timeScale,e.roughness=t.roughness,e.straightness=t.straightness,e.propagationTimeFactor=t.propagationTimeFactor,e.vanishingTimeFactor=t.vanishingTimeFactor,e.maxIterations=this.maxIterations,e.seed=void 0!==t.noiseSeed?t.noiseSeed:0,e.recursion=0},LightningStrike.prototype.fractalRay=function(time,e){this.time=time,this.currentSegmentCallback=e,this.numSubrays=0,this.initSubray(this.addNewSubray(),this.rayParameters);for(var t=0;t<this.numSubrays;t++){var r=this.subrays[t];this.currentSubray=r,this.randomGenerator.setSeed(r.seed),r.endPropagationTime=_Math.lerp(r.birthTime,r.deathTime,r.propagationTimeFactor),r.beginVanishingTime=_Math.lerp(r.deathTime,r.birthTime,1-r.vanishingTimeFactor);var n=this.randomGenerator.random;r.linPos0.set(n(),n(),n()).multiplyScalar(1e3),r.linPos1.set(n(),n(),n()).multiplyScalar(1e3),this.timeFraction=(time-r.birthTime)/(r.deathTime-r.birthTime),this.currentSegmentIndex=0,this.isInitialSegment=!0;var o=this.getNewSegment();o.iteration=0,o.pos0.copy(r.pos0),o.pos1.copy(r.pos1),o.linPos0.copy(r.linPos0),o.linPos1.copy(r.linPos1),o.up0.copy(r.up0),o.up1.copy(r.up1),o.radius0=r.radius0,o.radius1=r.radius1,o.fraction0=0,o.fraction1=1,o.positionVariationFactor=1-r.straightness,this.subrayProbability=this.ramification*Math.pow(this.recursionProbability,r.recursion)/(1<<r.maxIterations),this.fractalRayRecursive(o)}this.currentSegmentCallback=null,this.currentSubray=null},LightningStrike.prototype.fractalRayRecursive=function(e){if(e.iteration>=this.currentSubray.maxIterations)this.currentSegmentCallback(e);else{this.forwards.subVectors(e.pos1,e.pos0);var t=this.forwards.length();t<1e-6&&(this.forwards.set(0,0,.01),t=this.forwards.length());var r=.5*(e.radius0+e.radius1),n=.5*(e.fraction0+e.fraction1),o=this.time*this.currentSubray.timeScale*Math.pow(2,e.iteration);this.middlePos.lerpVectors(e.pos0,e.pos1,.5),this.middleLinPos.lerpVectors(e.linPos0,e.linPos1,.5);var p=this.middleLinPos;this.newPos.set(this.simplexX.noise4d(p.x,p.y,p.z,o),this.simplexY.noise4d(p.x,p.y,p.z,o),this.simplexZ.noise4d(p.x,p.y,p.z,o)),this.newPos.multiplyScalar(e.positionVariationFactor*t),this.newPos.add(this.middlePos);var l=this.getNewSegment();l.pos0.copy(e.pos0),l.pos1.copy(this.newPos),l.linPos0.copy(e.linPos0),l.linPos1.copy(this.middleLinPos),l.up0.copy(e.up0),l.up1.copy(e.up1),l.radius0=e.radius0,l.radius1=r,l.fraction0=e.fraction0,l.fraction1=n,l.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,l.iteration=e.iteration+1;var c=this.getNewSegment();c.pos0.copy(this.newPos),c.pos1.copy(e.pos1),c.linPos0.copy(this.middleLinPos),c.linPos1.copy(e.linPos1),this.cross1.crossVectors(e.up0,this.forwards.normalize()),c.up0.crossVectors(this.forwards,this.cross1).normalize(),c.up1.copy(e.up1),c.radius0=r,c.radius1=e.radius1,c.fraction0=n,c.fraction1=e.fraction1,c.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,c.iteration=e.iteration+1,this.fractalRayRecursive(l),this.fractalRayRecursive(c)}},LightningStrike.prototype.createPrism=function(e){this.forwardsFill.subVectors(e.pos1,e.pos0).normalize(),this.isInitialSegment&&(this.currentCreateTriangleVertices(e.pos0,e.up0,this.forwardsFill,e.radius0,0),this.isInitialSegment=!1),this.currentCreateTriangleVertices(e.pos1,e.up0,this.forwardsFill,e.radius1,e.fraction1),this.createPrismFaces()},LightningStrike.prototype.createTriangleVerticesWithoutUVs=function(e,t,r,n){this.side.crossVectors(t,r).multiplyScalar(n*LightningStrike.COS30DEG),this.down.copy(t).multiplyScalar(-n*LightningStrike.SIN30DEG);var p=this.vPos,o=this.vertices;p.copy(e).sub(this.side).add(this.down),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,p.copy(e).add(this.side).add(this.down),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,p.copy(t).multiplyScalar(n).add(e),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,this.currentVertex+=3},LightningStrike.prototype.createTriangleVerticesWithUVs=function(e,t,r,n,u){this.side.crossVectors(t,r).multiplyScalar(n*LightningStrike.COS30DEG),this.down.copy(t).multiplyScalar(-n*LightningStrike.SIN30DEG);var p=this.vPos,o=this.vertices,l=this.uvs;p.copy(e).sub(this.side).add(this.down),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,l[this.currentUVCoordinate++]=u,l[this.currentUVCoordinate++]=0,p.copy(e).add(this.side).add(this.down),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,l[this.currentUVCoordinate++]=u,l[this.currentUVCoordinate++]=.5,p.copy(t).multiplyScalar(n).add(e),o[this.currentCoordinate++]=p.x,o[this.currentCoordinate++]=p.y,o[this.currentCoordinate++]=p.z,l[this.currentUVCoordinate++]=u,l[this.currentUVCoordinate++]=1,this.currentVertex+=3},LightningStrike.prototype.createPrismFaces=function(e,t){var r=this.indices;e=this.currentVertex-6;r[this.currentIndex++]=e+1,r[this.currentIndex++]=e+2,r[this.currentIndex++]=e+5,r[this.currentIndex++]=e+1,r[this.currentIndex++]=e+5,r[this.currentIndex++]=e+4,r[this.currentIndex++]=e+0,r[this.currentIndex++]=e+1,r[this.currentIndex++]=e+4,r[this.currentIndex++]=e+0,r[this.currentIndex++]=e+4,r[this.currentIndex++]=e+3,r[this.currentIndex++]=e+2,r[this.currentIndex++]=e+0,r[this.currentIndex++]=e+3,r[this.currentIndex++]=e+2,r[this.currentIndex++]=e+3,r[this.currentIndex++]=e+5},LightningStrike.prototype.createDefaultSubrayCreationCallbacks=function(){var e=this.randomGenerator.random;this.onDecideSubrayCreation=function(t,r){var n=r.currentSubray,o=r.rayParameters.subrayPeriod,l=r.rayParameters.subrayDutyCycle,c=r.rayParameters.isEternal&&0==n.recursion?-e()*o:_Math.lerp(n.birthTime,n.endPropagationTime,t.fraction0)-e()*o,h=r.time-c,d=Math.floor(h/o),f=e()*(d+1),m=h%o<=l*o;v=r.subrayProbability;var v=0;if(m&&(v=r.subrayProbability),n.recursion<r.maxSubrayRecursion&&r.numSubrays<r.maxSubrays&&e()<v){var y=r.addNewSubray(),x=r.randomGenerator.getSeed();y.seed=f,r.randomGenerator.setSeed(f),y.recursion=n.recursion+1,y.maxIterations=Math.max(1,n.maxIterations-1),y.linPos0.set(e(),e(),e()).multiplyScalar(1e3),y.linPos1.set(e(),e(),e()).multiplyScalar(1e3),y.up0.copy(n.up0),y.up1.copy(n.up1),y.radius0=t.radius0*r.rayParameters.radius0Factor,y.radius1=Math.min(r.rayParameters.minRadius,t.radius1*r.rayParameters.radius1Factor),y.birthTime=c+d*o,y.deathTime=y.birthTime+o*l,r.rayParameters.isEternal||0!=n.recursion||(y.birthTime=Math.max(y.birthTime,n.birthTime),y.deathTime=Math.min(y.deathTime,n.deathTime)),y.timeScale=2*n.timeScale,y.roughness=n.roughness,y.straightness=n.straightness,y.propagationTimeFactor=n.propagationTimeFactor,y.vanishingTimeFactor=n.vanishingTimeFactor,r.onSubrayCreation(t,n,y,r),r.randomGenerator.setSeed(x)}};var t=new Vector3,r=new Vector3,n=new Vector3,o=new Vector3;this.onSubrayCreation=function(e,t,r,n){n.subrayCylinderPosition(e,t,r,.5,.6,.2)},this.subrayConePosition=function(l,c,h,d,f,m){h.pos0.copy(l.pos0),t.subVectors(c.pos1,c.pos0),r.copy(t).normalize(),t.multiplyScalar(l.fraction0+(1-l.fraction0)*(e()*d));var v=t.length();n.crossVectors(c.up0,r);var y=2*Math.PI*e();n.multiplyScalar(Math.cos(y)),o.copy(c.up0).multiplyScalar(Math.sin(y)),h.pos1.copy(n).add(o).multiplyScalar(v*f*(m+e()*(1-m))).add(t).add(c.pos0)},this.subrayCylinderPosition=function(l,c,h,d,f,m){h.pos0.copy(l.pos0),t.subVectors(c.pos1,c.pos0),r.copy(t).normalize(),t.multiplyScalar(l.fraction0+(1-l.fraction0)*((2*e()-1)*d));var v=t.length();n.crossVectors(c.up0,r);var y=2*Math.PI*e();n.multiplyScalar(Math.cos(y)),o.copy(c.up0).multiplyScalar(Math.sin(y)),h.pos1.copy(n).add(o).multiplyScalar(v*f*(m+e()*(1-m))).add(t).add(c.pos0)}},LightningStrike.prototype.createSubray=function(){return{seed:0,maxIterations:0,recursion:0,pos0:new Vector3,pos1:new Vector3,linPos0:new Vector3,linPos1:new Vector3,up0:new Vector3,up1:new Vector3,radius0:0,radius1:0,birthTime:0,deathTime:0,timeScale:0,roughness:0,straightness:0,propagationTimeFactor:0,vanishingTimeFactor:0,endPropagationTime:0,beginVanishingTime:0}},LightningStrike.prototype.createSegment=function(){return{iteration:0,pos0:new Vector3,pos1:new Vector3,linPos0:new Vector3,linPos1:new Vector3,up0:new Vector3,up1:new Vector3,radius0:0,radius1:0,fraction0:0,fraction1:0,positionVariationFactor:0}},LightningStrike.prototype.getNewSegment=function(){return this.raySegments[this.currentSegmentIndex++]},LightningStrike.prototype.copy=function(source){return BufferGeometry.prototype.copy.call(this,source),this.init(LightningStrike.copyParameters({},source.rayParameters)),this},LightningStrike.prototype.clone=function(){return new this.constructor(LightningStrike.copyParameters({},this.rayParameters))};var TeapotBufferGeometry=function(e,t,r,n,body,o,l){var c=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,3,16,17,18,7,19,20,21,11,22,23,24,15,25,26,27,18,28,29,30,21,31,32,33,24,34,35,36,27,37,38,39,30,40,41,0,33,42,43,4,36,44,45,8,39,46,47,12,12,13,14,15,48,49,50,51,52,53,54,55,56,57,58,59,15,25,26,27,51,60,61,62,55,63,64,65,59,66,67,68,27,37,38,39,62,69,70,71,65,72,73,74,68,75,76,77,39,46,47,12,71,78,79,48,74,80,81,52,77,82,83,56,56,57,58,59,84,85,86,87,88,89,90,91,92,93,94,95,59,66,67,68,87,96,97,98,91,99,100,101,95,102,103,104,68,75,76,77,98,105,106,107,101,108,109,110,104,111,112,113,77,82,83,56,107,114,115,84,110,116,117,88,113,118,119,92,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,123,136,137,120,127,138,139,124,131,140,141,128,135,142,143,132,132,133,134,135,144,145,146,147,148,149,150,151,68,152,153,154,135,142,143,132,147,155,156,144,151,157,158,148,154,159,160,68,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,164,177,178,161,168,179,180,165,172,181,182,169,176,183,184,173,173,174,175,176,185,186,187,188,189,190,191,192,193,194,195,196,176,183,184,173,188,197,198,185,192,199,200,189,196,201,202,193,203,203,203,203,204,205,206,207,208,208,208,208,209,210,211,212,203,203,203,203,207,213,214,215,208,208,208,208,212,216,217,218,203,203,203,203,215,219,220,221,208,208,208,208,218,222,223,224,203,203,203,203,221,225,226,204,208,208,208,208,224,227,228,209,209,210,211,212,229,230,231,232,233,234,235,236,237,238,239,240,212,216,217,218,232,241,242,243,236,244,245,246,240,247,248,249,218,222,223,224,243,250,251,252,246,253,254,255,249,256,257,258,224,227,228,209,252,259,260,229,255,261,262,233,258,263,264,237,265,265,265,265,266,267,268,269,270,271,272,273,92,119,118,113,265,265,265,265,269,274,275,276,273,277,278,279,113,112,111,104,265,265,265,265,276,280,281,282,279,283,284,285,104,103,102,95,265,265,265,265,282,286,287,266,285,288,289,270,95,94,93,92],h=[1.4,0,2.4,1.4,-.784,2.4,.784,-1.4,2.4,0,-1.4,2.4,1.3375,0,2.53125,1.3375,-.749,2.53125,.749,-1.3375,2.53125,0,-1.3375,2.53125,1.4375,0,2.53125,1.4375,-.805,2.53125,.805,-1.4375,2.53125,0,-1.4375,2.53125,1.5,0,2.4,1.5,-.84,2.4,.84,-1.5,2.4,0,-1.5,2.4,-.784,-1.4,2.4,-1.4,-.784,2.4,-1.4,0,2.4,-.749,-1.3375,2.53125,-1.3375,-.749,2.53125,-1.3375,0,2.53125,-.805,-1.4375,2.53125,-1.4375,-.805,2.53125,-1.4375,0,2.53125,-.84,-1.5,2.4,-1.5,-.84,2.4,-1.5,0,2.4,-1.4,.784,2.4,-.784,1.4,2.4,0,1.4,2.4,-1.3375,.749,2.53125,-.749,1.3375,2.53125,0,1.3375,2.53125,-1.4375,.805,2.53125,-.805,1.4375,2.53125,0,1.4375,2.53125,-1.5,.84,2.4,-.84,1.5,2.4,0,1.5,2.4,.784,1.4,2.4,1.4,.784,2.4,.749,1.3375,2.53125,1.3375,.749,2.53125,.805,1.4375,2.53125,1.4375,.805,2.53125,.84,1.5,2.4,1.5,.84,2.4,1.75,0,1.875,1.75,-.98,1.875,.98,-1.75,1.875,0,-1.75,1.875,2,0,1.35,2,-1.12,1.35,1.12,-2,1.35,0,-2,1.35,2,0,.9,2,-1.12,.9,1.12,-2,.9,0,-2,.9,-.98,-1.75,1.875,-1.75,-.98,1.875,-1.75,0,1.875,-1.12,-2,1.35,-2,-1.12,1.35,-2,0,1.35,-1.12,-2,.9,-2,-1.12,.9,-2,0,.9,-1.75,.98,1.875,-.98,1.75,1.875,0,1.75,1.875,-2,1.12,1.35,-1.12,2,1.35,0,2,1.35,-2,1.12,.9,-1.12,2,.9,0,2,.9,.98,1.75,1.875,1.75,.98,1.875,1.12,2,1.35,2,1.12,1.35,1.12,2,.9,2,1.12,.9,2,0,.45,2,-1.12,.45,1.12,-2,.45,0,-2,.45,1.5,0,.225,1.5,-.84,.225,.84,-1.5,.225,0,-1.5,.225,1.5,0,.15,1.5,-.84,.15,.84,-1.5,.15,0,-1.5,.15,-1.12,-2,.45,-2,-1.12,.45,-2,0,.45,-.84,-1.5,.225,-1.5,-.84,.225,-1.5,0,.225,-.84,-1.5,.15,-1.5,-.84,.15,-1.5,0,.15,-2,1.12,.45,-1.12,2,.45,0,2,.45,-1.5,.84,.225,-.84,1.5,.225,0,1.5,.225,-1.5,.84,.15,-.84,1.5,.15,0,1.5,.15,1.12,2,.45,2,1.12,.45,.84,1.5,.225,1.5,.84,.225,.84,1.5,.15,1.5,.84,.15,-1.6,0,2.025,-1.6,-.3,2.025,-1.5,-.3,2.25,-1.5,0,2.25,-2.3,0,2.025,-2.3,-.3,2.025,-2.5,-.3,2.25,-2.5,0,2.25,-2.7,0,2.025,-2.7,-.3,2.025,-3,-.3,2.25,-3,0,2.25,-2.7,0,1.8,-2.7,-.3,1.8,-3,-.3,1.8,-3,0,1.8,-1.5,.3,2.25,-1.6,.3,2.025,-2.5,.3,2.25,-2.3,.3,2.025,-3,.3,2.25,-2.7,.3,2.025,-3,.3,1.8,-2.7,.3,1.8,-2.7,0,1.575,-2.7,-.3,1.575,-3,-.3,1.35,-3,0,1.35,-2.5,0,1.125,-2.5,-.3,1.125,-2.65,-.3,.9375,-2.65,0,.9375,-2,-.3,.9,-1.9,-.3,.6,-1.9,0,.6,-3,.3,1.35,-2.7,.3,1.575,-2.65,.3,.9375,-2.5,.3,1.125,-1.9,.3,.6,-2,.3,.9,1.7,0,1.425,1.7,-.66,1.425,1.7,-.66,.6,1.7,0,.6,2.6,0,1.425,2.6,-.66,1.425,3.1,-.66,.825,3.1,0,.825,2.3,0,2.1,2.3,-.25,2.1,2.4,-.25,2.025,2.4,0,2.025,2.7,0,2.4,2.7,-.25,2.4,3.3,-.25,2.4,3.3,0,2.4,1.7,.66,.6,1.7,.66,1.425,3.1,.66,.825,2.6,.66,1.425,2.4,.25,2.025,2.3,.25,2.1,3.3,.25,2.4,2.7,.25,2.4,2.8,0,2.475,2.8,-.25,2.475,3.525,-.25,2.49375,3.525,0,2.49375,2.9,0,2.475,2.9,-.15,2.475,3.45,-.15,2.5125,3.45,0,2.5125,2.8,0,2.4,2.8,-.15,2.4,3.2,-.15,2.4,3.2,0,2.4,3.525,.25,2.49375,2.8,.25,2.475,3.45,.15,2.5125,2.9,.15,2.475,3.2,.15,2.4,2.8,.15,2.4,0,0,3.15,.8,0,3.15,.8,-.45,3.15,.45,-.8,3.15,0,-.8,3.15,0,0,2.85,.2,0,2.7,.2,-.112,2.7,.112,-.2,2.7,0,-.2,2.7,-.45,-.8,3.15,-.8,-.45,3.15,-.8,0,3.15,-.112,-.2,2.7,-.2,-.112,2.7,-.2,0,2.7,-.8,.45,3.15,-.45,.8,3.15,0,.8,3.15,-.2,.112,2.7,-.112,.2,2.7,0,.2,2.7,.45,.8,3.15,.8,.45,3.15,.112,.2,2.7,.2,.112,2.7,.4,0,2.55,.4,-.224,2.55,.224,-.4,2.55,0,-.4,2.55,1.3,0,2.55,1.3,-.728,2.55,.728,-1.3,2.55,0,-1.3,2.55,1.3,0,2.4,1.3,-.728,2.4,.728,-1.3,2.4,0,-1.3,2.4,-.224,-.4,2.55,-.4,-.224,2.55,-.4,0,2.55,-.728,-1.3,2.55,-1.3,-.728,2.55,-1.3,0,2.55,-.728,-1.3,2.4,-1.3,-.728,2.4,-1.3,0,2.4,-.4,.224,2.55,-.224,.4,2.55,0,.4,2.55,-1.3,.728,2.55,-.728,1.3,2.55,0,1.3,2.55,-1.3,.728,2.4,-.728,1.3,2.4,0,1.3,2.4,.224,.4,2.55,.4,.224,2.55,.728,1.3,2.55,1.3,.728,2.55,.728,1.3,2.4,1.3,.728,2.4,0,0,0,1.425,0,0,1.425,.798,0,.798,1.425,0,0,1.425,0,1.5,0,.075,1.5,.84,.075,.84,1.5,.075,0,1.5,.075,-.798,1.425,0,-1.425,.798,0,-1.425,0,0,-.84,1.5,.075,-1.5,.84,.075,-1.5,0,.075,-1.425,-.798,0,-.798,-1.425,0,0,-1.425,0,-1.5,-.84,.075,-.84,-1.5,.075,0,-1.5,.075,.798,-1.425,0,1.425,-.798,0,.84,-1.5,.075,1.5,-.84,.075];BufferGeometry.call(this),e=e||50,t=void 0!==t?Math.max(2,Math.floor(t)||10):10,o=void 0===o||o;var d=3.15*((l=void 0===l||l)?1:1.3)/2,f=e/d,m=(r=void 0===r||r)?(8*t-4)*t:0;m+=(n=void 0===n||n)?(16*t-4)*t:0,m+=(body=void 0===body||body)?40*t*t:0;var v=new Uint32Array(3*m),y=r?4:0;y+=n?8:0,y+=body?20:0,y*=(t+1)*(t+1);var x=new Float32Array(3*y),w=new Float32Array(3*y),M=new Float32Array(2*y),S=new Matrix4;S.set(-1,3,-3,1,3,-6,3,0,-3,3,0,0,1,0,0,0);var i,A,T,_,L,C,N,s,P,E,D,p,F,R,O,B,g=[],I=[],U=[],V=[],k=[],G=[],z=[],j=[],W=[],H=new Vector3,X=0,Y=0,Q=new Vector3,K=new Matrix4,J=new Matrix4,Z=new Vector4,$=new Vector4,ee=new Vector4,te=new Vector4,re=new Vector3,ie=new Vector3,ne=S.clone();ne.transpose();var ae=function(e,t,r){return!(x[3*e]===x[3*t]&&x[3*e+1]===x[3*t+1]&&x[3*e+2]===x[3*t+2]||x[3*e]===x[3*r]&&x[3*e+1]===x[3*r+1]&&x[3*e+2]===x[3*r+2]||x[3*t]===x[3*r]&&x[3*t+1]===x[3*r+1]&&x[3*t+2]===x[3*r+2])};for(i=0;i<3;i++)G[i]=new Matrix4;var oe=r?32:28;N=t+1;for(var se=0,le=0,ce=0,ue=0,he=0,de=body?0:20;de<oe;de++)if(n||de<20||de>=28){for(i=0;i<3;i++){for(A=0;A<4;A++)for(T=0;T<4;T++)g[4*T+A]=h[3*c[16*de+4*A+T]+i],o&&de>=20&&de<28&&2!==i&&(g[4*T+A]*=1.077),l||2!==i||(g[4*T+A]*=1.3);K.set(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]),J.multiplyMatrices(K,S),G[i].multiplyMatrices(ne,J)}for(L=0;L<=t;L++)for(s=L/t,C=0;C<=t;C++){for(P=C/t,p=4,E=D=1;p--;)I[p]=E,U[p]=D,E*=s,D*=P,3===p?(V[p]=k[p]=0,X=Y=1):(V[p]=X*(3-p),k[p]=Y*(3-p),X*=s,Y*=P);for(Z.fromArray(I),$.fromArray(U),ee.fromArray(V),te.fromArray(k),i=0;i<3;i++)(_=Z.clone()).applyMatrix4(G[i]),z[i]=_.dot($),(_=ee.clone()).applyMatrix4(G[i]),j[i]=_.dot($),(_=Z.clone()).applyMatrix4(G[i]),W[i]=_.dot(te);re.fromArray(j),ie.fromArray(W),H.crossVectors(ie,re),H.normalize(),0===z[0]&&0===z[1]?Q.set(0,z[2]>d?1:-1,0):Q.set(H.x,H.z,-H.y),x[le++]=f*z[0],x[le++]=f*(z[2]-d),x[le++]=-f*z[1],w[ce++]=Q.x,w[ce++]=Q.y,w[ce++]=Q.z,M[ue++]=1-P,M[ue++]=1-s}for(L=0;L<t;L++)for(C=0;C<t;C++)B=(F=se*N*N+L*N+C)+N,ae(F,R=F+1,O=R+N)&&(v[he++]=F,v[he++]=R,v[he++]=O),ae(F,O,B)&&(v[he++]=F,v[he++]=O,v[he++]=B);se++}this.setIndex(new BufferAttribute(v,1)),this.addAttribute("position",new BufferAttribute(x,3)),this.addAttribute("normal",new BufferAttribute(w,3)),this.addAttribute("uv",new BufferAttribute(M,2)),this.computeBoundingSphere()};function DataTexture(data,e,t,r,n,o,l,c,h,d,f,m){Texture.call(this,null,o,l,c,h,d,r,n,f,m),this.image={data:data,width:e,height:t},this.magFilter=void 0!==h?h:NearestFilter,this.minFilter=void 0!==d?d:NearestFilter,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function GPUComputationRenderer(e,t,r){this.variables=[],this.currentTextureIndex=0;var n=new Scene,o=new Camera;o.position.z=1;var l={texture:{value:null}},c=f("uniform sampler2D texture;\n\nvoid main() {\n\n\tvec2 uv = gl_FragCoord.xy / resolution.xy;\n\n\tgl_FragColor = texture2D( texture, uv );\n\n}\n",l),h=new Mesh(new PlaneBufferGeometry(2,2),c);function d(r){r.defines.resolution="vec2( "+e.toFixed(1)+", "+t.toFixed(1)+" )"}function f(e,t){var r=new ShaderMaterial({uniforms:t=t||{},vertexShader:"void main()\t{\n\n\tgl_Position = vec4( position, 1.0 );\n\n}\n",fragmentShader:e});return d(r),r}n.add(h),this.addVariable=function(e,t,r){var n={name:e,initialValueTexture:r,material:this.createShaderMaterial(t),dependencies:null,renderTargets:[],wrapS:null,wrapT:null,minFilter:NearestFilter,magFilter:NearestFilter};return this.variables.push(n),n},this.setVariableDependencies=function(e,t){e.dependencies=t},this.init=function(){if(!r.extensions.get("OES_texture_float"))return"No OES_texture_float support for float textures.";if(0===r.capabilities.maxVertexTextures)return"No support for vertex shader textures.";for(var i=0;i<this.variables.length;i++){var n=this.variables[i];n.renderTargets[0]=this.createRenderTarget(e,t,n.wrapS,n.wrapT,n.minFilter,n.magFilter),n.renderTargets[1]=this.createRenderTarget(e,t,n.wrapS,n.wrapT,n.minFilter,n.magFilter),this.renderTexture(n.initialValueTexture,n.renderTargets[0]),this.renderTexture(n.initialValueTexture,n.renderTargets[1]);var o=n.material,l=o.uniforms;if(null!==n.dependencies)for(var c=0;c<n.dependencies.length;c++){var h=n.dependencies[c];if(h.name!==n.name){for(var d=!1,f=0;f<this.variables.length;f++)if(h.name===this.variables[f].name){d=!0;break}if(!d)return"Variable dependency not found. Variable="+n.name+", dependency="+h.name}l[h.name]={value:null},o.fragmentShader="\nuniform sampler2D "+h.name+";\n"+o.fragmentShader}}return this.currentTextureIndex=0,null},this.compute=function(){for(var e=this.currentTextureIndex,t=0===this.currentTextureIndex?1:0,i=0,r=this.variables.length;i<r;i++){var n=this.variables[i];if(null!==n.dependencies)for(var o=n.material.uniforms,l=0,dl=n.dependencies.length;l<dl;l++){var c=n.dependencies[l];o[c.name].value=c.renderTargets[e].texture}this.doRenderTarget(n.material,n.renderTargets[t])}this.currentTextureIndex=t},this.getCurrentRenderTarget=function(e){return e.renderTargets[this.currentTextureIndex]},this.getAlternateRenderTarget=function(e){return e.renderTargets[0===this.currentTextureIndex?1:0]},this.addResolutionDefine=d,this.createShaderMaterial=f,this.createRenderTarget=function(r,n,o,l,c,h){return new WebGLRenderTarget(r=r||e,n=n||t,{wrapS:o=o||ClampToEdgeWrapping,wrapT:l=l||ClampToEdgeWrapping,minFilter:c=c||NearestFilter,magFilter:h=h||NearestFilter,format:RGBAFormat,type:/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?HalfFloatType:FloatType,stencilBuffer:!1,depthBuffer:!1})},this.createTexture=function(){var r=new DataTexture(new Float32Array(e*t*4),e,t,RGBAFormat,FloatType);return r.needsUpdate=!0,r},this.renderTexture=function(input,output){l.texture.value=input,this.doRenderTarget(c,output),l.texture.value=null},this.doRenderTarget=function(e,output){var t=r.getRenderTarget();h.material=e,r.setRenderTarget(output),r.render(n,o),h.material=c,r.setRenderTarget(t)}}TeapotBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TeapotBufferGeometry.prototype.constructor=TeapotBufferGeometry,DataTexture.prototype=Object.create(Texture.prototype),DataTexture.prototype.constructor=DataTexture,DataTexture.prototype.isDataTexture=!0;var Cache={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};function LoadingManager(e,t,r){var n=this,o=!1,l=0,c=0,h=void 0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){c++,!1===o&&void 0!==n.onStart&&n.onStart(e,l,c),o=!0},this.itemEnd=function(e){l++,void 0!==n.onProgress&&n.onProgress(e,l,c),l===c&&(o=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return h?h(e):e},this.setURLModifier=function(e){return h=e,this}}var DefaultLoadingManager=new LoadingManager;function ImageLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function TextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function PointsMaterial(e){Material$1.call(this),this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function Points(e,t){Object3D.call(this),this.type="Points",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new PointsMaterial({color:16777215*Math.random()})}Object.assign(ImageLoader.prototype,{crossOrigin:"anonymous",load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var o=this,l=Cache.get(e);if(void 0!==l)return o.manager.itemStart(e),setTimeout((function(){t&&t(l),o.manager.itemEnd(e)}),0),l;var image=document.createElementNS("http://www.w3.org/1999/xhtml","img");function c(){image.removeEventListener("load",c,!1),image.removeEventListener("error",h,!1),Cache.add(e,this),t&&t(this),o.manager.itemEnd(e)}function h(t){image.removeEventListener("load",c,!1),image.removeEventListener("error",h,!1),n&&n(t),o.manager.itemError(e),o.manager.itemEnd(e)}return image.addEventListener("load",c,!1),image.addEventListener("error",h,!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(image.crossOrigin=this.crossOrigin),o.manager.itemStart(e),image.src=e,image},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(TextureLoader.prototype,{crossOrigin:"anonymous",load:function(e,t,r,n){var o=new Texture,l=new ImageLoader(this.manager);return l.setCrossOrigin(this.crossOrigin),l.setPath(this.path),l.load(e,(function(image){o.image=image;var r=e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/);o.format=r?RGBFormat:RGBAFormat,o.needsUpdate=!0,void 0!==t&&t(o)}),r,n),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),PointsMaterial.prototype=Object.create(Material$1.prototype),PointsMaterial.prototype.constructor=PointsMaterial,PointsMaterial.prototype.isPointsMaterial=!0,PointsMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.map=source.map,this.size=source.size,this.sizeAttenuation=source.sizeAttenuation,this.morphTargets=source.morphTargets,this},Points.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Points,isPoints:!0,raycast:function(){var e=new Matrix4,t=new Ray,r=new Sphere;return function(n,o){var object=this,l=this.geometry,c=this.matrixWorld,h=n.params.Points.threshold;if(null===l.boundingSphere&&l.computeBoundingSphere(),r.copy(l.boundingSphere),r.applyMatrix4(c),r.radius+=h,!1!==n.ray.intersectsSphere(r)){e.getInverse(c),t.copy(n.ray).applyMatrix4(e);var d=h/((this.scale.x+this.scale.y+this.scale.z)/3),f=d*d,m=new Vector3,v=new Vector3;if(l.isBufferGeometry){var y=l.index,x=l.attributes.position.array;if(null!==y)for(var w=y.array,i=0,M=w.length;i<M;i++){var a=w[i];m.fromArray(x,3*a),T(m,a)}else{i=0;for(var S=x.length/3;i<S;i++)m.fromArray(x,3*i),T(m,i)}}else{var A=l.vertices;for(i=0,S=A.length;i<S;i++)T(A[i],i)}}function T(e,r){var l=t.distanceSqToPoint(e);if(l<f){t.closestPointToPoint(e,v),v.applyMatrix4(c);var h=n.ray.origin.distanceTo(v);if(h<n.near||h>n.far)return;o.push({distance:h,distanceToRay:Math.sqrt(l),point:v.clone(),index:r,face:null,object:object})}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}});var GPUParticleSystem=function(e){var t=this;Object3D.apply(this,arguments),e=e||{},this.PARTICLE_COUNT=e.maxParticles||1e6,this.PARTICLE_CONTAINERS=e.containerCount||1,this.PARTICLE_NOISE_TEXTURE=e.particleNoiseTex||null,this.PARTICLE_SPRITE_TEXTURE=e.particleSpriteTex||null,this.PARTICLES_PER_CONTAINER=Math.ceil(this.PARTICLE_COUNT/this.PARTICLE_CONTAINERS),this.PARTICLE_CURSOR=0,this.time=0,this.particleContainers=[],this.rand=[];var i,r={vertexShader:["uniform float uTime;","uniform float uScale;","uniform sampler2D tNoise;","attribute vec3 positionStart;","attribute float startTime;","attribute vec3 velocity;","attribute float turbulence;","attribute vec3 color;","attribute float size;","attribute float lifeTime;","varying vec4 vColor;","varying float lifeLeft;","void main() {","\tvColor = vec4( color, 1.0 );","\tvec3 newPosition;","\tvec3 v;","\tfloat timeElapsed = uTime - startTime;","\tlifeLeft = 1.0 - ( timeElapsed / lifeTime );","\tgl_PointSize = ( uScale * size ) * lifeLeft;","\tv.x = ( velocity.x - 0.5 ) * 3.0;","\tv.y = ( velocity.y - 0.5 ) * 3.0;","\tv.z = ( velocity.z - 0.5 ) * 3.0;","\tnewPosition = positionStart + ( v * 10.0 ) * timeElapsed;","\tvec3 noise = texture2D( tNoise, vec2( newPosition.x * 0.015 + ( uTime * 0.05 ), newPosition.y * 0.02 + ( uTime * 0.015 ) ) ).rgb;","\tvec3 noiseVel = ( noise.rgb - 0.5 ) * 30.0;","\tnewPosition = mix( newPosition, newPosition + vec3( noiseVel * ( turbulence * 5.0 ) ), ( timeElapsed / lifeTime ) );","\tif( v.y > 0. && v.y < .05 ) {","\t\tlifeLeft = 0.0;","\t}","\tif( v.x < - 1.45 ) {","\t\tlifeLeft = 0.0;","\t}","\tif( timeElapsed > 0.0 ) {","\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );","\t} else {","\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\t\tlifeLeft = 0.0;","\t\tgl_PointSize = 0.;","\t}","}"].join("\n"),fragmentShader:["float scaleLinear( float value, vec2 valueDomain ) {","\treturn ( value - valueDomain.x ) / ( valueDomain.y - valueDomain.x );","}","float scaleLinear( float value, vec2 valueDomain, vec2 valueRange ) {","\treturn mix( valueRange.x, valueRange.y, scaleLinear( value, valueDomain ) );","}","varying vec4 vColor;","varying float lifeLeft;","uniform sampler2D tSprite;","void main() {","\tfloat alpha = 0.;","\tif( lifeLeft > 0.995 ) {","\t\talpha = scaleLinear( lifeLeft, vec2( 1.0, 0.995 ), vec2( 0.0, 1.0 ) );","\t} else {","\t\talpha = lifeLeft * 0.75;","\t}","\tvec4 tex = texture2D( tSprite, gl_PointCoord );","\tgl_FragColor = vec4( vColor.rgb * tex.a, alpha * tex.a );","}"].join("\n")};for(i=1e5;i>0;i--)t.rand.push(Math.random()-.5);this.random=function(){return++i>=this.rand.length?this.rand[i=1]:this.rand[i]};var n=new TextureLoader;this.particleNoiseTex=this.PARTICLE_NOISE_TEXTURE||n.load("textures/perlin-512.png"),this.particleNoiseTex.wrapS=this.particleNoiseTex.wrapT=RepeatWrapping,this.particleSpriteTex=this.PARTICLE_SPRITE_TEXTURE||n.load("textures/particle2.png"),this.particleSpriteTex.wrapS=this.particleSpriteTex.wrapT=RepeatWrapping,this.particleShaderMat=new ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uScale:{value:1},tNoise:{value:this.particleNoiseTex},tSprite:{value:this.particleSpriteTex}},blending:AdditiveBlending,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.particleShaderMat.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],this.particleShaderMat.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],this.init=function(){for(var i=0;i<this.PARTICLE_CONTAINERS;i++){var e=new GPUParticleContainer(this.PARTICLES_PER_CONTAINER,this);this.particleContainers.push(e),this.add(e)}},this.spawnParticle=function(e){this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=1),this.particleContainers[Math.floor(this.PARTICLE_CURSOR/this.PARTICLES_PER_CONTAINER)].spawnParticle(e)},this.update=function(time){for(var i=0;i<this.PARTICLE_CONTAINERS;i++)this.particleContainers[i].update(time)},this.dispose=function(){this.particleShaderMat.dispose(),this.particleNoiseTex.dispose(),this.particleSpriteTex.dispose();for(var i=0;i<this.PARTICLE_CONTAINERS;i++)this.particleContainers[i].dispose()},this.init()};GPUParticleSystem.prototype=Object.create(Object3D.prototype),GPUParticleSystem.prototype.constructor=GPUParticleSystem;var GPUParticleContainer=function(e,t){Object3D.apply(this,arguments),this.PARTICLE_COUNT=e||1e5,this.PARTICLE_CURSOR=0,this.time=0,this.offset=0,this.count=0,this.DPR=window.devicePixelRatio,this.GPUParticleSystem=t,this.particleUpdate=!1,this.particleShaderGeo=new BufferGeometry,this.particleShaderGeo.addAttribute("position",new BufferAttribute(new Float32Array(3*this.PARTICLE_COUNT),3).setDynamic(!0)),this.particleShaderGeo.addAttribute("positionStart",new BufferAttribute(new Float32Array(3*this.PARTICLE_COUNT),3).setDynamic(!0)),this.particleShaderGeo.addAttribute("startTime",new BufferAttribute(new Float32Array(this.PARTICLE_COUNT),1).setDynamic(!0)),this.particleShaderGeo.addAttribute("velocity",new BufferAttribute(new Float32Array(3*this.PARTICLE_COUNT),3).setDynamic(!0)),this.particleShaderGeo.addAttribute("turbulence",new BufferAttribute(new Float32Array(this.PARTICLE_COUNT),1).setDynamic(!0)),this.particleShaderGeo.addAttribute("color",new BufferAttribute(new Float32Array(3*this.PARTICLE_COUNT),3).setDynamic(!0)),this.particleShaderGeo.addAttribute("size",new BufferAttribute(new Float32Array(this.PARTICLE_COUNT),1).setDynamic(!0)),this.particleShaderGeo.addAttribute("lifeTime",new BufferAttribute(new Float32Array(this.PARTICLE_COUNT),1).setDynamic(!0)),this.particleShaderMat=this.GPUParticleSystem.particleShaderMat;var r=new Vector3,n=new Vector3,o=new Color;this.spawnParticle=function(e){var l=this.particleShaderGeo.getAttribute("positionStart"),c=this.particleShaderGeo.getAttribute("startTime"),h=this.particleShaderGeo.getAttribute("velocity"),d=this.particleShaderGeo.getAttribute("turbulence"),f=this.particleShaderGeo.getAttribute("color"),m=this.particleShaderGeo.getAttribute("size"),v=this.particleShaderGeo.getAttribute("lifeTime");r=void 0!==(e=e||{}).position?r.copy(e.position):r.set(0,0,0),n=void 0!==e.velocity?n.copy(e.velocity):n.set(0,0,0),o=void 0!==e.color?o.set(e.color):o.set(16777215);var y=void 0!==e.positionRandomness?e.positionRandomness:0,x=void 0!==e.velocityRandomness?e.velocityRandomness:0,w=void 0!==e.colorRandomness?e.colorRandomness:1,M=void 0!==e.turbulence?e.turbulence:1,S=void 0!==e.lifetime?e.lifetime:5,A=void 0!==e.size?e.size:10,T=void 0!==e.sizeRandomness?e.sizeRandomness:0,_=void 0!==e.smoothPosition&&e.smoothPosition;void 0!==this.DPR&&(A*=this.DPR);var i=this.PARTICLE_CURSOR;l.array[3*i+0]=r.x+t.random()*y,l.array[3*i+1]=r.y+t.random()*y,l.array[3*i+2]=r.z+t.random()*y,!0===_&&(l.array[3*i+0]+=-n.x*t.random(),l.array[3*i+1]+=-n.y*t.random(),l.array[3*i+2]+=-n.z*t.random());var L=n.x+t.random()*x,C=n.y+t.random()*x,N=n.z+t.random()*x;L=_Math.clamp((L- -2)/4,0,1),C=_Math.clamp((C- -2)/4,0,1),N=_Math.clamp((N- -2)/4,0,1),h.array[3*i+0]=L,h.array[3*i+1]=C,h.array[3*i+2]=N,o.r=_Math.clamp(o.r+t.random()*w,0,1),o.g=_Math.clamp(o.g+t.random()*w,0,1),o.b=_Math.clamp(o.b+t.random()*w,0,1),f.array[3*i+0]=o.r,f.array[3*i+1]=o.g,f.array[3*i+2]=o.b,d.array[i]=M,m.array[i]=A+t.random()*T,v.array[i]=S,c.array[i]=this.time+.02*t.random(),0===this.offset&&(this.offset=this.PARTICLE_CURSOR),this.count++,this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=0),this.particleUpdate=!0},this.init=function(){this.particleSystem=new Points(this.particleShaderGeo,this.particleShaderMat),this.particleSystem.frustumCulled=!1,this.add(this.particleSystem)},this.update=function(time){this.time=time,this.particleShaderMat.uniforms.uTime.value=time,this.geometryUpdate()},this.geometryUpdate=function(){if(!0===this.particleUpdate){this.particleUpdate=!1;var e=this.particleShaderGeo.getAttribute("positionStart"),t=this.particleShaderGeo.getAttribute("startTime"),r=this.particleShaderGeo.getAttribute("velocity"),n=this.particleShaderGeo.getAttribute("turbulence"),o=this.particleShaderGeo.getAttribute("color"),l=this.particleShaderGeo.getAttribute("size"),c=this.particleShaderGeo.getAttribute("lifeTime");this.offset+this.count<this.PARTICLE_COUNT?(e.updateRange.offset=this.offset*e.itemSize,t.updateRange.offset=this.offset*t.itemSize,r.updateRange.offset=this.offset*r.itemSize,n.updateRange.offset=this.offset*n.itemSize,o.updateRange.offset=this.offset*o.itemSize,l.updateRange.offset=this.offset*l.itemSize,c.updateRange.offset=this.offset*c.itemSize,e.updateRange.count=this.count*e.itemSize,t.updateRange.count=this.count*t.itemSize,r.updateRange.count=this.count*r.itemSize,n.updateRange.count=this.count*n.itemSize,o.updateRange.count=this.count*o.itemSize,l.updateRange.count=this.count*l.itemSize,c.updateRange.count=this.count*c.itemSize):(e.updateRange.offset=0,t.updateRange.offset=0,r.updateRange.offset=0,n.updateRange.offset=0,o.updateRange.offset=0,l.updateRange.offset=0,c.updateRange.offset=0,e.updateRange.count=-1,t.updateRange.count=-1,r.updateRange.count=-1,n.updateRange.count=-1,o.updateRange.count=-1,l.updateRange.count=-1,c.updateRange.count=-1),e.needsUpdate=!0,t.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0,o.needsUpdate=!0,l.needsUpdate=!0,c.needsUpdate=!0,this.offset=0,this.count=0}},this.dispose=function(){this.particleShaderGeo.dispose()},this.init()};GPUParticleContainer.prototype=Object.create(Object3D.prototype),GPUParticleContainer.prototype.constructor=GPUParticleContainer;var Gyroscope=function(){Object3D.call(this)},translationObject,quaternionObject,scaleObject,translationWorld,quaternionWorld,scaleWorld;Gyroscope.prototype=Object.create(Object3D.prototype),Gyroscope.prototype.constructor=Gyroscope,Gyroscope.prototype.updateMatrixWorld=(translationObject=new Vector3,quaternionObject=new Quaternion,scaleObject=new Vector3,translationWorld=new Vector3,quaternionWorld=new Quaternion,scaleWorld=new Vector3,function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null!==this.parent?(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(translationWorld,quaternionWorld,scaleWorld),this.matrix.decompose(translationObject,quaternionObject,scaleObject),this.matrixWorld.compose(translationWorld,quaternionObject,scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var i=0,t=this.children.length;i<t;i++)this.children[i].updateMatrixWorld(e)});var ImprovedNoise=function(){for(var p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],i=0;i<256;i++)p[256+i]=p[i];function e(e){return e*e*e*(e*(6*e-15)+10)}function t(e,a,b){return a+e*(b-a)}function r(e,t,r,n){var o=15&e,u=o<8?t:r,l=o<4?r:12==o||14==o?t:n;return(0==(1&o)?u:-u)+(0==(2&o)?l:-l)}return{noise:function(n,o,l){var c=Math.floor(n),h=Math.floor(o),d=Math.floor(l),f=255&c,m=255&h,v=255&d,y=(n-=c)-1,x=(o-=h)-1,w=(l-=d)-1,u=e(n),M=e(o),S=e(l),A=p[f]+m,T=p[A]+v,_=p[A+1]+v,L=p[f+1]+m,C=p[L]+v,N=p[L+1]+v;return t(S,t(M,t(u,r(p[T],n,o,l),r(p[C],y,o,l)),t(u,r(p[_],n,x,l),r(p[N],y,x,l))),t(M,t(u,r(p[T+1],n,o,w),r(p[C+1],y,o,l-1)),t(u,r(p[_+1],n,x,w),r(p[N+1],y,x,w))))}}},p;function Frustum(e,t,r,n,o,l){this.planes=[void 0!==e?e:new Plane,void 0!==t?t:new Plane,void 0!==r?r:new Plane,void 0!==n?n:new Plane,void 0!==o?o:new Plane,void 0!==l?l:new Plane]}Object.assign(Frustum.prototype,{set:function(e,t,r,n,o,l){var c=this.planes;return c[0].copy(e),c[1].copy(t),c[2].copy(r),c[3].copy(n),c[4].copy(o),c[5].copy(l),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,n=r[0],o=r[1],l=r[2],c=r[3],h=r[4],d=r[5],f=r[6],m=r[7],v=r[8],y=r[9],x=r[10],w=r[11],M=r[12],S=r[13],A=r[14],T=r[15];return t[0].setComponents(c-n,m-h,w-v,T-M).normalize(),t[1].setComponents(c+n,m+h,w+v,T+M).normalize(),t[2].setComponents(c+o,m+d,w+y,T+S).normalize(),t[3].setComponents(c-o,m-d,w-y,T-S).normalize(),t[4].setComponents(c-l,m-f,w-x,T-A).normalize(),t[5].setComponents(c+l,m+f,w+x,T+A).normalize(),this},intersectsObject:function(){var e=new Sphere;return function(object){var t=object.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),e.copy(t.boundingSphere).applyMatrix4(object.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new Sphere;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,r=e.center,n=-e.radius,i=0;i<6;i++){if(t[i].distanceToPoint(r)<n)return!1}return!0},intersectsBox:(p=new Vector3,function(e){for(var t=this.planes,i=0;i<6;i++){var r=t[i];if(p.x=r.normal.x>0?e.max.x:e.min.x,p.y=r.normal.y>0?e.max.y:e.min.y,p.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(p)<0)return!1}return!0}),containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}});var SelectionBox=function(){var e=new Frustum,t=new Vector3;function r(e,t,r){this.camera=e,this.scene=t,this.startPoint=new Vector3,this.endPoint=new Vector3,this.collection=[],this.deep=r||Number.MAX_VALUE}return r.prototype.select=function(t,r){return this.startPoint=t||this.startPoint,this.endPoint=r||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(e,this.scene),this.collection},r.prototype.updateFrustum=function(t,r){t=t||this.startPoint,r=r||this.endPoint,this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld();var n=t.clone();n.x=Math.min(t.x,r.x),n.y=Math.max(t.y,r.y),r.x=Math.max(t.x,r.x),r.y=Math.min(t.y,r.y);var o=this.camera.position.clone(),l=n.clone(),c=new Vector3(r.x,n.y,0),h=r.clone(),d=new Vector3(n.x,r.y,0);l.unproject(this.camera),c.unproject(this.camera),h.unproject(this.camera),d.unproject(this.camera);var f=l.clone().sub(o),m=c.clone().sub(o),v=h.clone().sub(o);f.normalize(),m.normalize(),v.normalize(),f.multiplyScalar(this.deep),m.multiplyScalar(this.deep),v.multiplyScalar(this.deep),f.add(o),m.add(o),v.add(o);var y=e.planes;y[0].setFromCoplanarPoints(o,l,c),y[1].setFromCoplanarPoints(o,c,h),y[2].setFromCoplanarPoints(h,d,o),y[3].setFromCoplanarPoints(d,l,o),y[4].setFromCoplanarPoints(c,h,d),y[5].setFromCoplanarPoints(v,m,f),y[5].normal.multiplyScalar(-1)},r.prototype.searchChildInFrustum=function(e,object){if(object.isMesh&&void 0!==object.material&&(object.geometry.computeBoundingSphere(),t.copy(object.geometry.boundingSphere.center),t.applyMatrix4(object.matrixWorld),e.containsPoint(t)&&this.collection.push(object)),object.children.length>0)for(var r=0;r<object.children.length;r++)this.searchChildInFrustum(e,object.children[r])},r}(),SelectionHelper=function(){function e(e,t,r){this.element=document.createElement("div"),this.element.classList.add(r),this.element.style.pointerEvents="none",this.renderer=t,this.startPoint={x:0,y:0},this.pointTopLeft={x:0,y:0},this.pointBottomRight={x:0,y:0},this.isDown=!1,this.renderer.domElement.addEventListener("mousedown",function(e){this.isDown=!0,this.onSelectStart(e)}.bind(this),!1),this.renderer.domElement.addEventListener("mousemove",function(e){this.isDown&&this.onSelectMove(e)}.bind(this),!1),this.renderer.domElement.addEventListener("mouseup",function(e){this.isDown=!1,this.onSelectOver(e)}.bind(this),!1)}return e.prototype.onSelectStart=function(e){this.renderer.domElement.parentElement.appendChild(this.element),this.element.style.left=e.clientX+"px",this.element.style.top=e.clientY+"px",this.element.style.width="0px",this.element.style.height="0px",this.startPoint.x=e.clientX,this.startPoint.y=e.clientY},e.prototype.onSelectMove=function(e){this.pointBottomRight.x=Math.max(this.startPoint.x,e.clientX),this.pointBottomRight.y=Math.max(this.startPoint.y,e.clientY),this.pointTopLeft.x=Math.min(this.startPoint.x,e.clientX),this.pointTopLeft.y=Math.min(this.startPoint.y,e.clientY),this.element.style.left=this.pointTopLeft.x+"px",this.element.style.top=this.pointTopLeft.y+"px",this.element.style.width=this.pointBottomRight.x-this.pointTopLeft.x+"px",this.element.style.height=this.pointBottomRight.y-this.pointTopLeft.y+"px"},e.prototype.onSelectOver=function(){this.element.parentElement.removeChild(this.element)},e}();function InstancedBufferGeometry(){BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function InterleavedBuffer(e,t){this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function InstancedInterleavedBuffer(e,t,r){InterleavedBuffer.call(this,e,t),this.meshPerAttribute=r||1}function InterleavedBufferAttribute(e,t,r,n){this.data=e,this.itemSize=t,this.offset=r,this.normalized=!0===n}function WireframeGeometry(e){BufferGeometry.call(this),this.type="WireframeGeometry";var i,t,r,n,ol,o,l,c,h,d,f=[],m=[0,0],v={},y=["a","b","c"];if(e&&e.isGeometry){var x=e.faces;for(i=0,r=x.length;i<r;i++){var w=x[i];for(t=0;t<3;t++)l=w[y[t]],c=w[y[(t+1)%3]],m[0]=Math.min(l,c),m[1]=Math.max(l,c),void 0===v[h=m[0]+","+m[1]]&&(v[h]={index1:m[0],index2:m[1]})}for(h in v)o=v[h],d=e.vertices[o.index1],f.push(d.x,d.y,d.z),d=e.vertices[o.index2],f.push(d.x,d.y,d.z)}else if(e&&e.isBufferGeometry){var M,S,A,T,_,L,C;if(d=new Vector3,null!==e.index){for(M=e.attributes.position,S=e.index,0===(A=e.groups).length&&(A=[{start:0,count:S.count,materialIndex:0}]),n=0,ol=A.length;n<ol;++n)for(i=_=(T=A[n]).start,r=_+T.count;i<r;i+=3)for(t=0;t<3;t++)l=S.getX(i+t),c=S.getX(i+(t+1)%3),m[0]=Math.min(l,c),m[1]=Math.max(l,c),void 0===v[h=m[0]+","+m[1]]&&(v[h]={index1:m[0],index2:m[1]});for(h in v)o=v[h],d.fromBufferAttribute(M,o.index1),f.push(d.x,d.y,d.z),d.fromBufferAttribute(M,o.index2),f.push(d.x,d.y,d.z)}else for(i=0,r=(M=e.attributes.position).count/3;i<r;i++)for(t=0;t<3;t++)L=3*i+t,d.fromBufferAttribute(M,L),f.push(d.x,d.y,d.z),C=3*i+(t+1)%3,d.fromBufferAttribute(M,C),f.push(d.x,d.y,d.z)}this.addAttribute("position",new Float32BufferAttribute(f,3))}InstancedBufferGeometry.prototype=Object.assign(Object.create(BufferGeometry.prototype),{constructor:InstancedBufferGeometry,isInstancedBufferGeometry:!0,copy:function(source){return BufferGeometry.prototype.copy.call(this,source),this.maxInstancedCount=source.maxInstancedCount,this},clone:function(){return(new this.constructor).copy(this)}}),Object.defineProperty(InterleavedBuffer.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(InterleavedBuffer.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setArray:function(e){if(Array.isArray(e))throw new TypeError("BufferAttribute: array should be a Typed Array.");return this.count=void 0!==e?e.length/this.stride:0,this.array=e,this},setDynamic:function(e){return this.dynamic=e,this},copy:function(source){return this.array=new source.array.constructor(source.array),this.count=source.count,this.stride=source.stride,this.dynamic=source.dynamic,this},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(var i=0,n=this.stride;i<n;i++)this.array[e+i]=t.array[r+i];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),InstancedInterleavedBuffer.prototype=Object.assign(Object.create(InterleavedBuffer.prototype),{constructor:InstancedInterleavedBuffer,isInstancedInterleavedBuffer:!0,copy:function(source){return InterleavedBuffer.prototype.copy.call(this,source),this.meshPerAttribute=source.meshPerAttribute,this}}),Object.defineProperties(InterleavedBufferAttribute.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(InterleavedBufferAttribute.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this},setXYZW:function(e,t,r,n,o){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=o,this}}),WireframeGeometry.prototype=Object.create(BufferGeometry.prototype),WireframeGeometry.prototype.constructor=WireframeGeometry;var LineSegmentsGeometry=function(){InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";new BufferGeometry;this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.addAttribute("position",new Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.addAttribute("uv",new Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))};LineSegmentsGeometry.prototype=Object.assign(Object.create(InstancedBufferGeometry.prototype),{constructor:LineSegmentsGeometry,isLineSegmentsGeometry:!0,applyMatrix:function(e){var t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return void 0!==t&&(e.applyToBufferAttribute(t),e.applyToBufferAttribute(r),t.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var r=new InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceStart",new InterleavedBufferAttribute(r,3,0)),this.addAttribute("instanceEnd",new InterleavedBufferAttribute(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var r=new InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceColorStart",new InterleavedBufferAttribute(r,3,0)),this.addAttribute("instanceColorEnd",new InterleavedBufferAttribute(r,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new WireframeGeometry(e.geometry)),this},fromLineSegements:function(e){var t=e.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this},computeBoundingBox:function(){var e=new Box3;return function(){null===this.boundingBox&&(this.boundingBox=new Box3);var t=this.attributes.instanceStart,r=this.attributes.instanceEnd;void 0!==t&&void 0!==r&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(r),this.boundingBox.union(e))}}(),computeBoundingSphere:function(){var e=new Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,r=this.attributes.instanceEnd;if(void 0!==t&&void 0!==r){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var o=0,i=0,l=t.count;i<l;i++)e.fromBufferAttribute(t,i),o=Math.max(o,n.distanceToSquared(e)),e.fromBufferAttribute(r,i),o=Math.max(o,n.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error("LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}}(),toJSON:function(){},clone:function(){},copy:function(source){return this}}),UniformsLib.line={linewidth:{value:1},resolution:{value:new Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},ShaderLib.line={uniforms:UniformsUtils.merge([UniformsLib.common,UniformsLib.fog,UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};var LineMaterial=function(e){ShaderMaterial.call(this,{type:"LineMaterial",uniforms:UniformsUtils.clone(ShaderLib.line.uniforms),vertexShader:ShaderLib.line.vertexShader,fragmentShader:ShaderLib.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}}),this.setValues(e)};LineMaterial.prototype=Object.create(ShaderMaterial.prototype),LineMaterial.prototype.constructor=LineMaterial,LineMaterial.prototype.isLineMaterial=!0,LineMaterial.prototype.copy=function(source){return ShaderMaterial.prototype.copy.call(this,source),this.color.copy(source.color),this.linewidth=source.linewidth,this.resolution=source.resolution,this};var LineSegments2=function(e,t){Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==e?e:new LineSegmentsGeometry,this.material=void 0!==t?t:new LineMaterial({color:16777215*Math.random()})};LineSegments2.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:LineSegments2,isLineSegments2:!0,computeLineDistances:function(){var e=new Vector3,t=new Vector3;return function(){for(var r=this.geometry,n=r.attributes.instanceStart,o=r.attributes.instanceEnd,l=new Float32Array(2*n.data.count),i=0,c=0,h=n.data.count;i<h;i++,c+=2)e.fromBufferAttribute(n,i),t.fromBufferAttribute(o,i),l[c]=0===c?0:l[c-1],l[c+1]=l[c]+e.distanceTo(t);var d=new InstancedInterleavedBuffer(l,2,1);return r.addAttribute("instanceDistanceStart",new InterleavedBufferAttribute(d,1,0)),r.addAttribute("instanceDistanceEnd",new InterleavedBufferAttribute(d,1,1)),this}}(),copy:function(source){return this}});var LineGeometry=function(){LineSegmentsGeometry.call(this),this.type="LineGeometry"};LineGeometry.prototype=Object.assign(Object.create(LineSegmentsGeometry.prototype),{constructor:LineGeometry,isLineGeometry:!0,setPositions:function(e){for(var t=e.length-3,r=new Float32Array(2*t),i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return LineSegmentsGeometry.prototype.setPositions.call(this,r),this},setColors:function(e){for(var t=e.length-3,r=new Float32Array(2*t),i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return LineSegmentsGeometry.prototype.setColors.call(this,r),this},fromLine:function(line){var e=line.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(source){return this}});var Line2=function(e,t){LineSegments2.call(this),this.type="Line2",this.geometry=void 0!==e?e:new LineGeometry,this.material=void 0!==t?t:new LineMaterial({color:16777215*Math.random()})};Line2.prototype=Object.assign(Object.create(LineSegments2.prototype),{constructor:Line2,isLine2:!0,copy:function(source){return this}});var Wireframe=function(e,t){Mesh.call(this),this.type="Wireframe",this.geometry=void 0!==e?e:new LineSegmentsGeometry,this.material=void 0!==t?t:new LineMaterial({color:16777215*Math.random()})};Wireframe.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:Wireframe,isWireframe:!0,computeLineDistances:function(){var e=new Vector3,t=new Vector3;return function(){for(var r=this.geometry,n=r.attributes.instanceStart,o=r.attributes.instanceEnd,l=new Float32Array(2*n.data.count),i=0,c=0,h=n.data.count;i<h;i++,c+=2)e.fromBufferAttribute(n,i),t.fromBufferAttribute(o,i),l[c]=0===c?0:l[c-1],l[c+1]=l[c]+e.distanceTo(t);var d=new InstancedInterleavedBuffer(l,2,1);return r.addAttribute("instanceDistanceStart",new InterleavedBufferAttribute(d,1,0)),r.addAttribute("instanceDistanceEnd",new InterleavedBufferAttribute(d,1,1)),this}}(),copy:function(source){return this}});var WireframeGeometry2=function(e){LineSegmentsGeometry.call(this),this.type="WireframeGeometry2",this.fromWireframeGeometry(new WireframeGeometry(e))};WireframeGeometry2.prototype=Object.assign(Object.create(LineSegmentsGeometry.prototype),{constructor:WireframeGeometry2,isWireframeGeometry2:!0,copy:function(source){return this}});var loading={};function FileLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function MeshPhongMaterial(e){Material$1.call(this),this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}Object.assign(FileLoader.prototype,{load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var o=this,l=Cache.get(e);if(void 0!==l)return o.manager.itemStart(e),setTimeout((function(){t&&t(l),o.manager.itemEnd(e)}),0),l;if(void 0===loading[e]){var c=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(c){var h=c[1],d=!!c[2],data=c[3];data=decodeURIComponent(data),d&&(data=atob(data));try{var f,m=(this.responseType||"").toLowerCase();switch(m){case"arraybuffer":case"blob":for(var view=new Uint8Array(data.length),i=0;i<data.length;i++)view[i]=data.charCodeAt(i);f="blob"===m?new Blob([view.buffer],{type:h}):view.buffer;break;case"document":var v=new DOMParser;f=v.parseFromString(data,h);break;case"json":f=JSON.parse(data);break;default:f=data}setTimeout((function(){t&&t(f),o.manager.itemEnd(e)}),0)}catch(t){setTimeout((function(){n&&n(t),o.manager.itemError(e),o.manager.itemEnd(e)}),0)}}else{loading[e]=[],loading[e].push({onLoad:t,onProgress:r,onError:n});var y=new XMLHttpRequest;for(var header in y.open("GET",e,!0),y.addEventListener("load",(function(t){var r=this.response;Cache.add(e,r);var n=loading[e];if(delete loading[e],200===this.status||0===this.status){0===this.status&&console.warn("FileLoader: HTTP Status 0 received.");for(var i=0,l=n.length;i<l;i++){(c=n[i]).onLoad&&c.onLoad(r)}o.manager.itemEnd(e)}else{for(i=0,l=n.length;i<l;i++){var c;(c=n[i]).onError&&c.onError(t)}o.manager.itemError(e),o.manager.itemEnd(e)}}),!1),y.addEventListener("progress",(function(t){for(var r=loading[e],i=0,n=r.length;i<n;i++){var o=r[i];o.onProgress&&o.onProgress(t)}}),!1),y.addEventListener("error",(function(t){var r=loading[e];delete loading[e];for(var i=0,n=r.length;i<n;i++){var l=r[i];l.onError&&l.onError(t)}o.manager.itemError(e),o.manager.itemEnd(e)}),!1),y.addEventListener("abort",(function(t){var r=loading[e];delete loading[e];for(var i=0,n=r.length;i<n;i++){var l=r[i];l.onError&&l.onError(t)}o.manager.itemError(e),o.manager.itemEnd(e)}),!1),void 0!==this.responseType&&(y.responseType=this.responseType),void 0!==this.withCredentials&&(y.withCredentials=this.withCredentials),y.overrideMimeType&&y.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)y.setRequestHeader(header,this.requestHeader[header]);y.send(null)}return o.manager.itemStart(e),y}loading[e].push({onLoad:t,onProgress:r,onError:n})},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),MeshPhongMaterial.prototype=Object.create(Material$1.prototype),MeshPhongMaterial.prototype.constructor=MeshPhongMaterial,MeshPhongMaterial.prototype.isMeshPhongMaterial=!0,MeshPhongMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.specular.copy(source.specular),this.shininess=source.shininess,this.map=source.map,this.lightMap=source.lightMap,this.lightMapIntensity=source.lightMapIntensity,this.aoMap=source.aoMap,this.aoMapIntensity=source.aoMapIntensity,this.emissive.copy(source.emissive),this.emissiveMap=source.emissiveMap,this.emissiveIntensity=source.emissiveIntensity,this.bumpMap=source.bumpMap,this.bumpScale=source.bumpScale,this.normalMap=source.normalMap,this.normalMapType=source.normalMapType,this.normalScale.copy(source.normalScale),this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this.specularMap=source.specularMap,this.alphaMap=source.alphaMap,this.envMap=source.envMap,this.combine=source.combine,this.reflectivity=source.reflectivity,this.refractionRatio=source.refractionRatio,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.wireframeLinecap=source.wireframeLinecap,this.wireframeLinejoin=source.wireframeLinejoin,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this};var LoaderUtils={decodeText:function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var s="",i=0,t=e.length;i<t;i++)s+=String.fromCharCode(e[i]);return decodeURIComponent(escape(s))},extractUrlBase:function(e){var t=e.lastIndexOf("/");return-1===t?"./":e.substr(0,t+1)}},ThreeMFLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.availableExtensions=[]};ThreeMFLoader.prototype={constructor:ThreeMFLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(e){t(o.parse(e))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){var e=this;function t(e){var t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);var n=e.getAttribute("pid");n&&(t.pid=n);var o=e.getAttribute("pindex");o&&(t.pindex=o);var l=e.getAttribute("thumbnail");l&&(t.thumbnail=l);var c=e.getAttribute("partnumber");c&&(t.partnumber=c);var h=e.getAttribute("name");h&&(t.name=h);var d=e.querySelector("mesh");d&&(t.mesh=function(e,t){for(var r={},n=[],o=e.querySelectorAll("vertices vertex"),i=0;i<o.length;i++){var l=o[i],c=l.getAttribute("x"),h=l.getAttribute("y"),d=l.getAttribute("z");n.push(parseFloat(c),parseFloat(h),parseFloat(d))}for(r.vertices=new Float32Array(n.length),i=0;i<n.length;i++)r.vertices[i]=n[i];var f=[],m=[],v=e.querySelectorAll("triangles triangle");for(i=0;i<v.length;i++){var y=v[i],x=y.getAttribute("v1"),w=y.getAttribute("v2"),M=y.getAttribute("v3"),S=y.getAttribute("p1"),A=y.getAttribute("p2"),T=y.getAttribute("p3"),_=y.getAttribute("pid");m.push(parseInt(x,10),parseInt(w,10),parseInt(M,10));var L={};S&&(L.p1=parseInt(S,10)),A&&(L.p2=parseInt(A,10)),T&&(L.p3=parseInt(T,10)),_&&(L.pid=_),0<Object.keys(L).length&&f.push(L)}for(r.triangleProperties=f,r.triangles=new Uint32Array(m.length),i=0;i<m.length;i++)r.triangles[i]=m[i];return r}(d));var f=e.querySelector("components");return f&&(t.components=void 0),t}function r(e){var r={unit:e.getAttribute("unit")||"millimeter"},n=e.querySelectorAll("metadata");n&&(r.metadata=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i],n=r.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(n)&&(t[n]=r.textContent)}return t}(n));var o=e.querySelector("resources");o&&(r.resources=function(e){var r={},n=e.querySelector("basematerials");n&&(r.basematerial=void 0),r.object={};for(var o=e.querySelectorAll("object"),i=0;i<o.length;i++){var l=t(o[i]);r.object[l.id]=l}return r}(o));var l=e.querySelector("build");return l&&(r.build=function(e){for(var t=[],r=e.querySelectorAll("item"),i=0;i<r.length;i++){var n=r[i],o={objectid:n.getAttribute("objectid")},l=n.getAttribute("transform");if(l){var c=[];l.split(" ").forEach((function(s){c.push(parseFloat(s))}));var h=new Matrix4;o.transform=h.set(c[0],c[3],c[6],c[9],c[1],c[4],c[7],c[10],c[2],c[5],c[8],c[11],0,0,0,1)}t.push(o)}return t}(l)),r}function n(e,t){var r=new BufferGeometry;r.setIndex(new BufferAttribute(e.triangles,1)),r.addAttribute("position",new BufferAttribute(e.vertices,3)),e.colors&&r.addAttribute("color",new BufferAttribute(e.colors,3)),r.computeBoundingSphere();var n={flatShading:!0};return e.colors&&0<e.colors.length?n.vertexColors=VertexColors:n.color=11184895,new Mesh(r,new MeshPhongMaterial(n))}function o(t,r,n,o){if(t){for(var l=[],c=Object.keys(t),i=0;i<c.length;i++)for(var h=c[i],d=0;d<e.availableExtensions.length;d++){(f=e.availableExtensions[d]).ns===h&&l.push(f)}for(i=0;i<l.length;i++){var f;(f=l[i]).apply(n,t[f.ns],r)}}}var l=function(data){var e,t,n=null,o=null,l=[],c=[],h={},d={};try{n=new JSZip(data)}catch(e){if(e instanceof ReferenceError)return console.error("ThreeMFLoader: jszip missing and file is compressed."),null}for(o in n.files)o.match(/\.rels$/)?e=o:o.match(/^3D\/.*\.model$/)?l.push(o):o.match(/^3D\/Metadata\/.*\.xml$/)||(o.match(/^3D\/Textures\/.*/)?c.push(o):o.match(/^3D\/Other\/.*/));var f=new Uint8Array(n.file(e).asArrayBuffer());t=function(e){var t=(new DOMParser).parseFromString(e,"application/xml").querySelector("Relationship"),r=t.getAttribute("Target"),n=t.getAttribute("Id"),o=t.getAttribute("Type");return{target:r,id:n,type:o}}(LoaderUtils.decodeText(f));for(var i=0;i<l.length;i++){var m=l[i],view=new Uint8Array(n.file(m).asArrayBuffer()),v=LoaderUtils.decodeText(view),y=(new DOMParser).parseFromString(v,"application/xml");"model"!==y.documentElement.nodeName.toLowerCase()&&console.error("ThreeMFLoader: Error loading 3MF - no 3MF document found: ",m);var x=y.querySelector("model"),w={};for(i=0;i<x.attributes.length;i++){var M=x.attributes[i];M.name.match(/^xmlns:(.+)$/)&&(w[M.value]=RegExp.$1)}var S=r(x);S.xml=x,0<Object.keys(w).length&&(S.extensions=w),h[m]=S}for(i=0;i<c.length;i++){var A=c[i];d[A]=n.file(A).asBinary()}return{rels:t,model:h,printTicket:{},texture:d,other:{}}}(data);return function(e,t,r){for(var n=new Group,o=r.model[t.target.substring(1)].build,i=0;i<o.length;i++){var l=o[i],c=e[l.objectid];l.transform&&c.geometry.applyMatrix(l.transform),n.add(c)}return n}(function(e){for(var t=e.model,r={},l=Object.keys(t),i=0;i<l.length;i++)for(var c=t[l[i]],h=c.xml,d=c.extensions,f=Object.keys(c.resources.object),m=0;m<f.length;m++){var v=f[m],y=c.resources.object[v].mesh;o(d,y,h),r[v]=n(y)}return r}(l),l.rels,l)},addExtension:function(e){this.availableExtensions.push(e)}};var AMFLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};AMFLoader.prototype={constructor:AMFLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){function e(e){for(var r="AMF Material",n=e.attributes.id.textContent,o={r:1,g:1,b:1,a:1},l=null,i=0;i<e.childNodes.length;i++){var c=e.childNodes[i];"metadata"===c.nodeName&&void 0!==c.attributes.type?"name"===c.attributes.type.value&&(r=c.textContent):"color"===c.nodeName&&(o=t(c))}return l=new MeshPhongMaterial({flatShading:!0,color:new Color(o.r,o.g,o.b),name:r}),1!==o.a&&(l.transparent=!0,l.opacity=o.a),{id:n,material:l}}function t(e){for(var t={r:1,g:1,b:1,a:1},i=0;i<e.childNodes.length;i++){var r=e.childNodes[i];"r"===r.nodeName?t.r=r.textContent:"g"===r.nodeName?t.g=r.textContent:"b"===r.nodeName?t.b=r.textContent:"a"===r.nodeName&&(t.a=r.textContent)}return t}function r(e){var t={name:"",triangles:[],materialid:null},r=e.firstElementChild;for(void 0!==e.attributes.materialid&&(t.materialId=e.attributes.materialid.nodeValue);r;){if("metadata"===r.nodeName)void 0!==r.attributes.type&&"name"===r.attributes.type.value&&(t.name=r.textContent);else if("triangle"===r.nodeName){var n=r.getElementsByTagName("v1")[0].textContent,o=r.getElementsByTagName("v2")[0].textContent,l=r.getElementsByTagName("v3")[0].textContent;t.triangles.push(n,o,l)}r=r.nextElementSibling}return t}function n(e){for(var t=[],r=[],n=e.firstElementChild;n;){if("vertex"===n.nodeName)for(var o=n.firstElementChild;o;){if("coordinates"===o.nodeName){var l=o.getElementsByTagName("x")[0].textContent,c=o.getElementsByTagName("y")[0].textContent,h=o.getElementsByTagName("z")[0].textContent;t.push(l,c,h)}else if("normal"===o.nodeName){var d=o.getElementsByTagName("nx")[0].textContent,f=o.getElementsByTagName("ny")[0].textContent,m=o.getElementsByTagName("nz")[0].textContent;r.push(d,f,m)}o=o.nextElementSibling}n=n.nextElementSibling}return{vertices:t,normals:r}}function o(e){for(var o=e.attributes.id.textContent,l={name:"amfobject",meshes:[]},c=null,h=e.firstElementChild;h;){if("metadata"===h.nodeName)void 0!==h.attributes.type&&"name"===h.attributes.type.value&&(l.name=h.textContent);else if("color"===h.nodeName)c=t(h);else if("mesh"===h.nodeName){for(var d=h.firstElementChild,f={vertices:[],normals:[],volumes:[],color:c};d;){if("vertices"===d.nodeName){var m=n(d);f.normals=f.normals.concat(m.normals),f.vertices=f.vertices.concat(m.vertices)}else"volume"===d.nodeName&&f.volumes.push(r(d));d=d.nextElementSibling}l.meshes.push(f)}h=h.nextElementSibling}return{id:o,obj:l}}var i,l,c=function(data){var view=new DataView(data);if("PK"===String.fromCharCode(view.getUint8(0),view.getUint8(1))){var e=null,t=null;console.log("AMFLoader: Loading Zip");try{e=new JSZip(data)}catch(e){if(e instanceof ReferenceError)return console.log("AMFLoader: jszip missing and file is compressed."),null}for(t in e.files)if(".amf"===t.toLowerCase().substr(-4))break;console.log("AMFLoader: Trying to load file asset: "+t),view=new DataView(e.file(t).asArrayBuffer())}var r=LoaderUtils.decodeText(view),n=(new DOMParser).parseFromString(r,"application/xml");return"amf"!==n.documentElement.nodeName.toLowerCase()?(console.log("AMFLoader: Error loading AMF - no AMF document found."),null):n}(data),h="",d="",f=function(e){var t=1,r="millimeter";void 0!==e.documentElement.attributes.unit&&(r=e.documentElement.attributes.unit.value.toLowerCase());var n={millimeter:1,inch:25.4,feet:304.8,meter:1e3,micron:.001};return void 0!==n[r]&&(t=n[r]),console.log("AMFLoader: Unit scale: "+t),t}(c),m={},v={},y=c.documentElement.childNodes;for(i=0;i<y.length;i++){var x=y[i];if("metadata"===x.nodeName)void 0!==x.attributes.type&&("name"===x.attributes.type.value?h=x.textContent:"author"===x.attributes.type.value&&(d=x.textContent));else if("material"===x.nodeName){var w=e(x);m[w.id]=w.material}else if("object"===x.nodeName){var M=o(x);v[M.id]=M.obj}}var S=new Group,A=new MeshPhongMaterial({color:11184895,flatShading:!0});for(var T in S.name=h,S.userData.author=d,S.userData.loader="AMF",v){var _=v[T],L=_.meshes,C=new Group;for(C.name=_.name||"",i=0;i<L.length;i++){var N=A,P=L[i],E=new Float32BufferAttribute(P.vertices,3),D=null;if(P.normals.length&&(D=new Float32BufferAttribute(P.normals,3)),P.color){var F=P.color;(N=A.clone()).color=new Color(F.r,F.g,F.b),1!==F.a&&(N.transparent=!0,N.opacity=F.a)}var R=P.volumes;for(l=0;l<R.length;l++){var O=R[l],B=new BufferGeometry,I=N;B.setIndex(O.triangles),B.addAttribute("position",E.clone()),D&&B.addAttribute("normal",D.clone()),void 0!==m[O.materialId]&&(I=m[O.materialId]),B.scale(f,f,f),C.add(new Mesh(B,I.clone()))}}S.add(C)}return S}};var AssimpJSONLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager},offsetMatrix,identityMatrix;function Skeleton(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var i=0,r=this.bones.length;i<r;i++)this.boneInverses.push(new Matrix4)}}function SkinnedMesh(e,t){e&&e.isGeometry&&console.error("SkinnedMesh no longer supports Geometry. Use BufferGeometry instead."),Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4}AssimpJSONLoader.prototype={constructor:AssimpJSONLoader,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===o.path?LoaderUtils.extractUrlBase(e):o.path,l=new FileLoader(this.manager);l.setPath(o.path),l.load(e,(function(text){var e=JSON.parse(text),r=e.__metadata__;if(void 0!==r){if("assimp2json"!==r.format)return void n("AssimpJSONLoader: Not an assimp2json scene.");if(r.version<100&&r.version>=200)return void n("AssimpJSONLoader: Unsupported assimp2json file format version.")}t(o.parse(e,path))}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,path){function t(e,t){for(var r=new Array(e.length),i=0;i<e.length;++i)r[i]=t.call(this,e[i]);return r}var r=new TextureLoader(this.manager);r.setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin);var n=t(e.meshes,(function(e){var i,t,r,n=new BufferGeometry,o=[],l=e.vertices||[],c=e.normals||[],h=e.texturecoords||[],d=e.colors||[];for(h=h[0]||[],i=0,t=e.faces.length;i<t;i++)r=e.faces[i],o.push(r[0],r[1],r[2]);return n.setIndex(o),n.addAttribute("position",new Float32BufferAttribute(l,3)),c.length>0&&n.addAttribute("normal",new Float32BufferAttribute(c,3)),h.length>0&&n.addAttribute("uv",new Float32BufferAttribute(h,2)),d.length>0&&n.addAttribute("color",new Float32BufferAttribute(d,3)),n.computeBoundingSphere(),n})),o=t(e.materials,(function(e){var t=new MeshPhongMaterial;for(var i in e.properties){var n=e.properties[i],o=n.key,l=n.value;switch(o){case"$tex.file":var c=n.semantic;if(1===c||2===c||4===c||5===c||6===c){var h;switch(c){case 1:h="map";break;case 2:h="specularMap";break;case 4:h="emissiveMap";break;case 5:h="bumpMap";break;case 6:h="normalMap"}var d=r.load(l);d.wrapS=d.wrapT=RepeatWrapping,t[h]=d}break;case"?mat.name":t.name=l;break;case"$clr.diffuse":t.color.fromArray(l);break;case"$clr.specular":t.specular.fromArray(l);break;case"$clr.emissive":t.emissive.fromArray(l);break;case"$mat.shininess":t.shininess=l;break;case"$mat.shadingm":t.flatShading=1===l;break;case"$mat.opacity":l<1&&(t.opacity=l,t.transparent=!0)}}return t}));return function e(t,r,n,o){var i,l,c=new Object3D;for(c.name=r.name||"",c.matrix=(new Matrix4).fromArray(r.transformation).transpose(),c.matrix.decompose(c.position,c.quaternion,c.scale),i=0;r.meshes&&i<r.meshes.length;i++)l=r.meshes[i],c.add(new Mesh(n[l],o[t.meshes[l].materialindex]));for(i=0;r.children&&i<r.children.length;i++)c.add(e(t,r.children[i],n,o));return c}(e,e.rootnode,n,o)}},Object.assign(Skeleton.prototype,{calculateInverses:function(){this.boneInverses=[];for(var i=0,e=this.bones.length;i<e;i++){var t=new Matrix4;this.bones[i]&&t.getInverse(this.bones[i].matrixWorld),this.boneInverses.push(t)}},pose:function(){var e,i,t;for(i=0,t=this.bones.length;i<t;i++)(e=this.bones[i])&&e.matrixWorld.getInverse(this.boneInverses[i]);for(i=0,t=this.bones.length;i<t;i++)(e=this.bones[i])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:(offsetMatrix=new Matrix4,identityMatrix=new Matrix4,function(){for(var e=this.bones,t=this.boneInverses,r=this.boneMatrices,n=this.boneTexture,i=0,o=e.length;i<o;i++){var l=e[i]?e[i].matrixWorld:identityMatrix;offsetMatrix.multiplyMatrices(l,t[i]),offsetMatrix.toArray(r,16*i)}void 0!==n&&(n.needsUpdate=!0)}),clone:function(){return new Skeleton(this.bones,this.boneInverses)},getBoneByName:function(e){for(var i=0,t=this.bones.length;i<t;i++){var r=this.bones[i];if(r.name===e)return r}}}),SkinnedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:SkinnedMesh,isSkinnedMesh:!0,bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){for(var e=new Vector4,t=this.geometry.attributes.skinWeight,i=0,r=t.count;i<r;i++){e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.w=t.getW(i);var n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}},updateMatrixWorld:function(e){Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}});var AssimpLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};AssimpLoader.prototype={constructor:AssimpLoader,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===o.path?LoaderUtils.extractUrlBase(e):o.path,l=new FileLoader(this.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(e){t(o.parse(e,path))}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,path){var t=new TextureLoader(this.manager);t.setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin);var r={KeyFrame:function(time,e){this.time=time,this.matrix=e.clone(),this.position=new Vector3,this.quaternion=new Quaternion,this.scale=new Vector3(1,1,1),this.matrix.decompose(this.position,this.quaternion,this.scale),this.clone=function(){return new r.KeyFrame(this.time,this.matrix)},this.lerp=function(e,time){var t=(time-=this.time)/(e.time-this.time),n=1-t,o=this.position,l=this.quaternion,c=e.position,h=e.quaternion;return r.KeyFrame.tempAniPos.x=o.x*n+c.x*t,r.KeyFrame.tempAniPos.y=o.y*n+c.y*t,r.KeyFrame.tempAniPos.z=o.z*n+c.z*t,r.KeyFrame.tempAniQuat.set(l.x,l.y,l.z,l.w),r.KeyFrame.tempAniQuat.slerp(h,t),r.KeyFrame.tempAniMatrix.compose(r.KeyFrame.tempAniPos,r.KeyFrame.tempAniQuat,r.KeyFrame.tempAniScale)}}};r.KeyFrame.tempAniPos=new Vector3,r.KeyFrame.tempAniQuat=new Quaternion,r.KeyFrame.tempAniScale=new Vector3(1,1,1),r.KeyFrame.tempAniMatrix=new Matrix4,r.KeyFrameTrack=function(){this.keys=[],this.target=null,this.time=0,this.length=0,this._accelTable={},this.fps=20,this.addKey=function(e){this.keys.push(e)},this.init=function(){if(this.sortKeys(),this.keys.length>0?this.length=this.keys[this.keys.length-1].time:this.length=0,this.fps)for(var e=0;e<this.length*this.fps;e++)for(var i=0;i<this.keys.length;i++){if(this.keys[i].time==e){this._accelTable[e]=i;break}if(this.keys[i].time<e/this.fps&&this.keys[i+1]&&this.keys[i+1].time>=e/this.fps){this._accelTable[e]=i;break}}},this.parseFromThree=function(data){var e=data.fps;this.target=data.node;for(var track=data.hierarchy[0].keys,i=0;i<track.length;i++)this.addKey(new r.KeyFrame(i/e||track[i].time,track[i].targets[0].data));this.init()},this.parseFromCollada=function(data){for(var track=data.keys,e=this.fps,i=0;i<track.length;i++)this.addKey(new r.KeyFrame(i/e||track[i].time,track[i].matrix));this.init()},this.sortKeys=function(){this.keys.sort(this.keySortFunc)},this.keySortFunc=function(a,b){return a.time-b.time},this.clone=function(){var e=new r.KeyFrameTrack;e.target=this.target,e.time=this.time,e.length=this.length;for(var i=0;i<this.keys.length;i++)e.addKey(this.keys[i].clone());return e.init(),e},this.reTarget=function(e,t){t||(t=r.TrackTargetNodeNameCompare),this.target=t(e,this.target)},this.keySearchAccel=function(time){return time*=this.fps,time=Math.floor(time),this._accelTable[time]||0},this.setTime=function(time){time=Math.abs(time),this.length&&(time=time%this.length+.05);for(var e=null,t=null,i=this.keySearchAccel(time);i<this.keys.length;i++){if(this.keys[i].time==time){e=this.keys[i],t=this.keys[i];break}if(this.keys[i].time<time&&this.keys[i+1]&&this.keys[i+1].time>time){e=this.keys[i],t=this.keys[i+1];break}if(this.keys[i].time<time&&i==this.keys.length-1){e=this.keys[i],(t=this.keys[0].clone()).time+=this.length+.05;break}}return e&&t&&e!==t?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(e.lerp(t,time)),void(this.target.matrixWorldNeedsUpdate=!0)):e&&t&&e==t?(this.target.matrixAutoUpdate=!1,this.target.matrix.copy(e.matrix),void(this.target.matrixWorldNeedsUpdate=!0)):void 0}},r.TrackTargetNodeNameCompare=function(e,t){return function e(t,r){if(t.name==r)return t;for(var i=0;i<t.children.length;i++){var n=e(t.children[i],r);if(n)return n}return null}(e,t.name)},r.Animation=function(){this.tracks=[],this.length=0,this.addTrack=function(track){this.tracks.push(track),this.length=Math.max(track.length,this.length)},this.setTime=function(time){this.time=time;for(var i=0;i<this.tracks.length;i++)this.tracks[i].setTime(time)},this.clone=function(e,t){t||(t=r.TrackTargetNodeNameCompare);var n=new r.Animation;n.target=e;for(var i=0;i<this.tracks.length;i++){var track=this.tracks[i].clone();track.reTarget(e,t),n.addTrack(track)}return n}};var n=4660,o=4661,l=4662,c=4663,h=4664,d=4665,f=4666,m=4667,v=4668,y=4669,x=4670,w=1,M=2,S=4,A=256,T=65536,_=1,L=4,C=1,N=3,P=1,E=6,D=8,F=10,R=4;function O(e){return A<<e}function B(e){return T<<e}function I(e,t){var r=new Bone;for(var i in r.matrix.copy(e.matrix),r.matrixWorld.copy(e.matrixWorld),r.position.copy(e.position),r.quaternion.copy(e.quaternion),r.scale.copy(e.scale),t.nodeCount++,r.name="bone_"+e.name+t.nodeCount.toString(),t.nodeToBoneMap[e.name]||(t.nodeToBoneMap[e.name]=[]),t.nodeToBoneMap[e.name].push(r),e.children){var n=I(e.children[i],t);n&&r.add(n)}return r}function U(e,t){for(var r=[],i=0;i<e.length;i++)r.push({i:e[i],w:t[i]});for(r.sort((function(a,b){return b.w-a.w}));r.length<4;)r.push({i:0,w:0});r.length>4&&(r.length=4);var n=0;for(i=0;i<4;i++)n+=r[i].w*r[i].w;n=Math.sqrt(n);for(i=0;i<4;i++)r[i].w=r[i].w/n,e[i]=r[i].i,t[i]=r[i].w}function V(e,t){if(0==e.name.indexOf("bone_"+t))return e;for(var i in e.children){var r=V(e.children[i],t);if(r)return r}}function k(){this.mPrimitiveTypes=0,this.mNumVertices=0,this.mNumFaces=0,this.mNumBones=0,this.mMaterialIndex=0,this.mVertices=[],this.mNormals=[],this.mTangents=[],this.mBitangents=[],this.mColors=[[]],this.mTextureCoords=[[]],this.mFaces=[],this.mBones=[],this.hookupSkeletons=function(e,t){if(0!=this.mBones.length){for(var r=[],n=[],o=e.findNode(this.mBones[0].mName);o.mParent&&o.mParent.isBone;)o=o.mParent;var l=I(h=o.toTHREE(e),e);this.threeNode.add(l);for(var i=0;i<this.mBones.length;i++){if(d=V(l,this.mBones[i].mName)){var c=d;r.push(c),n.push(this.mBones[i].mOffsetMatrix.toTHREE())}else{if(!(o=e.findNode(this.mBones[i].mName)))return;var h;(h=o.toTHREE(e)).parent,l=I(h,e);this.threeNode.add(l);var d;c=d=V(l,this.mBones[i].mName);r.push(c),n.push(this.mBones[i].mOffsetMatrix.toTHREE())}}var f=new Skeleton(r,n);this.threeNode.bind(f,new Matrix4),this.threeNode.material.skinning=!0}},this.toTHREE=function(e){if(this.threeNode)return this.threeNode;var t,r,n=new BufferGeometry;if(t=e.mMaterials[this.mMaterialIndex]?e.mMaterials[this.mMaterialIndex].toTHREE(e):new MeshLambertMaterial,n.setIndex(new BufferAttribute(new Uint32Array(this.mIndexArray),1)),n.addAttribute("position",new BufferAttribute(this.mVertexBuffer,3)),this.mNormalBuffer&&this.mNormalBuffer.length>0&&n.addAttribute("normal",new BufferAttribute(this.mNormalBuffer,3)),this.mColorBuffer&&this.mColorBuffer.length>0&&n.addAttribute("color",new BufferAttribute(this.mColorBuffer,4)),this.mTexCoordsBuffers[0]&&this.mTexCoordsBuffers[0].length>0&&n.addAttribute("uv",new BufferAttribute(new Float32Array(this.mTexCoordsBuffers[0]),2)),this.mTexCoordsBuffers[1]&&this.mTexCoordsBuffers[1].length>0&&n.addAttribute("uv1",new BufferAttribute(new Float32Array(this.mTexCoordsBuffers[1]),2)),this.mTangentBuffer&&this.mTangentBuffer.length>0&&n.addAttribute("tangents",new BufferAttribute(this.mTangentBuffer,3)),this.mBitangentBuffer&&this.mBitangentBuffer.length>0&&n.addAttribute("bitangents",new BufferAttribute(this.mBitangentBuffer,3)),this.mBones.length>0){for(var o=[],l=[],i=0;i<this.mBones.length;i++)for(var c=0;c<this.mBones[i].mWeights.length;c++){var h=this.mBones[i].mWeights[c];h&&(o[h.mVertexId]||(o[h.mVertexId]=[]),l[h.mVertexId]||(l[h.mVertexId]=[]),o[h.mVertexId].push(h.mWeight),l[h.mVertexId].push(parseInt(i)))}for(var i in l)U(l[i],o[i]);var d=[],f=[];for(i=0;i<o.length;i++)for(c=0;c<4;c++)o[i]&&l[i]?(d.push(o[i][c]),f.push(l[i][c])):(d.push(0),f.push(0));n.addAttribute("skinWeight",new BufferAttribute(new Float32Array(d),R)),n.addAttribute("skinIndex",new BufferAttribute(new Float32Array(f),R))}return 0==this.mBones.length&&(r=new Mesh(n,t)),this.mBones.length>0&&(r=new SkinnedMesh(n,t)).normalizeSkinWeights(),this.threeNode=r,r}}function G(){this.mNumIndices=0,this.mIndices=[]}function z(){this.x=0,this.y=0,this.z=0,this.toTHREE=function(){return new Vector3(this.x,this.y,this.z)}}function j(){this.r=0,this.g=0,this.b=0,this.a=0,this.toTHREE=function(){return new Color(this.r,this.g,this.b,1)}}function W(){this.x=0,this.y=0,this.z=0,this.w=0,this.toTHREE=function(){return new Quaternion(this.x,this.y,this.z,this.w)}}function H(){this.mVertexId=0,this.mWeight=0}function X(){this.data=[],this.toString=function(){var e="";return this.data.forEach((function(i){e+=String.fromCharCode(i)})),e.replace(/[^\x20-\x7E]+/g,"")}}function Y(){this.mTime=0,this.mValue=null}function Q(){this.mTime=0,this.mValue=null}function K(){this.mName="",this.mTransformation=[],this.mNumChildren=0,this.mNumMeshes=0,this.mMeshes=[],this.mChildren=[],this.toTHREE=function(e){if(this.threeNode)return this.threeNode;var t=new Object3D;t.name=this.mName,t.matrix=this.mTransformation.toTHREE();for(var i=0;i<this.mChildren.length;i++)t.add(this.mChildren[i].toTHREE(e));for(i=0;i<this.mMeshes.length;i++)t.add(e.mMeshes[this.mMeshes[i]].toTHREE(e));return this.threeNode=t,t.matrix.decompose(t.position,t.quaternion,t.scale),t}}function J(){this.mName="",this.mNumWeights=0,this.mOffsetMatrix=0}function Z(){this.mKey="",this.mSemantic=0,this.mIndex=0,this.mData=[],this.mDataLength=0,this.mType=0,this.dataAsColor=function(){var e=new Uint8Array(this.mData).buffer,t=new DataView(e);return new Color(t.getFloat32(0,!0),t.getFloat32(4,!0),t.getFloat32(8,!0))},this.dataAsFloat=function(){var e=new Uint8Array(this.mData).buffer;return new DataView(e).getFloat32(0,!0)},this.dataAsBool=function(){var e=new Uint8Array(this.mData).buffer;return!!new DataView(e).getFloat32(0,!0)},this.dataAsString=function(){var s=new X;return s.data=this.mData,s.toString()},this.dataAsMap=function(){var s=new X;s.data=this.mData;var path=s.toString();return-1!=(path=path.replace(/\\/g,"/")).indexOf("/")&&(path=path.substr(path.lastIndexOf("/")+1)),t.load(path)}}var $={"?mat.name":"name","$mat.shadingm":"shading","$mat.twosided":"twoSided","$mat.wireframe":"wireframe","$clr.ambient":"ambient","$clr.diffuse":"color","$clr.specular":"specular","$clr.emissive":"emissive","$clr.transparent":"transparent","$clr.reflective":"reflect","$mat.shininess":"shininess","$mat.reflectivity":"reflectivity","$mat.refracti":"refraction","$tex.file":"map"},ee={"?mat.name":"string","$mat.shadingm":"bool","$mat.twosided":"bool","$mat.wireframe":"bool","$clr.ambient":"color","$clr.diffuse":"color","$clr.specular":"color","$clr.emissive":"color","$clr.transparent":"color","$clr.reflective":"color","$mat.shininess":"float","$mat.reflectivity":"float","$mat.refracti":"float","$tex.file":"map"};function te(){this.mNumAllocated=0,this.mNumProperties=0,this.mProperties=[],this.toTHREE=function(e){this.mProperties[0].dataAsString();for(var t=new MeshPhongMaterial,i=0;i<this.mProperties.length;i++)if("float"==ee[this.mProperties[i].mKey]&&(t[$[this.mProperties[i].mKey]]=this.mProperties[i].dataAsFloat()),"color"==ee[this.mProperties[i].mKey]&&(t[$[this.mProperties[i].mKey]]=this.mProperties[i].dataAsColor()),"bool"==ee[this.mProperties[i].mKey]&&(t[$[this.mProperties[i].mKey]]=this.mProperties[i].dataAsBool()),"string"==ee[this.mProperties[i].mKey]&&(t[$[this.mProperties[i].mKey]]=this.mProperties[i].dataAsString()),"map"==ee[this.mProperties[i].mKey]){var r=this.mProperties[i];r.mSemantic==P&&(t.map=this.mProperties[i].dataAsMap()),r.mSemantic==E&&(t.normalMap=this.mProperties[i].dataAsMap()),r.mSemantic==F&&(t.lightMap=this.mProperties[i].dataAsMap()),r.mSemantic==D&&(t.alphaMap=this.mProperties[i].dataAsMap())}return t.ambient.r=.53,t.ambient.g=.53,t.ambient.b=.53,t.color.r=1,t.color.g=1,t.color.b=1,t}}function re(e,t,r){var n=new Vector3,o=1-r;return n.x=e.x*r+t.x*o,n.y=e.y*r+t.y*o,n.z=e.z*r+t.z*o,n}function ie(e,t,r){return e.clone().slerp(t,1-r)}function ne(e,time,t,r){if(1==e.length)return e[0].mValue.toTHREE();for(var n=1/0,o=null,l=null,i=0;i<e.length;i++){var c=Math.abs(e[i].mTime-time);c<n&&e[i].mTime<=time&&(n=c,o=e[i],l=e[i+1])}if(o){if(l){var h=l.mTime-o.mTime,d=(o.mTime-time)/h;return r(o.mValue.toTHREE(),l.mValue.toTHREE(),d)}(l=e[0].clone()).mTime+=t;h=l.mTime-o.mTime,d=(o.mTime-time)/h;return r(o.mValue.toTHREE(),l.mValue.toTHREE(),d)}return null}function ae(){this.mNodeName="",this.mNumPositionKeys=0,this.mNumRotationKeys=0,this.mNumScalingKeys=0,this.mPositionKeys=[],this.mRotationKeys=[],this.mScalingKeys=[],this.mPreState="",this.mPostState="",this.init=function(e){function t(t){t.mTime/=e}e||(e=1),this.mPositionKeys.forEach(t),this.mRotationKeys.forEach(t),this.mScalingKeys.forEach(t)},this.sortKeys=function(){function e(a,b){return a.mTime-b.mTime}this.mPositionKeys.sort(e),this.mRotationKeys.sort(e),this.mScalingKeys.sort(e)},this.getLength=function(){return Math.max(Math.max.apply(null,this.mPositionKeys.map((function(a){return a.mTime}))),Math.max.apply(null,this.mRotationKeys.map((function(a){return a.mTime}))),Math.max.apply(null,this.mScalingKeys.map((function(a){return a.mTime}))))},this.toTHREE=function(e,t){this.sortKeys();for(var n=this.getLength(),track=new r.KeyFrameTrack,i=0;i<n;i+=.05){var o=new Matrix4,time=i,l=ne(this.mPositionKeys,time,n,re),c=ne(this.mScalingKeys,time,n,re),h=ne(this.mRotationKeys,time,n,ie);o.compose(l,h,c);var d=new r.KeyFrame(time,o);track.addKey(d)}track.target=e.findNode(this.mNodeName).toTHREE();var f=[track];if(e.nodeToBoneMap[this.mNodeName])for(i=0;i<e.nodeToBoneMap[this.mNodeName].length;i++){var m=track.clone();m.target=e.nodeToBoneMap[this.mNodeName][i],f.push(m)}return f}}function oe(){this.mName="",this.mDuration=0,this.mTicksPerSecond=0,this.mNumChannels=0,this.mChannels=[],this.toTHREE=function(e){var t=new r.Animation;for(var i in this.mChannels){this.mChannels[i].init(this.mTicksPerSecond);var n=this.mChannels[i].toTHREE(e);for(var o in n)n[o].init(),t.addTrack(n[o])}return t.length=Math.max.apply(null,t.tracks.map((function(e){return e.length}))),t}}function se(){this.mWidth=0,this.mHeight=0,this.texAchFormatHint=[],this.pcData=[]}function le(){this.mName="",this.mType=0,this.mAttenuationConstant=0,this.mAttenuationLinear=0,this.mAttenuationQuadratic=0,this.mAngleInnerCone=0,this.mAngleOuterCone=0,this.mColorDiffuse=null,this.mColorSpecular=null,this.mColorAmbient=null}function ce(){this.mName="",this.mPosition=null,this.mLookAt=null,this.mUp=null,this.mHorizontalFOV=0,this.mClipPlaneNear=0,this.mClipPlaneFar=0,this.mAspect=0}function ue(){this.mFlags=0,this.mNumMeshes=0,this.mNumMaterials=0,this.mNumAnimations=0,this.mNumTextures=0,this.mNumLights=0,this.mNumCameras=0,this.mRootNode=null,this.mMeshes=[],this.mMaterials=[],this.mAnimations=[],this.mLights=[],this.mCameras=[],this.nodeToBoneMap={},this.findNode=function(e,t){if(t||(t=this.mRootNode),t.mName==e)return t;for(var i=0;i<t.mChildren.length;i++){var r=this.findNode(e,t.mChildren[i]);if(r)return r}return null},this.toTHREE=function(){this.nodeCount=0,function(e){for(var i in e.mMeshes){var t=e.mMeshes[i];for(var r in t.mBones){var n=e.findNode(t.mBones[r].mName);n&&(n.isBone=!0)}}}(this);var e=this.mRootNode.toTHREE(this);for(var i in this.mMeshes)this.mMeshes[i].hookupSkeletons(this,e);if(this.mAnimations.length>0)var a=this.mAnimations[0].toTHREE(this);return{object:e,animation:a}}}function he(){this.elements=[[],[],[],[]],this.toTHREE=function(){for(var e=new Matrix4,i=0;i<4;++i)for(var t=0;t<4;++t)e.elements[4*i+t]=this.elements[t][i];return e}}var de=!0;function pe(e){var t=e.getFloat32(e.readOffset,de);return e.readOffset+=4,t}function fe(e){var t=e.getFloat64(e.readOffset,de);return e.readOffset+=8,t}function me(e){var t=e.getUint16(e.readOffset,de);return e.readOffset+=2,t}function ve(e){var t=e.getUint32(e.readOffset,de);return e.readOffset+=4,t}function ge(e){var t=e.getUint32(e.readOffset,de);return e.readOffset+=4,t}function ye(e){var t=new z;return t.x=pe(e),t.y=pe(e),t.z=pe(e),t}function xe(e){var t=new j;return t.r=pe(e),t.g=pe(e),t.b=pe(e),t}function be(e){var s=new X,t=ve(e);return e.ReadBytes(s.data,1,t),s.toString()}function we(e){var t=new H;return t.mVertexId=ve(e),t.mWeight=pe(e),t}function Me(e){for(var t=new he,i=0;i<4;++i)for(var r=0;r<4;++r)t.elements[i][r]=pe(e);return t}function Se(e){var t=new Y;return t.mTime=fe(e),t.mValue=ye(e),t}function Ae(e){var t=new Q;return t.mTime=fe(e),t.mValue=function(e){var t=new W;return t.w=pe(e),t.x=pe(e),t.y=pe(e),t.z=pe(e),t}(e),t}function Te(e,data,t){for(var i=0;i<t;i++)data[i]=Se(e)}function _e(e,t,r){return e.Seek(sizeof(t)*r,ke)}function Le(e){if(!e)throw"asset failed"}function Ce(e,b){return Le(ge(e)==f),ge(e),b.mName=be(e),b.mNumWeights=ve(e),b.mOffsetMatrix=Me(e),Ue?_e(e,b.mWeights,b.mNumWeights):(b.mWeights=[],function(e,data,t){for(var i=0;i<t;i++)data[i]=we(e)}(e,b.mWeights,b.mNumWeights)),b}function Ne(e,t){Le(ge(e)==c),ge(e),t.mPrimitiveTypes=ve(e),t.mNumVertices=ve(e),t.mNumFaces=ve(e),t.mNumBones=ve(e),t.mMaterialIndex=ve(e),t.mNumUVComponents=[];var r=ve(e);r&w&&(Ue?_e(e,t.mVertices,t.mNumVertices):(t.mVertices=[],t.mVertexBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,ke))),r&M&&(Ue?_e(e,t.mNormals,t.mNumVertices):(t.mNormals=[],t.mNormalBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,ke))),r&S&&(Ue?(_e(e,t.mTangents,t.mNumVertices),_e(e,t.mBitangents,t.mNumVertices)):(t.mTangents=[],t.mTangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,ke),t.mBitangents=[],t.mBitangentBuffer=e.subArray32(e.readOffset,e.readOffset+3*t.mNumVertices*4),e.Seek(3*t.mNumVertices*4,ke)));for(var n=0;n<_&&r&B(n);++n)Ue?_e(e,t.mColors[n],t.mNumVertices):(t.mColors[n]=[],t.mColorBuffer=e.subArray32(e.readOffset,e.readOffset+4*t.mNumVertices*4),e.Seek(4*t.mNumVertices*4,ke));t.mTexCoordsBuffers=[];for(n=0;n<L&&r&O(n);++n)if(t.mNumUVComponents[n]=ve(e),Ue)_e(e,t.mTextureCoords[n],t.mNumVertices);else{t.mTextureCoords[n]=[],t.mTexCoordsBuffers[n]=[];for(var o=0;o<t.mNumVertices;o++)t.mTexCoordsBuffers[n].push(pe(e)),t.mTexCoordsBuffers[n].push(pe(e)),pe(e)}if(Ue)ve(e);else{t.mFaces=[],t.mIndexArray=[];for(var i=0;i<t.mNumFaces;++i){var l=t.mFaces[i]=new G;l.mNumIndices=me(e),l.mIndices=[];for(var a=0;a<l.mNumIndices;++a)t.mNumVertices<65536?l.mIndices[a]=me(e):l.mIndices[a]=ve(e);if(3===l.mNumIndices)t.mIndexArray.push(l.mIndices[0]),t.mIndexArray.push(l.mIndices[1]),t.mIndexArray.push(l.mIndices[2]);else{if(4!==l.mNumIndices)throw new Error("Sorry, can't currently triangulate polys. Use the triangulate preprocessor in Assimp.");t.mIndexArray.push(l.mIndices[0]),t.mIndexArray.push(l.mIndices[1]),t.mIndexArray.push(l.mIndices[2]),t.mIndexArray.push(l.mIndices[2]),t.mIndexArray.push(l.mIndices[3]),t.mIndexArray.push(l.mIndices[0])}}}if(t.mNumBones){t.mBones=[];for(a=0;a<t.mNumBones;++a)t.mBones[a]=new J,Ce(e,t.mBones[a])}}function Pe(e,t){Le(ge(e)==x),ge(e),t.mKey=be(e),t.mSemantic=ve(e),t.mIndex=ve(e),t.mDataLength=ve(e),t.mType=ve(e),t.mData=[],e.ReadBytes(t.mData,1,t.mDataLength)}function Ee(e,t){if(Le(ge(e)==y),ge(e),t.mNumAllocated=t.mNumProperties=ve(e),t.mNumProperties){t.mProperties&&delete t.mProperties,t.mProperties=[];for(var i=0;i<t.mNumProperties;++i)t.mProperties[i]=new Z,Pe(e,t.mProperties[i])}}function De(e,t){Le(ge(e)==h),ge(e),t.mNodeName=be(e),t.mNumPositionKeys=ve(e),t.mNumRotationKeys=ve(e),t.mNumScalingKeys=ve(e),t.mPreState=ve(e),t.mPostState=ve(e),t.mNumPositionKeys&&(Ue?_e(e,t.mPositionKeys,t.mNumPositionKeys):(t.mPositionKeys=[],Te(e,t.mPositionKeys,t.mNumPositionKeys))),t.mNumRotationKeys&&(Ue?_e(e,t.mRotationKeys,t.mNumRotationKeys):(t.mRotationKeys=[],function(e,data,t){for(var i=0;i<t;i++)data[i]=Ae(e)}(e,t.mRotationKeys,t.mNumRotationKeys))),t.mNumScalingKeys&&(Ue?_e(e,t.mScalingKeys,t.mNumScalingKeys):(t.mScalingKeys=[],Te(e,t.mScalingKeys,t.mNumScalingKeys)))}function Fe(e,t){if(Le(ge(e)==m),ge(e),t.mName=be(e),t.mDuration=fe(e),t.mTicksPerSecond=fe(e),t.mNumChannels=ve(e),t.mNumChannels){t.mChannels=[];for(var a=0;a<t.mNumChannels;++a)t.mChannels[a]=new ae,De(e,t.mChannels[a])}}function Re(e,t){Le(ge(e)==l),ge(e),t.mWidth=ve(e),t.mHeight=ve(e),e.ReadBytes(t.achFormatHint,1,4),Ue||(t.mHeight?(t.pcData=[],e.ReadBytes(t.pcData,1,t.mWidth*t.mHeight*4)):(t.pcData=[],e.ReadBytes(t.pcData,1,t.mWidth)))}function Oe(e,t){Le(ge(e)==o),ge(e),t.mName=be(e),t.mType=ve(e),t.mType!=C&&(t.mAttenuationConstant=pe(e),t.mAttenuationLinear=pe(e),t.mAttenuationQuadratic=pe(e)),t.mColorDiffuse=xe(e),t.mColorSpecular=xe(e),t.mColorAmbient=xe(e),t.mType==N&&(t.mAngleInnerCone=pe(e),t.mAngleOuterCone=pe(e))}function Be(e,t){Le(ge(e)==n),ge(e),t.mName=be(e),t.mPosition=ye(e),t.mLookAt=ye(e),t.mUp=ye(e),t.mHorizontalFOV=pe(e),t.mClipPlaneNear=pe(e),t.mClipPlaneFar=pe(e),t.mAspect=pe(e)}function Ie(e,t){if(Le(ge(e)==d),ge(e),t.mFlags=ve(e),t.mNumMeshes=ve(e),t.mNumMaterials=ve(e),t.mNumAnimations=ve(e),t.mNumTextures=ve(e),t.mNumLights=ve(e),t.mNumCameras=ve(e),t.mRootNode=new K,t.mRootNode=function e(t,r,n){Le(ge(t)==v),ge(t);var o=new K;if(o.mParent=r,o.mDepth=n,o.mName=be(t),o.mTransformation=Me(t),o.mNumChildren=ve(t),o.mNumMeshes=ve(t),o.mNumMeshes){o.mMeshes=[];for(var i=0;i<o.mNumMeshes;++i)o.mMeshes[i]=ve(t)}if(o.mNumChildren){o.mChildren=[];for(i=0;i<o.mNumChildren;++i){var l=e(t,o,n++);o.mChildren[i]=l}}return o}(e,null,0),t.mNumMeshes){t.mMeshes=[];for(var i=0;i<t.mNumMeshes;++i)t.mMeshes[i]=new k,Ne(e,t.mMeshes[i])}if(t.mNumMaterials){t.mMaterials=[];for(i=0;i<t.mNumMaterials;++i)t.mMaterials[i]=new te,Ee(e,t.mMaterials[i])}if(t.mNumAnimations){t.mAnimations=[];for(i=0;i<t.mNumAnimations;++i)t.mAnimations[i]=new oe,Fe(e,t.mAnimations[i])}if(t.mNumTextures){t.mTextures=[];for(i=0;i<t.mNumTextures;++i)t.mTextures[i]=new se,Re(e,t.mTextures[i])}if(t.mNumLights){t.mLights=[];for(i=0;i<t.mNumLights;++i)t.mLights[i]=new le,Oe(e,t.mLights[i])}if(t.mNumCameras){t.mCameras=[];for(i=0;i<t.mNumCameras;++i)t.mCameras[i]=new ce,Be(e,t.mCameras[i])}}var Ue,Ve,ke=0,Ge=1;return function(e){var t=new ue,r=new DataView(e);if(function(e){e.readOffset=0,e.Seek=function(t,r){r==ke&&(e.readOffset+=t),r==Ge&&(e.readOffset=t)},e.ReadBytes=function(e,t,r){for(var n,o,l=t*r,i=0;i<l;i++)e[i]=(o=void 0,o=(n=this).getUint8(n.readOffset),n.readOffset+=1,o)},e.subArray32=function(e,t){var r=this.buffer.slice(e,t);return new Float32Array(r)},e.subArrayUint16=function(e,t){var r=this.buffer.slice(e,t);return new Uint16Array(r)},e.subArrayUint8=function(e,t){var r=this.buffer.slice(e,t);return new Uint8Array(r)},e.subArrayUint32=function(e,t){var r=this.buffer.slice(e,t);return new Uint32Array(r)}}(r),r.Seek(44,ke),ve(r),ve(r),ve(r),ve(r),Ue=me(r)>0,Ve=me(r)>0,Ue)throw"Shortened binaries are not supported!";if(r.Seek(256,ke),r.Seek(128,ke),r.Seek(64,ke),!Ve)return Ie(r,t),t.toTHREE();var n=ge(r),o=r.FileSize()-r.Tell(),l=[];r.Read(l,1,o);var c=[];uncompress(c,n,l,o),Ie(new ArrayBuffer(c),t)}(e)}};var AWD_FIELD_INT8=1,AWD_FIELD_INT16=2,AWD_FIELD_INT32=3,AWD_FIELD_UINT8=4,AWD_FIELD_UINT16=5,AWD_FIELD_UINT32=6,AWD_FIELD_FLOAT32=7,AWD_FIELD_FLOAT64=8,AWD_FIELD_BOOL=21,AWD_FIELD_BADDR=23,AWD_FIELD_VECTOR2x1=41,AWD_FIELD_VECTOR3x1=42,AWD_FIELD_VECTOR4x1=43,AWD_FIELD_MTX3x2=44,AWD_FIELD_MTX3x3=45,AWD_FIELD_MTX4x3=46,AWD_FIELD_MTX4x4=47,BOOL=21,BADDR=23,UINT8=4,UINT16=5,FLOAT32=7,FLOAT64=8,littleEndian=!0;function Block(){this.id=0,this.data=null}function AWDProperties(){}AWDProperties.prototype={set:function(e,t){this[e]=t},get:function(e,t){return this.hasOwnProperty(e)?this[e]:t}};var AWDLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.trunk=new Object3D,this.materialFactory=void 0,this._url="",this._baseDir="",this._data=void 0,this._ptr=0,this._version=[],this._streaming=!1,this._optimized_for_accuracy=!1,this._compression=0,this._bodylen=4294967295,this._blocks=[new Block],this._accuracyMatrix=!1,this._accuracyGeo=!1,this._accuracyProps=!1};function Light(e,t){Object3D.call(this),this.type="Light",this.color=new Color(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function LightShadow(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new Vector2(512,512),this.map=null,this.matrix=new Matrix4}function PointLight(e,t,r,n){Light.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==r?r:0,this.decay=void 0!==n?n:1,this.shadow=new LightShadow(new PerspectiveCamera(90,1,.5,500))}function DirectionalLightShadow(){LightShadow.call(this,new OrthographicCamera(-5,5,5,-5,.5,500))}function DirectionalLight(e,t){Light.call(this,e,t),this.type="DirectionalLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}function SpotLightShadow(){LightShadow.call(this,new PerspectiveCamera(50,1,.5,500))}function SpotLight(e,t,r,n,o,l){Light.call(this,e,t),this.type="SpotLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==r?r:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==o?o:0,this.decay=void 0!==l?l:1,this.shadow=new SpotLightShadow}function HemisphereLight(e,t,r){Light.call(this,e,r),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.groundColor=new Color(t)}AWDLoader.prototype={constructor:AWDLoader,load:function(e,t,r,n){var o=this;this._url=e,this._baseDir=e.substr(0,e.lastIndexOf("/")+1);var l=new FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){var e=data.byteLength;for(this._ptr=0,this._data=new DataView(data),this._parseHeader(),0!=this._compression&&console.error("compressed AWD not supported"),this._streaming||this._bodylen==data.byteLength-this._ptr||console.error("AWDLoader: body len does not match file length",this._bodylen,e-this._ptr);this._ptr<e;)this.parseNextBlock();return this.trunk},parseNextBlock:function(){var e,t,r=this.readU32(),n=(this.readU8(),this.readU8()),o=(this.readU8(),this.readU32());switch(n){case 1:e=this.parseMeshData(o);break;case 22:e=this.parseContainer(o);break;case 23:e=this.parseMeshInstance(o);break;case 81:e=this.parseMaterial(o);break;case 82:e=this.parseTexture(o);break;case 101:e=this.parseSkeleton(o);break;case 112:e=this.parseMeshPoseAnimation(o,!1);break;case 113:e=this.parseVertexAnimationSet(o);break;case 102:e=this.parseSkeletonPose(o);break;case 103:e=this.parseSkeletonAnimation(o);break;case 122:e=this.parseAnimatorSet(o);break;default:this._ptr+=o}this._blocks[r]=t=new Block,t.data=e,t.id=r},_parseHeader:function(){var e=this._version;if(4282180!=(this.readU8()<<16|this.readU8()<<8|this.readU8()))throw new Error("AWDLoader - bad magic");e[0]=this.readU8(),e[1]=this.readU8();var t=this.readU16();this._streaming=1==(1&t),2===e[0]&&1===e[1]&&(this._accuracyMatrix=2==(2&t),this._accuracyGeo=4==(4&t),this._accuracyProps=8==(8&t)),this._geoNrType=this._accuracyGeo?FLOAT64:FLOAT32,this._matrixNrType=this._accuracyMatrix?FLOAT64:FLOAT32,this._propsNrType=this._accuracyProps?FLOAT64:FLOAT32,this._optimized_for_accuracy=2==(2&t),this._compression=this.readU8(),this._bodylen=this.readU32()},parseContainer:function(e){var t=new Object3D,r=this.readU32(),n=this.parseMatrix4();return t.name=this.readUTF(),t.applyMatrix(n),(this._blocks[r].data||this.trunk).add(t),this.parseProperties({1:this._matrixNrType,2:this._matrixNrType,3:this._matrixNrType,4:UINT8}),t.extra=this.parseUserAttributes(),t},parseMeshInstance:function(e){var t,r,n,o,l,c,h,d,f,m,v,y,i;for(c=this.readU32(),d=this.parseMatrix4(),t=this.readUTF(),h=this.readU32(),y=this.readU16(),n=this.getBlock(h),f=[],i=0;i<y;i++)v=this.readU32(),m=this.getBlock(v),f.push(m);if(l=[],(o=n.length)>1)for(r=new Object3D,i=0;i<o;i++){var x=new Mesh(n[i]);l.push(x),r.add(x)}else r=new Mesh(n[0]),l.push(r);r.applyMatrix(d),r.name=t,(this.getBlock(c)||this.trunk).add(r);var w=f.length,M=Math.max(o,w);for(i=0;i<M;i++)l[i%o].material=f[i%w];return this.parseProperties(null),r.extra=this.parseUserAttributes(),r},parseMaterial:function(e){var t,r,n,o,l,c;for(t=this.readUTF(),r=this.readU8(),c=this.readU8(),n=this.parseProperties({1:AWD_FIELD_INT32,2:AWD_FIELD_BADDR,11:AWD_FIELD_BOOL,12:AWD_FIELD_FLOAT32,13:AWD_FIELD_BOOL}),0;0<c;){this.readU16();this.parseProperties(null),this.parseUserAttributes()}if(l=this.parseUserAttributes(),void 0!==this.materialFactory&&(o=this.materialFactory(t)))return o;if(o=new MeshPhongMaterial,1===r)o.color.setHex(n.get(1,13421772));else if(2===r){var h=n.get(2,0);o.map=this.getBlock(h)}return o.extra=l,o.alphaThreshold=n.get(12,0),o.repeat=n.get(13,!1),o},parseTexture:function(e){var t,r;this.readUTF();if(0===this.readU8()){r=this.readU32();var n=this.readUTFBytes(r);console.log(n),t=this.loadTexture(n)}return this.parseProperties(null),this.parseUserAttributes(),t},loadTexture:function(e){var t=new Texture;return new ImageLoader(this.manager).load(this._baseDir+e,(function(image){t.image=image,t.needsUpdate=!0})),t},parseSkeleton:function(e){this.readUTF();var t=this.readU16(),r=[],n=0;for(this.parseProperties(null);n<t;){var o,l;this.readU16(),(o=new Bone).parent=this.readU16()-1,o.name=this.readUTF(),l=this.parseMatrix4(),o.skinMatrix=l,this.parseProperties(null),this.parseUserAttributes(),r.push(o),n++}return this.parseUserAttributes(),r},parseSkeletonPose:function(e){this.readUTF();var t=this.readU16();this.parseProperties(null);for(var r=[],n=0;n<t;){var o;o=1===this.readU8()?this.parseMatrix4():new Matrix4,r[n]=o,n++}return this.parseUserAttributes(),r},parseSkeletonAnimation:function(e){this.readUTF();var t,r,n,o=[],l=this.readU16();this.parseProperties(null);for(var c=0;c<l;)r=this.readU32(),t=this.readU16(),n=this._blocks[r].data,o.push({pose:n,duration:t}),c++;if(0!==o.length)return this.parseUserAttributes(),o},parseVertexAnimationSet:function(e){this.readUTF();for(var t,r=this.readU16(),n=(this.parseProperties({1:UINT16}),0),o=[];n<r;)t=this.readU32(),o.push(this._blocks[t].data),n++;return this.parseUserAttributes(),o},parseAnimatorSet:function(e){this.readUTF();var t,r,n=this.readU16(),o=this.parseProperties({1:BADDR});t=this.readU32();for(var l=this.readU16(),c=[],i=0;i<l;i++)c.push(this.readU32());this.readU16(),Boolean(this.readU8());this.parseUserAttributes(),this.parseUserAttributes();var h,d=[];for(i=0;i<c.length;i++)d.push(this._blocks[c[i]].data);for(r=this._blocks[t].data,1==n&&(h={animationSet:r,skeleton:this._blocks[o.get(1,0)].data}),i=0;i<d.length;i++)d[i].animator=h;return h},parseMeshData:function(e){var t,r,n=this.readUTF(),o=this.readU16(),l=0,c=[];for(this.parseProperties({1:this._geoNrType,2:this._geoNrType});l<o;){var h,d,f;for((t=new BufferGeometry).name=n,c.push(t),h=this.readU32(),d=this._ptr+h,this.parseProperties({1:this._geoNrType,2:this._geoNrType});this._ptr<d;){var m=0,v=this.readU8(),y=(this.readU8(),this.readU32()),x=y+this._ptr;if(1===v)for(f=new BufferAttribute(r=new Float32Array(y/12*3),3),t.addAttribute("position",f),m=0;this._ptr<x;)r[m]=-this.readF32(),r[m+1]=this.readF32(),r[m+2]=this.readF32(),m+=3;else if(2===v)for(f=new BufferAttribute(r=new Uint16Array(y/2),1),t.setIndex(f),m=0;this._ptr<x;)r[m+1]=this.readU16(),r[m]=this.readU16(),r[m+2]=this.readU16(),m+=3;else if(3===v)for(f=new BufferAttribute(r=new Float32Array(y/8*2),2),t.addAttribute("uv",f),m=0;this._ptr<x;)r[m]=this.readF32(),r[m+1]=1-this.readF32(),m+=2;else if(4===v)for(f=new BufferAttribute(r=new Float32Array(y/12*3),3),t.addAttribute("normal",f),m=0;this._ptr<x;)r[m]=-this.readF32(),r[m+1]=this.readF32(),r[m+2]=this.readF32(),m+=3;else this._ptr=x}this.parseUserAttributes(),t.computeBoundingSphere(),l++}return this.parseUserAttributes(),c},parseMeshPoseAnimation:function(e,t){var r,n,o,l,c,h,d,f,m,v=1,y=0,x={},w=[],M=(this.readUTF(),this.readU32()),S=this.getBlock(M);if(null!==S){for((h=S.geometry).morphTargets=[],t||(v=this.readU16()),r=this.readU16(),d=this.readU16(),f=0;f<d;)w.push(this.readU16()),f++;for(m=this.parseProperties({1:BOOL,2:BOOL}),x.looping=m.get(1,!0),x.stitchFinalFrame=m.get(2,!1),n=0;n<v;){for(this.readU16(),o=0;o<r;)for(f=0,l=this.readU32(),c=this._ptr+l;f<d;){if(1===w[f]){var A=new Float32Array(l/4);for(h.morphTargets.push({array:A}),y=0;this._ptr<c;)A[y]=this.readF32(),A[y+1]=this.readF32(),A[y+2]=this.readF32(),y+=3;o++}else this._ptr=c;f++}n++}return this.parseUserAttributes(),null}console.log("parseMeshPoseAnimation target mesh not found at:",M)},getBlock:function(e){return this._blocks[e].data},parseMatrix4:function(){var e=new Matrix4,t=e.elements;return t[0]=this.readF32(),t[1]=this.readF32(),t[2]=this.readF32(),t[3]=0,t[4]=this.readF32(),t[5]=this.readF32(),t[6]=this.readF32(),t[7]=0,t[8]=this.readF32(),t[9]=this.readF32(),t[10]=this.readF32(),t[11]=0,t[12]=-this.readF32(),t[13]=this.readF32(),t[14]=this.readF32(),t[15]=1,e},parseProperties:function(e){var t=this.readU32(),r=this._ptr+t,n=new AWDProperties;if(e)for(;this._ptr<r;){var o,l=this.readU16(),c=this.readU32();e.hasOwnProperty(l)?(o=e[l],n.set(l,this.parseAttrValue(o,c))):this._ptr+=c}return n},parseUserAttributes:function(){return this._ptr=this.readU32()+this._ptr,null},parseAttrValue:function(e,t){var r,n;switch(e){case AWD_FIELD_INT8:r=1,n=this.readI8;break;case AWD_FIELD_INT16:r=2,n=this.readI16;break;case AWD_FIELD_INT32:r=4,n=this.readI32;break;case AWD_FIELD_BOOL:case AWD_FIELD_UINT8:r=1,n=this.readU8;break;case AWD_FIELD_UINT16:r=2,n=this.readU16;break;case AWD_FIELD_UINT32:case AWD_FIELD_BADDR:r=4,n=this.readU32;break;case AWD_FIELD_FLOAT32:r=4,n=this.readF32;break;case AWD_FIELD_FLOAT64:r=8,n=this.readF64;break;case AWD_FIELD_VECTOR2x1:case AWD_FIELD_VECTOR3x1:case AWD_FIELD_VECTOR4x1:case AWD_FIELD_MTX3x2:case AWD_FIELD_MTX3x3:case AWD_FIELD_MTX4x3:case AWD_FIELD_MTX4x4:r=8,n=this.readF64}if(r<t){var o,l,c;for(o=[],l=0,c=t/r;l<c;)o.push(n.call(this)),l++;return o}return n.call(this)},readU8:function(){return this._data.getUint8(this._ptr++)},readI8:function(){return this._data.getInt8(this._ptr++)},readU16:function(){var a=this._data.getUint16(this._ptr,littleEndian);return this._ptr+=2,a},readI16:function(){var a=this._data.getInt16(this._ptr,littleEndian);return this._ptr+=2,a},readU32:function(){var a=this._data.getUint32(this._ptr,littleEndian);return this._ptr+=4,a},readI32:function(){var a=this._data.getInt32(this._ptr,littleEndian);return this._ptr+=4,a},readF32:function(){var a=this._data.getFloat32(this._ptr,littleEndian);return this._ptr+=4,a},readF64:function(){var a=this._data.getFloat64(this._ptr,littleEndian);return this._ptr+=8,a},readUTF:function(){var e=this.readU16();return this.readUTFBytes(e)},readUTFBytes:function(e){for(var t=[],r=0;t.length<e;){var n=this._data.getUint8(this._ptr++,littleEndian);if(n<128)t[r++]=String.fromCharCode(n);else if(n>191&&n<224){var o=this._data.getUint8(this._ptr++,littleEndian);t[r++]=String.fromCharCode((31&n)<<6|63&o)}else{o=this._data.getUint8(this._ptr++,littleEndian);var l=this._data.getUint8(this._ptr++,littleEndian);t[r++]=String.fromCharCode((15&n)<<12|(63&o)<<6|63&l)}}return t.join("")}},Light.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Light,isLight:!0,copy:function(source){return Object3D.prototype.copy.call(this,source),this.color.copy(source.color),this.intensity=source.intensity,this},toJSON:function(meta){var data=Object3D.prototype.toJSON.call(this,meta);return data.object.color=this.color.getHex(),data.object.intensity=this.intensity,void 0!==this.groundColor&&(data.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(data.object.distance=this.distance),void 0!==this.angle&&(data.object.angle=this.angle),void 0!==this.decay&&(data.object.decay=this.decay),void 0!==this.penumbra&&(data.object.penumbra=this.penumbra),void 0!==this.shadow&&(data.object.shadow=this.shadow.toJSON()),data}}),Object.assign(LightShadow.prototype,{copy:function(source){return this.camera=source.camera.clone(),this.bias=source.bias,this.radius=source.radius,this.mapSize.copy(source.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var object={};return 0!==this.bias&&(object.bias=this.bias),1!==this.radius&&(object.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(object.mapSize=this.mapSize.toArray()),object.camera=this.camera.toJSON(!1).object,delete object.camera.matrix,object}}),PointLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:PointLight,isPointLight:!0,copy:function(source){return Light.prototype.copy.call(this,source),this.distance=source.distance,this.decay=source.decay,this.shadow=source.shadow.clone(),this}}),DirectionalLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:DirectionalLightShadow}),DirectionalLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:DirectionalLight,isDirectionalLight:!0,copy:function(source){return Light.prototype.copy.call(this,source),this.target=source.target.clone(),this.shadow=source.shadow.clone(),this}}),SpotLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:SpotLightShadow,isSpotLightShadow:!0,update:function(e){var t=this.camera,r=2*_Math.RAD2DEG*e.angle,n=this.mapSize.width/this.mapSize.height,o=e.distance||t.far;r===t.fov&&n===t.aspect&&o===t.far||(t.fov=r,t.aspect=n,t.far=o,t.updateProjectionMatrix())}}),SpotLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:SpotLight,isSpotLight:!0,copy:function(source){return Light.prototype.copy.call(this,source),this.distance=source.distance,this.angle=source.angle,this.penumbra=source.penumbra,this.decay=source.decay,this.target=source.target.clone(),this.shadow=source.shadow.clone(),this}}),HemisphereLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:HemisphereLight,isHemisphereLight:!0,copy:function(source){return Light.prototype.copy.call(this,source),this.groundColor.copy(source.groundColor),this}});var BabylonLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};BabylonLoader.prototype={constructor:BabylonLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(e){function t(e){var t=new BufferGeometry,r=e.indices,n=e.positions,o=e.normals,l=e.uvs;t.setIndex(r);for(var c=2,h=n.length;c<h;c+=3)n[c]=-n[c];if(t.addAttribute("position",new Float32BufferAttribute(n,3)),o){for(c=2,h=o.length;c<h;c+=3)o[c]=-o[c];t.addAttribute("normal",new Float32BufferAttribute(o,3))}l&&t.addAttribute("uv",new Float32BufferAttribute(l,2));var d=e.subMeshes;if(d)for(c=0,h=d.length;c<h;c++){var f=d[c];t.addGroup(f.indexStart,f.indexCount)}return t}return function(e,r){for(var n={},o=new Scene,l=e.cameras,i=0,c=l.length;i<c;i++){var h=new PerspectiveCamera((data=l[i]).fov/Math.PI*180,1.33,data.minZ,data.maxZ);h.name=data.name,h.position.fromArray(data.position),data.rotation&&h.rotation.fromArray(data.rotation),n[data.id]=h}var d=e.lights;for(i=0,c=d.length;i<c;i++){var f;switch((data=d[i]).type){case 0:f=new PointLight;break;case 1:f=new DirectionalLight;break;case 2:f=new SpotLight;break;case 3:f=new HemisphereLight}f.name=data.name,data.position&&f.position.set(data.position[0],data.position[1],-data.position[2]),f.color.fromArray(data.diffuse),data.groundColor&&f.groundColor.fromArray(data.groundColor),data.intensity&&(f.intensity=data.intensity),n[data.id]=f,o.add(f)}var m=e.meshes;for(i=0,c=m.length;i<c;i++){var data,object;if((data=m[i]).indices)object=new Mesh(t(data),r[data.materialId]);else object=new Group;object.name=data.name,object.position.set(data.position[0],data.position[1],-data.position[2]),object.rotation.fromArray(data.rotation),data.rotationQuaternion&&object.quaternion.fromArray(data.rotationQuaternion),object.scale.fromArray(data.scaling),data.parentId?n[data.parentId].add(object):o.add(object),n[data.id]=object}return o}(e,function(e){for(var t={},i=0,r=e.materials.length;i<r;i++){var data=e.materials[i],n=new MeshPhongMaterial;n.name=data.name,n.color.fromArray(data.diffuse),n.emissive.fromArray(data.emissive),n.specular.fromArray(data.specular),n.shininess=data.specularPower,n.opacity=data.alpha,t[data.id]=n}if(e.multiMaterials)for(i=0,r=e.multiMaterials.length;i<r;i++){data=e.multiMaterials[i];console.warn("BabylonLoader: Multi materials not yet supported."),t[data.id]=new MeshPhongMaterial}return t}(e))}};var BVHLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.animateBonePositions=!0,this.animateBoneRotations=!0};function AmbientLight(e,t){Light.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function LineSegments(e,t){Line.call(this,e,t),this.type="LineSegments"}BVHLoader.prototype={constructor:BVHLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(text){function e(data,t,r){if("ENDSITE"!==r.type){var n={time:t,position:new Vector3,rotation:new Quaternion};r.frames.push(n);for(var o=new Quaternion,l=new Vector3(1,0,0),c=new Vector3(0,1,0),h=new Vector3(0,0,1),i=0;i<r.channels.length;i++)switch(r.channels[i]){case"Xposition":n.position.x=parseFloat(data.shift().trim());break;case"Yposition":n.position.y=parseFloat(data.shift().trim());break;case"Zposition":n.position.z=parseFloat(data.shift().trim());break;case"Xrotation":o.setFromAxisAngle(l,parseFloat(data.shift().trim())*Math.PI/180),n.rotation.multiply(o);break;case"Yrotation":o.setFromAxisAngle(c,parseFloat(data.shift().trim())*Math.PI/180),n.rotation.multiply(o);break;case"Zrotation":o.setFromAxisAngle(h,parseFloat(data.shift().trim())*Math.PI/180),n.rotation.multiply(o);break;default:console.warn("BVHLoader: Invalid channel type.")}for(i=0;i<r.children.length;i++)e(data,t,r.children[i])}}function t(e){for(var line;0===(line=e.shift().trim()).length;);return line}var r=this,n=function(r){"HIERARCHY"!==t(r)&&console.error("BVHLoader: HIERARCHY expected.");var n=[],o=function e(r,n,o){var l={name:"",type:"",frames:[]};o.push(l);var c=n.split(/[\s]+/);"END"===c[0].toUpperCase()&&"SITE"===c[1].toUpperCase()?(l.type="ENDSITE",l.name="ENDSITE"):(l.name=c[1],l.type=c[0].toUpperCase());"{"!==t(r)&&console.error("BVHLoader: Expected opening { after type & name");"OFFSET"!==(c=t(r).split(/[\s]+/))[0]&&console.error("BVHLoader: Expected OFFSET but got: "+c[0]);4!==c.length&&console.error("BVHLoader: Invalid number of values for OFFSET.");var h=new Vector3(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));(isNaN(h.x)||isNaN(h.y)||isNaN(h.z))&&console.error("BVHLoader: Invalid values of OFFSET.");if(l.offset=h,"ENDSITE"!==l.type){"CHANNELS"!==(c=t(r).split(/[\s]+/))[0]&&console.error("BVHLoader: Expected CHANNELS definition.");var d=parseInt(c[1]);l.channels=c.splice(2,d),l.children=[]}for(;;){var line=t(r);if("}"===line)return l;l.children.push(e(r,line,o))}}(r,t(r),n);"MOTION"!==t(r)&&console.error("BVHLoader: MOTION expected.");var l=t(r).split(/[\s]+/),c=parseInt(l[1]);isNaN(c)&&console.error("BVHLoader: Failed to read number of frames."),l=t(r).split(/[\s]+/);var h=parseFloat(l[2]);isNaN(h)&&console.error("BVHLoader: Failed to read frame time.");for(var i=0;i<c;i++)e(l=t(r).split(/[\s]+/),i*h,o);return n}(text.split(/[\r\n]+/g)),o=[];!function e(source,t){var r=new Bone;if(t.push(r),r.position.add(source.offset),r.name=source.name,"ENDSITE"!==source.type)for(var i=0;i<source.children.length;i++)r.add(e(source.children[i],t));return r}(n[0],o);var l=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];if("ENDSITE"!==n.type){for(var o=[],l=[],c=[],h=0;h<n.frames.length;h++){var d=n.frames[h];o.push(d.time),l.push(d.position.x+n.offset.x),l.push(d.position.y+n.offset.y),l.push(d.position.z+n.offset.z),c.push(d.rotation.x),c.push(d.rotation.y),c.push(d.rotation.z),c.push(d.rotation.w)}r.animateBonePositions&&t.push(new VectorKeyframeTrack(".bones["+n.name+"].position",o,l)),r.animateBoneRotations&&t.push(new QuaternionKeyframeTrack(".bones["+n.name+"].quaternion",o,c))}}return new AnimationClip("animation",-1,t)}(n);return{skeleton:new Skeleton(o),clip:l}}},AmbientLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:AmbientLight,isAmbientLight:!0}),LineSegments.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineSegments,isLineSegments:!0,computeLineDistances:function(){var e=new Vector3,t=new Vector3;return function(){var r=this.geometry;if(r.isBufferGeometry)if(null===r.index){for(var n=r.attributes.position,o=[],i=0,l=n.count;i<l;i+=2)e.fromBufferAttribute(n,i),t.fromBufferAttribute(n,i+1),o[i]=0===i?0:o[i-1],o[i+1]=o[i]+e.distanceTo(t);r.addAttribute("lineDistance",new Float32BufferAttribute(o,1))}else console.warn("LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(r.isGeometry){var c=r.vertices;for(o=r.lineDistances,i=0,l=c.length;i<l;i+=2)e.copy(c[i]),t.copy(c[i+1]),o[i]=0===i?0:o[i-1],o[i+1]=o[i]+e.distanceTo(t)}return this}}()});var TGALoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};TGALoader.prototype={constructor:TGALoader,load:function(e,t,r,n){var o=this,l=new Texture,c=new FileLoader(this.manager);return c.setResponseType("arraybuffer"),c.setPath(this.path),c.load(e,(function(e){l.image=o.parse(e),l.needsUpdate=!0,void 0!==t&&t(l)}),r,n),l},parse:function(e){var t=0,r=1,n=2,o=3,l=9,c=10,h=11,d=48,f=4,m=0,v=1,y=2,x=3;e.length<19&&console.error("TGALoader: Not enough data to contain header.");var content=new Uint8Array(e),w=0,header={id_length:content[w++],colormap_type:content[w++],image_type:content[w++],colormap_index:content[w++]|content[w++]<<8,colormap_length:content[w++]|content[w++]<<8,colormap_size:content[w++],origin:[content[w++]|content[w++]<<8,content[w++]|content[w++]<<8],width:content[w++]|content[w++]<<8,height:content[w++]|content[w++]<<8,pixel_size:content[w++],flags:content[w++]};!function(header){switch(header.image_type){case r:case l:(header.colormap_length>256||24!==header.colormap_size||1!==header.colormap_type)&&console.error("TGALoader: Invalid type colormap data for indexed type.");break;case n:case o:case c:case h:header.colormap_type&&console.error("TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("TGALoader: No data.");default:console.error('TGALoader: Invalid type "%s".',header.image_type)}(header.width<=0||header.height<=0)&&console.error("TGALoader: Invalid image size."),8!==header.pixel_size&&16!==header.pixel_size&&24!==header.pixel_size&&32!==header.pixel_size&&console.error('TGALoader: Invalid pixel size "%s".',header.pixel_size)}(header),header.id_length+w>e.length&&console.error("TGALoader: No data."),w+=header.id_length;var M=!1,S=!1,A=!1;switch(header.image_type){case l:M=!0,S=!0;break;case r:S=!0;break;case c:M=!0;break;case n:break;case h:M=!0,A=!0;break;case o:A=!0}var T="undefined"!=typeof OffscreenCanvas,canvas=T?new OffscreenCanvas(header.width,header.height):document.createElement("canvas");canvas.width=header.width,canvas.height=header.height;var _=canvas.getContext("2d"),L=_.createImageData(header.width,header.height),C=function(e,t,header,r,data){var n,o,l,c;if(o=header.pixel_size>>3,l=header.width*header.height*o,t&&(c=data.subarray(r,r+=header.colormap_length*(header.colormap_size>>3))),e){var h,d,i;n=new Uint8Array(l);for(var f=0,m=new Uint8Array(o);f<l;)if(d=1+(127&(h=data[r++])),128&h){for(i=0;i<o;++i)m[i]=data[r++];for(i=0;i<d;++i)n.set(m,f+i*o);f+=o*d}else{for(d*=o,i=0;i<d;++i)n[f+i]=data[r++];f+=d}}else n=data.subarray(r,r+=t?header.width*header.height:l);return{pixel_data:n,palettes:c}}(M,S,header,w,content);!function(data,e,t,image,r){var n,o,l,c,h,w;switch((header.flags&d)>>f){default:case y:n=0,l=1,h=e,o=0,c=1,w=t;break;case m:n=0,l=1,h=e,o=t-1,c=-1,w=-1;break;case x:n=e-1,l=-1,h=-1,o=0,c=1,w=t;break;case v:n=e-1,l=-1,h=-1,o=t-1,c=-1,w=-1}if(A)switch(header.pixel_size){case 8:!function(e,t,r,n,o,l,c,image){var h,d,f,i=0,m=header.width;for(f=t;f!==n;f+=r)for(d=o;d!==c;d+=l,i++)h=image[i],e[4*(d+m*f)+0]=h,e[4*(d+m*f)+1]=h,e[4*(d+m*f)+2]=h,e[4*(d+m*f)+3]=255}(data,o,c,w,n,l,h,image);break;case 16:!function(e,t,r,n,o,l,c,image){var h,d,i=0,f=header.width;for(d=t;d!==n;d+=r)for(h=o;h!==c;h+=l,i+=2)e[4*(h+f*d)+0]=image[i+0],e[4*(h+f*d)+1]=image[i+0],e[4*(h+f*d)+2]=image[i+0],e[4*(h+f*d)+3]=image[i+1]}(data,o,c,w,n,l,h,image);break;default:console.error("TGALoader: Format not supported.")}else switch(header.pixel_size){case 8:!function(e,t,r,n,o,l,c,image,h){var d,f,m,v=h,i=0,y=header.width;for(m=t;m!==n;m+=r)for(f=o;f!==c;f+=l,i++)d=image[i],e[4*(f+y*m)+3]=255,e[4*(f+y*m)+2]=v[3*d+0],e[4*(f+y*m)+1]=v[3*d+1],e[4*(f+y*m)+0]=v[3*d+2]}(data,o,c,w,n,l,h,image,r);break;case 16:!function(e,t,r,n,o,l,c,image){var h,d,f,i=0,m=header.width;for(f=t;f!==n;f+=r)for(d=o;d!==c;d+=l,i+=2)h=image[i+0]+(image[i+1]<<8),e[4*(d+m*f)+0]=(31744&h)>>7,e[4*(d+m*f)+1]=(992&h)>>2,e[4*(d+m*f)+2]=(31&h)>>3,e[4*(d+m*f)+3]=32768&h?0:255}(data,o,c,w,n,l,h,image);break;case 24:!function(e,t,r,n,o,l,c,image){var h,d,i=0,f=header.width;for(d=t;d!==n;d+=r)for(h=o;h!==c;h+=l,i+=3)e[4*(h+f*d)+3]=255,e[4*(h+f*d)+2]=image[i+0],e[4*(h+f*d)+1]=image[i+1],e[4*(h+f*d)+0]=image[i+2]}(data,o,c,w,n,l,h,image);break;case 32:!function(e,t,r,n,o,l,c,image){var h,d,i=0,f=header.width;for(d=t;d!==n;d+=r)for(h=o;h!==c;h+=l,i+=4)e[4*(h+f*d)+2]=image[i+0],e[4*(h+f*d)+1]=image[i+1],e[4*(h+f*d)+0]=image[i+2],e[4*(h+f*d)+3]=image[i+3]}(data,o,c,w,n,l,h,image);break;default:console.error("TGALoader: Format not supported.")}}(L.data,header.width,header.height,C.pixel_data,C.palettes);return _.putImageData(L,0,0),T?canvas.transferToImageBitmap():canvas},setPath:function(e){return this.path=e,this}};var ColladaLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};function CompressedTexture(e,t,r,n,o,l,c,h,d,f,m,v){Texture.call(this,null,l,c,h,d,f,n,o,m,v),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function CompressedTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this._parser=null}ColladaLoader.prototype={constructor:ColladaLoader,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===o.path?LoaderUtils.extractUrlBase(e):o.path,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text,path))}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(text,path){function e(e,t){for(var r=[],n=e.childNodes,i=0,o=n.length;i<o;i++){var l=n[i];l.nodeName===t&&r.push(l)}return r}function t(text){if(0===text.length)return[];for(var e=text.trim().split(/\s+/),t=new Array(e.length),i=0,r=e.length;i<r;i++)t[i]=e[i];return t}function r(text){if(0===text.length)return[];for(var e=text.trim().split(/\s+/),t=new Array(e.length),i=0,r=e.length;i<r;i++)t[i]=parseFloat(e[i]);return t}function n(text){if(0===text.length)return[];for(var e=text.trim().split(/\s+/),t=new Array(e.length),i=0,r=e.length;i<r;i++)t[i]=parseInt(e[i]);return t}function o(text){return text.substring(1)}function l(object){return 0===Object.keys(object).length}function c(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function h(e){return void 0!==e?e.textContent:"Y_UP"}function d(t,r,n,o){var l=e(t,r)[0];if(void 0!==l)for(var c=e(l,n),i=0;i<c.length;i++)o(c[i])}function f(data,e){for(var t in data){data[t].build=e(data[t])}}function m(data,e){return void 0!==data.build?data.build:(data.build=e(data),data.build)}function v(e){for(var data={inputs:{}},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"input":var n=o(r.getAttribute("source")),l=r.getAttribute("semantic");data.inputs[l]=n}}return data}function y(e){var data={},t=e.getAttribute("target").split("/"),r=t.shift(),n=t.shift(),l=-1!==n.indexOf("("),c=-1!==n.indexOf(".");if(c)t=n.split("."),n=t.shift(),data.member=t.shift();else if(l){var h=n.split("(");n=h.shift();for(var i=0;i<h.length;i++)h[i]=parseInt(h[i].replace(/\)/,""));data.indices=h}return data.id=r,data.sid=n,data.arraySyntax=l,data.memberSyntax=c,data.sampler=o(e.getAttribute("source")),data}function x(data){var e=[],t=data.channels,r=data.samplers,n=data.sources;for(var o in t)if(t.hasOwnProperty(o)){var l=t[o],c=r[l.sampler],h=c.inputs.INPUT,d=c.inputs.OUTPUT;_(M(l,n[h],n[d]),e)}return e}function w(e){return m(Ze.animations[e],x)}function M(e,t,r){var time,n,i,o,l,c,h=Ze.nodes[e.id],d=Ge(h.id),f=h.transforms[e.sid],m=h.matrix.clone().transpose(),data={};switch(f){case"matrix":for(i=0,o=t.array.length;i<o;i++)if(time=t.array[i],n=i*r.stride,void 0===data[time]&&(data[time]={}),!0===e.arraySyntax){var v=r.array[n],y=e.indices[0]+4*e.indices[1];data[time][y]=v}else for(l=0,c=r.stride;l<c;l++)data[time][l]=r.array[n+l];break;case"translate":case"rotate":case"scale":console.warn('ColladaLoader: Animation transform type "%s" not yet implemented.',f)}var x=function(data,e){var t=[];for(var time in data)t.push({time:parseFloat(time),value:data[time]});t.sort((function(a,b){return a.time-b.time}));for(var i=0;i<16;i++)L(t,i,e.elements[i]);return t}(data,m);return{name:d.uuid,keyframes:x}}var S=new Vector3,A=new Vector3,T=new Quaternion;function _(e,t){for(var r=e.keyframes,n=e.name,o=[],l=[],c=[],h=[],i=0,d=r.length;i<d;i++){var f=r[i],time=f.time,m=f.value;Pe.fromArray(m).transpose(),Pe.decompose(S,T,A),o.push(time),l.push(S.x,S.y,S.z),c.push(T.x,T.y,T.z,T.w),h.push(A.x,A.y,A.z)}return l.length>0&&t.push(new VectorKeyframeTrack(n+".position",o,l)),c.length>0&&t.push(new QuaternionKeyframeTrack(n+".quaternion",o,c)),h.length>0&&t.push(new VectorKeyframeTrack(n+".scale",o,h)),t}function L(e,t,r){var n,i,o,l=!0;for(i=0,o=e.length;i<o;i++)void 0===(n=e[i]).value[t]?n.value[t]=null:l=!1;if(!0===l)for(i=0,o=e.length;i<o;i++)(n=e[i]).value[t]=r;else!function(e,t){for(var r,n,i=0,o=e.length;i<o;i++){var l=e[i];if(null===l.value[t]){if(r=C(e,i,t),n=N(e,i,t),null===r){l.value[t]=n.value[t];continue}if(null===n){l.value[t]=r.value[t];continue}P(l,r,n,t)}}}(e,t)}function C(e,i,t){for(;i>=0;){var r=e[i];if(null!==r.value[t])return r;i--}return null}function N(e,i,t){for(;i<e.length;){var r=e[i];if(null!==r.value[t])return r;i++}return null}function P(e,t,r,n){r.time-t.time!=0?e.value[n]=(e.time-t.time)*(r.value[n]-t.value[n])/(r.time-t.time)+t.value[n]:e.value[n]=t.value[n]}function E(data){for(var e=[],t=data.name,r=data.end-data.start||-1,n=data.animations,i=0,o=n.length;i<o;i++)for(var l=w(n[i]),c=0,h=l.length;c<h;c++)e.push(l[c]);return new AnimationClip(t,r,e)}function D(e){return m(Ze.clips[e],E)}function F(e){for(var data={sources:{}},i=0,t=e.childNodes.length;i<t;i++){var n=e.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"bind_shape_matrix":data.bindShapeMatrix=r(n.textContent);break;case"source":var o=n.getAttribute("id");data.sources[o]=ue(n);break;case"joints":data.joints=R(n);break;case"vertex_weights":data.vertexWeights=O(n)}}return data}function R(e){for(var data={inputs:{}},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"input":var n=r.getAttribute("semantic"),l=o(r.getAttribute("source"));data.inputs[n]=l}}return data}function O(e){for(var data={inputs:{}},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"input":var l=r.getAttribute("semantic"),c=o(r.getAttribute("source")),h=parseInt(r.getAttribute("offset"));data.inputs[l]={id:c,offset:h};break;case"vcount":data.vcount=n(r.textContent);break;case"v":data.v=n(r.textContent)}}return data}function B(data){var e={id:data.id},t=Ze.geometries[e.id];return void 0!==data.skin&&(e.skin=function(data){var i,e,t,r={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},n=data.sources,o=data.vertexWeights,l=o.vcount,c=o.v,h=o.inputs.JOINT.offset,d=o.inputs.WEIGHT.offset,f=data.sources[data.joints.inputs.JOINT],m=data.sources[data.joints.inputs.INV_BIND_MATRIX],v=n[o.inputs.WEIGHT.id].array,y=0;for(i=0,t=l.length;i<t;i++){var x=l[i],w=[];for(e=0;e<x;e++){var M=c[y+h],S=c[y+d],A=v[S];w.push({index:M,weight:A}),y+=2}for(w.sort(C),e=0;e<4;e++){var T=w[e];void 0!==T?(r.indices.array.push(T.index),r.weights.array.push(T.weight)):(r.indices.array.push(0),r.weights.array.push(0))}}data.bindShapeMatrix?r.bindMatrix=(new Matrix4).fromArray(data.bindShapeMatrix).transpose():r.bindMatrix=(new Matrix4).identity();for(i=0,t=f.array.length;i<t;i++){var _=f.array[i],L=(new Matrix4).fromArray(m.array,i*m.stride).transpose();r.joints.push({name:_,boneInverse:L})}return r;function C(a,b){return b.weight-a.weight}}(data.skin),t.sources.skinIndices=e.skin.indices,t.sources.skinWeights=e.skin.weights),e}function I(data){return void 0!==data.build?data.build:data.init_from}function U(e){var data=Ze.images[e];return void 0!==data?m(data,I):(console.warn("ColladaLoader: Couldn't find image with ID:",e),null)}function V(e){for(var data={surfaces:{},samplers:{}},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"newparam":k(r,data);break;case"technique":data.technique=j(r);break;case"extra":data.extra=K(r)}}return data}function k(e,data){for(var t=e.getAttribute("sid"),i=0,r=e.childNodes.length;i<r;i++){var n=e.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"surface":data.surfaces[t]=G(n);break;case"sampler2D":data.samplers[t]=z(n)}}}function G(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"init_from":data.init_from=r.textContent}}return data}function z(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"source":data.source=r.textContent}}return data}function j(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":data.type=r.nodeName,data.parameters=W(r)}}return data}function W(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":data[r.nodeName]=H(r);break;case"transparent":data[r.nodeName]={opaque:r.getAttribute("opaque"),data:H(r)}}}return data}function H(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var n=e.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"color":data[n.nodeName]=r(n.textContent);break;case"float":data[n.nodeName]=parseFloat(n.textContent);break;case"texture":data[n.nodeName]={id:n.getAttribute("texture"),extra:X(n)}}}return data}function X(e){for(var data={technique:{}},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"extra":Y(r,data)}}return data}function Y(e,data){for(var i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"technique":Q(r,data)}}}function Q(e,data){for(var i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":data.technique[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":"TRUE"===r.textContent.toUpperCase()?data.technique[r.nodeName]=1:"FALSE"===r.textContent.toUpperCase()?data.technique[r.nodeName]=0:data.technique[r.nodeName]=parseInt(r.textContent)}}}function K(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"technique":data.technique=J(r)}}return data}function J(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"double_sided":data[r.nodeName]=parseInt(r.textContent)}}return data}function Z(data){return data}function $(data){var e,t,r=(e=data.url,m(Ze.effects[e],Z)),n=r.profile.technique,o=r.profile.extra;switch(n.type){case"phong":case"blinn":t=new MeshPhongMaterial;break;case"lambert":t=new MeshLambertMaterial;break;default:t=new MeshBasicMaterial}function c(e){var t=r.profile.samplers[e.id],image=null;void 0!==t?image=U(r.profile.surfaces[t.source].init_from):(console.warn("ColladaLoader: Undefined sampler. Access image directly (see #12530)."),image=U(e.id));if(null!==image){var n=function(image){var e,t=image.slice(2+(image.lastIndexOf(".")-1>>>0));switch(t=t.toLowerCase()){case"tga":e=Xe;break;default:e=qe}return e}(image);if(void 0!==n){var o=n.load(image),c=e.extra;if(void 0!==c&&void 0!==c.technique&&!1===l(c.technique)){var h=c.technique;o.wrapS=h.wrapU?RepeatWrapping:ClampToEdgeWrapping,o.wrapT=h.wrapV?RepeatWrapping:ClampToEdgeWrapping,o.offset.set(h.offsetU||0,h.offsetV||0),o.repeat.set(h.repeatU||1,h.repeatV||1)}else o.wrapS=RepeatWrapping,o.wrapT=RepeatWrapping;return o}return console.warn("ColladaLoader: Loader for texture %s not found.",image),null}return console.warn("ColladaLoader: Couldn't create texture with ID:",e.id),null}t.name=data.name||"";var h=n.parameters;for(var d in h){var f=h[d];switch(d){case"diffuse":f.color&&t.color.fromArray(f.color),f.texture&&(t.map=c(f.texture));break;case"specular":f.color&&t.specular&&t.specular.fromArray(f.color),f.texture&&(t.specularMap=c(f.texture));break;case"bump":f.texture&&(t.normalMap=c(f.texture));break;case"ambient":f.texture&&(t.lightMap=c(f.texture));break;case"shininess":f.float&&t.shininess&&(t.shininess=f.float);break;case"emission":f.color&&t.emissive&&t.emissive.fromArray(f.color),f.texture&&(t.emissiveMap=c(f.texture))}}var v=h.transparent,y=h.transparency;if(void 0===y&&v&&(y={float:1}),void 0===v&&y&&(v={opaque:"A_ONE",data:{color:[1,1,1,1]}}),v&&y)if(v.data.texture)t.transparent=!0;else{var x=v.data.color;switch(v.opaque){case"A_ONE":t.opacity=x[3]*y.float;break;case"RGB_ZERO":t.opacity=1-x[0]*y.float;break;case"A_ZERO":t.opacity=1-x[3]*y.float;break;case"RGB_ONE":t.opacity=x[0]*y.float;break;default:console.warn('ColladaLoader: Invalid opaque type "%s" of transparent tag.',v.opaque)}t.opacity<1&&(t.transparent=!0)}return void 0!==o&&void 0!==o.technique&&1===o.technique.double_sided&&(t.side=DoubleSide),t}function ee(e){return m(Ze.materials[e],$)}function te(e){for(var i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];switch(t.nodeName){case"technique_common":return re(t)}}return{}}function re(e){for(var data={},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];switch(t.nodeName){case"perspective":case"orthographic":data.technique=t.nodeName,data.parameters=ie(t)}}return data}function ie(e){for(var data={},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];switch(t.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":data[t.nodeName]=parseFloat(t.textContent)}}return data}function ne(data){var e;switch(data.optics.technique){case"perspective":e=new PerspectiveCamera(data.optics.parameters.yfov,data.optics.parameters.aspect_ratio,data.optics.parameters.znear,data.optics.parameters.zfar);break;case"orthographic":var t=data.optics.parameters.ymag,r=data.optics.parameters.xmag,n=data.optics.parameters.aspect_ratio;r=void 0===r?t*n:r,t=void 0===t?r/n:t,e=new OrthographicCamera(-(r*=.5),r,t*=.5,-t,data.optics.parameters.znear,data.optics.parameters.zfar);break;default:e=new PerspectiveCamera}return e.name=data.name||"",e}function ae(e){var data=Ze.cameras[e];return void 0!==data?m(data,ne):(console.warn("ColladaLoader: Couldn't find camera with ID:",e),null)}function oe(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"directional":case"point":case"spot":case"ambient":data.technique=r.nodeName,data.parameters=se(r)}}return data}function se(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var n=e.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"color":var o=r(n.textContent);data.color=(new Color).fromArray(o);break;case"falloff_angle":data.falloffAngle=parseFloat(n.textContent);break;case"quadratic_attenuation":var l=parseFloat(n.textContent);data.distance=l?Math.sqrt(1/l):0}}return data}function le(data){var e;switch(data.technique){case"directional":e=new DirectionalLight;break;case"point":e=new PointLight;break;case"spot":e=new SpotLight;break;case"ambient":e=new AmbientLight}return data.parameters.color&&e.color.copy(data.parameters.color),data.parameters.distance&&(e.distance=data.parameters.distance),e}function ce(e){var data=Ze.lights[e];return void 0!==data?m(data,le):(console.warn("ColladaLoader: Couldn't find light with ID:",e),null)}function ue(n){for(var data={array:[],stride:3},i=0;i<n.childNodes.length;i++){var o=n.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"float_array":data.array=r(o.textContent);break;case"Name_array":data.array=t(o.textContent);break;case"technique_common":var l=e(o,"accessor")[0];void 0!==l&&(data.stride=parseInt(l.getAttribute("stride")))}}return data}function he(e){for(var data={},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];1===t.nodeType&&(data[t.getAttribute("semantic")]=o(t.getAttribute("source")))}return data}function de(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1},i=0,r=e.childNodes.length;i<r;i++){var l=e.childNodes[i];if(1===l.nodeType)switch(l.nodeName){case"input":var c=o(l.getAttribute("source")),h=l.getAttribute("semantic"),d=parseInt(l.getAttribute("offset")),f=parseInt(l.getAttribute("set")),m=f>0?h+f:h;t.inputs[m]={id:c,offset:d},t.stride=Math.max(t.stride,d+1),"TEXCOORD"===h&&(t.hasUV=!0);break;case"vcount":t.vcount=n(l.textContent);break;case"p":t.p=n(l.textContent)}}return t}function pe(e){for(var t=0,i=0,r=e.length;i<r;i++){!0===e[i].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function fe(data){var e={},t=data.sources,r=data.vertices,n=data.primitives;if(0===n.length)return{};var o=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];void 0===t[r.type]&&(t[r.type]=[]),t[r.type].push(r)}return t}(n);for(var l in o){var c=o[l];pe(c),e[l]=me(c,t,r)}return e}function me(e,t,r){for(var n={},o={array:[],stride:0},l={array:[],stride:0},c={array:[],stride:0},h={array:[],stride:0},d={array:[],stride:0},f=[],m=4,v=[],y=4,x=new BufferGeometry,w=[],M=0,p=0;p<e.length;p++){var S=e[p],A=S.inputs,T=0;switch(S.type){case"lines":case"linestrips":T=2*S.count;break;case"triangles":T=3*S.count;break;case"polylist":for(var g=0;g<S.count;g++){var _=S.vcount[g];switch(_){case 3:T+=3;break;case 4:T+=6;break;default:T+=3*(_-2)}}break;default:console.warn("ColladaLoader: Unknow primitive type:",S.type)}for(var L in x.addGroup(M,T,p),M+=T,S.material&&w.push(S.material),A){var input=A[L];switch(L){case"VERTEX":for(var C in r){var N=r[C];switch(C){case"POSITION":var P=o.array.length;if(ve(S,t[N],input.offset,o.array),o.stride=t[N].stride,t.skinWeights&&t.skinIndices&&(ve(S,t.skinIndices,input.offset,f),ve(S,t.skinWeights,input.offset,v)),!1===S.hasUV&&!0===e.uvsNeedsFix){T=(o.array.length-P)/o.stride;for(var i=0;i<T;i++)c.array.push(0,0)}break;case"NORMAL":ve(S,t[N],input.offset,l.array),l.stride=t[N].stride;break;case"COLOR":ve(S,t[N],input.offset,d.array),d.stride=t[N].stride;break;case"TEXCOORD":ve(S,t[N],input.offset,c.array),c.stride=t[N].stride;break;case"TEXCOORD1":ve(S,t[N],input.offset,h.array),c.stride=t[N].stride;break;default:console.warn('ColladaLoader: Semantic "%s" not handled in geometry build process.',C)}}break;case"NORMAL":ve(S,t[input.id],input.offset,l.array),l.stride=t[input.id].stride;break;case"COLOR":ve(S,t[input.id],input.offset,d.array),d.stride=t[input.id].stride;break;case"TEXCOORD":ve(S,t[input.id],input.offset,c.array),c.stride=t[input.id].stride;break;case"TEXCOORD1":ve(S,t[input.id],input.offset,h.array),h.stride=t[input.id].stride}}}return o.array.length>0&&x.addAttribute("position",new Float32BufferAttribute(o.array,o.stride)),l.array.length>0&&x.addAttribute("normal",new Float32BufferAttribute(l.array,l.stride)),d.array.length>0&&x.addAttribute("color",new Float32BufferAttribute(d.array,d.stride)),c.array.length>0&&x.addAttribute("uv",new Float32BufferAttribute(c.array,c.stride)),h.array.length>0&&x.addAttribute("uv2",new Float32BufferAttribute(h.array,h.stride)),f.length>0&&x.addAttribute("skinIndex",new Float32BufferAttribute(f,m)),v.length>0&&x.addAttribute("skinWeight",new Float32BufferAttribute(v,y)),n.data=x,n.type=e[0].type,n.materialKeys=w,n}function ve(e,source,t,r){var n=e.p,o=e.stride,l=e.vcount;function c(i){for(var e=n[i+t]*d,o=e+d;e<o;e++)r.push(h[e])}var h=source.array,d=source.stride;if(void 0!==e.vcount)for(var f=0,i=0,m=l.length;i<m;i++){var v=l[i];if(4===v){var b=f+1*o,y=f+2*o,x=f+3*o;c(f+0*o),c(b),c(x),c(b),c(y),c(x)}else if(3===v){b=f+1*o,y=f+2*o;c(f+0*o),c(b),c(y)}else if(v>4)for(var w=1,M=v-2;w<=M;w++){b=f+o*w,y=f+o*(w+1);c(f+0*o),c(b),c(y)}f+=o*v}else for(i=0,m=n.length;i<m;i+=o)c(i)}function ge(e){return m(Ze.geometries[e],fe)}function ye(data){return void 0!==data.build?data.build:data}function xe(e,data){for(var i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"joint":data.joints[t.getAttribute("sid")]=be(t);break;case"link":data.links.push(Me(t))}}}function be(e){for(var data,i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"prismatic":case"revolute":data=we(t)}}return data}function we(e,data){data={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(var i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"axis":var n=r(t.textContent);data.axis.fromArray(n);break;case"limits":var o=t.getElementsByTagName("max")[0],l=t.getElementsByTagName("min")[0];data.limits.max=parseFloat(o.textContent),data.limits.min=parseFloat(l.textContent)}}return data.limits.min>=data.limits.max&&(data.static=!0),data.middlePosition=(data.limits.min+data.limits.max)/2,data}function Me(e){for(var data={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"attachment_full":data.attachments.push(Se(t));break;case"matrix":case"translate":case"rotate":data.transforms.push(Ae(t))}}return data}function Se(e){for(var data={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"link":data.links.push(Me(t));break;case"matrix":case"translate":case"rotate":data.transforms.push(Ae(t))}}return data}function Ae(e){var data={type:e.nodeName},t=r(e.textContent);switch(data.type){case"matrix":data.obj=new Matrix4,data.obj.fromArray(t).transpose();break;case"translate":data.obj=new Vector3,data.obj.fromArray(t);break;case"rotate":data.obj=new Vector3,data.obj.fromArray(t),data.angle=_Math.degToRad(t[3])}return data}function Te(e,data){for(var i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"technique_common":_e(t,data)}}}function _e(e,data){for(var i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"inertia":data.inertia=r(t.textContent);break;case"mass":data.mass=r(t.textContent)[0]}}}function Le(e){for(var data={target:e.getAttribute("target").split("/").pop()},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"axis":var param=t.getElementsByTagName("param")[0];data.axis=param.textContent;var r=data.axis.split("inst_").pop().split("axis")[0];data.jointIndex=r.substr(0,r.length-1)}}return data}function Ce(data){return void 0!==data.build?data.build:data}function Ne(e){for(var t=[],n=We.querySelector('[id="'+e.id+'"]'),i=0;i<n.childNodes.length;i++){var o=n.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"matrix":var l=r(o.textContent),c=(new Matrix4).fromArray(l).transpose();t.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:c});break;case"translate":case"scale":l=r(o.textContent);var h=(new Vector3).fromArray(l);t.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:h});break;case"rotate":l=r(o.textContent),h=(new Vector3).fromArray(l);var d=_Math.degToRad(l[3]);t.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:h,angle:d})}}return t}var Pe=new Matrix4,Ee=new Vector3;function De(e){for(var data={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"node":data.nodes.push(t.getAttribute("id")),De(t);break;case"instance_camera":data.instanceCameras.push(o(t.getAttribute("url")));break;case"instance_controller":data.instanceControllers.push(Fe(t));break;case"instance_light":data.instanceLights.push(o(t.getAttribute("url")));break;case"instance_geometry":data.instanceGeometries.push(Fe(t));break;case"instance_node":data.instanceNodes.push(o(t.getAttribute("url")));break;case"matrix":var n=r(t.textContent);data.matrix.multiply(Pe.fromArray(n).transpose()),data.transforms[t.getAttribute("sid")]=t.nodeName;break;case"translate":n=r(t.textContent);Ee.fromArray(n),data.matrix.multiply(Pe.makeTranslation(Ee.x,Ee.y,Ee.z)),data.transforms[t.getAttribute("sid")]=t.nodeName;break;case"rotate":n=r(t.textContent);var l=_Math.degToRad(n[3]);data.matrix.multiply(Pe.makeRotationAxis(Ee.fromArray(n),l)),data.transforms[t.getAttribute("sid")]=t.nodeName;break;case"scale":n=r(t.textContent);data.matrix.scale(Ee.fromArray(n)),data.transforms[t.getAttribute("sid")]=t.nodeName;break;case"extra":break;default:console.log(t)}}return ke(data.id)?console.warn("ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",data.id):Ze.nodes[data.id]=data,data}function Fe(e){for(var data={id:o(e.getAttribute("url")),materials:{},skeletons:[]},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];switch(t.nodeName){case"bind_material":for(var r=t.getElementsByTagName("instance_material"),n=0;n<r.length;n++){var l=r[n],symbol=l.getAttribute("symbol"),c=l.getAttribute("target");data.materials[symbol]=o(c)}break;case"skeleton":data.skeletons.push(o(t.textContent))}}return data}function Re(e,t){var i,data,r,n=[],o=[];for(i=0;i<e.length;i++){var l=e[i];if(ke(l))Oe(Ge(l),t,n);else if(r=l,void 0!==Ze.visualScenes[r])for(var c=Ze.visualScenes[l].children,h=0;h<c.length;h++){var d=c[h];if("JOINT"===d.type)Oe(Ge(d.id),t,n)}else console.error("ColladaLoader: Unable to find root bone of skeleton with ID:",l)}for(i=0;i<t.length;i++)for(h=0;h<n.length;h++)if((data=n[h]).bone.name===t[i].name){o[i]=data,data.processed=!0;break}for(i=0;i<n.length;i++)!1===(data=n[i]).processed&&(o.push(data),data.processed=!0);var f=[],m=[];for(i=0;i<o.length;i++)data=o[i],f.push(data.bone),m.push(data.boneInverse);return new Skeleton(f,m)}function Oe(e,t,r){e.traverse((function(object){if(!0===object.isBone){for(var e,i=0;i<t.length;i++){var n=t[i];if(n.name===object.name){e=n.boneInverse;break}}void 0===e&&(e=new Matrix4),r.push({bone:object,boneInverse:e,processed:!1})}}))}function Be(data){for(var e,t=[],r=data.matrix,n=data.nodes,o=data.type,l=data.instanceCameras,c=data.instanceControllers,h=data.instanceLights,d=data.instanceGeometries,f=data.instanceNodes,i=0,v=n.length;i<v;i++)t.push(Ge(n[i]));for(i=0,v=l.length;i<v;i++){var y=ae(l[i]);null!==y&&t.push(y.clone())}for(i=0,v=c.length;i<v;i++)for(var x=c[i],w=(e=x.id,m(Ze.controllers[e],B)),M=Ve(ge(w.id),x.materials),S=Re(x.skeletons,w.skin.joints),A=0,T=M.length;A<T;A++){var object;(object=M[A]).isSkinnedMesh&&(object.bind(S,w.skin.bindMatrix),object.normalizeSkinWeights()),t.push(object)}for(i=0,v=h.length;i<v;i++){var _=ce(h[i]);null!==_&&t.push(_.clone())}for(i=0,v=d.length;i<v;i++)for(A=0,T=(M=Ve(ge((x=d[i]).id),x.materials)).length;A<T;A++)t.push(M[A]);for(i=0,v=f.length;i<v;i++)t.push(Ge(f[i]).clone());if(0===n.length&&1===t.length)object=t[0];else{object="JOINT"===o?new Bone:new Group;for(i=0;i<t.length;i++)object.add(t[i])}return""===object.name&&(object.name="JOINT"===o?data.sid:data.name),object.matrix.copy(r),object.matrix.decompose(object.position,object.quaternion,object.scale),object}var Ie=new MeshBasicMaterial({color:16711935});function Ue(e,t){for(var r=[],i=0,n=e.length;i<n;i++){var o=t[e[i]];void 0===o?(console.warn("ColladaLoader: Material with key %s not found. Apply fallback material.",e[i]),r.push(Ie)):r.push(ee(o))}return r}function Ve(e,t){var r=[];for(var n in e){var o=e[n],l=Ue(o.materialKeys,t);0===l.length&&("lines"===n||"linestrips"===n?l.push(new LineBasicMaterial):l.push(new MeshPhongMaterial));var c=void 0!==o.data.attributes.skinIndex;if(c)for(var i=0,h=l.length;i<h;i++)l[i].skinning=!0;var object,d=1===l.length?l[0]:l;switch(n){case"lines":object=new LineSegments(o.data,d);break;case"linestrips":object=new Line(o.data,d);break;case"triangles":case"polylist":object=c?new SkinnedMesh(o.data,d):new Mesh(o.data,d)}r.push(object)}return r}function ke(e){return void 0!==Ze.nodes[e]}function Ge(e){return m(Ze.nodes[e],Be)}function ze(data){var e=new Group;e.name=data.name;for(var t=data.children,i=0;i<t.length;i++){var r=t[i];e.add(Ge(r.id))}return e}function je(e){return m(Ze.visualScenes[e],ze)}if(0===text.length)return{scene:new Scene};var We=e((new DOMParser).parseFromString(text,"application/xml"),"COLLADA")[0],He=We.getAttribute("version");console.log("ColladaLoader: File version",He);var Xe,Ye=function(t){return{unit:c(e(t,"unit")[0]),upAxis:h(e(t,"up_axis")[0])}}(e(We,"asset")[0]),qe=new TextureLoader(this.manager);qe.setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin),TGALoader&&(Xe=new TGALoader(this.manager)).setPath(this.resourcePath||path);var Qe=[],Ke={},Je=0,Ze={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};d(We,"library_animations","animation",(function(e){for(var data={sources:{},samplers:{},channels:{}},i=0,t=e.childNodes.length;i<t;i++){var r,n=e.childNodes[i];if(1===n.nodeType)switch(n.nodeName){case"source":r=n.getAttribute("id"),data.sources[r]=ue(n);break;case"sampler":r=n.getAttribute("id"),data.samplers[r]=v(n);break;case"channel":r=n.getAttribute("target"),data.channels[r]=y(n);break;default:console.log(n)}}Ze.animations[e.getAttribute("id")]=data})),d(We,"library_animation_clips","animation_clip",(function(e){for(var data={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"instance_animation":data.animations.push(o(r.getAttribute("url")))}}Ze.clips[e.getAttribute("id")]=data})),d(We,"library_controllers","controller",(function(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"skin":data.id=o(r.getAttribute("source")),data.skin=F(r);break;case"morph":data.id=o(r.getAttribute("source")),console.warn("ColladaLoader: Morph target animation not supported yet.")}}Ze.controllers[e.getAttribute("id")]=data})),d(We,"library_images","image",(function(t){var data={init_from:e(t,"init_from")[0].textContent};Ze.images[t.getAttribute("id")]=data})),d(We,"library_effects","effect",(function(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"profile_COMMON":data.profile=V(r)}}Ze.effects[e.getAttribute("id")]=data})),d(We,"library_materials","material",(function(e){for(var data={name:e.getAttribute("name")},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"instance_effect":data.url=o(r.getAttribute("url"))}}Ze.materials[e.getAttribute("id")]=data})),d(We,"library_cameras","camera",(function(e){for(var data={name:e.getAttribute("name")},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"optics":data.optics=te(r)}}Ze.cameras[e.getAttribute("id")]=data})),d(We,"library_lights","light",(function(e){for(var data={},i=0,t=e.childNodes.length;i<t;i++){var r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"technique_common":data=oe(r)}}Ze.lights[e.getAttribute("id")]=data})),d(We,"library_geometries","geometry",(function(t){var data={name:t.getAttribute("name"),sources:{},vertices:{},primitives:[]},r=e(t,"mesh")[0];if(void 0!==r){for(var i=0;i<r.childNodes.length;i++){var n=r.childNodes[i];if(1===n.nodeType){var o=n.getAttribute("id");switch(n.nodeName){case"source":data.sources[o]=ue(n);break;case"vertices":data.vertices=he(n);break;case"polygons":console.warn("ColladaLoader: Unsupported primitive type: ",n.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":data.primitives.push(de(n));break;default:console.log(n)}}}Ze.geometries[t.getAttribute("id")]=data}})),d(We,"library_nodes","node",De),d(We,"library_visual_scenes","visual_scene",(function(t){var data={name:t.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),i=0;i<t.length;i++){var element=t[i];!1===element.hasAttribute("id")&&element.setAttribute("id","three_default_"+Je++)}}(t);for(var r=e(t,"node"),i=0;i<r.length;i++)data.children.push(De(r[i]));Ze.visualScenes[t.getAttribute("id")]=data})),d(We,"library_kinematics_models","kinematics_model",(function(e){for(var data={name:e.getAttribute("name")||"",joints:{},links:[]},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"technique_common":xe(t,data)}}Ze.kinematicsModels[e.getAttribute("id")]=data})),d(We,"library_physics_models","physics_model",(function(e){for(var data={name:e.getAttribute("name")||"",rigidBodies:{}},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"rigid_body":data.rigidBodies[t.getAttribute("name")]={},Te(t,data.rigidBodies[t.getAttribute("name")])}}Ze.physicsModels[e.getAttribute("id")]=data})),d(We,"scene","instance_kinematics_scene",(function(e){for(var data={bindJointAxis:[]},i=0;i<e.childNodes.length;i++){var t=e.childNodes[i];if(1===t.nodeType)switch(t.nodeName){case"bind_joint_axis":data.bindJointAxis.push(Le(t))}}Ze.kinematicsScenes[o(e.getAttribute("url"))]=data})),f(Ze.animations,x),f(Ze.clips,E),f(Ze.controllers,B),f(Ze.images,I),f(Ze.effects,Z),f(Ze.materials,$),f(Ze.cameras,ne),f(Ze.lights,le),f(Ze.geometries,fe),f(Ze.visualScenes,ze),function(){var e=Ze.clips;if(!0===l(e)){if(!1===l(Ze.animations)){var t=[];for(var r in Ze.animations)for(var n=w(r),i=0,o=n.length;i<o;i++)t.push(n[i]);Qe.push(new AnimationClip("default",-1,t))}}else for(var r in e)Qe.push(D(r))}(),function(){var e=Object.keys(Ze.kinematicsModels)[0],t=Object.keys(Ze.kinematicsScenes)[0],r=Object.keys(Ze.visualScenes)[0];if(void 0!==e&&void 0!==t){for(var n,o=(n=e,m(Ze.kinematicsModels[n],ye)),l=function(e){return m(Ze.kinematicsScenes[e],Ce)}(t),c=je(r),h=l.bindJointAxis,d={},i=0,f=h.length;i<f;i++){var v=h[i],y=We.querySelector('[sid="'+v.target+'"]');if(y){var x=y.parentElement;M(v.jointIndex,x)}}var w=new Matrix4;Ke={joints:o&&o.joints,getJointValue:function(e){var t=d[e];if(t)return t.position;console.warn("ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){var r=d[e];if(r){var n=r.joint;if(t>n.limits.max||t<n.limits.min)console.warn("ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+n.limits.min+", max: "+n.limits.max+").");else if(n.static)console.warn("ColladaLoader: Joint "+e+" is static.");else{var object=r.object,o=n.axis,l=r.transforms;Pe.identity();for(var i=0;i<l.length;i++){var c=l[i];if(c.sid&&-1!==c.sid.indexOf(e))switch(n.type){case"revolute":Pe.multiply(w.makeRotationAxis(o,_Math.degToRad(t)));break;case"prismatic":Pe.multiply(w.makeTranslation(o.x*t,o.y*t,o.z*t));break;default:console.warn("ColladaLoader: Unknown joint type: "+n.type)}else switch(c.type){case"matrix":Pe.multiply(c.obj);break;case"translate":Pe.multiply(w.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"scale":Pe.scale(c.obj);break;case"rotate":Pe.multiply(w.makeRotationAxis(c.obj,c.angle))}}object.matrix.copy(Pe),object.matrix.decompose(object.position,object.quaternion,object.scale),d[e].position=t}}else console.log("ColladaLoader: "+e+" does not exist.")}}}function M(e,t){var r=t.getAttribute("name"),n=o.joints[e];c.traverse((function(object){object.name===r&&(d[e]={object:object,transforms:Ne(t),joint:n,position:n.zeroPosition})}))}}();var $e=function(t){return je(o(e(t,"instance_visual_scene")[0].getAttribute("url")))}(e(We,"scene")[0]);return"Z_UP"===Ye.upAxis&&$e.quaternion.setFromEuler(new Euler(-Math.PI/2,0,0)),$e.scale.multiplyScalar(Ye.unit),{animations:Qe,kinematics:Ke,library:Ze,scene:$e}}},CompressedTexture.prototype=Object.create(Texture.prototype),CompressedTexture.prototype.constructor=CompressedTexture,CompressedTexture.prototype.isCompressedTexture=!0,Object.assign(CompressedTextureLoader.prototype,{load:function(e,t,r,n){var o=this,l=[],c=new CompressedTexture;c.image=l;var h=new FileLoader(this.manager);function d(i){h.load(e[i],(function(e){var r=o._parser(e,!0);l[i]={width:r.width,height:r.height,format:r.format,mipmaps:r.mipmaps},6===(f+=1)&&(1===r.mipmapCount&&(c.minFilter=LinearFilter),c.format=r.format,c.needsUpdate=!0,t&&t(c))}),r,n)}if(h.setPath(this.path),h.setResponseType("arraybuffer"),Array.isArray(e))for(var f=0,i=0,m=e.length;i<m;++i)d(i);else h.load(e,(function(e){var r=o._parser(e,!0);if(r.isCubemap)for(var n=r.mipmaps.length/r.mipmapCount,h=0;h<n;h++){l[h]={mipmaps:[]};for(var i=0;i<r.mipmapCount;i++)l[h].mipmaps.push(r.mipmaps[h*r.mipmapCount+i]),l[h].format=r.format,l[h].width=r.width,l[h].height=r.height}else c.image.width=r.width,c.image.height=r.height,c.mipmaps=r.mipmaps;1===r.mipmapCount&&(c.minFilter=LinearFilter),c.format=r.format,c.needsUpdate=!0,t&&t(c)}),r,n);return c},setPath:function(e){return this.path=e,this}});var DDSLoader=function(e){CompressedTextureLoader.call(this,e),this._parser=DDSLoader.parse},BlendingMode,color,textureLoader,materialLoader;function RawShaderMaterial(e){ShaderMaterial.call(this,e),this.type="RawShaderMaterial"}function LineLoop(e,t){Line.call(this,e,t),this.type="LineLoop"}function LineDashedMaterial(e){LineBasicMaterial.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}function MeshDepthMaterial(e){Material$1.call(this),this.type="MeshDepthMaterial",this.depthPacking=BasicDepthPacking,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function MeshDistanceMaterial(e){Material$1.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new Vector3,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.lights=!1,this.setValues(e)}function MeshNormalMaterial(e){Material$1.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshStandardMaterial(e){Material$1.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Color(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshPhysicalMaterial(e){MeshStandardMaterial.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function MeshToonMaterial(e){MeshPhongMaterial.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function ShadowMaterial(e){Material$1.call(this),this.type="ShadowMaterial",this.color=new Color(0),this.transparent=!0,this.setValues(e)}function SpriteMaterial(e){Material$1.call(this),this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.rotation=0,this.sizeAttenuation=!0,this.lights=!1,this.transparent=!0,this.setValues(e)}function MaterialLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.textures={}}function Loader$1(){}DDSLoader.prototype=Object.create(CompressedTextureLoader.prototype),DDSLoader.prototype.constructor=DDSLoader,DDSLoader.parse=function(e,t){var r={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function n(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function o(e,t,r,n){for(var o=r*n*4,l=new Uint8Array(e,t,o),c=new Uint8Array(o),h=0,d=0,f=0;f<n;f++)for(var m=0;m<r;m++){var b=l[d],g=l[++d],v=l[++d],a=l[++d];d++,c[h]=v,c[++h]=g,c[++h]=b,c[++h]=a,h++}return c}var l,c=n("DXT1"),h=n("DXT3"),d=n("DXT5"),f=n("ETC1"),header=new Int32Array(e,0,31);if(542327876!==header[0])return console.error("DDSLoader.parse: Invalid magic number in DDS header."),r;if(4&!header[20])return console.error("DDSLoader.parse: Unsupported format, must contain a FourCC code."),r;var m,v=header[21],y=!1;switch(v){case c:l=8,r.format=RGB_S3TC_DXT1_Format;break;case h:l=16,r.format=RGBA_S3TC_DXT3_Format;break;case d:l=16,r.format=RGBA_S3TC_DXT5_Format;break;case f:l=8,r.format=RGB_ETC1_Format;break;default:if(!(32===header[22]&&16711680&header[23]&&65280&header[24]&&255&header[25]&&4278190080&header[26]))return console.error("DDSLoader.parse: Unsupported FourCC code ",(m=v,String.fromCharCode(255&m,m>>8&255,m>>16&255,m>>24&255))),r;y=!0,l=64,r.format=RGBAFormat}r.mipmapCount=1,131072&header[2]&&!1!==t&&(r.mipmapCount=Math.max(1,header[7]));var x=header[28];if(r.isCubemap=!!(512&x),r.isCubemap&&(!(1024&x)||!(2048&x)||!(4096&x)||!(8192&x)||!(16384&x)||!(32768&x)))return console.error("DDSLoader.parse: Incomplete cubemap faces"),r;r.width=header[4],r.height=header[3];for(var w=header[1]+4,M=r.isCubemap?6:1,S=0;S<M;S++)for(var A=r.width,T=r.height,i=0;i<r.mipmapCount;i++){if(y)var _=(L=o(e,w,A,T)).length;else{_=Math.max(4,A)/4*Math.max(4,T)/4*l;var L=new Uint8Array(e,w,_)}var C={data:L,width:A,height:T};r.mipmaps.push(C),w+=_,A=Math.max(A>>1,1),T=Math.max(T>>1,1)}return r},RawShaderMaterial.prototype=Object.create(ShaderMaterial.prototype),RawShaderMaterial.prototype.constructor=RawShaderMaterial,RawShaderMaterial.prototype.isRawShaderMaterial=!0,LineLoop.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineLoop,isLineLoop:!0}),LineDashedMaterial.prototype=Object.create(LineBasicMaterial.prototype),LineDashedMaterial.prototype.constructor=LineDashedMaterial,LineDashedMaterial.prototype.isLineDashedMaterial=!0,LineDashedMaterial.prototype.copy=function(source){return LineBasicMaterial.prototype.copy.call(this,source),this.scale=source.scale,this.dashSize=source.dashSize,this.gapSize=source.gapSize,this},MeshDepthMaterial.prototype=Object.create(Material$1.prototype),MeshDepthMaterial.prototype.constructor=MeshDepthMaterial,MeshDepthMaterial.prototype.isMeshDepthMaterial=!0,MeshDepthMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.depthPacking=source.depthPacking,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.map=source.map,this.alphaMap=source.alphaMap,this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this},MeshDistanceMaterial.prototype=Object.create(Material$1.prototype),MeshDistanceMaterial.prototype.constructor=MeshDistanceMaterial,MeshDistanceMaterial.prototype.isMeshDistanceMaterial=!0,MeshDistanceMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.referencePosition.copy(source.referencePosition),this.nearDistance=source.nearDistance,this.farDistance=source.farDistance,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.map=source.map,this.alphaMap=source.alphaMap,this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this},MeshNormalMaterial.prototype=Object.create(Material$1.prototype),MeshNormalMaterial.prototype.constructor=MeshNormalMaterial,MeshNormalMaterial.prototype.isMeshNormalMaterial=!0,MeshNormalMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.bumpMap=source.bumpMap,this.bumpScale=source.bumpScale,this.normalMap=source.normalMap,this.normalMapType=source.normalMapType,this.normalScale.copy(source.normalScale),this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this},MeshStandardMaterial.prototype=Object.create(Material$1.prototype),MeshStandardMaterial.prototype.constructor=MeshStandardMaterial,MeshStandardMaterial.prototype.isMeshStandardMaterial=!0,MeshStandardMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.defines={STANDARD:""},this.color.copy(source.color),this.roughness=source.roughness,this.metalness=source.metalness,this.map=source.map,this.lightMap=source.lightMap,this.lightMapIntensity=source.lightMapIntensity,this.aoMap=source.aoMap,this.aoMapIntensity=source.aoMapIntensity,this.emissive.copy(source.emissive),this.emissiveMap=source.emissiveMap,this.emissiveIntensity=source.emissiveIntensity,this.bumpMap=source.bumpMap,this.bumpScale=source.bumpScale,this.normalMap=source.normalMap,this.normalMapType=source.normalMapType,this.normalScale.copy(source.normalScale),this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this.roughnessMap=source.roughnessMap,this.metalnessMap=source.metalnessMap,this.alphaMap=source.alphaMap,this.envMap=source.envMap,this.envMapIntensity=source.envMapIntensity,this.refractionRatio=source.refractionRatio,this.wireframe=source.wireframe,this.wireframeLinewidth=source.wireframeLinewidth,this.wireframeLinecap=source.wireframeLinecap,this.wireframeLinejoin=source.wireframeLinejoin,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this},MeshPhysicalMaterial.prototype=Object.create(MeshStandardMaterial.prototype),MeshPhysicalMaterial.prototype.constructor=MeshPhysicalMaterial,MeshPhysicalMaterial.prototype.isMeshPhysicalMaterial=!0,MeshPhysicalMaterial.prototype.copy=function(source){return MeshStandardMaterial.prototype.copy.call(this,source),this.defines={PHYSICAL:""},this.reflectivity=source.reflectivity,this.clearCoat=source.clearCoat,this.clearCoatRoughness=source.clearCoatRoughness,this},MeshToonMaterial.prototype=Object.create(MeshPhongMaterial.prototype),MeshToonMaterial.prototype.constructor=MeshToonMaterial,MeshToonMaterial.prototype.isMeshToonMaterial=!0,MeshToonMaterial.prototype.copy=function(source){return MeshPhongMaterial.prototype.copy.call(this,source),this.gradientMap=source.gradientMap,this},ShadowMaterial.prototype=Object.create(Material$1.prototype),ShadowMaterial.prototype.constructor=ShadowMaterial,ShadowMaterial.prototype.isShadowMaterial=!0,ShadowMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this},SpriteMaterial.prototype=Object.create(Material$1.prototype),SpriteMaterial.prototype.constructor=SpriteMaterial,SpriteMaterial.prototype.isSpriteMaterial=!0,SpriteMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.color.copy(source.color),this.map=source.map,this.rotation=source.rotation,this.sizeAttenuation=source.sizeAttenuation,this},Object.assign(MaterialLoader.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n)},parse:function(e){var t=this.textures;function r(e){return void 0===t[e]&&console.warn("MaterialLoader: Undefined texture",e),t[e]}var n=new{LineBasicMaterial:LineBasicMaterial,LineDashedMaterial:LineDashedMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshToonMaterial:MeshToonMaterial,PointsMaterial:PointsMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial}[e.type];if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&n.specular.setHex(e.specular),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearCoat&&(n.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(n.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.vertexColors&&(n.vertexColors=e.vertexColors),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.combine&&(n.combine=e.combine),void 0!==e.side&&(n.side=e.side),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),1!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.polygonOffset&&(n.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(n.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(n.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.skinning&&(n.skinning=e.skinning),void 0!==e.morphTargets&&(n.morphTargets=e.morphTargets),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.uniforms)for(var o in e.uniforms){var l=e.uniforms[o];switch(n.uniforms[o]={},l.type){case"t":n.uniforms[o].value=r(l.value);break;case"c":n.uniforms[o].value=(new Color).setHex(l.value);break;case"v2":n.uniforms[o].value=(new Vector2).fromArray(l.value);break;case"v3":n.uniforms[o].value=(new Vector3).fromArray(l.value);break;case"v4":n.uniforms[o].value=(new Vector4).fromArray(l.value);break;case"m3":n.uniforms[o].value=(new Matrix3).fromArray(l.value);case"m4":n.uniforms[o].value=(new Matrix4).fromArray(l.value);break;default:n.uniforms[o].value=l.value}}if(void 0!==e.defines&&(n.defines=e.defines),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.extensions)for(var c in e.extensions)n.extensions[c]=e.extensions[c];if(void 0!==e.shading&&(n.flatShading=1===e.shading),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(n.map=r(e.map)),void 0!==e.alphaMap&&(n.alphaMap=r(e.alphaMap),n.transparent=!0),void 0!==e.bumpMap&&(n.bumpMap=r(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=r(e.normalMap)),void 0!==e.normalMapType&&(n.normalMapType=e.normalMapType),void 0!==e.normalScale){var h=e.normalScale;!1===Array.isArray(h)&&(h=[h,h]),n.normalScale=(new Vector2).fromArray(h)}return void 0!==e.displacementMap&&(n.displacementMap=r(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=r(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=r(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=r(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=r(e.specularMap)),void 0!==e.envMap&&(n.envMap=r(e.envMap)),void 0!==e.envMapIntensity&&(n.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.lightMap&&(n.lightMap=r(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=r(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=r(e.gradientMap)),n},setPath:function(e){return this.path=e,this},setTextures:function(e){return this.textures=e,this}}),Loader$1.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,i=0,r=t.length;i<r;i+=2){var n=t[i],o=t[i+1];if(n.test(e))return o}return null}},Object.assign(Loader$1.prototype,{crossOrigin:"anonymous",onLoadStart:function(){},onLoadProgress:function(){},onLoadComplete:function(){},initMaterials:function(e,t,r){for(var n=[],i=0;i<e.length;++i)n[i]=this.createMaterial(e[i],t,r);return n},createMaterial:(BlendingMode={NoBlending:NoBlending,NormalBlending:NormalBlending,AdditiveBlending:AdditiveBlending,SubtractiveBlending:SubtractiveBlending,MultiplyBlending:MultiplyBlending,CustomBlending:CustomBlending},color=new Color,textureLoader=new TextureLoader,materialLoader=new MaterialLoader,function(e,t,r){var n={};function o(path,e,o,l,c){var h,d=t+path,f=Loader$1.Handlers.get(d);null!==f?h=f.load(d):(textureLoader.setCrossOrigin(r),h=textureLoader.load(d)),void 0!==e&&(h.repeat.fromArray(e),1!==e[0]&&(h.wrapS=RepeatWrapping),1!==e[1]&&(h.wrapT=RepeatWrapping)),void 0!==o&&h.offset.fromArray(o),void 0!==l&&("repeat"===l[0]&&(h.wrapS=RepeatWrapping),"mirror"===l[0]&&(h.wrapS=MirroredRepeatWrapping),"repeat"===l[1]&&(h.wrapT=RepeatWrapping),"mirror"===l[1]&&(h.wrapT=MirroredRepeatWrapping)),void 0!==c&&(h.anisotropy=c);var m=_Math.generateUUID();return n[m]=h,m}var l={uuid:_Math.generateUUID(),type:"MeshLambertMaterial"};for(var c in e){var h=e[c];switch(c){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":l.name=h;break;case"blending":l.blending=BlendingMode[h];break;case"colorAmbient":case"mapAmbient":console.warn("Loader.createMaterial:",c,"is no longer supported.");break;case"colorDiffuse":l.color=color.fromArray(h).getHex();break;case"colorSpecular":l.specular=color.fromArray(h).getHex();break;case"colorEmissive":l.emissive=color.fromArray(h).getHex();break;case"specularCoef":l.shininess=h;break;case"shading":"basic"===h.toLowerCase()&&(l.type="MeshBasicMaterial"),"phong"===h.toLowerCase()&&(l.type="MeshPhongMaterial"),"standard"===h.toLowerCase()&&(l.type="MeshStandardMaterial");break;case"mapDiffuse":l.map=o(h,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":l.emissiveMap=o(h,e.mapEmissiveRepeat,e.mapEmissiveOffset,e.mapEmissiveWrap,e.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":l.lightMap=o(h,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":l.aoMap=o(h,e.mapAORepeat,e.mapAOOffset,e.mapAOWrap,e.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":l.bumpMap=o(h,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy);break;case"mapBumpScale":l.bumpScale=h;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":l.normalMap=o(h,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy);break;case"mapNormalFactor":l.normalScale=h;break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":l.specularMap=o(h,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":l.metalnessMap=o(h,e.mapMetalnessRepeat,e.mapMetalnessOffset,e.mapMetalnessWrap,e.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":l.roughnessMap=o(h,e.mapRoughnessRepeat,e.mapRoughnessOffset,e.mapRoughnessWrap,e.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":l.alphaMap=o(h,e.mapAlphaRepeat,e.mapAlphaOffset,e.mapAlphaWrap,e.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":l.side=BackSide;break;case"doubleSided":l.side=DoubleSide;break;case"transparency":console.warn("Loader.createMaterial: transparency has been renamed to opacity"),l.opacity=h;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":l[c]=h;break;case"vertexColors":!0===h&&(l.vertexColors=VertexColors),"face"===h&&(l.vertexColors=FaceColors);break;default:console.error("Loader.createMaterial: Unsupported",c,h)}}return"MeshBasicMaterial"===l.type&&delete l.emissive,"MeshPhongMaterial"!==l.type&&delete l.specular,l.opacity<1&&(l.transparent=!0),materialLoader.setTextures(n),materialLoader.parse(l)})});var LegacyGLTFLoader=function(){function e(e){this.manager=void 0!==e?e:DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,object){e[t]=object},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,r){for(var n in e){var object=e[n];object.update&&object.update(t,r)}}}}function r(e,t){var r={},n=e.material.uniforms;for(var o in n){var l=n[o];if(l.semantic){var c=l.node,h=e;c&&(h=t[c]),r[o]={semantic:l.semantic,sourceNode:h,targetNode:e,uniform:l}}}this.boundUniforms=r,this._m4=new Matrix4}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,n){var o,l=this;o=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:LoaderUtils.extractUrlBase(e);var c=new FileLoader(l.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.load(e,(function(data){l.parse(data,o,t)}),r,n)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){this.path=e},setResourcePath:function(e){return this.resourcePath=e,this},parse:function(data,path,e){var content,t={};LoaderUtils.decodeText(new Uint8Array(data,0,4))===l.magic?(t[n.KHR_BINARY_GLTF]=new h(data),content=t[n.KHR_BINARY_GLTF].content):content=LoaderUtils.decodeText(new Uint8Array(data));var r=JSON.parse(content);r.extensionsUsed&&r.extensionsUsed.indexOf(n.KHR_MATERIALS_COMMON)>=0&&(t[n.KHR_MATERIALS_COMMON]=new o(r)),new F(r,t,{crossOrigin:this.crossOrigin,manager:this.manager,path:path||this.resourcePath||""}).parse((function(t,r,n,o){e({scene:t,scenes:r,cameras:n,animations:o})}))}},e.Shaders={update:function(){console.warn("LegacyGLTFLoader.Shaders has been deprecated, and now updates automatically.")}},r.prototype.update=function(e,t){var r=this.boundUniforms;for(var n in r){var o=r[n];switch(o.semantic){case"MODELVIEW":o.uniform.value.multiplyMatrices(t.matrixWorldInverse,o.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var l=o.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,o.sourceNode.matrixWorld),l.getNormalMatrix(this._m4);break;case"PROJECTION":o.uniform.value.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var c=o.uniform.value,h=0;h<c.length;h++)c[h].getInverse(o.sourceNode.matrixWorld).multiply(o.targetNode.skeleton.bones[h].matrixWorld).multiply(o.targetNode.skeleton.boneInverses[h]).multiply(o.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+o.semantic)}}},e.Animations={update:function(){console.warn("LegacyGLTFLoader.Animation has been deprecated. Use AnimationMixer instead.")}};var n={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"};function o(e){this.name=n.KHR_MATERIALS_COMMON,this.lights={};var t=(e.extensions&&e.extensions[n.KHR_MATERIALS_COMMON]||{}).lights||{};for(var r in t){var o,l=t[r],c=l[l.type],h=(new Color).fromArray(c.color);switch(l.type){case"directional":(o=new DirectionalLight(h)).position.set(0,0,1);break;case"point":o=new PointLight(h);break;case"spot":(o=new SpotLight(h)).position.set(0,0,1);break;case"ambient":o=new AmbientLight(h)}o&&(this.lights[r]=o)}}var l={magic:"glTF",version:1,contentFormat:0},c=20;function h(data){this.name=n.KHR_BINARY_GLTF;var e=new DataView(data,0,c),header={magic:LoaderUtils.decodeText(new Uint8Array(data.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0),contentLength:e.getUint32(12,!0),contentFormat:e.getUint32(16,!0)};for(var t in l){var r=l[t];if(header[t]!==r)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',t,r)}var o=new Uint8Array(data,c,header.contentLength);this.header=header,this.content=LoaderUtils.decodeText(o),this.body=data.slice(c+header.contentLength,header.length)}h.prototype.loadShader=function(e,t){var r=t[e.extensions[n.KHR_BINARY_GLTF].bufferView],o=new Uint8Array(r);return LoaderUtils.decodeText(o)};var d={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},f={5126:Number,35675:Matrix3,35676:Matrix4,35664:Vector2,35665:Vector3,35666:Vector4,35678:Texture},m={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},v={9728:NearestFilter,9729:LinearFilter,9984:NearestMipMapNearestFilter,9985:LinearMipMapNearestFilter,9986:NearestMipMapLinearFilter,9987:LinearMipMapLinearFilter},y={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},x={6406:AlphaFormat,6407:RGBFormat,6408:RGBAFormat,6409:LuminanceFormat,6410:LuminanceAlphaFormat},w={5121:UnsignedByteType,32819:UnsignedShort4444Type,32820:UnsignedShort5551Type,33635:UnsignedShort565Type},M={1028:BackSide,1029:FrontSide},S={512:NeverDepth,513:LessDepth,514:EqualDepth,515:LessEqualDepth,516:GreaterEqualDepth,517:NotEqualDepth,518:GreaterEqualDepth,519:AlwaysDepth},A={32774:AddEquation,32778:SubtractEquation,32779:ReverseSubtractEquation},T={0:ZeroFactor,1:OneFactor,768:SrcColorFactor,769:OneMinusSrcColorFactor,770:SrcAlphaFactor,771:OneMinusSrcAlphaFactor,772:DstAlphaFactor,773:OneMinusDstAlphaFactor,774:DstColorFactor,775:OneMinusDstColorFactor,776:SrcAlphaSaturateFactor},_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},L={scale:"scale",translation:"position",rotation:"quaternion"},C={LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},N={2884:"CULL_FACE",2929:"DEPTH_TEST",3042:"BLEND",3089:"SCISSOR_TEST",32823:"POLYGON_OFFSET_FILL",32926:"SAMPLE_ALPHA_TO_COVERAGE"};function P(object,e,t){var r;if(!object)return Promise.resolve();var n=[];if("[object Array]"===Object.prototype.toString.call(object)){r=[];for(var o=object.length,l=0;l<o;l++){(h=e.call(t||this,object[l],l))&&(n.push(h),h instanceof Promise?h.then(function(e,t){r[e]=t}.bind(this,l)):r[l]=h)}}else for(var c in r={},object){var h;if(object.hasOwnProperty(c))(h=e.call(t||this,object[c],c))&&(n.push(h),h instanceof Promise?h.then(function(e,t){r[e]=t}.bind(this,c)):r[c]=h)}return Promise.all(n).then((function(){return r}))}function E(e,path){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:(path||"")+e}function D(e){this.isDeferredShaderMaterial=!0,this.params=e}function F(e,r,n){this.json=e||{},this.extensions=r||{},this.options=n||{},this.cache=new t}return D.prototype.create=function(){var e=UniformsUtils.clone(this.params.uniforms);for(var t in this.params.uniforms){var r=this.params.uniforms[t];r.value instanceof Texture&&(e[t].value=r.value,e[t].value.needsUpdate=!0),e[t].semantic=r.semantic,e[t].node=r.node}return this.params.uniforms=e,new RawShaderMaterial(this.params)},F.prototype._withDependencies=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i],n="load"+r.charAt(0).toUpperCase()+r.slice(1),o=this.cache.get(r);if(void 0!==o)t[r]=o;else if(this[n]){var l=this[n]();this.cache.add(r,l),t[r]=l}}return P(t,(function(e){return e}))},F.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then((function(r){var n=[];for(var o in r.scenes)n.push(r.scenes[o]);var l=void 0!==t.scene?r.scenes[t.scene]:n[0],c=[];for(var o in r.cameras){var h=r.cameras[o];c.push(h)}var d=[];for(var o in r.animations)d.push(r.animations[o]);e(l,n,c,d)}))},F.prototype.loadShaders=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then((function(o){return P(e.shaders,(function(e){return e.extensions&&e.extensions[n.KHR_BINARY_GLTF]?t[n.KHR_BINARY_GLTF].loadShader(e,o.bufferViews):new Promise((function(t){var n=new FileLoader(r.manager);n.setResponseType("text"),n.load(E(e.uri,r.path),(function(e){t(e)}))}))}))}))},F.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,r=this.options;return P(e.buffers,(function(e,o){return"binary_glTF"===o?t[n.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise((function(t){var n=new FileLoader(r.manager);n.setResponseType("arraybuffer"),n.load(E(e.uri,r.path),(function(e){t(e)}))})):void console.warn("LegacyGLTFLoader: "+e.type+" buffer type is not supported")}))},F.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then((function(t){return P(e.bufferViews,(function(e){var r=t.buffers[e.buffer],n=void 0!==e.byteLength?e.byteLength:0;return r.slice(e.byteOffset,e.byteOffset+n)}))}))},F.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then((function(t){return P(e.accessors,(function(e){var r=t.bufferViews[e.bufferView],n=_[e.type],o=m[e.componentType],l=o.BYTES_PER_ELEMENT,c=l*n;if(e.byteStride&&e.byteStride!==c){var h=new o(r);return new InterleavedBufferAttribute(new InterleavedBuffer(h,e.byteStride/l),n,e.byteOffset/l)}return new BufferAttribute(h=new o(r,e.byteOffset,e.count*n),n)}))}))},F.prototype.loadTextures=function(){var e=this.json,t=(this.extensions,this.options);return this._withDependencies(["bufferViews"]).then((function(r){return P(e.textures,(function(o){if(o.source)return new Promise((function(l){var source=e.images[o.source],c=source.uri,h=!1;if(source.extensions&&source.extensions[n.KHR_BINARY_GLTF]){var d=source.extensions[n.KHR_BINARY_GLTF],f=r.bufferViews[d.bufferView],m=new Blob([f],{type:d.mimeType});c=URL.createObjectURL(m),h=!0}var M=Loader$1.Handlers.get(c);null===M&&(M=new TextureLoader(t.manager)),M.setCrossOrigin(t.crossOrigin),M.load(E(c,t.path),(function(t){if(h&&URL.revokeObjectURL(c),t.flipY=!1,void 0!==o.name&&(t.name=o.name),t.format=void 0!==o.format?x[o.format]:RGBAFormat,void 0!==o.internalFormat&&t.format!==x[o.internalFormat]&&console.warn("LegacyGLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==o.type?w[o.type]:UnsignedByteType,o.sampler){var r=e.samplers[o.sampler];t.magFilter=v[r.magFilter]||LinearFilter,t.minFilter=v[r.minFilter]||NearestMipMapLinearFilter,t.wrapS=y[r.wrapS]||RepeatWrapping,t.wrapT=y[r.wrapT]||RepeatWrapping}l(t)}),void 0,(function(){h&&URL.revokeObjectURL(c),l()}))}))}))}))},F.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then((function(t){return P(e.materials,(function(r){var o,l,c={},h={};if(r.extensions&&r.extensions[n.KHR_MATERIALS_COMMON]&&(l=r.extensions[n.KHR_MATERIALS_COMMON]),l){var m=["ambient","emission","transparent","transparency","doubleSided"];switch(l.technique){case"BLINN":case"PHONG":o=MeshPhongMaterial,m.push("diffuse","specular","shininess");break;case"LAMBERT":o=MeshLambertMaterial,m.push("diffuse");break;case"CONSTANT":default:o=MeshBasicMaterial}m.forEach((function(e){void 0!==l.values[e]&&(c[e]=l.values[e])})),(l.doubleSided||c.doubleSided)&&(h.side=DoubleSide),(l.transparent||c.transparent)&&(h.transparent=!0,h.opacity=void 0!==c.transparency?c.transparency:1)}else if(void 0===r.technique)o=MeshPhongMaterial,Object.assign(c,r.values);else{o=D;var v=e.techniques[r.technique];h.uniforms={};var y=e.programs[v.program];if(y){h.fragmentShader=t.shaders[y.fragmentShader],h.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",y.fragmentShader),o=MeshPhongMaterial);var x=t.shaders[y.vertexShader];x||(console.warn("ERROR: Missing vertex shader definition:",y.vertexShader),o=MeshPhongMaterial),h.vertexShader=function(e,t){var r={};for(var n in t.attributes){var o=t.attributes[n],l=(param=t.parameters[o]).type,c=param.semantic;r[n]={type:l,semantic:c}}var h=t.parameters,d=t.attributes,f={};for(var n in r){var m=h[o=d[n]];(c=m.semantic)&&(f[n]=m)}for(var o in f){c=(param=f[o]).semantic;var param,v=new RegExp("\\b"+o+"\\b","g");switch(c){case"POSITION":e=e.replace(v,"position");break;case"NORMAL":e=e.replace(v,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(v,"uv");break;case"TEXCOORD_1":e=e.replace(v,"uv2");break;case"COLOR_0":case"COLOR0":case"COLOR":e=e.replace(v,"color");break;case"WEIGHT":e=e.replace(v,"skinWeight");break;case"JOINT":e=e.replace(v,"skinIndex")}}return e}(x,v);var w=v.uniforms;for(var _ in w){var L=w[_],C=v.parameters[L],P=C.type;if(!f[P])throw new Error("Unknown shader uniform param type: "+P);var E,F=C.count;void 0!==r.values&&(E=r.values[L]);var R=new f[P],O=C.semantic,B=C.node;switch(P){case d.FLOAT:R=C.value,"transparency"==L&&(h.transparent=!0),void 0!==E&&(R=E);break;case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:case d.FLOAT_MAT3:C&&C.value&&R.fromArray(C.value),E&&R.fromArray(E);break;case d.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case d.FLOAT_MAT4:if(F){R=new Array(F);for(var I=0;I<F;I++)R[I]=new f[P];if(C&&C.value){var U=C.value;R.fromArray(U)}E&&R.fromArray(E)}else{if(C&&C.value){var V=C.value;R.fromArray(V)}E&&R.fromArray(E)}break;case d.SAMPLER_2D:R=void 0!==E?t.textures[E]:void 0!==C.value?t.textures[C.value]:null}h.uniforms[_]={value:R,semantic:O,node:B}}for(var k=v.states||{},G=k.enable||[],z=k.functions||{},j=!1,W=!1,H=!1,i=0,X=G.length;i<X;i++){var Y=G[i];switch(N[Y]){case"CULL_FACE":j=!0;break;case"DEPTH_TEST":W=!0;break;case"BLEND":H=!0;break;case"SCISSOR_TEST":case"POLYGON_OFFSET_FILL":case"SAMPLE_ALPHA_TO_COVERAGE":break;default:throw new Error("Unknown technique.states.enable: "+Y)}}h.side=j?void 0!==z.cullFace?M[z.cullFace]:FrontSide:DoubleSide,h.depthTest=W,h.depthFunc=void 0!==z.depthFunc?S[z.depthFunc]:LessDepth,h.depthWrite=void 0===z.depthMask||z.depthMask[0],h.blending=H?CustomBlending:NoBlending,h.transparent=H;var Q=z.blendEquationSeparate;void 0!==Q?(h.blendEquation=A[Q[0]],h.blendEquationAlpha=A[Q[1]]):(h.blendEquation=AddEquation,h.blendEquationAlpha=AddEquation);var K=z.blendFuncSeparate;void 0!==K?(h.blendSrc=T[K[0]],h.blendDst=T[K[1]],h.blendSrcAlpha=T[K[2]],h.blendDstAlpha=T[K[3]]):(h.blendSrc=OneFactor,h.blendDst=ZeroFactor,h.blendSrcAlpha=OneFactor,h.blendDstAlpha=ZeroFactor)}}Array.isArray(c.diffuse)?h.color=(new Color).fromArray(c.diffuse):"string"==typeof c.diffuse&&(h.map=t.textures[c.diffuse]),delete h.diffuse,"string"==typeof c.reflective&&(h.envMap=t.textures[c.reflective]),"string"==typeof c.bump&&(h.bumpMap=t.textures[c.bump]),Array.isArray(c.emission)?o===MeshBasicMaterial?h.color=(new Color).fromArray(c.emission):h.emissive=(new Color).fromArray(c.emission):"string"==typeof c.emission&&(o===MeshBasicMaterial?h.map=t.textures[c.emission]:h.emissiveMap=t.textures[c.emission]),Array.isArray(c.specular)?h.specular=(new Color).fromArray(c.specular):"string"==typeof c.specular&&(h.specularMap=t.textures[c.specular]),void 0!==c.shininess&&(h.shininess=c.shininess);var J=new o(h);return void 0!==r.name&&(J.name=r.name),J}))}))},F.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then((function(t){return P(e.meshes,(function(r){var n=new Group;void 0!==r.name&&(n.name=r.name),r.extras&&(n.userData=r.extras);var o=r.primitives||[];for(var l in o){var c=o[l];if(c.mode===d.TRIANGLES||void 0===c.mode){var h=new BufferGeometry,f=c.attributes;for(var m in f){if(!(w=f[m]))return;var v=t.accessors[w];switch(m){case"POSITION":h.addAttribute("position",v);break;case"NORMAL":h.addAttribute("normal",v);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":h.addAttribute("uv",v);break;case"TEXCOORD_1":h.addAttribute("uv2",v);break;case"COLOR_0":case"COLOR0":case"COLOR":h.addAttribute("color",v);break;case"WEIGHT":h.addAttribute("skinWeight",v);break;case"JOINT":h.addAttribute("skinIndex",v);break;default:if(!c.material)break;if(!(S=e.materials[c.material]).technique)break;var y=e.techniques[S.technique].parameters||{};for(var x in y)y[x].semantic===m&&h.addAttribute(x,v)}}c.indices&&h.setIndex(t.accessors[c.indices]),(M=new Mesh(h,S=void 0!==t.materials?t.materials[c.material]:new MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:FrontSide}))).castShadow=!0,M.name="0"===l?n.name:n.name+l,c.extras&&(M.userData=c.extras),n.add(M)}else if(c.mode===d.LINES){h=new BufferGeometry,f=c.attributes;for(var m in f){var w;if(!(w=f[m]))return;v=t.accessors[w];switch(m){case"POSITION":h.addAttribute("position",v);break;case"COLOR_0":case"COLOR0":case"COLOR":h.addAttribute("color",v)}}var M,S=t.materials[c.material];c.indices?(h.setIndex(t.accessors[c.indices]),M=new LineSegments(h,S)):M=new Line(h,S),M.name="0"===l?n.name:n.name+l,c.extras&&(M.userData=c.extras),n.add(M)}else console.warn("Only triangular and line primitives are supported")}return n}))}))},F.prototype.loadCameras=function(){return P(this.json.cameras,(function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,r=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,n=t*r,o=new PerspectiveCamera(_Math.radToDeg(n),r,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(o.name=e.name),e.extras&&(o.userData=e.extras),o}if("orthographic"==e.type&&e.orthographic){o=new OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(o.name=e.name),e.extras&&(o.userData=e.extras),o}}))},F.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then((function(t){return P(e.skins,(function(e){var r=new Matrix4;return void 0!==e.bindShapeMatrix&&r.fromArray(e.bindShapeMatrix),{bindShapeMatrix:r,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]}}))}))},F.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then((function(t){return P(e.animations,(function(e,r){var n=[];for(var o in e.channels){var l=e.channels[o],c=e.samplers[l.sampler];if(c){var h=l.target,d=h.id,input=void 0!==e.parameters?e.parameters[c.input]:c.input,output=void 0!==e.parameters?e.parameters[c.output]:c.output,f=t.accessors[input],m=t.accessors[output],v=t.nodes[d];if(v){v.updateMatrix(),v.matrixAutoUpdate=!0;var y=L[h.path]===L.rotation?QuaternionKeyframeTrack:VectorKeyframeTrack,x=v.name?v.name:v.uuid,w=void 0!==c.interpolation?C[c.interpolation]:InterpolateLinear;n.push(new y(x+"."+L[h.path],AnimationUtils.arraySlice(f.array,0),AnimationUtils.arraySlice(m.array,0),w))}}}return new AnimationClip(d=void 0!==e.name?e.name:"animation_"+r,void 0,n)}))}))},F.prototype.loadNodes=function(){var e=this.json,t=this.extensions,r=this;return P(e.nodes,(function(e){var t,r=new Matrix4;return e.jointName?((t=new Bone).name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new Object3D,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(r.fromArray(e.matrix),t.applyMatrix(r)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t})).then((function(o){return r._withDependencies(["meshes","skins","cameras"]).then((function(r){return P(o,(function(l,c){var h=e.nodes[c];if(void 0!==h.meshes)for(var d in h.meshes){var f=h.meshes[d],m=r.meshes[f];if(void 0!==m)for(var v in m.children){var y,x=m.children[v],w=x.material,M=x.geometry,S=x.userData,A=x.name;switch(w.isDeferredShaderMaterial?w=T=w.create():T=w,x.type){case"LineSegments":x=new LineSegments(M,T);break;case"LineLoop":x=new LineLoop(M,T);break;case"Line":x=new Line(M,T);break;default:x=new Mesh(M,T)}if(x.castShadow=!0,x.userData=S,x.name=A,h.skin&&(y=r.skins[h.skin]),y){var T,_=function(e){for(var t=Object.keys(o),i=0,r=t.length;i<r;i++){var n=o[t[i]];if(n.jointName===e)return n}return null},L=M;(T=w).skinning=!0,(x=new SkinnedMesh(L,T)).castShadow=!0,x.userData=S,x.name=A;for(var C=[],N=[],i=0,P=y.jointNames.length;i<P;i++){var E=y.jointNames[i],D=_(E);if(D){C.push(D);var F=y.inverseBindMatrices.array,R=(new Matrix4).fromArray(F,16*i);N.push(R)}else console.warn("WARNING: joint: '"+E+"' could not be found")}x.bind(new Skeleton(C,N),y.bindShapeMatrix);var O=function(t,r,n){var l=t[n];if(void 0!==l)for(var i=0,c=l.length;i<c;i++){var h=l[i],d=o[h],f=e.nodes[h];void 0!==d&&!0===d.isBone&&void 0!==f&&(r.add(d),O(f,d,"children"))}};O(h,x,"skeletons")}l.add(x)}else console.warn("LegacyGLTFLoader: Couldn't find node \""+f+'".')}if(void 0!==h.camera){var B=r.cameras[h.camera];l.add(B)}if(h.extensions&&h.extensions[n.KHR_MATERIALS_COMMON]&&h.extensions[n.KHR_MATERIALS_COMMON].light){var I=t[n.KHR_MATERIALS_COMMON].lights[h.extensions[n.KHR_MATERIALS_COMMON].light];l.add(I)}return l}))}))}))},F.prototype.loadScenes=function(){var e=this.json;function t(r,n,o){var l=o[r];n.add(l);var c=e.nodes[r];if(c.children)for(var h=c.children,i=0,d=h.length;i<d;i++){t(h[i],l,o)}}return this._withDependencies(["nodes"]).then((function(n){return P(e.scenes,(function(e){var o=new Scene;void 0!==e.name&&(o.name=e.name),e.extras&&(o.userData=e.extras);for(var l=e.nodes||[],i=0,c=l.length;i<c;i++){t(l[i],o,n.nodes)}return o.traverse((function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new r(e,n.nodes),e.onBeforeRender=function(e,t,r){this.gltfShader.update(t,r)})})),o}))}))},e}(),LegacyJSONLoader=function(){function e(e){"boolean"==typeof e&&(console.warn("JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:DefaultLoadingManager,this.withCredentials=!1}return Object.assign(e.prototype,{crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===this.path?LoaderUtils.extractUrlBase(e):this.path,l=new FileLoader(this.manager);l.setPath(this.path),l.setWithCredentials(this.withCredentials),l.load(e,(function(text){var r=JSON.parse(text),n=r.metadata;if(void 0!==n){var l=n.type;if(void 0!==l&&"object"===l.toLowerCase())return void console.error("JSONLoader: "+e+" should be loaded with ObjectLoader instead.")}var object=o.parse(r,path);t(object.geometry,object.materials)}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,path){void 0!==e.data&&(e=e.data),void 0!==e.scale?e.scale=1/e.scale:e.scale=1;var t=new Geometry;return function(e,t){function r(e,t){return e&1<<t}var i,n,o,l,c,h,d,f,m,v,y,x,w,M,S,A,T,_,L,C,N,P,E,D,F,R=e.faces,O=e.vertices,B=e.normals,I=e.colors,U=e.scale,V=0;if(void 0!==e.uvs){for(i=0;i<e.uvs.length;i++)e.uvs[i].length&&V++;for(i=0;i<V;i++)t.faceVertexUvs[i]=[]}for(l=0,c=O.length;l<c;)(_=new Vector3).x=O[l++]*U,_.y=O[l++]*U,_.z=O[l++]*U,t.vertices.push(_);for(l=0,c=R.length;l<c;)if(y=r(v=R[l++],0),x=r(v,1),w=r(v,3),M=r(v,4),S=r(v,5),A=r(v,6),T=r(v,7),y){if((C=new Face3).a=R[l],C.b=R[l+1],C.c=R[l+3],(N=new Face3).a=R[l+1],N.b=R[l+2],N.c=R[l+3],l+=4,x&&(m=R[l++],C.materialIndex=m,N.materialIndex=m),o=t.faces.length,w)for(i=0;i<V;i++)for(D=e.uvs[i],t.faceVertexUvs[i][o]=[],t.faceVertexUvs[i][o+1]=[],n=0;n<4;n++)F=new Vector2(D[2*(f=R[l++])],D[2*f+1]),2!==n&&t.faceVertexUvs[i][o].push(F),0!==n&&t.faceVertexUvs[i][o+1].push(F);if(M&&(d=3*R[l++],C.normal.set(B[d++],B[d++],B[d]),N.normal.copy(C.normal)),S)for(i=0;i<4;i++)d=3*R[l++],E=new Vector3(B[d++],B[d++],B[d]),2!==i&&C.vertexNormals.push(E),0!==i&&N.vertexNormals.push(E);if(A&&(P=I[h=R[l++]],C.color.setHex(P),N.color.setHex(P)),T)for(i=0;i<4;i++)P=I[h=R[l++]],2!==i&&C.vertexColors.push(new Color(P)),0!==i&&N.vertexColors.push(new Color(P));t.faces.push(C),t.faces.push(N)}else{if((L=new Face3).a=R[l++],L.b=R[l++],L.c=R[l++],x&&(m=R[l++],L.materialIndex=m),o=t.faces.length,w)for(i=0;i<V;i++)for(D=e.uvs[i],t.faceVertexUvs[i][o]=[],n=0;n<3;n++)F=new Vector2(D[2*(f=R[l++])],D[2*f+1]),t.faceVertexUvs[i][o].push(F);if(M&&(d=3*R[l++],L.normal.set(B[d++],B[d++],B[d])),S)for(i=0;i<3;i++)d=3*R[l++],E=new Vector3(B[d++],B[d++],B[d]),L.vertexNormals.push(E);if(A&&(h=R[l++],L.color.setHex(I[h])),T)for(i=0;i<3;i++)h=R[l++],L.vertexColors.push(new Color(I[h]));t.faces.push(L)}}(e,t),function(e,t){var r=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var i=0,n=e.skinWeights.length;i<n;i+=r){var o=e.skinWeights[i],l=r>1?e.skinWeights[i+1]:0,c=r>2?e.skinWeights[i+2]:0,h=r>3?e.skinWeights[i+3]:0;t.skinWeights.push(new Vector4(o,l,c,h))}if(e.skinIndices)for(i=0,n=e.skinIndices.length;i<n;i+=r){var a=e.skinIndices[i],b=r>1?e.skinIndices[i+1]:0,d=r>2?e.skinIndices[i+2]:0,f=r>3?e.skinIndices[i+3]:0;t.skinIndices.push(new Vector4(a,b,d,f))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}(e,t),function(e,t){var r=e.scale;if(void 0!==e.morphTargets)for(var i=0,n=e.morphTargets.length;i<n;i++){t.morphTargets[i]={},t.morphTargets[i].name=e.morphTargets[i].name,t.morphTargets[i].vertices=[];for(var o=t.morphTargets[i].vertices,l=e.morphTargets[i].vertices,c=0,h=l.length;c<h;c+=3){var d=new Vector3;d.x=l[c]*r,d.y=l[c+1]*r,d.z=l[c+2]*r,o.push(d)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('JSONLoader: "morphColors" no longer supported. Using them as face colors.');var f=t.faces,m=e.morphColors[0].colors;for(i=0,n=f.length;i<n;i++)f[i].color.fromArray(m,3*i)}}(e,t),function(e,t){var r=[],n=[];void 0!==e.animation&&n.push(e.animation),void 0!==e.animations&&(e.animations.length?n=n.concat(e.animations):n.push(e.animations));for(var i=0;i<n.length;i++){var o=AnimationClip.parseAnimation(n[i],t.bones);o&&r.push(o)}if(t.morphTargets){var l=AnimationClip.CreateClipsFromMorphTargetSequences(t.morphTargets,10);r=r.concat(l)}r.length>0&&(t.animations=r)}(e,t),t.computeFaceNormals(),t.computeBoundingSphere(),void 0===e.materials||0===e.materials.length?{geometry:t}:{geometry:t,materials:Loader$1.prototype.initMaterials(e.materials,this.resourcePath||path,this.crossOrigin)}}}),e}(),DRACOLoader$1=function(e){this.timeLoaded=0,this.manager=e||DefaultLoadingManager,this.materials=null,this.verbosity=0,this.attributeOptions={},this.drawMode=TrianglesDrawMode,this.nativeAttributeMap={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"}};function WebGLRenderTargetCube(e,t,r){WebGLRenderTarget.call(this,e,t,r)}function CubeCamera(e,t,r,n){Object3D.call(this),this.type="CubeCamera";var o=new PerspectiveCamera(90,1,e,t);o.up.set(0,-1,0),o.lookAt(new Vector3(1,0,0)),this.add(o);var l=new PerspectiveCamera(90,1,e,t);l.up.set(0,-1,0),l.lookAt(new Vector3(-1,0,0)),this.add(l);var c=new PerspectiveCamera(90,1,e,t);c.up.set(0,0,1),c.lookAt(new Vector3(0,1,0)),this.add(c);var h=new PerspectiveCamera(90,1,e,t);h.up.set(0,0,-1),h.lookAt(new Vector3(0,-1,0)),this.add(h);var d=new PerspectiveCamera(90,1,e,t);d.up.set(0,-1,0),d.lookAt(new Vector3(0,0,1)),this.add(d);var f=new PerspectiveCamera(90,1,e,t);f.up.set(0,-1,0),f.lookAt(new Vector3(0,0,-1)),this.add(f),n=n||{format:RGBFormat,magFilter:LinearFilter,minFilter:LinearFilter},this.renderTarget=new WebGLRenderTargetCube(r,r,n),this.renderTarget.texture.name="CubeCamera",this.update=function(e,t){null===this.parent&&this.updateMatrixWorld();var r=e.getRenderTarget(),n=this.renderTarget,m=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0),e.render(t,o),e.setRenderTarget(n,1),e.render(t,l),e.setRenderTarget(n,2),e.render(t,c),e.setRenderTarget(n,3),e.render(t,h),e.setRenderTarget(n,4),e.render(t,d),n.texture.generateMipmaps=m,e.setRenderTarget(n,5),e.render(t,f),e.setRenderTarget(r)},this.clear=function(e,t,r,n){for(var o=e.getRenderTarget(),l=this.renderTarget,i=0;i<6;i++)e.setRenderTarget(l,i),e.clear(t,r,n);e.setRenderTarget(o)}}DRACOLoader$1.prototype={constructor:DRACOLoader$1,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.load(e,(function(e){o.decodeDracoFile(e,t)}),r,n)},setPath:function(e){return this.path=e,this},setVerbosity:function(e){return this.verbosity=e,this},setDrawMode:function(e){return this.drawMode=e,this},setSkipDequantization:function(e,t){var r=!0;return void 0!==t&&(r=t),this.getAttributeOptions(e).skipDequantization=r,this},decodeDracoFile:function(e,t,r,n){var o=this;DRACOLoader$1.getDecoderModule().then((function(l){o.decodeDracoFileInternal(e,l.decoder,t,r,n)}))},decodeDracoFileInternal:function(e,t,r,n,o){var l=new t.DecoderBuffer;l.Init(new Int8Array(e),e.byteLength);var c=new t.Decoder,h=c.GetEncodedGeometryType(l);if(h==t.TRIANGULAR_MESH)this.verbosity>0&&console.log("Loaded a mesh.");else{if(h!=t.POINT_CLOUD){var d="DRACOLoader: Unknown geometry type.";throw console.error(d),new Error(d)}this.verbosity>0&&console.log("Loaded a point cloud.")}r(this.convertDracoGeometryTo3JS(t,c,h,l,n,o))},addAttributeToGeometry:function(e,t,r,n,o,l,c,h){if(0===l.ptr){var d="DRACOLoader: No attribute "+n;throw console.error(d),new Error(d)}var f,m,v=l.num_components(),y=r.num_points()*v;switch(o){case Float32Array:f=new e.DracoFloat32Array,t.GetAttributeFloatForAllPoints(r,l,f),h[n]=new Float32Array(y),m=Float32BufferAttribute;break;case Int8Array:f=new e.DracoInt8Array,t.GetAttributeInt8ForAllPoints(r,l,f),h[n]=new Int8Array(y),m=Int8BufferAttribute;break;case Int16Array:f=new e.DracoInt16Array,t.GetAttributeInt16ForAllPoints(r,l,f),h[n]=new Int16Array(y),m=Int16BufferAttribute;break;case Int32Array:f=new e.DracoInt32Array,t.GetAttributeInt32ForAllPoints(r,l,f),h[n]=new Int32Array(y),m=Int32BufferAttribute;break;case Uint8Array:f=new e.DracoUInt8Array,t.GetAttributeUInt8ForAllPoints(r,l,f),h[n]=new Uint8Array(y),m=Uint8BufferAttribute;break;case Uint16Array:f=new e.DracoUInt16Array,t.GetAttributeUInt16ForAllPoints(r,l,f),h[n]=new Uint16Array(y),m=Uint16BufferAttribute;break;case Uint32Array:f=new e.DracoUInt32Array,t.GetAttributeUInt32ForAllPoints(r,l,f),h[n]=new Uint32Array(y),m=Uint32BufferAttribute;break;default:d="DRACOLoader: Unexpected attribute type.";throw console.error(d),new Error(d)}for(var i=0;i<y;i++)h[n][i]=f.GetValue(i);c.addAttribute(n,new m(h[n],v)),e.destroy(f)},convertDracoGeometryTo3JS:function(e,t,r,n,o,l){var c,h;!0===this.getAttributeOptions("position").skipDequantization&&t.SkipAttributeTransform(e.POSITION);var d=performance.now();if(r===e.TRIANGULAR_MESH?(c=new e.Mesh,h=t.DecodeBufferToMesh(n,c)):(c=new e.PointCloud,h=t.DecodeBufferToPointCloud(n,c)),!h.ok()||0==c.ptr){var f="DRACOLoader: Decoding failed: ";throw f+=h.error_msg(),console.error(f),e.destroy(t),e.destroy(c),new Error(f)}var m,v=performance.now();e.destroy(n),r==e.TRIANGULAR_MESH?(m=c.num_faces(),this.verbosity>0&&console.log("Number of faces loaded: "+m.toString())):m=0;var y=c.num_points(),x=c.num_attributes();this.verbosity>0&&(console.log("Number of points loaded: "+y.toString()),console.log("Number of attributes loaded: "+x.toString()));var w=t.GetAttributeId(c,e.POSITION);if(-1==w){f="DRACOLoader: No position attribute found.";throw console.error(f),e.destroy(t),e.destroy(c),new Error(f)}var M=t.GetAttribute(c,w),S={},A=new BufferGeometry;if(o)for(var T in o){var _=l[T],L=o[T],C=t.GetAttributeByUniqueId(c,L);this.addAttributeToGeometry(e,t,c,T,_,C,A,S)}else for(var T in this.nativeAttributeMap){var N=t.GetAttributeId(c,e[this.nativeAttributeMap[T]]);if(-1!==N){this.verbosity>0&&console.log("Loaded "+T+" attribute.");C=t.GetAttribute(c,N);this.addAttributeToGeometry(e,t,c,T,Float32Array,C,A,S)}}if(r==e.TRIANGULAR_MESH)if(this.drawMode===TriangleStripDrawMode){var P=new e.DracoInt32Array;t.GetTriangleStripsFromMesh(c,P);S.indices=new Uint32Array(P.size());for(var i=0;i<P.size();++i)S.indices[i]=P.GetValue(i);e.destroy(P)}else{var E=3*m;S.indices=new Uint32Array(E);var D=new e.DracoInt32Array;for(i=0;i<m;++i){t.GetFaceFromMesh(c,i,D);var F=3*i;S.indices[F]=D.GetValue(0),S.indices[F+1]=D.GetValue(1),S.indices[F+2]=D.GetValue(2)}e.destroy(D)}A.drawMode=this.drawMode,r==e.TRIANGULAR_MESH&&A.setIndex(new(S.indices.length>65535?Uint32BufferAttribute:Uint16BufferAttribute)(S.indices,1));var R=new e.AttributeQuantizationTransform;if(R.InitFromAttribute(M)){A.attributes.position.isQuantized=!0,A.attributes.position.maxRange=R.range(),A.attributes.position.numQuantizationBits=R.quantization_bits(),A.attributes.position.minValues=new Float32Array(3);for(i=0;i<3;++i)A.attributes.position.minValues[i]=R.min_value(i)}return e.destroy(R),e.destroy(t),e.destroy(c),this.decode_time=v-d,this.import_time=performance.now()-v,this.verbosity>0&&(console.log("Decode time: "+this.decode_time),console.log("Import time: "+this.import_time)),A},isVersionSupported:function(e,t){DRACOLoader$1.getDecoderModule().then((function(r){t(r.decoder.isVersionSupported(e))}))},getAttributeOptions:function(e){return void 0===this.attributeOptions[e]&&(this.attributeOptions[e]={}),this.attributeOptions[e]}},DRACOLoader$1.decoderPath="./",DRACOLoader$1.decoderConfig={},DRACOLoader$1.decoderModulePromise=null,DRACOLoader$1.setDecoderPath=function(path){DRACOLoader$1.decoderPath=path},DRACOLoader$1.setDecoderConfig=function(e){var t=DRACOLoader$1.decoderConfig.wasmBinary;DRACOLoader$1.decoderConfig=e||{},DRACOLoader$1.releaseDecoderModule(),t&&(DRACOLoader$1.decoderConfig.wasmBinary=t)},DRACOLoader$1.releaseDecoderModule=function(){DRACOLoader$1.decoderModulePromise=null},DRACOLoader$1.getDecoderModule=function(){var e=this,path=DRACOLoader$1.decoderPath,t=DRACOLoader$1.decoderConfig,r=DRACOLoader$1.decoderModulePromise;return r||("undefined"!=typeof DracoDecoderModule?r=Promise.resolve():"object"!=typeof WebAssembly||"js"===t.type?r=DRACOLoader$1._loadScript(path+"draco_decoder.js"):(t.wasmBinaryFile=path+"draco_decoder.wasm",r=DRACOLoader$1._loadScript(path+"draco_wasm_wrapper.js").then((function(){return DRACOLoader$1._loadArrayBuffer(t.wasmBinaryFile)})).then((function(e){t.wasmBinary=e}))),r=r.then((function(){return new Promise((function(r){t.onModuleLoaded=function(t){e.timeLoaded=performance.now(),r({decoder:t})},DracoDecoderModule(t)}))})),DRACOLoader$1.decoderModulePromise=r,r)},DRACOLoader$1._loadScript=function(e){var t=document.getElementById("decoder_script");null!==t&&t.parentNode.removeChild(t);var head=document.getElementsByTagName("head")[0],script=document.createElement("script");return script.id="decoder_script",script.type="text/javascript",script.src=e,new Promise((function(e){script.onload=e,head.appendChild(script)}))},DRACOLoader$1._loadArrayBuffer=function(e){var t=new FileLoader;return t.setResponseType("arraybuffer"),new Promise((function(r,n){t.load(e,r,void 0,n)}))},WebGLRenderTargetCube.prototype=Object.create(WebGLRenderTarget.prototype),WebGLRenderTargetCube.prototype.constructor=WebGLRenderTargetCube,WebGLRenderTargetCube.prototype.isWebGLRenderTargetCube=!0,CubeCamera.prototype=Object.create(Object3D.prototype),CubeCamera.prototype.constructor=CubeCamera;var CubemapGenerator=function(e){this.renderer=e};CubemapGenerator.prototype.fromEquirectangular=function(e,t){t=t||{};var r=new Scene,n={tEquirect:{value:null}},o="\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t//include <common>\n\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t#include <begin_vertex>\n\t\t\t\t#include <project_vertex>\n\n\t\t\t}\n\t\t\t",l="\n\t\t\tuniform sampler2D tEquirect;\n\n\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t//include <common>\n\t\t\t#define RECIPROCAL_PI 0.31830988618\n\t\t\t#define RECIPROCAL_PI2 0.15915494\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\tvec2 sampleUV;\n\n\t\t\t\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\n\t\t\t\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\n\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t}\n\t\t\t",c=new ShaderMaterial({type:"CubemapFromEquirect",uniforms:UniformsUtils.clone(n),vertexShader:o,fragmentShader:l,side:BackSide,blending:NoBlending});c.uniforms.tEquirect.value=e;var h=new Mesh(new BoxBufferGeometry(5,5,5),c);r.add(h);var d=new CubeCamera(1,10,t.resolution||512,{type:e.type,format:e.format,encoding:e.encoding,generateMipmaps:void 0!==t.generateMipmaps?t.generateMipmaps:e.generateMipmaps,minFilter:void 0!==t.minFilter?t.minFilter:e.minFilter,magFilter:void 0!==t.magFilter?t.magFilter:e.magFilter});return d.update(this.renderer,r),h.geometry.dispose(),h.material.dispose(),d.renderTarget};var EquirectangularToCubeGenerator=function(){var e,t=new PerspectiveCamera(90,1,.1,10),r=new Scene,n=new Mesh(new BoxBufferGeometry(1,1,1),((e=new ShaderMaterial({uniforms:{equirectangularMap:{value:null}},vertexShader:"varying vec3 localPosition;\n        \n        void main() {\n          localPosition = position;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }",fragmentShader:"#include <common>\n        varying vec3 localPosition;\n        uniform sampler2D equirectangularMap;\n        \n        vec2 EquirectangularSampleUV(vec3 v) {\n          vec2 uv = vec2(atan(v.z, v.x), asin(v.y));\n          uv *= vec2(0.1591, 0.3183); // inverse atan\n          uv += 0.5;\n          return uv;\n        }\n        \n        void main() {\n          vec2 uv = EquirectangularSampleUV(normalize(localPosition));\n          gl_FragColor = texture2D(equirectangularMap, uv);\n        }",blending:NoBlending})).type="EquirectangularToCubeGenerator",e));n.material.side=BackSide,r.add(n);var o=function(e,t){t=t||{},this.sourceTexture=e,this.resolution=t.resolution||512,this.views=[{t:[1,0,0],u:[0,-1,0]},{t:[-1,0,0],u:[0,-1,0]},{t:[0,1,0],u:[0,0,1]},{t:[0,-1,0],u:[0,0,-1]},{t:[0,0,1],u:[0,-1,0]},{t:[0,0,-1],u:[0,-1,0]}];var r={format:t.format||this.sourceTexture.format,magFilter:this.sourceTexture.magFilter,minFilter:this.sourceTexture.minFilter,type:t.type||this.sourceTexture.type,generateMipmaps:this.sourceTexture.generateMipmaps,anisotropy:this.sourceTexture.anisotropy,encoding:this.sourceTexture.encoding};this.renderTarget=new WebGLRenderTargetCube(this.resolution,this.resolution,r)};return o.prototype={constructor:o,update:function(e){var o=e.getRenderTarget();n.material.uniforms.equirectangularMap.value=this.sourceTexture;for(var i=0;i<6;i++){var l=this.views[i];t.position.set(0,0,0),t.up.set(l.u[0],l.u[1],l.u[2]),t.lookAt(l.t[0],l.t[1],l.t[2]),e.setRenderTarget(this.renderTarget,i),e.clear(),e.render(r,t)}return e.setRenderTarget(o),this.renderTarget.texture},dispose:function(){this.renderTarget.dispose()}},o}();function DataTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this._parser=null}Object.assign(DataTextureLoader.prototype,{load:function(e,t,r,n){var o=this,l=new DataTexture,c=new FileLoader(this.manager);return c.setResponseType("arraybuffer"),c.setPath(this.path),c.load(e,(function(e){var r=o._parser(e);r&&(void 0!==r.image?l.image=r.image:void 0!==r.data&&(l.image.width=r.width,l.image.height=r.height,l.image.data=r.data),l.wrapS=void 0!==r.wrapS?r.wrapS:ClampToEdgeWrapping,l.wrapT=void 0!==r.wrapT?r.wrapT:ClampToEdgeWrapping,l.magFilter=void 0!==r.magFilter?r.magFilter:LinearFilter,l.minFilter=void 0!==r.minFilter?r.minFilter:LinearMipMapLinearFilter,l.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,void 0!==r.format&&(l.format=r.format),void 0!==r.type&&(l.type=r.type),void 0!==r.mipmaps&&(l.mipmaps=r.mipmaps),1===r.mipmapCount&&(l.minFilter=LinearFilter),l.needsUpdate=!0,t&&t(l,r))}),r,n),l},setPath:function(e){return this.path=e,this}});var EXRLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};EXRLoader.prototype=Object.create(DataTextureLoader.prototype),EXRLoader.prototype._parser=function(e){var t=65536,r=t>>3,n=14,o=65537,l=1<<n,c=l-1,h=59,d=63,f=2+d-h,m=8,v=4,y=4,x=2,w=1;var M={l:0,c:0,lc:0};function S(e,t,r,n,o){for(;r<e;)t=t<<8|G(n,o),r+=8;r-=e,M.l=t>>r&(1<<e)-1,M.c=t,M.lc=r}var A=new Array(59);function T(e,t,r,n,l,c,m){for(var p=r,v=0,y=0;l<=c;l++){if(p.value-r.value>n)return!1;S(6,v,y,e,p);var x=M.l;if(v=M.c,y=M.lc,m[l]=x,x==d){if(p.value-r.value>n)throw"Something wrong with hufUnpackEncTable";S(8,v,y,e,p);var w=M.l+f;if(v=M.c,y=M.lc,l+w>c+1)throw"Something wrong with hufUnpackEncTable";for(;w--;)m[l++]=0;l--}else if(x>=h){if(l+(w=x-h+2)>c+1)throw"Something wrong with hufUnpackEncTable";for(;w--;)m[l++]=0;l--}}!function(e){for(var i=0;i<=58;++i)A[i]=0;for(i=0;i<o;++i)A[e[i]]+=1;var t=0;for(i=58;i>0;--i){var r=t+A[i]>>1;A[i]=t,t=r}for(i=0;i<o;++i){var n=e[i];n>0&&(e[i]=n|A[n]++<<6)}}(m)}function _(code){return 63&code}function L(code){return code>>6}var C={c:0,lc:0};function N(e,t,r,n){e=e<<8|G(r,n),t+=8,C.c=e,C.lc=t}var P={c:0,lc:0};function E(e,t,r,n,o,l,c,h,d,f){if(e==t){n<8&&(N(r,n,o,c),r=C.c,n=C.lc);var m=r>>(n-=8);m=new Uint8Array([m])[0];if(d.value+m>f)return!1;for(var s=h[d.value-1];m-- >0;)h[d.value++]=s}else{if(!(d.value<f))return!1;h[d.value++]=e}P.c=r,P.lc=n}function D(e){var t=function(e){return 65535&e}(e);return t>32767?t-65536:t}var F={a:0,b:0};function R(e,t){var r=D(e),n=D(t),o=r+(1&n)+(n>>1),l=o,c=o-n;F.a=l,F.b=c}function O(e,t,r,n,o,l,c){for(var h,d=r>o?o:r,p=1;p<=d;)p<<=1;for(h=p>>=1,p>>=1;p>=1;){for(var f,m,v,y,x=0,w=x+l*(o-h),M=l*p,S=l*h,A=n*p,T=n*h;x<=w;x+=S){for(var _=x,L=x+n*(r-h);_<=L;_+=T){var C=_+A,N=(P=_+M)+A;R(t[_+e],t[P+e]),f=F.a,v=F.b,R(t[C+e],t[N+e]),m=F.a,y=F.b,R(f,m),t[_+e]=F.a,t[C+e]=F.b,R(v,y),t[P+e]=F.a,t[N+e]=F.b}if(r&p){var P=_+M;R(t[_+e],t[P+e]),f=F.a,t[P+e]=F.b,t[_+e]=f}}if(o&p)for(_=x,L=x+n*(r-h);_<=L;_+=T){C=_+A;R(t[_+e],t[C+e]),f=F.a,t[C+e]=F.b,t[_+e]=f}h=p,p>>=1}return x}function B(e,t,r,h,d,f,m){var v=r.value,y=k(t,r),x=k(t,r);r.value+=4;var w=k(t,r);if(r.value+=4,y<0||y>=o||x<0||x>=o)throw"Something wrong with HUF_ENCSIZE";var M=new Array(o),S=new Array(l);if(function(e){for(var i=0;i<l;i++)e[i]={},e[i].len=0,e[i].lit=0,e[i].p=null}(S),T(e,0,r,h-(r.value-v),y,x,M),w>8*(h-(r.value-v)))throw"Something wrong with hufUncompress";!function(e,t,r,o){for(;t<=r;t++){var l=L(e[t]),c=_(e[t]);if(l>>c)throw"Invalid table entry";if(c>n){if((d=o[l>>c-n]).len)throw"Invalid table entry";if(d.lit++,d.p){var p=d.p;d.p=new Array(d.lit);for(var i=0;i<d.lit-1;++i)d.p[i]=p[i]}else d.p=new Array(1);d.p[d.lit-1]=t}else if(c){var h=0;for(i=1<<n-c;i>0;i--){var d;if((d=o[(l<<n-c)+h]).len||d.p)throw"Invalid table entry";d.len=c,d.lit=t,h++}}}}(M,y,x,S),function(e,t,r,o,l,h,d,f,m,v){for(var y=0,x=0,w=f,M=Math.trunc(l.value+(h+7)/8);l.value<M;)for(N(y,x,r,l),y=C.c,x=C.lc;x>=n;){if((T=t[y>>x-n&c]).len)x-=T.len,E(T.lit,d,y,x,r,0,l,m,v,w),y=P.c,x=P.lc;else{if(!T.p)throw"hufDecode issues";var S;for(S=0;S<T.lit;S++){for(var A=_(e[T.p[S]]);x<A&&l.value<M;)N(y,x,r,l),y=C.c,x=C.lc;if(x>=A&&L(e[T.p[S]])==(y>>x-A&(1<<A)-1)){x-=A,E(T.p[S],d,y,x,r,0,l,m,v,w),y=P.c,x=P.lc;break}}if(S==T.lit)throw"hufDecode issues"}}var i=8-h&7;for(y>>=i,x-=i;x>0;){var T;if(!(T=t[y<<n-x&c]).len)throw"hufDecode issues";x-=T.len,E(T.lit,d,y,x,r,0,l,m,v,w),y=P.c,x=P.lc}}(M,S,e,0,r,w,x,m,d,f)}function I(e,n,o,l,c,h,d,f,m,v){var y=new Uint8Array(r),x=H(l,c),w=H(l,c);if(w>=r)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(x<=w)for(var i=0;i<w-x+1;i++)y[i+x]=z(l,c);var M=new Uint16Array(t);!function(e,r){for(var n=0,i=0;i<t;++i)(0==i||e[i>>3]&1<<(7&i))&&(r[n++]=i);for(var o=n-1;n<t;)r[n++]=0}(y,M);B(o,l,c,k(l,c),e,n,h);var S=new Array(d),A=0;for(i=0;i<d;i++){f[i];S[i]={},S[i].start=A,S[i].end=S[i].start,S[i].nx=m,S[i].ny=v,S[i].size=1,A+=S[i].nx*S[i].ny*S[i].size}var T=0;for(i=0;i<d;i++)for(var _=0;_<S[i].size;++_)T+=O(_+T,e,S[i].nx,S[i].size,S[i].ny,S[i].nx*S[i].size);return function(e,data,t){for(var i=0;i<t;++i)data[i]=e[data[i]]}(M,e,A),!0}function U(e,t){for(var r=new Uint8Array(e),n=0;0!=r[t.value+n];)n+=1;var o=(new TextDecoder).decode(r.slice(t.value,t.value+n));return t.value=t.value+n+1,o}function V(e,t){var r=e.getUint32(0,!0);return t.value=t.value+m,r}function k(e,t){var r=e.getUint32(t.value,!0);return t.value=t.value+y,r}function G(e,t){var r=e[t.value];return t.value=t.value+w,r}function z(e,t){var r=e.getUint8(t.value);return t.value=t.value+w,r}function j(e,t){var r=e.getFloat32(t.value,!0);return t.value+=v,r}function W(e){var t=(31744&e)>>10,r=1023&e;return(e>>15?-1:1)*(t?31===t?r?NaN:1/0:Math.pow(2,t-15)*(1+r/1024):r/1024*6103515625e-14)}function H(e,t){var r=e.getUint16(t.value,!0);return t.value+=x,r}function X(e,t){return W(H(e,t))}function Y(e,t,r,n,o){if("string"===n||"iccProfile"===n)return function(e,t,r){var n=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+r));return t.value=t.value+r,n}(t,r,o);if("chlist"===n)return function(e,t,r,n){for(var o=r.value,l=[];r.value<o+n-1;){var c=U(t,r),h=k(e,r),d=z(e,r);r.value+=3;var f=k(e,r),m=k(e,r);l.push({name:c,pixelType:h,pLinear:d,xSampling:f,ySampling:m})}return r.value+=1,l}(e,t,r,o);if("chromaticities"===n)return function(e,t){return{redX:j(e,t),redY:j(e,t),greenX:j(e,t),greenY:j(e,t),blueX:j(e,t),blueY:j(e,t),whiteX:j(e,t),whiteY:j(e,t)}}(e,r);if("compression"===n)return function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][z(e,t)]}(e,r);if("box2i"===n)return function(e,t){return{xMin:k(e,t),yMin:k(e,t),xMax:k(e,t),yMax:k(e,t)}}(e,r);if("lineOrder"===n)return function(e,t){return["INCREASING_Y"][z(e,t)]}(e,r);if("float"===n)return j(e,r);if("v2f"===n)return function(e,t){return[j(e,t),j(e,t)]}(e,r);if("int"===n)return k(e,r);throw"Cannot parse value for unsupported type: "+n}for(var Q=new DataView(e),K=new Uint8Array(e),J={},Z=(Q.getUint32(0,!0),Q.getUint8(4,!0),Q.getUint8(5,!0),{value:8}),$=!0;$;){var ee=U(e,Z);if(0==ee)$=!1;else{var te=Y(Q,e,Z,U(e,Z),k(Q,Z));J[ee]=te}}var re=J.dataWindow.yMax+1,ie=1;"PIZ_COMPRESSION"===J.compression&&(ie=32);for(var ne=re/ie,i=0;i<ne;i++)V(Q,Z);var ae=J.dataWindow.xMax-J.dataWindow.xMin+1,oe=J.dataWindow.yMax-J.dataWindow.yMin+1,se=J.channels.length,le=new Float32Array(ae*oe*se),ce={R:0,G:1,B:2,A:3};if("NO_COMPRESSION"===J.compression)for(var ue=0;ue<oe;ue++)for(var he=k(Q,Z),de=(k(Q,Z),0);de<J.channels.length;de++){var pe=ce[J.channels[de].name];if(1!==J.channels[de].pixelType)throw"EXRLoader._parser: unsupported pixelType "+J.channels[de].pixelType+". Only pixelType is 1 (HALF) is supported.";for(var fe=0;fe<ae;fe++){var me=X(Q,Z);le[ae*se*(oe-he)+fe*se+pe]=me}}else{if("PIZ_COMPRESSION"!==J.compression)throw"EXRLoader._parser: "+J.compression+" is unsupported";for(var ve=0;ve<oe/ie;ve++){k(Q,Z),k(Q,Z);var ge=ae*ie*(2*J.channels.length),ye=new Uint16Array(ge);I(ye,{value:0},K,Q,Z,ge,se,J.channels,ae,ie);for(var xe=0;xe<ie;xe++)for(de=0;de<J.channels.length;de++){pe=ce[J.channels[de].name];if(1!==J.channels[de].pixelType)throw"EXRLoader._parser: unsupported pixelType "+J.channels[de].pixelType+". Only pixelType is 1 (HALF) is supported.";for(fe=0;fe<ae;fe++){me=W(ye[de*(ie*ae)+xe*ae+fe]);le[ae*se*(oe-(xe+ve*ie))+fe*se+pe]=me}}}}return{header:J,width:ae,height:oe,data:le,format:4==J.channels.length?RGBAFormat:RGBFormat,type:FloatType}};var FBXLoader=function(){var e,t,r;function n(e){this.manager=void 0!==e?e:DefaultLoadingManager}function o(e){this.textureLoader=e}function l(){}function c(){}function h(){}function d(){}function f(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function m(){}function v(text){var e=text.match(/FBXVersion: (\d+)/);if(e)return parseInt(e[1]);throw new Error("FBXLoader: Cannot find the version number for the file given.")}function y(time){return time/46186158e3}n.prototype={constructor:n,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===o.path?LoaderUtils.extractUrlBase(e):o.path,l=new FileLoader(this.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(r){try{t(o.parse(r,path))}catch(t){setTimeout((function(){n&&n(t),o.manager.itemError(e)}),0)}}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(t,path){if(l="Kaydara FBX Binary  \0",(n=t).byteLength>=l.length&&l===L(n,0,l.length))e=(new d).parse(t);else{var r=L(t);if(!function(text){var e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],cursor=0;function t(e){var t=text[e-1];return text=text.slice(cursor+e),cursor++,t}for(var i=0;i<e.length;++i){if(t(1)===e[i])return!1}return!0}(r))throw new Error("FBXLoader: Unknown format.");if(v(r)<7e3)throw new Error("FBXLoader: FBX version not supported, FileVersion: "+v(r));e=(new h).parse(r)}var n,l;return new o(new TextureLoader(this.manager).setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin)).parse(e)}},o.prototype={constructor:o,parse:function(){t=this.parseConnections();var e=this.parseImages(),n=this.parseTextures(e),o=this.parseMaterials(n),c=this.parseDeformers(),h=(new l).parse(c);return this.parseScene(c,h,o),r},parseConnections:function(){var t=new Map;"Connections"in e&&e.Connections.connections.forEach((function(e){var r=e[0],n=e[1],o=e[2];t.has(r)||t.set(r,{parents:[],children:[]});var l={ID:n,relationship:o};t.get(r).parents.push(l),t.has(n)||t.set(n,{parents:[],children:[]});var c={ID:r,relationship:o};t.get(n).children.push(c)}));return t},parseImages:function(){var t={},r={};if("Video"in e.Objects){var n=e.Objects.Video;for(var o in n){var l=n[o];if(t[d=parseInt(o)]=l.RelativeFilename||l.Filename,"Content"in l){var c=l.Content instanceof ArrayBuffer&&l.Content.byteLength>0,h="string"==typeof l.Content&&""!==l.Content;if(c||h){var image=this.parseImage(n[o]);r[l.RelativeFilename||l.Filename]=image}}}}for(var d in t){var f=t[d];void 0!==r[f]?t[d]=r[f]:t[d]=t[d].split("\\").pop()}return t},parseImage:function(e){var t,content=e.Content,r=e.RelativeFilename||e.Filename,n=r.slice(r.lastIndexOf(".")+1).toLowerCase();switch(n){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if("function"!=typeof TGALoader)return void console.warn("FBXLoader: TGALoader is required to load TGA textures");if(null===Loader.Handlers.get(".tga")){var o=new TGALoader;o.setPath(this.textureLoader.path),Loader.Handlers.add(/\.tga$/i,o)}t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+n+'" is not supported.')}if("string"==typeof content)return"data:"+t+";base64,"+content;var l=new Uint8Array(content);return window.URL.createObjectURL(new Blob([l],{type:t}))},parseTextures:function(t){var r=new Map;if("Texture"in e.Objects){var n=e.Objects.Texture;for(var o in n){var l=this.parseTexture(n[o],t);r.set(parseInt(o),l)}}return r},parseTexture:function(e,t){var r=this.loadTexture(e,t);r.ID=e.id,r.name=e.attrName;var n=e.WrapModeU,o=e.WrapModeV,l=void 0!==n?n.value:0,c=void 0!==o?o.value:0;if(r.wrapS=0===l?RepeatWrapping:ClampToEdgeWrapping,r.wrapT=0===c?RepeatWrapping:ClampToEdgeWrapping,"Scaling"in e){var h=e.Scaling.value;r.repeat.x=h[0],r.repeat.y=h[1]}return r},loadTexture:function(e,r){var n,o,l=this.textureLoader.path,c=t.get(e.id).children;void 0!==c&&c.length>0&&void 0!==r[c[0].ID]&&(0!==(n=r[c[0].ID]).indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));var h=e.FileName.slice(-3).toLowerCase();if("tga"===h){var d=Loader.Handlers.get(".tga");null===d?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",n),o=new Texture):o=d.load(n)}else"psd"===h?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",n),o=new Texture):o=this.textureLoader.load(n);return this.textureLoader.setPath(l),o},parseMaterials:function(t){var r=new Map;if("Material"in e.Objects){var n=e.Objects.Material;for(var o in n){var l=this.parseMaterial(n[o],t);null!==l&&r.set(parseInt(o),l)}}return r},parseMaterial:function(e,r){var n=e.id,o=e.attrName,l=e.ShadingModel;if("object"==typeof l&&(l=l.value),!t.has(n))return null;var c,h=this.parseParameters(e,r,n);switch(l.toLowerCase()){case"phong":c=new MeshPhongMaterial;break;case"lambert":c=new MeshLambertMaterial;break;default:console.warn('FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',l),c=new MeshPhongMaterial}return c.setValues(h),c.name=o,c},parseParameters:function(e,r,n){var o={};e.BumpFactor&&(o.bumpScale=e.BumpFactor.value),e.Diffuse?o.color=(new Color).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(o.color=(new Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(o.displacementScale=e.DisplacementFactor.value),e.Emissive?o.emissive=(new Color).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(o.emissive=(new Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(o.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(o.opacity=parseFloat(e.Opacity.value)),o.opacity<1&&(o.transparent=!0),e.ReflectionFactor&&(o.reflectivity=e.ReflectionFactor.value),e.Shininess&&(o.shininess=e.Shininess.value),e.Specular?o.specular=(new Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(o.specular=(new Color).fromArray(e.SpecularColor.value));var l=this;return t.get(n).children.forEach((function(e){var t=e.relationship;switch(t){case"Bump":o.bumpMap=l.getTexture(r,e.ID);break;case"Maya|TEX_ao_map":o.aoMap=l.getTexture(r,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":o.map=l.getTexture(r,e.ID);break;case"DisplacementColor":o.displacementMap=l.getTexture(r,e.ID);break;case"EmissiveColor":o.emissiveMap=l.getTexture(r,e.ID);break;case"NormalMap":case"Maya|TEX_normal_map":o.normalMap=l.getTexture(r,e.ID);break;case"ReflectionColor":o.envMap=l.getTexture(r,e.ID),o.envMap.mapping=EquirectangularReflectionMapping;break;case"SpecularColor":o.specularMap=l.getTexture(r,e.ID);break;case"TransparentColor":o.alphaMap=l.getTexture(r,e.ID),o.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("FBXLoader: %s map is not supported in three.js, skipping texture.",t)}})),o},getTexture:function(r,n){return"LayeredTexture"in e.Objects&&n in e.Objects.LayeredTexture&&(console.warn("FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),n=t.get(n).children[0].ID),r.get(n)},parseDeformers:function(){var r={},n={};if("Deformer"in e.Objects){var o=e.Objects.Deformer;for(var l in o){var c=o[l],h=t.get(parseInt(l));if("Skin"===c.attrType){var d=this.parseSkeleton(h,o);d.ID=l,h.parents.length>1&&console.warn("FBXLoader: skeleton attached to more than one geometry is not supported."),d.geometryID=h.parents[0].ID,r[l]=d}else if("BlendShape"===c.attrType){var f={id:l};f.rawTargets=this.parseMorphTargets(h,o),f.id=l,h.parents.length>1&&console.warn("FBXLoader: morph target attached to more than one geometry is not supported."),n[l]=f}}}return{skeletons:r,morphTargets:n}},parseSkeleton:function(e,t){var r=[];return e.children.forEach((function(e){var n=t[e.ID];if("Cluster"===n.attrType){var o={ID:e.ID,indices:[],weights:[],transformLink:(new Matrix4).fromArray(n.TransformLink.a)};"Indexes"in n&&(o.indices=n.Indexes.a,o.weights=n.Weights.a),r.push(o)}})),{rawBones:r,bones:[]}},parseMorphTargets:function(e,r){for(var n=[],i=0;i<e.children.length;i++){var o=e.children[i],l=r[o.ID],c={name:l.attrName,initialWeight:l.DeformPercent,id:l.id,fullWeights:l.FullWeights.a};if("BlendShapeChannel"!==l.attrType)return;c.geoID=t.get(parseInt(o.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(c)}return n},parseScene:function(n,o,l){r=new Group;var h=this.parseModels(n.skeletons,o,l),d=e.Objects.Model,f=this;h.forEach((function(e){var n=d[e.ID];f.setLookAtProperties(e,n),t.get(e.ID).parents.forEach((function(t){var r=h.get(t.ID);void 0!==r&&r.add(e)})),null===e.parent&&r.add(e)})),this.bindSkeleton(n.skeletons,o,h),this.createAmbientLight(),this.setupMorphMaterials(),r.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=A(e.userData.transformData);e.applyMatrix(t)}}));var m=(new c).parse();1===r.children.length&&r.children[0].isGroup&&(r.children[0].animations=m,r=r.children[0]),r.animations=m},parseModels:function(r,n,o){var l=new Map,c=e.Objects.Model;for(var h in c){var d=parseInt(h),f=c[h],m=t.get(d),v=this.buildSkeleton(m,r,d,f.attrName);if(!v){switch(f.attrType){case"Camera":v=this.createCamera(m);break;case"Light":v=this.createLight(m);break;case"Mesh":v=this.createMesh(m,n,o);break;case"NurbsCurve":v=this.createCurve(m,n);break;case"LimbNode":case"Root":v=new Bone;break;case"Null":default:v=new Group}v.name=PropertyBinding.sanitizeNodeName(f.attrName),v.ID=d}this.getTransformData(v,f),l.set(d,v)}return l},buildSkeleton:function(e,t,r,n){var o=null;return e.parents.forEach((function(e){for(var l in t){var c=t[l];c.rawBones.forEach((function(t,i){if(t.ID===e.ID){var l=o;(o=new Bone).matrixWorld.copy(t.transformLink),o.name=PropertyBinding.sanitizeNodeName(n),o.ID=r,c.bones[i]=o,null!==l&&o.add(l)}}))}})),o},createCamera:function(t){var r,n;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(n=r)})),void 0===n)r=new Object3D;else{var o=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(o=1);var l=1;void 0!==n.NearPlane&&(l=n.NearPlane.value/1e3);var c=1e3;void 0!==n.FarPlane&&(c=n.FarPlane.value/1e3);var h=window.innerWidth,d=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(h=n.AspectWidth.value,d=n.AspectHeight.value);var f=h/d,m=45;void 0!==n.FieldOfView&&(m=n.FieldOfView.value);var v=n.FocalLength?n.FocalLength.value:null;switch(o){case 0:r=new PerspectiveCamera(m,f,l,c),null!==v&&r.setFocalLength(v);break;case 1:r=new OrthographicCamera(-h/2,h/2,d/2,-d/2,l,c);break;default:console.warn("FBXLoader: Unknown camera type "+o+"."),r=new Object3D}}return r},createLight:function(t){var r,n;if(t.children.forEach((function(t){var r=e.Objects.NodeAttribute[t.ID];void 0!==r&&(n=r)})),void 0===n)r=new Object3D;else{var o;o=void 0===n.LightType?0:n.LightType.value;var l=16777215;void 0!==n.Color&&(l=(new Color).fromArray(n.Color.value));var c=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(c=0);var h=0;void 0!==n.FarAttenuationEnd&&(h=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);switch(o){case 0:r=new PointLight(l,c,h,1);break;case 1:r=new DirectionalLight(l,c);break;case 2:var d=Math.PI/3;void 0!==n.InnerAngle&&(d=_Math.degToRad(n.InnerAngle.value));var f=0;void 0!==n.OuterAngle&&(f=_Math.degToRad(n.OuterAngle.value),f=Math.max(f,1)),r=new SpotLight(l,c,h,d,f,1);break;default:console.warn("FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),r=new PointLight(l,c)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(r.castShadow=!0)}return r},createMesh:function(e,t,r){var n,o=null,l=null,c=[];return e.children.forEach((function(e){t.has(e.ID)&&(o=t.get(e.ID)),r.has(e.ID)&&c.push(r.get(e.ID))})),c.length>1?l=c:c.length>0?l=c[0]:(l=new MeshPhongMaterial({color:13421772}),c.push(l)),"color"in o.attributes&&c.forEach((function(e){e.vertexColors=VertexColors})),o.FBX_Deformer?(c.forEach((function(e){e.skinning=!0})),(n=new SkinnedMesh(o,l)).normalizeSkinWeights()):n=new Mesh(o,l),n},createCurve:function(e,t){return new Line(e.children.reduce((function(e,r){return t.has(r.ID)&&(e=t.get(r.ID)),e}),null),new LineBasicMaterial({color:3342591,linewidth:1}))},getTransformData:function(e,t){var r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?T(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r},setLookAtProperties:function(n,o){"LookAtProperty"in o&&t.get(n.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var o=e.Objects.Model[t.ID];if("Lcl_Translation"in o){var l=o.Lcl_Translation.value;void 0!==n.target?(n.target.position.fromArray(l),r.add(n.target)):n.lookAt((new Vector3).fromArray(l))}}}))},bindSkeleton:function(e,r,n){var o=this.parsePoseNodes();for(var l in e){var c=e[l];t.get(parseInt(c.ID)).parents.forEach((function(e){if(r.has(e.ID)){var l=e.ID;t.get(l).parents.forEach((function(e){n.has(e.ID)&&n.get(e.ID).bind(new Skeleton(c.bones),o[e.ID])}))}}))}},parsePoseNodes:function(){var t={};if("Pose"in e.Objects){var r=e.Objects.Pose;for(var n in r)if("BindPose"===r[n].attrType){var o=r[n].PoseNode;Array.isArray(o)?o.forEach((function(e){t[e.Node]=(new Matrix4).fromArray(e.Matrix.a)})):t[o.Node]=(new Matrix4).fromArray(o.Matrix.a)}}return t},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var t=e.GlobalSettings.AmbientColor.value,n=t[0],g=t[1],b=t[2];if(0!==n||0!==g||0!==b){var o=new Color(n,g,b);r.add(new AmbientLight(o,1))}}},setupMorphMaterials:function(){var e=this;r.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(r,i){e.setupMorphMaterial(t,r,i)})):e.setupMorphMaterial(t,t.material))}))},setupMorphMaterial:function(e,t,n){var o=e.uuid,l=t.uuid,c=!1;if(r.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===l&&e.uuid!==o&&(c=!0)})):e.material.uuid===l&&e.uuid!==o&&(c=!0))})),!0===c){var h=t.clone();h.morphTargets=!0,void 0===n?e.material=h:e.material[n]=h}else t.morphTargets=!0}},l.prototype={constructor:l,parse:function(r){var n=new Map;if("Geometry"in e.Objects){var o=e.Objects.Geometry;for(var l in o){var c=t.get(parseInt(l)),h=this.parseGeometry(c,o[l],r);n.set(parseInt(l),h)}}return n},parseGeometry:function(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}},parseMeshGeometry:function(t,r,n){var o=n.skeletons,l=n.morphTargets,c=t.parents.map((function(t){return e.Objects.Model[t.ID]}));if(0!==c.length){var h=t.children.reduce((function(e,t){return void 0!==o[t.ID]&&(e=o[t.ID]),e}),null),d=t.children.reduce((function(e,t){return void 0!==l[t.ID]&&(e=l[t.ID]),e}),null),f=c[0],m={};"RotationOrder"in f&&(m.eulerOrder=T(f.RotationOrder.value)),"InheritType"in f&&(m.inheritType=parseInt(f.InheritType.value)),"GeometricTranslation"in f&&(m.translation=f.GeometricTranslation.value),"GeometricRotation"in f&&(m.rotation=f.GeometricRotation.value),"GeometricScaling"in f&&(m.scale=f.GeometricScaling.value);var v=A(m);return this.genGeometry(r,h,d,v)}},genGeometry:function(e,t,r,n){var o=new BufferGeometry;e.attrName&&(o.name=e.attrName);var l=this.parseGeoNode(e,t),c=this.genBuffers(l),h=new Float32BufferAttribute(c.vertex,3);if(n.applyToBufferAttribute(h),o.addAttribute("position",h),c.colors.length>0&&o.addAttribute("color",new Float32BufferAttribute(c.colors,3)),t&&(o.addAttribute("skinIndex",new Uint16BufferAttribute(c.weightsIndices,4)),o.addAttribute("skinWeight",new Float32BufferAttribute(c.vertexWeights,4)),o.FBX_Deformer=t),c.normal.length>0){var d=new Float32BufferAttribute(c.normal,3);(new Matrix3).getNormalMatrix(n).applyToBufferAttribute(d),o.addAttribute("normal",d)}if(c.uvs.forEach((function(e,i){var t="uv"+(i+1).toString();0===i&&(t="uv"),o.addAttribute(t,new Float32BufferAttribute(c.uvs[i],2))})),l.material&&"AllSame"!==l.material.mappingType){var f=c.materialIndex[0],m=0;if(c.materialIndex.forEach((function(e,i){e!==f&&(o.addGroup(m,i-m,f),f=e,m=i)})),o.groups.length>0){var v=o.groups[o.groups.length-1],y=v.start+v.count;y!==c.materialIndex.length&&o.addGroup(y,c.materialIndex.length-y,f)}0===o.groups.length&&o.addGroup(0,c.materialIndex.length,c.materialIndex[0])}return this.addMorphTargets(o,e,r,n),o},parseGeoNode:function(e,t){var r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];for(var i=0;e.LayerElementUV[i];)r.uv.push(this.parseUVs(e.LayerElementUV[i])),i++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach((function(e,i){e.indices.forEach((function(t,n){void 0===r.weightTable[t]&&(r.weightTable[t]=[]),r.weightTable[t].push({id:i,weight:e.weights[n]})}))}))),r},genBuffers:function(e){var t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,n=0,o=!1,l=[],c=[],h=[],d=[],f=[],m=[],v=this;return e.vertexIndices.forEach((function(y,x){var M=!1;y<0&&(y^=-1,M=!0);var S=[],A=[];if(l.push(3*y,3*y+1,3*y+2),e.color){var data=w(x,r,y,e.color);h.push(data[0],data[1],data[2])}if(e.skeleton){if(void 0!==e.weightTable[y]&&e.weightTable[y].forEach((function(e){A.push(e.weight),S.push(e.id)})),A.length>4){o||(console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),o=!0);var T=[0,0,0,0],_=[0,0,0,0];A.forEach((function(e,t){var r=e,n=S[t];_.forEach((function(e,t,o){if(r>e){o[t]=r,r=e;var l=T[t];T[t]=n,n=l}}))})),S=T,A=_}for(;A.length<4;)A.push(0),S.push(0);for(var i=0;i<4;++i)f.push(A[i]),m.push(S[i])}if(e.normal){data=w(x,r,y,e.normal);c.push(data[0],data[1],data[2])}if(e.material&&"AllSame"!==e.material.mappingType)var L=w(x,r,y,e.material)[0];e.uv&&e.uv.forEach((function(e,i){var data=w(x,r,y,e);void 0===d[i]&&(d[i]=[]),d[i].push(data[0]),d[i].push(data[1])})),n++,M&&(v.genFace(t,e,l,L,c,h,d,f,m,n),r++,n=0,l=[],c=[],h=[],d=[],f=[],m=[])})),t},genFace:function(e,t,r,n,o,l,c,h,d,f){for(var i=2;i<f;i++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(i-1)]]),e.vertex.push(t.vertexPositions[r[3*(i-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(i-1)+2]]),e.vertex.push(t.vertexPositions[r[3*i]]),e.vertex.push(t.vertexPositions[r[3*i+1]]),e.vertex.push(t.vertexPositions[r[3*i+2]]),t.skeleton&&(e.vertexWeights.push(h[0]),e.vertexWeights.push(h[1]),e.vertexWeights.push(h[2]),e.vertexWeights.push(h[3]),e.vertexWeights.push(h[4*(i-1)]),e.vertexWeights.push(h[4*(i-1)+1]),e.vertexWeights.push(h[4*(i-1)+2]),e.vertexWeights.push(h[4*(i-1)+3]),e.vertexWeights.push(h[4*i]),e.vertexWeights.push(h[4*i+1]),e.vertexWeights.push(h[4*i+2]),e.vertexWeights.push(h[4*i+3]),e.weightsIndices.push(d[0]),e.weightsIndices.push(d[1]),e.weightsIndices.push(d[2]),e.weightsIndices.push(d[3]),e.weightsIndices.push(d[4*(i-1)]),e.weightsIndices.push(d[4*(i-1)+1]),e.weightsIndices.push(d[4*(i-1)+2]),e.weightsIndices.push(d[4*(i-1)+3]),e.weightsIndices.push(d[4*i]),e.weightsIndices.push(d[4*i+1]),e.weightsIndices.push(d[4*i+2]),e.weightsIndices.push(d[4*i+3])),t.color&&(e.colors.push(l[0]),e.colors.push(l[1]),e.colors.push(l[2]),e.colors.push(l[3*(i-1)]),e.colors.push(l[3*(i-1)+1]),e.colors.push(l[3*(i-1)+2]),e.colors.push(l[3*i]),e.colors.push(l[3*i+1]),e.colors.push(l[3*i+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(o[0]),e.normal.push(o[1]),e.normal.push(o[2]),e.normal.push(o[3*(i-1)]),e.normal.push(o[3*(i-1)+1]),e.normal.push(o[3*(i-1)+2]),e.normal.push(o[3*i]),e.normal.push(o[3*i+1]),e.normal.push(o[3*i+2])),t.uv&&t.uv.forEach((function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(c[r][0]),e.uvs[r].push(c[r][1]),e.uvs[r].push(c[r][2*(i-1)]),e.uvs[r].push(c[r][2*(i-1)+1]),e.uvs[r].push(c[r][2*i]),e.uvs[r].push(c[r][2*i+1])}))},addMorphTargets:function(t,r,n,o){if(null!==n){t.morphAttributes.position=[];var l=this;n.rawTargets.forEach((function(n){var c=e.Objects.Geometry[n.geoID];void 0!==c&&l.genMorphGeometry(t,r,c,o,n.name)}))}},genMorphGeometry:function(e,t,r,n,o){var l=new BufferGeometry;r.attrName&&(l.name=r.attrName);for(var c=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],h=void 0!==t.Vertices?t.Vertices.a.slice():[],d=void 0!==r.Vertices?r.Vertices.a:[],f=void 0!==r.Indexes?r.Indexes.a:[],i=0;i<f.length;i++){var m=3*f[i];h[m]+=d[3*i],h[m+1]+=d[3*i+1],h[m+2]+=d[3*i+2]}var v={vertexIndices:c,vertexPositions:h},y=new Float32BufferAttribute(this.genBuffers(v).vertex,3);y.name=o||r.attrName,n.applyToBufferAttribute(y),e.morphAttributes.position.push(y)},parseNormals:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Normals.a,o=[];return"IndexToDirect"===r&&("NormalIndex"in e?o=e.NormalIndex.a:"NormalsIndex"in e&&(o=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:o,mappingType:t,referenceType:r}},parseUVs:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.UV.a,o=[];return"IndexToDirect"===r&&(o=e.UVIndex.a),{dataSize:2,buffer:n,indices:o,mappingType:t,referenceType:r}},parseVertexColors:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType,n=e.Colors.a,o=[];return"IndexToDirect"===r&&(o=e.ColorIndex.a),{dataSize:4,buffer:n,indices:o,mappingType:t,referenceType:r}},parseMaterialIndices:function(e){var t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};for(var n=e.Materials.a,o=[],i=0;i<n.length;++i)o.push(i);return{dataSize:1,buffer:n,indices:o,mappingType:t,referenceType:r}},parseNurbsGeometry:function(e){if(void 0===NURBSCurve)return console.error("FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new BufferGeometry;var t=parseInt(e.Order);if(isNaN(t))return console.error("FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new BufferGeometry;for(var r,n,o=t-1,l=e.KnotVector.a,c=[],h=e.Points.a,i=0,d=h.length;i<d;i+=4)c.push((new Vector4).fromArray(h,i));if("Closed"===e.Form)c.push(c[0]);else if("Periodic"===e.Form){r=o,n=l.length-1-r;for(i=0;i<o;++i)c.push(c[i])}var f=new NURBSCurve(o,l,c,r,n).getPoints(7*c.length),m=new Float32Array(3*f.length);f.forEach((function(e,i){e.toArray(m,3*i)}));var v=new BufferGeometry;return v.addAttribute("position",new BufferAttribute(m,3)),v}},c.prototype={constructor:c,parse:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var r in t){var n=t[r],o=this.addClip(n);e.push(o)}return e},parseClips:function(){if(void 0!==e.Objects.AnimationCurve){var t=this.parseAnimationCurveNodes();this.parseAnimationCurves(t);var r=this.parseAnimationLayers(t);return this.parseAnimStacks(r)}},parseAnimationCurveNodes:function(){var t=e.Objects.AnimationCurveNode,r=new Map;for(var n in t){var o=t[n];if(null!==o.attrName.match(/S|R|T|DeformPercent/)){var l={id:o.id,attr:o.attrName,curves:{}};r.set(l.id,l)}}return r},parseAnimationCurves:function(r){var n=e.Objects.AnimationCurve;for(var o in n){var l={id:n[o].id,times:n[o].KeyTime.a.map(y),values:n[o].KeyValueFloat.a},c=t.get(l.id);if(void 0!==c){var h=c.parents[0].ID,d=c.parents[0].relationship;d.match(/X/)?r.get(h).curves.x=l:d.match(/Y/)?r.get(h).curves.y=l:d.match(/Z/)?r.get(h).curves.z=l:d.match(/d|DeformPercent/)&&r.has(h)&&(r.get(h).curves.morph=l)}}},parseAnimationLayers:function(n){var o=e.Objects.AnimationLayer,l=new Map;for(var c in o){var h=[],d=t.get(parseInt(c));if(void 0!==d)d.children.forEach((function(o,i){if(n.has(o.ID)){var l=n.get(o.ID);if(void 0!==l.curves.x||void 0!==l.curves.y||void 0!==l.curves.z){if(void 0===h[i])if(void 0!==(y=t.get(o.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID)){var c=e.Objects.Model[y.toString()],d={modelName:PropertyBinding.sanitizeNodeName(c.attrName),ID:c.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};r.traverse((function(e){e.ID===c.id&&(d.transform=e.matrix,e.userData.transformData&&(d.eulerOrder=e.userData.transformData.eulerOrder))})),d.transform||(d.transform=new Matrix4),"PreRotation"in c&&(d.preRotation=c.PreRotation.value),"PostRotation"in c&&(d.postRotation=c.PostRotation.value),h[i]=d}h[i]&&(h[i][l.attr]=l)}else if(void 0!==l.curves.morph){if(void 0===h[i]){var f=t.get(o.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,m=t.get(f).parents[0].ID,v=t.get(m).parents[0].ID,y=t.get(v).parents[0].ID;c=e.Objects.Model[y],d={modelName:PropertyBinding.sanitizeNodeName(c.attrName),morphName:e.Objects.Deformer[f].attrName};h[i]=d}h[i][l.attr]=l}}})),l.set(parseInt(c),h)}return l},parseAnimStacks:function(r){var n=e.Objects.AnimationStack,o={};for(var l in n){var c=t.get(parseInt(l)).children;c.length>1&&console.warn("FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var h=r.get(c[0].ID);o[l]={name:n[l].attrName,layer:h}}return o},addClip:function(e){var t=[],r=this;return e.layer.forEach((function(e){t=t.concat(r.generateTracks(e))})),new AnimationClip(e.name,-1,t)},generateTracks:function(e){var t=[],r=new Vector3,n=new Quaternion,o=new Vector3;if(e.transform&&e.transform.decompose(r,n,o),r=r.toArray(),n=(new Euler).setFromQuaternion(n,e.eulerOrder).toArray(),o=o.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var l=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");void 0!==l&&t.push(l)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var c=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);void 0!==c&&t.push(c)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var h=this.generateVectorTrack(e.modelName,e.S.curves,o,"scale");void 0!==h&&t.push(h)}if(void 0!==e.DeformPercent){var d=this.generateMorphTrack(e);void 0!==d&&t.push(d)}return t},generateVectorTrack:function(e,t,r,n){var o=this.getTimesForAllAxes(t);return new VectorKeyframeTrack(e+"."+n,o,this.getKeyframeTrackValues(o,t,r))},generateRotationTrack:function(e,t,r,n,o,l){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(_Math.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(_Math.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(_Math.degToRad));var c=this.getTimesForAllAxes(t),h=this.getKeyframeTrackValues(c,t,r);void 0!==n&&((n=n.map(_Math.degToRad)).push(l),n=(new Euler).fromArray(n),n=(new Quaternion).setFromEuler(n)),void 0!==o&&((o=o.map(_Math.degToRad)).push(l),o=(new Euler).fromArray(o),o=(new Quaternion).setFromEuler(o).inverse());for(var d=new Quaternion,f=new Euler,m=[],i=0;i<h.length;i+=3)f.set(h[i],h[i+1],h[i+2],l),d.setFromEuler(f),void 0!==n&&d.premultiply(n),void 0!==o&&d.multiply(o),d.toArray(m,i/3*4);return new QuaternionKeyframeTrack(e+".quaternion",c,m)},generateMorphTrack:function(e){var t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),o=r.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+o+"]",t.times,n)},getTimesForAllAxes:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(a,b){return a-b})).filter((function(e,t,r){return r.indexOf(e)==t}))},getKeyframeTrackValues:function(e,t,r){var n=r,o=[],l=-1,c=-1,h=-1;return e.forEach((function(time){if(t.x&&(l=t.x.times.indexOf(time)),t.y&&(c=t.y.times.indexOf(time)),t.z&&(h=t.z.times.indexOf(time)),-1!==l){var e=t.x.values[l];o.push(e),n[0]=e}else o.push(n[0]);if(-1!==c){var r=t.y.values[c];o.push(r),n[1]=r}else o.push(n[1]);if(-1!==h){var d=t.z.values[h];o.push(d),n[2]=d}else o.push(n[2])})),o},interpolateRotations:function(e){for(var i=1;i<e.values.length;i++){var t=e.values[i-1],r=e.values[i]-t,n=Math.abs(r);if(n>=180){for(var o=n/180,l=r/o,c=t+l,h=e.times[i-1],d=(e.times[i]-h)/o,f=h+d,m=[],v=[];f<e.times[i];)m.push(f),f+=d,v.push(c),c+=l;e.times=C(e.times,i,m),e.values=C(e.values,i,v)}}}},h.prototype={constructor:h,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(text){this.currentIndent=0,this.allNodes=new m,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var e=this,t=text.split(/[\r\n]+/);return t.forEach((function(line,i){var r=line.match(/^[\s\t]*;/),n=line.match(/^[\s\t]*$/);if(!r&&!n){var o=line.match("^\\t{"+e.currentIndent+"}(\\w+):(.*){",""),l=line.match("^\\t{"+e.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),c=line.match("^\\t{"+(e.currentIndent-1)+"}}");o?e.parseNodeBegin(line,o):l?e.parseNodeProperty(line,l,t[++i]):c?e.popStack():line.match(/^[^\s\t}]/)&&e.parseNodePropertyContinued(line)}})),this.allNodes},parseNodeBegin:function(line,e){var t=e[1].trim().replace(/^"/,"").replace(/"$/,""),r=e[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),n={name:t},o=this.parseNodeAttr(r),l=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(t,n):t in l?("PoseNode"===t?l.PoseNode.push(n):void 0!==l[t].id&&(l[t]={},l[t][l[t].id]=l[t]),""!==o.id&&(l[t][o.id]=n)):"number"==typeof o.id?(l[t]={},l[t][o.id]=n):"Properties70"!==t&&(l[t]="PoseNode"===t?[n]:n),"number"==typeof o.id&&(n.id=o.id),""!==o.name&&(n.attrName=o.name),""!==o.type&&(n.attrType=o.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r="",n="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:r,type:n}},parseNodeProperty:function(line,e,t){var r=e[1].replace(/^"/,"").replace(/"$/,"").trim(),n=e[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===n&&(n=t.replace(/"/g,"").replace(/,$/,"").trim());var o=this.getCurrentNode();if("Properties70"!==o.name){if("C"===r){var l=n.split(",").slice(1),c=parseInt(l[0]),h=parseInt(l[1]),d=n.split(",").slice(3);r="connections",function(a,b){for(var i=0,e=a.length,t=b.length;i<t;i++,e++)a[e]=b[i]}(n=[c,h],d=d.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===o[r]&&(o[r]=[])}"Node"===r&&(o.id=n),r in o&&Array.isArray(o[r])?o[r].push(n):"a"!==r?o[r]=n:o.a=n,this.setCurrentProp(o,r),"a"===r&&","!==n.slice(-1)&&(o.a=_(n))}else this.parseNodeSpecialProperty(line,r,n)},parseNodePropertyContinued:function(line){var e=this.getCurrentNode();e.a+=line,","!==line.slice(-1)&&(e.a=_(e.a))},parseNodeSpecialProperty:function(line,e,t){var r=t.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),n=r[0],o=r[1],l=r[2],c=r[3],h=r[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":h=parseFloat(h);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":h=_(h)}this.getPrevNode()[n]={type:o,type2:l,flag:c,value:h},this.setCurrentProp(this.getPrevNode(),n)}},d.prototype={constructor:d,parse:function(e){var t=new f(e);t.skip(23);var r=t.getUint32();console.log("FBXLoader: FBX binary version: "+r);for(var n=new m;!this.endOfContent(t);){var o=this.parseNode(t,r);null!==o&&n.add(o.name,o)}return n},endOfContent:function(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()},parseNode:function(e,t){var r={},n=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32(),l=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),c=e.getString(l);if(0===n)return null;for(var h=[],i=0;i<o;i++)h.push(this.parseProperty(e));var d=h.length>0?h[0]:"",f=h.length>1?h[1]:"",m=h.length>2?h[2]:"";for(r.singleProperty=1===o&&e.getOffset()===n;n>e.getOffset();){var v=this.parseNode(e,t);null!==v&&this.parseSubNode(c,r,v)}return r.propertyList=h,"number"==typeof d&&(r.id=d),""!==f&&(r.attrName=f),""!==m&&(r.attrType=m),""!==c&&(r.name=c),r},parseSubNode:function(e,t,r){if(!0===r.singleProperty){var n=r.propertyList[0];Array.isArray(n)?(t[r.name]=r,r.a=n):t[r.name]=n}else if("Connections"===e&&"C"===r.name){var o=[];r.propertyList.forEach((function(e,i){0!==i&&o.push(e)})),void 0===t.connections&&(t.connections=[]),t.connections.push(o)}else if("Properties70"===r.name){Object.keys(r).forEach((function(e){t[e]=r[e]}))}else if("Properties70"===e&&"P"===r.name){var l,c=r.propertyList[0],h=r.propertyList[1],d=r.propertyList[2],f=r.propertyList[3];0===c.indexOf("Lcl ")&&(c=c.replace("Lcl ","Lcl_")),0===h.indexOf("Lcl ")&&(h=h.replace("Lcl ","Lcl_")),l="Color"===h||"ColorRGB"===h||"Vector"===h||"Vector3D"===h||0===h.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[c]={type:h,type2:d,flag:f,value:l}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)},parseProperty:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var r=e.getUint32();return e.getArrayBuffer(r);case"S":r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var n=e.getUint32(),o=e.getUint32(),l=e.getUint32();if(0===o)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}"undefined"==typeof Zlib&&console.error("FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var c=new f(new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(l))).decompress().buffer);switch(t){case"b":case"c":return c.getBooleanArray(n);case"d":return c.getFloat64Array(n);case"f":return c.getFloat32Array(n);case"i":return c.getInt32Array(n);case"l":return c.getInt64Array(n)}default:throw new Error("FBXLoader: Unknown property type "+t)}}},f.prototype={constructor:f,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getBoolean());return a},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getInt32());return a},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e},getInt64Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getInt64());return a},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getFloat32());return a},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var a=[],i=0;i<e;i++)a.push(this.getFloat64());return a},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getString:function(e){for(var a=[],i=0;i<e;i++)a[i]=this.getUint8();var t=a.indexOf(0);return t>=0&&(a=a.slice(0,t)),LoaderUtils.decodeText(new Uint8Array(a))}},m.prototype={constructor:m,add:function(e,t){this[e]=t}};var x=[];function w(e,t,r,n){var o;switch(n.mappingType){case"ByPolygonVertex":o=e;break;case"ByPolygon":o=t;break;case"ByVertice":o=r;break;case"AllSame":o=n.indices[0];break;default:console.warn("FBXLoader: unknown attribute mapping type "+n.mappingType)}"IndexToDirect"===n.referenceType&&(o=n.indices[o]);var l=o*n.dataSize,c=l+n.dataSize;return function(a,b,e,t){for(var i=e,r=0;i<t;i++,r++)a[r]=b[i];return a}(x,n.buffer,l,c)}var M=new Euler,S=new Vector3;function A(e){var t,r=new Matrix4,n=new Matrix4,o=new Matrix4,l=new Matrix4,c=new Matrix4,h=new Matrix4,d=new Matrix4,f=new Matrix4,m=new Matrix4,v=new Matrix4,y=new Matrix4,x=e.inheritType?e.inheritType:0;(e.translation&&r.setPosition(S.fromArray(e.translation)),e.preRotation)&&((t=e.preRotation.map(_Math.degToRad)).push(e.eulerOrder),n.makeRotationFromEuler(M.fromArray(t)));e.rotation&&((t=e.rotation.map(_Math.degToRad)).push(e.eulerOrder),o.makeRotationFromEuler(M.fromArray(t)));e.postRotation&&((t=e.postRotation.map(_Math.degToRad)).push(e.eulerOrder),l.makeRotationFromEuler(M.fromArray(t)));e.scale&&c.scale(S.fromArray(e.scale)),e.scalingOffset&&d.setPosition(S.fromArray(e.scalingOffset)),e.scalingPivot&&h.setPosition(S.fromArray(e.scalingPivot)),e.rotationOffset&&f.setPosition(S.fromArray(e.rotationOffset)),e.rotationPivot&&m.setPosition(S.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(v=e.parentMatrixWorld);var w=n.multiply(o).multiply(l),A=new Matrix4;v.extractRotation(A);var T,_,L,C,N=new Matrix4;if(N.copyPosition(v),L=N.getInverse(N).multiply(v),_=A.getInverse(A).multiply(L),T=c,0===x)C=A.multiply(w).multiply(_).multiply(T);else if(1===x)C=A.multiply(_).multiply(w).multiply(T);else{var P=(new Matrix4).copy(c),E=_.multiply(P.getInverse(P));C=A.multiply(w).multiply(E).multiply(T)}var D=r.multiply(f).multiply(m).multiply(n).multiply(o).multiply(l).multiply(m.getInverse(m)).multiply(d).multiply(h).multiply(c).multiply(h.getInverse(h)),F=(new Matrix4).copyPosition(D),R=v.multiply(F);return y.copyPosition(R),D=y.multiply(C)}function T(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function _(e){return e.split(",").map((function(e){return parseFloat(e)}))}function L(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=e.byteLength),LoaderUtils.decodeText(new Uint8Array(e,t,r))}function C(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}return n}(),GCodeLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.splitLayer=!1};GCodeLoader.prototype.load=function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text))}),r,n)},GCodeLoader.prototype.setPath=function(e){return this.path=e,this},GCodeLoader.prototype.parse=function(data){var e={x:0,y:0,z:0,e:0,f:0,extruding:!1,relative:!1},t=[],r=void 0,n=new LineBasicMaterial({color:16711680});n.name="path";var o=new LineBasicMaterial({color:65280});function l(line){r={vertex:[],pathVertex:[],z:line.z},t.push(r)}function c(t,r){return e.relative?r:r-t}function h(t,r){return e.relative?t+r:r}o.name="extruded";for(var d,f,m=data.replace(/;.+/g,"").split("\n"),i=0;i<m.length;i++){var v=m[i].split(" "),y=v[0].toUpperCase(),x={};if(v.splice(1).forEach((function(e){if(void 0!==e[0]){var t=e[0].toLowerCase(),r=parseFloat(e.substring(1));x[t]=r}})),"G0"===y||"G1"===y){var line={x:void 0!==x.x?h(e.x,x.x):e.x,y:void 0!==x.y?h(e.y,x.y):e.y,z:void 0!==x.z?h(e.z,x.z):e.z,e:void 0!==x.e?h(e.e,x.e):e.e,f:void 0!==x.f?h(e.f,x.f):e.f};c(e.e,line.e)>0&&(line.extruding=c(e.e,line.e)>0,null!=r&&line.z==r.z||l(line)),d=e,f=line,void 0===r&&l(d),line.extruding?(r.vertex.push(d.x,d.y,d.z),r.vertex.push(f.x,f.y,f.z)):(r.pathVertex.push(d.x,d.y,d.z),r.pathVertex.push(f.x,f.y,f.z)),e=line}else if("G2"===y||"G3"===y)console.warn("GCodeLoader: Arc command not supported");else if("G90"===y)e.relative=!1;else if("G91"===y)e.relative=!0;else if("G92"===y){(line=e).x=void 0!==x.x?x.x:line.x,line.y=void 0!==x.y?x.y:line.y,line.z=void 0!==x.z?x.z:line.z,line.e=void 0!==x.e?x.e:line.e,e=line}else console.warn("GCodeLoader: Command not supported:"+y)}function w(e,t){var r=new BufferGeometry;r.addAttribute("position",new Float32BufferAttribute(e,3));var l=new LineSegments(r,t?o:n);l.name="layer"+i,object.add(l)}var object=new Group;if(object.name="gcode",this.splitLayer)for(i=0;i<t.length;i++){w((A=t[i]).vertex,!0),w(A.pathVertex,!1)}else{var M=[],S=[];for(i=0;i<t.length;i++){var A=t[i];M=M.concat(A.vertex),S=S.concat(A.pathVertex)}w(M,!0),w(S,!1)}return object.quaternion.setFromEuler(new Euler(-Math.PI/2,0,0)),object};var BufferGeometryUtils={computeTangents:function(e){var t=e.index,r=e.attributes;if(null!==t&&void 0!==r.position&&void 0!==r.normal&&void 0!==r.uv){var n=t.array,o=r.position.array,l=r.normal.array,c=r.uv.array,h=o.length/3;void 0===r.tangent&&e.addAttribute("tangent",new BufferAttribute(new Float32Array(4*h),4));for(var d=r.tangent.array,f=[],m=[],i=0;i<h;i++)f[i]=new Vector3,m[i]=new Vector3;var v=new Vector3,y=new Vector3,x=new Vector3,w=new Vector2,M=new Vector2,S=new Vector2,A=new Vector3,T=new Vector3,_=e.groups;0===_.length&&(_=[{start:0,count:n.length}]);i=0;for(var L=_.length;i<L;++i)for(var C=U=(I=_[i]).start,N=U+I.count;C<N;C+=3)V(n[C+0],n[C+1],n[C+2]);var P,E,D,F=new Vector3,R=new Vector3,O=new Vector3,B=new Vector3;for(i=0,L=_.length;i<L;++i){var I,U;for(C=U=(I=_[i]).start,N=U+I.count;C<N;C+=3)k(n[C+0]),k(n[C+1]),k(n[C+2])}}else console.warn("BufferGeometry: Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");function V(a,b,e){v.fromArray(o,3*a),y.fromArray(o,3*b),x.fromArray(o,3*e),w.fromArray(c,2*a),M.fromArray(c,2*b),S.fromArray(c,2*e);var t=y.x-v.x,r=x.x-v.x,n=y.y-v.y,l=x.y-v.y,h=y.z-v.z,d=x.z-v.z,_=M.x-w.x,L=S.x-w.x,C=M.y-w.y,N=S.y-w.y,P=1/(_*N-L*C);A.set((N*t-C*r)*P,(N*n-C*l)*P,(N*h-C*d)*P),T.set((_*r-L*t)*P,(_*l-L*n)*P,(_*d-L*h)*P),f[a].add(A),f[b].add(A),f[e].add(A),m[a].add(T),m[b].add(T),m[e].add(T)}function k(e){O.fromArray(l,3*e),B.copy(O),E=f[e],F.copy(E),F.sub(O.multiplyScalar(O.dot(E))).normalize(),R.crossVectors(B,E),D=R.dot(m[e]),P=D<0?-1:1,d[4*e]=F.x,d[4*e+1]=F.y,d[4*e+2]=F.z,d[4*e+3]=P}},mergeBufferGeometries:function(e,t){for(var r=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),o=new Set(Object.keys(e[0].morphAttributes)),l={},c={},h=new BufferGeometry,d=0,i=0;i<e.length;++i){var f=e[i];if(r!==(null!==f.index))return null;for(var m in f.attributes){if(!n.has(m))return null;void 0===l[m]&&(l[m]=[]),l[m].push(f.attributes[m])}for(var m in f.morphAttributes){if(!o.has(m))return null;void 0===c[m]&&(c[m]=[]),c[m].push(f.morphAttributes[m])}if(h.userData.mergedUserData=h.userData.mergedUserData||[],h.userData.mergedUserData.push(f.userData),t){var v;if(r)v=f.index.count;else{if(void 0===f.attributes.position)return null;v=f.attributes.position.count}h.addGroup(d,v,i),d+=v}}if(r){var y=0,x=[];for(i=0;i<e.length;++i){for(var w=e[i].index,M=0;M<w.count;++M)x.push(w.getX(M)+y);y+=e[i].attributes.position.count}h.setIndex(x)}for(var m in l){var S=this.mergeBufferAttributes(l[m]);if(!S)return null;h.addAttribute(m,S)}for(var m in c){var A=c[m][0].length;if(0===A)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[m]=[];for(i=0;i<A;++i){var T=[];for(M=0;M<c[m].length;++M)T.push(c[m][M][i]);var _=this.mergeBufferAttributes(T);if(!_)return null;h.morphAttributes[m].push(_)}}return h},mergeBufferAttributes:function(e){for(var t,r,n,o=0,i=0;i<e.length;++i){var l=e[i];if(l.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=l.array.constructor),t!==l.array.constructor)return null;if(void 0===r&&(r=l.itemSize),r!==l.itemSize)return null;if(void 0===n&&(n=l.normalized),n!==l.normalized)return null;o+=l.array.length}var c=new t(o),h=0;for(i=0;i<e.length;++i)c.set(e[i].array,h),h+=e[i].array.length;return new BufferAttribute(c,r,n)},interleaveAttributes:function(e){for(var t,r=0,n=0,i=0,o=e.length;i<o;++i){var l=e[i];if(void 0===t&&(t=l.array.constructor),t!==l.array.constructor)return console.warn("AttributeBuffers of different types cannot be interleaved"),null;r+=l.array.length,n+=l.itemSize}var c=new InterleavedBuffer(new t(r),n),h=0,d=[],f=["getX","getY","getZ","getW"],m=["setX","setY","setZ","setW"],v=0;for(o=e.length;v<o;v++){var y=(l=e[v]).itemSize,x=l.count,w=new InterleavedBufferAttribute(c,y,h,l.normalized);d.push(w),h+=y;for(var M=0;M<x;M++)for(var S=0;S<y;S++)w[m[S]](M,l[f[S]](M))}return d},estimateBytesUsed:function(e){var t=0;for(var r in e.attributes){var n=e.getAttribute(r);t+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}var o=e.getIndex();return t+=o?o.count*o.itemSize*o.array.BYTES_PER_ELEMENT:0},mergeVertices:function(e,t){void 0===t&&(t=1e-4),t=Math.max(t,Number.EPSILON);for(var r={},n=e.getIndex(),o=e.getAttribute("position"),l=n?n.count:o.count,c=0,h=Object.keys(e.attributes),d={},f={},m=[],v=["getX","getY","getZ","getW"],y=0,x=h.length;y<x;y++){d[L=h[y]]=[],(E=e.morphAttributes[L])&&(f[L]=new Array(E.length).fill().map((function(){return[]})))}for(var w=Math.log10(1/t),M=Math.pow(10,w),i=0;i<l;i++){for(var S=n?n.getX(i):i,A="",T=0,_=h.length;T<_;T++)for(var L=h[T],C=(P=e.getAttribute(L)).itemSize,N=0;N<C;N++)A+=~~(P[v[N]](S)*M)+",";if(A in r)m.push(r[A]);else{for(T=0,_=h.length;T<_;T++){L=h[T];var P=e.getAttribute(L),E=e.morphAttributes[L],D=(C=P.itemSize,d[L]),F=f[L];for(N=0;N<C;N++){var R=v[N];if(D.push(P[R](S)),E)for(var O=0,B=E.length;O<B;O++)F[O].push(E[O][R](S))}}r[A]=c,m.push(c),c++}}var I=e.clone();for(i=0,_=h.length;i<_;i++){L=h[i];var U=e.getAttribute(L),V=new U.array.constructor(d[L]);if(U.isInterleavedBufferAttribute?P=new BufferAttribute(V,U.itemSize,U.itemSize):(P=e.getAttribute(L).clone()).setArray(V),I.addAttribute(L,P),L in f)for(T=0;T<f[L].length;T++){var k=e.morphAttributes[L][T].clone();k.setArray(new k.array.constructor(f[L][T])),I.morphAttributes[L][T]=k}}var G=Uint8Array;m.length>=Math.pow(2,8)&&(G=Uint16Array),m.length>=Math.pow(2,16)&&(G=Uint32Array);var z=new G(m);m=null;return null===n?m=new BufferAttribute(z,1):(m=e.getIndex().clone()).setArray(z),I.setIndex(m),I}},GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.dracoLoader=null}function t(){var e={};return{get:function(t){return e[t]},add:function(t,object){e[t]=object},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,n){var o,l=this;o=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:LoaderUtils.extractUrlBase(e),l.manager.itemStart(e);var c=function(t){n?n(t):console.error(t),l.manager.itemError(e),l.manager.itemEnd(e)},h=new FileLoader(l.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.load(e,(function(data){try{l.parse(data,o,(function(r){t(r),l.manager.itemEnd(e)}),c)}catch(e){c(e)}}),r,c)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},parse:function(data,path,e,t){var content,h={};if("string"==typeof data)content=data;else if(LoaderUtils.decodeText(new Uint8Array(data,0,4))===c){try{h[r.KHR_BINARY_GLTF]=new f(data)}catch(e){return void(t&&t(e))}content=h[r.KHR_BINARY_GLTF].content}else content=LoaderUtils.decodeText(new Uint8Array(data));var d=JSON.parse(content);if(void 0===d.asset||d.asset.version[0]<2)t&&t(new Error("GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(d.extensionsUsed)for(var i=0;i<d.extensionsUsed.length;++i){var x=d.extensionsUsed[i],w=d.extensionsRequired||[];switch(x){case r.KHR_LIGHTS_PUNCTUAL:h[x]=new o(d);break;case r.KHR_MATERIALS_UNLIT:h[x]=new l(d);break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:h[x]=new y(d);break;case r.KHR_DRACO_MESH_COMPRESSION:h[x]=new m(d,this.dracoLoader);break;case r.MSFT_TEXTURE_DDS:h[r.MSFT_TEXTURE_DDS]=new n;break;case r.KHR_TEXTURE_TRANSFORM:h[r.KHR_TEXTURE_TRANSFORM]=new v(d);break;default:w.indexOf(x)>=0&&console.warn('GLTFLoader: Unknown extension "'+x+'".')}}var M=new Y(d,h,{path:path||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});M.parse((function(t,r,n,o,l){var c={scene:t,scenes:r,cameras:n,animations:o,asset:l.asset,parser:M,userData:{}};k(h,c,l),e(c)}),t)}}};var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function n(){if(!DDSLoader)throw new Error("GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=r.MSFT_TEXTURE_DDS,this.ddsLoader=new DDSLoader}function o(e){this.name=r.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[r.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function l(e){this.name=r.KHR_MATERIALS_UNLIT}o.prototype.loadLight=function(e){var t,r=this.lightDefs[e],n=new Color(16777215);void 0!==r.color&&n.fromArray(r.color);var o=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new DirectionalLight(n)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new PointLight(n)).distance=o;break;case"spot":(t=new SpotLight(n)).distance=o,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},l.prototype.getMaterialType=function(e){return MeshBasicMaterial},l.prototype.extendParams=function(e,t,r){var n=[];e.color=new Color(1,1,1),e.opacity=1;var o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){var l=o.baseColorFactor;e.color.fromArray(l),e.opacity=l[3]}void 0!==o.baseColorTexture&&n.push(r.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(n)};var c="glTF",h=12,d={JSON:1313821514,BIN:5130562};function f(data){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var e=new DataView(data,0,h);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(data.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==c)throw new Error("GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var t=new DataView(data,h),n=0;n<t.byteLength;){var o=t.getUint32(n,!0);n+=4;var l=t.getUint32(n,!0);if(n+=4,l===d.JSON){var f=new Uint8Array(data,h+n,o);this.content=LoaderUtils.decodeText(f)}else if(l===d.BIN){var m=h+n;this.body=data.slice(m,m+o)}n+=o}if(null===this.content)throw new Error("GLTFLoader: JSON content not found.")}function m(e,t){if(!t)throw new Error("GLTFLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,DRACOLoader.getDecoderModule()}function v(e){this.name=r.KHR_TEXTURE_TRANSFORM}function y(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return ShaderMaterial},extendParams:function(e,t,r){var n=t.extensions[this.name],o=ShaderLib.standard,l=UniformsUtils.clone(o.uniforms),c=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),h=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),d=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),f=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),m=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),v=o.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",c).replace("#include <metalnessmap_pars_fragment>",h).replace("#include <roughnessmap_fragment>",d).replace("#include <metalnessmap_fragment>",f).replace("#include <lights_physical_fragment>",m);delete l.roughness,delete l.metalness,delete l.roughnessMap,delete l.metalnessMap,l.specular={value:(new Color).setHex(1118481)},l.glossiness={value:.5},l.specularMap={value:null},l.glossinessMap={value:null},e.vertexShader=o.vertexShader,e.fragmentShader=v,e.uniforms=l,e.defines={STANDARD:""},e.color=new Color(1,1,1),e.opacity=1;var y=[];if(Array.isArray(n.diffuseFactor)){var x=n.diffuseFactor;e.color.fromArray(x),e.opacity=x[3]}if(void 0!==n.diffuseTexture&&y.push(r.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var w=n.specularGlossinessTexture;y.push(r.assignTexture(e,"glossinessMap",w)),y.push(r.assignTexture(e,"specularMap",w))}return Promise.all(y)},createMaterial:function(e){var t=new ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(source){var e=source.clone();e.isGLTFSpecularGlossinessMaterial=!0;for(var t=this.specularGlossinessParams,i=0,r=t.length;i<r;i++)e[t[i]]=source[t[i]];return e},refreshUniforms:function(e,t,r,n,o,l){if(!0===o.isGLTFSpecularGlossinessMaterial){var c,h=o.uniforms,d=o.defines;h.opacity.value=o.opacity,h.diffuse.value.copy(o.color),h.emissive.value.copy(o.emissive).multiplyScalar(o.emissiveIntensity),h.map.value=o.map,h.specularMap.value=o.specularMap,h.alphaMap.value=o.alphaMap,h.lightMap.value=o.lightMap,h.lightMapIntensity.value=o.lightMapIntensity,h.aoMap.value=o.aoMap,h.aoMapIntensity.value=o.aoMapIntensity,o.map?c=o.map:o.specularMap?c=o.specularMap:o.displacementMap?c=o.displacementMap:o.normalMap?c=o.normalMap:o.bumpMap?c=o.bumpMap:o.glossinessMap?c=o.glossinessMap:o.alphaMap?c=o.alphaMap:o.emissiveMap&&(c=o.emissiveMap),void 0!==c&&(c.isWebGLRenderTarget&&(c=c.texture),!0===c.matrixAutoUpdate&&c.updateMatrix(),h.uvTransform.value.copy(c.matrix)),o.envMap&&(h.envMap.value=o.envMap,h.envMapIntensity.value=o.envMapIntensity,h.flipEnvMap.value=o.envMap.isCubeTexture?-1:1,h.reflectivity.value=o.reflectivity,h.refractionRatio.value=o.refractionRatio,h.maxMipLevel.value=e.properties.get(o.envMap).__maxMipLevel),h.specular.value.copy(o.specular),h.glossiness.value=o.glossiness,h.glossinessMap.value=o.glossinessMap,h.emissiveMap.value=o.emissiveMap,h.bumpMap.value=o.bumpMap,h.normalMap.value=o.normalMap,h.displacementMap.value=o.displacementMap,h.displacementScale.value=o.displacementScale,h.displacementBias.value=o.displacementBias,null!==h.glossinessMap.value&&void 0===d.USE_GLOSSINESSMAP&&(d.USE_GLOSSINESSMAP="",d.USE_ROUGHNESSMAP=""),null===h.glossinessMap.value&&void 0!==d.USE_GLOSSINESSMAP&&(delete d.USE_GLOSSINESSMAP,delete d.USE_ROUGHNESSMAP)}}}}function x(e,t,r,n){Interpolant.call(this,e,t,r,n)}m.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,o=e.extensions[this.name].bufferView,l=e.extensions[this.name].attributes,c={},h={},d={};for(var f in l)f in D&&(c[D[f]]=l[f]);for(f in e.attributes)if(void 0!==D[f]&&void 0!==l[f]){var m=r.accessors[e.attributes[f]],v=C[m.componentType];d[D[f]]=v,h[D[f]]=!0===m.normalized}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(var r in e.attributes){var n=e.attributes[r],o=h[r];void 0!==o&&(n.normalized=o)}t(e)}),c,d)}))}))},v.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},x.prototype=Object.create(Interpolant.prototype),x.prototype.constructor=x,x.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,o=e*n*3+n,i=0;i!==n;i++)t[i]=r[o+i];return t},x.prototype.beforeStart_=x.prototype.copySampleValue_,x.prototype.afterEnd_=x.prototype.copySampleValue_,x.prototype.interpolate_=function(e,t,r,n){for(var o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,h=2*c,d=3*c,td=n-t,p=(r-t)/td,f=p*p,m=f*p,v=e*d,y=v-d,x=-2*m+3*f,w=m-f,M=1-x,S=w-f+p,i=0;i!==c;i++){var A=l[y+i+c],T=l[y+i+h]*td,_=l[v+i+c],L=l[v+i]*td;o[i]=M*A+S*T+x*_+w*L}return o};var w=0,M=1,S=2,A=3,T=4,_=5,L=6,C={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},N={9728:NearestFilter,9729:LinearFilter,9984:NearestMipMapNearestFilter,9985:LinearMipMapNearestFilter,9986:NearestMipMapLinearFilter,9987:LinearMipMapLinearFilter},P={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},E={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},D={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},F={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},R={CUBICSPLINE:InterpolateSmooth,LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},O="OPAQUE",B="MASK",I="BLEND",U={"image/png":RGBAFormat,"image/jpeg":RGBFormat};function V(e,path){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:path+e}function k(e,object,t){for(var r in t.extensions)void 0===e[r]&&(object.userData.gltfExtensions=object.userData.gltfExtensions||{},object.userData.gltfExtensions[r]=t.extensions[r])}function G(object,e){void 0!==e.extras&&("object"==typeof e.extras?object.userData=e.extras:console.warn("GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function z(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var i=0,r=t.weights.length;i<r;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){var n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(i=0,r=n.length;i<r;i++)e.morphTargetDictionary[n[i]]=i}else console.warn("GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function j(a,b){if(Object.keys(a).length!==Object.keys(b).length)return!1;for(var e in a)if(a[e]!==b[e])return!1;return!0}function W(e){var t=e.extensions&&e.extensions[r.KHR_DRACO_MESH_COMPRESSION];return t?"draco:"+t.bufferView+":"+t.indices+":"+H(t.attributes):e.indices+":"+H(e.attributes)+":"+e.mode}function H(e){for(var t="",r=Object.keys(e).sort(),i=0,n=r.length;i<n;i++)t+=r[i]+":"+e[r[i]]+";";return t}function X(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,r=e.itemSize,n=e.array.slice(0,t*r),i=0,o=0;i<t;++i)n[o++]=e.getX(i),r>=2&&(n[o++]=e.getY(i)),r>=3&&(n[o++]=e.getZ(i)),r>=4&&(n[o++]=e.getW(i));return new BufferAttribute(n,r,e.normalized)}return e.clone()}function Y(e,r,n){this.json=e||{},this.extensions=r||{},this.options=n||{},this.cache=new t,this.primitiveCache={},this.multiplePrimitivesCache={},this.multiPassGeometryCache={},this.textureLoader=new TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function Q(e,t,r){var n=t.attributes,o=[];function l(t,n){return r.getDependency("accessor",t).then((function(t){e.addAttribute(n,t)}))}for(var c in n){var h=D[c];h&&(h in e.attributes||o.push(l(n[c],h)))}if(void 0!==t.indices&&!e.index){var d=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(d)}return G(e,t),Promise.all(o).then((function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,o=!1,i=0,l=t.length;i<l;i++){if(void 0!==(d=t[i]).POSITION&&(n=!0),void 0!==d.NORMAL&&(o=!0),n&&o)break}if(!n&&!o)return Promise.resolve(e);var c=[],h=[];for(i=0,l=t.length;i<l;i++){var d=t[i];if(n){var f=void 0!==d.POSITION?r.getDependency("accessor",d.POSITION).then((function(e){return X(e)})):e.attributes.position;c.push(f)}if(o){f=void 0!==d.NORMAL?r.getDependency("accessor",d.NORMAL).then((function(e){return X(e)})):e.attributes.normal;h.push(f)}}return Promise.all([Promise.all(c),Promise.all(h)]).then((function(r){for(var l=r[0],c=r[1],i=0,h=t.length;i<h;i++){var d=t[i],f="morphTarget"+i;if(n&&void 0!==d.POSITION){var m=l[i];m.name=f;for(var v=e.attributes.position,y=0,x=m.count;y<x;y++)m.setXYZ(y,m.getX(y)+v.getX(y),m.getY(y)+v.getY(y),m.getZ(y)+v.getZ(y))}if(o&&void 0!==d.NORMAL){var w=c[i];w.name=f;var M=e.attributes.normal;for(y=0,x=w.count;y<x;y++)w.setXYZ(y,w.getX(y)+M.getX(y),w.getY(y)+M.getY(y),w.getZ(y)+M.getZ(y))}}return n&&(e.morphAttributes.position=l),o&&(e.morphAttributes.normal=c),e}))}(e,t.targets,r):e}))}return Y.prototype.parse=function(e,t){var r=this.json;this.cache.removeAll(),this.markDefs(),this.getMultiDependencies(["scene","animation","camera"]).then((function(t){var n=t.scenes||[],o=n[r.scene||0],l=t.animations||[],c=t.cameras||[];e(o,n,c,l,r)})).catch(t)},Y.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n={},o={},l=0,c=t.length;l<c;l++)for(var h=t[l].joints,i=0,d=h.length;i<d;i++)e[h[i]].isBone=!0;for(var f=0,m=e.length;f<m;f++){var v=e[f];void 0!==v.mesh&&(void 0===n[v.mesh]&&(n[v.mesh]=o[v.mesh]=0),n[v.mesh]++,void 0!==v.skin&&(r[v.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=o},Y.prototype.getDependency=function(e,t){var n=e+":"+t,o=this.cache.get(n);if(!o){switch(e){case"scene":o=this.loadScene(t);break;case"node":o=this.loadNode(t);break;case"mesh":o=this.loadMesh(t);break;case"accessor":o=this.loadAccessor(t);break;case"bufferView":o=this.loadBufferView(t);break;case"buffer":o=this.loadBuffer(t);break;case"material":o=this.loadMaterial(t);break;case"texture":o=this.loadTexture(t);break;case"skin":o=this.loadSkin(t);break;case"animation":o=this.loadAnimation(t);break;case"camera":o=this.loadCamera(t);break;case"light":o=this.extensions[r.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,o)}return o},Y.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,defs=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(defs.map((function(t,n){return r.getDependency(e,n)}))),this.cache.add(e,t)}return t},Y.prototype.getMultiDependencies=function(e){for(var t={},r=[],i=0,n=e.length;i<n;i++){var o=e[i],l=this.getDependencies(o);l=l.then(function(e,r){t[e]=r}.bind(this,o+("mesh"===o?"es":"s"))),r.push(l)}return Promise.all(r).then((function(){return t}))},Y.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var o=this.options;return new Promise((function(e,r){n.load(V(t.uri,o.path),e,void 0,(function(){r(new Error('GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},Y.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)}))},Y.prototype.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(e){var o,l=e[0],c=E[n.type],h=C[n.componentType],d=h.BYTES_PER_ELEMENT,f=d*c,m=n.byteOffset||0,v=void 0!==n.bufferView?r.bufferViews[n.bufferView].byteStride:void 0,y=!0===n.normalized;if(v&&v!==f){var x="InterleavedBuffer:"+n.bufferView+":"+n.componentType,w=t.cache.get(x);w||(w=new InterleavedBuffer(new h(l),v/d),t.cache.add(x,w)),o=new InterleavedBufferAttribute(w,c,m/d,y)}else o=new BufferAttribute(null===l?new h(n.count*c):new h(l,m,n.count*c),c,y);if(void 0!==n.sparse){var M=E.SCALAR,S=C[n.sparse.indices.componentType],A=n.sparse.indices.byteOffset||0,T=n.sparse.values.byteOffset||0,_=new S(e[1],A,n.sparse.count*M),L=new h(e[2],T,n.sparse.count*c);null!==l&&o.setArray(o.array.slice());for(var i=0,N=_.length;i<N;i++){var P=_[i];if(o.setX(P,L[i*c]),c>=2&&o.setY(P,L[i*c+1]),c>=3&&o.setZ(P,L[i*c+2]),c>=4&&o.setW(P,L[i*c+3]),c>=5)throw new Error("GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o}))},Y.prototype.loadTexture=function(e){var source,t=this,n=this.json,o=this.options,l=this.textureLoader,c=window.URL||window.webkitURL,h=n.textures[e],d=h.extensions||{},f=(source=d[r.MSFT_TEXTURE_DDS]?n.images[d[r.MSFT_TEXTURE_DDS].source]:n.images[h.source]).uri,m=!1;return void 0!==source.bufferView&&(f=t.getDependency("bufferView",source.bufferView).then((function(e){m=!0;var t=new Blob([e],{type:source.mimeType});return f=c.createObjectURL(t)}))),Promise.resolve(f).then((function(e){var n=Loader$1.Handlers.get(e);return n||(n=d[r.MSFT_TEXTURE_DDS]?t.extensions[r.MSFT_TEXTURE_DDS].ddsLoader:l),new Promise((function(t,r){n.load(V(e,o.path),t,void 0,r)}))})).then((function(e){!0===m&&c.revokeObjectURL(f),e.flipY=!1,void 0!==h.name&&(e.name=h.name),source.mimeType in U&&(e.format=U[source.mimeType]);var t=(n.samplers||{})[h.sampler]||{};return e.magFilter=N[t.magFilter]||LinearFilter,e.minFilter=N[t.minFilter]||LinearMipMapLinearFilter,e.wrapS=P[t.wrapS]||RepeatWrapping,e.wrapT=P[t.wrapT]||RepeatWrapping,e}))},Y.prototype.assignTexture=function(e,t,n){var o=this;return this.getDependency("texture",n.index).then((function(l){switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":l.format=RGBFormat}if(o.extensions[r.KHR_TEXTURE_TRANSFORM]){var c=void 0!==n.extensions?n.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;c&&(l=o.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(l,c))}e[t]=l}))},Y.prototype.loadMaterial=function(e){var t,n=this.json,o=this.extensions,l=n.materials[e],c={},h=l.extensions||{},d=[];if(h[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var f=o[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=f.getMaterialType(l),d.push(f.extendParams(c,l,this))}else if(h[r.KHR_MATERIALS_UNLIT]){var m=o[r.KHR_MATERIALS_UNLIT];t=m.getMaterialType(l),d.push(m.extendParams(c,l,this))}else{t=MeshStandardMaterial;var v=l.pbrMetallicRoughness||{};if(c.color=new Color(1,1,1),c.opacity=1,Array.isArray(v.baseColorFactor)){var y=v.baseColorFactor;c.color.fromArray(y),c.opacity=y[3]}void 0!==v.baseColorTexture&&d.push(this.assignTexture(c,"map",v.baseColorTexture)),c.metalness=void 0!==v.metallicFactor?v.metallicFactor:1,c.roughness=void 0!==v.roughnessFactor?v.roughnessFactor:1,void 0!==v.metallicRoughnessTexture&&(d.push(this.assignTexture(c,"metalnessMap",v.metallicRoughnessTexture)),d.push(this.assignTexture(c,"roughnessMap",v.metallicRoughnessTexture)))}!0===l.doubleSided&&(c.side=DoubleSide);var x=l.alphaMode||O;return x===I?c.transparent=!0:(c.transparent=!1,x===B&&(c.alphaTest=void 0!==l.alphaCutoff?l.alphaCutoff:.5)),void 0!==l.normalTexture&&t!==MeshBasicMaterial&&(d.push(this.assignTexture(c,"normalMap",l.normalTexture)),c.normalScale=new Vector2(1,1),void 0!==l.normalTexture.scale&&c.normalScale.set(l.normalTexture.scale,l.normalTexture.scale)),void 0!==l.occlusionTexture&&t!==MeshBasicMaterial&&(d.push(this.assignTexture(c,"aoMap",l.occlusionTexture)),void 0!==l.occlusionTexture.strength&&(c.aoMapIntensity=l.occlusionTexture.strength)),void 0!==l.emissiveFactor&&t!==MeshBasicMaterial&&(c.emissive=(new Color).fromArray(l.emissiveFactor)),void 0!==l.emissiveTexture&&t!==MeshBasicMaterial&&d.push(this.assignTexture(c,"emissiveMap",l.emissiveTexture)),Promise.all(d).then((function(){var e;return e=t===ShaderMaterial?o[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(c):new t(c),void 0!==l.name&&(e.name=l.name),e.map&&(e.map.encoding=sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=sRGBEncoding),e.specularMap&&(e.specularMap.encoding=sRGBEncoding),G(e,l),l.extensions&&k(o,e,l),e}))},Y.prototype.loadGeometries=function(e){var t,n=this,o=this.extensions,l=this.primitiveCache,c=function(e){if(e.length<2)return!1;var t=e[0],n=t.targets||[];if(void 0===t.indices)return!1;for(var i=1,o=e.length;i<o;i++){var l=e[i];if(t.mode!==l.mode)return!1;if(void 0===l.indices)return!1;if(l.extensions&&l.extensions[r.KHR_DRACO_MESH_COMPRESSION])return!1;if(!j(t.attributes,l.attributes))return!1;var c=l.targets||[];if(n.length!==c.length)return!1;for(var h=0,d=n.length;h<d;h++)if(!j(n[h],c[h]))return!1}return!0}(e);function h(e){return o[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,n).then((function(t){return Q(t,e,n)}))}c&&(t=e,e=[e[0]]);for(var d=[],i=0,f=e.length;i<f;i++){var m,v=e[i],y=W(v),x=l[y];if(x)d.push(x.promise);else m=v.extensions&&v.extensions[r.KHR_DRACO_MESH_COMPRESSION]?h(v):Q(new BufferGeometry,v,n),l[y]={primitive:v,promise:m},d.push(m)}return Promise.all(d).then((function(r){if(c){var o=r[0],l=n.multiPassGeometryCache,h=function(e,t){for(var r=e.uuid,i=0,n=t.length;i<n;i++)r+=i+W(t[i]);return r}(o,t);if(null!==(y=l[h]))return[y.geometry];var d=new BufferGeometry;for(var f in d.name=o.name,d.userData=o.userData,o.attributes)d.addAttribute(f,o.attributes[f]);for(var f in o.morphAttributes)d.morphAttributes[f]=o.morphAttributes[f];for(var m=[],i=0,v=t.length;i<v;i++)m.push(n.getDependency("accessor",t[i].indices));return Promise.all(m).then((function(e){for(var r=[],n=0,i=0,c=t.length;i<c;i++){for(var f=e[i],m=0,v=f.count;m<v;m++)r.push(f.array[m]);d.addGroup(n,f.count,i),n+=f.count}return d.setIndex(r),l[h]={geometry:d,baseGeometry:o,primitives:t},[d]}))}if(r.length>1&&void 0!==BufferGeometryUtils){for(i=1,v=e.length;i<v;i++)if(e[0].mode!==e[i].mode)return r;var y;l=n.multiplePrimitivesCache,h=function(a){for(var e="",i=0,t=a.length;i<t;i++)e+=":"+a[i].uuid;return e}(r);if(y=l[h]){if(null!==y.geometry)return[y.geometry]}else{d=BufferGeometryUtils.mergeBufferGeometries(r,!0);if(l[h]={geometry:d,baseGeometries:r},null!==d)return[d]}}return r}))},Y.prototype.loadMesh=function(e){for(var t=this,n=this.json,o=this.extensions,l=n.meshes[e],c=l.primitives,h=[],i=0,d=c.length;i<d;i++){var f=void 0===c[i].material?new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide}):this.getDependency("material",c[i].material);h.push(f)}return Promise.all(h).then((function(n){return t.loadGeometries(c).then((function(h){for(var d=1===h.length&&h[0].groups.length>0,f=[],i=0,m=h.length;i<m;i++){var v,y=h[i],x=c[i],C=d?n:n[i];if(x.mode===T||x.mode===_||x.mode===L||void 0===x.mode)!0===(v=!0===l.isSkinnedMesh?new SkinnedMesh(y,C):new Mesh(y,C)).isSkinnedMesh&&v.normalizeSkinWeights(),x.mode===_?v.drawMode=TriangleStripDrawMode:x.mode===L&&(v.drawMode=TriangleFanDrawMode);else if(x.mode===M)v=new LineSegments(y,C);else if(x.mode===A)v=new Line(y,C);else if(x.mode===S)v=new LineLoop(y,C);else{if(x.mode!==w)throw new Error("GLTFLoader: Primitive mode unsupported: "+x.mode);v=new Points(y,C)}Object.keys(v.geometry.morphAttributes).length>0&&z(v,l),v.name=l.name||"mesh_"+e,h.length>1&&(v.name+="_"+i),G(v,l),f.push(v);for(var N=d?v.material:[v.material],P=void 0!==y.attributes.tangent,E=void 0!==y.attributes.color,D=void 0===y.attributes.normal,F=!0===v.isSkinnedMesh,R=Object.keys(y.morphAttributes).length>0,O=R&&void 0!==y.morphAttributes.normal,B=0,I=N.length;B<I;B++){C=N[B];if(v.isPoints){var U="PointsMaterial:"+C.uuid,V=t.cache.get(U);V||(V=new PointsMaterial,Material$1.prototype.copy.call(V,C),V.color.copy(C.color),V.map=C.map,V.lights=!1,t.cache.add(U,V)),C=V}else if(v.isLine){U="LineBasicMaterial:"+C.uuid;var k=t.cache.get(U);k||(k=new LineBasicMaterial,Material$1.prototype.copy.call(k,C),k.color.copy(C.color),k.lights=!1,t.cache.add(U,k)),C=k}if(P||E||D||F||R){U="ClonedMaterial:"+C.uuid+":";C.isGLTFSpecularGlossinessMaterial&&(U+="specular-glossiness:"),F&&(U+="skinning:"),P&&(U+="vertex-tangents:"),E&&(U+="vertex-colors:"),D&&(U+="flat-shading:"),R&&(U+="morph-targets:"),O&&(U+="morph-normals:");var j=t.cache.get(U);j||(j=C.isGLTFSpecularGlossinessMaterial?o[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(C):C.clone(),F&&(j.skinning=!0),P&&(j.vertexTangents=!0),E&&(j.vertexColors=VertexColors),D&&(j.flatShading=!0),R&&(j.morphTargets=!0),O&&(j.morphNormals=!0),t.cache.add(U,j)),C=j}N[B]=C,C.aoMap&&void 0===y.attributes.uv2&&void 0!==y.attributes.uv&&(console.log("GLTFLoader: Duplicating UVs to support aoMap."),y.addAttribute("uv2",new BufferAttribute(y.attributes.uv.array,2))),C.isGLTFSpecularGlossinessMaterial&&(v.onBeforeRender=o[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms)}v.material=d?N:N[0]}if(1===f.length)return f[0];var W=new Group;for(i=0,m=f.length;i<m;i++)W.add(f[i]);return W}))}))},Y.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new PerspectiveCamera(_Math.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new OrthographicCamera(n.xmag/-2,n.xmag/2,n.ymag/2,n.ymag/-2,n.znear,n.zfar)),void 0!==r.name&&(t.name=r.name),G(t,r),Promise.resolve(t);console.warn("GLTFLoader: Missing camera parameters.")},Y.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},Y.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],n=[],o=[],l=[],c=[],i=0,h=t.channels.length;i<h;i++){var d=t.channels[i],f=t.samplers[d.sampler],m=d.target,v=void 0!==m.node?m.node:m.id,input=void 0!==t.parameters?t.parameters[f.input]:f.input,output=void 0!==t.parameters?t.parameters[f.output]:f.output;r.push(this.getDependency("node",v)),n.push(this.getDependency("accessor",input)),o.push(this.getDependency("accessor",output)),l.push(f),c.push(m)}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(o),Promise.all(l),Promise.all(c)]).then((function(r){for(var n=r[0],o=r[1],l=r[2],c=r[3],h=r[4],d=[],i=0,f=n.length;i<f;i++){var m=n[i],v=o[i],y=l[i],w=c[i],M=h[i];if(void 0!==m){var S;switch(m.updateMatrix(),m.matrixAutoUpdate=!0,F[M.path]){case F.weights:S=NumberKeyframeTrack;break;case F.rotation:S=QuaternionKeyframeTrack;break;case F.position:case F.scale:default:S=VectorKeyframeTrack}var A=m.name?m.name:m.uuid,T=void 0!==w.interpolation?R[w.interpolation]:InterpolateLinear,_=[];F[M.path]===F.weights?m.traverse((function(object){!0===object.isMesh&&object.morphTargetInfluences&&_.push(object.name?object.name:object.uuid)})):_.push(A);for(var L=0,C=_.length;L<C;L++){var track=new S(_[L]+"."+F[M.path],AnimationUtils.arraySlice(v.array,0),AnimationUtils.arraySlice(y.array,0),T);"CUBICSPLINE"===w.interpolation&&(track.createInterpolant=function(e){return new x(this.times,this.values,this.getValueSize()/3,e)},track.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),d.push(track)}}}return new AnimationClip(void 0!==t.name?t.name:"animation_"+e,void 0,d)}))},Y.prototype.loadNode=function(e){var t=this.json,n=this.extensions,o=this,l=t.meshReferences,c=t.meshUses,h=t.nodes[e];return(!0===h.isBone?Promise.resolve(new Bone):void 0!==h.mesh?o.getDependency("mesh",h.mesh).then((function(e){var t;if(l[h.mesh]>1){var r=c[h.mesh]++;(t=e.clone()).name+="_instance_"+r,t.onBeforeRender=e.onBeforeRender;for(var i=0,n=t.children.length;i<n;i++)t.children[i].name+="_instance_"+r,t.children[i].onBeforeRender=e.children[i].onBeforeRender}else t=e;return void 0!==h.weights&&t.traverse((function(e){if(e.isMesh)for(var i=0,t=h.weights.length;i<t;i++)e.morphTargetInfluences[i]=h.weights[i]})),t})):void 0!==h.camera?o.getDependency("camera",h.camera):h.extensions&&h.extensions[r.KHR_LIGHTS_PUNCTUAL]&&void 0!==h.extensions[r.KHR_LIGHTS_PUNCTUAL].light?o.getDependency("light",h.extensions[r.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new Object3D)).then((function(e){if(void 0!==h.name&&(e.name=PropertyBinding.sanitizeNodeName(h.name)),G(e,h),h.extensions&&k(n,e,h),void 0!==h.matrix){var t=new Matrix4;t.fromArray(h.matrix),e.applyMatrix(t)}else void 0!==h.translation&&e.position.fromArray(h.translation),void 0!==h.rotation&&e.quaternion.fromArray(h.rotation),void 0!==h.scale&&e.scale.fromArray(h.scale);return e}))},Y.prototype.loadScene=function(){function e(t,r,n,o){var l=n.nodes[t];return o.getDependency("node",t).then((function(e){return void 0===l.skin?e:o.getDependency("skin",l.skin).then((function(e){for(var r=[],i=0,n=(t=e).joints.length;i<n;i++)r.push(o.getDependency("node",t.joints[i]));return Promise.all(r)})).then((function(r){for(var n=!0===e.isGroup?e.children:[e],i=0,o=n.length;i<o;i++){for(var l=n[i],c=[],h=[],d=0,f=r.length;d<f;d++){var m=r[d];if(m){c.push(m);var v=new Matrix4;void 0!==t.inverseBindMatrices&&v.fromArray(t.inverseBindMatrices.array,16*d),h.push(v)}else console.warn('GLTFLoader: Joint "%s" could not be found.',t.joints[d])}l.bind(new Skeleton(c,h),l.matrixWorld)}return e}));var t})).then((function(t){r.add(t);var c=[];if(l.children)for(var h=l.children,i=0,d=h.length;i<d;i++){var f=h[i];c.push(e(f,t,n,o))}return Promise.all(c)}))}return function(t){var r=this.json,n=this.extensions,o=this.json.scenes[t],l=new Scene;void 0!==o.name&&(l.name=o.name),G(l,o),o.extensions&&k(n,l,o);for(var c=o.nodes||[],h=[],i=0,d=c.length;i<d;i++)h.push(e(c[i],l,r,this));return Promise.all(h).then((function(){return l}))}}(),e}(),RGBELoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.type=UnsignedByteType};RGBELoader.prototype=Object.create(DataTextureLoader.prototype),RGBELoader.prototype._parser=function(e){var t=function(e,t){switch(e){case 1:console.error("RGBELoader Read Error: "+(t||""));break;case 2:console.error("RGBELoader Write Error: "+(t||""));break;case 3:console.error("RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("RGBELoader: Error: "+(t||""))}return-1},r=function(e,t,r){t=t||1024;for(var p=e.pos,i=-1,n=0,s="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(p,p+128)));0>(i=o.indexOf("\n"))&&n<t&&p<e.byteLength;)s+=o,n+=o.length,p+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(p,p+128)));return-1<i&&(!1!==r&&(e.pos+=n+i+1),s+o.slice(0,i))},n=new Uint8Array(e);n.pos=0;var o=function(e){var line,n,o=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,l=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,c=/^\s*FORMAT=(\S+)\s*$/,h=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,header={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(e.pos>=e.byteLength||!(line=r(e)))return t(1,"no header found");if(!(n=line.match(/^#\?(\S+)$/)))return t(3,"bad initial token");for(header.valid|=1,header.programtype=n[1],header.string+=line+"\n";!1!==(line=r(e));)if(header.string+=line+"\n","#"!==line.charAt(0)){if((n=line.match(o))&&(header.gamma=parseFloat(n[1],10)),(n=line.match(l))&&(header.exposure=parseFloat(n[1],10)),(n=line.match(c))&&(header.valid|=2,header.format=n[1]),(n=line.match(h))&&(header.valid|=4,header.height=parseInt(n[1],10),header.width=parseInt(n[2],10)),2&header.valid&&4&header.valid)break}else header.comments+=line+"\n";return 2&header.valid?4&header.valid?header:t(3,"missing image size specifier"):t(3,"missing format specifier")}(n);if(-1!==o){var l=o.width,c=o.height,h=function(e,r,n){var o,l,c,h,d,f,m,v,i,y,x,w,M,S=r,A=n;if(S<8||S>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(S!==(e[2]<<8|e[3]))return t(3,"wrong scanline width");if(!(o=new Uint8Array(4*r*n))||!o.length)return t(4,"unable to allocate buffer space");for(l=0,c=0,v=4*S,M=new Uint8Array(4),f=new Uint8Array(v);A>0&&c<e.byteLength;){if(c+4>e.byteLength)return t(1);if(M[0]=e[c++],M[1]=e[c++],M[2]=e[c++],M[3]=e[c++],2!=M[0]||2!=M[1]||(M[2]<<8|M[3])!=S)return t(3,"bad rgbe scanline format");for(m=0;m<v&&c<e.byteLength;){if((w=(h=e[c++])>128)&&(h-=128),0===h||m+h>v)return t(3,"bad scanline data");if(w)for(d=e[c++],i=0;i<h;i++)f[m++]=d;else f.set(e.subarray(c,c+h),m),m+=h,c+=h}for(y=S,i=0;i<y;i++)x=0,o[l]=f[i+x],x+=S,o[l+1]=f[i+x],x+=S,o[l+2]=f[i+x],x+=S,o[l+3]=f[i+x],l+=4;A--}return o}(n.subarray(n.pos),l,c);if(-1!==h){if(this.type===UnsignedByteType)var data=h,d=RGBEFormat,f=UnsignedByteType;else if(this.type===FloatType){for(var m=function(e,t,r,n){var o=e[t+3],l=Math.pow(2,o-128)/255;r[n+0]=e[t+0]*l,r[n+1]=e[t+1]*l,r[n+2]=e[t+2]*l},v=h.length/4*3,y=new Float32Array(v),x=0;x<v;x++)m(h,4*x,y,3*x);data=y,d=RGBFormat,f=FloatType}else console.error("RGBELoader: unsupported type: ",this.type);return{width:l,height:c,data:data,header:o.string,gamma:o.gamma,exposure:o.exposure,format:d,type:f}}}return null};var HDRLoader=RGBELoader;function CubeTexture(e,t,r,n,o,l,c,h,d,f){e=void 0!==e?e:[],t=void 0!==t?t:CubeReflectionMapping,c=void 0!==c?c:RGBFormat,Texture.call(this,e,t,r,n,o,l,c,h,d,f),this.flipY=!1}RGBELoader.prototype.setType=function(e){return this.type=e,this},CubeTexture.prototype=Object.create(Texture.prototype),CubeTexture.prototype.constructor=CubeTexture,CubeTexture.prototype.isCubeTexture=!0,Object.defineProperty(CubeTexture.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var HDRCubeTextureLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.hdrLoader=new RGBELoader};HDRCubeTextureLoader.prototype.load=function(e,t,r,n,o){var l=function(e,t,r,n){var o=e[t+3],l=Math.pow(2,o-128)/255;r[n+0]=e[t+0]*l,r[n+1]=e[t+1]*l,r[n+2]=e[t+2]*l},c=function(){var e=new Float32Array(1),t=new Int32Array(e.buffer);function r(r){e[0]=r;var n=t[0],o=n>>16&32768,l=n>>12&2047,c=n>>23&255;return c<103?o:c>142?(o|=31744,o|=(255==c?0:1)&&8388607&n):c<113?o|=((l|=2048)>>114-c)+(l>>113-c&1):(o|=c-112<<10|l>>1,o+=1&l)}return function(e,t,n,o){var l=e[t+3],c=Math.pow(2,l-128)/255;n[o+0]=r(e[t+0]*c),n[o+1]=r(e[t+1]*c),n[o+2]=r(e[t+2]*c)}}(),h=new CubeTexture;h.type=e,h.encoding=e===UnsignedByteType?RGBEEncoding:LinearEncoding,h.format=e===UnsignedByteType?RGBAFormat:RGBFormat,h.minFilter=h.encoding===RGBEEncoding?NearestFilter:LinearFilter,h.magFilter=h.encoding===RGBEEncoding?NearestFilter:LinearFilter,h.generateMipmaps=h.encoding!==RGBEEncoding,h.anisotropy=0;var d=this,f=0;function m(i,r,n,o){var m=new FileLoader(d.manager);m.setPath(d.path),m.setResponseType("arraybuffer"),m.load(t[i],(function(t){f++;var n=d.hdrLoader._parser(t);if(n){if(e===FloatType){for(var o=n.data.length/4*3,m=new Float32Array(o),v=0;v<o;v++)l(n.data,4*v,m,3*v);n.data=m}else if(e===HalfFloatType){o=n.data.length/4*3;var y=new Uint16Array(o);for(v=0;v<o;v++)c(n.data,4*v,y,3*v);n.data=y}if(void 0!==n.image)h[i].images=n.image;else if(void 0!==n.data){var x=new DataTexture(n.data,n.width,n.height);x.format=h.format,x.type=h.type,x.encoding=h.encoding,x.minFilter=h.minFilter,x.magFilter=h.magFilter,x.generateMipmaps=h.generateMipmaps,h.images[i]=x}6===f&&(h.needsUpdate=!0,r&&r(h))}}),n,o)}for(var i=0;i<t.length;i++)m(i,r,n,o);return h},HDRCubeTextureLoader.prototype.setPath=function(e){return this.path=e,this};var KMZLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};KMZLoader.prototype={constructor:KMZLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){var e=new LoadingManager;e.setURLModifier((function(e){var image=function(e){for(var path in t.files)if(path.substr(-e.length)===e)return t.files[path]}(e);if(image){console.log("Loading",e);var r=new Blob([image.asArrayBuffer()],{type:"application/octet-stream"});return URL.createObjectURL(r)}return e}));var t=new JSZip(data);if(t.files["doc.kml"]){var r=(new DOMParser).parseFromString(t.files["doc.kml"].asText(),"application/xml").querySelector("Placemark Model Link href");if(r)return new ColladaLoader(e).parse(t.files[r.textContent].asText())}else for(var path in console.warn("KMZLoader: Missing doc.kml file."),t.files){if("dae"===path.split(".").pop().toLowerCase())return new ColladaLoader(e).parse(t.files[path].asText())}return console.error("KMZLoader: Couldn't find .dae file."),{scene:new Group}}};var KTXLoader=function(e){CompressedTextureLoader.call(this,e),this._parser=KTXLoader.parse};KTXLoader.prototype=Object.create(CompressedTextureLoader.prototype),KTXLoader.prototype.constructor=KTXLoader,KTXLoader.parse=function(e,t){var r=new KhronosTextureContainer(e,1);return{mipmaps:r.mipmaps(t),width:r.pixelWidth,height:r.pixelHeight,format:r.glInternalFormat,isCubemap:6===r.numberOfFaces,mipmapCount:r.numberOfMipmapLevels}};var KhronosTextureContainer=function(){function e(t,r,n,o){this.arrayBuffer=t;var l=new Uint8Array(this.arrayBuffer,0,12);if(171===l[0]&&75===l[1]&&84===l[2]&&88===l[3]&&32===l[4]&&49===l[5]&&49===l[6]&&187===l[7]&&13===l[8]&&10===l[9]&&26===l[10]&&10===l[11]){var c=Uint32Array.BYTES_PER_ELEMENT,h=new DataView(this.arrayBuffer,12,13*c),d=67305985===h.getUint32(0,!0);this.glType=h.getUint32(1*c,d),this.glTypeSize=h.getUint32(2*c,d),this.glFormat=h.getUint32(3*c,d),this.glInternalFormat=h.getUint32(4*c,d),this.glBaseInternalFormat=h.getUint32(5*c,d),this.pixelWidth=h.getUint32(6*c,d),this.pixelHeight=h.getUint32(7*c,d),this.pixelDepth=h.getUint32(8*c,d),this.numberOfArrayElements=h.getUint32(9*c,d),this.numberOfFaces=h.getUint32(10*c,d),this.numberOfMipmapLevels=h.getUint32(11*c,d),this.bytesOfKeyValueData=h.getUint32(12*c,d),0===this.glType?(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0!==this.pixelHeight&&0===this.pixelDepth?0===this.numberOfArrayElements?this.numberOfFaces===r?this.loadType=e.COMPRESSED_2D:console.warn("number of faces expected"+r+", but found "+this.numberOfFaces):console.warn("texture arrays not currently supported"):console.warn("only 2D textures currently supported")):console.warn("only compressed formats currently supported")}else console.error("texture missing KTX identifier")}return e.prototype.mipmaps=function(t){for(var r=[],n=e.HEADER_LEN+this.bytesOfKeyValueData,o=this.pixelWidth,l=this.pixelHeight,c=t?this.numberOfMipmapLevels:1,h=0;h<c;h++){for(var d=new Int32Array(this.arrayBuffer,n,1)[0],f=0;f<this.numberOfFaces;f++){var m=new Uint8Array(this.arrayBuffer,n+4,d);r.push({data:m,width:o,height:l}),n+=d+4,n+=3-(d+3)%4}o=Math.max(1,.5*o),l=Math.max(1,.5*l)}return r},e.HEADER_LEN=64,e.COMPRESSED_2D=0,e.COMPRESSED_3D=1,e.TEX_2D=2,e.TEX_3D=3,e}(),LDrawLoader=function(){function e(line,e){this.line=line,this.lineLength=line.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=e}function t(a,b){return a.colourCode===b.colourCode?0:a.colourCode<b.colourCode?-1:1}function r(e,r){e.sort(t);var n=[],o=[],l=new BufferGeometry;l.clearGroups();for(var c=null,h=0,d=0,f=0,m=e.length;f<m;f++){var v=e[f],y=v.v0,x=v.v1;n.push(y.x,y.y,y.z,x.x,x.y,x.z),3===r&&n.push(v.v2.x,v.v2.y,v.v2.z),c!==v.material?(null!==c&&l.addGroup(h,d,o.length-1),o.push(v.material),c=v.material,h=f*r,d=r):d+=r}d>0&&l.addGroup(h,1/0,o.length-1),l.addAttribute("position",new Float32BufferAttribute(n,3));var w=null;return 2===r?w=new LineSegments(l,o):3===r&&(l.computeVertexNormals(),w=new Mesh(l,o)),w}function n(t){this.manager=void 0!==t?t:DefaultLoadingManager,this.parseScopesStack=null,this.path="",this.materials=[],this.subobjectCache={},this.fileMap=null,this.setMaterials([this.parseColourMetaDirective(new e("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333")),this.parseColourMetaDirective(new e("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))]),this.separateObjects=!1,this.currentGroupObject=null,this.currentTriangles=null,this.currentLineSegments=null}return e.prototype={constructor:e,seekNonSpace:function(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar)return;this.currentCharIndex++}},getToken:function(){for(var e=this.currentCharIndex++;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar);)this.currentCharIndex++;var t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)},getRemainingString:function(){return this.line.substring(this.currentCharIndex,this.lineLength)},isAtTheEnd:function(){return this.currentCharIndex>=this.lineLength},setToEnd:function(){this.currentCharIndex=this.lineLength},getLineNumberString:function(){return this.lineNumber>=0?" at line "+this.lineNumber:""}},n.FINISH_TYPE_DEFAULT=0,n.FINISH_TYPE_CHROME=1,n.FINISH_TYPE_PEARLESCENT=2,n.FINISH_TYPE_RUBBER=3,n.FINISH_TYPE_MATTE_METALLIC=4,n.FINISH_TYPE_METAL=5,n.FILE_LOCATION_AS_IS=0,n.FILE_LOCATION_TRY_PARTS=1,n.FILE_LOCATION_TRY_P=2,n.FILE_LOCATION_TRY_MODELS=3,n.FILE_LOCATION_TRY_RELATIVE=4,n.FILE_LOCATION_TRY_ABSOLUTE=5,n.FILE_LOCATION_NOT_FOUND=6,n.prototype={constructor:n,load:function(e,t,o,l){this.fileMap||(this.fileMap={});var c=this,h=new FileLoader(this.manager);h.setPath(this.path),h.load(e,(function(text){!function t(text,o){var l=c.newParseScopeLevel();l.url=e;var h=c.getParentParseScope(),d=h.currentFileName;void 0===c.subobjectCache[d]&&(c.subobjectCache[d]=text);var f=c.parse(text);if(l.subobjects=f.userData.subobjects,l.numSubobjects=l.subobjects.length,l.subobjectIndex=0,l.numSubobjects>0){var m=y(l.subobjects[0],!0);if(m){for(;m&&l.subobjectIndex<l.numSubobjects-1;)m=y(l.subobjects[++l.subobjectIndex],!0);m&&v()}}else v();return f;function v(){c.separateObjects||h.isFromParse||(c.currentLineSegments.length>0&&f.add(r(c.currentLineSegments,2)),c.currentTriangles.length>0&&f.add(r(c.currentTriangles,3))),c.removeScopeLevel(),o&&o(f)}function y(r,d){l.mainColourCode=r.material.userData.code,l.mainEdgeColourCode=r.material.userData.edgeMaterial.userData.code,l.currentFileName=r.originalFileName,c.separateObjects||l.currentMatrix.multiplyMatrices(h.currentMatrix,r.matrix);var m=c.subobjectCache[r.originalFileName];if(m){var v=t(m,d?void 0:x);return d?(w(r,v),v):void 0}var S=r.fileName,A=n.FILE_LOCATION_NOT_FOUND;switch(r.locationState){case n.FILE_LOCATION_AS_IS:A=r.locationState+1;break;case n.FILE_LOCATION_TRY_PARTS:S="parts/"+S,A=r.locationState+1;break;case n.FILE_LOCATION_TRY_P:S="p/"+S,A=r.locationState+1;break;case n.FILE_LOCATION_TRY_MODELS:S="models/"+S,A=r.locationState+1;break;case n.FILE_LOCATION_TRY_RELATIVE:S=e.substring(0,e.lastIndexOf("/")+1)+S,A=r.locationState+1;break;case n.FILE_LOCATION_TRY_ABSOLUTE:r.triedLowerCase?A=n.FILE_LOCATION_NOT_FOUND:(r.fileName=r.fileName.toLowerCase(),S=r.fileName,r.triedLowerCase=!0,A=n.FILE_LOCATION_AS_IS);break;case n.FILE_LOCATION_NOT_FOUND:return console.warn('LDrawLoader: Subobject "'+r.originalFileName+'" could not be found.'),l.subobjectIndex++,void(l.subobjectIndex>=l.numSubobjects?(c.removeScopeLevel(),o(f)):y(l.subobjects[l.subobjectIndex]))}r.locationState=A,r.url=S,c.load(S,x,void 0,M)}function x(e){var t=l.subobjects[l.subobjectIndex];null!==e?(w(t,e),l.subobjectIndex++,l.subobjectIndex<l.numSubobjects?y(l.subobjects[l.subobjectIndex]):v()):y(t)}function w(e,t){c.separateObjects&&(t.name=e.fileName,f.add(t),t.matrix.copy(e.matrix),t.matrixAutoUpdate=!1),c.fileMap[e.originalFileName]=e.url}function M(e){y(l.subobjects[l.subobjectIndex])}}(text,t)}),o,l)},setPath:function(e){return this.path=e,this},setMaterials:function(e){return this.parseScopesStack=[],this.newParseScopeLevel(e),this.getCurrentParseScope().isFromParse=!1,this.materials=e,this.currentGroupObject=null,this},setFileMap:function(e){return this.fileMap=e,this},newParseScopeLevel:function(e){var t={};if(e)for(var i=0,r=e.length;i<r;i++){var n=e[i];t[n.userData.code]=n}var o=this.getCurrentParseScope(),l=(this.getParentParseScope(),{lib:t,url:null,subobjects:null,numSubobjects:0,subobjectIndex:0,currentFileName:null,mainColourCode:o?o.mainColourCode:"16",mainEdgeColourCode:o?o.mainEdgeColourCode:"24",currentMatrix:new Matrix4,isFromParse:!0});return this.parseScopesStack.push(l),l},removeScopeLevel:function(){return this.parseScopesStack.pop(),this},addMaterial:function(e){var t=this.getCurrentParseScope().lib;return t[e.userData.code]||this.materials.push(e),t[e.userData.code]=e,this},getMaterial:function(t){if(t.startsWith("0x2")){var r=t.substring(3);return this.parseColourMetaDirective(new e("Direct_Color_"+r+" CODE -1 VALUE #"+r+" EDGE #"+r))}for(var i=this.parseScopesStack.length-1;i>=0;i--){var n=this.parseScopesStack[i].lib[t];if(n)return n}return null},getParentParseScope:function(){return this.parseScopesStack.length>1?this.parseScopesStack[this.parseScopesStack.length-2]:null},getCurrentParseScope:function(){return this.parseScopesStack.length>0?this.parseScopesStack[this.parseScopesStack.length-1]:null},parseColourMetaDirective:function(e){var code=null,t=16711935,r=16711935,o=1,l=!1,c=0,h=n.FINISH_TYPE_DEFAULT,d=!0,f=null,m=e.getToken();if(!m)throw'LDrawLoader: Material name was expected after "!COLOUR tag'+e.getLineNumberString()+".";for(var v=null;v=e.getToken();)switch(v.toUpperCase()){case"CODE":code=e.getToken();break;case"VALUE":if((t=e.getToken()).startsWith("0x"))t="#"+t.substring(2);else if(!t.startsWith("#"))throw"LDrawLoader: Invalid colour while parsing material"+e.getLineNumberString()+".";break;case"EDGE":if((r=e.getToken()).startsWith("0x"))r="#"+r.substring(2);else if(!r.startsWith("#")){if(!(f=this.getMaterial(r)))throw"LDrawLoader: Invalid edge colour while parsing material"+e.getLineNumberString()+".";f=f.userData.edgeMaterial}break;case"ALPHA":if(o=parseInt(e.getToken()),isNaN(o))throw"LDrawLoader: Invalid alpha value in material definition"+e.getLineNumberString()+".";(o=Math.max(0,Math.min(1,o/255)))<1&&(l=!0);break;case"LUMINANCE":if(c=parseInt(e.getToken()),isNaN(c))throw"LDrawLoader: Invalid luminance value in material definition"+e.getLineNumberString()+".";c=Math.max(0,Math.min(1,c/255));break;case"CHROME":h=n.FINISH_TYPE_CHROME;break;case"PEARLESCENT":h=n.FINISH_TYPE_PEARLESCENT;break;case"RUBBER":h=n.FINISH_TYPE_RUBBER;break;case"MATTE_METALLIC":h=n.FINISH_TYPE_MATTE_METALLIC;break;case"METAL":h=n.FINISH_TYPE_METAL;break;case"MATERIAL":e.setToEnd();break;default:throw'LDrawLoader: Unknown token "'+v+'" while parsing material'+e.getLineNumberString()+"."}var y=null;switch(h){case n.FINISH_TYPE_DEFAULT:case n.FINISH_TYPE_PEARLESCENT:var x=new Color(t),w=35,M=x.getHSL({h:0,s:0,l:0});h===n.FINISH_TYPE_DEFAULT?M.l=Math.min(1,M.l+.12*(1-M.l)):(M.h=(M.h+.5)%1,M.l=Math.min(1,M.l+.7*(1-M.l)),w=10),x.setHSL(M.h,M.s,M.l),y=new MeshPhongMaterial({color:t,specular:x,shininess:w,reflectivity:.3});break;case n.FINISH_TYPE_CHROME:y=new MeshStandardMaterial({color:t,roughness:0,metalness:1});break;case n.FINISH_TYPE_RUBBER:y=new MeshLambertMaterial({color:t}),d=!1;break;case n.FINISH_TYPE_MATTE_METALLIC:y=new MeshStandardMaterial({color:t,roughness:.8,metalness:.4});break;case n.FINISH_TYPE_METAL:y=new MeshStandardMaterial({color:t,roughness:.2,metalness:.85})}return y.side=DoubleSide,y.transparent=l,y.opacity=o,y.userData.canHaveEnvMap=d,0!==c&&y.emissive.set(y.color).multiplyScalar(c),f||((f=new LineBasicMaterial({color:r})).userData.code=code,f.name=m+" - Edge",f.userData.canHaveEnvMap=!1),y.userData.code=code,y.name=m,y.userData.edgeMaterial=f,y},parse:function(text){var t,o,l=this.getParentParseScope(),c=l.mainColourCode,h=l.mainEdgeColourCode;l.url,this.getCurrentParseScope();this.separateObjects?(t=[],o=[]):(null===this.currentGroupObject&&(this.currentGroupObject=new Group,this.currentTriangles=[],this.currentLineSegments=[]),t=this.currentTriangles,o=this.currentLineSegments);var d=[],f=null,m=null;-1!==text.indexOf("\r\n")&&(text=text.replace(/\r\n/g,"\n"));var v=text.split("\n"),y=v.length,x=0,w=!1,M=null,S=null,A=this;function T(e,t){var r=e.getToken();t||"16"!==r||(r=c),t&&"24"===r&&(r=h);var n=A.getMaterial(r);if(!n)throw'LDrawLoader: Unknown colour code "'+r+'" is used'+e.getLineNumberString()+" but it was not defined previously.";return n}function _(e){var t=new Vector3(parseFloat(e.getToken()),parseFloat(e.getToken()),parseFloat(e.getToken()));return A.separateObjects||t.applyMatrix4(l.currentMatrix),t}for(x=0;x<y;x++){var line=v[x];if(0!==line.length)if(w)line.startsWith("0 FILE ")?(this.subobjectCache[M]=S,M=line.substring(7),S=""):S+=line+"\n";else{var L=new e(line,x+1);if(L.seekNonSpace(),!L.isAtTheEnd()){var C=L.getToken();switch(C){case"0":var meta=L.getToken();if(meta)switch(meta){case"!COLOUR":(P=this.parseColourMetaDirective(L))?this.addMaterial(P):console.warn("LDrawLoader: Error parsing material"+L.getLineNumberString());break;case"!CATEGORY":f=L.getToken();break;case"!KEYWORDS":var N=L.getRemainingString().split(",");N.length>0&&(m||(m=[]),N.forEach((function(e){m.push(e.trim())})));break;case"FILE":x>0&&(w=!0,M=L.getRemainingString(),S="")}break;case"1":var P=T(L),E=parseFloat(L.getToken()),D=parseFloat(L.getToken()),F=parseFloat(L.getToken()),R=parseFloat(L.getToken()),O=parseFloat(L.getToken()),B=parseFloat(L.getToken()),I=parseFloat(L.getToken()),U=parseFloat(L.getToken()),V=parseFloat(L.getToken()),k=parseFloat(L.getToken()),G=parseFloat(L.getToken()),z=parseFloat(L.getToken()),j=(new Matrix4).set(R,O,B,E,I,U,V,D,k,G,z,F,0,0,0,1),W=L.getRemainingString().trim().replace("\\","/");A.fileMap[W]?W=A.fileMap[W]:W.startsWith("s/")?W="parts/"+W:W.startsWith("48/")&&(W="p/"+W),d.push({material:P,matrix:j,fileName:W,originalFileName:W,locationState:n.FILE_LOCATION_AS_IS,url:null,triedLowerCase:!1});break;case"2":P=T(L,!0);o.push({material:P.userData.edgeMaterial,colourCode:P.userData.code,v0:_(L),v1:_(L)});break;case"3":P=T(L);t.push({material:P,colourCode:P.userData.code,v0:_(L),v1:_(L),v2:_(L)});break;case"4":P=T(L);var H=_(L),X=_(L),Y=_(L),Q=_(L);t.push({material:P,colourCode:P.userData.code,v0:H,v1:X,v2:Y}),t.push({material:P,colourCode:P.userData.code,v0:H,v1:Y,v2:Q});break;case"5":break;default:throw'LDrawLoader: Unknown line type "'+C+'"'+L.getLineNumberString()+"."}}}}w&&(this.subobjectCache[M]=S);var K=null;return this.separateObjects?(K=new Group,o.length>0&&K.add(r(o,2)),t.length>0&&K.add(r(t,3))):K=this.currentGroupObject,K.userData.category=f,K.userData.keywords=m,K.userData.subobjects=d,K}},n}(),LoaderSupport={Validator:{isValid:function(input){return null!=input},verifyInput:function(input,e){return null==input?e:input}},Callbacks:function(){this.onProgress=null,this.onReportError=null,this.onMeshAlter=null,this.onLoad=null,this.onLoadMaterials=null}};LoaderSupport.Callbacks.prototype={constructor:LoaderSupport.Callbacks,setCallbackOnProgress:function(e){this.onProgress=LoaderSupport.Validator.verifyInput(e,this.onProgress)},setCallbackOnReportError:function(e){this.onReportError=LoaderSupport.Validator.verifyInput(e,this.onReportError)},setCallbackOnMeshAlter:function(e){this.onMeshAlter=LoaderSupport.Validator.verifyInput(e,this.onMeshAlter)},setCallbackOnLoad:function(e){this.onLoad=LoaderSupport.Validator.verifyInput(e,this.onLoad)},setCallbackOnLoadMaterials:function(e){this.onLoadMaterials=LoaderSupport.Validator.verifyInput(e,this.onLoadMaterials)}},LoaderSupport.LoadedMeshUserOverride=function(e,t){this.disregardMesh=!0===e,this.alteredMesh=!0===t,this.meshes=[]},LoaderSupport.LoadedMeshUserOverride.prototype={constructor:LoaderSupport.LoadedMeshUserOverride,addMesh:function(e){this.meshes.push(e),this.alteredMesh=!0},isDisregardMesh:function(){return this.disregardMesh},providesAlteredMeshes:function(){return this.alteredMesh}},LoaderSupport.ResourceDescriptor=function(e,t){var r=e.split("/");this.path,this.resourcePath,this.name=e,this.url=e,r.length>=2&&(this.path=LoaderSupport.Validator.verifyInput(r.slice(0,r.length-1).join("/")+"/",this.path),this.name=r[r.length-1],this.url=e),this.name=LoaderSupport.Validator.verifyInput(this.name,"Unnamed_Resource"),this.extension=LoaderSupport.Validator.verifyInput(t,"default"),this.extension=this.extension.trim(),this.content=null},LoaderSupport.ResourceDescriptor.prototype={constructor:LoaderSupport.ResourceDescriptor,setContent:function(content){this.content=LoaderSupport.Validator.verifyInput(content,null)},setResourcePath:function(e){this.resourcePath=LoaderSupport.Validator.verifyInput(e,this.resourcePath)}},LoaderSupport.PrepData=function(e){this.logging={enabled:!0,debug:!1},this.modelName=LoaderSupport.Validator.verifyInput(e,""),this.resources=[],this.callbacks=new LoaderSupport.Callbacks},LoaderSupport.PrepData.prototype={constructor:LoaderSupport.PrepData,setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},getCallbacks:function(){return this.callbacks},addResource:function(e){this.resources.push(e)},clone:function(){var e,t,r=new LoaderSupport.PrepData(this.modelName);for(e in r.logging.enabled=this.logging.enabled,r.logging.debug=this.logging.debug,r.resources=this.resources,r.callbacks=this.callbacks,this)t=this[e],r.hasOwnProperty(e)||"function"==typeof this[e]||(r[e]=t);return r},checkResourceDescriptorFiles:function(e,t){var r,n,i,o,l={};for(var c in e)if(r=e[c],o=!1,LoaderSupport.Validator.isValid(r.name))if(LoaderSupport.Validator.isValid(r.content)){for(i=0;i<t.length&&!o;i++)if(n=t[i],r.extension.toLowerCase()===n.ext.toLowerCase())if(n.ignore)o=!0;else if("ArrayBuffer"===n.type){if(!(r.content instanceof ArrayBuffer||r.content instanceof Uint8Array))throw"Provided content is not of type ArrayBuffer! Aborting...";l[n.ext]=r,o=!0}else if("String"===n.type){if(!("string"==typeof r.content||r.content instanceof String))throw"Provided  content is not of type String! Aborting...";l[n.ext]=r,o=!0}if(!o)throw'Unidentified resource "'+r.name+'": '+r.url}else{if(!("string"==typeof r.name||r.name instanceof String))throw"Provided file is not properly defined! Aborting...";for(i=0;i<t.length&&!o;i++)n=t[i],r.extension.toLowerCase()===n.ext.toLowerCase()&&(n.ignore||(l[n.ext]=r),o=!0);if(!o)throw'Unidentified resource "'+r.name+'": '+r.url}return l}},LoaderSupport.MeshBuilder=function(){console.info("Using LoaderSupport.MeshBuilder version: "+LoaderSupport.MeshBuilder.LOADER_MESH_BUILDER_VERSION),this.validator=LoaderSupport.Validator,this.logging={enabled:!0,debug:!1},this.callbacks=new LoaderSupport.Callbacks,this.materials=[]},LoaderSupport.MeshBuilder.LOADER_MESH_BUILDER_VERSION="1.3.0",LoaderSupport.MeshBuilder.prototype={constructor:LoaderSupport.MeshBuilder,setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},init:function(){var e=new MeshStandardMaterial({color:14479871});e.name="defaultMaterial";var t=new MeshStandardMaterial({color:14479871});t.name="defaultVertexColorMaterial",t.vertexColors=VertexColors;var r=new LineBasicMaterial;r.name="defaultLineMaterial";var n=new PointsMaterial({size:1});n.name="defaultPointMaterial";var o={};o[e.name]=e,o[t.name]=t,o[r.name]=r,o[n.name]=n,this.updateMaterials({cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:o}})},setMaterials:function(e){var t={cmd:"materialData",materials:{materialCloneInstructions:null,serializedMaterials:null,runtimeMaterials:this.validator.isValid(this.callbacks.onLoadMaterials)?this.callbacks.onLoadMaterials(e):e}};this.updateMaterials(t)},_setCallbacks:function(e){this.validator.isValid(e.onProgress)&&this.callbacks.setCallbackOnProgress(e.onProgress),this.validator.isValid(e.onReportError)&&this.callbacks.setCallbackOnReportError(e.onReportError),this.validator.isValid(e.onMeshAlter)&&this.callbacks.setCallbackOnMeshAlter(e.onMeshAlter),this.validator.isValid(e.onLoad)&&this.callbacks.setCallbackOnLoad(e.onLoad),this.validator.isValid(e.onLoadMaterials)&&this.callbacks.setCallbackOnLoadMaterials(e.onLoadMaterials)},processPayload:function(e){return"meshData"===e.cmd?this.buildMeshes(e):"materialData"===e.cmd?(this.updateMaterials(e),null):void 0},buildMeshes:function(e){var t,r,n,o=e.params.meshName,l=new BufferGeometry;l.addAttribute("position",new BufferAttribute(new Float32Array(e.buffers.vertices),3)),this.validator.isValid(e.buffers.indices)&&l.setIndex(new BufferAttribute(new Uint32Array(e.buffers.indices),1)),this.validator.isValid(e.buffers.colors)&&l.addAttribute("color",new BufferAttribute(new Float32Array(e.buffers.colors),3)),this.validator.isValid(e.buffers.normals)?l.addAttribute("normal",new BufferAttribute(new Float32Array(e.buffers.normals),3)):l.computeVertexNormals(),this.validator.isValid(e.buffers.uvs)&&l.addAttribute("uv",new BufferAttribute(new Float32Array(e.buffers.uvs),2));var c=e.materials.materialNames,h=e.materials.multiMaterial,d=[];for(n in c)r=c[n],t=this.materials[r],h&&d.push(t);if(h){t=d;var f,m=e.materials.materialGroups;for(n in m)f=m[n],l.addGroup(f.start,f.count,f.index)}var v,y,x,w=[],M=this.callbacks.onMeshAlter,S=!0,A=this.validator.verifyInput(e.geometryType,0);if(this.validator.isValid(M)&&(y=M({detail:{meshName:o,bufferGeometry:l,material:t,geometryType:A}}),this.validator.isValid(y)))if(y.isDisregardMesh())S=!1;else if(y.providesAlteredMeshes()){for(var i in y.meshes)w.push(y.meshes[i]);S=!1}if(S&&(e.computeBoundingSphere&&l.computeBoundingSphere(),(v=0===A?new Mesh(l,t):1===A?new LineSegments(l,t):new Points(l,t)).name=o,w.push(v)),this.validator.isValid(w)&&w.length>0){var T=[];for(var i in w)v=w[i],T[i]=v.name;x="Adding mesh(es) ("+T.length+": "+T+") from input mesh: "+o,x+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)"}else x="Not adding mesh: "+o,x+=" ("+(100*e.progress.numericalValue).toFixed(2)+"%)";var _=this.callbacks.onProgress;this.validator.isValid(_)&&_(new CustomEvent("MeshBuilderEvent",{detail:{type:"progress",modelName:e.params.meshName,text:x,numericalValue:e.progress.numericalValue}}));return w},updateMaterials:function(e){var t,r,n=e.materials.materialCloneInstructions;if(this.validator.isValid(n)){var o=n.materialNameOrg,l=this.materials[o];if(this.validator.isValid(o)){t=l.clone(),r=n.materialName,t.name=r;var c=n.materialProperties;for(var h in c)t.hasOwnProperty(h)&&c.hasOwnProperty(h)&&(t[h]=c[h]);this.materials[r]=t}else console.warn('Requested material "'+o+'" is not available!')}var d=e.materials.serializedMaterials;if(this.validator.isValid(d)&&Object.keys(d).length>0){var f,m=new MaterialLoader;for(r in d)f=d[r],this.validator.isValid(f)&&(t=m.parse(f),this.logging.enabled&&console.info('De-serialized material with name "'+r+'" will be added.'),this.materials[r]=t)}if(d=e.materials.runtimeMaterials,this.validator.isValid(d)&&Object.keys(d).length>0)for(r in d)t=d[r],this.logging.enabled&&console.info('Material with name "'+r+'" will be added.'),this.materials[r]=t},getMaterialsJSON:function(){var e,t={};for(var r in this.materials)e=this.materials[r],t[r]=e.toJSON();return t},getMaterials:function(){return this.materials}},LoaderSupport.WorkerSupport=function(){console.info("Using LoaderSupport.WorkerSupport version: "+LoaderSupport.WorkerSupport.WORKER_SUPPORT_VERSION),this.logging={enabled:!0,debug:!1},this.loaderWorker="undefined"!=typeof window?new LoaderSupport.WorkerSupport.LoaderWorker:new LoaderSupport.WorkerSupport.NodeLoaderWorker},LoaderSupport.WorkerSupport.WORKER_SUPPORT_VERSION="2.3.0",LoaderSupport.WorkerSupport.prototype={constructor:LoaderSupport.WorkerSupport,setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t,this.loaderWorker.setLogging(this.logging.enabled,this.logging.debug)},setForceWorkerDataCopy:function(e){this.loaderWorker.setForceCopy(e)},validate:function(e,t,r,n,o){if(!LoaderSupport.Validator.isValid(this.loaderWorker.worker)){this.logging.enabled&&(console.info("WorkerSupport: Building worker code..."),console.time("buildWebWorkerCode")),LoaderSupport.Validator.isValid(o)?this.logging.enabled&&console.info('WorkerSupport: Using "'+o.runnerName+'" as Runner class for worker.'):"undefined"!=typeof window?(o=LoaderSupport.WorkerRunnerRefImpl,this.logging.enabled&&console.info('WorkerSupport: Using DEFAULT "LoaderSupport.WorkerRunnerRefImpl" as Runner class for worker.')):(o=LoaderSupport.NodeWorkerRunnerRefImpl,this.logging.enabled&&console.info('WorkerSupport: Using DEFAULT "LoaderSupport.NodeWorkerRunnerRefImpl" as Runner class for worker.'));var l=e(LoaderSupport.WorkerSupport.CodeSerializer);l+="var Parser = "+t+";\n\n",l+=LoaderSupport.WorkerSupport.CodeSerializer.serializeClass(o.runnerName,o),l+="new "+o.runnerName+"();\n\n";var c=this;if(LoaderSupport.Validator.isValid(r)&&r.length>0){var h="",d=function(path,e){if(0===e.length)c.loaderWorker.initWorker(h+l,o.runnerName),c.logging.enabled&&console.timeEnd("buildWebWorkerCode");else{var t=new FileLoader;t.setPath(path),t.setResponseType("text"),t.load(e[0],(function(t){h+=t,d(path,e)})),e.shift()}};d(n,r)}else this.loaderWorker.initWorker(l,o.runnerName),this.logging.enabled&&console.timeEnd("buildWebWorkerCode")}},setCallbacks:function(e,t){this.loaderWorker.setCallbacks(e,t)},run:function(e){this.loaderWorker.run(e)},setTerminateRequested:function(e){this.loaderWorker.setTerminateRequested(e)}},LoaderSupport.WorkerSupport.LoaderWorker=function(){this._reset()},LoaderSupport.WorkerSupport.LoaderWorker.prototype={constructor:LoaderSupport.WorkerSupport.LoaderWorker,_reset:function(){this.logging={enabled:!0,debug:!1},this.worker=null,this.runnerImplName=null,this.callbacks={meshBuilder:null,onLoad:null},this.terminateRequested=!1,this.queuedMessage=null,this.started=!1,this.forceCopy=!1},checkSupport:function(){return void 0===window.Worker?"This browser does not support web workers!":void 0===window.Blob?"This browser does not support Blob!":"function"!=typeof window.URL.createObjectURL?"This browser does not support Object creation from URL!":void 0},setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},setForceCopy:function(e){this.forceCopy=!0===e},initWorker:function(code,e){var t=this.checkSupport();if(t)throw t;this.runnerImplName=e;var r=new Blob([code],{type:"application/javascript"});this.worker=new Worker(window.URL.createObjectURL(r)),this.worker.onmessage=this._receiveWorkerMessage,this.worker.runtimeRef=this,this._postMessage()},_receiveWorkerMessage:function(e){var t=e.data;switch(t.cmd){case"meshData":case"materialData":case"imageData":this.runtimeRef.callbacks.meshBuilder(t);break;case"complete":this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run is complete. Terminating application on request!"),this.runtimeRef._terminate());break;case"error":console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Reported error: "+t.msg),this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(t.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run reported error. Terminating application on request!"),this.runtimeRef._terminate());break;default:console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Received unknown command: "+t.cmd)}},setCallbacks:function(e,t){this.callbacks.meshBuilder=LoaderSupport.Validator.verifyInput(e,this.callbacks.meshBuilder),this.callbacks.onLoad=LoaderSupport.Validator.verifyInput(t,this.callbacks.onLoad)},run:function(e){if(LoaderSupport.Validator.isValid(this.queuedMessage))console.warn("Already processing message. Rejecting new run instruction");else{if(this.queuedMessage=e,this.started=!0,!LoaderSupport.Validator.isValid(this.callbacks.meshBuilder))throw'Unable to run as no "MeshBuilder" callback is set.';if(!LoaderSupport.Validator.isValid(this.callbacks.onLoad))throw'Unable to run as no "onLoad" callback is set.';"run"!==e.cmd&&(e.cmd="run"),LoaderSupport.Validator.isValid(e.logging)?(e.logging.enabled=!0===e.logging.enabled,e.logging.debug=!0===e.logging.debug):e.logging={enabled:!0,debug:!1},this._postMessage()}},_postMessage:function(){var content;LoaderSupport.Validator.isValid(this.queuedMessage)&&LoaderSupport.Validator.isValid(this.worker)&&(this.queuedMessage.data.input instanceof ArrayBuffer?(content=this.forceCopy?this.queuedMessage.data.input.slice(0):this.queuedMessage.data.input,this.worker.postMessage(this.queuedMessage,[content])):this.worker.postMessage(this.queuedMessage))},setTerminateRequested:function(e){this.terminateRequested=!0===e,this.terminateRequested&&LoaderSupport.Validator.isValid(this.worker)&&!LoaderSupport.Validator.isValid(this.queuedMessage)&&this.started&&(this.logging.enabled&&console.info("Worker is terminated immediately as it is not running!"),this._terminate())},_terminate:function(){this.worker.terminate(),this._reset()}},LoaderSupport.WorkerSupport.CodeSerializer={serializeObject:function(e,object){var t,r=e+" = {\n\n";for(var n in object)r+="string"==typeof(t=object[n])||t instanceof String?"\t"+n+': "'+(t=(t=t.replace("\n","\\n")).replace("\r","\\r"))+'",\n':t instanceof Array?"\t"+n+": ["+t+"],\n":"object"==typeof t?"\t"+n+": {},\n":"\t"+n+": "+t+",\n";return r+="}\n\n"},serializeClass:function(e,object,t,r,n,o,l){var c,h,d,i,f,m=[],v=[],y=[],x=null!=r;for(var w in Array.isArray(n)||(n=[]),Array.isArray(o)||(o=null),Array.isArray(l)||(l=[]),object.prototype)c=(h=object.prototype[w]).toString(),"constructor"===w?d=e+" = "+c+";\n\n":"function"==typeof h&&n.indexOf(w)<0&&(null===o||o.indexOf(w)>=0)&&((f=l[w])&&f.fullName===e+".prototype."+w&&(c=f.code),x?m.push(e+".prototype."+w+" = "+c+";\n\n"):m.push("\t"+w+": "+c+",\n\n"));for(var w in object)"function"==typeof(h=object[w])?n.indexOf(w)<0&&(null===o||o.indexOf(w)>=0)&&(c=(f=l[w])&&f.fullName===e+"."+w?f.code:h.toString(),y.push(e+"."+w+" = "+c+";\n\n")):(c="string"==typeof h||h instanceof String?'"'+h.toString()+'"':"object"==typeof h?"{}":h,v.push(e+"."+w+" = "+c+";\n"));null==d&&"function"==typeof object.prototype.constructor&&(d=e+" = "+object.prototype.constructor.toString().replace(t,""));var M=d+"\n\n";for(x&&(M+=e+".prototype = Object.create( "+r+".prototype );\n"),M+=e+".prototype.constructor = "+e+";\n",M+="\n\n",i=0;i<v.length;i++)M+=v[i];for(M+="\n\n",i=0;i<y.length;i++)M+=y[i];if(M+="\n\n",x)for(i=0;i<m.length;i++)M+=m[i];else{for(M+=e+".prototype = {\n\n",i=0;i<m.length;i++)M+=m[i];M+="\n};"}return M+="\n\n"}},LoaderSupport.WorkerRunnerRefImpl=function(){this.getParentScope().addEventListener("message",function(e){this.processMessage(e.data)}.bind(this))},LoaderSupport.WorkerRunnerRefImpl.runnerName="LoaderSupport.WorkerRunnerRefImpl",LoaderSupport.WorkerRunnerRefImpl.prototype={constructor:LoaderSupport.WorkerRunnerRefImpl,getParentScope:function(){return self},applyProperties:function(e,t){var r,n,o;for(r in t)n="set"+r.substring(0,1).toLocaleUpperCase()+r.substring(1),o=t[r],"function"==typeof e[n]?e[n](o):e.hasOwnProperty(r)&&(e[r]=o)},processMessage:function(e){if("run"===e.cmd){var t=this.getParentScope(),r={callbackMeshBuilder:function(e){t.postMessage(e)},callbackProgress:function(text){e.logging.enabled&&e.logging.debug&&console.debug("WorkerRunner: progress: "+text)}},n=new Parser;"function"==typeof n.setLogging&&n.setLogging(e.logging.enabled,e.logging.debug),this.applyProperties(n,e.params),this.applyProperties(n,e.materials),this.applyProperties(n,r),n.workerScope=t,n.parse(e.data.input,e.data.options),e.logging.enabled&&console.log("WorkerRunner: Run complete!"),r.callbackMeshBuilder({cmd:"complete",msg:"WorkerRunner completed run."})}else console.error("WorkerRunner: Received unknown command: "+e.cmd)}},LoaderSupport.NodeWorkerRunnerRefImpl=function(){this.runnerName="LoaderSupport.NodeWorkerRunnerRefImpl",this.getParentScope().onmessage=this.processMessage.bind(this)},LoaderSupport.NodeWorkerRunnerRefImpl.prototype=Object.create(LoaderSupport.WorkerRunnerRefImpl.prototype),LoaderSupport.NodeWorkerRunnerRefImpl.prototype.constructor=LoaderSupport.NodeWorkerRunnerRefImpl,LoaderSupport.NodeWorkerRunnerRefImpl.runnerName="LoaderSupport.NodeWorkerRunnerRefImpl",LoaderSupport.NodeWorkerRunnerRefImpl.prototype={getParentScope:function(){var _require=eval("require");return _require("worker_threads").parentPort}},LoaderSupport.WorkerSupport.NodeLoaderWorker=function(){LoaderSupport.WorkerSupport.LoaderWorker.call(this)},LoaderSupport.WorkerSupport.NodeLoaderWorker.prototype=Object.create(LoaderSupport.WorkerSupport.LoaderWorker.prototype),LoaderSupport.WorkerSupport.NodeLoaderWorker.prototype.constructor=LoaderSupport.WorkerSupport.NodeLoaderWorker,LoaderSupport.WorkerSupport.NodeLoaderWorker.checkSupport=function(){try{var _require=eval("require");_require.resolve("worker_threads")}catch(e){return"This version of Node does not support web workers!"}},LoaderSupport.WorkerSupport.NodeLoaderWorker.prototype.initWorker=function(code,runnerImplName){var supportError=this.checkSupport();if(supportError)throw supportError;this.runnerImplName=runnerImplName;var _require=eval("require"),Worker=_require("worker_threads").Worker;this.worker=new Worker(code,{eval:!0}),this.worker.onmessage=this._receiveWorkerMessage,this.worker.runtimeRef=this,this._postMessage()},LoaderSupport.WorkerDirector=function(e){if(console.info("Using LoaderSupport.WorkerDirector version: "+LoaderSupport.WorkerDirector.LOADER_WORKER_DIRECTOR_VERSION),this.logging={enabled:!0,debug:!1},this.maxQueueSize=LoaderSupport.WorkerDirector.MAX_QUEUE_SIZE,this.maxWebWorkers=LoaderSupport.WorkerDirector.MAX_WEB_WORKER,this.crossOrigin=null,!LoaderSupport.Validator.isValid(e))throw"Provided invalid classDef: "+e;this.workerDescription={classDef:e,globalCallbacks:{},workerSupports:{},forceWorkerDataCopy:!0},this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0,this.callbackOnFinishedProcessing=null},LoaderSupport.WorkerDirector.LOADER_WORKER_DIRECTOR_VERSION="2.3.0",LoaderSupport.WorkerDirector.MAX_WEB_WORKER=16,LoaderSupport.WorkerDirector.MAX_QUEUE_SIZE=2048,LoaderSupport.WorkerDirector.prototype={constructor:LoaderSupport.WorkerDirector,setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},getMaxQueueSize:function(){return this.maxQueueSize},getMaxWebWorkers:function(){return this.maxWebWorkers},setCrossOrigin:function(e){this.crossOrigin=e},setForceWorkerDataCopy:function(e){this.workerDescription.forceWorkerDataCopy=!0===e},prepareWorkers:function(e,t,r){LoaderSupport.Validator.isValid(e)&&(this.workerDescription.globalCallbacks=e),this.maxQueueSize=Math.min(t,LoaderSupport.WorkerDirector.MAX_QUEUE_SIZE),this.maxWebWorkers=Math.min(r,LoaderSupport.WorkerDirector.MAX_WEB_WORKER),this.maxWebWorkers=Math.min(this.maxWebWorkers,this.maxQueueSize),this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0;for(var n=0;n<this.maxWebWorkers;n++){var o=new LoaderSupport.WorkerSupport;o.setLogging(this.logging.enabled,this.logging.debug),o.setForceWorkerDataCopy(this.workerDescription.forceWorkerDataCopy),this.workerDescription.workerSupports[n]={instanceNo:n,inUse:!1,terminateRequested:!1,workerSupport:o,loader:null}}},enqueueForRun:function(e){this.instructionQueue.length<this.maxQueueSize&&this.instructionQueue.push(e)},isRunning:function(){var e=Object.keys(this.workerDescription.workerSupports);return this.instructionQueue.length>0&&this.instructionQueuePointer<this.instructionQueue.length||e.length>0},processQueue:function(){var e,t;for(var r in this.workerDescription.workerSupports)(t=this.workerDescription.workerSupports[r]).inUse||(this.instructionQueuePointer<this.instructionQueue.length?(e=this.instructionQueue[this.instructionQueuePointer],this._kickWorkerRun(e,t),this.instructionQueuePointer++):this._deregister(t));this.isRunning()||null===this.callbackOnFinishedProcessing||(this.callbackOnFinishedProcessing(),this.callbackOnFinishedProcessing=null)},_kickWorkerRun:function(e,t){t.inUse=!0,t.workerSupport.setTerminateRequested(t.terminateRequested),this.logging.enabled&&console.info("\nAssigning next item from queue to worker (queue length: "+this.instructionQueue.length+")\n\n");var r=LoaderSupport.Validator,n=this,o=e.getCallbacks(),l=this.workerDescription.globalCallbacks;t.loader=this._buildLoader(t.instanceNo);var c=new LoaderSupport.Callbacks;c.setCallbackOnLoad((function(e){r.isValid(l.onLoad)&&l.onLoad(e),r.isValid(o.onLoad)&&o.onLoad(e),n.objectsCompleted++,t.inUse=!1,n.processQueue()})),c.setCallbackOnProgress((function(e){r.isValid(l.onProgress)&&l.onProgress(e),r.isValid(o.onProgress)&&o.onProgress(e)})),c.setCallbackOnReportError((function(e){var c=!0;r.isValid(l.onReportError)&&(c=l.onReportError(t,e)),r.isValid(o.onReportError)&&(c=o.onReportError(t,e)),r.isValid(l.onReportError)||r.isValid(o.onReportError)||(console.error("Loader reported an error: "),console.error(e)),c&&(t.inUse=!1,n.processQueue())})),c.setCallbackOnMeshAlter((function(e,t){return r.isValid(l.onMeshAlter)&&(t=l.onMeshAlter(e,t)),r.isValid(o.onMeshAlter)&&(t=l.onMeshAlter(e,t)),t})),c.setCallbackOnLoadMaterials((function(e){return r.isValid(l.onLoadMaterials)&&(e=l.onLoadMaterials(e)),r.isValid(o.onLoadMaterials)&&(e=o.onLoadMaterials(e)),e})),e.callbacks=c,t.loader.run(e,t.workerSupport)},_buildLoader:function(e){var t=this.workerDescription.classDef,r=Object.create(t.prototype);if(t.call(r,DefaultLoadingManager),!r.hasOwnProperty("instanceNo"))throw t.name+' has no property "instanceNo".';if(r.instanceNo=e,!r.hasOwnProperty("workerSupport"))throw t.name+' has no property "workerSupport".';if("function"!=typeof r.run)throw t.name+' has no function "run".';return r.hasOwnProperty("callbacks")&&LoaderSupport.Validator.isValid(r.callbacks)||(console.warn(t.name+' has an invalid property "callbacks". Will change to "LoaderSupport.Callbacks"'),r.callbacks=new LoaderSupport.Callbacks),r},_deregister:function(e){if(LoaderSupport.Validator.isValid(e)){e.workerSupport.setTerminateRequested(!0),this.logging.enabled&&console.info("Requested termination of worker #"+e.instanceNo+".");var t=e.loader.callbacks;LoaderSupport.Validator.isValid(t.onProgress)&&t.onProgress({detail:{text:""}}),delete this.workerDescription.workerSupports[e.instanceNo]}},tearDown:function(e){for(var t in this.logging.enabled&&console.info("WorkerDirector received the deregister call. Terminating all workers!"),this.instructionQueuePointer=this.instructionQueue.length,this.callbackOnFinishedProcessing=LoaderSupport.Validator.verifyInput(e,null),this.workerDescription.workerSupports)this.workerDescription.workerSupports[t].terminateRequested=!0}};var MD2Loader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager},normalData;MD2Loader.prototype={constructor:MD2Loader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(e){t(o.parse(e))}),r,n)},setPath:function(e){return this.path=e,this},parse:(normalData=[[-.525731,0,.850651],[-.442863,.238856,.864188],[-.295242,0,.955423],[-.309017,.5,.809017],[-.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-.681718,.147621,.716567],[-.809017,.309017,.5],[-.587785,.425325,.688191],[-.850651,.525731,0],[-.864188,.442863,.238856],[-.716567,.681718,.147621],[-.688191,.587785,.425325],[-.5,.809017,.309017],[-.238856,.864188,.442863],[-.425325,.688191,.587785],[-.716567,.681718,-.147621],[-.5,.809017,-.309017],[-.525731,.850651,0],[0,.850651,-.525731],[-.238856,.864188,-.442863],[0,.955423,-.295242],[-.262866,.951056,-.16246],[0,1,0],[0,.955423,.295242],[-.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-.442863],[.262866,.951056,-.16246],[.5,.809017,-.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-.525731,0],[.955423,-.295242,0],[.864188,-.442863,.238856],[.951056,-.16246,.262866],[.809017,-.309017,.5],[.681718,-.147621,.716567],[.850651,0,.525731],[.864188,.442863,-.238856],[.809017,.309017,-.5],[.951056,.16246,-.262866],[.525731,0,-.850651],[.681718,.147621,-.716567],[.681718,-.147621,-.716567],[.850651,0,-.525731],[.809017,-.309017,-.5],[.864188,-.442863,-.238856],[.951056,-.16246,-.262866],[.147621,.716567,-.681718],[.309017,.5,-.809017],[.425325,.688191,-.587785],[.442863,.238856,-.864188],[.587785,.425325,-.688191],[.688191,.587785,-.425325],[-.147621,.716567,-.681718],[-.309017,.5,-.809017],[0,.525731,-.850651],[-.525731,0,-.850651],[-.442863,.238856,-.864188],[-.295242,0,-.955423],[-.16246,.262866,-.951056],[0,0,-1],[.295242,0,-.955423],[.16246,.262866,-.951056],[-.442863,-.238856,-.864188],[-.309017,-.5,-.809017],[-.16246,-.262866,-.951056],[0,-.850651,-.525731],[-.147621,-.716567,-.681718],[.147621,-.716567,-.681718],[0,-.525731,-.850651],[.309017,-.5,-.809017],[.442863,-.238856,-.864188],[.16246,-.262866,-.951056],[.238856,-.864188,-.442863],[.5,-.809017,-.309017],[.425325,-.688191,-.587785],[.716567,-.681718,-.147621],[.688191,-.587785,-.425325],[.587785,-.425325,-.688191],[0,-.955423,-.295242],[0,-1,0],[.262866,-.951056,-.16246],[0,-.850651,.525731],[0,-.955423,.295242],[.238856,-.864188,.442863],[.262866,-.951056,.16246],[.5,-.809017,.309017],[.716567,-.681718,.147621],[.525731,-.850651,0],[-.238856,-.864188,-.442863],[-.5,-.809017,-.309017],[-.262866,-.951056,-.16246],[-.850651,-.525731,0],[-.716567,-.681718,-.147621],[-.716567,-.681718,.147621],[-.525731,-.850651,0],[-.5,-.809017,.309017],[-.238856,-.864188,.442863],[-.262866,-.951056,.16246],[-.864188,-.442863,.238856],[-.809017,-.309017,.5],[-.688191,-.587785,.425325],[-.681718,-.147621,.716567],[-.442863,-.238856,.864188],[-.587785,-.425325,.688191],[-.309017,-.5,.809017],[-.147621,-.716567,.681718],[-.425325,-.688191,.587785],[-.16246,-.262866,.951056],[.442863,-.238856,.864188],[.16246,-.262866,.951056],[.309017,-.5,.809017],[.147621,-.716567,.681718],[0,-.525731,.850651],[.425325,-.688191,.587785],[.587785,-.425325,.688191],[.688191,-.587785,.425325],[-.955423,.295242,0],[-.951056,.16246,.262866],[-1,0,0],[-.850651,0,.525731],[-.955423,-.295242,0],[-.951056,-.16246,.262866],[-.864188,.442863,-.238856],[-.951056,.16246,-.262866],[-.809017,.309017,-.5],[-.864188,-.442863,-.238856],[-.951056,-.16246,-.262866],[-.809017,-.309017,-.5],[-.681718,.147621,-.716567],[-.681718,-.147621,-.716567],[-.850651,0,-.525731],[-.688191,.587785,-.425325],[-.587785,.425325,-.688191],[-.425325,.688191,-.587785],[-.425325,-.688191,-.587785],[-.587785,-.425325,-.688191],[-.688191,-.587785,-.425325]],function(e){console.time("MD2Loader");for(var data=new DataView(e),header={},t=["ident","version","skinwidth","skinheight","framesize","num_skins","num_vertices","num_st","num_tris","num_glcmds","num_frames","offset_skins","offset_st","offset_tris","offset_frames","offset_glcmds","offset_end"],i=0;i<t.length;i++)header[t[i]]=data.getInt32(4*i,!0);if(844121161===header.ident&&8===header.version){if(header.offset_end===data.byteLength){for(var r=new BufferGeometry,n=[],o=header.offset_st,l=(i=0,header.num_st);i<l;i++){var u=data.getInt16(o+0,!0),c=data.getInt16(o+2,!0);n.push(u/header.skinwidth,1-c/header.skinheight),o+=4}o=header.offset_tris;var h=[],d=[];for(i=0,l=header.num_tris;i<l;i++)h.push(data.getUint16(o+0,!0),data.getUint16(o+2,!0),data.getUint16(o+4,!0)),d.push(data.getUint16(o+6,!0),data.getUint16(o+8,!0),data.getUint16(o+10,!0)),o+=12;var f=new Vector3,m=new Vector3,v=[],y=[];for(o=header.offset_frames,i=0,l=header.num_frames;i<l;i++){m.set(data.getFloat32(o+0,!0),data.getFloat32(o+4,!0),data.getFloat32(o+8,!0)),f.set(data.getFloat32(o+12,!0),data.getFloat32(o+16,!0),data.getFloat32(o+20,!0)),o+=24;for(var x=0;x<16;x++){var w=data.getUint8(o+x,!0);if(0===w)break;v[x]=w}var M={name:String.fromCharCode.apply(null,v),vertices:[],normals:[]};for(o+=16,x=0;x<header.num_vertices;x++){var S=data.getUint8(o++,!0),A=data.getUint8(o++,!0),T=data.getUint8(o++,!0),_=normalData[data.getUint8(o++,!0)];S=S*m.x+f.x,A=A*m.y+f.y,T=T*m.z+f.z,M.vertices.push(S,T,A),M.normals.push(_[0],_[2],_[1])}y.push(M)}var L=[],C=[],N=[],P=y[0].vertices,E=y[0].normals;for(i=0,l=h.length;i<l;i++){S=P[V=3*h[i]],A=P[V+1],T=P[V+2],L.push(S,A,T);var D=E[V],F=E[V+1],R=E[V+2];C.push(D,F,R),u=n[V=2*d[i]],c=n[V+1],N.push(u,c)}r.addAttribute("position",new Float32BufferAttribute(L,3)),r.addAttribute("normal",new Float32BufferAttribute(C,3)),r.addAttribute("uv",new Float32BufferAttribute(N,2));var O=[],B=[];for(i=0,l=y.length;i<l;i++){var I=(M=y[i]).name;if(M.vertices.length>0){L=[],x=0;for(var U=h.length;x<U;x++){var V=3*h[x];S=M.vertices[V],A=M.vertices[V+1],T=M.vertices[V+2],L.push(S,A,T)}var k=new Float32BufferAttribute(L,3);k.name=I,O.push(k)}if(M.normals.length>0){for(C=[],x=0,U=h.length;x<U;x++)V=3*h[x],D=M.normals[V],F=M.normals[V+1],R=M.normals[V+2],C.push(D,F,R);var G=new Float32BufferAttribute(C,3);G.name=I,B.push(G)}}return r.morphAttributes.position=O,r.morphAttributes.normal=B,r.animations=AnimationClip.CreateClipsFromMorphTargetSequences(y,10),console.timeEnd("MD2Loader"),r}console.error("Corrupted MD2 file")}else console.error("Not a valid MD2 file")})};var MMDLoader=function(){function e(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.loader=new FileLoader(this.manager),this.parser=null,this.meshBuilder=new r(this.manager),this.animationBuilder=new l}e.prototype={constructor:e,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},setAnimationPath:function(e){return this.animationPath=e,this},setPath:function(path){return this.path=path,this},setResoucePath:function(e){return this.resourcePath=e,this},load:function(e,t,r,n){var o,l=this.meshBuilder.setCrossOrigin(this.crossOrigin);o=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:LoaderUtils.extractUrlBase(e);var c=this._extractExtension(e).toLowerCase();"pmd"===c||"pmx"===c?this["pmd"===c?"loadPMD":"loadPMX"](e,(function(data){t(l.build(data,o,r,n))}),r,n):n&&n(new Error("MMDLoader: Unknown model file extension ."+c+"."))},loadAnimation:function(e,object,t,r,n){var o=this.animationBuilder;this.loadVMD(e,(function(e){t(object.isCamera?o.buildCameraAnimation(e):o.build(e,object))}),r,n)},loadWithAnimation:function(e,t,r,n,o){var l=this;this.load(e,(function(e){l.loadAnimation(t,e,(function(t){r({mesh:e,animation:t})}),n,o)}),n,o)},loadPMD:function(e,t,r,n){var o=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").load(e,(function(e){t(o.parsePmd(e,!0))}),r,n)},loadPMX:function(e,t,r,n){var o=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").load(e,(function(e){t(o.parsePmx(e,!0))}),r,n)},loadVMD:function(e,t,r,n){var o=Array.isArray(e)?e:[e],l=[],c=o.length,h=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer");for(var i=0,d=o.length;i<d;i++)this.loader.load(o[i],(function(e){l.push(h.parseVmd(e,!0)),l.length===c&&t(h.mergeVmds(l))}),r,n)},loadVPD:function(e,t,r,n,o){var l=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").load(e,(function(text){r(l.parseVpd(text,!0))}),n,o)},_extractExtension:function(e){var t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)},_getParser:function(){if(null===this.parser){if("undefined"==typeof MMDParser)throw new Error("MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser");this.parser=new MMDParser.Parser}return this.parser}};var t=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="];function r(e){this.geometryBuilder=new n,this.materialBuilder=new o(e)}function n(){}function o(e){this.manager=e,this.textureLoader=new TextureLoader(this.manager),this.tgaLoader=null}function l(){}function c(e,t,r,n,o){Interpolant.call(this,e,t,r,n),this.interpolationParams=o}return r.prototype={constructor:r,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},build:function(data,e,t,r){var n=this.geometryBuilder.build(data),o=new SkinnedMesh(n,this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(e).build(data,n,t,r)),l=new Skeleton(function(e){var t,r,i,n,o=e.geometry,l=[];if(o&&void 0!==o.bones){for(i=0,n=o.bones.length;i<n;i++)r=o.bones[i],t=new Bone,l.push(t),t.name=r.name,t.position.fromArray(r.pos),t.quaternion.fromArray(r.rotq),void 0!==r.scl&&t.scale.fromArray(r.scl);for(i=0,n=o.bones.length;i<n;i++)-1!==(r=o.bones[i]).parent&&null!==r.parent&&void 0!==l[r.parent]?l[r.parent].add(l[i]):e.add(l[i])}return e.updateMatrixWorld(!0),l}(o));return o.bind(l),o}},n.prototype={constructor:n,build:function(data){for(var e=[],t=[],r=[],n=[],o=[],l=[],c=[],h=[],d=[],f=[],m=[],v=[],y=[],x=[],w=0,M={},i=0;i<data.metadata.vertexCount;i++){for(var S=data.vertices[i],A=0,T=S.position.length;A<T;A++)e.push(S.position[A]);for(A=0,T=S.normal.length;A<T;A++)r.push(S.normal[A]);for(A=0,T=S.uv.length;A<T;A++)t.push(S.uv[A]);for(A=0;A<4;A++)c.push(S.skinIndices.length-1>=A?S.skinIndices[A]:0);for(A=0;A<4;A++)h.push(S.skinWeights.length-1>=A?S.skinWeights[A]:0)}for(i=0;i<data.metadata.faceCount;i++){var _=data.faces[i];for(A=0,T=_.indices.length;A<T;A++)n.push(_.indices[A])}for(i=0;i<data.metadata.materialCount;i++){var L=data.materials[i];o.push({offset:3*w,count:3*L.faceCount}),w+=L.faceCount}for(i=0;i<data.metadata.rigidBodyCount;i++){var body=data.rigidBodies[i],C=M[body.boneIndex];C=void 0===C?body.type:Math.max(body.type,C),M[body.boneIndex]=C}for(i=0;i<data.metadata.boneCount;i++){-1!==(W={parent:(R=data.bones[i]).parentIndex,name:R.name,pos:R.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==M[i]?M[i]:-1}).parent&&(W.pos[0]-=data.bones[W.parent].position[0],W.pos[1]-=data.bones[W.parent].position[1],W.pos[2]-=data.bones[W.parent].position[2]),l.push(W)}if("pmd"===data.metadata.format)for(i=0;i<data.metadata.ikCount;i++){var param={target:(N=data.iks[i]).target,effector:N.effector,iteration:N.iteration,maxAngle:4*N.maxAngle,links:[]};for(A=0,T=N.links.length;A<T;A++){(link={}).index=N.links[A].index,link.enabled=!0,data.bones[link.index].name.indexOf("ひざ")>=0&&(link.limitation=new Vector3(1,0,0)),param.links.push(link)}m.push(param)}else for(i=0;i<data.metadata.boneCount;i++){var N;if(void 0!==(N=data.bones[i].ik)){for(param={target:i,effector:N.effector,iteration:N.iteration,maxAngle:N.maxAngle,links:[]},A=0,T=N.links.length;A<T;A++){var link;if((link={}).index=N.links[A].index,link.enabled=!0,1===N.links[A].angleLimitation){var P=N.links[A].lowerLimitationAngle,E=N.links[A].upperLimitationAngle,D=-E[0],F=-E[1];E[0]=-P[0],E[1]=-P[1],P[0]=D,P[1]=F,link.rotationMin=(new Vector3).fromArray(P),link.rotationMax=(new Vector3).fromArray(E)}param.links.push(link)}m.push(param)}}if("pmx"===data.metadata.format){for(i=0;i<data.metadata.boneCount;i++){var R,O=(R=data.bones[i]).grant;if(void 0!==O){param={index:i,parentIndex:O.parentIndex,ratio:O.ratio,isLocal:O.isLocal,affectRotation:O.affectRotation,affectPosition:O.affectPosition,transformationClass:R.transformationClass};v.push(param)}}v.sort((function(a,b){return a.transformationClass-b.transformationClass}))}function B(e,t,r){for(var i=0;i<t.elementCount;i++){var n,element=t.elements[i];n="pmd"===data.metadata.format?data.morphs[0].elements[element.index].index:element.index,e.array[3*n+0]+=element.position[0]*r,e.array[3*n+1]+=element.position[1]*r,e.array[3*n+2]+=element.position[2]*r}}for(i=0;i<data.metadata.morphCount;i++){var I=data.morphs[i],U={name:I.name},V=new Float32BufferAttribute(3*data.metadata.vertexCount,3);V.name=I.name;for(A=0;A<3*data.metadata.vertexCount;A++)V.array[A]=e[A];if("pmd"===data.metadata.format)0!==i&&B(V,I,1);else if(0===I.type)for(A=0;A<I.elementCount;A++){var k=data.morphs[I.elements[A].index],G=I.elements[A].ratio;1===k.type&&B(V,k,G)}else 1===I.type?B(V,I,1):2===I.type||3===I.type||4===I.type||5===I.type||6===I.type||7===I.type||I.type;d.push(U),f.push(V)}for(i=0;i<data.metadata.rigidBodyCount;i++){var z=data.rigidBodies[i];U={};for(var j in z)U[j]=z[j];if("pmx"===data.metadata.format&&-1!==U.boneIndex){var W=data.bones[U.boneIndex];U.position[0]-=W.position[0],U.position[1]-=W.position[1],U.position[2]-=W.position[2]}y.push(U)}for(i=0;i<data.metadata.constraintCount;i++){var H=data.constraints[i];U={};for(var j in H)U[j]=H[j];var X=y[U.rigidBodyIndex1],Y=y[U.rigidBodyIndex2];0!==X.type&&2===Y.type&&-1!==X.boneIndex&&-1!==Y.boneIndex&&data.bones[Y.boneIndex].parentIndex===X.boneIndex&&(Y.type=1),x.push(U)}var Q=new BufferGeometry;Q.addAttribute("position",new Float32BufferAttribute(e,3)),Q.addAttribute("normal",new Float32BufferAttribute(r,3)),Q.addAttribute("uv",new Float32BufferAttribute(t,2)),Q.addAttribute("skinIndex",new Uint16BufferAttribute(c,4)),Q.addAttribute("skinWeight",new Float32BufferAttribute(h,4)),Q.setIndex(n);i=0;for(var K=o.length;i<K;i++)Q.addGroup(o[i].offset,o[i].count,i);return Q.bones=l,Q.morphTargets=d,Q.morphAttributes.position=f,Q.userData.MMD={bones:l,iks:m,grants:v,rigidBodies:y,constraints:x,format:data.metadata.format},Q.computeBoundingSphere(),Q}},o.prototype={constructor:o,crossOrigin:"anonymous",resourcePath:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},setResourcePath:function(e){return this.resourcePath=e,this},build:function(data,e,t,r){var n=[],o={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(var i=0;i<data.metadata.materialCount;i++){var l=data.materials[i],c={userData:{}};if(void 0!==l.name&&(c.name=l.name),c.color=(new Color).fromArray(l.diffuse),c.opacity=l.diffuse[3],c.specular=(new Color).fromArray(l.specular),c.emissive=(new Color).fromArray(l.ambient),c.shininess=Math.max(l.shininess,1e-4),c.transparent=1!==c.opacity,c.skinning=e.bones.length>0,c.morphTargets=e.morphTargets.length>0,c.lights=!0,c.fog=!0,c.blending=CustomBlending,c.blendSrc=SrcAlphaFactor,c.blendDst=OneMinusSrcAlphaFactor,c.blendSrcAlpha=SrcAlphaFactor,c.blendDstAlpha=DstAlphaFactor,"pmx"===data.metadata.format&&1==(1&l.flag)?c.side=DoubleSide:c.side=1===c.opacity?FrontSide:DoubleSide,"pmd"===data.metadata.format){if(l.fileName){var h=l.fileName.split("*");if(c.map=this._loadTexture(h[0],o),h.length>1){var d=h[1].slice(-4).toLowerCase();c.envMap=this._loadTexture(h[1],o,{sphericalReflectionMapping:!0}),c.combine=".sph"===d?MultiplyOperation:AddOperation}}var f=-1===l.toonIndex?"toon00.bmp":data.toonTextures[l.toonIndex].fileName;c.gradientMap=this._loadTexture(f,o,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(f)}),c.userData.outlineParameters={thickness:1===l.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===l.edgeFlag}}else{var m;-1!==l.textureIndex&&(c.map=this._loadTexture(data.textures[l.textureIndex],o)),-1===l.envTextureIndex||1!==l.envFlag&&2!=l.envFlag||(c.envMap=this._loadTexture(data.textures[l.envTextureIndex],o,{sphericalReflectionMapping:!0}),c.combine=1===l.envFlag?MultiplyOperation:AddOperation),-1===l.toonIndex||0!==l.toonFlag?(f="toon"+("0"+(l.toonIndex+1)).slice(-2)+".bmp",m=!0):(f=data.textures[l.toonIndex],m=!1),c.gradientMap=this._loadTexture(f,o,{isToonTexture:!0,isDefaultToonTexture:m}),c.userData.outlineParameters={thickness:l.edgeSize/300,color:l.edgeColor.slice(0,3),alpha:l.edgeColor[3],visible:0!=(16&l.flag)&&l.edgeSize>0}}void 0!==c.map&&(c.transparent||this._checkImageTransparency(c.map,e,i),c.emissive.multiplyScalar(.2)),n.push(new MeshToonMaterial(c))}if("pmx"===data.metadata.format){function v(e,t){for(var i=0,r=e.length;i<r;i++){var element=e[i];if(-1!==element.index){var n=t[element.index];n.opacity!==element.diffuse[3]&&(n.transparent=!0)}}}i=0;for(var y=data.morphs.length;i<y;i++){var x=data.morphs[i],w=x.elements;if(0===x.type)for(var M=0,S=w.length;M<S;M++){var A=data.morphs[w[M].index];8===A.type&&v(A.elements,n)}else 8===x.type&&v(w,n)}}return n},_getTGALoader:function(){if(null===this.tgaLoader){if(void 0===TGALoader)throw new Error("MMDLoader: Import TGALoader");this.tgaLoader=new TGALoader(this.manager)}return this.tgaLoader},_isDefaultToonTexture:function(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)},_loadTexture:function(e,r,n,o,l){var c,h=this;if(!0===(n=n||{}).isDefaultToonTexture){var d;try{d=parseInt(e.match("toon([0-9]{2}).bmp$")[1])}catch(t){console.warn("MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),d=0}c=t[d]}else c=this.resourcePath+e;if(void 0!==r[c])return r[c];var f=Loader.Handlers.get(c);null===f&&(f=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);var m=f.load(c,(function(e){!0===n.isToonTexture&&(e.image=h._getRotatedImage(e.image)),e.flipY=!1,e.wrapS=RepeatWrapping,e.wrapT=RepeatWrapping;for(var i=0;i<m.readyCallbacks.length;i++)m.readyCallbacks[i](m);delete m.readyCallbacks}),o,l);return!0===n.sphericalReflectionMapping&&(m.mapping=SphericalReflectionMapping),m.readyCallbacks=[],r[c]=m,m},_getRotatedImage:function(image){var canvas=document.createElement("canvas"),e=canvas.getContext("2d"),t=image.width,r=image.height;return canvas.width=t,canvas.height=r,e.clearRect(0,0,t,r),e.translate(t/2,r/2),e.rotate(.5*Math.PI),e.translate(-t/2,-r/2),e.drawImage(image,0,0),e.getImageData(0,0,t,r)},_checkImageTransparency:function(map,e,t){map.readyCallbacks.push((function(r){function n(image,e){var t=image.width,r=image.height,n=Math.round(e.x*t)%t,o=Math.round(e.y*r)%r;n<0&&(n+=t),o<0&&(o+=r);var l=o*t+n;return image.data[4*l+3]}var o=void 0!==r.image.data?r.image:function(image){var canvas=document.createElement("canvas");canvas.width=image.width,canvas.height=image.height;var e=canvas.getContext("2d");return e.drawImage(image,0,0),e.getImageData(0,0,canvas.width,canvas.height)}(r.image),l=e.groups[t];(function(image,e,t){var r=image.width,o=image.height;if(image.data.length/(r*o)!=4)return!1;for(var i=0;i<t.length;i+=3){for(var l={x:0,y:0},c=0;c<3;c++){var h=t[3*i+c],d={x:e[2*h+0],y:e[2*h+1]};if(n(image,d)<253)return!0;l.x+=d.x,l.y+=d.y}if(l.x/=3,l.y/=3,n(image,l)<253)return!0}return!1})(o,e.attributes.uv.array,e.index.array.slice(l.start,l.start+l.count))&&(map.transparent=!0)}))}},l.prototype={constructor:l,build:function(e,t){for(var r=this.buildSkeletalAnimation(e,t).tracks,n=this.buildMorphAnimation(e,t).tracks,i=0,o=n.length;i<o;i++)r.push(n[i]);return new AnimationClip("",-1,r)},buildSkeletalAnimation:function(e,t){function r(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)}for(var n=[],o={},l=t.skeleton.bones,c={},i=0,h=l.length;i<h;i++)c[l[i].name]=!0;for(i=0;i<e.metadata.motionCount;i++){var d=e.motions[i],f=d.boneName;void 0!==c[f]&&(o[f]=o[f]||[],o[f].push(d))}for(var m in o){var v=o[m];v.sort((function(a,b){return a.frameNum-b.frameNum}));var y=[],x=[],w=[],M=[],S=[],A=t.skeleton.getBoneByName(m).position.toArray();for(i=0,h=v.length;i<h;i++){var time=v[i].frameNum/30,T=v[i].position,_=v[i].rotation,L=v[i].interpolation;y.push(time);for(var C=0;C<3;C++)x.push(A[C]+T[C]);for(C=0;C<4;C++)w.push(_[C]);for(C=0;C<3;C++)r(M,L,C);r(S,L,3)}var N=".bones["+m+"]";n.push(this._createTrack(N+".position",VectorKeyframeTrack,y,x,M)),n.push(this._createTrack(N+".quaternion",QuaternionKeyframeTrack,y,w,S))}return new AnimationClip("",-1,n)},buildMorphAnimation:function(e,t){for(var r=[],n={},o=t.morphTargetDictionary,i=0;i<e.metadata.morphCount;i++){var l=e.morphs[i],c=l.morphName;void 0!==o[c]&&(n[c]=n[c]||[],n[c].push(l))}for(var h in n){var d=n[h];d.sort((function(a,b){return a.frameNum-b.frameNum}));for(var f=[],m=[],v=(i=0,d.length);i<v;i++)f.push(d[i].frameNum/30),m.push(d[i].weight);r.push(new NumberKeyframeTrack(".morphTargetInfluences["+o[h]+"]",f,m))}return new AnimationClip("",-1,r)},buildCameraAnimation:function(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function r(e,q){e.push(q.x),e.push(q.y),e.push(q.z),e.push(q.w)}function n(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)}var o=[],l=void 0===e.cameras?[]:e.cameras.slice();l.sort((function(a,b){return a.frameNum-b.frameNum}));for(var c=[],h=[],d=[],f=[],m=[],v=[],y=[],x=[],w=[],M=new Quaternion,S=new Euler,A=new Vector3,T=new Vector3,i=0,_=l.length;i<_;i++){var L=l[i],time=L.frameNum/30,C=L.position,N=L.rotation,P=L.distance,E=L.fov,D=L.interpolation;c.push(time),A.set(0,0,-P),T.set(C[0],C[1],C[2]),S.set(-N[0],-N[1],-N[2]),M.setFromEuler(S),A.add(T),A.applyQuaternion(M),t(h,T),r(d,M),t(f,A),m.push(E);for(var F=0;F<3;F++)n(v,D,F);n(y,D,3);for(F=0;F<3;F++)n(x,D,4);n(w,D,5)}return(o=[]).push(this._createTrack("target.position",VectorKeyframeTrack,c,h,v)),o.push(this._createTrack(".quaternion",QuaternionKeyframeTrack,c,d,y)),o.push(this._createTrack(".position",VectorKeyframeTrack,c,f,x)),o.push(this._createTrack(".fov",NumberKeyframeTrack,c,m,w)),new AnimationClip("",-1,o)},_createTrack:function(e,t,r,n,o){if(r.length>2){r=r.slice(),n=n.slice(),o=o.slice();for(var l=n.length/r.length,h=o.length/r.length,d=1,f=2,m=r.length;f<m;f++){for(var i=0;i<l;i++)if(n[d*l+i]!==n[(d-1)*l+i]||n[d*l+i]!==n[f*l+i]){d++;break}if(f>d){r[d]=r[f];for(i=0;i<l;i++)n[d*l+i]=n[f*l+i];for(i=0;i<h;i++)o[d*h+i]=o[f*h+i]}}r.length=d+1,n.length=(d+1)*l,o.length=(d+1)*h}var track=new t(e,r,n);return track.createInterpolant=function(e){return new c(this.times,this.values,this.getValueSize(),e,new Float32Array(o))},track}},c.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:c,interpolate_:function(e,t,r,n){var o=this.resultBuffer,l=this.sampleValues,c=this.valueSize,h=this.interpolationParams,d=e*c,f=d-c,m=n-t<.05?0:(r-t)/(n-t);if(4===c){var v=h[4*e+0],y=h[4*e+1],x=h[4*e+2],w=h[4*e+3],M=this._calculate(v,y,x,w,m);Quaternion.slerpFlat(o,0,l,f,l,d,M)}else if(3===c)for(var i=0;i!==c;++i){v=h[12*e+4*i+0],y=h[12*e+4*i+1],x=h[12*e+4*i+2],w=h[12*e+4*i+3],M=this._calculate(v,y,x,w,m);o[i]=l[f+i]*(1-M)+l[d+i]*M}else{v=h[4*e+0],y=h[4*e+1],x=h[4*e+2],w=h[4*e+3],M=this._calculate(v,y,x,w,m);o[0]=l[f]*(1-M)+l[d]*M}return o},_calculate:function(e,t,r,n,o){for(var l,c,h,d=.5,f=d,s=1-f,m=Math,i=0;i<15;i++){var v=(l=3*s*s*f)*e+(c=3*s*f*f)*t+(h=f*f*f)-o;if(m.abs(v)<1e-5)break;d/=2,s=1-(f+=v<0?d:-d)}return l*r+c*n+h}}),e}(),MTLLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};MTLLoader.prototype={constructor:MTLLoader,load:function(e,t,r,n){var o=this,path=void 0===this.path?LoaderUtils.extractUrlBase(e):this.path,l=new FileLoader(this.manager);l.setPath(this.path),l.load(e,(function(text){t(o.parse(text,path))}),r,n)},setPath:function(path){return this.path=path,this},setResourcePath:function(path){return this.resourcePath=path,this},setTexturePath:function(path){return console.warn("MTLLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(path)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setMaterialOptions:function(e){return this.materialOptions=e,this},parse:function(text,path){for(var e=text.split("\n"),t={},r=/\s+/,n={},i=0;i<e.length;i++){var line=e[i];if(0!==(line=line.trim()).length&&"#"!==line.charAt(0)){var o=line.indexOf(" "),l=o>=0?line.substring(0,o):line;l=l.toLowerCase();var c=o>=0?line.substring(o+1):"";if(c=c.trim(),"newmtl"===l)t={name:c},n[c]=t;else if("ka"===l||"kd"===l||"ks"===l||"ke"===l){var h=c.split(r,3);t[l]=[parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])]}else t[l]=c}}var d=new MTLLoader.MaterialCreator(this.resourcePath||path,this.materialOptions);return d.setCrossOrigin(this.crossOrigin),d.setManager(this.manager),d.setMaterials(n),d}},MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e||"",this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:RepeatWrapping},MTLLoader.MaterialCreator.prototype={constructor:MTLLoader.MaterialCreator,crossOrigin:"anonymous",setCrossOrigin:function(e){return this.crossOrigin=e,this},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var n=e[r],o={};for(var l in t[r]=o,n){var c=!0,h=n[l],d=l.toLowerCase();switch(d){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(h=[h[0]/255,h[1]/255,h[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===h[0]&&0===h[1]&&0===h[2]&&(c=!1)}c&&(o[d]=h)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t=this,r=this.materialsInfo[e],n={name:e,side:this.side};function o(e,r){if(!n[e]){var o,l,c=t.getTextureParams(r,n),map=t.loadTexture((o=t.baseUrl,"string"!=typeof(l=c.url)||""===l?"":/^https?:\/\//i.test(l)?l:o+l));map.repeat.copy(c.scale),map.offset.copy(c.offset),map.wrapS=t.wrap,map.wrapT=t.wrap,n[e]=map}}for(var l in r){var c,h=r[l];if(""!==h)switch(l.toLowerCase()){case"kd":n.color=(new Color).fromArray(h);break;case"ks":n.specular=(new Color).fromArray(h);break;case"ke":n.emissive=(new Color).fromArray(h);break;case"map_kd":o("map",h);break;case"map_ks":o("specularMap",h);break;case"map_ke":o("emissiveMap",h);break;case"norm":o("normalMap",h);break;case"map_bump":case"bump":o("bumpMap",h);break;case"map_d":o("alphaMap",h),n.transparent=!0;break;case"ns":n.shininess=parseFloat(h);break;case"d":(c=parseFloat(h))<1&&(n.opacity=c,n.transparent=!0);break;case"tr":c=parseFloat(h),this.options&&this.options.invertTrProperty&&(c=1-c),c>0&&(n.opacity=1-c,n.transparent=!0)}}return this.materials[e]=new MeshPhongMaterial(n),this.materials[e]},getTextureParams:function(e,t){var r,n={scale:new Vector2(1,1),offset:new Vector2(0,0)},o=e.split(/\s+/);return(r=o.indexOf("-bm"))>=0&&(t.bumpScale=parseFloat(o[r+1]),o.splice(r,2)),(r=o.indexOf("-s"))>=0&&(n.scale.set(parseFloat(o[r+1]),parseFloat(o[r+2])),o.splice(r,4)),(r=o.indexOf("-o"))>=0&&(n.offset.set(parseFloat(o[r+1]),parseFloat(o[r+2])),o.splice(r,4)),n.url=o.join(" ").trim(),n},loadTexture:function(e,t,r,n,o){var l,c=Loader$1.Handlers.get(e),h=void 0!==this.manager?this.manager:DefaultLoadingManager;return null===c&&(c=new TextureLoader(h)),c.setCrossOrigin&&c.setCrossOrigin(this.crossOrigin),l=c.load(e,r,n,o),void 0!==t&&(l.mapping=t),l}};var NodeMaterialLoader=function(e,t){this.manager=void 0!==e?e:DefaultLoadingManager,this.nodes={},this.materials={},this.passes={},this.names={},this.library=t||{}};Object.assign(NodeMaterialLoader.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);return l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n),this},setPath:function(e){return this.path=e,this},getObjectByName:function(e){return this.names[e]},getObjectById:function(e){return this.library[e]||this.nodes[e]||this.materials[e]||this.passes[e]||this.names[e]},getNode:function(e){var object=this.getObjectById(e);return object||console.warn('Node "'+e+'" not found.'),object},resolve:function(e){switch(typeof e){case"boolean":case"number":return e;case"string":return/^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$/i.test(e)||this.library[e]?this.getNode(e):e;default:if(Array.isArray(e))for(var i=0;i<e.length;i++)e[i]=this.resolve(e[i]);else for(var t in e)"uuid"!==t&&(e[t]=this.resolve(e[t]))}return e},declare:function(e){var t,r,object;for(t in e.nodes)r=e.nodes[t],object=new THREE[r.nodeType+"Node"],r.name&&(object.name=r.name,this.names[object.name]=object),this.nodes[t]=object;for(t in e.materials)r=e.materials[t],object=new THREE[r.type],r.name&&(object.name=r.name,this.names[object.name]=object),this.materials[t]=object;for(t in e.passes)r=e.passes[t],object=new THREE[r.type],r.name&&(object.name=r.name,this.names[object.name]=object),this.passes[t]=object;return e.material&&(this.material=this.materials[e.material]),e.pass&&(this.pass=this.passes[e.pass]),e},parse:function(e){var t;for(t in(e=this.resolve(this.declare(e))).nodes)this.nodes[t].copy(e.nodes[t]);for(t in e.materials)this.materials[t].copy(e.materials[t]);for(t in e.passes)this.passes[t].copy(e.passes[t]);return this.material||this.pass||this}});var OBJLoader=function(){var e=/^[og]\s*(.+)?/,t=/^mtllib /,r=/^usemtl /;function n(){var e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(e,t){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);var n={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){var t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(n),n},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){var t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(var r=this.materials.length-1;r>=0;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){var n=r.clone(0);n.inherited=!0,this.object.materials.push(n)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){var r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseUVIndex:function(e,t){var r=parseInt(e,10);return 2*(r>=0?r-1:r+t/2)},addVertex:function(a,b,e){var t=this.vertices,r=this.object.geometry.vertices;r.push(t[a+0],t[a+1],t[a+2]),r.push(t[b+0],t[b+1],t[b+2]),r.push(t[e+0],t[e+1],t[e+2])},addVertexPoint:function(a){var e=this.vertices;this.object.geometry.vertices.push(e[a+0],e[a+1],e[a+2])},addVertexLine:function(a){var e=this.vertices;this.object.geometry.vertices.push(e[a+0],e[a+1],e[a+2])},addNormal:function(a,b,e){var t=this.normals,r=this.object.geometry.normals;r.push(t[a+0],t[a+1],t[a+2]),r.push(t[b+0],t[b+1],t[b+2]),r.push(t[e+0],t[e+1],t[e+2])},addColor:function(a,b,e){var t=this.colors,r=this.object.geometry.colors;r.push(t[a+0],t[a+1],t[a+2]),r.push(t[b+0],t[b+1],t[b+2]),r.push(t[e+0],t[e+1],t[e+2])},addUV:function(a,b,e){var t=this.uvs,r=this.object.geometry.uvs;r.push(t[a+0],t[a+1]),r.push(t[b+0],t[b+1]),r.push(t[e+0],t[e+1])},addUVLine:function(a){var e=this.uvs;this.object.geometry.uvs.push(e[a+0],e[a+1])},addFace:function(a,b,e,t,r,n,o,l,c){var h=this.vertices.length,d=this.parseVertexIndex(a,h),f=this.parseVertexIndex(b,h),m=this.parseVertexIndex(e,h);if(this.addVertex(d,f,m),void 0!==t&&""!==t){var v=this.uvs.length;d=this.parseUVIndex(t,v),f=this.parseUVIndex(r,v),m=this.parseUVIndex(n,v),this.addUV(d,f,m)}if(void 0!==o&&""!==o){var y=this.normals.length;d=this.parseNormalIndex(o,y),f=o===l?d:this.parseNormalIndex(l,y),m=o===c?d:this.parseNormalIndex(c,y),this.addNormal(d,f,m)}this.colors.length>0&&this.addColor(d,f,m)},addPointGeometry:function(e){this.object.geometry.type="Points";for(var t=this.vertices.length,r=0,n=e.length;r<n;r++)this.addVertexPoint(this.parseVertexIndex(e[r],t))},addLineGeometry:function(e,t){this.object.geometry.type="Line";for(var r=this.vertices.length,n=this.uvs.length,o=0,l=e.length;o<l;o++)this.addVertexLine(this.parseVertexIndex(e[o],r));var c=0;for(l=t.length;c<l;c++)this.addUVLine(this.parseUVIndex(t[c],n))}};return e.startObject("",!1),e}function o(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.materials=null}return o.prototype={constructor:o,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(this.path),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},setMaterials:function(e){return this.materials=e,this},parse:function(text){console.time("OBJLoader");var o=new n;-1!==text.indexOf("\r\n")&&(text=text.replace(/\r\n/g,"\n")),-1!==text.indexOf("\\\n")&&(text=text.replace(/\\\n/g,""));for(var l=text.split("\n"),line="",c="",h=[],d="function"==typeof"".trimLeft,i=0,f=l.length;i<f;i++)if(line=l[i],0!==(line=d?line.trimLeft():line.trim()).length&&"#"!==(c=line.charAt(0)))if("v"===c){var data=line.split(/\s+/);switch(data[0]){case"v":o.vertices.push(parseFloat(data[1]),parseFloat(data[2]),parseFloat(data[3])),8===data.length&&o.colors.push(parseFloat(data[4]),parseFloat(data[5]),parseFloat(data[6]));break;case"vn":o.normals.push(parseFloat(data[1]),parseFloat(data[2]),parseFloat(data[3]));break;case"vt":o.uvs.push(parseFloat(data[1]),parseFloat(data[2]))}}else if("f"===c){for(var m=line.substr(1).trim().split(/\s+/),v=[],y=0,x=m.length;y<x;y++){var w=m[y];if(w.length>0){var M=w.split("/");v.push(M)}}var S=v[0];for(y=1,x=v.length-1;y<x;y++){var A=v[y],T=v[y+1];o.addFace(S[0],A[0],T[0],S[1],A[1],T[1],S[2],A[2],T[2])}}else if("l"===c){var _=line.substring(1).trim().split(" "),L=[],C=[];if(-1===line.indexOf("/"))L=_;else for(var li=0,N=_.length;li<N;li++){var P=_[li].split("/");""!==P[0]&&L.push(P[0]),""!==P[1]&&C.push(P[1])}o.addLineGeometry(L,C)}else if("p"===c){var E=line.substr(1).trim().split(" ");o.addPointGeometry(E)}else if(null!==(h=e.exec(line))){var D=(" "+h[0].substr(1).trim()).substr(1);o.startObject(D)}else if(r.test(line))o.object.startMaterial(line.substring(7).trim(),o.materialLibraries);else if(t.test(line))o.materialLibraries.push(line.substring(7).trim());else{if("s"!==c){if("\0"===line)continue;throw new Error('OBJLoader: Unexpected line: "'+line+'"')}if((h=line.split(" ")).length>1){var F=h[1].trim().toLowerCase();o.object.smooth="0"!==F&&"off"!==F}else o.object.smooth=!0;(X=o.object.currentMaterial())&&(X.smooth=o.object.smooth)}o.finalize();var R=new Group;R.materialLibraries=[].concat(o.materialLibraries);for(i=0,f=o.objects.length;i<f;i++){var object=o.objects[i],O=object.geometry,B=object.materials,I="Line"===O.type,U="Points"===O.type,V=!1;if(0!==O.vertices.length){var k=new BufferGeometry;k.addAttribute("position",new Float32BufferAttribute(O.vertices,3)),O.normals.length>0?k.addAttribute("normal",new Float32BufferAttribute(O.normals,3)):k.computeVertexNormals(),O.colors.length>0&&(V=!0,k.addAttribute("color",new Float32BufferAttribute(O.colors,3))),O.uvs.length>0&&k.addAttribute("uv",new Float32BufferAttribute(O.uvs,2));for(var G,z=[],j=0,W=B.length;j<W;j++){var H=B[j],X=void 0;if(null!==this.materials)if(X=this.materials.create(H.name),!I||!X||X instanceof LineBasicMaterial){if(U&&X&&!(X instanceof PointsMaterial)){var Y=new PointsMaterial({size:10,sizeAttenuation:!1});Material.prototype.copy.call(Y,X),Y.color.copy(X.color),Y.map=X.map,Y.lights=!1,X=Y}}else{var Q=new LineBasicMaterial;Material.prototype.copy.call(Q,X),Q.color.copy(X.color),Q.lights=!1,X=Q}X||((X=I?new LineBasicMaterial:U?new PointsMaterial({size:1,sizeAttenuation:!1}):new MeshPhongMaterial).name=H.name),X.flatShading=!H.smooth,X.vertexColors=V?VertexColors:NoColors,z.push(X)}if(z.length>1){for(j=0,W=B.length;j<W;j++){H=B[j];k.addGroup(H.groupStart,H.groupCount,j)}G=I?new LineSegments(k,z):U?new Points(k,z):new Mesh(k,z)}else G=I?new LineSegments(k,z[0]):U?new Points(k,z[0]):new Mesh(k,z[0]);G.name=object.name,R.add(G)}}return console.timeEnd("OBJLoader"),R}},o}();void 0===LoaderSupport&&console.error('"LoaderSupport" is not available. "OBJLoader2" requires it. Please include "LoaderSupport.js" in your HTML.');var OBJLoader2=function(e){console.info("Using OBJLoader2 version: "+OBJLoader2.OBJLOADER2_VERSION),this.manager=LoaderSupport.Validator.verifyInput(e,DefaultLoadingManager),this.logging={enabled:!0,debug:!1},this.modelName="",this.instanceNo=0,this.path,this.resourcePath,this.useIndices=!1,this.disregardNormals=!1,this.materialPerSmoothingGroup=!1,this.useOAsMesh=!1,this.loaderRootNode=new Group,this.meshBuilder=new LoaderSupport.MeshBuilder,this.callbacks=new LoaderSupport.Callbacks,this.workerSupport=new LoaderSupport.WorkerSupport,this.terminateWorkerOnLoad=!0};OBJLoader2.OBJLOADER2_VERSION="2.5.0",OBJLoader2.prototype={constructor:OBJLoader2,setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t,this.meshBuilder.setLogging(this.logging.enabled,this.logging.debug)},setModelName:function(e){this.modelName=LoaderSupport.Validator.verifyInput(e,this.modelName)},setPath:function(path){this.path=LoaderSupport.Validator.verifyInput(path,this.path)},setResourcePath:function(e){this.resourcePath=LoaderSupport.Validator.verifyInput(e,this.resourcePath)},setStreamMeshesTo:function(e){this.loaderRootNode=LoaderSupport.Validator.verifyInput(e,this.loaderRootNode)},setMaterials:function(e){this.meshBuilder.setMaterials(e)},setUseIndices:function(e){this.useIndices=!0===e},setDisregardNormals:function(e){this.disregardNormals=!0===e},setMaterialPerSmoothingGroup:function(e){this.materialPerSmoothingGroup=!0===e},setUseOAsMesh:function(e){this.useOAsMesh=!0===e},_setCallbacks:function(e){LoaderSupport.Validator.isValid(e.onProgress)&&this.callbacks.setCallbackOnProgress(e.onProgress),LoaderSupport.Validator.isValid(e.onReportError)&&this.callbacks.setCallbackOnReportError(e.onReportError),LoaderSupport.Validator.isValid(e.onMeshAlter)&&this.callbacks.setCallbackOnMeshAlter(e.onMeshAlter),LoaderSupport.Validator.isValid(e.onLoad)&&this.callbacks.setCallbackOnLoad(e.onLoad),LoaderSupport.Validator.isValid(e.onLoadMaterials)&&this.callbacks.setCallbackOnLoadMaterials(e.onLoadMaterials),this.meshBuilder._setCallbacks(this.callbacks)},onProgress:function(e,text,t){var content=LoaderSupport.Validator.isValid(text)?text:"",r={detail:{type:e,modelName:this.modelName,instanceNo:this.instanceNo,text:content,numericalValue:t}};LoaderSupport.Validator.isValid(this.callbacks.onProgress)&&this.callbacks.onProgress(r),this.logging.enabled&&this.logging.debug&&console.debug(content)},_onError:function(e){var output="Error occurred while downloading!";e.currentTarget&&null!==e.currentTarget.statusText&&(output+="\nurl: "+e.currentTarget.responseURL+"\nstatus: "+e.currentTarget.statusText),this.onProgress("error",output,-1),this._throwError(output)},_throwError:function(e){if(!LoaderSupport.Validator.isValid(this.callbacks.onReportError))throw e;this.callbacks.onReportError(e)},load:function(e,t,r,n,o,l){var c=new LoaderSupport.ResourceDescriptor(e,"OBJ");this._loadObj(c,t,r,n,o,l)},_loadObj:function(e,t,r,n,o,l){var c=this;LoaderSupport.Validator.isValid(n)||(n=function(e){c._onError(e)}),LoaderSupport.Validator.isValid(e)||n("An invalid ResourceDescriptor was provided. Unable to continue!");var h=function(content){if(e.content=content,l)c.parseAsync(content,t);else{var r=new LoaderSupport.Callbacks;r.setCallbackOnMeshAlter(o),c._setCallbacks(r),t({detail:{loaderRootNode:c.parse(content),modelName:c.modelName,instanceNo:c.instanceNo}})}};if(this.setPath(e.path),this.setResourcePath(e.resourcePath),!LoaderSupport.Validator.isValid(e.url)||LoaderSupport.Validator.isValid(e.content))h(LoaderSupport.Validator.isValid(e.content)?e.content:null);else{if(!LoaderSupport.Validator.isValid(r)){var d=0,f=0;r=function(t){if(t.lengthComputable&&(f=t.loaded/t.total)>d){d=f;var output='Download of "'+e.url+'": '+(100*f).toFixed(2)+"%";c.onProgress("progressLoad",output,f)}}}var m=new FileLoader(this.manager);m.setPath(this.path||this.resourcePath),m.setResponseType("arraybuffer"),m.load(e.name,h,r,n)}},run:function(e,t){this._applyPrepData(e);var r=e.checkResourceDescriptorFiles(e.resources,[{ext:"obj",type:"ArrayBuffer",ignore:!1},{ext:"mtl",type:"String",ignore:!1},{ext:"zip",type:"String",ignore:!0}]);LoaderSupport.Validator.isValid(t)&&(this.terminateWorkerOnLoad=!1,this.workerSupport=t,this.logging.enabled=this.workerSupport.logging.enabled,this.logging.debug=this.workerSupport.logging.debug);var n=this;this._loadMtl(r.mtl,(function(t){null!==t&&n.meshBuilder.setMaterials(t),n._loadObj(r.obj,n.callbacks.onLoad,null,null,n.callbacks.onMeshAlter,e.useAsync)}),null,null,e.crossOrigin,e.materialOptions)},_applyPrepData:function(e){LoaderSupport.Validator.isValid(e)&&(this.setLogging(e.logging.enabled,e.logging.debug),this.setModelName(e.modelName),this.setStreamMeshesTo(e.streamMeshesTo),this.meshBuilder.setMaterials(e.materials),this.setUseIndices(e.useIndices),this.setDisregardNormals(e.disregardNormals),this.setMaterialPerSmoothingGroup(e.materialPerSmoothingGroup),this.setUseOAsMesh(e.useOAsMesh),this._setCallbacks(e.getCallbacks()))},parse:function(content){if(!LoaderSupport.Validator.isValid(content))return console.warn("Provided content is not a valid ArrayBuffer or String."),this.loaderRootNode;this.logging.enabled&&console.time("OBJLoader2 parse: "+this.modelName),this.meshBuilder.init();var e=new OBJLoader2.Parser;e.setLogging(this.logging.enabled,this.logging.debug),e.setMaterialPerSmoothingGroup(this.materialPerSmoothingGroup),e.setUseOAsMesh(this.useOAsMesh),e.setUseIndices(this.useIndices),e.setDisregardNormals(this.disregardNormals),e.setMaterials(this.meshBuilder.getMaterials());var t=this;e.setCallbackMeshBuilder((function(e){var r,n=t.meshBuilder.processPayload(e);for(var i in n)r=n[i],t.loaderRootNode.add(r)}));return e.setCallbackProgress((function(text,e){t.onProgress("progressParse",text,e)})),content instanceof ArrayBuffer||content instanceof Uint8Array?(this.logging.enabled&&console.info("Parsing arrayBuffer..."),e.parse(content)):"string"==typeof content||content instanceof String?(this.logging.enabled&&console.info("Parsing text..."),e.parseText(content)):this._throwError("Provided content was neither of type String nor Uint8Array! Aborting..."),this.logging.enabled&&console.timeEnd("OBJLoader2 parse: "+this.modelName),this.loaderRootNode},parseAsync:function(content,e){var t=this,r=!1,n=function(){e({detail:{loaderRootNode:t.loaderRootNode,modelName:t.modelName,instanceNo:t.instanceNo}}),r&&t.logging.enabled&&console.timeEnd("OBJLoader2 parseAsync: "+t.modelName)};LoaderSupport.Validator.isValid(content)?r=!0:(console.warn("Provided content is not a valid ArrayBuffer."),n()),r&&this.logging.enabled&&console.time("OBJLoader2 parseAsync: "+this.modelName),this.meshBuilder.init();this.workerSupport.validate((function(e){var t="";return t+="\n\n",t+="THREE = { LoaderSupport: {}, OBJLoader2: {} };\n\n",t+=e.serializeObject("LoaderSupport.Validator",LoaderSupport.Validator),t+=e.serializeClass("OBJLoader2.Parser",OBJLoader2.Parser)}),"OBJLoader2.Parser"),this.workerSupport.setCallbacks((function(e){var r,n=t.meshBuilder.processPayload(e);for(var i in n)r=n[i],t.loaderRootNode.add(r)}),n),t.terminateWorkerOnLoad&&this.workerSupport.setTerminateRequested(!0);var o={},l=this.meshBuilder.getMaterials();for(var c in l)o[c]=c;this.workerSupport.run({params:{useAsync:!0,materialPerSmoothingGroup:this.materialPerSmoothingGroup,useOAsMesh:this.useOAsMesh,useIndices:this.useIndices,disregardNormals:this.disregardNormals},logging:{enabled:this.logging.enabled,debug:this.logging.debug},materials:{materials:o},data:{input:content,options:null}})},loadMtl:function(e,content,t,r,n,o,l){var c=new LoaderSupport.ResourceDescriptor(e,"MTL");c.setContent(content),this._loadMtl(c,t,r,n,o,l)},_loadMtl:function(e,t,r,n,o,l){void 0===MTLLoader&&console.error('"MTLLoader" is not available. "OBJLoader2" requires it for loading MTL files.'),LoaderSupport.Validator.isValid(e)&&this.logging.enabled&&console.time("Loading MTL: "+e.name);var c=[],h=this,d=function(r){var n=[];if(LoaderSupport.Validator.isValid(r))for(var o in r.preload(),n=r.materials)n.hasOwnProperty(o)&&(c[o]=n[o]);LoaderSupport.Validator.isValid(e)&&h.logging.enabled&&console.timeEnd("Loading MTL: "+e.name),t(c,r)};if(LoaderSupport.Validator.isValid(e)&&(LoaderSupport.Validator.isValid(e.content)||LoaderSupport.Validator.isValid(e.url))){var f=new MTLLoader(this.manager);o=LoaderSupport.Validator.verifyInput(o,"anonymous"),f.setCrossOrigin(o),f.setResourcePath(e.resourcePath||e.path),LoaderSupport.Validator.isValid(l)&&f.setMaterialOptions(l);var m=function(content){var e=content;"string"==typeof content||content instanceof String||(content.length>0||content.byteLength>0?e=LoaderUtils.decodeText(content):this._throwError("Unable to parse mtl as it it seems to be neither a String, an Array or an ArrayBuffer!")),d(f.parse(e))};if(LoaderSupport.Validator.isValid(e.content))m(e.content);else if(LoaderSupport.Validator.isValid(e.url)){var v=new FileLoader(this.manager);if(LoaderSupport.Validator.isValid(n)||(n=function(e){h._onError(e)}),!LoaderSupport.Validator.isValid(r)){var y=0,x=0;r=function(t){if(t.lengthComputable&&(x=t.loaded/t.total)>y){y=x;var output='Download of "'+e.url+'": '+(100*x).toFixed(2)+"%";h.onProgress("progressLoad",output,x)}}}v.load(e.url,m,r,n)}}else d()}},OBJLoader2.Parser=function(){this.callbackProgress=null,this.callbackMeshBuilder=null,this.contentRef=null,this.legacyMode=!1,this.materials={},this.useAsync=!1,this.materialPerSmoothingGroup=!1,this.useOAsMesh=!1,this.useIndices=!1,this.disregardNormals=!1,this.vertices=[],this.colors=[],this.normals=[],this.uvs=[],this.rawMesh={objectName:"",groupName:"",activeMtlName:"",mtllibName:"",faceType:-1,subGroups:[],subGroupInUse:null,smoothingGroup:{splitMaterials:!1,normalized:-1,real:-1},counts:{doubleIndicesCount:0,faceCount:0,mtlCount:0,smoothingGroupCount:0}},this.inputObjectCount=1,this.outputObjectCount=1,this.globalCounts={vertices:0,faces:0,doubleIndicesCount:0,lineByte:0,currentByte:0,totalBytes:0},this.logging={enabled:!0,debug:!1}},OBJLoader2.Parser.prototype={constructor:OBJLoader2.Parser,resetRawMesh:function(){this.rawMesh.subGroups=[],this.rawMesh.subGroupInUse=null,this.rawMesh.smoothingGroup.normalized=-1,this.rawMesh.smoothingGroup.real=-1,this.pushSmoothingGroup(1),this.rawMesh.counts.doubleIndicesCount=0,this.rawMesh.counts.faceCount=0,this.rawMesh.counts.mtlCount=0,this.rawMesh.counts.smoothingGroupCount=0},setUseAsync:function(e){this.useAsync=e},setMaterialPerSmoothingGroup:function(e){this.materialPerSmoothingGroup=e},setUseOAsMesh:function(e){this.useOAsMesh=e},setUseIndices:function(e){this.useIndices=e},setDisregardNormals:function(e){this.disregardNormals=e},setMaterials:function(e){this.materials=LoaderSupport.Validator.verifyInput(e,this.materials),this.materials=LoaderSupport.Validator.verifyInput(this.materials,{})},setCallbackMeshBuilder:function(e){LoaderSupport.Validator.isValid(e)||this._throwError('Unable to run as no "MeshBuilder" callback is set.'),this.callbackMeshBuilder=e},setCallbackProgress:function(e){this.callbackProgress=e},setLogging:function(e,t){this.logging.enabled=!0===e,this.logging.debug=!0===t},configure:function(){if(this.pushSmoothingGroup(1),this.logging.enabled){var e=Object.keys(this.materials),t="OBJLoader2.Parser configuration:"+(e.length>0?"\n\tmaterialNames:\n\t\t- "+e.join("\n\t\t- "):"\n\tmaterialNames: None")+"\n\tuseAsync: "+this.useAsync+"\n\tmaterialPerSmoothingGroup: "+this.materialPerSmoothingGroup+"\n\tuseOAsMesh: "+this.useOAsMesh+"\n\tuseIndices: "+this.useIndices+"\n\tdisregardNormals: "+this.disregardNormals+"\n\tcallbackMeshBuilderName: "+this.callbackMeshBuilder.name+"\n\tcallbackProgressName: "+this.callbackProgress.name;console.info(t)}},parse:function(e){this.logging.enabled&&console.time("OBJLoader2.Parser.parse"),this.configure();var t=new Uint8Array(e);this.contentRef=t;var r=t.byteLength;this.globalCounts.totalBytes=r;for(var code,n=new Array(128),o="",l=0,c=0,i=0;i<r;i++)switch(code=t[i]){case 32:o.length>0&&(n[l++]=o),o="";break;case 47:o.length>0&&(n[l++]=o),c++,o="";break;case 10:o.length>0&&(n[l++]=o),o="",this.globalCounts.lineByte=this.globalCounts.currentByte,this.globalCounts.currentByte=i,this.processLine(n,l,c),l=0,c=0;break;case 13:break;default:o+=String.fromCharCode(code)}this.finalizeParsing(),this.logging.enabled&&console.timeEnd("OBJLoader2.Parser.parse")},parseText:function(text){this.logging.enabled&&console.time("OBJLoader2.Parser.parseText"),this.configure(),this.legacyMode=!0,this.contentRef=text;var e=text.length;this.globalCounts.totalBytes=e;for(var t,r=new Array(128),n="",o=0,l=0,i=0;i<e;i++)switch(t=text[i]){case" ":n.length>0&&(r[o++]=n),n="";break;case"/":n.length>0&&(r[o++]=n),l++,n="";break;case"\n":n.length>0&&(r[o++]=n),n="",this.globalCounts.lineByte=this.globalCounts.currentByte,this.globalCounts.currentByte=i,this.processLine(r,o,l),o=0,l=0;break;case"\r":break;default:n+=t}this.finalizeParsing(),this.logging.enabled&&console.timeEnd("OBJLoader2.Parser.parseText")},processLine:function(e,t,r){if(!(t<1)){var n,o,i,l,c=function(content,e,t,r){var line="";if(r>t){var i;if(e)for(i=t;i<r;i++)line+=content[i];else for(i=t;i<r;i++)line+=String.fromCharCode(content[i]);line=line.trim()}return line};switch(l=e[0]){case"v":this.vertices.push(parseFloat(e[1])),this.vertices.push(parseFloat(e[2])),this.vertices.push(parseFloat(e[3])),t>4&&(this.colors.push(parseFloat(e[4])),this.colors.push(parseFloat(e[5])),this.colors.push(parseFloat(e[6])));break;case"vt":this.uvs.push(parseFloat(e[1])),this.uvs.push(parseFloat(e[2]));break;case"vn":this.normals.push(parseFloat(e[1])),this.normals.push(parseFloat(e[2])),this.normals.push(parseFloat(e[3]));break;case"f":if(n=t-1,0===r)for(this.checkFaceType(0),i=2,o=n;i<o;i++)this.buildFace(e[1]),this.buildFace(e[i]),this.buildFace(e[i+1]);else if(n===2*r)for(this.checkFaceType(1),i=3,o=n-2;i<o;i+=2)this.buildFace(e[1],e[2]),this.buildFace(e[i],e[i+1]),this.buildFace(e[i+2],e[i+3]);else if(2*n==3*r)for(this.checkFaceType(2),i=4,o=n-3;i<o;i+=3)this.buildFace(e[1],e[2],e[3]),this.buildFace(e[i],e[i+1],e[i+2]),this.buildFace(e[i+3],e[i+4],e[i+5]);else for(this.checkFaceType(3),i=3,o=n-2;i<o;i+=2)this.buildFace(e[1],void 0,e[2]),this.buildFace(e[i],void 0,e[i+1]),this.buildFace(e[i+2],void 0,e[i+3]);break;case"l":case"p":if((n=t-1)===2*r)for(this.checkFaceType(4),i=1,o=n+1;i<o;i+=2)this.buildFace(e[i],e[i+1]);else for(this.checkFaceType("l"===l?5:6),i=1,o=n+1;i<o;i++)this.buildFace(e[i]);break;case"s":this.pushSmoothingGroup(e[1]);break;case"g":this.processCompletedMesh(),this.rawMesh.groupName=c(this.contentRef,this.legacyMode,this.globalCounts.lineByte+2,this.globalCounts.currentByte);break;case"o":this.useOAsMesh&&this.processCompletedMesh(),this.rawMesh.objectName=c(this.contentRef,this.legacyMode,this.globalCounts.lineByte+2,this.globalCounts.currentByte);break;case"mtllib":this.rawMesh.mtllibName=c(this.contentRef,this.legacyMode,this.globalCounts.lineByte+7,this.globalCounts.currentByte);break;case"usemtl":var h=c(this.contentRef,this.legacyMode,this.globalCounts.lineByte+7,this.globalCounts.currentByte);""!==h&&this.rawMesh.activeMtlName!==h&&(this.rawMesh.activeMtlName=h,this.rawMesh.counts.mtlCount++,this.checkSubGroup())}}},pushSmoothingGroup:function(e){var t=parseInt(e);isNaN(t)&&(t="off"===e?0:1);var r=this.rawMesh.smoothingGroup.normalized;this.rawMesh.smoothingGroup.normalized=this.rawMesh.smoothingGroup.splitMaterials?t:0===t?0:1,this.rawMesh.smoothingGroup.real=t,r!==t&&(this.rawMesh.counts.smoothingGroupCount++,this.checkSubGroup())},checkFaceType:function(e){this.rawMesh.faceType!==e&&(this.processCompletedMesh(),this.rawMesh.faceType=e,this.checkSubGroup())},checkSubGroup:function(){var e=this.rawMesh.activeMtlName+"|"+this.rawMesh.smoothingGroup.normalized;this.rawMesh.subGroupInUse=this.rawMesh.subGroups[e],LoaderSupport.Validator.isValid(this.rawMesh.subGroupInUse)||(this.rawMesh.subGroupInUse={index:e,objectName:this.rawMesh.objectName,groupName:this.rawMesh.groupName,materialName:this.rawMesh.activeMtlName,smoothingGroup:this.rawMesh.smoothingGroup.normalized,vertices:[],indexMappingsCount:0,indexMappings:[],indices:[],colors:[],uvs:[],normals:[]},this.rawMesh.subGroups[e]=this.rawMesh.subGroupInUse)},buildFace:function(e,t,r){this.disregardNormals&&(r=void 0);var n=this,o=function(){var o=parseInt(e),l=3*(o>0?o-1:o+n.vertices.length/3),c=n.colors.length>0?l:null,h=n.rawMesh.subGroupInUse.vertices;if(h.push(n.vertices[l++]),h.push(n.vertices[l++]),h.push(n.vertices[l]),null!==c){var d=n.rawMesh.subGroupInUse.colors;d.push(n.colors[c++]),d.push(n.colors[c++]),d.push(n.colors[c])}if(t){var f=parseInt(t),m=2*(f>0?f-1:f+n.uvs.length/2),v=n.rawMesh.subGroupInUse.uvs;v.push(n.uvs[m++]),v.push(n.uvs[m])}if(r){var y=parseInt(r),x=3*(y>0?y-1:y+n.normals.length/3),w=n.rawMesh.subGroupInUse.normals;w.push(n.normals[x++]),w.push(n.normals[x++]),w.push(n.normals[x])}};if(this.useIndices){var l=e+(t?"_"+t:"_n")+(r?"_"+r:"_n"),c=this.rawMesh.subGroupInUse.indexMappings[l];LoaderSupport.Validator.isValid(c)?this.rawMesh.counts.doubleIndicesCount++:(c=this.rawMesh.subGroupInUse.vertices.length/3,o(),this.rawMesh.subGroupInUse.indexMappings[l]=c,this.rawMesh.subGroupInUse.indexMappingsCount++),this.rawMesh.subGroupInUse.indices.push(c)}else o();this.rawMesh.counts.faceCount++},createRawMeshReport:function(e){return"Input Object number: "+e+"\n\tObject name: "+this.rawMesh.objectName+"\n\tGroup name: "+this.rawMesh.groupName+"\n\tMtllib name: "+this.rawMesh.mtllibName+"\n\tVertex count: "+this.vertices.length/3+"\n\tNormal count: "+this.normals.length/3+"\n\tUV count: "+this.uvs.length/2+"\n\tSmoothingGroup count: "+this.rawMesh.counts.smoothingGroupCount+"\n\tMaterial count: "+this.rawMesh.counts.mtlCount+"\n\tReal MeshOutputGroup count: "+this.rawMesh.subGroups.length},finalizeRawMesh:function(){var e,t,r=[],n=0,o=0,l=0,c=0,h=0,d=0;for(var f in this.rawMesh.subGroups)if((e=this.rawMesh.subGroups[f]).vertices.length>0){if((t=e.indices).length>0&&o>0)for(var i in t)t[i]=t[i]+o;r.push(e),n+=e.vertices.length,o+=e.indexMappingsCount,l+=e.indices.length,c+=e.colors.length,d+=e.uvs.length,h+=e.normals.length}var m=null;return r.length>0&&(m={name:""!==this.rawMesh.groupName?this.rawMesh.groupName:this.rawMesh.objectName,subGroups:r,absoluteVertexCount:n,absoluteIndexCount:l,absoluteColorCount:c,absoluteNormalCount:h,absoluteUvCount:d,faceCount:this.rawMesh.counts.faceCount,doubleIndicesCount:this.rawMesh.counts.doubleIndicesCount}),m},processCompletedMesh:function(){var e=this.finalizeRawMesh();if(LoaderSupport.Validator.isValid(e)){this.colors.length>0&&this.colors.length!==this.vertices.length&&this._throwError("Vertex Colors were detected, but vertex count and color count do not match!"),this.logging.enabled&&this.logging.debug&&console.debug(this.createRawMeshReport(this.inputObjectCount)),this.inputObjectCount++,this.buildMesh(e);var t=this.globalCounts.currentByte/this.globalCounts.totalBytes;return this.callbackProgress("Completed [o: "+this.rawMesh.objectName+" g:"+this.rawMesh.groupName+"] Total progress: "+(100*t).toFixed(2)+"%",t),this.resetRawMesh(),!0}return!1},buildMesh:function(e){var t=e.subGroups,r=new Float32Array(e.absoluteVertexCount);this.globalCounts.vertices+=e.absoluteVertexCount/3,this.globalCounts.faces+=e.faceCount,this.globalCounts.doubleIndicesCount+=e.doubleIndicesCount;var n,o,l,c,h,d,f,m=e.absoluteIndexCount>0?new Uint32Array(e.absoluteIndexCount):null,v=e.absoluteColorCount>0?new Float32Array(e.absoluteColorCount):null,y=e.absoluteNormalCount>0?new Float32Array(e.absoluteNormalCount):null,x=e.absoluteUvCount>0?new Float32Array(e.absoluteUvCount):null,w=LoaderSupport.Validator.isValid(v),M=[],S=t.length>1,A=0,T=[],_=[],L=0,C=0,N=0,P=0,E=0,D=0,F=0;for(var R in t)if(t.hasOwnProperty(R)){if(f=(n=t[R]).materialName,d=this.rawMesh.faceType<4?f+(w?"_vertexColor":"")+(0===n.smoothingGroup?"_flat":""):6===this.rawMesh.faceType?"defaultPointMaterial":"defaultLineMaterial",c=this.materials[f],h=this.materials[d],!LoaderSupport.Validator.isValid(c)&&!LoaderSupport.Validator.isValid(h)){var O=w?"defaultVertexColorMaterial":"defaultMaterial";c=this.materials[O],this.logging.enabled&&console.warn('object_group "'+n.objectName+"_"+n.groupName+'" was defined with unresolvable material "'+f+'"! Assigning "'+O+'".'),(f=O)===d&&(h=c,d=O)}if(!LoaderSupport.Validator.isValid(h)){var B={materialNameOrg:f,materialName:d,materialProperties:{vertexColors:w?2:0,flatShading:0===n.smoothingGroup}},I={cmd:"materialData",materials:{materialCloneInstructions:B}};this.callbackMeshBuilder(I),this.useAsync&&(this.materials[d]=B)}if(S?((o=T[d])||(o=A,T[d]=A,M.push(d),A++),l={start:D,count:F=this.useIndices?n.indices.length:n.vertices.length/3,index:o},_.push(l),D+=F):M.push(d),r.set(n.vertices,L),L+=n.vertices.length,m&&(m.set(n.indices,C),C+=n.indices.length),v&&(v.set(n.colors,N),N+=n.colors.length),y&&(y.set(n.normals,P),P+=n.normals.length),x&&(x.set(n.uvs,E),E+=n.uvs.length),this.logging.enabled&&this.logging.debug){var U=LoaderSupport.Validator.isValid(o)?"\n\t\tmaterialIndex: "+o:"",V="\tOutput Object no.: "+this.outputObjectCount+"\n\t\tgroupName: "+n.groupName+"\n\t\tIndex: "+n.index+"\n\t\tfaceType: "+this.rawMesh.faceType+"\n\t\tmaterialName: "+n.materialName+"\n\t\tsmoothingGroup: "+n.smoothingGroup+U+"\n\t\tobjectName: "+n.objectName+"\n\t\t#vertices: "+n.vertices.length/3+"\n\t\t#indices: "+n.indices.length+"\n\t\t#colors: "+n.colors.length/3+"\n\t\t#uvs: "+n.uvs.length/2+"\n\t\t#normals: "+n.normals.length/3;console.debug(V)}}this.outputObjectCount++,this.callbackMeshBuilder({cmd:"meshData",progress:{numericalValue:this.globalCounts.currentByte/this.globalCounts.totalBytes},params:{meshName:e.name},materials:{multiMaterial:S,materialNames:M,materialGroups:_},buffers:{vertices:r,indices:m,colors:v,normals:y,uvs:x},geometryType:this.rawMesh.faceType<4?0:6===this.rawMesh.faceType?2:1},[r.buffer],LoaderSupport.Validator.isValid(m)?[m.buffer]:null,LoaderSupport.Validator.isValid(v)?[v.buffer]:null,LoaderSupport.Validator.isValid(y)?[y.buffer]:null,LoaderSupport.Validator.isValid(x)?[x.buffer]:null)},finalizeParsing:function(){if(this.logging.enabled&&console.info("Global output object count: "+this.outputObjectCount),this.processCompletedMesh()&&this.logging.enabled){var e="Overall counts: \n\tVertices: "+this.globalCounts.vertices+"\n\tFaces: "+this.globalCounts.faces+"\n\tMultiple definitions: "+this.globalCounts.doubleIndicesCount;console.info(e)}}};var PCDLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.littleEndian=!0};PCDLoader.prototype={constructor:PCDLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(data){try{t(o.parse(data,e))}catch(e){if(!n)throw e;n(e)}}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data,e){var t=LoaderUtils.decodeText(data),r=function(data){var e={},t=data.search(/[\r\n]DATA\s(\S*)\s/i),r=/[\r\n]DATA\s(\S*)\s/i.exec(data.substr(t-1));if(e.data=r[1],e.headerLen=r[0].length+t,e.str=data.substr(0,e.headerLen),e.str=e.str.replace(/\#.*/gi,""),e.version=/VERSION (.*)/i.exec(e.str),e.fields=/FIELDS (.*)/i.exec(e.str),e.size=/SIZE (.*)/i.exec(e.str),e.type=/TYPE (.*)/i.exec(e.str),e.count=/COUNT (.*)/i.exec(e.str),e.width=/WIDTH (.*)/i.exec(e.str),e.height=/HEIGHT (.*)/i.exec(e.str),e.viewpoint=/VIEWPOINT (.*)/i.exec(e.str),e.points=/POINTS (.*)/i.exec(e.str),null!==e.version&&(e.version=parseFloat(e.version[1])),null!==e.fields&&(e.fields=e.fields[1].split(" ")),null!==e.type&&(e.type=e.type[1].split(" ")),null!==e.width&&(e.width=parseInt(e.width[1])),null!==e.height&&(e.height=parseInt(e.height[1])),null!==e.viewpoint&&(e.viewpoint=e.viewpoint[1]),null!==e.points&&(e.points=parseInt(e.points[1],10)),null===e.points&&(e.points=e.width*e.height),null!==e.size&&(e.size=e.size[1].split(" ").map((function(e){return parseInt(e,10)}))),null!==e.count)e.count=e.count[1].split(" ").map((function(e){return parseInt(e,10)}));else{e.count=[];for(var i=0,n=e.fields.length;i<n;i++)e.count.push(1)}e.offset={};var o=0;for(i=0,n=e.fields.length;i<n;i++)"ascii"===e.data?e.offset[e.fields[i]]=i:(e.offset[e.fields[i]]=o,o+=e.size[i]);return e.rowSize=o,e}(t),n=[],o=[],l=[];if("ascii"===r.data)for(var c=r.offset,h=t.substr(r.headerLen).split("\n"),i=0,d=h.length;i<d;i++)if(""!==h[i]){var line=h[i].split(" ");if(void 0!==c.x&&(n.push(parseFloat(line[c.x])),n.push(parseFloat(line[c.y])),n.push(parseFloat(line[c.z]))),void 0!==c.rgb){var f=parseFloat(line[c.rgb]),m=f>>16&255,g=f>>8&255,b=f>>0&255;l.push(m/255,g/255,b/255)}void 0!==c.normal_x&&(o.push(parseFloat(line[c.normal_x])),o.push(parseFloat(line[c.normal_y])),o.push(parseFloat(line[c.normal_z])))}if("binary_compressed"!==r.data){if("binary"===r.data)for(var v=new DataView(data,r.headerLen),y=(c=r.offset,i=0,0);i<r.points;i++,y+=r.rowSize)void 0!==c.x&&(n.push(v.getFloat32(y+c.x,this.littleEndian)),n.push(v.getFloat32(y+c.y,this.littleEndian)),n.push(v.getFloat32(y+c.z,this.littleEndian))),void 0!==c.rgb&&(l.push(v.getUint8(y+c.rgb+2)/255),l.push(v.getUint8(y+c.rgb+1)/255),l.push(v.getUint8(y+c.rgb+0)/255)),void 0!==c.normal_x&&(o.push(v.getFloat32(y+c.normal_x,this.littleEndian)),o.push(v.getFloat32(y+c.normal_y,this.littleEndian)),o.push(v.getFloat32(y+c.normal_z,this.littleEndian)));var x=new BufferGeometry;n.length>0&&x.addAttribute("position",new Float32BufferAttribute(n,3)),o.length>0&&x.addAttribute("normal",new Float32BufferAttribute(o,3)),l.length>0&&x.addAttribute("color",new Float32BufferAttribute(l,3)),x.computeBoundingSphere();var w=new PointsMaterial({size:.005});l.length>0?w.vertexColors=VertexColors:w.color.setHex(16777215*Math.random());var M=new Points(x,w),S=e.split("").reverse().join("");return S=(S=/([^\/]*)/.exec(S))[1].split("").reverse().join(""),M.name=S,M}console.error("PCDLoader: binary_compressed files are not supported")}};var PDBLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};PDBLoader.prototype={constructor:PDBLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(text){function e(text){return text.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function t(text){return text.charAt(0).toUpperCase()+text.substr(1).toLowerCase()}function r(e,t){var r=parseInt(y[i].substr(e,t));if(r){var n=function(s,e){return"s"+Math.min(s,e)+"e"+Math.max(s,e)}(w,r);void 0===v[n]&&(m.push([w-1,r-1,1]),v[n]=m.length-1)}}for(var n,o,l,c,h,d={h:[255,255,255],he:[217,255,255],li:[204,128,255],be:[194,255,0],b:[255,181,181],c:[144,144,144],n:[48,80,248],o:[255,13,13],f:[144,224,80],ne:[179,227,245],na:[171,92,242],mg:[138,255,0],al:[191,166,166],si:[240,200,160],p:[255,128,0],s:[255,255,48],cl:[31,240,31],ar:[128,209,227],k:[143,64,212],ca:[61,255,0],sc:[230,230,230],ti:[191,194,199],v:[166,166,171],cr:[138,153,199],mn:[156,122,199],fe:[224,102,51],co:[240,144,160],ni:[80,208,80],cu:[200,128,51],zn:[125,128,176],ga:[194,143,143],ge:[102,143,143],as:[189,128,227],se:[255,161,0],br:[166,41,41],kr:[92,184,209],rb:[112,46,176],sr:[0,255,0],y:[148,255,255],zr:[148,224,224],nb:[115,194,201],mo:[84,181,181],tc:[59,158,158],ru:[36,143,143],rh:[10,125,140],pd:[0,105,133],ag:[192,192,192],cd:[255,217,143],in:[166,117,115],sn:[102,128,128],sb:[158,99,181],te:[212,122,0],i:[148,0,148],xe:[66,158,176],cs:[87,23,143],ba:[0,201,0],la:[112,212,255],ce:[255,255,199],pr:[217,255,199],nd:[199,255,199],pm:[163,255,199],sm:[143,255,199],eu:[97,255,199],gd:[69,255,199],tb:[48,255,199],dy:[31,255,199],ho:[0,255,156],er:[0,230,117],tm:[0,212,82],yb:[0,191,56],lu:[0,171,36],hf:[77,194,255],ta:[77,166,255],w:[33,148,214],re:[38,125,171],os:[38,102,150],ir:[23,84,135],pt:[208,208,224],au:[255,209,35],hg:[184,184,208],tl:[166,84,77],pb:[87,89,97],bi:[158,79,181],po:[171,92,0],at:[117,79,69],rn:[66,130,150],fr:[66,0,102],ra:[0,125,0],ac:[112,171,250],th:[0,186,255],pa:[0,161,255],u:[0,143,255],np:[0,128,255],pu:[0,107,255],am:[84,92,242],cm:[120,92,227],bk:[138,79,227],cf:[161,54,212],es:[179,31,212],fm:[179,31,186],md:[179,13,166],no:[189,13,135],lr:[199,0,102],rf:[204,0,89],db:[209,0,79],sg:[217,0,69],bh:[224,0,56],hs:[230,0,46],mt:[235,0,38],ds:[235,0,38],rg:[235,0,38],cn:[235,0,38],uut:[235,0,38],uuq:[235,0,38],uup:[235,0,38],uuh:[235,0,38],uus:[235,0,38],uuo:[235,0,38]},f=[],m=[],v={},y=text.split("\n"),i=0,x=y.length;i<x;i++)if("ATOM"===y[i].substr(0,4)||"HETATM"===y[i].substr(0,6))n=parseFloat(y[i].substr(30,7)),o=parseFloat(y[i].substr(38,7)),l=parseFloat(y[i].substr(46,7)),c=parseInt(y[i].substr(6,5))-1,""===(h=e(y[i].substr(76,2)).toLowerCase())&&(h=e(y[i].substr(12,2)).toLowerCase()),f[c]=[n,o,l,d[h],t(h)];else if("CONECT"===y[i].substr(0,6)){var w=parseInt(y[i].substr(6,5));r(11,5),r(16,5),r(21,5),r(26,5)}return function(){var i,e,t={geometryAtoms:new BufferGeometry,geometryBonds:new BufferGeometry,json:{atoms:f,bonds:m}},r=t.geometryAtoms,n=t.geometryBonds,o=[],l=[],c=[];for(i=0,e=f.length;i<e;i++){var h=f[i],d=h[0],v=h[1],y=h[2];o.push(d,v,y);var x=h[3][0]/255,g=h[3][1]/255,b=h[3][2]/255;l.push(x,g,b)}for(i=0,e=m.length;i<e;i++){var w=m[i],M=w[0],S=w[1];c.push(o[3*M+0]),c.push(o[3*M+1]),c.push(o[3*M+2]),c.push(o[3*S+0]),c.push(o[3*S+1]),c.push(o[3*S+2])}return r.addAttribute("position",new Float32BufferAttribute(o,3)),r.addAttribute("color",new Float32BufferAttribute(l,3)),n.addAttribute("position",new Float32BufferAttribute(c,3)),t}()}};var PlayCanvasLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};PlayCanvasLoader.prototype={constructor:PlayCanvasLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(e){function t(data){var e={};for(var t in data){var r,n=data[t],o=n.type,l=n.components;switch(o){case"float32":r=new Float32BufferAttribute(n.data,l);break;case"uint8":r=new Uint8BufferAttribute(n.data,l);break;case"uint16":r=new Uint16BufferAttribute(n.data,l);break;default:console.log('PlayCanvasLoader: Array type "%s" not yet supported.',o)}e[t]=r}data._attributes=e}function r(data){var e=new BufferGeometry;e.setIndex(data.indices);var t=c.vertices[data.vertices]._attributes;for(var r in t){var n=t[r];"texCoord0"===r&&(r="uv"),e.addAttribute(r,n)}data._geometry=e}function n(data){var object=new Group,e=data._geometries;if(void 0!==e)for(var t=new MeshPhongMaterial,i=0,r=e.length;i<r;i++){var n=e[i];object.add(new Mesh(n,t))}for(i=0,r=data.rotation.length;i<r;i++)data.rotation[i]*=Math.PI/180;object.name=data.name,object.position.fromArray(data.position),object.quaternion.setFromEuler((new Euler).fromArray(data.rotation)),object.scale.fromArray(data.scale),data._object=object}for(var data,o,l,c=e.model,i=0,h=c.vertices.length;i<h;i++)t(c.vertices[i]);for(i=0,h=c.meshes.length;i<h;i++)r(c.meshes[i]);for(i=0,h=c.meshInstances.length;i<h;i++)data=c.meshInstances[i],o=void 0,l=void 0,o=c.nodes[data.node],l=c.meshes[data.mesh],void 0===o._geometries&&(o._geometries=[]),o._geometries.push(l._geometry);for(i=0,h=c.nodes.length;i<h;i++)n(c.nodes[i]);for(i=0,h=c.parents.length;i<h;i++){var d=c.parents[i];-1!==d&&c.nodes[d]._object.add(c.nodes[i]._object)}return c.nodes[0]._object}};var PLYLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.propertyNameMapping={}};PLYLoader.prototype={constructor:PLYLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},setPropertyNameMapping:function(e){this.propertyNameMapping=e},parse:function(data){function e(data){var e="",t=0,r=/ply([\s\S]*)end_header\r?\n/.exec(data);null!==r&&(e=r[1],t=r[0].length);var n,o,l,c,h,d,header={comments:[],elements:[],headerLength:t},m=e.split("\n");for(var i=0;i<m.length;i++){var line=m[i];if(""!==(line=line.trim()))switch(o=(l=line.split(/\s+/)).shift(),line=l.join(" "),o){case"format":header.format=l[0],header.version=l[1];break;case"comment":header.comments.push(line);break;case"element":void 0!==n&&header.elements.push(n),(n={}).name=l[0],n.count=parseInt(l[1]),n.properties=[];break;case"property":n.properties.push((c=l,h=f.propertyNameMapping,d=void 0,"list"===(d={type:c[0]}).type?(d.name=c[3],d.countType=c[1],d.itemType=c[2]):d.name=c[1],d.name in h&&(d.name=h[d.name]),d));break;default:console.log("unhandled",o,l)}}return void 0!==n&&header.elements.push(n),header}function t(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function r(e,line){for(var r=line.split(/\s+/),element={},i=0;i<e.length;i++)if("list"===e[i].type){for(var n=[],o=t(r.shift(),e[i].countType),l=0;l<o;l++)n.push(t(r.shift(),e[i].itemType));element[e[i].name]=n}else element[e[i].name]=t(r.shift(),e[i].type);return element}function n(data,header){var e,t={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},body="";null!==(e=/end_header\s([\s\S]*)$/.exec(data))&&(body=e[1]);for(var n=body.split("\n"),c=0,h=0,i=0;i<n.length;i++){var line=n[i];if(""!==(line=line.trim())){h>=header.elements[c].count&&(c++,h=0);var element=r(header.elements[c].properties,line);l(t,header.elements[c].name,element),h++}}return o(t)}function o(e){var t=new BufferGeometry;return e.indices.length>0&&t.setIndex(e.indices),t.addAttribute("position",new Float32BufferAttribute(e.vertices,3)),e.normals.length>0&&t.addAttribute("normal",new Float32BufferAttribute(e.normals,3)),e.uvs.length>0&&t.addAttribute("uv",new Float32BufferAttribute(e.uvs,2)),e.colors.length>0&&t.addAttribute("color",new Float32BufferAttribute(e.colors,3)),e.faceVertexUvs.length>0&&(t=t.toNonIndexed()).addAttribute("uv",new Float32BufferAttribute(e.faceVertexUvs,2)),t.computeBoundingSphere(),t}function l(e,t,element){if("vertex"===t)e.vertices.push(element.x,element.y,element.z),"nx"in element&&"ny"in element&&"nz"in element&&e.normals.push(element.nx,element.ny,element.nz),"s"in element&&"t"in element&&e.uvs.push(element.s,element.t),"red"in element&&"green"in element&&"blue"in element&&e.colors.push(element.red/255,element.green/255,element.blue/255);else if("face"===t){var r=element.vertex_indices||element.vertex_index,n=element.texcoord;3===r.length?(e.indices.push(r[0],r[1],r[2]),n&&6===n.length&&(e.faceVertexUvs.push(n[0],n[1]),e.faceVertexUvs.push(n[2],n[3]),e.faceVertexUvs.push(n[4],n[5]))):4===r.length&&(e.indices.push(r[0],r[1],r[3]),e.indices.push(r[1],r[2],r[3]))}}function c(e,t,r,n){switch(r){case"int8":case"char":return[e.getInt8(t),1];case"uint8":case"uchar":return[e.getUint8(t),1];case"int16":case"short":return[e.getInt16(t,n),2];case"uint16":case"ushort":return[e.getUint16(t,n),2];case"int32":case"int":return[e.getInt32(t,n),4];case"uint32":case"uint":return[e.getUint32(t,n),4];case"float32":case"float":return[e.getFloat32(t,n),4];case"float64":case"double":return[e.getFloat64(t,n),8]}}function h(e,t,r,n){for(var o,element={},l=0,i=0;i<r.length;i++)if("list"===r[i].type){var h=[],d=(o=c(e,t+l,r[i].countType,n))[0];l+=o[1];for(var f=0;f<d;f++)o=c(e,t+l,r[i].itemType,n),h.push(o[0]),l+=o[1];element[r[i].name]=h}else o=c(e,t+l,r[i].type,n),element[r[i].name]=o[0],l+=o[1];return[element,l]}var d,f=this;if(data instanceof ArrayBuffer){var text=LoaderUtils.decodeText(new Uint8Array(data)),header=e(text);d="ascii"===header.format?n(text,header):function(data,header){for(var e,t={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[]},r="binary_little_endian"===header.format,body=new DataView(data,header.headerLength),n=0,c=0;c<header.elements.length;c++)for(var d=0;d<header.elements[c].count;d++){n+=(e=h(body,n,header.elements[c].properties,r))[1];var element=e[0];l(t,header.elements[c].name,element)}return o(t)}(data,header)}else d=n(data,e(data));return d}};var bigEndianPlatform=null;function isBigEndianPlatform(){if(null===bigEndianPlatform){var e=new ArrayBuffer(2),t=new Uint8Array(e),r=new Uint16Array(e);t[0]=170,t[1]=187,bigEndianPlatform=43707===r[0]}return bigEndianPlatform}var InvertedEncodingTypes=[null,Float32Array,null,Int8Array,Int16Array,null,Int32Array,Uint8Array,Uint16Array,null,Uint32Array],getMethods={Uint16Array:"getUint16",Uint32Array:"getUint32",Int16Array:"getInt16",Int32Array:"getInt32",Float32Array:"getFloat32",Float64Array:"getFloat64"};function copyFromBuffer(e,t,r,n,o){var l,c=t.BYTES_PER_ELEMENT;if(o===isBigEndianPlatform()||1===c)l=new t(e,r,n);else{var h=new DataView(e,r,n*c),d=getMethods[t.name],f=!o,i=0;for(l=new t(n);i<n;i++)l[i]=h[d](i*c,f)}return l}function decodePrwm(e){var t=new Uint8Array(e),r=t[0],n=t[1],o=!!(n>>7&1),l=n>>6&1,c=1==(n>>5&1),h=31&n,d=0,f=0;if(c?(d=(t[2]<<16)+(t[3]<<8)+t[4],f=(t[5]<<16)+(t[6]<<8)+t[7]):(d=t[2]+(t[3]<<8)+(t[4]<<16),f=t[5]+(t[6]<<8)+(t[7]<<16)),0===r)throw new Error("PRWM decoder: Invalid format version: 0");if(1!==r)throw new Error("PRWM decoder: Unsupported format version: "+r);if(!o){if(0!==l)throw new Error("PRWM decoder: Indices type must be set to 0 for non-indexed geometries");if(0!==f)throw new Error("PRWM decoder: Number of indices must be set to 0 for non-indexed geometries")}var m,v,y,x,w,M,S,i,A=8,T={};for(i=0;i<h;i++){for(m="";A<t.length&&(v=t[A],A++,0!==v);)m+=String.fromCharCode(v);y=(n=t[A])>>7&1,x=1+(n>>4&3),A++,M=copyFromBuffer(e,w=InvertedEncodingTypes[15&n],A=4*Math.ceil(A/4),x*d,c),A+=w.BYTES_PER_ELEMENT*x*d,T[m]={type:y,cardinality:x,values:M}}return A=4*Math.ceil(A/4),S=null,o&&(S=copyFromBuffer(e,1===l?Uint32Array:Uint16Array,A,f,c)),{version:r,attributes:T,indices:S}}var PRWMLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};PRWMLoader.prototype={constructor:PRWMLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),e=e.replace(/\*/g,isBigEndianPlatform()?"be":"le"),l.load(e,(function(e){t(o.parse(e))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(e){console.time("PRWMLoader");var t,i,data=decodePrwm(e),r=Object.keys(data.attributes),n=new BufferGeometry;for(i=0;i<r.length;i++)t=data.attributes[r[i]],n.addAttribute(r[i],new BufferAttribute(t.values,t.cardinality,t.normalized));return null!==data.indices&&n.setIndex(new BufferAttribute(data.indices,1)),console.timeEnd("PRWMLoader"),n}},PRWMLoader.isBigEndianPlatform=function(){return isBigEndianPlatform()};var PVRLoader=function(e){CompressedTextureLoader.call(this,e),this._parser=PVRLoader.parse};PVRLoader.prototype=Object.create(CompressedTextureLoader.prototype),PVRLoader.prototype.constructor=PVRLoader,PVRLoader.parse=function(e,t){var header=new Uint32Array(e,0,13),r={buffer:e,header:header,loadMipmaps:t};return 55727696===header[0]?PVRLoader._parseV3(r):559044176===header[11]?PVRLoader._parseV2(r):void console.error("PVRLoader: Unknown PVR format.")},PVRLoader._parseV3=function(e){var t,r,header=e.header,n=header[12],o=header[2],l=header[6],c=header[7],h=header[10],d=header[11];switch(o){case 0:t=2,r=RGB_PVRTC_2BPPV1_Format;break;case 1:t=2,r=RGBA_PVRTC_2BPPV1_Format;break;case 2:t=4,r=RGB_PVRTC_4BPPV1_Format;break;case 3:t=4,r=RGBA_PVRTC_4BPPV1_Format;break;default:console.error("PVRLoader: Unsupported PVR format:",o)}return e.dataPtr=52+n,e.bpp=t,e.format=r,e.width=c,e.height=l,e.numSurfaces=h,e.numMipmaps=d,e.isCubemap=6===h,PVRLoader._extract(e)},PVRLoader._parseV2=function(e){var t,r,header=e.header,n=header[0],o=header[1],l=header[2],c=header[3],h=header[4],d=header[10],f=header[12],m=255&h,v=d>0;return 25===m?(r=v?RGBA_PVRTC_4BPPV1_Format:RGB_PVRTC_4BPPV1_Format,t=4):24===m?(r=v?RGBA_PVRTC_2BPPV1_Format:RGB_PVRTC_2BPPV1_Format,t=2):console.error("PVRLoader: Unknown PVR format:",m),e.dataPtr=n,e.bpp=t,e.format=r,e.width=l,e.height=o,e.numSurfaces=f,e.numMipmaps=c+1,e.isCubemap=6===f,PVRLoader._extract(e)},PVRLoader._extract=function(e){var t,r={mipmaps:[],width:e.width,height:e.height,format:e.format,mipmapCount:e.numMipmaps,isCubemap:e.isCubemap},n=e.buffer,o=e.dataPtr,l=e.bpp,c=e.numSurfaces,h=0,d=0,f=0,m=0,v=0;2===l?(d=8,f=4):(d=4,f=4),t=d*f*l/8,r.mipmaps.length=e.numMipmaps*c;for(var y=0;y<e.numMipmaps;){var x=e.width>>y,w=e.height>>y;(m=x/d)<2&&(m=2),(v=w/f)<2&&(v=2),h=m*v*t;for(var M=0;M<c;M++){var S={data:new Uint8Array(n,o,h),width:x,height:w};r.mipmaps[M*e.numMipmaps+y]=S,o+=h}y++}return r};var STLLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};function EllipseCurve(e,t,r,n,o,l,c,h){Curve.call(this),this.type="EllipseCurve",this.aX=e||0,this.aY=t||0,this.xRadius=r||1,this.yRadius=n||1,this.aStartAngle=o||0,this.aEndAngle=l||2*Math.PI,this.aClockwise=c||!1,this.aRotation=h||0}function ArcCurve(e,t,r,n,o,l){EllipseCurve.call(this,e,t,r,r,n,o,l),this.type="ArcCurve"}function CubicPoly(){var e=0,t=0,r=0,n=0;function o(o,l,c,h){e=o,t=c,r=-3*o+3*l-2*c-h,n=2*o-2*l+c+h}return{initCatmullRom:function(e,t,r,n,l){o(t,r,l*(r-e),l*(n-t))},initNonuniformCatmullRom:function(e,t,r,n,l,c,h){var d=(t-e)/l-(r-e)/(l+c)+(r-t)/c,f=(r-t)/c-(n-t)/(c+h)+(n-r)/h;o(t,r,d*=c,f*=c)},calc:function(o){var l=o*o;return e+t*o+r*l+n*(l*o)}}}STLLoader.prototype={constructor:STLLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){try{t(o.parse(text))}catch(e){n&&n(e)}}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){function e(e,t,r){for(var i=0,n=e.length;i<n;i++)if(e[i]!==t.getUint8(r+i,!1))return!1;return!0}var t,r=function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=255&e.charCodeAt(i);return t.buffer||t}return e}(data);return function(data){var t;if(50,84+50*(t=new DataView(data)).getUint32(80,!0)===t.byteLength)return!0;for(var r=[115,111,108,105,100],n=0;n<5;n++)if(e(r,t,n))return!1;return!0}(r)?function(data){for(var e,g,b,t,r,n,o,l,c=new DataView(data),h=c.getUint32(80,!0),d=!1,f=0;f<70;f++)1129270351==c.getUint32(f,!1)&&82==c.getUint8(f+4)&&61==c.getUint8(f+5)&&(d=!0,t=[],r=c.getUint8(f+6)/255,n=c.getUint8(f+7)/255,o=c.getUint8(f+8)/255,l=c.getUint8(f+9)/255);for(var m=new BufferGeometry,v=[],y=[],x=0;x<h;x++){var w=84+50*x,M=c.getFloat32(w,!0),S=c.getFloat32(w+4,!0),A=c.getFloat32(w+8,!0);if(d){var T=c.getUint16(w+48,!0);0==(32768&T)?(e=(31&T)/31,g=(T>>5&31)/31,b=(T>>10&31)/31):(e=r,g=n,b=o)}for(var i=1;i<=3;i++){var _=w+12*i;v.push(c.getFloat32(_,!0)),v.push(c.getFloat32(_+4,!0)),v.push(c.getFloat32(_+8,!0)),y.push(M,S,A),d&&t.push(e,g,b)}}return m.addAttribute("position",new BufferAttribute(new Float32Array(v),3)),m.addAttribute("normal",new BufferAttribute(new Float32Array(y),3)),d&&(m.addAttribute("color",new BufferAttribute(new Float32Array(t),3)),m.hasColors=!0,m.alpha=l),m}(r):function(data){for(var e,t=new BufferGeometry,r=/facet([\s\S]*?)endfacet/g,n=0,o=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,l=new RegExp("vertex"+o+o+o,"g"),c=new RegExp("normal"+o+o+o,"g"),h=[],d=[],f=new Vector3;null!==(e=r.exec(data));){for(var m=0,v=0,text=e[0];null!==(e=c.exec(text));)f.x=parseFloat(e[1]),f.y=parseFloat(e[2]),f.z=parseFloat(e[3]),v++;for(;null!==(e=l.exec(text));)h.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),d.push(f.x,f.y,f.z),m++;1!==v&&console.error("STLLoader: Something isn't right with the normal of face number "+n),3!==m&&console.error("STLLoader: Something isn't right with the vertices of face number "+n),n++}return t.addAttribute("position",new Float32BufferAttribute(h,3)),t.addAttribute("normal",new Float32BufferAttribute(d,3)),t}("string"!=typeof(t=data)?LoaderUtils.decodeText(new Uint8Array(t)):t)}},EllipseCurve.prototype=Object.create(Curve.prototype),EllipseCurve.prototype.constructor=EllipseCurve,EllipseCurve.prototype.isEllipseCurve=!0,EllipseCurve.prototype.getPoint=function(e,t){for(var r=t||new Vector2,n=2*Math.PI,o=this.aEndAngle-this.aStartAngle,l=Math.abs(o)<Number.EPSILON;o<0;)o+=n;for(;o>n;)o-=n;o<Number.EPSILON&&(o=l?0:n),!0!==this.aClockwise||l||(o===n?o=-n:o-=n);var c=this.aStartAngle+e*o,h=this.aX+this.xRadius*Math.cos(c),d=this.aY+this.yRadius*Math.sin(c);if(0!==this.aRotation){var f=Math.cos(this.aRotation),m=Math.sin(this.aRotation),v=h-this.aX,y=d-this.aY;h=v*f-y*m+this.aX,d=v*m+y*f+this.aY}return r.set(h,d)},EllipseCurve.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.aX=source.aX,this.aY=source.aY,this.xRadius=source.xRadius,this.yRadius=source.yRadius,this.aStartAngle=source.aStartAngle,this.aEndAngle=source.aEndAngle,this.aClockwise=source.aClockwise,this.aRotation=source.aRotation,this},EllipseCurve.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.aX=this.aX,data.aY=this.aY,data.xRadius=this.xRadius,data.yRadius=this.yRadius,data.aStartAngle=this.aStartAngle,data.aEndAngle=this.aEndAngle,data.aClockwise=this.aClockwise,data.aRotation=this.aRotation,data},EllipseCurve.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this},ArcCurve.prototype=Object.create(EllipseCurve.prototype),ArcCurve.prototype.constructor=ArcCurve,ArcCurve.prototype.isArcCurve=!0;var tmp=new Vector3,px=new CubicPoly,py=new CubicPoly,pz=new CubicPoly;function CatmullRomCurve3(e,t,r,n){Curve.call(this),this.type="CatmullRomCurve3",this.points=e||[],this.closed=t||!1,this.curveType=r||"centripetal",this.tension=n||.5}function CatmullRom(e,t,r,n,o){var l=.5*(n-t),c=.5*(o-r),h=e*e;return(2*r-2*n+l+c)*(e*h)+(-3*r+3*n-2*l-c)*h+l*e+r}function QuadraticBezierP0(e,p){var t=1-e;return t*t*p}function QuadraticBezierP1(e,p){return 2*(1-e)*e*p}function QuadraticBezierP2(e,p){return e*e*p}function QuadraticBezier(e,t,r,n){return QuadraticBezierP0(e,t)+QuadraticBezierP1(e,r)+QuadraticBezierP2(e,n)}function CubicBezierP0(e,p){var t=1-e;return t*t*t*p}function CubicBezierP1(e,p){var t=1-e;return 3*t*t*e*p}function CubicBezierP2(e,p){return 3*(1-e)*e*e*p}function CubicBezierP3(e,p){return e*e*e*p}function CubicBezier(e,t,r,n,o){return CubicBezierP0(e,t)+CubicBezierP1(e,r)+CubicBezierP2(e,n)+CubicBezierP3(e,o)}function CubicBezierCurve(e,t,r,n){Curve.call(this),this.type="CubicBezierCurve",this.v0=e||new Vector2,this.v1=t||new Vector2,this.v2=r||new Vector2,this.v3=n||new Vector2}function CubicBezierCurve3(e,t,r,n){Curve.call(this),this.type="CubicBezierCurve3",this.v0=e||new Vector3,this.v1=t||new Vector3,this.v2=r||new Vector3,this.v3=n||new Vector3}function LineCurve(e,t){Curve.call(this),this.type="LineCurve",this.v1=e||new Vector2,this.v2=t||new Vector2}function LineCurve3(e,t){Curve.call(this),this.type="LineCurve3",this.v1=e||new Vector3,this.v2=t||new Vector3}function QuadraticBezierCurve(e,t,r){Curve.call(this),this.type="QuadraticBezierCurve",this.v0=e||new Vector2,this.v1=t||new Vector2,this.v2=r||new Vector2}function QuadraticBezierCurve3(e,t,r){Curve.call(this),this.type="QuadraticBezierCurve3",this.v0=e||new Vector3,this.v1=t||new Vector3,this.v2=r||new Vector3}function SplineCurve(e){Curve.call(this),this.type="SplineCurve",this.points=e||[]}CatmullRomCurve3.prototype=Object.create(Curve.prototype),CatmullRomCurve3.prototype.constructor=CatmullRomCurve3,CatmullRomCurve3.prototype.isCatmullRomCurve3=!0,CatmullRomCurve3.prototype.getPoint=function(e,t){var r,n,o,l,c=t||new Vector3,h=this.points,d=h.length,p=(d-(this.closed?0:1))*e,f=Math.floor(p),m=p-f;if(this.closed?f+=f>0?0:(Math.floor(Math.abs(f)/d)+1)*d:0===m&&f===d-1&&(f=d-2,m=1),this.closed||f>0?r=h[(f-1)%d]:(tmp.subVectors(h[0],h[1]).add(h[0]),r=tmp),n=h[f%d],o=h[(f+1)%d],this.closed||f+2<d?l=h[(f+2)%d]:(tmp.subVectors(h[d-1],h[d-2]).add(h[d-1]),l=tmp),"centripetal"===this.curveType||"chordal"===this.curveType){var v="chordal"===this.curveType?.5:.25,y=Math.pow(r.distanceToSquared(n),v),x=Math.pow(n.distanceToSquared(o),v),w=Math.pow(o.distanceToSquared(l),v);x<1e-4&&(x=1),y<1e-4&&(y=x),w<1e-4&&(w=x),px.initNonuniformCatmullRom(r.x,n.x,o.x,l.x,y,x,w),py.initNonuniformCatmullRom(r.y,n.y,o.y,l.y,y,x,w),pz.initNonuniformCatmullRom(r.z,n.z,o.z,l.z,y,x,w)}else"catmullrom"===this.curveType&&(px.initCatmullRom(r.x,n.x,o.x,l.x,this.tension),py.initCatmullRom(r.y,n.y,o.y,l.y,this.tension),pz.initCatmullRom(r.z,n.z,o.z,l.z,this.tension));return c.set(px.calc(m),py.calc(m),pz.calc(m)),c},CatmullRomCurve3.prototype.copy=function(source){Curve.prototype.copy.call(this,source),this.points=[];for(var i=0,e=source.points.length;i<e;i++){var t=source.points[i];this.points.push(t.clone())}return this.closed=source.closed,this.curveType=source.curveType,this.tension=source.tension,this},CatmullRomCurve3.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);data.points=[];for(var i=0,e=this.points.length;i<e;i++){var t=this.points[i];data.points.push(t.toArray())}return data.closed=this.closed,data.curveType=this.curveType,data.tension=this.tension,data},CatmullRomCurve3.prototype.fromJSON=function(e){Curve.prototype.fromJSON.call(this,e),this.points=[];for(var i=0,t=e.points.length;i<t;i++){var r=e.points[i];this.points.push((new Vector3).fromArray(r))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this},CubicBezierCurve.prototype=Object.create(Curve.prototype),CubicBezierCurve.prototype.constructor=CubicBezierCurve,CubicBezierCurve.prototype.isCubicBezierCurve=!0,CubicBezierCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,n=this.v0,o=this.v1,l=this.v2,c=this.v3;return r.set(CubicBezier(e,n.x,o.x,l.x,c.x),CubicBezier(e,n.y,o.y,l.y,c.y)),r},CubicBezierCurve.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this.v3.copy(source.v3),this},CubicBezierCurve.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data.v3=this.v3.toArray(),data},CubicBezierCurve.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this},CubicBezierCurve3.prototype=Object.create(Curve.prototype),CubicBezierCurve3.prototype.constructor=CubicBezierCurve3,CubicBezierCurve3.prototype.isCubicBezierCurve3=!0,CubicBezierCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3,n=this.v0,o=this.v1,l=this.v2,c=this.v3;return r.set(CubicBezier(e,n.x,o.x,l.x,c.x),CubicBezier(e,n.y,o.y,l.y,c.y),CubicBezier(e,n.z,o.z,l.z,c.z)),r},CubicBezierCurve3.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this.v3.copy(source.v3),this},CubicBezierCurve3.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data.v3=this.v3.toArray(),data},CubicBezierCurve3.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this},LineCurve.prototype=Object.create(Curve.prototype),LineCurve.prototype.constructor=LineCurve,LineCurve.prototype.isLineCurve=!0,LineCurve.prototype.getPoint=function(e,t){var r=t||new Vector2;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},LineCurve.prototype.getPointAt=function(u,e){return this.getPoint(u,e)},LineCurve.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},LineCurve.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v1.copy(source.v1),this.v2.copy(source.v2),this},LineCurve.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data},LineCurve.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this},LineCurve3.prototype=Object.create(Curve.prototype),LineCurve3.prototype.constructor=LineCurve3,LineCurve3.prototype.isLineCurve3=!0,LineCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3;return 1===e?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r},LineCurve3.prototype.getPointAt=function(u,e){return this.getPoint(u,e)},LineCurve3.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v1.copy(source.v1),this.v2.copy(source.v2),this},LineCurve3.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data},LineCurve3.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this},QuadraticBezierCurve.prototype=Object.create(Curve.prototype),QuadraticBezierCurve.prototype.constructor=QuadraticBezierCurve,QuadraticBezierCurve.prototype.isQuadraticBezierCurve=!0,QuadraticBezierCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,n=this.v0,o=this.v1,l=this.v2;return r.set(QuadraticBezier(e,n.x,o.x,l.x),QuadraticBezier(e,n.y,o.y,l.y)),r},QuadraticBezierCurve.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this},QuadraticBezierCurve.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data},QuadraticBezierCurve.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this},QuadraticBezierCurve3.prototype=Object.create(Curve.prototype),QuadraticBezierCurve3.prototype.constructor=QuadraticBezierCurve3,QuadraticBezierCurve3.prototype.isQuadraticBezierCurve3=!0,QuadraticBezierCurve3.prototype.getPoint=function(e,t){var r=t||new Vector3,n=this.v0,o=this.v1,l=this.v2;return r.set(QuadraticBezier(e,n.x,o.x,l.x),QuadraticBezier(e,n.y,o.y,l.y),QuadraticBezier(e,n.z,o.z,l.z)),r},QuadraticBezierCurve3.prototype.copy=function(source){return Curve.prototype.copy.call(this,source),this.v0.copy(source.v0),this.v1.copy(source.v1),this.v2.copy(source.v2),this},QuadraticBezierCurve3.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);return data.v0=this.v0.toArray(),data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data},QuadraticBezierCurve3.prototype.fromJSON=function(e){return Curve.prototype.fromJSON.call(this,e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this},SplineCurve.prototype=Object.create(Curve.prototype),SplineCurve.prototype.constructor=SplineCurve,SplineCurve.prototype.isSplineCurve=!0,SplineCurve.prototype.getPoint=function(e,t){var r=t||new Vector2,n=this.points,p=(n.length-1)*e,o=Math.floor(p),l=p-o,c=n[0===o?o:o-1],h=n[o],d=n[o>n.length-2?n.length-1:o+1],f=n[o>n.length-3?n.length-1:o+2];return r.set(CatmullRom(l,c.x,h.x,d.x,f.x),CatmullRom(l,c.y,h.y,d.y,f.y)),r},SplineCurve.prototype.copy=function(source){Curve.prototype.copy.call(this,source),this.points=[];for(var i=0,e=source.points.length;i<e;i++){var t=source.points[i];this.points.push(t.clone())}return this},SplineCurve.prototype.toJSON=function(){var data=Curve.prototype.toJSON.call(this);data.points=[];for(var i=0,e=this.points.length;i<e;i++){var t=this.points[i];data.points.push(t.toArray())}return data},SplineCurve.prototype.fromJSON=function(e){Curve.prototype.fromJSON.call(this,e),this.points=[];for(var i=0,t=e.points.length;i<t;i++){var r=e.points[i];this.points.push((new Vector2).fromArray(r))}return this};var Curves$1={ArcCurve:ArcCurve,CatmullRomCurve3:CatmullRomCurve3,CubicBezierCurve:CubicBezierCurve,CubicBezierCurve3:CubicBezierCurve3,EllipseCurve:EllipseCurve,LineCurve:LineCurve,LineCurve3:LineCurve3,QuadraticBezierCurve:QuadraticBezierCurve,QuadraticBezierCurve3:QuadraticBezierCurve3,SplineCurve:SplineCurve};function CurvePath(){Curve.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function Path(e){CurvePath.call(this),this.type="Path",this.currentPoint=new Vector2,e&&this.setFromPoints(e)}function Shape(e){Path.call(this,e),this.uuid=_Math.generateUUID(),this.type="Shape",this.holes=[]}CurvePath.prototype=Object.assign(Object.create(Curve.prototype),{constructor:CurvePath,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Curves$1.LineCurve(t,e))},getPoint:function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),i=0;i<r.length;){if(r[i]>=t){var n=r[i]-t,o=this.curves[i],l=o.getLength(),u=0===l?0:1-n/l;return o.getPointAt(u)}i++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,i=0,r=this.curves.length;i<r;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,r=[],i=0,n=this.curves;i<n.length;i++)for(var o=n[i],l=o&&o.isEllipseCurve?2*e:o&&(o.isLineCurve||o.isLineCurve3)?1:o&&o.isSplineCurve?e*o.points.length:e,c=o.getPoints(l),h=0;h<c.length;h++){var d=c[h];t&&t.equals(d)||(r.push(d),t=d)}return this.autoClose&&r.length>1&&!r[r.length-1].equals(r[0])&&r.push(r[0]),r},copy:function(source){Curve.prototype.copy.call(this,source),this.curves=[];for(var i=0,e=source.curves.length;i<e;i++){var t=source.curves[i];this.curves.push(t.clone())}return this.autoClose=source.autoClose,this},toJSON:function(){var data=Curve.prototype.toJSON.call(this);data.autoClose=this.autoClose,data.curves=[];for(var i=0,e=this.curves.length;i<e;i++){var t=this.curves[i];data.curves.push(t.toJSON())}return data},fromJSON:function(e){Curve.prototype.fromJSON.call(this,e),this.autoClose=e.autoClose,this.curves=[];for(var i=0,t=e.curves.length;i<t;i++){var r=e.curves[i];this.curves.push((new Curves$1[r.type]).fromJSON(r))}return this}}),Path.prototype=Object.assign(Object.create(CurvePath.prototype),{constructor:Path,setFromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var i=1,t=e.length;i<t;i++)this.lineTo(e[i].x,e[i].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var r=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));this.curves.push(r),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,r,n){var o=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,n));this.curves.push(o),this.currentPoint.set(r,n)},bezierCurveTo:function(e,t,r,n,o,l){var c=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,n),new Vector2(o,l));this.curves.push(c),this.currentPoint.set(o,l)},splineThru:function(e){var t=new SplineCurve([this.currentPoint.clone()].concat(e));this.curves.push(t),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,r,n,o,l){var c=this.currentPoint.x,h=this.currentPoint.y;this.absarc(e+c,t+h,r,n,o,l)},absarc:function(e,t,r,n,o,l){this.absellipse(e,t,r,r,n,o,l)},ellipse:function(e,t,r,n,o,l,c,h){var d=this.currentPoint.x,f=this.currentPoint.y;this.absellipse(e+d,t+f,r,n,o,l,c,h)},absellipse:function(e,t,r,n,o,l,c,h){var d=new EllipseCurve(e,t,r,n,o,l,c,h);if(this.curves.length>0){var f=d.getPoint(0);f.equals(this.currentPoint)||this.lineTo(f.x,f.y)}this.curves.push(d);var m=d.getPoint(1);this.currentPoint.copy(m)},copy:function(source){return CurvePath.prototype.copy.call(this,source),this.currentPoint.copy(source.currentPoint),this},toJSON:function(){var data=CurvePath.prototype.toJSON.call(this);return data.currentPoint=this.currentPoint.toArray(),data},fromJSON:function(e){return CurvePath.prototype.fromJSON.call(this,e),this.currentPoint.fromArray(e.currentPoint),this}}),Shape.prototype=Object.assign(Object.create(Path.prototype),{constructor:Shape,getPointsHoles:function(e){for(var t=[],i=0,r=this.holes.length;i<r;i++)t[i]=this.holes[i].getPoints(e);return t},extractPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},copy:function(source){Path.prototype.copy.call(this,source),this.holes=[];for(var i=0,e=source.holes.length;i<e;i++){var t=source.holes[i];this.holes.push(t.clone())}return this},toJSON:function(){var data=Path.prototype.toJSON.call(this);data.uuid=this.uuid,data.holes=[];for(var i=0,e=this.holes.length;i<e;i++){var t=this.holes[i];data.holes.push(t.toJSON())}return data},fromJSON:function(e){Path.prototype.fromJSON.call(this,e),this.uuid=e.uuid,this.holes=[];for(var i=0,t=e.holes.length;i<t;i++){var r=e.holes[i];this.holes.push((new Path).fromJSON(r))}return this}});var Earcut={triangulate:function(data,e,t){t=t||2;var r,n,o,l,c,h,d,f=e&&e.length,m=f?e[0]*t:data.length,v=linkedList(data,0,m,t,!0),y=[];if(!v)return y;if(f&&(v=eliminateHoles(data,e,v,t)),data.length>80*t){r=o=data[0],n=l=data[1];for(var i=t;i<m;i+=t)(c=data[i])<r&&(r=c),(h=data[i+1])<n&&(n=h),c>o&&(o=c),h>l&&(l=h);d=0!==(d=Math.max(o-r,l-n))?1/d:0}return earcutLinked(v,y,t,r,n,d),y}};function linkedList(data,e,t,r,n){var i,o;if(n===signedArea(data,e,t,r)>0)for(i=e;i<t;i+=r)o=insertNode(i,data[i],data[i+1],o);else for(i=t-r;i>=e;i-=r)o=insertNode(i,data[i],data[i+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);var r,p=e;do{if(r=!1,p.steiner||!equals(p,p.next)&&0!==area(p.prev,p,p.next))p=p.next;else{if(removeNode(p),(p=t=p.prev)===p.next)break;r=!0}}while(r||p!==t);return t}function earcutLinked(e,t,r,n,o,l,c){if(e){!c&&l&&indexCurve(e,n,o,l);for(var h,d,f=e;e.prev!==e.next;)if(h=e.prev,d=e.next,l?isEarHashed(e,n,o,l):isEar(e))t.push(h.i/r),t.push(e.i/r),t.push(d.i/r),removeNode(e),e=d.next,f=d.next;else if((e=d)===f){c?1===c?earcutLinked(e=cureLocalIntersections(e,t,r),t,r,n,o,l,2):2===c&&splitEarcut(e,t,r,n,o,l):earcutLinked(filterPoints(e),t,r,n,o,l,1);break}}}function isEar(e){var a=e.prev,b=e,t=e.next;if(area(a,b,t)>=0)return!1;for(var p=e.next.next;p!==e.prev;){if(pointInTriangle(a.x,a.y,b.x,b.y,t.x,t.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function isEarHashed(e,t,r,n){var a=e.prev,b=e,o=e.next;if(area(a,b,o)>=0)return!1;for(var l=a.x<b.x?a.x<o.x?a.x:o.x:b.x<o.x?b.x:o.x,c=a.y<b.y?a.y<o.y?a.y:o.y:b.y<o.y?b.y:o.y,h=a.x>b.x?a.x>o.x?a.x:o.x:b.x>o.x?b.x:o.x,d=a.y>b.y?a.y>o.y?a.y:o.y:b.y>o.y?b.y:o.y,f=zOrder(l,c,t,r,n),m=zOrder(h,d,t,r,n),p=e.nextZ;p&&p.z<=m;){if(p!==e.prev&&p!==e.next&&pointInTriangle(a.x,a.y,b.x,b.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=e.prevZ;p&&p.z>=f;){if(p!==e.prev&&p!==e.next&&pointInTriangle(a.x,a.y,b.x,b.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function cureLocalIntersections(e,t,r){var p=e;do{var a=p.prev,b=p.next.next;!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)&&(t.push(a.i/r),t.push(p.i/r),t.push(b.i/r),removeNode(p),removeNode(p.next),p=e=b),p=p.next}while(p!==e);return p}function splitEarcut(e,t,r,n,o,l){var a=e;do{for(var b=a.next.next;b!==a.prev;){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);return a=filterPoints(a,a.next),c=filterPoints(c,c.next),earcutLinked(a,t,r,n,o,l),void earcutLinked(c,t,r,n,o,l)}b=b.next}a=a.next}while(a!==e)}function eliminateHoles(data,e,t,r){var i,n,o,l=[];for(i=0,n=e.length;i<n;i++)(o=linkedList(data,e[i]*r,i<n-1?e[i+1]*r:data.length,r,!1))===o.next&&(o.steiner=!0),l.push(getLeftmost(o));for(l.sort(compareX),i=0;i<l.length;i++)eliminateHole(l[i],t),t=filterPoints(t,t.next);return t}function compareX(a,b){return a.x-b.x}function eliminateHole(e,t){if(t=findHoleBridge(e,t)){var b=splitPolygon(t,e);filterPoints(b,b.next)}}function findHoleBridge(e,t){var r,p=t,n=e.x,o=e.y,l=-1/0;do{if(o<=p.y&&o>=p.next.y&&p.next.y!==p.y){var c=p.x+(o-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(c<=n&&c>l){if(l=c,c===n){if(o===p.y)return p;if(o===p.next.y)return p.next}r=p.x<p.next.x?p:p.next}}p=p.next}while(p!==t);if(!r)return null;if(n===l)return r.prev;var h,d=r,f=r.x,m=r.y,v=1/0;for(p=r.next;p!==d;)n>=p.x&&p.x>=f&&n!==p.x&&pointInTriangle(o<m?n:l,o,f,m,o<m?l:n,o,p.x,p.y)&&((h=Math.abs(o-p.y)/(n-p.x))<v||h===v&&p.x>r.x)&&locallyInside(p,e)&&(r=p,v=h),p=p.next;return r}function indexCurve(e,t,r,n){var p=e;do{null===p.z&&(p.z=zOrder(p.x,p.y,t,r,n)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next}while(p!==e);p.prevZ.nextZ=null,p.prevZ=null,sortLinked(p)}function sortLinked(e){var i,p,q,t,r,n,o,l,c=1;do{for(p=e,e=null,r=null,n=0;p;){for(n++,q=p,o=0,i=0;i<c&&(o++,q=q.nextZ);i++);for(l=c;o>0||l>0&&q;)0!==o&&(0===l||!q||p.z<=q.z)?(t=p,p=p.nextZ,o--):(t=q,q=q.nextZ,l--),r?r.nextZ=t:e=t,t.prevZ=r,r=t;p=q}r.nextZ=null,c*=2}while(n>1);return e}function zOrder(e,t,r,n,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*o)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){var p=e,t=e;do{p.x<t.x&&(t=p),p=p.next}while(p!==e);return t}function pointInTriangle(e,t,r,n,o,l,c,h){return(o-c)*(t-h)-(e-c)*(l-h)>=0&&(e-c)*(n-h)-(r-c)*(t-h)>=0&&(r-c)*(l-h)-(o-c)*(n-h)>=0}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!intersectsPolygon(a,b)&&locallyInside(a,b)&&locallyInside(b,a)&&middleInside(a,b)}function area(p,q,e){return(q.y-p.y)*(e.x-q.x)-(q.x-p.x)*(e.y-q.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,r,n){return!!(equals(e,t)&&equals(r,n)||equals(e,n)&&equals(r,t))||area(e,t,r)>0!=area(e,t,n)>0&&area(r,n,e)>0!=area(r,n,t)>0}function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return!0;p=p.next}while(p!==a);return!1}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function middleInside(a,b){var p=a,e=!1,t=(a.x+b.x)/2,r=(a.y+b.y)/2;do{p.y>r!=p.next.y>r&&p.next.y!==p.y&&t<(p.next.x-p.x)*(r-p.y)/(p.next.y-p.y)+p.x&&(e=!e),p=p.next}while(p!==a);return e}function splitPolygon(a,b){var e=new Node(a.i,a.x,a.y),t=new Node(b.i,b.x,b.y),r=a.next,n=b.prev;return a.next=b,b.prev=a,e.next=r,r.prev=e,t.next=e,e.prev=t,n.next=t,t.prev=n,t}function insertNode(i,e,t,r){var p=new Node(i,e,t);return r?(p.next=r.next,p.prev=r,r.next.prev=p,r.next=p):(p.prev=p,p.next=p),p}function removeNode(p){p.next.prev=p.prev,p.prev.next=p.next,p.prevZ&&(p.prevZ.nextZ=p.nextZ),p.nextZ&&(p.nextZ.prevZ=p.prevZ)}function Node(i,e,t){this.i=i,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function signedArea(data,e,t,r){for(var n=0,i=e,o=t-r;i<t;i+=r)n+=(data[o]-data[i])*(data[i+1]+data[o+1]),o=i;return n}var ShapeUtils={area:function(e){for(var t=e.length,a=0,p=t-1,q=0;q<t;p=q++)a+=e[p].x*e[q].y-e[q].x*e[p].y;return.5*a},isClockWise:function(e){return ShapeUtils.area(e)<0},triangulateShape:function(e,t){var r=[],n=[],o=[];removeDupEndPts(e),addContour(r,e);var l=e.length;t.forEach(removeDupEndPts);for(var i=0;i<t.length;i++)n.push(l),l+=t[i].length,addContour(r,t[i]);var c=Earcut.triangulate(r,n);for(i=0;i<c.length;i+=3)o.push(c.slice(i,i+3));return o}};function removeDupEndPts(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function addContour(e,t){for(var i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y)}function ShapePath(){this.type="ShapePath",this.color=new Color,this.subPaths=[],this.currentPath=null}Object.assign(ShapePath.prototype,{moveTo:function(e,t){this.currentPath=new Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,r,n){this.currentPath.quadraticCurveTo(e,t,r,n)},bezierCurveTo:function(e,t,r,n,o,l){this.currentPath.bezierCurveTo(e,t,r,n,o,l)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function r(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i],o=new Shape;o.curves=n.curves,t.push(o)}return t}function n(e,t){for(var r=t.length,n=!1,p=r-1,q=0;q<r;p=q++){var o=t[p],l=t[q],c=l.x-o.x,h=l.y-o.y;if(Math.abs(h)>Number.EPSILON){if(h<0&&(o=t[q],c=-c,l=t[p],h=-h),e.y<o.y||e.y>l.y)continue;if(e.y===o.y){if(e.x===o.x)return!0}else{var d=h*(e.x-o.x)-c*(e.y-o.y);if(0===d)return!0;if(d<0)continue;n=!n}}else{if(e.y!==o.y)continue;if(l.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=l.x)return!0}}return n}var o=ShapeUtils.isClockWise,l=this.subPaths;if(0===l.length)return[];if(!0===t)return r(l);var c,h,d,f=[];if(1===l.length)return h=l[0],(d=new Shape).curves=h.curves,f.push(d),f;var m=!o(l[0].getPoints());m=e?!m:m;var v,y,x=[],w=[],M=[],S=0;w[S]=void 0,M[S]=[];for(var i=0,A=l.length;i<A;i++)c=o(v=(h=l[i]).getPoints()),(c=e?!c:c)?(!m&&w[S]&&S++,w[S]={s:new Shape,p:v},w[S].s.curves=h.curves,m&&S++,M[S]=[]):M[S].push({h:h,p:v[0]});if(!w[0])return r(l);if(w.length>1){for(var T=!1,_=[],L=0,C=w.length;L<C;L++)x[L]=[];for(L=0,C=w.length;L<C;L++)for(var N=M[L],P=0;P<N.length;P++){for(var E=N[P],D=!0,F=0;F<w.length;F++)n(E.p,w[F].p)&&(L!==F&&_.push({froms:L,tos:F,hole:P}),D?(D=!1,x[F].push(E)):T=!0);D&&x[L].push(E)}_.length>0&&(T||(M=x))}i=0;for(var R=w.length;i<R;i++){d=w[i].s,f.push(d);for(var O=0,B=(y=M[i]).length;O<B;O++)d.holes.push(y[O].h)}return f}});var SVGLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};SVGLoader.prototype={constructor:SVGLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(text){function e(path,e,r,n,o,l,c,h){n=n*Math.PI/180,e=Math.abs(e),r=Math.abs(r);var d=(c.x-h.x)/2,f=(c.y-h.y)/2,m=Math.cos(n)*d+Math.sin(n)*f,v=-Math.sin(n)*d+Math.cos(n)*f,y=e*e,x=r*r,w=m*m,M=v*v,S=w/y+M/x;if(S>1){var s=Math.sqrt(S);y=(e*=s)*e,x=(r*=s)*r}var A=y*M+x*w,T=(y*x-A)/A,q=Math.sqrt(Math.max(0,T));o===l&&(q=-q);var _=q*e*v/r,L=-q*r*m/e,C=Math.cos(n)*_-Math.sin(n)*L+(c.x+h.x)/2,N=Math.sin(n)*_+Math.cos(n)*L+(c.y+h.y)/2,P=t(1,0,(m-_)/e,(v-L)/r),E=t((m-_)/e,(v-L)/r,(-m-_)/e,(-v-L)/r)%(2*Math.PI);path.currentPath.absellipse(C,N,e,r,P,P+E,0===l,n)}function t(e,t,r,n){var o=e*r+t*n,l=Math.sqrt(e*e+t*t)*Math.sqrt(r*r+n*n),c=Math.acos(Math.max(-1,Math.min(1,o/l)));return e*n-t*r<0&&(c=-c),c}function r(e,style){return style=Object.assign({},style),e.hasAttribute("fill")&&(style.fill=e.getAttribute("fill")),""!==e.style.fill&&(style.fill=e.style.fill),style}function n(style){return"none"!==style.fill&&"transparent"!==style.fill}function o(a,b){return a-(b-a)}function l(e){for(var t=e.split(/[\s,]+|(?=\s?[+\-])/),i=0;i<t.length;i++){var r=t[i];if(r.indexOf(".")!==r.lastIndexOf("."))for(var n=r.split("."),s=2;s<n.length;s++)t.splice(i+s-1,0,"0."+n[s]);t[i]=parseFloat(r)}return t}function c(e){var t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function h(e){var t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}console.log("SVGLoader");var d=[],f=[],m=new Matrix3,v=new Matrix3,y=new Matrix3,x=new Matrix3,w=new Matrix3;console.time("SVGLoader: DOMParser");var M=(new DOMParser).parseFromString(text,"image/svg+xml");return console.timeEnd("SVGLoader: DOMParser"),console.time("SVGLoader: Parse"),function t(M,style){if(1===M.nodeType){var S=function(e){if(!e.hasAttribute("transform"))return null;var t=function(e){for(var t=new Matrix3,r=m,n=e.getAttribute("transform").split(" "),o=n.length-1;o>=0;o--){var c=n[o],h=c.indexOf("("),d=c.indexOf(")");if(h>0&&h<d){var f=c.substr(0,h),w=l(c.substr(h+1,d-h-1));switch(r.identity(),f){case"translate":if(w.length>=1){var M=w[0],S=M;w.length>=2&&(S=w[1]),r.translate(M,S)}break;case"rotate":if(w.length>=1){var A,T=0,_=0;A=-w[0]*Math.PI/180,w.length>=3&&(T=w[1],_=w[2]),v.identity().translate(-T,-_),y.identity().rotate(A),x.multiplyMatrices(y,v),v.identity().translate(T,_),r.multiplyMatrices(v,x)}break;case"scale":if(w.length>=1){var L=w[0],C=L;w.length>=2&&(C=w[1]),r.scale(L,C)}break;case"skewX":1===w.length&&r.set(1,Math.tan(w[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===w.length&&r.set(1,0,0,Math.tan(w[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===w.length&&r.set(w[0],w[2],w[4],w[1],w[3],w[5],0,0,1)}}t.premultiply(r)}return t}(e);t&&(f.length>0&&t.premultiply(f[f.length-1]),w.copy(t),f.push(t));return t}(M),path=null;switch(M.nodeName){case"svg":break;case"g":style=r(M,style);break;case"path":style=r(M,style),M.hasAttribute("d")&&n(style)&&(path=function(t,style){var path=new ShapePath;path.color.setStyle(style.fill);for(var r=new Vector2,n=new Vector2,c=new Vector2,h=!0,d=!1,f=t.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi),i=0,m=f.length;i<m;i++){var v=f[i],y=v.charAt(0),data=v.substr(1).trim();switch(!0===h&&(d=!0,h=!1),y){case"M":for(var x=l(data),w=0,M=x.length;w<M;w+=2)r.x=x[w+0],r.y=x[w+1],n.x=r.x,n.y=r.y,0===w?path.moveTo(r.x,r.y):path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"H":for(x=l(data),w=0,M=x.length;w<M;w++)r.x=x[w],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"V":for(x=l(data),w=0,M=x.length;w<M;w++)r.y=x[w],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"L":for(x=l(data),w=0,M=x.length;w<M;w+=2)r.x=x[w+0],r.y=x[w+1],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"C":for(x=l(data),w=0,M=x.length;w<M;w+=6)path.bezierCurveTo(x[w+0],x[w+1],x[w+2],x[w+3],x[w+4],x[w+5]),n.x=x[w+2],n.y=x[w+3],r.x=x[w+4],r.y=x[w+5],0===w&&!0===d&&c.copy(r);break;case"S":for(x=l(data),w=0,M=x.length;w<M;w+=4)path.bezierCurveTo(o(r.x,n.x),o(r.y,n.y),x[w+0],x[w+1],x[w+2],x[w+3]),n.x=x[w+0],n.y=x[w+1],r.x=x[w+2],r.y=x[w+3],0===w&&!0===d&&c.copy(r);break;case"Q":for(x=l(data),w=0,M=x.length;w<M;w+=4)path.quadraticCurveTo(x[w+0],x[w+1],x[w+2],x[w+3]),n.x=x[w+0],n.y=x[w+1],r.x=x[w+2],r.y=x[w+3],0===w&&!0===d&&c.copy(r);break;case"T":for(x=l(data),w=0,M=x.length;w<M;w+=2){var S=o(r.x,n.x),A=o(r.y,n.y);path.quadraticCurveTo(S,A,x[w+0],x[w+1]),n.x=S,n.y=A,r.x=x[w+0],r.y=x[w+1],0===w&&!0===d&&c.copy(r)}break;case"A":for(x=l(data),w=0,M=x.length;w<M;w+=7){var T=r.clone();r.x=x[w+5],r.y=x[w+6],n.x=r.x,n.y=r.y,e(path,x[w],x[w+1],x[w+2],x[w+3],x[w+4],T,r),0===w&&!0===d&&c.copy(r)}break;case"m":for(x=l(data),w=0,M=x.length;w<M;w+=2)r.x+=x[w+0],r.y+=x[w+1],n.x=r.x,n.y=r.y,0===w?path.moveTo(r.x,r.y):path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"h":for(x=l(data),w=0,M=x.length;w<M;w++)r.x+=x[w],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"v":for(x=l(data),w=0,M=x.length;w<M;w++)r.y+=x[w],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"l":for(x=l(data),w=0,M=x.length;w<M;w+=2)r.x+=x[w+0],r.y+=x[w+1],n.x=r.x,n.y=r.y,path.lineTo(r.x,r.y),0===w&&!0===d&&c.copy(r);break;case"c":for(x=l(data),w=0,M=x.length;w<M;w+=6)path.bezierCurveTo(r.x+x[w+0],r.y+x[w+1],r.x+x[w+2],r.y+x[w+3],r.x+x[w+4],r.y+x[w+5]),n.x=r.x+x[w+2],n.y=r.y+x[w+3],r.x+=x[w+4],r.y+=x[w+5],0===w&&!0===d&&c.copy(r);break;case"s":for(x=l(data),w=0,M=x.length;w<M;w+=4)path.bezierCurveTo(o(r.x,n.x),o(r.y,n.y),r.x+x[w+0],r.y+x[w+1],r.x+x[w+2],r.y+x[w+3]),n.x=r.x+x[w+0],n.y=r.y+x[w+1],r.x+=x[w+2],r.y+=x[w+3],0===w&&!0===d&&c.copy(r);break;case"q":for(x=l(data),w=0,M=x.length;w<M;w+=4)path.quadraticCurveTo(r.x+x[w+0],r.y+x[w+1],r.x+x[w+2],r.y+x[w+3]),n.x=r.x+x[w+0],n.y=r.y+x[w+1],r.x+=x[w+2],r.y+=x[w+3],0===w&&!0===d&&c.copy(r);break;case"t":for(x=l(data),w=0,M=x.length;w<M;w+=2){S=o(r.x,n.x),A=o(r.y,n.y);path.quadraticCurveTo(S,A,r.x+x[w+0],r.y+x[w+1]),n.x=S,n.y=A,r.x=r.x+x[w+0],r.y=r.y+x[w+1],0===w&&!0===d&&c.copy(r)}break;case"a":for(x=l(data),w=0,M=x.length;w<M;w+=7){T=r.clone();r.x+=x[w+5],r.y+=x[w+6],n.x=r.x,n.y=r.y,e(path,x[w],x[w+1],x[w+2],x[w+3],x[w+4],T,r),0===w&&!0===d&&c.copy(r)}break;case"Z":case"z":path.currentPath.autoClose=!0,path.currentPath.curves.length>0&&(r.copy(c),path.currentPath.currentPoint.copy(r),h=!0);break;default:console.warn(v)}d=!1}return path}(M,style));break;case"rect":n(style=r(M,style))&&(path=function(e,style){var t=parseFloat(e.getAttribute("x")||0),r=parseFloat(e.getAttribute("y")||0),n=parseFloat(e.getAttribute("rx")||0),o=parseFloat(e.getAttribute("ry")||0),l=parseFloat(e.getAttribute("width")),c=parseFloat(e.getAttribute("height")),path=new ShapePath;path.color.setStyle(style.fill),path.moveTo(t+2*n,r),path.lineTo(t+l-2*n,r),(0!==n||0!==o)&&path.bezierCurveTo(t+l,r,t+l,r,t+l,r+2*o);path.lineTo(t+l,r+c-2*o),(0!==n||0!==o)&&path.bezierCurveTo(t+l,r+c,t+l,r+c,t+l-2*n,r+c);path.lineTo(t+2*n,r+c),(0!==n||0!==o)&&path.bezierCurveTo(t,r+c,t,r+c,t,r+c-2*o);path.lineTo(t,r+2*o),(0!==n||0!==o)&&path.bezierCurveTo(t,r,t,r,t+2*n,r);return path}(M,style));break;case"polygon":n(style=r(M,style))&&(path=function(e,style){var path=new ShapePath;path.color.setStyle(style.fill);var t=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,a,b){var r=parseFloat(a),n=parseFloat(b);0===t?path.moveTo(r,n):path.lineTo(r,n);t++})),path.currentPath.autoClose=!0,path}(M,style));break;case"polyline":n(style=r(M,style))&&(path=function(e,style){var path=new ShapePath;path.color.setStyle(style.fill);var t=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,(function(e,a,b){var r=parseFloat(a),n=parseFloat(b);0===t?path.moveTo(r,n):path.lineTo(r,n);t++})),path.currentPath.autoClose=!1,path}(M,style));break;case"circle":n(style=r(M,style))&&(path=function(e,style){var t=parseFloat(e.getAttribute("cx")),r=parseFloat(e.getAttribute("cy")),n=parseFloat(e.getAttribute("r")),o=new Path;o.absarc(t,r,n,0,2*Math.PI);var path=new ShapePath;return path.color.setStyle(style.fill),path.subPaths.push(o),path}(M,style));break;case"ellipse":n(style=r(M,style))&&(path=function(e,style){var t=parseFloat(e.getAttribute("cx")),r=parseFloat(e.getAttribute("cy")),n=parseFloat(e.getAttribute("rx")),o=parseFloat(e.getAttribute("ry")),l=new Path;l.absellipse(t,r,n,o,0,2*Math.PI);var path=new ShapePath;return path.color.setStyle(style.fill),path.subPaths.push(l),path}(M,style));break;case"line":n(style=r(M,style))&&(path=function(e,style){var t=parseFloat(e.getAttribute("x1")),r=parseFloat(e.getAttribute("y1")),n=parseFloat(e.getAttribute("x2")),o=parseFloat(e.getAttribute("y2")),path=new ShapePath;return path.moveTo(t,r),path.lineTo(n,o),path.currentPath.autoClose=!1,path}(M));break;default:console.log(M)}path&&(!function(path,e){function t(t){o.set(t.x,t.y,1).applyMatrix3(e),t.set(o.x,o.y)}for(var r=function(e){return 0!==e.elements[1]||0!==e.elements[3]}(e),n=new Vector2,o=new Vector3,l=path.subPaths,i=0,d=l.length;i<d;i++)for(var f=l[i].curves,m=0;m<f.length;m++){var v=f[m];v.isLineCurve?(t(v.v1),t(v.v2)):v.isCubicBezierCurve?(t(v.v0),t(v.v1),t(v.v2),t(v.v3)):v.isQuadraticBezierCurve?(t(v.v0),t(v.v1),t(v.v2)):v.isEllipseCurve&&(r&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),n.set(v.aX,v.aY),t(n),v.aX=n.x,v.aY=n.y,v.xRadius*=c(e),v.yRadius*=h(e))}}(path,w),d.push(path));for(var A=M.childNodes,i=0;i<A.length;i++)t(A[i],style);S&&w.copy(f.pop())}}(M.documentElement,{fill:"#000"}),console.timeEnd("SVGLoader: Parse"),d}};var TDSLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]};TDSLoader.prototype={constructor:TDSLoader,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0!==this.path?this.path:LoaderUtils.extractUrlBase(e),l=new FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.load(e,(function(data){t(o.parse(data,path))}),r,n)},parse:function(e,path){this.group=new Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(e,path);for(var i=0;i<this.meshes.length;i++)this.group.add(this.meshes[i]);return this.group},readFile:function(e,path){var data=new DataView(e),t=this.readChunk(data);if(t.id===MLIBMAGIC||t.id===CMAGIC||t.id===M3DMAGIC)for(var r=this.nextChunk(data,t);0!==r;){if(r===M3D_VERSION){var n=this.readDWord(data);this.debugMessage("3DS file version: "+n)}else r===MDATA?(this.resetPosition(data),this.readMeshData(data,path)):this.debugMessage("Unknown main chunk: "+r.toString(16));r=this.nextChunk(data,t)}this.debugMessage("Parsed "+this.meshes.length+" meshes")},readMeshData:function(data,path){for(var e=this.readChunk(data),t=this.nextChunk(data,e);0!==t;){if(t===MESH_VERSION){var r=+this.readDWord(data);this.debugMessage("Mesh Version: "+r)}else if(t===MASTER_SCALE){var n=this.readFloat(data);this.debugMessage("Master scale: "+n),this.group.scale.set(n,n,n)}else t===NAMED_OBJECT?(this.debugMessage("Named Object"),this.resetPosition(data),this.readNamedObject(data)):t===MAT_ENTRY?(this.debugMessage("Material"),this.resetPosition(data),this.readMaterialEntry(data,path)):this.debugMessage("Unknown MDATA chunk: "+t.toString(16));t=this.nextChunk(data,e)}},readNamedObject:function(data){var e=this.readChunk(data),t=this.readString(data,64);e.cur=this.position;for(var r=this.nextChunk(data,e);0!==r;){if(r===N_TRI_OBJECT){this.resetPosition(data);var n=this.readMesh(data);n.name=t,this.meshes.push(n)}else this.debugMessage("Unknown named object chunk: "+r.toString(16));r=this.nextChunk(data,e)}this.endChunk(e)},readMaterialEntry:function(data,path){for(var e=this.readChunk(data),t=this.nextChunk(data,e),r=new MeshPhongMaterial;0!==t;){if(t===MAT_NAME)r.name=this.readString(data,64),this.debugMessage("   Name: "+r.name);else if(t===MAT_WIRE)this.debugMessage("   Wireframe"),r.wireframe=!0;else if(t===MAT_WIRE_SIZE){var n=this.readByte(data);r.wireframeLinewidth=n,this.debugMessage("   Wireframe Thickness: "+n)}else if(t===MAT_TWO_SIDE)r.side=DoubleSide,this.debugMessage("   DoubleSided");else if(t===MAT_ADDITIVE)this.debugMessage("   Additive Blending"),r.blending=AdditiveBlending;else if(t===MAT_DIFFUSE)this.debugMessage("   Diffuse Color"),r.color=this.readColor(data);else if(t===MAT_SPECULAR)this.debugMessage("   Specular Color"),r.specular=this.readColor(data);else if(t===MAT_AMBIENT)this.debugMessage("   Ambient color"),r.color=this.readColor(data);else if(t===MAT_SHININESS){var o=this.readWord(data);r.shininess=o,this.debugMessage("   Shininess : "+o)}else t===MAT_TEXMAP?(this.debugMessage("   ColorMap"),this.resetPosition(data),r.map=this.readMap(data,path)):t===MAT_BUMPMAP?(this.debugMessage("   BumpMap"),this.resetPosition(data),r.bumpMap=this.readMap(data,path)):t===MAT_OPACMAP?(this.debugMessage("   OpacityMap"),this.resetPosition(data),r.alphaMap=this.readMap(data,path)):t===MAT_SPECMAP?(this.debugMessage("   SpecularMap"),this.resetPosition(data),r.specularMap=this.readMap(data,path)):this.debugMessage("   Unknown material chunk: "+t.toString(16));t=this.nextChunk(data,e)}this.endChunk(e),this.materials[r.name]=r},readMesh:function(data){var e=this.readChunk(data),t=this.nextChunk(data,e),r=new BufferGeometry,n=[],o=new Mesh(r,new MeshPhongMaterial);for(o.name="mesh";0!==t;){if(t===POINT_ARRAY){var l=this.readWord(data);this.debugMessage("   Vertex: "+l);for(var c=[],i=0;i<l;i++)c.push(this.readFloat(data)),c.push(this.readFloat(data)),c.push(this.readFloat(data));r.addAttribute("position",new Float32BufferAttribute(c,3))}else if(t===FACE_ARRAY)this.resetPosition(data),this.readFaceArray(data,o);else if(t===TEX_VERTS){var h=this.readWord(data);this.debugMessage("   UV: "+h);for(n=[],i=0;i<h;i++)n.push(this.readFloat(data)),n.push(this.readFloat(data));r.addAttribute("uv",new Float32BufferAttribute(n,2))}else if(t===MESH_MATRIX){this.debugMessage("   Tranformation Matrix (TODO)");var d=[];for(i=0;i<12;i++)d[i]=this.readFloat(data);var f=new Matrix4;f.elements[0]=d[0],f.elements[1]=d[6],f.elements[2]=d[3],f.elements[3]=d[9],f.elements[4]=d[2],f.elements[5]=d[8],f.elements[6]=d[5],f.elements[7]=d[11],f.elements[8]=d[1],f.elements[9]=d[7],f.elements[10]=d[4],f.elements[11]=d[10],f.elements[12]=0,f.elements[13]=0,f.elements[14]=0,f.elements[15]=1,f.transpose();var m=new Matrix4;m.getInverse(f,!0),r.applyMatrix(m),f.decompose(o.position,o.quaternion,o.scale)}else this.debugMessage("   Unknown mesh chunk: "+t.toString(16));t=this.nextChunk(data,e)}return this.endChunk(e),r.computeVertexNormals(),o},readFaceArray:function(data,e){var t=this.readChunk(data),r=this.readWord(data);this.debugMessage("   Faces: "+r);for(var n=[],i=0;i<r;++i){n.push(this.readWord(data),this.readWord(data),this.readWord(data));this.readWord(data)}for(e.geometry.setIndex(n);this.position<t.end;){if((t=this.readChunk(data)).id===MSH_MAT_GROUP){this.debugMessage("      Material Group"),this.resetPosition(data);var o=this.readMaterialGroup(data),l=this.materials[o.name];void 0!==l&&(e.material=l,""===l.name&&(l.name=e.name))}else this.debugMessage("      Unknown face array chunk: "+t.toString(16));this.endChunk(t)}this.endChunk(t)},readMap:function(data,path){var e=this.readChunk(data),t=this.nextChunk(data,e),r={},n=new TextureLoader(this.manager);for(n.setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin);0!==t;){if(t===MAT_MAPNAME){var o=this.readString(data,128);r=n.load(o),this.debugMessage("      File: "+path+o)}else t===MAT_MAP_UOFFSET?(r.offset.x=this.readFloat(data),this.debugMessage("      OffsetX: "+r.offset.x)):t===MAT_MAP_VOFFSET?(r.offset.y=this.readFloat(data),this.debugMessage("      OffsetY: "+r.offset.y)):t===MAT_MAP_USCALE?(r.repeat.x=this.readFloat(data),this.debugMessage("      RepeatX: "+r.repeat.x)):t===MAT_MAP_VSCALE?(r.repeat.y=this.readFloat(data),this.debugMessage("      RepeatY: "+r.repeat.y)):this.debugMessage("      Unknown map chunk: "+t.toString(16));t=this.nextChunk(data,e)}return this.endChunk(e),r},readMaterialGroup:function(data){this.readChunk(data);var e=this.readString(data,64),t=this.readWord(data);this.debugMessage("         Name: "+e),this.debugMessage("         Faces: "+t);for(var r=[],i=0;i<t;++i)r.push(this.readWord(data));return{name:e,index:r}},readColor:function(data){var e=this.readChunk(data),t=new Color;if(e.id===COLOR_24||e.id===LIN_COLOR_24){var r=this.readByte(data),g=this.readByte(data),b=this.readByte(data);t.setRGB(r/255,g/255,b/255),this.debugMessage("      Color: "+t.r+", "+t.g+", "+t.b)}else if(e.id===COLOR_F||e.id===LIN_COLOR_F){r=this.readFloat(data),g=this.readFloat(data),b=this.readFloat(data);t.setRGB(r,g,b),this.debugMessage("      Color: "+t.r+", "+t.g+", "+t.b)}else this.debugMessage("      Unknown color chunk: "+e.toString(16));return this.endChunk(e),t},readChunk:function(data){var e={};return e.cur=this.position,e.id=this.readWord(data),e.size=this.readDWord(data),e.end=e.cur+e.size,e.cur+=6,e},endChunk:function(e){this.position=e.end},nextChunk:function(data,e){if(e.cur>=e.end)return 0;this.position=e.cur;try{var t=this.readChunk(data);return e.cur+=t.size,t.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}},resetPosition:function(){this.position-=6},readByte:function(data){var e=data.getUint8(this.position,!0);return this.position+=1,e},readFloat:function(data){try{var e=data.getFloat32(this.position,!0);return this.position+=4,e}catch(e){this.debugMessage(e+" "+this.position+" "+data.byteLength)}},readInt:function(data){var e=data.getInt32(this.position,!0);return this.position+=4,e},readShort:function(data){var e=data.getInt16(this.position,!0);return this.position+=2,e},readDWord:function(data){var e=data.getUint32(this.position,!0);return this.position+=4,e},readWord:function(data){var e=data.getUint16(this.position,!0);return this.position+=2,e},readString:function(data,e){for(var s="",i=0;i<e;i++){var t=this.readByte(data);if(!t)break;s+=String.fromCharCode(t)}return s},setPath:function(path){return this.path=path,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},debugMessage:function(e){this.debug&&console.log(e)}};var M3DMAGIC=19789,MLIBMAGIC=15786,CMAGIC=49725,M3D_VERSION=2,COLOR_F=16,COLOR_24=17,LIN_COLOR_24=18,LIN_COLOR_F=19,MDATA=15677,MESH_VERSION=15678,MASTER_SCALE=256,MAT_ENTRY=45055,MAT_NAME=40960,MAT_AMBIENT=40976,MAT_DIFFUSE=40992,MAT_SPECULAR=41008,MAT_SHININESS=41024,MAT_TWO_SIDE=41089,MAT_ADDITIVE=41091,MAT_WIRE=41093,MAT_WIRE_SIZE=41095,MAT_TEXMAP=41472,MAT_OPACMAP=41488,MAT_BUMPMAP=41520,MAT_SPECMAP=41476,MAT_MAPNAME=41728,MAT_MAP_USCALE=41812,MAT_MAP_VSCALE=41814,MAT_MAP_UOFFSET=41816,MAT_MAP_VOFFSET=41818,NAMED_OBJECT=16384,N_TRI_OBJECT=16640,POINT_ARRAY=16656,FACE_ARRAY=16672,MSH_MAT_GROUP=16688,TEX_VERTS=16704,MESH_MATRIX=16736,TTFLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.reversed=!1};TTFLoader.prototype={constructor:TTFLoader,load:function(e,t,r,n){var o=this,l=new FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.load(e,(function(e){t(o.parse(e))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(e){function t(e){var path,t=[];e.forEach((function(e){"m"===e.type.toLowerCase()?(path=[e],t.push(path)):"z"!==e.type.toLowerCase()&&path.push(e)}));var r=[];return t.forEach((function(p){var e={type:"m",x:p[p.length-1].x,y:p[p.length-1].y};r.push(e);for(var i=p.length-1;i>0;i--){var t=p[i];e={type:t.type};void 0!==t.x2&&void 0!==t.y2?(e.x1=t.x2,e.y1=t.y2,e.x2=t.x1,e.y2=t.y1):void 0!==t.x1&&void 0!==t.y1&&(e.x1=t.x1,e.y1=t.y1),e.x=p[i-1].x,e.y=p[i-1].y,r.push(e)}})),r}return"undefined"==typeof opentype?(console.warn("TTFLoader: The loader requires opentype.js. Make sure it's included before using the loader."),null):function(e,r){for(var n=Math.round,o={},l=1e5/(72*(e.unitsPerEm||2048)),i=0;i<e.glyphs.length;i++){var glyph=e.glyphs.glyphs[i];if(void 0!==glyph.unicode){var c={ha:n(glyph.advanceWidth*l),x_min:n(glyph.xMin*l),x_max:n(glyph.xMax*l),o:""};r&&(glyph.path.commands=t(glyph.path.commands)),glyph.path.commands.forEach((function(e,i){"c"===e.type.toLowerCase()&&(e.type="b"),c.o+=e.type.toLowerCase()+" ",void 0!==e.x&&void 0!==e.y&&(c.o+=n(e.x*l)+" "+n(e.y*l)+" "),void 0!==e.x1&&void 0!==e.y1&&(c.o+=n(e.x1*l)+" "+n(e.y1*l)+" "),void 0!==e.x2&&void 0!==e.y2&&(c.o+=n(e.x2*l)+" "+n(e.y2*l)+" ")})),o[String.fromCharCode(glyph.unicode)]=c}}return{glyphs:o,familyName:e.familyName,ascender:n(e.ascender*l),descender:n(e.descender*l),underlinePosition:e.tables.post.underlinePosition,underlineThickness:e.tables.post.underlineThickness,boundingBox:{xMin:e.tables.head.xMin,xMax:e.tables.head.xMax,yMin:e.tables.head.yMin,yMax:e.tables.head.yMax},resolution:1e3,original_font_information:e.tables.name}}(opentype.parse(e),this.reversed)}};var VRMLLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};VRMLLoader.prototype={constructor:VRMLLoader,isRecordingPoints:!1,isRecordingFaces:!1,points:[],indexes:[],isRecordingAngles:!1,isRecordingColors:!1,angles:[],colors:[],recordingFieldname:null,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===o.path?LoaderUtils.extractUrlBase(e):o.path,l=new FileLoader(this.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(text,path))}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(data,path){var e=this,t=new TextureLoader(this.manager);t.setPath(this.resourcePath||path).setCrossOrigin(this.crossOrigin);for(var r=new Scene,n=data.split("\n"),i=n.length-1;i>-1;i--){var line=n[i];if(line=line.replace(/(#.*)/,""),/{.*[{\[]/.test(line))(o=line.split("{").join("{\n").split("\n")).unshift(1),o.unshift(i),n.splice.apply(n,o);else if(/\].*}/.test(line)){var o;(o=line.split("]").join("]\n").split("\n")).unshift(1),o.unshift(i),n.splice.apply(n,o)}if(/}.*}/.test(line))(o=line.split("}").join("}\n").split("\n")).unshift(1),o.unshift(i),n.splice.apply(n,o);/^\b[^\s]+\b$/.test(line.trim())?(n[i+1]=line+" "+n[i+1].trim(),n.splice(i,1)):line.indexOf("coord")>-1&&line.indexOf("[")<0&&line.indexOf("{")<0&&(n[i]+=" Coordinate {}")}var header=n.shift();return/V1.0/.exec(header)?console.warn("VRMLLoader: V1.0 not supported yet."):/V2.0/.exec(header)&&function(r,n){var o={},l=/(\b|\-|\+)([\d\.e]+)/,c=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g,h=/([\d\.\+\-e]+)\s+([\d\.\+\-e]+)\s+([\d\.\+\-e]+)/g;function d(e,t,r,n,o){for(var l=!0===o?1:-1,c=[],h={},d={},f=0;f<r.length;f++){var m={x:l*(Math.cos(r[f])*t),y:l*(Math.sin(r[f])*t)};c.push(m)}for(var v=e.index,y=e.attributes.position,x=new BufferAttribute(new Float32Array(3*e.attributes.position.count),3),w=new Vector3,M=new Color,i=0;i<v.count;i++){var S=v.getX(i);w.fromBufferAttribute(y,S);for(var A=0;A<n.length;A++)if(0===A?(h.x=0,h.y=!0===o?t:-1*t):(h.x=c[A-1].x,h.y=c[A-1].y),void 0!==(d=c[A]))if(!0===(!0===o?w.y<=h.y&&w.y>d.y:w.y>=h.y&&w.y<d.y)){var T=n[A],_=n[A+1],L=Math.abs(w.y-h.y)/(h.y-d.y);M.copy(T).lerp(_,L),x.setXYZ(S,M.r,M.g,M.b)}else{var C=n[!0===o?n.length-1:0];x.setXYZ(S,C.r,C.g,C.b)}}e.addAttribute("color",x)}var f=[];function m(t,line){for(var r,n,o,d=[],m={},v=/[^\s,\[\]]+/g;null!==(r=v.exec(line));)d.push(r[0]);switch(n=d[0]){case"skyAngle":case"groundAngle":e.recordingFieldname=n,e.isRecordingAngles=!0,e.angles=[];break;case"color":case"skyColor":case"groundColor":e.recordingFieldname=n,e.isRecordingColors=!0,e.colors=[];break;case"point":case"vector":e.recordingFieldname=n,e.isRecordingPoints=!0,e.points=[];break;case"colorIndex":case"coordIndex":case"normalIndex":case"texCoordIndex":e.recordingFieldname=n,e.isRecordingFaces=!0,e.indexes=[]}if(e.isRecordingFaces){if(d.length>0)for(var y=0;y<d.length;y++)/(-?\d+)/.test(d[y])&&("-1"===d[y]?(f.length>0&&e.indexes.push(f),f=[]):f.push(parseInt(d[y])));/]/.exec(line)&&(f.length>0&&e.indexes.push(f),f=[],e.isRecordingFaces=!1,t[e.recordingFieldname]=e.indexes)}else if(e.isRecordingPoints){if("Coordinate"==t.nodeType)for(;null!==(d=h.exec(line));)o={x:parseFloat(d[1]),y:parseFloat(d[2]),z:parseFloat(d[3])},e.points.push(o);if("Normal"==t.nodeType)for(;null!==(d=h.exec(line));)o={x:parseFloat(d[1]),y:parseFloat(d[2]),z:parseFloat(d[3])},e.points.push(o);if("TextureCoordinate"==t.nodeType)for(;null!==(d=c.exec(line));)o={x:parseFloat(d[1]),y:parseFloat(d[2])},e.points.push(o);/]/.exec(line)&&(e.isRecordingPoints=!1,t.points=e.points)}else if(e.isRecordingAngles){if(d.length>0)for(y=0;y<d.length;y++)l.test(d[y])&&e.angles.push(parseFloat(d[y]));/]/.exec(line)&&(e.isRecordingAngles=!1,t[e.recordingFieldname]=e.angles)}else if(e.isRecordingColors){for(;null!==(d=h.exec(line));){var x={r:parseFloat(d[1]),g:parseFloat(d[2]),b:parseFloat(d[3])};e.colors.push(x)}/]/.exec(line)&&(e.isRecordingColors=!1,t[e.recordingFieldname]=e.colors)}else if("NULL"!==d[d.length-1]&&"children"!==n){switch(n){case"diffuseColor":case"emissiveColor":case"specularColor":case"color":if(4!==d.length){console.warn("VRMLLoader: Invalid color format detected for %s.",n);break}m={r:parseFloat(d[1]),g:parseFloat(d[2]),b:parseFloat(d[3])};break;case"location":case"direction":case"translation":case"scale":case"size":if(4!==d.length){console.warn("VRMLLoader: Invalid vector format detected for %s.",n);break}m={x:parseFloat(d[1]),y:parseFloat(d[2]),z:parseFloat(d[3])};break;case"intensity":case"cutOffAngle":case"radius":case"topRadius":case"bottomRadius":case"height":case"transparency":case"shininess":case"ambientIntensity":case"creaseAngle":if(2!==d.length){console.warn("VRMLLoader: Invalid single float value specification detected for %s.",n);break}m=parseFloat(d[1]);break;case"rotation":if(5!==d.length){console.warn("VRMLLoader: Invalid quaternion format detected for %s.",n);break}m={x:parseFloat(d[1]),y:parseFloat(d[2]),z:parseFloat(d[3]),w:parseFloat(d[4])};break;case"on":case"ccw":case"solid":case"colorPerVertex":case"convex":if(2!==d.length){console.warn("VRMLLoader: Invalid format detected for %s.",n);break}m="TRUE"===d[1]}t[n]=m}return m}!function e(data,r){var object;if("string"!=typeof data){object=r,data.string.indexOf("AmbientLight")>-1&&"PointLight"===data.nodeType&&(data.nodeType="AmbientLight");var l=void 0===data.on||data.on,c=void 0!==data.intensity?data.intensity:1,h=new Color;if(data.color&&h.copy(data.color),"AmbientLight"===data.nodeType)(object=new AmbientLight(h,c)).visible=l,r.add(object);else if("PointLight"===data.nodeType){var f=0;void 0!==data.radius&&data.radius<1e3&&(f=data.radius),(object=new PointLight(h,c,f)).visible=l,r.add(object)}else if("SpotLight"===data.nodeType){c=1,f=0;var m=Math.PI/3;l=!0;void 0!==data.radius&&data.radius<1e3&&(f=data.radius),void 0!==data.cutOffAngle&&(m=data.cutOffAngle),(object=new SpotLight(h,c,f,m,0)).visible=l,r.add(object)}else if("Transform"===data.nodeType||"Group"===data.nodeType){if(object=new Object3D,/DEF/.exec(data.string)&&(object.name=/DEF\s+([^\s]+)/.exec(data.string)[1],o[object.name]=object),void 0!==data.translation){var v=data.translation;object.position.set(v.x,v.y,v.z)}if(void 0!==data.rotation){var y=data.rotation;object.quaternion.setFromAxisAngle(new Vector3(y.x,y.y,y.z),y.w)}if(void 0!==data.scale){var s=data.scale;object.scale.set(s.x,s.y,s.z)}r.add(object)}else if("Shape"===data.nodeType)object=new Mesh,/DEF/.exec(data.string)&&(object.name=/DEF\s+([^\s]+)/.exec(data.string)[1],o[object.name]=object),r.add(object);else if("Background"===data.nodeType){var x=2e4,w=new SphereBufferGeometry(x,20,20),M=new MeshBasicMaterial({fog:!1,side:BackSide});if(data.skyColor.length>1)d(w,x,data.skyAngle,data.skyColor,!0),M.vertexColors=VertexColors;else{var S=data.skyColor[0];M.color.setRGB(S.r,S.b,S.g)}if(n.add(new Mesh(w,M)),void 0!==data.groundColor){var A=new SphereBufferGeometry(x=12e3,20,20,0,2*Math.PI,.5*Math.PI,1.5*Math.PI),T=new MeshBasicMaterial({fog:!1,side:BackSide,vertexColors:VertexColors});d(A,x,data.groundAngle,data.groundColor,!1),n.add(new Mesh(A,T))}}else{if(/geometry/.exec(data.string)){if("Box"===data.nodeType){s=data.size;r.geometry=new BoxBufferGeometry(s.x,s.y,s.z)}else if("Cylinder"===data.nodeType)r.geometry=new CylinderBufferGeometry(data.radius,data.radius,data.height);else if("Cone"===data.nodeType)r.geometry=new CylinderBufferGeometry(data.topRadius,data.bottomRadius,data.height);else if("Sphere"===data.nodeType)r.geometry=new SphereBufferGeometry(data.radius);else if("IndexedFaceSet"===data.nodeType){var _,L,C,N,P,E,D=new BufferGeometry,F=[],R=[],O=[],B=[];for(i=0,N=data.children.length;i<N;i++){if("TextureCoordinate"===(ie=data.children[i]).nodeType&&ie.points)for(P=0,E=ie.points.length;P<E;P++)C=ie.points[P],B.push(C.x,C.y);if("Normal"===ie.nodeType&&ie.points)for(P=0,E=ie.points.length;P<E;P++)L=ie.points[P],O.push(L.x,L.y,L.z);if("Color"===ie.nodeType&&ie.color)for(P=0,E=ie.color.length;P<E;P++)S=ie.color[P],R.push(S.r,S.g,S.b);if("Coordinate"===ie.nodeType){if(ie.points)for(P=0,E=ie.points.length;P<E;P++)_=ie.points[P],F.push(_.x,_.y,_.z);if(ie.string.indexOf("DEF")>-1){var I=/DEF\s+([^\s]+)/.exec(ie.string)[1];o[I]=F.slice(0)}if(ie.string.indexOf("USE")>-1){ce=/USE\s+([^\s]+)/.exec(ie.string)[1];F=o[ce]}}}if(data.coordIndex){function U(e,t,r){void 0===t&&(t=!0);var n=[],o=0;for(i=0,N=e.length;i<N;i++)if(!1===r){var l=e[i];for(P=0,E=l.length;P<E;P++){var c=l[P];n.push(c,c,c)}}else{var h=e[i];for(o=0;h.length>=3&&o<h.length-2;){var d=h[0],f=h[o+(t?1:2)],m=h[o+(t?2:1)];n.push(d,f,m),o++}}return n}var V=data.coordIndex?U(data.coordIndex,data.ccw):[],k=data.normalIndex?U(data.normalIndex,data.ccw):V,G=data.colorIndex?U(data.colorIndex,data.ccw,data.colorPerVertex):[],z=data.texCoordIndex?U(data.texCoordIndex,data.ccw):V,j=[],W=[],H=[],X=[],Y=[],Q=Object.create(null);for(i=0;i<V.length;i++){var K=[],J=V[i],Z=k[i],$=G[i],ee=z[i];K.push(J.toString(10)),void 0!==Z&&K.push(Z.toString(10)),void 0!==$&&K.push($.toString(10)),void 0!==ee&&K.push(ee.toString(10));var te=K.join(","),re=Q[te];void 0===re&&(re=W.length/3,Q[te]=re,W.push(F[3*J],F[3*J+1],F[3*J+2]),void 0!==Z&&O.length>0&&H.push(O[3*Z],O[3*Z+1],O[3*Z+2]),void 0!==$&&R.length>0&&X.push(R[3*$],R[3*$+1],R[3*$+2]),void 0!==ee&&B.length>0&&Y.push(B[2*ee],B[2*ee+1])),j.push(re)}F=W,O=H,R=X,B=Y,D.setIndex(j)}else r.parent.remove(r);!1===data.solid&&(r.material.side=DoubleSide),D.solid=data.solid,D.addAttribute("position",new Float32BufferAttribute(F,3)),R.length>0&&(D.addAttribute("color",new Float32BufferAttribute(R,3)),r.material.vertexColors=VertexColors),B.length>0&&D.addAttribute("uv",new Float32BufferAttribute(B,2)),O.length>0?D.addAttribute("normal",new Float32BufferAttribute(O,3)):(D=D.toNonIndexed()).computeVertexNormals(),D.computeBoundingSphere(),/DEF/.exec(data.string)&&(D.name=/DEF ([^\s]+)/.exec(data.string)[1],o[D.name]=D),r.geometry=D}return}if(/appearance/.exec(data.string)){for(var i=0;i<data.children.length;i++){var ie;if("Material"===(ie=data.children[i]).nodeType){var ne=new MeshPhongMaterial;if(void 0!==ie.diffuseColor){var ae=ie.diffuseColor;ne.color.setRGB(ae.r,ae.g,ae.b)}if(void 0!==ie.emissiveColor){var oe=ie.emissiveColor;ne.emissive.setRGB(oe.r,oe.g,oe.b)}if(void 0!==ie.specularColor){s=ie.specularColor;ne.specular.setRGB(s.r,s.g,s.b)}if(void 0!==ie.transparency){v=ie.transparency;ne.opacity=Math.abs(1-v),ne.transparent=!0}/DEF/.exec(data.string)&&(ne.name=/DEF ([^\s]+)/.exec(data.string)[1],o[ne.name]=ne),r.material=ne}if("ImageTexture"===ie.nodeType){var se=/"([^"]+)"/.exec(ie.children[0]);se&&(r.material.name=se[1],r.material.map=t.load(se[1]))}}return}}i=0;for(var le=data.children.length;i<le;i++)e(data.children[i],object)}else if(/USE/.exec(data)){var ce=/USE\s+?([^\s]+)/.exec(data)[1];null==o[ce]?console.warn("VRMLLoader: %s is not defined.",ce):/appearance/.exec(data)&&ce?r.material=o[ce].clone():/geometry/.exec(data)&&ce?(r.geometry=o[ce].clone(),void 0!==o[ce].solid&&!1===o[ce].solid&&(r.geometry.solid=!1,r.material.side=DoubleSide)):ce&&(object=o[ce].clone(),r.add(object))}}(function(e){for(var t,r,n={string:"Scene",children:[]},o=n,i=0;i<e.length;i++){var l="",line=e[i];if(null===/^\s+?$/g.exec(line)&&""!==(line=line.trim())){if(/#/.exec(line)){var c=line.split("#");line=c[0],l=c[1]}if(t=/([^\s]*){1}(?:\s+)?{/.exec(line)){var h={nodeType:t[1],string:line,parent:o,children:[],comment:l};o.children.push(h),o=h,/}/.exec(line)&&(r=/{(.*)}/.exec(line)[1],h.children.push(r),m(o,r),o=o.parent)}else/}/.exec(line)?o=o.parent:""!==line&&(m(o,line),o.children.push(line))}}return n}(r),n)}(n,r),r}};var VRMLoader=function(){function e(e){if(void 0===GLTFLoader)throw new Error("VRMLoader: Import GLTFLoader.");this.manager=void 0!==e?e:DefaultLoadingManager,this.gltfLoader=new GLTFLoader(this.manager)}return e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,n){var o=this;this.gltfLoader.load(e,(function(e){o.parse(e,t)}),r,n)},setCrossOrigin:function(e){return this.glTFLoader.setCrossOrigin(e),this},setPath:function(e){return this.glTFLoader.setPath(e),this},setResourcePath:function(e){return this.glTFLoader.setResourcePath(e),this},setDRACOLoader:function(e){return this.glTFLoader.setDRACOLoader(e),this},parse:function(e,t){e.parser,(e.userData.gltfExtensions||{}).VRM;t(e)}},e}(),VTKLoader=function(e){this.manager=void 0!==e?e:DefaultLoadingManager};function ImmediateRenderObject(e){Object3D.call(this),this.material=e,this.render=function(){}}Object.assign(VTKLoader.prototype,EventDispatcher.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.setResponseType("arraybuffer"),l.load(e,(function(text){t(o.parse(text))}),r,n)},setPath:function(e){return this.path=e,this},parse:function(data){function e(e,t){var r=e.length,n=new Int32Array(r+t.length);return n.set(e),n.set(t,r),n}function t(data){for(var e="",t=new Uint8Array(data),i=0,r=t.length;r--;)e+=String.fromCharCode(t[i++]);return e}var meta=LoaderUtils.decodeText(new Uint8Array(data,0,250)).split("\n");return-1!==meta[0].indexOf("xml")?function(t){function r(e){var i,t,r,n,o,l,c="undefined"!=typeof Uint8Array?Uint8Array:Array,h=[],d=[],code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f=code.length;for(i=0;i<f;i++)h[i]=code[i];for(i=0;i<f;++i)d[code.charCodeAt(i)]=i;if(d["-".charCodeAt(0)]=62,d["_".charCodeAt(0)]=63,(f=e.length)%4>0)throw new Error("Invalid string. Length must be a multiple of 4");l=new c(3*f/4-(o="="===e[f-2]?2:"="===e[f-1]?1:0)),r=o>0?f-4:f;var m=0;for(i=0,t=0;i<r;i+=4,t+=3)n=d[e.charCodeAt(i)]<<18|d[e.charCodeAt(i+1)]<<12|d[e.charCodeAt(i+2)]<<6|d[e.charCodeAt(i+3)],l[m++]=(16711680&n)>>16,l[m++]=(65280&n)>>8,l[m++]=255&n;return 2===o?(n=d[e.charCodeAt(i)]<<2|d[e.charCodeAt(i+1)]>>4,l[m++]=255&n):1===o&&(n=d[e.charCodeAt(i)]<<10|d[e.charCodeAt(i+1)]<<4|d[e.charCodeAt(i+2)]>>2,l[m++]=n>>8&255,l[m++]=255&n),l}function n(t,n){var o,c,h,d,f=0;if("UInt64"===l.attributes.header_type?f=8:"UInt32"===l.attributes.header_type&&(f=4),"binary"===t.attributes.format&&n){var m,v,y,x,w,M;if("Float32"===t.attributes.type)var S=new Float32Array;else if("Int64"===t.attributes.type)S=new Int32Array;v=(m=r(t["#text"]))[0];for(var i=1;i<f-1;i++)v|=m[i]<<i*f;x=(v+3)*f,M=x+=x%3>0?3-x%3:0,(w=[]).push(M),y=3*f;for(i=0;i<v;i++){for(var A=m[i*f+y],T=1;T<f-1;T++)A|=m[i*f+y+T]<<8*T;M+=A,w.push(M)}for(i=0;i<w.length-1;i++){content=(content=new Zlib.Inflate(m.slice(w[i],w[i+1]),{resize:!0,verify:!0}).decompress()).buffer,"Float32"===t.attributes.type?(content=new Float32Array(content),c=content,h=void 0,d=void 0,h=(o=S).length,(d=new Float32Array(h+c.length)).set(o),d.set(c,h),S=d):"Int64"===t.attributes.type&&(S=e(S,content=new Int32Array(content)))}delete t["#text"],"Int64"===t.attributes.type&&"binary"===t.attributes.format&&(S=S.filter((function(e,t){if(t%2!=1)return!0})))}else{if("binary"!==t.attributes.format||n)if(t["#text"])var content=t["#text"].split(/\s+/).filter((function(e){if(""!==e)return e}));else content=new Int32Array(0).buffer;else content=(content=r(t["#text"])).slice(f).buffer;if(delete t["#text"],"Float32"===t.attributes.type)S=new Float32Array(content);else if("Int32"===t.attributes.type)S=new Int32Array(content);else if("Int64"===t.attributes.type){S=new Int32Array(content);"binary"===t.attributes.format&&(S=S.filter((function(e,t){if(t%2!=1)return!0})))}}return S}var o=null;if(window.DOMParser)try{o=(new DOMParser).parseFromString(t,"text/xml")}catch(e){o=null}else{if(!window.ActiveXObject)throw new Error("Cannot parse xml string!");try{if((o=new ActiveXObject("Microsoft.XMLDOM")).async=!1,!o.loadXML())throw new Error(o.parseError.reason+o.parseError.srcText)}catch(e){o=null}}var l=function e(t){var r={};if(1===t.nodeType){if(t.attributes&&t.attributes.length>0){r.attributes={};for(var n=0;n<t.attributes.length;n++){var o=t.attributes.item(n);r.attributes[o.nodeName]=o.nodeValue.trim()}}}else 3===t.nodeType&&(r=t.nodeValue.trim());if(t.hasChildNodes())for(var i=0;i<t.childNodes.length;i++){var l=t.childNodes.item(i),c=l.nodeName;if(void 0===r[c]){""!==(d=e(l))&&(r[c]=d)}else{if(void 0===r[c].push){var h=r[c];r[c]=[h]}var d;""!==(d=e(l))&&r[c].push(d)}}return r}(o.documentElement),c=[],h=[],d=[];if(l.PolyData){for(var f=l.PolyData.Piece,m=l.attributes.hasOwnProperty("compressor"),v=["PointData","Points","Strips","Polys"],y=0,x=v.length;y<x;){var section=f[v[y]];if(section&&section.DataArray){if("[object Array]"===Object.prototype.toString.call(section.DataArray))var w=section.DataArray;else w=[section.DataArray];for(var M=0,S=w.length;M<S;)"#text"in w[M]&&w[M]["#text"].length>0&&(w[M].text=n(w[M],m)),M++;switch(v[y]){case"PointData":var A=parseInt(f.attributes.NumberOfPoints),T=section.attributes.Normals;if(A>0)for(var i=0,_=w.length;i<_;i++)if(T===w[i].attributes.Name){var L=w[i].attributes.NumberOfComponents;(h=new Float32Array(A*L)).set(w[i].text,0)}break;case"Points":if((A=parseInt(f.attributes.NumberOfPoints))>0){L=section.DataArray.attributes.NumberOfComponents;(c=new Float32Array(A*L)).set(section.DataArray.text,0)}break;case"Strips":var C=parseInt(f.attributes.NumberOfStrips);if(C>0){var N=new Int32Array(section.DataArray[0].text.length),P=new Int32Array(section.DataArray[1].text.length);N.set(section.DataArray[0].text,0),P.set(section.DataArray[1].text,0);var E=C+N.length;d=new Uint32Array(3*E-9*C);var D=0;for(i=0,_=C;i<_;i++){for(var F=[],s=0,R=P[i],O=0;s<R-O;s++)F.push(N[s]),i>0&&(O=P[i-1]);var B=0;for(R=P[i],O=0;B<R-O-2;B++)B%2?(d[D++]=F[B],d[D++]=F[B+2],d[D++]=F[B+1]):(d[D++]=F[B],d[D++]=F[B+1],d[D++]=F[B+2]),i>0&&(O=P[i-1])}}break;case"Polys":var I=parseInt(f.attributes.NumberOfPolys);if(I>0){N=new Int32Array(section.DataArray[0].text.length),P=new Int32Array(section.DataArray[1].text.length);N.set(section.DataArray[0].text,0),P.set(section.DataArray[1].text,0);E=I+N.length;d=new Uint32Array(3*E-9*I);D=0;var U=0;for(i=0,_=I,O=0;i<_;){var V=[];for(s=0,R=P[i];s<R-O;)V.push(N[U++]),s++;for(B=1;B<R-O-1;)d[D++]=V[0],d[D++]=V[B],d[D++]=V[B+1],B++;O=P[++i-1]}}}}y++}var k=new BufferGeometry;return k.setIndex(new BufferAttribute(d,1)),k.addAttribute("position",new BufferAttribute(c,3)),h.length===c.length&&k.addAttribute("normal",new BufferAttribute(h,3)),k}}(t(data)):meta[2].includes("ASCII")?function(data){var e,t=[],r=[],n=[],o=[],l=/(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)\s+(\-?\d+\.?[\d\-\+e]*)/g,c=/^(\d+)\s+([\s\d]*)/,h=/^POINTS /,d=/^POLYGONS /,f=/^TRIANGLE_STRIPS /,m=/^POINT_DATA[ ]+(\d+)/,v=/^CELL_DATA[ ]+(\d+)/,y=/^COLOR_SCALARS[ ]+(\w+)[ ]+3/,x=/^NORMALS[ ]+(\w+)[ ]+(\w+)/,w=!1,M=!1,S=!1,A=!1,T=!1,_=!1,L=!1,C=data.split("\n");for(var i in C){var line=C[i];if(w)for(;null!==(e=l.exec(line));){var N=parseFloat(e[1]),P=parseFloat(e[2]),E=parseFloat(e[3]);r.push(N,P,E)}else if(M){if(null!==(e=c.exec(line))){var D=parseInt(e[1]),F=e[2].split(/\s+/);if(D>=3)for(var R=parseInt(F[0]),O=1,B=0;B<D-2;++B)I=parseInt(F[O]),U=parseInt(F[O+1]),t.push(R,I,U),O++}}else if(S){if(null!==(e=c.exec(line))){D=parseInt(e[1]),F=e[2].split(/\s+/);if(D>=3){var I,U;for(B=0;B<D-2;B++)B%2==1?(R=parseInt(F[B]),I=parseInt(F[B+2]),U=parseInt(F[B+1]),t.push(R,I,U)):(R=parseInt(F[B]),I=parseInt(F[B+1]),U=parseInt(F[B+2]),t.push(R,I,U))}}}else if(A||T)if(_)for(;null!==(e=l.exec(line));){var V=parseFloat(e[1]),g=parseFloat(e[2]),b=parseFloat(e[3]);n.push(V,g,b)}else if(L)for(;null!==(e=l.exec(line));){var k=parseFloat(e[1]),G=parseFloat(e[2]),z=parseFloat(e[3]);o.push(k,G,z)}null!==d.exec(line)?(M=!0,w=!1,S=!1):null!==h.exec(line)?(M=!1,w=!0,S=!1):null!==f.exec(line)?(M=!1,w=!1,S=!0):null!==m.exec(line)?(A=!0,w=!1,M=!1,S=!1):null!==v.exec(line)?(T=!0,w=!1,M=!1,S=!1):null!==y.exec(line)?(_=!0,L=!1,w=!1,M=!1,S=!1):null!==x.exec(line)&&(L=!0,_=!1,w=!1,M=!1,S=!1)}var j=new BufferGeometry;if(j.setIndex(t),j.addAttribute("position",new Float32BufferAttribute(r,3)),o.length===r.length&&j.addAttribute("normal",new Float32BufferAttribute(o,3)),n.length!==t.length)n.length===r.length&&j.addAttribute("color",new Float32BufferAttribute(n,3));else{var W=(j=j.toNonIndexed()).attributes.position.count/3;if(n.length===3*W){var H=[];for(i=0;i<W;i++){V=n[3*i+0],g=n[3*i+1],b=n[3*i+2];H.push(V,g,b),H.push(V,g,b),H.push(V,g,b)}j.addAttribute("color",new Float32BufferAttribute(H,3))}}return j}(t(data)):function(data){var e,t,i,r,s,n,line,o=new Uint8Array(data),l=new DataView(data),c=[],h=[],d=[],f=0;function m(e,t){for(var r=t,n=e[r],s=[];10!==n;)s.push(String.fromCharCode(n)),n=e[++r];return{start:t,end:r,next:r+1,parsedString:s.join("")}}for(;;){if(0===(line=(n=m(o,f)).parsedString).indexOf("POINTS")){for(e=4*(r=parseInt(line.split(" ")[1],10))*3,c=new Float32Array(3*r),t=n.next,i=0;i<r;i++)c[3*i]=l.getFloat32(t,!1),c[3*i+1]=l.getFloat32(t+4,!1),c[3*i+2]=l.getFloat32(t+8,!1),t+=12;n.next=n.next+e+1}else if(0===line.indexOf("TRIANGLE_STRIPS")){var v=parseInt(line.split(" ")[1],10);e=4*(S=parseInt(line.split(" ")[2],10)),d=new Uint32Array(3*S-9*v);var y=0;for(t=n.next,i=0;i<v;i++){var x=l.getInt32(t,!1),w=[];for(t+=4,s=0;s<x;s++)w.push(l.getInt32(t,!1)),t+=4;for(var M=0;M<x-2;M++)M%2?(d[y++]=w[M],d[y++]=w[M+2],d[y++]=w[M+1]):(d[y++]=w[M],d[y++]=w[M+1],d[y++]=w[M+2])}n.next=n.next+e+1}else if(0===line.indexOf("POLYGONS")){var S;v=parseInt(line.split(" ")[1],10);e=4*(S=parseInt(line.split(" ")[2],10)),d=new Uint32Array(3*S-9*v);y=0;for(t=n.next,i=0;i<v;i++){x=l.getInt32(t,!1),w=[];for(t+=4,s=0;s<x;s++)w.push(l.getInt32(t,!1)),t+=4;for(M=1;M<x-1;M++)d[y++]=w[0],d[y++]=w[M],d[y++]=w[M+1]}n.next=n.next+e+1}else if(0===line.indexOf("POINT_DATA")){for(r=parseInt(line.split(" ")[1],10),n=m(o,n.next),e=4*r*3,h=new Float32Array(3*r),t=n.next,i=0;i<r;i++)h[3*i]=l.getFloat32(t,!1),h[3*i+1]=l.getFloat32(t+4,!1),h[3*i+2]=l.getFloat32(t+8,!1),t+=12;n.next=n.next+e}if((f=n.next)>=o.byteLength)break}var A=new BufferGeometry;return A.setIndex(new BufferAttribute(d,1)),A.addAttribute("position",new BufferAttribute(c,3)),h.length===c.length&&A.addAttribute("normal",new BufferAttribute(h,3)),A}(data)}}),ImmediateRenderObject.prototype=Object.create(Object3D.prototype),ImmediateRenderObject.prototype.constructor=ImmediateRenderObject,ImmediateRenderObject.prototype.isImmediateRenderObject=!0;var MarchingCubes=function(e,t,r,n){ImmediateRenderObject.call(this,t);var o=this,l=new Float32Array(36),c=new Float32Array(36),h=new Float32Array(36);function d(a,b,e){return a+(b-a)*e}function f(q,e,t,r,n,f,m,v,y,x){var w=(t-m)/(v-m),M=o.normal_cache;l[e+0]=r+w*o.delta,l[e+1]=n,l[e+2]=f,c[e+0]=d(M[q+0],M[q+3],w),c[e+1]=d(M[q+1],M[q+4],w),c[e+2]=d(M[q+2],M[q+5],w),h[e+0]=d(o.palette[3*y+0],o.palette[3*x+0],w),h[e+1]=d(o.palette[3*y+1],o.palette[3*x+1],w),h[e+2]=d(o.palette[3*y+2],o.palette[3*x+2],w)}function m(q,e,t,r,n,f,m,v,y,x){var w=(t-m)/(v-m),M=o.normal_cache;l[e+0]=r,l[e+1]=n+w*o.delta,l[e+2]=f;var S=q+3*o.yd;c[e+0]=d(M[q+0],M[S+0],w),c[e+1]=d(M[q+1],M[S+1],w),c[e+2]=d(M[q+2],M[S+2],w),h[e+0]=d(o.palette[3*y+0],o.palette[3*x+0],w),h[e+1]=d(o.palette[3*y+1],o.palette[3*x+1],w),h[e+2]=d(o.palette[3*y+2],o.palette[3*x+2],w)}function v(q,e,t,r,n,f,m,v,y,x){var w=(t-m)/(v-m),M=o.normal_cache;l[e+0]=r,l[e+1]=n,l[e+2]=f+w*o.delta;var S=q+3*o.zd;c[e+0]=d(M[q+0],M[S+0],w),c[e+1]=d(M[q+1],M[S+1],w),c[e+2]=d(M[q+2],M[S+2],w),h[e+0]=d(o.palette[3*y+0],o.palette[3*x+0],w),h[e+1]=d(o.palette[3*y+1],o.palette[3*x+1],w),h[e+2]=d(o.palette[3*y+2],o.palette[3*x+2],w)}function y(q){var e=3*q;0===o.normal_cache[e]&&(o.normal_cache[e+0]=o.field[q-1]-o.field[q+1],o.normal_cache[e+1]=o.field[q-o.yd]-o.field[q+o.yd],o.normal_cache[e+2]=o.field[q-o.zd]-o.field[q+o.zd])}function x(e,t,r,q,n,d){var x=q+1,M=q+o.yd,S=q+o.zd,A=x+o.yd,T=x+o.zd,_=q+o.yd+o.zd,L=x+o.yd+o.zd,C=0,N=o.field[q],P=o.field[x],E=o.field[M],D=o.field[A],F=o.field[S],R=o.field[T],O=o.field[_],B=o.field[L];N<n&&(C|=1),P<n&&(C|=2),E<n&&(C|=8),D<n&&(C|=4),F<n&&(C|=16),R<n&&(C|=32),O<n&&(C|=128),B<n&&(C|=64);var I=edgeTable[C];if(0===I)return 0;var U=o.delta,V=e+U,k=t+U,G=r+U;1&I&&(y(q),y(x),f(3*q,0,n,e,t,r,N,P,q,x)),2&I&&(y(x),y(A),m(3*x,3,n,V,t,r,P,D,x,A)),4&I&&(y(M),y(A),f(3*M,6,n,e,k,r,E,D,M,A)),8&I&&(y(q),y(M),m(3*q,9,n,e,t,r,N,E,q,M)),16&I&&(y(S),y(T),f(3*S,12,n,e,t,G,F,R,S,T)),32&I&&(y(T),y(L),m(3*T,15,n,V,t,G,R,B,T,L)),64&I&&(y(_),y(L),f(3*_,18,n,e,k,G,O,B,_,L)),128&I&&(y(S),y(_),m(3*S,21,n,e,t,G,F,O,S,_)),256&I&&(y(q),y(S),v(3*q,24,n,e,t,r,N,F,q,S)),512&I&&(y(x),y(T),v(3*x,27,n,V,t,r,P,R,x,T)),1024&I&&(y(A),y(L),v(3*A,30,n,V,k,r,D,B,A,L)),2048&I&&(y(M),y(_),v(3*M,33,n,e,k,r,E,O,M,_)),C<<=4;for(var z,j,W,H=0,i=0;-1!=triTable[C+i];)j=(z=C+i)+1,W=z+2,w(l,c,h,3*triTable[z],3*triTable[j],3*triTable[W],d),i+=3,H++;return H}function w(e,t,r,n,l,c,h){var d=3*o.count;if(o.positionArray[d+0]=e[n],o.positionArray[d+1]=e[n+1],o.positionArray[d+2]=e[n+2],o.positionArray[d+3]=e[l],o.positionArray[d+4]=e[l+1],o.positionArray[d+5]=e[l+2],o.positionArray[d+6]=e[c],o.positionArray[d+7]=e[c+1],o.positionArray[d+8]=e[c+2],!0===o.material.flatShading){var f=(t[n+0]+t[l+0]+t[c+0])/3,m=(t[n+1]+t[l+1]+t[c+1])/3,v=(t[n+2]+t[l+2]+t[c+2])/3;o.normalArray[d+0]=f,o.normalArray[d+1]=m,o.normalArray[d+2]=v,o.normalArray[d+3]=f,o.normalArray[d+4]=m,o.normalArray[d+5]=v,o.normalArray[d+6]=f,o.normalArray[d+7]=m,o.normalArray[d+8]=v}else o.normalArray[d+0]=t[n+0],o.normalArray[d+1]=t[n+1],o.normalArray[d+2]=t[n+2],o.normalArray[d+3]=t[l+0],o.normalArray[d+4]=t[l+1],o.normalArray[d+5]=t[l+2],o.normalArray[d+6]=t[c+0],o.normalArray[d+7]=t[c+1],o.normalArray[d+8]=t[c+2];if(o.enableUvs){var y=2*o.count;o.uvArray[y+0]=e[n+0],o.uvArray[y+1]=e[n+2],o.uvArray[y+2]=e[l+0],o.uvArray[y+3]=e[l+2],o.uvArray[y+4]=e[c+0],o.uvArray[y+5]=e[c+2]}o.enableColors&&(o.colorArray[d+0]=r[n+0],o.colorArray[d+1]=r[n+1],o.colorArray[d+2]=r[n+2],o.colorArray[d+3]=r[l+0],o.colorArray[d+4]=r[l+1],o.colorArray[d+5]=r[l+2],o.colorArray[d+6]=r[c+0],o.colorArray[d+7]=r[c+1],o.colorArray[d+8]=r[c+2]),o.count+=3,o.count>=o.maxCount-3&&(o.hasPositions=!0,o.hasNormals=!0,o.enableUvs&&(o.hasUvs=!0),o.enableColors&&(o.hasColors=!0),h(o))}function M(a,b,e){var t=new Float32Array(a.length+e);return t.set(a,0),t.set(b.slice(0,e),a.length),t}this.enableUvs=void 0!==r&&r,this.enableColors=void 0!==n&&n,this.init=function(e){this.resolution=e,this.isolation=80,this.size=e,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(3*this.size3),this.palette=new Float32Array(3*this.size3),this.maxCount=4096,this.count=0,this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=new Float32Array(3*this.maxCount),this.normalArray=new Float32Array(3*this.maxCount),this.enableUvs&&(this.uvArray=new Float32Array(2*this.maxCount)),this.enableColors&&(this.colorArray=new Float32Array(3*this.maxCount))},this.begin=function(){this.count=0,this.hasPositions=!1,this.hasNormals=!1,this.hasUvs=!1,this.hasColors=!1},this.end=function(e){if(0!==this.count){for(var i=3*this.count;i<this.positionArray.length;i++)this.positionArray[i]=0;this.hasPositions=!0,this.hasNormals=!0,this.enableUvs&&this.material.map&&(this.hasUvs=!0),this.enableColors&&this.material.vertexColors!==NoColors&&(this.hasColors=!0),e(this)}},this.addBall=function(e,t,r,n,o,l){var c=Math.sign(n);n=Math.abs(n);var h=!(null==l),d=new Color(e,t,r);if(h)try{d=l instanceof Color?l:Array.isArray(l)?new Color(Math.min(Math.abs(l[0]),1),Math.min(Math.abs(l[1]),1),Math.min(Math.abs(l[2]),1)):new Color(l)}catch(n){h=!1,d=new Color(e,t,r)}var f=this.size*Math.sqrt(n/o),m=r*this.size,v=t*this.size,y=e*this.size,x=Math.floor(m-f);x<1&&(x=1);var w=Math.floor(m+f);w>this.size-1&&(w=this.size-1);var M=Math.floor(v-f);M<1&&(M=1);var S=Math.floor(v+f);S>this.size-1&&(S=this.size-1);var A=Math.floor(y-f);A<1&&(A=1);var T,_,L,C,N,P,E,D,F,R,O,B=Math.floor(y+f);for(B>this.size-1&&(B=this.size-1),L=x;L<w;L++)for(N=this.size2*L,F=(D=L/this.size-r)*D,_=M;_<S;_++)for(C=N+this.size*_,R=(E=_/this.size-t)*E,T=A;T<B;T++)if((O=n/(1e-6+(P=T/this.size-e)*P+R+F)-o)>0){this.field[C+T]+=O*c;var I=Math.sqrt((T-y)*(T-y)+(_-v)*(_-v)+(L-m)*(L-m))/f,U=1-I*I*I*(I*(6*I-15)+10);this.palette[3*(C+T)+0]+=d.r*U,this.palette[3*(C+T)+1]+=d.g*U,this.palette[3*(C+T)+2]+=d.b*U}},this.addPlaneX=function(e,t){var r,n,o,l,c,h,d=this.size,f=this.yd,m=this.zd,v=this.field,y=d*Math.sqrt(e/t);for(y>d&&(y=d),r=0;r<y;r++)if((l=e/(1e-4+(c=r/d)*c)-t)>0)for(n=0;n<d;n++)for(h=r+n*f,o=0;o<d;o++)v[m*o+h]+=l},this.addPlaneY=function(e,t){var r,n,o,l,c,h,d,f=this.size,m=this.yd,v=this.zd,y=this.field,x=f*Math.sqrt(e/t);for(x>f&&(x=f),n=0;n<x;n++)if((l=e/(1e-4+(c=n/f)*c)-t)>0)for(h=n*m,r=0;r<f;r++)for(d=h+r,o=0;o<f;o++)y[v*o+d]+=l},this.addPlaneZ=function(e,t){var r,n,o,l,c,h,d,f=this.size,m=this.yd,v=this.zd,y=this.field,x=f*Math.sqrt(e/t);for(x>f&&(x=f),o=0;o<x;o++)if((l=e/(1e-4+(c=o/f)*c)-t)>0)for(h=v*o,n=0;n<f;n++)for(d=h+n*m,r=0;r<f;r++)y[d+r]+=l},this.reset=function(){var i;for(i=0;i<this.size3;i++)this.normal_cache[3*i]=0,this.field[i]=0,this.palette[3*i]=this.palette[3*i+1]=this.palette[3*i+2]=0},this.render=function(e){this.begin();for(var t=this.size-2,r=1;r<t;r++)for(var n=this.size2*r,o=(r-this.halfsize)/this.halfsize,l=1;l<t;l++)for(var c=n+this.size*l,h=(l-this.halfsize)/this.halfsize,d=1;d<t;d++){x((d-this.halfsize)/this.halfsize,h,o,c+d,this.isolation,e)}this.end(e)},this.generateGeometry=function(){return console.warn("MarchingCubes: generateGeometry() now returns BufferGeometry"),this.generateBufferGeometry()},this.generateBufferGeometry=function(){var e=new BufferGeometry,t=new Float32Array,r=new Float32Array,n=new Float32Array,o=new Float32Array,l=this;return this.render((function(object){l.hasPositions&&(t=M(t,object.positionArray,3*object.count)),l.hasNormals&&(r=M(r,object.normalArray,3*object.count)),l.hasColors&&(n=M(n,object.colorArray,3*object.count)),l.hasUvs&&(o=M(o,object.uvArray,2*object.count)),object.count=0})),this.hasPositions&&e.addAttribute("position",new BufferAttribute(t,3)),this.hasNormals&&e.addAttribute("normal",new BufferAttribute(r,3)),this.hasColors&&e.addAttribute("color",new BufferAttribute(n,3)),this.hasUvs&&e.addAttribute("uv",new BufferAttribute(o,2)),e},this.init(e)};MarchingCubes.prototype=Object.create(ImmediateRenderObject.prototype),MarchingCubes.prototype.constructor=MarchingCubes;var edgeTable=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),triTable=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),ColorConverter={setHSV:function(e,t,s,r){return t=_Math.euclideanModulo(t,1),s=_Math.clamp(s,0,1),r=_Math.clamp(r,0,1),e.setHSL(t,s*r/((t=(2-s)*r)<1?t:2-t),.5*t)},getHSV:function(){var e={};return function(t,r){return void 0===r&&(console.warn("ColorConverter: .getHSV() target is now required"),r={h:0,s:0,l:0}),t.getHSL(e),e.s*=e.l<.5?e.l:1-e.l,r.h=e.h,r.s=2*e.s/(e.l+e.s),r.v=e.l+e.s,r}}(),setCMYK:function(e,t,r,n,o){var l=(1-t)*(1-o),g=(1-r)*(1-o),b=(1-n)*(1-o);return e.setRGB(l,g,b)},getCMYK:function(e,t){void 0===t&&(console.warn("ColorConverter: .getCMYK() target is now required"),t={c:0,m:0,y:0,k:0});var r=e.r,g=e.g,b=e.b,n=1-Math.max(r,g,b),o=(1-r-n)/(1-n),l=(1-g-n)/(1-n),c=(1-b-n)/(1-n);return t.c=o,t.m=l,t.y=c,t.k=n,t}},geometry;function CanvasTexture(canvas,e,t,r,n,o,l,c,h){Texture.call(this,canvas,e,t,r,n,o,l,c,h),this.needsUpdate=!0}function Sprite(e){if(Object3D.call(this),this.type="Sprite",void 0===geometry){geometry=new BufferGeometry;var t=new InterleavedBuffer(new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),5);geometry.setIndex([0,1,2,0,2,3]),geometry.addAttribute("position",new InterleavedBufferAttribute(t,3,0,!1)),geometry.addAttribute("uv",new InterleavedBufferAttribute(t,2,3,!1))}this.geometry=geometry,this.material=void 0!==e?e:new SpriteMaterial,this.center=new Vector2(.5,.5)}CanvasTexture.prototype=Object.create(Texture.prototype),CanvasTexture.prototype.constructor=CanvasTexture,CanvasTexture.prototype.isCanvasTexture=!0,Sprite.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Sprite,isSprite:!0,raycast:function(){var e=new Vector3,t=new Vector3,r=new Vector3,n=new Vector2,o=new Vector2,l=new Matrix4,c=new Vector3,h=new Vector3,d=new Vector3,f=new Vector2,m=new Vector2,v=new Vector2;function y(e,t,r,c,h,d){n.subVectors(e,r).addScalar(.5).multiply(c),void 0!==h?(o.x=d*n.x-h*n.y,o.y=h*n.x+d*n.y):o.copy(n),e.copy(t),e.x+=o.x,e.y+=o.y,e.applyMatrix4(l)}return function(n,o){t.setFromMatrixScale(this.matrixWorld),l.getInverse(this.modelViewMatrix).premultiply(this.matrixWorld),r.setFromMatrixPosition(this.modelViewMatrix);var x,w,M=this.material.rotation;0!==M&&(w=Math.cos(M),x=Math.sin(M));var S=this.center;y(c.set(-.5,-.5,0),r,S,t,x,w),y(h.set(.5,-.5,0),r,S,t,x,w),y(d.set(.5,.5,0),r,S,t,x,w),f.set(0,0),m.set(1,0),v.set(1,1);var A=n.ray.intersectTriangle(c,h,d,!1,e);if(null!==A||(y(h.set(-.5,.5,0),r,S,t,x,w),m.set(0,1),null!==(A=n.ray.intersectTriangle(c,d,h,!1,e)))){var T=n.ray.origin.distanceTo(e);T<n.near||T>n.far||o.push({distance:T,point:e.clone(),uv:Triangle.getUV(e,c,h,d,f,m,v,new Vector2),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)},copy:function(source){return Object3D.prototype.copy.call(this,source),void 0!==source.center&&this.center.copy(source.center),this}});var Lut=function(e,t){this.lut=[],this.map=ColorMapKeywords[e],this.n=t,this.mapname=e;for(var r=1/this.n,i=0;i<=1;i+=r)for(var n=0;n<this.map.length-1;n++)if(i>=this.map[n][0]&&i<this.map[n+1][0]){var o=this.map[n][0],l=this.map[n+1][0],c=new Color(16777215).setHex(this.map[n][1]),h=new Color(16777215).setHex(this.map[n+1][1]),d=c.lerp(h,(i-o)/(l-o));this.lut.push(d)}return this.set(this)};Lut.prototype={constructor:Lut,lut:[],map:[],mapname:"rainbow",n:256,minV:0,maxV:1,legend:null,set:function(e){return e instanceof Lut&&this.copy(e),this},setMin:function(e){return this.minV=e,this},setMax:function(e){return this.maxV=e,this},changeNumberOfColors:function(e){return this.n=e,new Lut(this.mapname,this.n)},changeColorMap:function(e){return this.mapname=e,new Lut(this.mapname,this.n)},copy:function(e){return this.lut=e.lut,this.mapname=e.mapname,this.map=e.map,this.n=e.n,this.minV=e.minV,this.maxV=e.maxV,this},getColor:function(e){e<=this.minV?e=this.minV:e>=this.maxV&&(e=this.maxV),e=(e-this.minV)/(this.maxV-this.minV);var t=Math.round(e*this.n);return t==this.n&&(t-=1),this.lut[t]},addColorMap:function(e,t){ColorMapKeywords[e]=t},setLegendOn:function(e){void 0===e&&(e={}),this.legend={},this.legend.layout=e.hasOwnProperty("layout")?e.layout:"vertical",this.legend.position=e.hasOwnProperty("position")?e.position:{x:4,y:0,z:0},this.legend.dimensions=e.hasOwnProperty("dimensions")?e.dimensions:{width:.5,height:3},this.legend.canvas=document.createElement("canvas"),this.legend.canvas.setAttribute("id","legend"),this.legend.canvas.setAttribute("hidden",!0),document.body.appendChild(this.legend.canvas),this.legend.ctx=this.legend.canvas.getContext("2d"),this.legend.canvas.setAttribute("width",1),this.legend.canvas.setAttribute("height",this.n),this.legend.texture=new Texture(this.legend.canvas);var t=this.legend.ctx.getImageData(0,0,1,this.n),data=t.data;this.map=ColorMapKeywords[this.mapname];for(var r=0,n=1/this.n,i=1;i>=0;i-=n)for(var o=this.map.length-1;o>=0;o--)if(i<this.map[o][0]&&i>=this.map[o-1][0]){var l=this.map[o-1][0],c=this.map[o][0],h=new Color(16777215).setHex(this.map[o-1][1]),d=new Color(16777215).setHex(this.map[o][1]),f=h.lerp(d,(i-l)/(c-l));data[4*r]=Math.round(255*f.r),data[4*r+1]=Math.round(255*f.g),data[4*r+2]=Math.round(255*f.b),data[4*r+3]=255,r+=1}return this.legend.ctx.putImageData(t,0,0),this.legend.texture.needsUpdate=!0,this.legend.legendGeometry=new PlaneBufferGeometry(this.legend.dimensions.width,this.legend.dimensions.height),this.legend.legendMaterial=new MeshBasicMaterial({map:this.legend.texture,side:DoubleSide}),this.legend.mesh=new Mesh(this.legend.legendGeometry,this.legend.legendMaterial),"horizontal"==this.legend.layout&&(this.legend.mesh.rotation.z=Math.PI/180*-90),this.legend.mesh.position.copy(this.legend.position),this.legend.mesh},setLegendOff:function(){return this.legend=null,this.legend},setLegendLayout:function(e){return!!this.legend&&(this.legend.layout!=e&&(("horizontal"==e||"vertical"==e)&&(this.layout=e,"horizontal"==e&&(this.legend.mesh.rotation.z=Math.PI/180*90),"vertical"==e&&(this.legend.mesh.rotation.z=Math.PI/180*-90),this.legend.mesh)))},setLegendPosition:function(e){return this.legend.position=new Vector3(e.x,e.y,e.z),this.legend},setLegendLabels:function(e,t){if(!this.legend)return!1;"function"==typeof e&&(t=e),void 0===e&&(e={}),this.legend.labels={},this.legend.labels.fontsize=e.hasOwnProperty("fontsize")?e.fontsize:24,this.legend.labels.fontface=e.hasOwnProperty("fontface")?e.fontface:"Arial",this.legend.labels.title=e.hasOwnProperty("title")?e.title:"",this.legend.labels.um=e.hasOwnProperty("um")?" [ "+e.um+" ]":"",this.legend.labels.ticks=e.hasOwnProperty("ticks")?e.ticks:0,this.legend.labels.decimal=e.hasOwnProperty("decimal")?e.decimal:2,this.legend.labels.notation=e.hasOwnProperty("notation")?e.notation:"standard";var r=255,n=100,o=100,l=.8,c=255,h=0,d=0,f=1,m=document.createElement("canvas"),v=m.getContext("2d");v.font="Normal "+1.2*this.legend.labels.fontsize+"px "+this.legend.labels.fontface,v.fillStyle="rgba("+r+","+n+","+o+","+l+")",v.strokeStyle="rgba("+c+","+h+","+d+","+f+")",v.lineWidth=4,v.fillStyle="rgba( 0, 0, 0, 1.0 )",v.fillText(this.legend.labels.title.toString()+this.legend.labels.um.toString(),4,this.legend.labels.fontsize+4);var y=new CanvasTexture(m);y.minFilter=LinearFilter;var x=new Sprite(new SpriteMaterial({map:y}));if(x.scale.set(2,1,1),"vertical"==this.legend.layout&&x.position.set(this.legend.position.x+this.legend.dimensions.width,this.legend.position.y+.45*this.legend.dimensions.height,this.legend.position.z),"horizontal"==this.legend.layout&&x.position.set(1.015*this.legend.position.x,this.legend.position.y+.03*this.legend.dimensions.height,this.legend.position.z),this.legend.labels.ticks>0){var w={},M={};if("vertical"==this.legend.layout)var S=this.legend.position.y+.36*this.legend.dimensions.height,A=this.legend.position.y-.61*this.legend.dimensions.height;if("horizontal"==this.legend.layout)var T=this.legend.position.x+.75*this.legend.dimensions.height,_=this.legend.position.x-1.2*this.legend.dimensions.width;for(var i=0;i<this.legend.labels.ticks;i++){var L=(this.maxV-this.minV)/(this.legend.labels.ticks-1)*i+this.minV;L=t?t(L):"scientific"==this.legend.labels.notation?L.toExponential(this.legend.labels.decimal):L.toFixed(this.legend.labels.decimal);var C=document.createElement("canvas"),N=C.getContext("2d");N.font="Normal "+this.legend.labels.fontsize+"px "+this.legend.labels.fontface,N.fillStyle="rgba("+r+","+n+","+o+","+l+")",N.strokeStyle="rgba("+c+","+h+","+d+","+f+")",N.lineWidth=4,N.fillStyle="rgba( 0, 0, 0, 1.0 )",N.fillText(L.toString(),4,this.legend.labels.fontsize+4);var P=new CanvasTexture(C);P.minFilter=LinearFilter;var E=new Sprite(new SpriteMaterial({map:P}));if(E.scale.set(2,1,1),"vertical"==this.legend.layout){var D=A+(S-A)*((L-this.minV)/(this.maxV-this.minV));E.position.set(this.legend.position.x+2.7*this.legend.dimensions.width,D,this.legend.position.z)}if("horizontal"==this.legend.layout){D=_+(T-_)*((L-this.minV)/(this.maxV-this.minV));if(this.legend.labels.ticks>5)if(i%2==0)var F=1.7;else F=2.1;else F=1.7;E.position.set(D,this.legend.position.y-this.legend.dimensions.width*F,this.legend.position.z)}var R=new LineBasicMaterial({color:0,linewidth:2}),O=[];if("vertical"==this.legend.layout){var B=this.legend.position.y-.5*this.legend.dimensions.height+.01+this.legend.dimensions.height*((L-this.minV)/(this.maxV-this.minV)*.99);O.push(new Vector3(this.legend.position.x+.55*this.legend.dimensions.width,B,this.legend.position.z)),O.push(new Vector3(this.legend.position.x+.7*this.legend.dimensions.width,B,this.legend.position.z))}if("horizontal"==this.legend.layout){B=this.legend.position.x-.5*this.legend.dimensions.height+.01+this.legend.dimensions.height*((L-this.minV)/(this.maxV-this.minV)*.99);O.push(new Vector3(B,this.legend.position.y-.55*this.legend.dimensions.width,this.legend.position.z)),O.push(new Vector3(B,this.legend.position.y-.7*this.legend.dimensions.width,this.legend.position.z))}var line=new Line((new BufferGeometry).setFromPoints(O),R);M[i]=line,w[i]=E}}return{title:x,ticks:w,lines:M}}};var ColorMapKeywords={rainbow:[[0,"0x0000FF"],[.2,"0x00FFFF"],[.5,"0x00FF00"],[.8,"0xFFFF00"],[1,"0xFF0000"]],cooltowarm:[[0,"0x3C4EC2"],[.2,"0x9BBCFF"],[.5,"0xDCDCDC"],[.8,"0xF6A385"],[1,"0xB40426"]],blackbody:[[0,"0x000000"],[.2,"0x780000"],[.5,"0xE63200"],[.8,"0xFFFF00"],[1,"0xFFFFFF"]],grayscale:[[0,"0x000000"],[.2,"0x404040"],[.5,"0x7F7F80"],[.8,"0xBFBFBF"],[1,"0xFFFFFF"]]},MD2Character=function(){var e=this;function t(e,t){for(var r=new TextureLoader,o=[],i=0;i<t.length;i++)o[i]=r.load(e+t[i],n),o[i].mapping=UVMapping,o[i].name=t[i];return o}function r(e,t){var r=new MeshLambertMaterial({color:16755200,wireframe:!0,morphTargets:!0,morphNormals:!0}),n=new MeshLambertMaterial({color:16777215,wireframe:!1,map:t,morphTargets:!0,morphNormals:!0}),o=new Mesh(e,n);return o.rotation.y=-Math.PI/2,o.castShadow=!0,o.receiveShadow=!0,o.materialTexture=n,o.materialWireframe=r,o}function n(){e.loadCounter-=1,0===e.loadCounter&&e.onLoadComplete()}this.scale=1,this.animationFPS=6,this.root=new Object3D,this.meshBody=null,this.meshWeapon=null,this.skinsBody=[],this.skinsWeapon=[],this.weapons=[],this.activeAnimation=null,this.mixer=null,this.onLoadComplete=function(){},this.loadCounter=0,this.loadParts=function(o){this.loadCounter=2*o.weapons.length+o.skins.length+1;for(var l=[],i=0;i<o.weapons.length;i++)l[i]=o.weapons[i][1];this.skinsBody=t(o.baseUrl+"skins/",o.skins),this.skinsWeapon=t(o.baseUrl+"skins/",l);var c=new MD2Loader;c.load(o.baseUrl+o.body,(function(t){t.computeBoundingBox(),e.root.position.y=-e.scale*t.boundingBox.min.y;var o=r(t,e.skinsBody[0]);o.scale.set(e.scale,e.scale,e.scale),e.root.add(o),e.meshBody=o,e.meshBody.clipOffset=0,e.activeAnimationClipName=o.geometry.animations[0].name,e.mixer=new AnimationMixer(o),n()}));var h=function(t,o){return function(l){var c=r(l,e.skinsWeapon[t]);c.scale.set(e.scale,e.scale,e.scale),c.visible=!1,c.name=o,e.root.add(c),e.weapons[t]=c,e.meshWeapon=c,n()}};for(i=0;i<o.weapons.length;i++)c.load(o.baseUrl+o.weapons[i][0],h(i,o.weapons[i][0]))},this.setPlaybackRate=function(e){this.mixer.timeScale=0!==e?1/e:0},this.setWireframe=function(e){e?(this.meshBody&&(this.meshBody.material=this.meshBody.materialWireframe),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialWireframe)):(this.meshBody&&(this.meshBody.material=this.meshBody.materialTexture),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialTexture))},this.setSkin=function(e){this.meshBody&&!1===this.meshBody.material.wireframe&&(this.meshBody.material.map=this.skinsBody[e])},this.setWeapon=function(t){for(var i=0;i<this.weapons.length;i++)this.weapons[i].visible=!1;var r=this.weapons[t];r&&(r.visible=!0,this.meshWeapon=r,e.syncWeaponAnimation())},this.setAnimation=function(t){if(this.meshBody){this.meshBody.activeAction&&(this.meshBody.activeAction.stop(),this.meshBody.activeAction=null);var r=this.mixer.clipAction(t,this.meshBody);r&&(this.meshBody.activeAction=r.play())}e.activeClipName=t,e.syncWeaponAnimation()},this.syncWeaponAnimation=function(){var t=e.activeClipName;if(e.meshWeapon){this.meshWeapon.activeAction&&(this.meshWeapon.activeAction.stop(),this.meshWeapon.activeAction=null);var r=this.mixer.clipAction(t,this.meshWeapon);r&&(this.meshWeapon.activeAction=r.syncWith(this.meshBody.activeAction).play())}},this.update=function(e){this.mixer&&this.mixer.update(e)}},MorphBlendMesh=function(e,t){Mesh.call(this,e,t),this.animationsMap={},this.animationsList=[];var r=Object.keys(this.morphTargetDictionary).length,n=r-1,o=r/1;this.createAnimation("__default",0,n,o),this.setAnimationWeight("__default",1)};MorphBlendMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:MorphBlendMesh,createAnimation:function(e,t,r,n){var o={start:t,end:r,length:r-t+1,fps:n,duration:(r-t)/n,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=o,this.animationsList.push(o)},autoCreateAnimations:function(e){var t,pattern=/([a-z]+)_?(\d+)/i,r={},i=0;for(var n in this.morphTargetDictionary){var o=n.match(pattern);if(o&&o.length>1)r[l=o[1]]||(r[l]={start:1/0,end:-1/0}),i<(c=r[l]).start&&(c.start=i),i>c.end&&(c.end=i),t||(t=l);i++}for(var l in r){var c=r[l];this.createAnimation(l,c.start,c.end,e)}this.firstAnimation=t},setAnimationDirectionForward:function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},setAnimationDirectionBackward:function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},setAnimationFPS:function(e,t){var r=this.animationsMap[e];r&&(r.fps=t,r.duration=(r.end-r.start)/r.fps)},setAnimationDuration:function(e,t){var r=this.animationsMap[e];r&&(r.duration=t,r.fps=(r.end-r.start)/r.duration)},setAnimationWeight:function(e,t){var r=this.animationsMap[e];r&&(r.weight=t)},setAnimationTime:function(e,time){var t=this.animationsMap[e];t&&(t.time=time)},getAnimationTime:function(e){var time=0,t=this.animationsMap[e];return t&&(time=t.time),time},getAnimationDuration:function(e){var t=-1,r=this.animationsMap[e];return r&&(t=r.duration),t},playAnimation:function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("MorphBlendMesh: animation["+e+"] undefined in .playAnimation()")},stopAnimation:function(e){var t=this.animationsMap[e];t&&(t.active=!1)},update:function(e){for(var i=0,t=this.animationsList.length;i<t;i++){var r=this.animationsList[i];if(r.active){var n=r.duration/r.length;r.time+=r.direction*e,r.mirroredLoop?(r.time>r.duration||r.time<0)&&(r.direction*=-1,r.time>r.duration&&(r.time=r.duration,r.directionBackwards=!0),r.time<0&&(r.time=0,r.directionBackwards=!1)):(r.time=r.time%r.duration,r.time<0&&(r.time+=r.duration));var o=r.start+_Math.clamp(Math.floor(r.time/n),0,r.length-1),l=r.weight;o!==r.currentFrame&&(this.morphTargetInfluences[r.lastFrame]=0,this.morphTargetInfluences[r.currentFrame]=1*l,this.morphTargetInfluences[o]=0,r.lastFrame=r.currentFrame,r.currentFrame=o);var c=r.time%n/n;r.directionBackwards&&(c=1-c),r.currentFrame!==r.lastFrame?(this.morphTargetInfluences[r.currentFrame]=c*l,this.morphTargetInfluences[r.lastFrame]=(1-c)*l):this.morphTargetInfluences[r.currentFrame]=l}}}});var MD2CharacterComplex=function(){var e=this;function t(e,t){for(var r=new TextureLoader,o=[],i=0;i<t.length;i++)o[i]=r.load(e+t[i],n),o[i].mapping=UVMapping,o[i].name=t[i];return o}function r(t,r){var n=new MeshLambertMaterial({color:16755200,wireframe:!0,morphTargets:!0,morphNormals:!0}),o=new MeshLambertMaterial({color:16777215,wireframe:!1,map:r,morphTargets:!0,morphNormals:!0}),l=new MorphBlendMesh(t,o);return l.rotation.y=-Math.PI/2,l.materialTexture=o,l.materialWireframe=n,l.autoCreateAnimations(e.animationFPS),l}function n(){e.loadCounter-=1,0===e.loadCounter&&e.onLoadComplete()}function o(e){return 1===e?1:1-Math.pow(2,-10*e)}this.scale=1,this.animationFPS=6,this.transitionFrames=15,this.maxSpeed=275,this.maxReverseSpeed=-275,this.frontAcceleration=600,this.backAcceleration=600,this.frontDecceleration=600,this.angularSpeed=2.5,this.root=new Object3D,this.meshBody=null,this.meshWeapon=null,this.controls=null,this.skinsBody=[],this.skinsWeapon=[],this.weapons=[],this.currentSkin=void 0,this.onLoadComplete=function(){},this.meshes=[],this.animations={},this.loadCounter=0,this.speed=0,this.bodyOrientation=0,this.walkSpeed=this.maxSpeed,this.crouchSpeed=.5*this.maxSpeed,this.activeAnimation=null,this.oldAnimation=null,this.enableShadows=function(e){for(var i=0;i<this.meshes.length;i++)this.meshes[i].castShadow=e,this.meshes[i].receiveShadow=e},this.setVisible=function(e){for(var i=0;i<this.meshes.length;i++)this.meshes[i].visible=e,this.meshes[i].visible=e},this.shareParts=function(e){this.animations=e.animations,this.walkSpeed=e.walkSpeed,this.crouchSpeed=e.crouchSpeed,this.skinsBody=e.skinsBody,this.skinsWeapon=e.skinsWeapon;var t=r(e.meshBody.geometry,this.skinsBody[0]);t.scale.set(this.scale,this.scale,this.scale),this.root.position.y=e.root.position.y,this.root.add(t),this.meshBody=t,this.meshes.push(t);for(var i=0;i<e.weapons.length;i++){var n=r(e.weapons[i].geometry,this.skinsWeapon[i]);n.scale.set(this.scale,this.scale,this.scale),n.visible=!1,n.name=e.weapons[i].name,this.root.add(n),this.weapons[i]=n,this.meshWeapon=n,this.meshes.push(n)}},this.loadParts=function(o){this.animations=o.animations,this.walkSpeed=o.walkSpeed,this.crouchSpeed=o.crouchSpeed,this.loadCounter=2*o.weapons.length+o.skins.length+1;for(var l=[],i=0;i<o.weapons.length;i++)l[i]=o.weapons[i][1];this.skinsBody=t(o.baseUrl+"skins/",o.skins),this.skinsWeapon=t(o.baseUrl+"skins/",l);var c=new MD2Loader;c.load(o.baseUrl+o.body,(function(t){t.computeBoundingBox(),e.root.position.y=-e.scale*t.boundingBox.min.y;var o=r(t,e.skinsBody[0]);o.scale.set(e.scale,e.scale,e.scale),e.root.add(o),e.meshBody=o,e.meshes.push(o),n()}));var h=function(t,o){return function(l){var c=r(l,e.skinsWeapon[t]);c.scale.set(e.scale,e.scale,e.scale),c.visible=!1,c.name=o,e.root.add(c),e.weapons[t]=c,e.meshWeapon=c,e.meshes.push(c),n()}};for(i=0;i<o.weapons.length;i++)c.load(o.baseUrl+o.weapons[i][0],h(i,o.weapons[i][0]))},this.setPlaybackRate=function(e){this.meshBody&&(this.meshBody.duration=this.meshBody.baseDuration/e),this.meshWeapon&&(this.meshWeapon.duration=this.meshWeapon.baseDuration/e)},this.setWireframe=function(e){e?(this.meshBody&&(this.meshBody.material=this.meshBody.materialWireframe),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialWireframe)):(this.meshBody&&(this.meshBody.material=this.meshBody.materialTexture),this.meshWeapon&&(this.meshWeapon.material=this.meshWeapon.materialTexture))},this.setSkin=function(e){this.meshBody&&!1===this.meshBody.material.wireframe&&(this.meshBody.material.map=this.skinsBody[e],this.currentSkin=e)},this.setWeapon=function(e){for(var i=0;i<this.weapons.length;i++)this.weapons[i].visible=!1;var t=this.weapons[e];t&&(t.visible=!0,this.meshWeapon=t,this.activeAnimation&&(t.playAnimation(this.activeAnimation),this.meshWeapon.setAnimationTime(this.activeAnimation,this.meshBody.getAnimationTime(this.activeAnimation))))},this.setAnimation=function(e){e!==this.activeAnimation&&e&&(this.meshBody&&(this.meshBody.setAnimationWeight(e,0),this.meshBody.playAnimation(e),this.oldAnimation=this.activeAnimation,this.activeAnimation=e,this.blendCounter=this.transitionFrames),this.meshWeapon&&(this.meshWeapon.setAnimationWeight(e,0),this.meshWeapon.playAnimation(e)))},this.update=function(e){this.controls&&this.updateMovementModel(e),this.animations&&(this.updateBehaviors(e),this.updateAnimations(e))},this.updateAnimations=function(e){var t=1;this.blendCounter>0&&(t=(this.transitionFrames-this.blendCounter)/this.transitionFrames,this.blendCounter-=1),this.meshBody&&(this.meshBody.update(e),this.meshBody.setAnimationWeight(this.activeAnimation,t),this.meshBody.setAnimationWeight(this.oldAnimation,1-t)),this.meshWeapon&&(this.meshWeapon.update(e),this.meshWeapon.setAnimationWeight(this.activeAnimation,t),this.meshWeapon.setAnimationWeight(this.oldAnimation,1-t))},this.updateBehaviors=function(e){var t,r,n=this.controls,o=this.animations;n.crouch?(t=o.crouchMove,r=o.crouchIdle):(t=o.move,r=o.idle),n.jump&&(t=o.jump,r=o.jump),n.attack&&(n.crouch?(t=o.crouchAttack,r=o.crouchAttack):(t=o.attack,r=o.attack)),(n.moveForward||n.moveBackward||n.moveLeft||n.moveRight)&&this.activeAnimation!==t&&this.setAnimation(t),Math.abs(this.speed)<.2*this.maxSpeed&&!(n.moveLeft||n.moveRight||n.moveForward||n.moveBackward)&&this.activeAnimation!==r&&this.setAnimation(r),n.moveForward&&(this.meshBody&&(this.meshBody.setAnimationDirectionForward(this.activeAnimation),this.meshBody.setAnimationDirectionForward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionForward(this.activeAnimation),this.meshWeapon.setAnimationDirectionForward(this.oldAnimation))),n.moveBackward&&(this.meshBody&&(this.meshBody.setAnimationDirectionBackward(this.activeAnimation),this.meshBody.setAnimationDirectionBackward(this.oldAnimation)),this.meshWeapon&&(this.meshWeapon.setAnimationDirectionBackward(this.activeAnimation),this.meshWeapon.setAnimationDirectionBackward(this.oldAnimation)))},this.updateMovementModel=function(e){var t=this.controls;t.crouch?this.maxSpeed=this.crouchSpeed:this.maxSpeed=this.walkSpeed,this.maxReverseSpeed=-this.maxSpeed,t.moveForward&&(this.speed=_Math.clamp(this.speed+e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),t.moveBackward&&(this.speed=_Math.clamp(this.speed-e*this.backAcceleration,this.maxReverseSpeed,this.maxSpeed));if(t.moveLeft&&(this.bodyOrientation+=e*this.angularSpeed,this.speed=_Math.clamp(this.speed+1*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),t.moveRight&&(this.bodyOrientation-=e*this.angularSpeed,this.speed=_Math.clamp(this.speed+1*e*this.frontAcceleration,this.maxReverseSpeed,this.maxSpeed)),!t.moveForward&&!t.moveBackward)if(this.speed>0){var r=o(this.speed/this.maxSpeed);this.speed=_Math.clamp(this.speed-r*e*this.frontDecceleration,0,this.maxSpeed)}else{r=o(this.speed/this.maxReverseSpeed);this.speed=_Math.clamp(this.speed+r*e*this.backAcceleration,this.maxReverseSpeed,0)}var n=this.speed*e;this.root.position.x+=Math.sin(this.bodyOrientation)*n,this.root.position.z+=Math.cos(this.bodyOrientation)*n,this.root.rotation.y=this.bodyOrientation}},ExplodeModifier=function(){};ExplodeModifier.prototype.modify=function(e){for(var t=[],i=0,r=e.faces.length;i<r;i++){var n=t.length,o=e.faces[i],a=o.a,b=o.b,l=o.c,c=e.vertices[a],h=e.vertices[b],d=e.vertices[l];t.push(c.clone()),t.push(h.clone()),t.push(d.clone()),o.a=n,o.b=n+1,o.c=n+2}e.vertices=t};var SimplifyModifier=function(){};!function(){var e=new Vector3,t=new Vector3;function r(e,object){var t=e.indexOf(object);t>-1&&e.splice(t,1)}function n(u,e){var i,t,r,n=e.position.distanceTo(u.position),o=0,l=[],c=u.faces.length;for(i=0;i<c;i++)(t=u.faces[i]).hasVertex(e)&&l.push(t);for(i=0;i<c;i++){var h=1;t=u.faces[i];for(var d=0;d<l.length;d++){r=l[d];var f=t.normal.dot(r.normal);h=Math.min(h,(1.001-f)/2)}o=Math.max(o,h)}return l.length<2&&(o=1),n*o+0}function o(e){if(0===e.neighbors.length)return e.collapseNeighbor=null,void(e.collapseCost=-.01);e.collapseCost=1e5,e.collapseNeighbor=null;for(var i=0;i<e.neighbors.length;i++){var t=n(e,e.neighbors[i]);e.collapseNeighbor||(e.collapseNeighbor=e.neighbors[i],e.collapseCost=t,e.minCost=t,e.totalCost=0,e.costCount=0),e.costCount++,e.totalCost+=t,t<e.minCost&&(e.collapseNeighbor=e.neighbors[i],e.minCost=t)}e.collapseCost=e.totalCost/e.costCount}function l(e,t){for(console.assert(0===e.faces.length);e.neighbors.length;){r(e.neighbors.pop().neighbors,e)}r(t,e)}function c(e,t){r(t,e),e.v1&&r(e.v1.faces,e),e.v2&&r(e.v2.faces,e),e.v3&&r(e.v3.faces,e);for(var n,o,l=[e.v1,e.v2,e.v3],i=0;i<3;i++)o=l[(i+1)%3],(n=l[i])&&o&&(n.removeIfNonNeighbor(o),o.removeIfNonNeighbor(n))}function h(e,t,u,r){if(r){var i,n=[];for(i=0;i<u.neighbors.length;i++)n.push(u.neighbors[i]);for(i=u.faces.length-1;i>=0;i--)u.faces[i].hasVertex(r)&&c(u.faces[i],t);for(i=u.faces.length-1;i>=0;i--)u.faces[i].replaceVertex(u,r);for(l(u,e),i=0;i<n.length;i++)o(n[i])}else l(u,e)}function d(e){for(var t=e[0],i=0;i<e.length;i++)e[i].collapseCost<t.collapseCost&&(t=e[i]);return t}function f(e,t,r,a,b,n){this.a=a,this.b=b,this.c=n,this.v1=e,this.v2=t,this.v3=r,this.normal=new Vector3,this.computeNormal(),e.faces.push(this),e.addUniqueNeighbor(t),e.addUniqueNeighbor(r),t.faces.push(this),t.addUniqueNeighbor(e),t.addUniqueNeighbor(r),r.faces.push(this),r.addUniqueNeighbor(e),r.addUniqueNeighbor(t)}function m(e,t){this.position=e,this.id=t,this.faces=[],this.neighbors=[],this.collapseCost=0,this.collapseNeighbor=null}f.prototype.computeNormal=function(){var r=this.v1.position,n=this.v2.position,o=this.v3.position;e.subVectors(o,n),t.subVectors(r,n),e.cross(t).normalize(),this.normal.copy(e)},f.prototype.hasVertex=function(e){return e===this.v1||e===this.v2||e===this.v3},f.prototype.replaceVertex=function(e,t){e===this.v1?this.v1=t:e===this.v2?this.v2=t:e===this.v3&&(this.v3=t),r(e.faces,this),t.faces.push(this),e.removeIfNonNeighbor(this.v1),this.v1.removeIfNonNeighbor(e),e.removeIfNonNeighbor(this.v2),this.v2.removeIfNonNeighbor(e),e.removeIfNonNeighbor(this.v3),this.v3.removeIfNonNeighbor(e),this.v1.addUniqueNeighbor(this.v2),this.v1.addUniqueNeighbor(this.v3),this.v2.addUniqueNeighbor(this.v1),this.v2.addUniqueNeighbor(this.v3),this.v3.addUniqueNeighbor(this.v1),this.v3.addUniqueNeighbor(this.v2),this.computeNormal()},m.prototype.addUniqueNeighbor=function(e){!function(e,object){-1===e.indexOf(object)&&e.push(object)}(this.neighbors,e)},m.prototype.removeIfNonNeighbor=function(e){var t=this.neighbors,r=this.faces,n=t.indexOf(e);if(-1!==n){for(var i=0;i<r.length;i++)if(r[i].hasVertex(e))return;t.splice(n,1)}},SimplifyModifier.prototype.modify=function(e,t){e.isBufferGeometry&&(e=(new Geometry).fromBufferGeometry(e)),e.mergeVertices();var i,r,n,l=e.vertices,c=e.faces,v=[],y=[];for(i=0,r=l.length;i<r;i++){var x=new m(l[i],i);v.push(x)}for(i=0,r=c.length;i<r;i++){var a=(L=c[i]).a,b=L.b,w=L.c,M=new f(v[a],v[b],v[w],a,b,w);y.push(M)}for(i=0,r=v.length;i<r;i++)o(v[i]);for(var S=t;S--;){if(!(n=d(v))){console.log("SimplifyModifier: No next vertex");break}h(v,y,n,n.collapseNeighbor)}var A=new BufferGeometry,T=[],_=[];for(i=0;i<v.length;i++){x=v[i].position;T.push(x.x,x.y,x.z)}for(i=0;i<y.length;i++){var L=y[i];a=v.indexOf(L.v1),b=v.indexOf(L.v2),w=v.indexOf(L.v3);_.push(a,b,w)}return A.addAttribute("position",new Float32BufferAttribute(T,3)),A.setIndex(_),A}}();var SubdivisionModifier=function(e){this.subdivisions=void 0===e?1:e};SubdivisionModifier.prototype.modify=function(e){(e=e.isBufferGeometry?(new Geometry).fromBufferGeometry(e):e.clone()).mergeVertices();for(var t=this.subdivisions;t-- >0;)this.smooth(e);return e.computeFaceNormals(),e.computeVertexNormals(),e},function(){var e=["a","b","c"];function t(a,b,map){return map[Math.min(a,b)+"_"+Math.max(a,b)]}function r(a,b,e,map,t,r){var n,o=Math.min(a,b),l=Math.max(a,b),c=o+"_"+l;c in map?n=map[c]:(n={a:e[o],b:e[l],newEdge:null,faces:[]},map[c]=n);n.faces.push(t),r[a].edges.push(n),r[b].edges.push(n)}function n(e,a,b,t,r){e.push(new Face3(a,b,t,void 0,void 0,r))}function o(a,b){return Math.abs(b-a)/2+Math.min(a,b)}function l(e,a,b,t){e.push([a.clone(),b.clone(),t.clone()])}SubdivisionModifier.prototype.smooth=function(c){var h,d,f,m,v,y,i,x,w,M,S,A,T,_,L=new Vector3,C=[];h=c.vertices,d=c.faces;var N,P,E,D,F,R,O,B,I,U,V,k,G,z,j=void 0!==(f=c.faceVertexUvs[0])&&f.length>0;for(i in function(e,t,n,o){var i,l,c;for(i=0,l=e.length;i<l;i++)n[i]={edges:[]};for(i=0,l=t.length;i<l;i++)r((c=t[i]).a,c.b,e,o,c,n),r(c.b,c.c,e,o,c,n),r(c.c,c.a,e,o,c,n)}(h,d,S=new Array(h.length),A={}),T=[],A){for(P=A[i],E=new Vector3,F=3/8,R=1/8,2!=(O=P.faces.length)&&(F=.5,R=0),E.addVectors(P.a,P.b).multiplyScalar(F),L.set(0,0,0),w=0;w<O;w++){for(D=P.faces[w],M=0;M<3&&((N=h[D[e[M]]])===P.a||N===P.b);M++);L.add(N)}L.multiplyScalar(R),E.add(L),P.newEdge=T.length,T.push(E)}for(_=[],i=0,x=h.length;i<x;i++){for(G=h[i],3==(y=(k=S[i].edges).length)?B=3/16:y>3&&(B=3/(8*y)),I=1-y*B,U=B,y<=2&&2==y&&(I=.75,U=1/8),z=G.clone().multiplyScalar(I),L.set(0,0,0),w=0;w<y;w++)N=(V=k[w]).a!==G?V.a:V.b,L.add(N);L.multiplyScalar(U),z.add(L),_.push(z)}m=_.concat(T);var W,H,X,Y,Q,K,J,Z=_.length;v=[];var $=new Vector2,ee=new Vector2,te=new Vector2;for(i=0,x=d.length;i<x;i++)n(v,W=t((D=d[i]).a,D.b,A).newEdge+Z,H=t(D.b,D.c,A).newEdge+Z,X=t(D.c,D.a,A).newEdge+Z,D.materialIndex),n(v,D.a,W,X,D.materialIndex),n(v,D.b,H,W,D.materialIndex),n(v,D.c,X,H,D.materialIndex),j&&(Q=(Y=f[i])[0],K=Y[1],J=Y[2],$.set(o(Q.x,K.x),o(Q.y,K.y)),ee.set(o(K.x,J.x),o(K.y,J.y)),te.set(o(Q.x,J.x),o(Q.y,J.y)),l(C,$,ee,te),l(C,Q,$,te),l(C,K,ee,$),l(C,J,te,ee));c.vertices=m,c.faces=v,j&&(c.faceVertexUvs[0]=C)}}();var TessellateModifier=function(e){this.maxEdgeLength=e};TessellateModifier.prototype.modify=function(e){for(var t,r=[],n=[],o=this.maxEdgeLength*this.maxEdgeLength,i=0,l=e.faceVertexUvs.length;i<l;i++)n[i]=[];for(i=0,l=e.faces.length;i<l;i++){var c=e.faces[i];if(c instanceof Face3){var a=c.a,b=c.b,h=c.c,d=e.vertices[a],f=e.vertices[b],m=e.vertices[h],v=d.distanceToSquared(f),y=f.distanceToSquared(m),x=d.distanceToSquared(m);if(v>o||y>o||x>o){var w=e.vertices.length,M=c.clone(),S=c.clone();if(v>=y&&v>=x){if((A=d.clone()).lerp(f,.5),M.a=a,M.b=w,M.c=h,S.a=w,S.b=b,S.c=h,3===c.vertexNormals.length)(T=c.vertexNormals[0].clone()).lerp(c.vertexNormals[1],.5),M.vertexNormals[1].copy(T),S.vertexNormals[0].copy(T);if(3===c.vertexColors.length)(_=c.vertexColors[0].clone()).lerp(c.vertexColors[1],.5),M.vertexColors[1].copy(_),S.vertexColors[0].copy(_);t=0}else if(y>=v&&y>=x){if((A=f.clone()).lerp(m,.5),M.a=a,M.b=b,M.c=w,S.a=w,S.b=h,S.c=a,3===c.vertexNormals.length)(T=c.vertexNormals[1].clone()).lerp(c.vertexNormals[2],.5),M.vertexNormals[2].copy(T),S.vertexNormals[0].copy(T),S.vertexNormals[1].copy(c.vertexNormals[2]),S.vertexNormals[2].copy(c.vertexNormals[0]);if(3===c.vertexColors.length)(_=c.vertexColors[1].clone()).lerp(c.vertexColors[2],.5),M.vertexColors[2].copy(_),S.vertexColors[0].copy(_),S.vertexColors[1].copy(c.vertexColors[2]),S.vertexColors[2].copy(c.vertexColors[0]);t=1}else{var A,T,_;if((A=d.clone()).lerp(m,.5),M.a=a,M.b=b,M.c=w,S.a=w,S.b=b,S.c=h,3===c.vertexNormals.length)(T=c.vertexNormals[0].clone()).lerp(c.vertexNormals[2],.5),M.vertexNormals[2].copy(T),S.vertexNormals[0].copy(T);if(3===c.vertexColors.length)(_=c.vertexColors[0].clone()).lerp(c.vertexColors[2],.5),M.vertexColors[2].copy(_),S.vertexColors[0].copy(_);t=2}r.push(M,S),e.vertices.push(A);for(var L=0,C=e.faceVertexUvs.length;L<C;L++)if(e.faceVertexUvs[L].length){var N=e.faceVertexUvs[L][i],P=N[0],E=N[1],D=N[2];if(0===t){(O=P.clone()).lerp(E,.5);var F=[P.clone(),O.clone(),D.clone()],R=[O.clone(),E.clone(),D.clone()]}else if(1===t){(O=E.clone()).lerp(D,.5);F=[P.clone(),E.clone(),O.clone()],R=[O.clone(),D.clone(),P.clone()]}else{var O;(O=P.clone()).lerp(D,.5);F=[P.clone(),E.clone(),O.clone()],R=[O.clone(),E.clone(),D.clone()]}n[L].push(F,R)}}else{r.push(c);for(L=0,C=e.faceVertexUvs.length;L<C;L++)n[L].push(e.faceVertexUvs[L][i])}}}e.faces=r,e.faceVertexUvs=n};var MorphAnimMesh=function(e,t){Mesh.call(this,e,t),this.type="MorphAnimMesh",this.mixer=new AnimationMixer(this),this.activeAction=null};function Node$1(e){this.uuid=_Math.generateUUID(),this.name="",this.type=e,this.userData={}}function TempNode(e,t){Node$1.call(this,e),t=t||{},this.shared=void 0===t.shared||t.shared,this.unique=void 0!==t.unique&&t.unique}MorphAnimMesh.prototype=Object.create(Mesh.prototype),MorphAnimMesh.prototype.constructor=MorphAnimMesh,MorphAnimMesh.prototype.setDirectionForward=function(){this.mixer.timeScale=1},MorphAnimMesh.prototype.setDirectionBackward=function(){this.mixer.timeScale=-1},MorphAnimMesh.prototype.playAnimation=function(label,e){this.activeAction&&(this.activeAction.stop(),this.activeAction=null);var t=AnimationClip.findByName(this,label);if(!t)throw new Error("MorphAnimMesh: animations["+label+"] undefined in .playAnimation()");var r=this.mixer.clipAction(t);r.timeScale=t.tracks.length*e/t.duration,this.activeAction=r.play()},MorphAnimMesh.prototype.updateAnimation=function(e){this.mixer.update(e)},MorphAnimMesh.prototype.copy=function(source){return Mesh.prototype.copy.call(this,source),this.mixer=new AnimationMixer(this),this},Node$1.prototype={constructor:Node$1,isNode:!0,parse:function(e,t){t=t||{},e.parsing=!0,this.build(e.addFlow(t.slot,t.cache,t.context),"v4"),e.clearVertexNodeCode(),e.clearFragmentNodeCode(),e.removeFlow(),e.parsing=!1},parseAndBuildCode:function(e,output,t){return t=t||{},this.parse(e,t),this.buildCode(e,output,t)},buildCode:function(e,output,t){t=t||{};var data={result:this.build(e.addFlow(t.slot,t.cache,t.context),output)};return data.code=e.clearNodeCode(),e.removeFlow(),data},build:function(e,output,t){output=output||this.getType(e,output);var data=e.getNodeData(t||this);return e.parsing&&this.appendDepsNode(e,data,output),-1===e.nodes.indexOf(this)&&e.nodes.push(this),void 0!==this.updateFrame&&-1===e.updaters.indexOf(this)&&e.updaters.push(this),this.generate(e,output,t)},appendDepsNode:function(e,data,output){data.deps=(data.deps||0)+1;var t=e.getTypeLength(output);(t>(data.outputMax||0)||this.getType(e,output))&&(data.outputMax=t,data.output=output)},setName:function(e){return this.name=e,this},getName:function(e){return this.name},getType:function(e,output){return"sampler2D"===output||"samplerCube"===output?output:this.type},getJSONNode:function(meta){if(!(void 0===meta||"string"==typeof meta)&&void 0!==meta.nodes[this.uuid])return meta.nodes[this.uuid]},copy:function(source){void 0!==source.name&&(this.name=source.name),void 0!==source.userData&&(this.userData=JSON.parse(JSON.stringify(source.userData)))},createJSONNode:function(meta){var e=void 0===meta||"string"==typeof meta,data={};if("string"!=typeof this.nodeType)throw new Error("Node does not allow serialization.");return data.uuid=this.uuid,data.nodeType=this.nodeType,""!==this.name&&(data.name=this.name),"{}"!==JSON.stringify(this.userData)&&(data.userData=this.userData),e||(meta.nodes[this.uuid]=data),data},toJSON:function(meta){return this.getJSONNode(meta)||this.createJSONNode(meta)}},TempNode.prototype=Object.create(Node$1.prototype),TempNode.prototype.constructor=TempNode,TempNode.prototype.build=function(e,output,t,r){if(output=output||this.getType(e),this.getShared(e,output)){var n=this.getUnique(e,output);n&&void 0===this.constructor.uuid&&(this.constructor.uuid=_Math.generateUUID()),t=e.getUuid(t||this.getUuid(),!n);var data=e.getNodeData(t),o=data.output||this.getType(e);if(e.parsing)return(data.deps||0)>0||this.getLabel()?(this.appendDepsNode(e,data,output),this.generate(e,output,t)):Node$1.prototype.build.call(this,e,output,t);if(n)return data.name=data.name||Node$1.prototype.build.call(this,e,output,t),data.name;if(!(this.getLabel()||this.getShared(e,o)&&e.optimize&&1!==data.deps))return Node$1.prototype.build.call(this,e,output,t);t=this.getUuid(!1);var l=this.getTemp(e,t);if(l)return e.format(l,o,output);l=TempNode.prototype.generate.call(this,e,output,t,data.output,r);var code=this.generate(e,o,t);return e.addNodeCode(l+" = "+code+";"),e.format(l,o,output)}return Node$1.prototype.build.call(this,e,output,t)},TempNode.prototype.getShared=function(e,output){return"sampler2D"!==output&&"samplerCube"!==output&&this.shared},TempNode.prototype.getUnique=function(e,output){return this.unique},TempNode.prototype.setLabel=function(e){return this.label=e,this},TempNode.prototype.getLabel=function(e){return this.label},TempNode.prototype.getUuid=function(e){var t=(e||null==e)&&this.constructor.uuid||this.uuid;return"string"==typeof this.scope&&(t=this.scope+"-"+t),t},TempNode.prototype.getTemp=function(e,t){t=t||this.uuid;var r=e.getVars()[t];return r?r.name:void 0},TempNode.prototype.generate=function(e,output,t,r,n){return this.getShared(e,output)||console.error("TempNode is not shared!"),t=t||this.uuid,e.getTempVar(t,r||this.getType(e),n,this.getLabel()).name};var NodeLib={nodes:{},keywords:{},add:function(e){this.nodes[e.name]=e},addKeyword:function(e,t,r){r=void 0===r||r,this.keywords[e]={callback:t,cache:r}},remove:function(e){delete this.nodes[e.name]},removeKeyword:function(e){delete this.keywords[e]},get:function(e){return this.nodes[e]},getKeyword:function(e,t){return this.keywords[e].callback.call(this,t)},getKeywordData:function(e){return this.keywords[e]},contains:function(e){return null!=this.nodes[e]},containsKeyword:function(e){return null!=this.keywords[e]}},declarationRegexp=/^([a-z_0-9]+)\s([a-z_0-9]+)\s*\((.*?)\)/i,propertiesRegexp=/[a-z_0-9]+/gi;function FunctionNode(e,t,r,n,o){this.isMethod=void 0===o,TempNode.call(this,o),this.eval(e,t,r,n)}function InputNode(e,t){(t=t||{}).shared=void 0!==t.shared&&t.shared,TempNode.call(this,e,t),this.readonly=!1}function FloatNode(e){InputNode.call(this,"f"),this.value=e||0}function PositionNode(e){TempNode.call(this,"v3"),this.scope=e||PositionNode.LOCAL}function CameraNode(e,t){TempNode.call(this,"v3"),this.setScope(e||CameraNode.POSITION),this.setCamera(t)}FunctionNode.prototype=Object.create(TempNode.prototype),FunctionNode.prototype.constructor=FunctionNode,FunctionNode.prototype.nodeType="Function",FunctionNode.prototype.useKeywords=!0,FunctionNode.prototype.getShared=function(e,output){return!this.isMethod},FunctionNode.prototype.getType=function(e){return e.getTypeByFormat(this.type)},FunctionNode.prototype.getInputByName=function(e){for(var i=this.inputs.length;i--;)if(this.inputs[i].name===e)return this.inputs[i]},FunctionNode.prototype.getIncludeByName=function(e){for(var i=this.includes.length;i--;)if(this.includes[i].name===e)return this.includes[i]},FunctionNode.prototype.generate=function(e,output){for(var t,r=0,n=this.src,i=0;i<this.includes.length;i++)e.include(this.includes[i],this);for(var o in this.extensions)e.extensions[o]=!0;for(;t=propertiesRegexp.exec(this.src);){var l=t[0],c=!this.isMethod||!this.getInputByName(l),h=l;if(this.keywords[l]||this.useKeywords&&c&&NodeLib.containsKeyword(l)){var d=this.keywords[l];if(!d){var f=NodeLib.getKeywordData(l);f.cache&&(d=e.keywords[l]),d=d||NodeLib.getKeyword(l,e),f.cache&&(e.keywords[l]=d)}h=d.build(e)}l!=h&&(n=n.substring(0,t.index+r)+h+n.substring(t.index+l.length+r),r+=h.length-l.length),void 0===this.getIncludeByName(h)&&NodeLib.contains(h)&&e.include(NodeLib.get(h))}return"source"===output?n:this.isMethod?(e.include(this,!1,n),this.name):e.format("( "+n+" )",this.getType(e),output)},FunctionNode.prototype.eval=function(e,t,r,n){if(this.src=e||"",this.includes=t||[],this.extensions=r||{},this.keywords=n||{},this.isMethod){var o=this.src.match(declarationRegexp);if(this.inputs=[],o&&4==o.length){this.type=o[1],this.name=o[2];var l=o[3].match(propertiesRegexp);if(l)for(var i=0;i<l.length;){var c,h,d=l[i++];"in"==d||"out"==d||"inout"==d?c=l[i++]:(c=d,d=""),h=l[i++],this.inputs.push({name:h,type:c,qualifier:d})}}else this.type="",this.name=""}},FunctionNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.isMethod=source.isMethod,this.useKeywords=source.useKeywords,this.eval(source.src,source.includes,source.extensions,source.keywords),void 0!==source.type&&(this.type=source.type)},FunctionNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);if(!data){for(var e in(data=this.createJSONNode(meta)).src=this.src,data.isMethod=this.isMethod,data.useKeywords=this.useKeywords,this.isMethod||(data.type=this.type),data.extensions=JSON.parse(JSON.stringify(this.extensions)),data.keywords={},this.keywords)data.keywords[e]=this.keywords[e].toJSON(meta).uuid;if(this.includes.length){data.includes=[];for(var i=0;i<this.includes.length;i++)data.includes.push(this.includes[i].toJSON(meta).uuid)}}return data},InputNode.prototype=Object.create(TempNode.prototype),InputNode.prototype.constructor=InputNode,InputNode.prototype.setReadonly=function(e){return this.readonly=e,this},InputNode.prototype.getReadonly=function(e){return this.readonly},InputNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),void 0!==source.readonly&&(this.readonly=source.readonly)},InputNode.prototype.createJSONNode=function(meta){var data=TempNode.prototype.createJSONNode.call(this,meta);return!0===this.readonly&&(data.readonly=this.readonly),data},InputNode.prototype.generate=function(e,output,t,r,n,o){t=e.getUuid(t||this.getUuid()),r=r||this.getType(e);var data=e.getNodeData(t);return this.getReadonly(e)&&void 0!==this.generateReadonly?this.generateReadonly(e,output,t,r,n,o):e.isShader("vertex")?(data.vertex||(data.vertex=e.createVertexUniform(r,this,n,o,this.getLabel())),e.format(data.vertex.name,r,output)):(data.fragment||(data.fragment=e.createFragmentUniform(r,this,n,o,this.getLabel())),e.format(data.fragment.name,r,output))},FloatNode.prototype=Object.create(InputNode.prototype),FloatNode.prototype.constructor=FloatNode,FloatNode.prototype.nodeType="Float",FloatNode.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format(this.value+(this.value%1?"":".0"),r,output)},FloatNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value=source.value},FloatNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value,!0===this.readonly&&(data.readonly=!0)),data},PositionNode.LOCAL="local",PositionNode.WORLD="world",PositionNode.VIEW="view",PositionNode.PROJECTION="projection",PositionNode.prototype=Object.create(TempNode.prototype),PositionNode.prototype.constructor=PositionNode,PositionNode.prototype.nodeType="Position",PositionNode.prototype.getType=function(){switch(this.scope){case PositionNode.PROJECTION:return"v4"}return this.type},PositionNode.prototype.getShared=function(e){switch(this.scope){case PositionNode.LOCAL:case PositionNode.WORLD:return!1}return!0},PositionNode.prototype.generate=function(e,output){var t;switch(this.scope){case PositionNode.LOCAL:e.requires.position=!0,t=e.isShader("vertex")?"transformed":"vPosition";break;case PositionNode.WORLD:e.requires.worldPosition=!0,t="vWPosition";break;case PositionNode.VIEW:t=e.isShader("vertex")?"-mvPosition.xyz":"vViewPosition";break;case PositionNode.PROJECTION:t=e.isShader("vertex")?"( projectionMatrix * modelViewMatrix * vec4( position, 1.0 ) )":"vec4( 0.0 )"}return e.format(t,this.getType(e),output)},PositionNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.scope=source.scope},PositionNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).scope=this.scope),data},NodeLib.addKeyword("position",(function(){return new PositionNode})),NodeLib.addKeyword("worldPosition",(function(){return new PositionNode(PositionNode.WORLD)})),NodeLib.addKeyword("viewPosition",(function(){return new PositionNode(NormalNode.VIEW)})),CameraNode.Nodes={depthColor:new FunctionNode(["float depthColor( float mNear, float mFar ) {","\t#ifdef USE_LOGDEPTHBUF_EXT","\t\tfloat depth = gl_FragDepthEXT / gl_FragCoord.w;","\t#else","\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;","\t#endif","\treturn 1.0 - smoothstep( mNear, mFar, depth );","}"].join("\n"))},CameraNode.POSITION="position",CameraNode.DEPTH="depth",CameraNode.TO_VERTEX="toVertex",CameraNode.prototype=Object.create(TempNode.prototype),CameraNode.prototype.constructor=CameraNode,CameraNode.prototype.nodeType="Camera",CameraNode.prototype.setCamera=function(e){this.camera=e,this.updateFrame=void 0!==e?this.onUpdateFrame:void 0},CameraNode.prototype.setScope=function(e){switch(this.scope){case CameraNode.DEPTH:delete this.near,delete this.far}switch(this.scope=e,e){case CameraNode.DEPTH:var t=this.camera;this.near=new FloatNode(t?t.near:1),this.far=new FloatNode(t?t.far:1200)}},CameraNode.prototype.getType=function(e){switch(this.scope){case CameraNode.DEPTH:return"f"}return this.type},CameraNode.prototype.getUnique=function(e){switch(this.scope){case CameraNode.DEPTH:case CameraNode.TO_VERTEX:return!0}return!1},CameraNode.prototype.getShared=function(e){switch(this.scope){case CameraNode.POSITION:return!1}return!0},CameraNode.prototype.generate=function(e,output){var t;switch(this.scope){case CameraNode.POSITION:t="cameraPosition";break;case CameraNode.DEPTH:t=e.include(CameraNode.Nodes.depthColor)+"( "+this.near.build(e,"f")+", "+this.far.build(e,"f")+" )";break;case CameraNode.TO_VERTEX:t="normalize( "+new PositionNode(PositionNode.WORLD).build(e,"v3")+" - cameraPosition )"}return e.format(t,this.getType(e),output)},CameraNode.prototype.onUpdateFrame=function(e){switch(this.scope){case CameraNode.DEPTH:var t=this.camera;this.near.value=t.near,this.far.value=t.far}},CameraNode.prototype.copy=function(source){switch(TempNode.prototype.copy.call(this,source),this.setScope(source.scope),source.camera&&this.setCamera(source.camera),source.scope){case CameraNode.DEPTH:this.near.number=source.near,this.far.number=source.far}},CameraNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);if(!data)switch((data=this.createJSONNode(meta)).scope=this.scope,this.camera&&(data.camera=this.camera.uuid),this.scope){case CameraNode.DEPTH:data.near=this.near.value,data.far=this.far.value}return data};var vertexDict=["color","color2"],fragmentDict=["vColor","vColor2"];function ColorsNode(e){TempNode.call(this,"v4",{shared:!1}),this.index=e||0}function LightNode(e){TempNode.call(this,"v3",{shared:!1}),this.scope=e||LightNode.TOTAL}function NormalNode$1(e){TempNode.call(this,"v3"),this.scope=e||NormalNode$1.LOCAL}function ReflectNode(e){TempNode.call(this,"v3",{unique:!0}),this.scope=e||ReflectNode.CUBE}ColorsNode.prototype=Object.create(TempNode.prototype),ColorsNode.prototype.constructor=ColorsNode,ColorsNode.prototype.generate=function(e,output){e.requires.color[this.index]=!0;var t=e.isShader("vertex")?vertexDict[this.index]:fragmentDict[this.index];return e.format(t,this.getType(e),output)},ColorsNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.index=source.index},ColorsNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).index=this.index),data},LightNode.TOTAL="total",LightNode.prototype=Object.create(TempNode.prototype),LightNode.prototype.constructor=LightNode,LightNode.prototype.nodeType="Light",LightNode.prototype.generate=function(e,output){return e.isCache("light")?e.format("reflectedLight.directDiffuse",this.type,output):(console.warn('LightNode is only compatible in "light" channel.'),e.format("vec3( 0.0 )",this.type,output))},LightNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.scope=source.scope},LightNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).scope=this.scope),data},NormalNode$1.LOCAL="local",NormalNode$1.WORLD="world",NormalNode$1.VIEW="view",NormalNode$1.prototype=Object.create(TempNode.prototype),NormalNode$1.prototype.constructor=NormalNode$1,NormalNode$1.prototype.nodeType="Normal",NormalNode$1.prototype.getShared=function(e){switch(this.scope){case NormalNode$1.WORLD:return!0}return!1},NormalNode$1.prototype.generate=function(e,output){var t;switch(this.scope){case NormalNode$1.LOCAL:e.requires.normal=!0,t="normal";break;case NormalNode$1.WORLD:e.requires.worldNormal=!0,t=e.isShader("vertex")?"( modelMatrix * vec4( objectNormal, 0.0 ) ).xyz":"vWNormal";break;case NormalNode$1.VIEW:t="vNormal"}return e.format(t,this.getType(e),output)},NormalNode$1.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.scope=source.scope},NormalNode$1.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).scope=this.scope),data},NodeLib.addKeyword("normal",(function(){return new NormalNode$1})),NodeLib.addKeyword("worldNormal",(function(){return new NormalNode$1(NormalNode$1.WORLD)})),NodeLib.addKeyword("viewNormal",(function(){return new NormalNode$1(NormalNode$1.VIEW)})),ReflectNode.CUBE="cube",ReflectNode.SPHERE="sphere",ReflectNode.VECTOR="vector",ReflectNode.prototype=Object.create(TempNode.prototype),ReflectNode.prototype.constructor=ReflectNode,ReflectNode.prototype.nodeType="Reflect",ReflectNode.prototype.getType=function(e){switch(this.scope){case ReflectNode.SPHERE:return"v2"}return this.type},ReflectNode.prototype.generate=function(e,output){if(e.isShader("fragment")){var t;switch(this.scope){case ReflectNode.VECTOR:e.addNodeCode("vec3 reflectVec = inverseTransformDirection( reflect( -normalize( vViewPosition ), normal ), viewMatrix );"),t="reflectVec";break;case ReflectNode.CUBE:var r=new ReflectNode(ReflectNode.VECTOR).build(e,"v3");e.addNodeCode("vec3 reflectCubeVec = vec3( -1.0 * "+r+".x, "+r+".yz );"),t="reflectCubeVec";break;case ReflectNode.SPHERE:r=new ReflectNode(ReflectNode.VECTOR).build(e,"v3");e.addNodeCode("vec2 reflectSphereVec = normalize( ( viewMatrix * vec4( "+r+", 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) ).xy * 0.5 + 0.5;"),t="reflectSphereVec"}return e.format(t,this.getType(e),output)}return console.warn("ReflectNode is not compatible with "+e.shader+" shader."),e.format("vec3( 0.0 )",this.type,output)},ReflectNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).scope=this.scope),data};var NodeUtils={elements:["x","y","z","w"],addShortcuts:function(){function e(e,t,r){return r?{get:function(){return this[e][t][r]},set:function(n){this[e][t][r]=n}}:{get:function(){return this[e][t]},set:function(r){this[e][t]=r}}}return function(t,r,n){for(var o={},i=0;i<n.length;++i){var data=n[i].split("."),l=data[0],c=data[1];o[l]=e(r,l,c)}Object.defineProperties(t,o)}}()};function Vector2Node(e,t){InputNode.call(this,"v2"),this.value=e instanceof Vector2?e:new Vector2(e,t)}function ResolutionNode(){Vector2Node.call(this)}function ScreenUVNode(e){TempNode.call(this,"v2"),this.resolution=e||new ResolutionNode}Vector2Node.prototype=Object.create(InputNode.prototype),Vector2Node.prototype.constructor=Vector2Node,Vector2Node.prototype.nodeType="Vector2",NodeUtils.addShortcuts(Vector2Node.prototype,"value",["x","y"]),Vector2Node.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("vec2( "+this.x+", "+this.y+" )",r,output)},Vector2Node.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value.copy(source)},Vector2Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).x=this.x,data.y=this.y,!0===this.readonly&&(data.readonly=!0)),data},ResolutionNode.prototype=Object.create(Vector2Node.prototype),ResolutionNode.prototype.constructor=ResolutionNode,ResolutionNode.prototype.nodeType="Resolution",ResolutionNode.prototype.updateFrame=function(e){if(e.renderer){var t=e.renderer.getSize(),r=e.renderer.getPixelRatio();this.x=t.width*r,this.y=t.height*r}else console.warn("ResolutionNode need a renderer in NodeFrame")},ResolutionNode.prototype.copy=function(source){Vector2Node.prototype.copy.call(this,source),this.renderer=source.renderer},ResolutionNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).renderer=this.renderer.uuid),data},ScreenUVNode.prototype=Object.create(TempNode.prototype),ScreenUVNode.prototype.constructor=ScreenUVNode,ScreenUVNode.prototype.nodeType="ScreenUV",ScreenUVNode.prototype.generate=function(e,output){var t;return e.isShader("fragment")?t="( gl_FragCoord.xy / "+this.resolution.build(e,"v2")+")":(console.warn("ScreenUVNode is not compatible with "+e.shader+" shader."),t="vec2( 0.0 )"),e.format(t,this.getType(e),output)},ScreenUVNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.resolution=source.resolution},ScreenUVNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).resolution=this.resolution.toJSON(meta).uuid),data};var vertexDict$1=["uv","uv2"],fragmentDict$1=["vUv","vUv2"];function UVNode(e){TempNode.call(this,"v2",{shared:!1}),this.index=e||0}function BlinnShininessExponentNode(){TempNode.call(this,"f")}function BlinnExponentToRoughnessNode(e){TempNode.call(this,"f"),this.blinnExponent=e||new BlinnShininessExponentNode}function MaxMIPLevelNode(e){FloatNode.call(this),this.texture=e,this.maxMIPLevel=0}function RoughnessToBlinnExponentNode(e){TempNode.call(this,"f"),this.texture=e,this.maxMIPLevel=new MaxMIPLevelNode(e),this.blinnShininessExponent=new BlinnShininessExponentNode}function AttributeNode(e,t){Node$1.call(this,t),this.name=e}UVNode.prototype=Object.create(TempNode.prototype),UVNode.prototype.constructor=UVNode,UVNode.prototype.nodeType="UV",UVNode.prototype.generate=function(e,output){e.requires.uv[this.index]=!0;var t=e.isShader("vertex")?vertexDict$1[this.index]:fragmentDict$1[this.index];return e.format(t,this.getType(e),output)},UVNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.index=source.index},UVNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).index=this.index),data},NodeLib.addKeyword("uv",(function(){return new UVNode})),NodeLib.addKeyword("uv2",(function(){return new UVNode(1)})),BlinnShininessExponentNode.prototype=Object.create(TempNode.prototype),BlinnShininessExponentNode.prototype.constructor=BlinnShininessExponentNode,BlinnShininessExponentNode.prototype.nodeType="BlinnShininessExponent",BlinnShininessExponentNode.prototype.generate=function(e,output){return e.isCache("clearCoat")?e.format("Material_ClearCoat_BlinnShininessExponent( material )",this.type,output):e.format("Material_BlinnShininessExponent( material )",this.type,output)},BlinnExponentToRoughnessNode.prototype=Object.create(TempNode.prototype),BlinnExponentToRoughnessNode.prototype.constructor=BlinnExponentToRoughnessNode,BlinnExponentToRoughnessNode.prototype.nodeType="BlinnExponentToRoughness",BlinnExponentToRoughnessNode.prototype.generate=function(e,output){return e.format("BlinnExponentToGGXRoughness( "+this.blinnExponent.build(e,"f")+" )",this.type,output)},BlinnExponentToRoughnessNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.blinnExponent=source.blinnExponent},BlinnExponentToRoughnessNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).blinnExponent=this.blinnExponent),data},MaxMIPLevelNode.prototype=Object.create(FloatNode.prototype),MaxMIPLevelNode.prototype.constructor=MaxMIPLevelNode,MaxMIPLevelNode.prototype.nodeType="MaxMIPLevel",Object.defineProperties(MaxMIPLevelNode.prototype,{value:{get:function(){if(0===this.maxMIPLevel){var image=this.texture.value.image?this.texture.value.image[0]:void 0;this.maxMIPLevel=void 0!==image?Math.log(Math.max(image.width,image.height))*Math.LOG2E:0}return this.maxMIPLevel},set:function(){}}}),MaxMIPLevelNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).texture=this.texture.uuid),data},RoughnessToBlinnExponentNode.Nodes={getSpecularMIPLevel:new FunctionNode(["float getSpecularMIPLevel( const in float blinnShininessExponent, const in float maxMIPLevelScalar ) {","\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );","\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );","}"].join("\n"))},RoughnessToBlinnExponentNode.prototype=Object.create(TempNode.prototype),RoughnessToBlinnExponentNode.prototype.constructor=RoughnessToBlinnExponentNode,RoughnessToBlinnExponentNode.prototype.nodeType="RoughnessToBlinnExponent",RoughnessToBlinnExponentNode.prototype.generate=function(e,output){if(e.isShader("fragment")){this.maxMIPLevel.texture=this.texture;var t=e.include(RoughnessToBlinnExponentNode.Nodes.getSpecularMIPLevel);return e.format(t+"( "+this.blinnShininessExponent.build(e,"f")+", "+this.maxMIPLevel.build(e,"f")+" )",this.type,output)}return console.warn("RoughnessToBlinnExponentNode is not compatible with "+e.shader+" shader."),e.format("0.0",this.type,output)},RoughnessToBlinnExponentNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.texture=source.texture},RoughnessToBlinnExponentNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).texture=this.texture),data},AttributeNode.prototype=Object.create(Node$1.prototype),AttributeNode.prototype.constructor=AttributeNode,AttributeNode.prototype.nodeType="Attribute",AttributeNode.prototype.getAttributeType=function(e){return"number"==typeof this.type?e.getConstructorFromLength(this.type):this.type},AttributeNode.prototype.getType=function(e){var t=this.getAttributeType(e);return e.getTypeByFormat(t)},AttributeNode.prototype.generate=function(e,output){var t=this.getAttributeType(e),r=e.getAttribute(this.name,t),n=e.isShader("vertex")?this.name:r.varying.name;return console.log(r),e.format(n,this.getType(e),output)},AttributeNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),this.type=source.type},AttributeNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).type=this.type),data};var declarationRegexp$1=/^([a-z_0-9]+)\s([a-z_0-9]+)\s?\=?\s?(.*?)(\;|$)/i;function ConstNode(e,t){TempNode.call(this),this.eval(e||ConstNode.PI,t)}function ExpressionNode(e,t,r,n,o){FunctionNode.call(this,e,o,n,r,t)}function FunctionCallNode(e,t){TempNode.call(this),this.setFunction(e,t)}function NodeUniform(e){e=e||{},this.name=e.name,this.type=e.type,this.node=e.node,this.needsUpdate=e.needsUpdate}ConstNode.PI="PI",ConstNode.PI2="PI2",ConstNode.RECIPROCAL_PI="RECIPROCAL_PI",ConstNode.RECIPROCAL_PI2="RECIPROCAL_PI2",ConstNode.LOG2="LOG2",ConstNode.EPSILON="EPSILON",ConstNode.prototype=Object.create(TempNode.prototype),ConstNode.prototype.constructor=ConstNode,ConstNode.prototype.nodeType="Const",ConstNode.prototype.getType=function(e){return e.getTypeByFormat(this.type)},ConstNode.prototype.eval=function(e,t){this.src=e||"";var r,n,o="",l=this.src.match(declarationRegexp$1);this.useDefine=t||"#"===this.src.charAt(0),l&&l.length>1?(n=l[1],r=l[2],o=l[3]):(r=this.src,n="f"),this.name=r,this.type=n,this.value=o},ConstNode.prototype.build=function(e,output){return"source"!==output?(e.include(this),e.format(this.name,this.getType(e),output)):this.value?this.useDefine?"#define "+this.name+" "+this.value:"const "+this.type+" "+this.name+" = "+this.value+";":this.useDefine?this.src:void 0},ConstNode.prototype.generate=function(e,output){return e.format(this.name,this.getType(e),output)},ConstNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.eval(source.src,source.useDefine)},ConstNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).src=this.src,!0===data.useDefine&&(data.useDefine=!0)),data},ExpressionNode.prototype=Object.create(FunctionNode.prototype),ExpressionNode.prototype.constructor=ExpressionNode,ExpressionNode.prototype.nodeType="Expression",FunctionCallNode.prototype=Object.create(TempNode.prototype),FunctionCallNode.prototype.constructor=FunctionCallNode,FunctionCallNode.prototype.nodeType="FunctionCall",FunctionCallNode.prototype.setFunction=function(e,t){this.value=e,this.inputs=t||[]},FunctionCallNode.prototype.getFunction=function(){return this.value},FunctionCallNode.prototype.getType=function(e){return this.value.getType(e)},FunctionCallNode.prototype.generate=function(e,output){for(var t=this.getType(e),r=this.value,code=r.build(e,output)+"( ",n=[],i=0;i<r.inputs.length;i++){var o=r.inputs[i],param=this.inputs[i]||this.inputs[o.name];n.push(param.build(e,e.getTypeByFormat(o.type)))}return code+=n.join(", ")+" )",e.format(code,t,output)},FunctionCallNode.prototype.copy=function(source){for(var e in TempNode.prototype.copy.call(this,source),source.inputs)this.inputs[e]=source.inputs[e];this.value=source.value},FunctionCallNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);if(!data){var e=this.value;if((data=this.createJSONNode(meta)).value=this.value.toJSON(meta).uuid,e.inputs.length){data.inputs={};for(var i=0;i<e.inputs.length;i++){var t=e.inputs[i],r=this.inputs[i]||this.inputs[t.name];data.inputs[t.name]=r.toJSON(meta).uuid}}}return data},Object.defineProperties(NodeUniform.prototype,{value:{get:function(){return this.node.value},set:function(e){this.node.value=e}}});var declarationRegexp$2=/^struct\s*([a-z_0-9]+)\s*{\s*((.|\n)*?)}/gim,propertiesRegexp$1=/\s*(\w*?)\s*(\w*?)(\=|\;)/gim,LinearToLinear,GammaToLinear,LinearToGamma,sRGBToLinear,LinearTosRGB,RGBEToLinear,LinearToRGBE,RGBMToLinear,LinearToRGBM,RGBDToLinear,LinearToRGBD,cLogLuvM,LinearToLogLuv,cLogLuvInverseM,TextureCubeUVData,getFaceFromDirection,cubeUV_maxLods1,cubeUV_rangeClamp,MipLevelInfo,cubeUV_maxLods2,cubeUV_rcpTextureSize,getCubeUV,cubeUV_maxLods3;function StructNode(e){TempNode.call(this),this.eval(e)}function Vector3Node(e,t,r){InputNode.call(this,"v3"),this.value=e instanceof Vector3?e:new Vector3(e,t,r)}function Vector4Node(e,t,r,n){InputNode.call(this,"v4"),this.value=e instanceof Vector4?e:new Vector4(e,t,r,n)}function ColorSpaceNode(input,e){TempNode.call(this,"v4"),this.input=input,this.method=e||ColorSpaceNode.LINEAR}function TextureNode(e,t,r,n){InputNode.call(this,"v4",{shared:!0}),this.value=e,this.uv=t||new UVNode,this.bias=r,this.project=void 0!==n&&n}function CubeTextureNode(e,t,r){InputNode.call(this,"v4",{shared:!0}),this.value=e,this.uv=t||new ReflectNode,this.bias=r}function TextureCubeUVNode(e,t,r){TempNode.call(this,"TextureCubeUVData"),this.uv=e||new ReflectNode(ReflectNode.VECTOR),this.textureSize=t||new FloatNode(1024),this.blinnExponentToRoughness=r||new BlinnExponentToRoughnessNode}function TextureCubeNode(e,t){TempNode.call(this,"v4"),this.value=e,this.uv=t||new TextureCubeUVNode}StructNode.prototype=Object.create(TempNode.prototype),StructNode.prototype.constructor=StructNode,StructNode.prototype.nodeType="Struct",StructNode.prototype.getType=function(e){return e.getTypeByFormat(this.name)},StructNode.prototype.getInputByName=function(e){for(var i=this.inputs.length;i--;)if(this.inputs[i].name===e)return this.inputs[i]},StructNode.prototype.generate=function(e,output){return"source"===output?this.src+";":e.format("( "+this.src+" )",this.getType(e),output)},StructNode.prototype.eval=function(e){this.src=e||"",this.inputs=[];var t=declarationRegexp$2.exec(this.src);if(t){for(var r,n=t[2];r=propertiesRegexp$1.exec(n);)this.inputs.push({type:r[1],name:r[2]});this.name=t[1]}else this.name="";this.type=this.name},StructNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).src=this.src),data},Vector3Node.prototype=Object.create(InputNode.prototype),Vector3Node.prototype.constructor=Vector3Node,Vector3Node.prototype.nodeType="Vector3",NodeUtils.addShortcuts(Vector3Node.prototype,"value",["x","y","z"]),Vector3Node.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("vec3( "+this.x+", "+this.y+", "+this.z+" )",r,output)},Vector3Node.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value.copy(source)},Vector3Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).x=this.x,data.y=this.y,data.z=this.z,!0===this.readonly&&(data.readonly=!0)),data},Vector4Node.prototype=Object.create(InputNode.prototype),Vector4Node.prototype.constructor=Vector4Node,Vector4Node.prototype.nodeType="Vector4",NodeUtils.addShortcuts(Vector4Node.prototype,"value",["x","y","z","w"]),Vector4Node.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("vec4( "+this.x+", "+this.y+", "+this.z+", "+this.w+" )",r,output)},Vector4Node.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value.copy(source)},Vector4Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).x=this.x,data.y=this.y,data.z=this.z,data.w=this.w,!0===this.readonly&&(data.readonly=!0)),data},ColorSpaceNode.Nodes=(LinearToLinear=new FunctionNode(["vec4 LinearToLinear( in vec4 value ) {","\treturn value;","}"].join("\n")),GammaToLinear=new FunctionNode(["vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {","\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );","}"].join("\n")),LinearToGamma=new FunctionNode(["vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {","\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );","}"].join("\n")),sRGBToLinear=new FunctionNode(["vec4 sRGBToLinear( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );","}"].join("\n")),LinearTosRGB=new FunctionNode(["vec4 LinearTosRGB( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );","}"].join("\n")),RGBEToLinear=new FunctionNode(["vec4 RGBEToLinear( in vec4 value ) {","\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );","}"].join("\n")),LinearToRGBE=new FunctionNode(["vec4 LinearToRGBE( in vec4 value ) {","\tfloat maxComponent = max( max( value.r, value.g ), value.b );","\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );","\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );","}"].join("\n")),RGBMToLinear=new FunctionNode(["vec3 RGBMToLinear( in vec4 value, in float maxRange ) {","\treturn vec4( value.xyz * value.w * maxRange, 1.0 );","}"].join("\n")),LinearToRGBM=new FunctionNode(["vec3 LinearToRGBM( in vec4 value, in float maxRange ) {","\tfloat maxRGB = max( value.x, max( value.g, value.b ) );","\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );","\tM            = ceil( M * 255.0 ) / 255.0;","\treturn vec4( value.rgb / ( M * maxRange ), M );","}"].join("\n")),RGBDToLinear=new FunctionNode(["vec3 RGBDToLinear( in vec4 value, in float maxRange ) {","\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );","}"].join("\n")),LinearToRGBD=new FunctionNode(["vec3 LinearToRGBD( in vec4 value, in float maxRange ) {","\tfloat maxRGB = max( value.x, max( value.g, value.b ) );","\tfloat D      = max( maxRange / maxRGB, 1.0 );","\tD            = min( floor( D ) / 255.0, 1.0 );","\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );","}"].join("\n")),cLogLuvM=new ConstNode("const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );"),LinearToLogLuv=new FunctionNode(["vec4 LinearToLogLuv( in vec4 value ) {","\tvec3 Xp_Y_XYZp = cLogLuvM * value.rgb;","\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));","\tvec4 vResult;","\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;","\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;","\tvResult.w = fract(Le);","\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;","\treturn vResult;","}"].join("\n"),[cLogLuvM]),cLogLuvInverseM=new ConstNode("const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );"),{LinearToLinear:LinearToLinear,GammaToLinear:GammaToLinear,LinearToGamma:LinearToGamma,sRGBToLinear:sRGBToLinear,LinearTosRGB:LinearTosRGB,RGBEToLinear:RGBEToLinear,LinearToRGBE:LinearToRGBE,RGBMToLinear:RGBMToLinear,LinearToRGBM:LinearToRGBM,RGBDToLinear:RGBDToLinear,LinearToRGBD:LinearToRGBD,cLogLuvM:cLogLuvM,LinearToLogLuv:LinearToLogLuv,cLogLuvInverseM:cLogLuvInverseM,LogLuvToLinear:new FunctionNode(["vec4 LogLuvToLinear( in vec4 value ) {","\tfloat Le = value.z * 255.0 + value.w;","\tvec3 Xp_Y_XYZp;","\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);","\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;","\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;","\tvec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;","\treturn vec4( max(vRGB, 0.0), 1.0 );","}"].join("\n"),[cLogLuvInverseM])}),ColorSpaceNode.LINEAR_TO_LINEAR="LinearToLinear",ColorSpaceNode.GAMMA_TO_LINEAR="GammaToLinear",ColorSpaceNode.LINEAR_TO_GAMMA="LinearToGamma",ColorSpaceNode.SRGB_TO_LINEAR="sRGBToLinear",ColorSpaceNode.LINEAR_TO_SRGB="LinearTosRGB",ColorSpaceNode.RGBE_TO_LINEAR="RGBEToLinear",ColorSpaceNode.LINEAR_TO_RGBE="LinearToRGBE",ColorSpaceNode.RGBM_TO_LINEAR="RGBMToLinear",ColorSpaceNode.LINEAR_TO_RGBM="LinearToRGBM",ColorSpaceNode.RGBD_TO_LINEAR="RGBDToLinear",ColorSpaceNode.LINEAR_TO_RGBD="LinearToRGBD",ColorSpaceNode.LINEAR_TO_LOG_LUV="LinearToLogLuv",ColorSpaceNode.LOG_LUV_TO_LINEAR="LogLuvToLinear",ColorSpaceNode.prototype=Object.create(TempNode.prototype),ColorSpaceNode.prototype.constructor=ColorSpaceNode,ColorSpaceNode.prototype.nodeType="ColorAdjustment",ColorSpaceNode.prototype.generate=function(e,output){var input=e.context.input||this.input.build(e,"v4"),t=void 0!==e.context.encoding?this.getEncodingMethod(e.context.encoding):[this.method],r=this.factor?this.factor.build(e,"f"):t[1],n=e.include(ColorSpaceNode.Nodes[t[0]]);return r?e.format(n+"( "+input+", "+r+" )",this.getType(e),output):e.format(n+"( "+input+" )",this.getType(e),output)},ColorSpaceNode.prototype.getDecodingMethod=function(e){var t=this.getEncodingComponents(e);return t[0]+="ToLinear",t},ColorSpaceNode.prototype.getEncodingMethod=function(e){var t=this.getEncodingComponents(e);return t[0]="LinearTo"+t[0],t},ColorSpaceNode.prototype.getEncodingComponents=function(e){switch(e){case LinearEncoding:return["Linear"];case sRGBEncoding:return["sRGB"];case RGBEEncoding:return["RGBE"];case RGBM7Encoding:return["RGBM","7.0"];case RGBM16Encoding:return["RGBM","16.0"];case RGBDEncoding:return["RGBD","256.0"];case GammaEncoding:return["Gamma","float( GAMMA_FACTOR )"]}},ColorSpaceNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.input=source.input,this.method=source.method},ColorSpaceNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).input=this.input.toJSON(meta).uuid,data.method=this.method),data},TextureNode.prototype=Object.create(InputNode.prototype),TextureNode.prototype.constructor=TextureNode,TextureNode.prototype.nodeType="Texture",TextureNode.prototype.getTexture=function(e,output){return InputNode.prototype.generate.call(this,e,output,this.value.uuid,"t")},TextureNode.prototype.generate=function(e,output){if("sampler2D"===output)return this.getTexture(e,output);var t,code,r=this.getTexture(e,output),n=this.uv.build(e,this.project?"v4":"v2"),o=this.bias?this.bias.build(e,"f"):void 0;return null==o&&e.context.bias&&(o=new e.context.bias(this).build(e,"f")),t=this.project?"texture2DProj":o?"tex2DBias":"tex2D",code=o?t+"( "+r+", "+n+", "+o+" )":t+"( "+r+", "+n+" )",e.addContext({input:code,encoding:e.getTextureEncodingFromMap(this.value),include:e.isShader("vertex")}),this.colorSpace=this.colorSpace||new ColorSpaceNode(this),code=this.colorSpace.build(e,this.type),e.removeContext(),e.format(code,this.type,output)},TextureNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),source.value&&(this.value=source.value),this.uv=source.uv,source.bias&&(this.bias=source.bias),void 0!==source.project&&(this.project=source.project)},TextureNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),this.value&&(data.value=this.value.uuid),data.uv=this.uv.toJSON(meta).uuid,data.project=this.project,this.bias&&(data.bias=this.bias.toJSON(meta).uuid)),data},CubeTextureNode.prototype=Object.create(InputNode.prototype),CubeTextureNode.prototype.constructor=CubeTextureNode,CubeTextureNode.prototype.nodeType="CubeTexture",CubeTextureNode.prototype.getTexture=function(e,output){return InputNode.prototype.generate.call(this,e,output,this.value.uuid,"tc")},CubeTextureNode.prototype.generate=function(e,output){if("samplerCube"===output)return this.getTexture(e,output);var code,t=this.getTexture(e,output),r=this.uv.build(e,"v3"),n=this.bias?this.bias.build(e,"f"):void 0;return void 0===n&&e.context.bias&&(n=new e.context.bias(this).build(e,"f")),code=n?"texCubeBias( "+t+", "+r+", "+n+" )":"texCube( "+t+", "+r+" )",e.addContext({input:code,encoding:e.getTextureEncodingFromMap(this.value),include:e.isShader("vertex")}),this.colorSpace=this.colorSpace||new ColorSpaceNode(this),code=this.colorSpace.build(e,this.type),e.removeContext(),e.format(code,this.type,output)},CubeTextureNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),source.value&&(this.value=source.value),this.uv=source.uv,source.bias&&(this.bias=source.bias)},CubeTextureNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value.uuid,data.uv=this.uv.toJSON(meta).uuid,this.bias&&(data.bias=this.bias.toJSON(meta).uuid)),data},TextureCubeUVNode.Nodes=(TextureCubeUVData=new StructNode(["struct TextureCubeUVData {","\tvec2 uv_10;","\tvec2 uv_20;","\tfloat t;","}"].join("\n")),getFaceFromDirection=new FunctionNode(["int getFaceFromDirection(vec3 direction) {","\tvec3 absDirection = abs(direction);","\tint face = -1;","\tif( absDirection.x > absDirection.z ) {","\t\tif(absDirection.x > absDirection.y )","\t\t\tface = direction.x > 0.0 ? 0 : 3;","\t\telse","\t\t\tface = direction.y > 0.0 ? 1 : 4;","\t}","\telse {","\t\tif(absDirection.z > absDirection.y )","\t\t\tface = direction.z > 0.0 ? 2 : 5;","\t\telse","\t\t\tface = direction.y > 0.0 ? 1 : 4;","\t}","\treturn face;","}"].join("\n")),cubeUV_maxLods1=new ConstNode("#define cubeUV_maxLods1 ( log2( cubeUV_textureSize * 0.25 ) - 1.0 )"),cubeUV_rangeClamp=new ConstNode("#define cubeUV_rangeClamp ( exp2( ( 6.0 - 1.0 ) * 2.0 ) )"),MipLevelInfo=new FunctionNode(["vec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness, in float cubeUV_textureSize ) {","\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);","\tfloat dxRoughness = dFdx(roughness);","\tfloat dyRoughness = dFdy(roughness);","\tvec3 dx = dFdx( vec * scale * dxRoughness );","\tvec3 dy = dFdy( vec * scale * dyRoughness );","\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );","\td = clamp(d, 1.0, cubeUV_rangeClamp);","\tfloat mipLevel = 0.5 * log2(d);","\treturn vec2(floor(mipLevel), fract(mipLevel));","}"].join("\n"),[cubeUV_maxLods1,cubeUV_rangeClamp],{derivatives:!0}),cubeUV_maxLods2=new ConstNode("#define cubeUV_maxLods2 ( log2( cubeUV_textureSize * 0.25 ) - 2.0 )"),cubeUV_rcpTextureSize=new ConstNode("#define cubeUV_rcpTextureSize ( 1.0 / cubeUV_textureSize )"),getCubeUV=new FunctionNode(["vec2 getCubeUV( vec3 direction, float roughnessLevel, float mipLevel, in float cubeUV_textureSize ) {","\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;","\tfloat a = 16.0 * cubeUV_rcpTextureSize;","","\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );","\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;","\tfloat powScale = exp2_packed.x * exp2_packed.y;","\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;","\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;","","\tbool bRes = mipLevel == 0.0;","\tscale =  bRes && (scale < a) ? a : scale;","","\tvec3 r;","\tvec2 offset;","\tint face = getFaceFromDirection(direction);","","\tfloat rcpPowScale = 1.0 / powScale;","","\tif( face == 0) {","\t\tr = vec3(direction.x, -direction.z, direction.y);","\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;","\t}","\telse if( face == 1) {","\t\tr = vec3(direction.y, direction.x, direction.z);","\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;","\t}","\telse if( face == 2) {","\t\tr = vec3(direction.z, direction.x, direction.y);","\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;","\t}","\telse if( face == 3) {","\t\tr = vec3(direction.x, direction.z, direction.y);","\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;","\t}","\telse if( face == 4) {","\t\tr = vec3(direction.y, direction.x, -direction.z);","\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;","\t}","\telse {","\t\tr = vec3(direction.z, -direction.x, direction.y);","\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);","\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;","\t}","\tr = normalize(r);","\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;","\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;","\tvec2 base = offset + vec2( texelOffset );","\treturn base + s * ( scale - 2.0 * texelOffset );","}"].join("\n"),[cubeUV_maxLods2,cubeUV_rcpTextureSize,getFaceFromDirection]),cubeUV_maxLods3=new ConstNode("#define cubeUV_maxLods3 ( log2( cubeUV_textureSize * 0.25 ) - 3.0 )"),{TextureCubeUVData:TextureCubeUVData,textureCubeUV:new FunctionNode(["TextureCubeUVData textureCubeUV( vec3 reflectedDirection, float roughness, in float cubeUV_textureSize ) {","\tfloat roughnessVal = roughness * cubeUV_maxLods3;","\tfloat r1 = floor(roughnessVal);","\tfloat r2 = r1 + 1.0;","\tfloat t = fract(roughnessVal);","\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness, cubeUV_textureSize);","\tfloat s = mipInfo.y;","\tfloat level0 = mipInfo.x;","\tfloat level1 = level0 + 1.0;","\tlevel1 = level1 > 5.0 ? 5.0 : level1;","","\tlevel0 += min( floor( s + 0.5 ), 5.0 );","","\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0, cubeUV_textureSize);","\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0, cubeUV_textureSize);","","\treturn TextureCubeUVData(uv_10, uv_20, t);","}"].join("\n"),[TextureCubeUVData,cubeUV_maxLods3,MipLevelInfo,getCubeUV])}),TextureCubeUVNode.prototype=Object.create(TempNode.prototype),TextureCubeUVNode.prototype.constructor=TextureCubeUVNode,TextureCubeUVNode.prototype.nodeType="TextureCubeUV",TextureCubeUVNode.prototype.generate=function(e,output){if(e.isShader("fragment")){var t=e.include(TextureCubeUVNode.Nodes.textureCubeUV);return e.format(t+"( "+this.uv.build(e,"v3")+", "+this.blinnExponentToRoughness.build(e,"f")+", "+this.textureSize.build(e,"f")+" )",this.getType(e),output)}return console.warn("TextureCubeUVNode is not compatible with "+e.shader+" shader."),e.format("vec4( 0.0 )",this.getType(e),output)},TextureCubeUVNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).uv=this.uv.toJSON(meta).uuid,data.textureSize=this.textureSize.toJSON(meta).uuid,data.blinnExponentToRoughness=this.blinnExponentToRoughness.toJSON(meta).uuid),data},TextureCubeNode.prototype=Object.create(TempNode.prototype),TextureCubeNode.prototype.constructor=TextureCubeNode,TextureCubeNode.prototype.nodeType="TextureCube",TextureCubeNode.prototype.generate=function(e,output){if(e.isShader("fragment")){var t=this.uv.build(e)+".uv_10",r=this.uv.build(e)+".uv_20",n=this.uv.build(e)+".t",o=e.getTexelDecodingFunctionFromTexture("texture2D( "+this.value.build(e,"sampler2D")+", "+t+" )",this.value.value),l=e.getTexelDecodingFunctionFromTexture("texture2D( "+this.value.build(e,"sampler2D")+", "+r+" )",this.value.value);return e.format("vec4( mix( "+o+", "+l+", "+n+" ).rgb, 1.0 )",this.getType(e),output)}return console.warn("TextureCubeNode is not compatible with "+e.shader+" shader."),e.format("vec4( 0.0 )",this.getType(e),output)},TextureCubeNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).uv=this.uv.toJSON(meta).uuid,data.textureSize=this.textureSize.toJSON(meta).uuid,data.blinnExponentToRoughness=this.blinnExponentToRoughness.toJSON(meta).uuid,this.roughness&&(data.roughness=this.roughness.toJSON(meta).uuid)),data};var elements=NodeUtils.elements,constructors=["float","vec2","vec3","vec4"],convertFormatToType={float:"f",vec2:"v2",vec3:"v3",vec4:"v4",mat4:"v4",int:"i",bool:"b"},convertTypeToFormat={t:"sampler2D",tc:"samplerCube",b:"bool",i:"int",f:"float",c:"vec3",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4"},LUMA,dHdxy_fwd;function NodeBuilder(){this.slots=[],this.caches=[],this.contexts=[],this.keywords={},this.nodeData={},this.requires={uv:[],color:[],lights:!1,fog:!1},this.includes={consts:[],functions:[],structs:[]},this.attributes={},this.prefixCode=["#ifdef TEXTURE_LOD_EXT","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCubeLodEXT(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2DLodEXT(a, b, c)","#else","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCube(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2D(a, b, c)","#endif","#include <packing>","#include <common>"].join("\n"),this.parsCode={vertex:"",fragment:""},this.code={vertex:"",fragment:""},this.nodeCode={vertex:"",fragment:""},this.resultCode={vertex:"",fragment:""},this.finalCode={vertex:"",fragment:""},this.inputs={uniforms:{list:[],vertex:[],fragment:[]},vars:{varying:[],vertex:[],fragment:[]}},this.defines={},this.uniforms={},this.extensions={},this.updaters=[],this.nodes=[],this.parsing=!1,this.optimize=!0}function NodeFrame(time){this.time=void 0!==time?time:0,this.id=0}function VarNode(e,t){Node$1.call(this,e),this.value=t}function BlurNode(e,t,r,n){TempNode.call(this,"v4"),this.value=e,this.uv=t||new UVNode,this.radius=new Vector2Node(1,1),this.size=n,this.blurX=!0,this.blurY=!0,this.horizontal=new FloatNode(1/64),this.vertical=new FloatNode(1/64)}function LuminanceNode(e){TempNode.call(this,"f"),this.rgb=e}function ColorAdjustmentNode(e,t,r){TempNode.call(this,"v3"),this.rgb=e,this.adjustment=t,this.method=r||ColorAdjustmentNode.SATURATION}function BoolNode(e){InputNode.call(this,"b"),this.value=Boolean(e)}function ColorNode(e,g,b){InputNode.call(this,"c"),this.value=e instanceof Color?e:new Color(e||0,g,b)}function IntNode(e){InputNode.call(this,"i"),this.value=Math.floor(e||0)}function Matrix3Node(e){InputNode.call(this,"m3"),this.value=e||new Matrix3}function Matrix4Node(e){InputNode.call(this,"m4"),this.value=e||new Matrix4}function PropertyNode(object,e,t){InputNode.call(this,t),this.object=object,this.property=e}function OperatorNode(a,b,e){TempNode.call(this),this.a=a,this.b=b,this.op=e}function ReflectorNode(e){TempNode.call(this,"v4"),e&&this.setMirror(e)}function RawNode(e){Node$1.call(this,"v4"),this.value=e}function NodeMaterial(e,t){ShaderMaterial.call(this),this.vertex=e||new RawNode(new PositionNode(PositionNode.PROJECTION)),this.fragment=t||new RawNode(new ColorNode(16711680)),this.updaters=[]}function RTTNode(e,t,input,r){r=r||{},this.input=input,this.clear=void 0===r.clear||r.clear,this.renderTarget=new WebGLRenderTarget(e,t,r),this.material=new NodeMaterial,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),this.material),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.render=!0,TextureNode.call(this,this.renderTarget.texture)}function ScreenNode(e){TextureNode.call(this,void 0,e)}function StandardNode(){Node$1.call(this),this.color=new ColorNode(15658734),this.roughness=new FloatNode(.5),this.metalness=new FloatNode(.5)}function SwitchNode(e,t){Node$1.call(this),this.node=e,this.components=t||"x"}function NormalMapNode(e,t){TempNode.call(this,"v3"),this.value=e,this.scale=t||new Vector2Node(1,1)}function MeshStandardNode(){StandardNode.call(this),this.properties={color:new Color(16777215),roughness:.5,metalness:.5,normalScale:new Vector2(1,1)},this.inputs={color:new PropertyNode(this.properties,"color","c"),roughness:new PropertyNode(this.properties,"roughness","f"),metalness:new PropertyNode(this.properties,"metalness","f"),normalScale:new PropertyNode(this.properties,"normalScale","v2")}}function MeshStandardNodeMaterial(){var e=new MeshStandardNode;NodeMaterial.call(this,e,e),this.type="MeshStandardNodeMaterial"}function PhongNode(){Node$1.call(this),this.color=new ColorNode(15658734),this.specular=new ColorNode(1118481),this.shininess=new FloatNode(30)}function SpriteNode(){Node$1.call(this),this.color=new ColorNode(15658734),this.spherical=!0}function PhongNodeMaterial(){var e=new PhongNode;NodeMaterial.call(this,e,e),this.type="PhongNodeMaterial"}function SpriteNodeMaterial(){var e=new SpriteNode;NodeMaterial.call(this,e,e),this.type="SpriteNodeMaterial"}function StandardNodeMaterial(){var e=new StandardNode;NodeMaterial.call(this,e,e),this.type="StandardNodeMaterial"}function CondNode(a,b,e,t,r){TempNode.call(this),this.a=a,this.b=b,this.op=e,this.ifNode=t,this.elseNode=r}function Math1Node(a,e){TempNode.call(this),this.a=a,this.method=e}function Math2Node(a,b,e){TempNode.call(this),this.a=a,this.b=b,this.method=e}function Math3Node(a,b,e,t){TempNode.call(this),this.a=a,this.b=b,this.c=e,this.method=t}function BumpMapNode(e,t){TempNode.call(this,"v3"),this.value=e,this.scale=t||new FloatNode(1),this.toNormalMap=!1}NodeBuilder.prototype={constructor:NodeBuilder,build:function(e,t){return this.buildShader("vertex",e),this.buildShader("fragment",t),this.requires.uv[0]&&(this.addVaryCode("varying vec2 vUv;"),this.addVertexFinalCode("vUv = uv;")),this.requires.uv[1]&&(this.addVaryCode("varying vec2 vUv2;"),this.addVertexParsCode("attribute vec2 uv2;"),this.addVertexFinalCode("vUv2 = uv2;")),this.requires.color[0]&&(this.addVaryCode("varying vec4 vColor;"),this.addVertexParsCode("attribute vec4 color;"),this.addVertexFinalCode("vColor = color;")),this.requires.color[1]&&(this.addVaryCode("varying vec4 vColor2;"),this.addVertexParsCode("attribute vec4 color2;"),this.addVertexFinalCode("vColor2 = color2;")),this.requires.position&&(this.addVaryCode("varying vec3 vPosition;"),this.addVertexFinalCode("vPosition = transformed;")),this.requires.worldPosition&&(this.addVaryCode("varying vec3 vWPosition;"),this.addVertexFinalCode("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;")),this.requires.normal&&(this.addVaryCode("varying vec3 vObjectNormal;"),this.addVertexFinalCode("vObjectNormal = normal;")),this.requires.worldNormal&&(this.addVaryCode("varying vec3 vWNormal;"),this.addVertexFinalCode("vWNormal = ( modelMatrix * vec4( objectNormal, 0.0 ) ).xyz;")),this},buildShader:function(e,t){this.resultCode[e]=t.build(this.setShader(e),"v4")},setMaterial:function(e,t){return this.material=e,this.renderer=t,this.requires.lights=e.lights,this.requires.fog=e.fog,this.mergeDefines(e.defines),this},addFlow:function(slot,e,t){return this.addSlot(slot).addCache(e).addContext(t)},removeFlow:function(){return this.removeSlot().removeCache().removeContext()},addCache:function(e){return this.cache=e||"",this.caches.push(this.cache),this},removeCache:function(){return this.caches.pop(),this.cache=this.caches[this.caches.length-1]||"",this},addContext:function(e){return this.context=Object.assign({},this.context,e),this.contexts.push(this.context),this},removeContext:function(){return this.contexts.pop(),this.context=this.contexts[this.contexts.length-1]||{},this},addSlot:function(e){return this.slot=e||"",this.slots.push(this.slot),this},removeSlot:function(){return this.slots.pop(),this.slot=this.slots[this.slots.length-1]||"",this},addVertexCode:function(code){this.addCode(code,"vertex")},addFragmentCode:function(code){this.addCode(code,"fragment")},addCode:function(code,e){this.code[e||this.shader]+=code+"\n"},addVertexNodeCode:function(code){this.addNodeCode(code,"vertex")},addFragmentNodeCode:function(code){this.addNodeCode(code,"fragment")},addNodeCode:function(code,e){this.nodeCode[e||this.shader]+=code+"\n"},clearNodeCode:function(e){e=e||this.shader;var code=this.nodeCode[e];return this.nodeCode[e]="",code},clearVertexNodeCode:function(){return this.clearNodeCode("vertex")},clearFragmentNodeCode:function(){return this.clearNodeCode("fragment")},addVertexFinalCode:function(code){this.addFinalCode(code,"vertex")},addFragmentFinalCode:function(code){this.addFinalCode(code,"fragment")},addFinalCode:function(code,e){this.finalCode[e||this.shader]+=code+"\n"},addVertexParsCode:function(code){this.addParsCode(code,"vertex")},addFragmentParsCode:function(code){this.addParsCode(code,"fragment")},addParsCode:function(code,e){this.parsCode[e||this.shader]+=code+"\n"},addVaryCode:function(code){this.addVertexParsCode(code),this.addFragmentParsCode(code)},isCache:function(e){return-1!==this.caches.indexOf(e)},isSlot:function(e){return-1!==this.slots.indexOf(e)},define:function(e,t){this.defines[e]=void 0===t?1:t},isDefined:function(e){return void 0!==this.defines[e]},getVar:function(e,t,r,n,o,label){void 0===n&&(n="varying"),void 0===o&&(o="V"),void 0===label&&(label="");var l=this.getVars(n),data=l[e];if(!data){var c=l.length;data={name:r||"node"+o+c+(label?"_"+label:""),type:t},l.push(data),l[e]=data}return data},getTempVar:function(e,t,r,label){return this.getVar(e,t,r,this.shader,"T",label)},getAttribute:function(e,t){if(!this.attributes[e]){var r=this.getVar(e,t);this.addVertexParsCode("attribute "+t+" "+e+";"),this.addVertexFinalCode(r.name+" = "+e+";"),this.attributes[e]={varying:r,name:e,type:t}}return this.attributes[e]},getCode:function(e){return[this.prefixCode,this.parsCode[e],this.getVarListCode(this.getVars("varying"),"varying"),this.getVarListCode(this.inputs.uniforms[e],"uniform"),this.getIncludesCode("consts",e),this.getIncludesCode("structs",e),this.getIncludesCode("functions",e),"void main() {",this.getVarListCode(this.getVars(e)),this.code[e],this.resultCode[e],this.finalCode[e],"}"].join("\n")},getVarListCode:function(e,t){t=t||"";for(var code="",i=0,r=e.length;i<r;++i){var n=e[i],o=n.type,l=n.name,c=this.getFormatByType(o);if(void 0===c)throw new Error("Node pars "+c+" not found.");code+=t+" "+c+" "+l+";\n"}return code},getVars:function(e){return this.inputs.vars[e||this.shader]},getNodeData:function(e){var t=e.isNode?e.uuid:e;return this.nodeData[t]=this.nodeData[t]||{}},createUniform:function(e,t,r,n,o,label){var l=this.inputs.uniforms,c=l.list.length,h=new NodeUniform({type:t,name:n||"nodeU"+c+(label?"_"+label:""),node:r,needsUpdate:o});return l.list.push(h),l[e].push(h),l[e][h.name]=h,this.uniforms[h.name]=h,h},createVertexUniform:function(e,t,r,n,label){return this.createUniform("vertex",e,t,r,n,label)},createFragmentUniform:function(e,t,r,n,label){return this.createUniform("fragment",e,t,r,n,label)},include:function(e,t,source){var r;if(e="string"==typeof e?NodeLib.get(e):e,!1===this.context.include)return e.name;e instanceof FunctionNode?r=this.includes.functions:e instanceof ConstNode?r=this.includes.consts:e instanceof StructNode&&(r=this.includes.structs);var n=r[this.shader]=r[this.shader]||[];if(e){var o=n[e.name];if(o||(o=n[e.name]={node:e,deps:[]},n.push(o),o.src=e.build(this,"source")),e instanceof FunctionNode&&t&&n[t.name]&&-1==n[t.name].deps.indexOf(e)&&(n[t.name].deps.push(e),e.includes&&e.includes.length)){var i=0;do{this.include(e.includes[i++],t)}while(i<e.includes.length)}return source&&(o.src=source),e.name}throw new Error("Include not found.")},colorToVectorProperties:function(e){return e.replace("r","x").replace("g","y").replace("b","z").replace("a","w")},colorToVector:function(e){return e.replace(/c/g,"v3")},getIncludes:function(e,t){return this.includes[e][t||this.shader]},getIncludesCode:function(){function e(a,b){return a.deps.length-b.deps.length}return function(t,r){if(!(n=this.getIncludes(t,r)))return"";for(var code="",n=n.sort(e),i=0;i<n.length;i++)n[i].src&&(code+=n[i].src+"\n");return code}}(),getConstructorFromLength:function(e){return constructors[e-1]},isTypeMatrix:function(e){return/^m/.test(e)},getTypeLength:function(e){return"f"===e?1:parseInt(this.colorToVector(e).substr(1))},getTypeFromLength:function(e){return 1===e?"f":"v"+e},findNode:function(){for(var e=arguments,i=0;i<arguments.length;i++){var t=e[i];if(void 0!==t&&t.isNode)return t}},resolve:function(){for(var e=arguments,i=0;i<arguments.length;i++){var t=e[i];if(void 0!==t){if(t.isNode)return t;if(t.isTexture)switch(t.mapping){case CubeReflectionMapping:case CubeRefractionMapping:return new CubeTextureNode(t);case CubeUVReflectionMapping:case CubeUVRefractionMapping:return new TextureCubeNode(new TextureNode(t));default:return new TextureNode(t)}else{if(t.isVector2)return new Vector2Node(t);if(t.isVector3)return new Vector3Node(t);if(t.isVector4)return new Vector4Node(t)}}}},format:function(code,e,t){switch(this.colorToVector(t+" <- "+e)){case"f <- v2":case"f <- v3":case"f <- v4":return code+".x";case"f <- i":case"f <- b":return"float( "+code+" )";case"v2 <- f":return"vec2( "+code+" )";case"v2 <- v3":case"v2 <- v4":return code+".xy";case"v2 <- i":case"v2 <- b":return"vec2( float( "+code+" ) )";case"v3 <- f":return"vec3( "+code+" )";case"v3 <- v2":return"vec3( "+code+", 0.0 )";case"v3 <- v4":return code+".xyz";case"v3 <- i":case"v3 <- b":return"vec2( float( "+code+" ) )";case"v4 <- f":return"vec4( "+code+" )";case"v4 <- v2":return"vec4( "+code+", 0.0, 1.0 )";case"v4 <- v3":return"vec4( "+code+", 1.0 )";case"v4 <- i":case"v4 <- b":return"vec4( float( "+code+" ) )";case"i <- f":case"i <- b":return"int( "+code+" )";case"i <- v2":case"i <- v3":case"i <- v4":return"int( "+code+".x )";case"b <- f":return"( "+code+" != 0.0 )";case"b <- v2":return"( "+code+" != vec2( 0.0 ) )";case"b <- v3":return"( "+code+" != vec3( 0.0 ) )";case"b <- v4":return"( "+code+" != vec4( 0.0 ) )";case"b <- i":return"( "+code+" != 0 )"}return code},getTypeByFormat:function(e){return convertFormatToType[e]||e},getFormatByType:function(e){return convertTypeToFormat[e]||e},getUuid:function(e,t){return(t=void 0===t||t)&&this.cache&&(e=this.cache+"-"+e),e},getElementByIndex:function(e){return elements[e]},getIndexByElement:function(e){return elements.indexOf(e)},isShader:function(e){return this.shader===e},setShader:function(e){return this.shader=e,this},mergeDefines:function(e){for(var t in e)this.defines[t]=e[t];return this.defines},mergeUniform:function(e){for(var t in e)this.uniforms[t]=e[t];return this.uniforms},getTextureEncodingFromMap:function(map,e){var t;return e=void 0!==e?e:this.context.gamma&&!!this.renderer&&this.renderer.gammaInput,map?map.isTexture?t=map.encoding:map.isWebGLRenderTarget&&(console.warn("WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),t=map.texture.encoding):t=LinearEncoding,t===LinearEncoding&&e&&(t=GammaEncoding),t}},NodeFrame.prototype={constructor:NodeFrame,update:function(e){return++this.id,this.time+=e,this.delta=e,this},setRenderer:function(e){return this.renderer=e,this},setRenderTexture:function(e){return this.renderTexture=e,this},updateNode:function(e){return e.frameId===this.id?this:(e.updateFrame(this),e.frameId=this.id,this)}},VarNode.prototype=Object.create(Node$1.prototype),VarNode.prototype.constructor=VarNode,VarNode.prototype.nodeType="Var",VarNode.prototype.getType=function(e){return e.getTypeByFormat(this.type)},VarNode.prototype.generate=function(e,output){var t=e.getVar(this.uuid,this.type);return this.value&&e.isShader("vertex")&&e.addNodeCode(t.name+" = "+this.value.build(e,this.getType(e))+";"),e.format(t.name,this.getType(e),output)},VarNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),this.type=source.type,this.value=source.value},VarNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).type=this.type,this.value&&(data.value=this.value.toJSON(meta).uuid)),data},BlurNode.Nodes={blurX:new FunctionNode(["vec4 blurX( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x - 4.0 * s, uv.y ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x - 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x - 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x - 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x + 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x + 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x + 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x + 4.0 * s, uv.y ) ) * 0.051;","\treturn sum * .667;","}"].join("\n")),blurY:new FunctionNode(["vec4 blurY( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x, uv.y - 4.0 * s ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 4.0 * s ) ) * 0.051;","\treturn sum * .667;","}"].join("\n"))},BlurNode.prototype=Object.create(TempNode.prototype),BlurNode.prototype.constructor=BlurNode,BlurNode.prototype.nodeType="Blur",BlurNode.prototype.updateFrame=function(e){if(this.size)this.horizontal.value=this.radius.x/this.size.x,this.vertical.value=this.radius.y/this.size.y;else if(this.value.value&&this.value.value.image){var image=this.value.value.image;this.horizontal.value=this.radius.x/image.width,this.vertical.value=this.radius.y/image.height}},BlurNode.prototype.generate=function(e,output){if(e.isShader("fragment")){var code,t=[],r=e.include(BlurNode.Nodes.blurX),n=e.include(BlurNode.Nodes.blurY);return this.blurX&&t.push(r+"( "+this.value.build(e,"sampler2D")+", "+this.uv.build(e,"v2")+", "+this.horizontal.build(e,"f")+" )"),this.blurY&&t.push(n+"( "+this.value.build(e,"sampler2D")+", "+this.uv.build(e,"v2")+", "+this.vertical.build(e,"f")+" )"),code=2==t.length?"( "+t.join(" + ")+" / 2.0 )":t.length?"( "+t[0]+" )":"vec4( 0.0 )",e.format(code,this.getType(e),output)}return console.warn("BlurNode is not compatible with "+e.shader+" shader."),e.format("vec4( 0.0 )",this.getType(e),output)},BlurNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.value=source.value,this.uv=source.uv,this.radius=source.radius,void 0!==source.size&&(this.size=new Vector2(source.size.x,source.size.y)),this.blurX=source.blurX,this.blurY=source.blurY},BlurNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value.toJSON(meta).uuid,data.uv=this.uv.toJSON(meta).uuid,data.radius=this.radius.toJSON(meta).uuid,this.size&&(data.size={x:this.size.x,y:this.size.y}),data.blurX=this.blurX,data.blurY=this.blurY),data},LuminanceNode.Nodes=(LUMA=new ConstNode("vec3 LUMA vec3( 0.2125, 0.7154, 0.0721 )"),{LUMA:LUMA,luminance:new FunctionNode(["float luminance( vec3 rgb ) {","\treturn dot( rgb, LUMA );","}"].join("\n"),[LUMA])}),LuminanceNode.prototype=Object.create(TempNode.prototype),LuminanceNode.prototype.constructor=LuminanceNode,LuminanceNode.prototype.nodeType="Luminance",LuminanceNode.prototype.generate=function(e,output){var t=e.include(LuminanceNode.Nodes.luminance);return e.format(t+"( "+this.rgb.build(e,"v3")+" )",this.getType(e),output)},LuminanceNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.rgb=source.rgb},LuminanceNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).rgb=this.rgb.toJSON(meta).uuid),data},ColorAdjustmentNode.Nodes={hue:new FunctionNode(["vec3 hue(vec3 rgb, float adjustment) {","\tconst mat3 RGBtoYIQ = mat3(0.299, 0.587, 0.114, 0.595716, -0.274453, -0.321263, 0.211456, -0.522591, 0.311135);","\tconst mat3 YIQtoRGB = mat3(1.0, 0.9563, 0.6210, 1.0, -0.2721, -0.6474, 1.0, -1.107, 1.7046);","\tvec3 yiq = RGBtoYIQ * rgb;","\tfloat hue = atan(yiq.z, yiq.y) + adjustment;","\tfloat chroma = sqrt(yiq.z * yiq.z + yiq.y * yiq.y);","\treturn YIQtoRGB * vec3(yiq.x, chroma * cos(hue), chroma * sin(hue));","}"].join("\n")),saturation:new FunctionNode(["vec3 saturation(vec3 rgb, float adjustment) {","\tvec3 intensity = vec3( luminance( rgb ) );","\treturn mix( intensity, rgb, adjustment );","}"].join("\n"),[LuminanceNode.Nodes.luminance]),vibrance:new FunctionNode(["vec3 vibrance(vec3 rgb, float adjustment) {","\tfloat average = (rgb.r + rgb.g + rgb.b) / 3.0;","\tfloat mx = max(rgb.r, max(rgb.g, rgb.b));","\tfloat amt = (mx - average) * (-3.0 * adjustment);","\treturn mix(rgb.rgb, vec3(mx), amt);","}"].join("\n"))},ColorAdjustmentNode.SATURATION="saturation",ColorAdjustmentNode.HUE="hue",ColorAdjustmentNode.VIBRANCE="vibrance",ColorAdjustmentNode.BRIGHTNESS="brightness",ColorAdjustmentNode.CONTRAST="contrast",ColorAdjustmentNode.prototype=Object.create(TempNode.prototype),ColorAdjustmentNode.prototype.constructor=ColorAdjustmentNode,ColorAdjustmentNode.prototype.nodeType="ColorAdjustment",ColorAdjustmentNode.prototype.generate=function(e,output){var t=this.rgb.build(e,"v3"),r=this.adjustment.build(e,"f");switch(this.method){case ColorAdjustmentNode.BRIGHTNESS:return e.format("( "+t+" + "+r+" )",this.getType(e),output);case ColorAdjustmentNode.CONTRAST:return e.format("( "+t+" * "+r+" )",this.getType(e),output)}var n=e.include(ColorAdjustmentNode.Nodes[this.method]);return e.format(n+"( "+t+", "+r+" )",this.getType(e),output)},ColorAdjustmentNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.rgb=source.rgb,this.adjustment=source.adjustment,this.method=source.method},ColorAdjustmentNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).rgb=this.rgb.toJSON(meta).uuid,data.adjustment=this.adjustment.toJSON(meta).uuid,data.method=this.method),data},BoolNode.prototype=Object.create(InputNode.prototype),BoolNode.prototype.constructor=BoolNode,BoolNode.prototype.nodeType="Bool",BoolNode.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format(this.value,r,output)},BoolNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value=source.value},BoolNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value,!0===this.readonly&&(data.readonly=!0)),data},ColorNode.prototype=Object.create(InputNode.prototype),ColorNode.prototype.constructor=ColorNode,ColorNode.prototype.nodeType="Color",NodeUtils.addShortcuts(ColorNode.prototype,"value",["r","g","b"]),ColorNode.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("vec3( "+this.r+", "+this.g+", "+this.b+" )",r,output)},ColorNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value.copy(source)},ColorNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).r=this.r,data.g=this.g,data.b=this.b,!0===this.readonly&&(data.readonly=!0)),data},IntNode.prototype=Object.create(InputNode.prototype),IntNode.prototype.constructor=IntNode,IntNode.prototype.nodeType="Int",IntNode.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format(this.value,r,output)},IntNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value=source.value},IntNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value,!0===this.readonly&&(data.readonly=!0)),data},Matrix3Node.prototype=Object.create(InputNode.prototype),Matrix3Node.prototype.constructor=Matrix3Node,Matrix3Node.prototype.nodeType="Matrix3",Object.defineProperties(Matrix3Node.prototype,{elements:{set:function(e){this.value.elements=e},get:function(){return this.value.elements}}}),Matrix3Node.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("mat3( "+this.value.elements.join(", ")+" )",r,output)},Matrix3Node.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.value.fromArray(source.elements)},Matrix3Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).elements=this.value.elements.concat()),data},Matrix4Node.prototype=Object.create(InputNode.prototype),Matrix4Node.prototype.constructor=Matrix4Node,Matrix4Node.prototype.nodeType="Matrix4",Object.defineProperties(Matrix4Node.prototype,{elements:{set:function(e){this.value.elements=e},get:function(){return this.value.elements}}}),Matrix4Node.prototype.generateReadonly=function(e,output,t,r,n,o){return e.format("mat4( "+this.value.elements.join(", ")+" )",r,output)},Matrix4Node.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.scope.value.fromArray(source.elements)},Matrix4Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).elements=this.value.elements.concat()),data},PropertyNode.prototype=Object.create(InputNode.prototype),PropertyNode.prototype.constructor=PropertyNode,PropertyNode.prototype.nodeType="Property",Object.defineProperties(PropertyNode.prototype,{value:{get:function(){return this.object[this.property]},set:function(e){this.object[this.property]=e}}}),PropertyNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value,data.property=this.property),data},OperatorNode.ADD="+",OperatorNode.SUB="-",OperatorNode.MUL="*",OperatorNode.DIV="/",OperatorNode.prototype=Object.create(TempNode.prototype),OperatorNode.prototype.constructor=OperatorNode,OperatorNode.prototype.nodeType="Operator",OperatorNode.prototype.getType=function(e){var a=this.a.getType(e),b=this.b.getType(e);return e.isTypeMatrix(a)?"v4":e.getTypeLength(b)>e.getTypeLength(a)?b:a},OperatorNode.prototype.generate=function(e,output){e.getNodeData(this);var t=this.getType(e),a=this.a.build(e,t),b=this.b.build(e,t);return e.format("( "+a+" "+this.op+" "+b+" )",t,output)},OperatorNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.a=source.a,this.b=source.b,this.op=source.op},OperatorNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).a=this.a.toJSON(meta).uuid,data.b=this.b.toJSON(meta).uuid,data.op=this.op),data},ReflectorNode.prototype=Object.create(TempNode.prototype),ReflectorNode.prototype.constructor=ReflectorNode,ReflectorNode.prototype.nodeType="Reflector",ReflectorNode.prototype.setMirror=function(e){this.mirror=e,this.textureMatrix=new Matrix4Node(this.mirror.material.uniforms.textureMatrix.value),this.localPosition=new PositionNode(PositionNode.LOCAL),this.uv=new OperatorNode(this.textureMatrix,this.localPosition,OperatorNode.MUL),this.uvResult=new OperatorNode(null,this.uv,OperatorNode.ADD),this.texture=new TextureNode(this.mirror.material.uniforms.tDiffuse.value,this.uv,null,!0)},ReflectorNode.prototype.generate=function(e,output){return e.isShader("fragment")?(this.uvResult.a=this.offset,this.texture.uv=this.offset?this.uvResult:this.uv,"sampler2D"===output?this.texture.build(e,output):e.format(this.texture.build(e,this.type),this.type,output)):(console.warn("ReflectorNode is not compatible with "+e.shader+" shader."),e.format("vec4( 0.0 )",this.type,output))},ReflectorNode.prototype.copy=function(source){InputNode.prototype.copy.call(this,source),this.scope.mirror=source.mirror},ReflectorNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).mirror=this.mirror.uuid,this.offset&&(data.offset=this.offset.toJSON(meta).uuid)),data},RawNode.prototype=Object.create(Node$1.prototype),RawNode.prototype.constructor=RawNode,RawNode.prototype.nodeType="Raw",RawNode.prototype.generate=function(e){var data=this.value.parseAndBuildCode(e,this.type),code=data.code+"\n";return e.isShader("vertex")?code+="gl_Position = "+data.result+";":code+="gl_FragColor = "+data.result+";",code},RawNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),this.value=source.value},RawNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value.toJSON(meta).uuid),data},NodeMaterial.prototype=Object.create(ShaderMaterial.prototype),NodeMaterial.prototype.constructor=NodeMaterial,NodeMaterial.prototype.type="NodeMaterial",NodeMaterial.prototype.isNodeMaterial=!0,Object.defineProperties(NodeMaterial.prototype,{properties:{get:function(){return this.fragment.properties}}}),NodeMaterial.prototype.updateFrame=function(e){for(var i=0;i<this.updaters.length;++i)e.updateNode(this.updaters[i])},NodeMaterial.prototype.onBeforeCompile=function(e,t){this.needsUpdate&&(this.build({renderer:t}),e.uniforms=this.uniforms,e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader)},NodeMaterial.prototype.build=function(e){var t=(e=e||{}).builder||new NodeBuilder;return t.setMaterial(this,e.renderer),t.build(this.vertex,this.fragment),this.vertexShader=t.getCode("vertex"),this.fragmentShader=t.getCode("fragment"),this.defines=t.defines,this.uniforms=t.uniforms,this.extensions=t.extensions,this.updaters=t.updaters,this.fog=t.requires.fog,this.lights=t.requires.lights,this.transparent=t.requires.transparent||this.blending>NormalBlending,this.needsUpdate=!1,this},NodeMaterial.prototype.copy=function(source){var e=this.uuid;for(var t in source)this[t]=source[t];this.uuid=e,void 0!==source.userData&&(this.userData=JSON.parse(JSON.stringify(source.userData)))},NodeMaterial.prototype.toJSON=function(meta){if((void 0===meta||"string"==typeof meta)&&(meta={nodes:{}}),meta&&!meta.materials&&(meta.materials={}),!meta.materials[this.uuid]){var data={};data.uuid=this.uuid,data.type=this.type,meta.materials[data.uuid]=data,""!==this.name&&(data.name=this.name),void 0!==this.size&&(data.size=this.size),void 0!==this.sizeAttenuation&&(data.sizeAttenuation=this.sizeAttenuation),this.blending!==NormalBlending&&(data.blending=this.blending),!0===this.flatShading&&(data.flatShading=this.flatShading),this.side!==FrontSide&&(data.side=this.side),this.vertexColors!==NoColors&&(data.vertexColors=this.vertexColors),this.depthFunc!==LessEqualDepth&&(data.depthFunc=this.depthFunc),!1===this.depthTest&&(data.depthTest=this.depthTest),!1===this.depthWrite&&(data.depthWrite=this.depthWrite),1!==this.linewidth&&(data.linewidth=this.linewidth),void 0!==this.dashSize&&(data.dashSize=this.dashSize),void 0!==this.gapSize&&(data.gapSize=this.gapSize),void 0!==this.scale&&(data.scale=this.scale),!0===this.dithering&&(data.dithering=!0),!0===this.wireframe&&(data.wireframe=this.wireframe),this.wireframeLinewidth>1&&(data.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(data.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(data.wireframeLinejoin=this.wireframeLinejoin),this.alphaTest>0&&(data.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(data.premultipliedAlpha=this.premultipliedAlpha),!0===this.morphTargets&&(data.morphTargets=!0),!0===this.skinning&&(data.skinning=!0),!1===this.visible&&(data.visible=!1),"{}"!==JSON.stringify(this.userData)&&(data.userData=this.userData),data.fog=this.fog,data.lights=this.lights,data.vertex=this.vertex.toJSON(meta).uuid,data.fragment=this.fragment.toJSON(meta).uuid}return meta.material=this.uuid,meta},RTTNode.prototype=Object.create(TextureNode.prototype),RTTNode.prototype.constructor=RTTNode,RTTNode.prototype.nodeType="RTT",RTTNode.prototype.build=function(e,output,t){var r=new NodeBuilder;return r.nodes=e.nodes,r.updaters=e.updaters,this.material.fragment.value=this.input,this.material.build({builder:r}),TextureNode.prototype.build.call(this,e,output,t)},RTTNode.prototype.updateFramesaveTo=function(e){if(this.saveTo.render=!1,this.saveTo!==this.saveToCurrent){this.saveToMaterial&&this.saveToMaterial.dispose();var t=new NodeMaterial;t.fragment.value=this,t.build();var r=new Scene,n=new Mesh(new PlaneBufferGeometry(2,2),t);n.frustumCulled=!1,r.add(n),this.saveToScene=r,this.saveToMaterial=t}this.saveToCurrent=this.saveTo,e.renderer.setRenderTarget(this.saveTo.renderTarget),this.saveTo.clear&&e.renderer.clear(),e.renderer.render(this.saveToScene,this.camera)},RTTNode.prototype.updateFrame=function(e){e.renderer?(this.saveTo&&!1===this.saveTo.render&&this.updateFramesaveTo(e),this.render&&(this.material.uniforms.renderTexture&&(this.material.uniforms.renderTexture.value=e.renderTexture),e.renderer.setRenderTarget(this.renderTarget),this.clear&&e.renderer.clear(),e.renderer.render(this.scene,this.camera)),this.saveTo&&!0===this.saveTo.render&&this.updateFramesaveTo(e)):console.warn("RTTNode need a renderer in NodeFrame")},RTTNode.prototype.copy=function(source){TextureNode.prototype.copy.call(this,source),this.saveTo=source.saveTo},RTTNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=TextureNode.prototype.toJSON.call(this,meta),this.saveTo&&(data.saveTo=this.saveTo.toJSON(meta).uuid)),data},ScreenNode.prototype=Object.create(TextureNode.prototype),ScreenNode.prototype.constructor=ScreenNode,ScreenNode.prototype.nodeType="Screen",ScreenNode.prototype.getUnique=function(){return!0},ScreenNode.prototype.getTexture=function(e,output){return InputNode.prototype.generate.call(this,e,output,this.getUuid(),"t","renderTexture")},StandardNode.prototype=Object.create(Node$1.prototype),StandardNode.prototype.constructor=StandardNode,StandardNode.prototype.nodeType="Standard",StandardNode.prototype.build=function(e){var code;if(e.define(this.clearCoat||this.clearCoatRoughness?"PHYSICAL":"STANDARD"),e.requires.lights=!0,e.extensions.shaderTextureLOD=!0,e.isShader("vertex")){var t=this.position?this.position.parseAndBuildCode(e,"v3",{cache:"position"}):void 0;e.mergeUniform(UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights])),e.addParsCode(["varying vec3 vViewPosition;","#ifndef FLAT_SHADED","\tvarying vec3 vNormal;","#endif","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));var output=["#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","\tvNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>"];t&&output.push(t.code,t.result?"transformed = "+t.result+";":""),output.push("#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <fog_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>"),code=output.join("\n")}else{var r={bias:RoughnessToBlinnExponentNode,gamma:!0},n={gamma:!0},o=!e.isDefined("STANDARD");this.mask&&this.mask.parse(e),this.color.parse(e,{slot:"color",context:n}),this.roughness.parse(e),this.metalness.parse(e),this.alpha&&this.alpha.parse(e),this.normal&&this.normal.parse(e),this.clearCoat&&this.clearCoat.parse(e),this.clearCoatRoughness&&this.clearCoatRoughness.parse(e),this.reflectivity&&this.reflectivity.parse(e),this.light&&this.light.parse(e,{cache:"light"}),this.ao&&this.ao.parse(e),this.ambient&&this.ambient.parse(e),this.shadow&&this.shadow.parse(e),this.emissive&&this.emissive.parse(e,{slot:"emissive"}),this.environment&&this.environment.parse(e,{cache:"env",context:r,slot:"environment"});var mask=this.mask?this.mask.buildCode(e,"b"):void 0,l=this.color.buildCode(e,"c",{slot:"color",context:n}),c=this.roughness.buildCode(e,"f"),h=this.metalness.buildCode(e,"f"),d=this.alpha?this.alpha.buildCode(e,"f"):void 0,f=this.normal?this.normal.buildCode(e,"v3"):void 0,m=this.clearCoat?this.clearCoat.buildCode(e,"f"):void 0,v=this.clearCoatRoughness?this.clearCoatRoughness.buildCode(e,"f"):void 0,y=this.reflectivity?this.reflectivity.buildCode(e,"f"):void 0,x=this.light?this.light.buildCode(e,"v3",{cache:"light"}):void 0,w=this.ao?this.ao.buildCode(e,"f"):void 0,M=this.ambient?this.ambient.buildCode(e,"c"):void 0,shadow=this.shadow?this.shadow.buildCode(e,"c"):void 0,S=this.emissive?this.emissive.buildCode(e,"c",{slot:"emissive"}):void 0,A=this.environment?this.environment.buildCode(e,"c",{cache:"env",context:r,slot:"environment"}):void 0,T=o&&A?this.environment.buildCode(e,"c",{cache:"clearCoat",context:r,slot:"environment"}):void 0;e.requires.transparent=void 0!==d,e.addParsCode(["varying vec3 vViewPosition;","#ifndef FLAT_SHADED","\tvarying vec3 vNormal;","#endif","#include <dithering_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <logdepthbuf_pars_fragment>"].join("\n"));output=["#include <clipping_planes_fragment>","\t#include <normal_fragment_begin>","\tPhysicalMaterial material;","\tmaterial.diffuseColor = vec3( 1.0 );"];mask&&output.push(mask.code,"if ( ! "+mask.result+" ) discard;"),output.push(l.code,"\tvec3 diffuseColor = "+l.result+";","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","#include <logdepthbuf_fragment>",c.code,"\tfloat roughnessFactor = "+c.result+";",h.code,"\tfloat metalnessFactor = "+h.result+";"),d&&output.push(d.code,"#ifdef ALPHATEST","\tif ( "+d.result+" <= ALPHATEST ) discard;","#endif"),f&&output.push(f.code,"normal = "+f.result+";"),output.push("material.diffuseColor = "+(x?"vec3( 1.0 )":"diffuseColor * (1.0 - metalnessFactor)")+";","material.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );"),m?output.push(m.code,"material.clearCoat = saturate( "+m.result+" );"):o&&output.push("material.clearCoat = 0.0;"),v?output.push(v.code,"material.clearCoatRoughness = clamp( "+v.result+", 0.04, 1.0 );"):o&&output.push("material.clearCoatRoughness = 0.0;"),y?output.push(y.code,"material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( "+y.result+" ) ), diffuseColor, metalnessFactor );"):output.push("material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor, metalnessFactor );"),output.push("#include <lights_fragment_begin>"),x&&(output.push(x.code,"reflectedLight.directDiffuse = "+x.result+";"),output.push("diffuseColor *= 1.0 - metalnessFactor;","reflectedLight.directDiffuse *= diffuseColor;","reflectedLight.indirectDiffuse *= diffuseColor;")),w&&output.push(w.code,"reflectedLight.indirectDiffuse *= "+w.result+";","float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );","reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, "+w.result+", material.specularRoughness );"),M&&output.push(M.code,"reflectedLight.indirectDiffuse += "+M.result+";"),shadow&&output.push(shadow.code,"reflectedLight.directDiffuse *= "+shadow.result+";","reflectedLight.directSpecular *= "+shadow.result+";"),S&&output.push(S.code,"reflectedLight.directDiffuse += "+S.result+";"),A&&(output.push(A.code),T&&output.push(T.code,"clearCoatRadiance += "+T.result+";"),output.push("radiance += "+A.result+";")),output.push("#include <lights_fragment_end>"),output.push("vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;"),d?output.push("gl_FragColor = vec4( outgoingLight, "+d.result+" );"):output.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),output.push("#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>"),code=output.join("\n")}return code},StandardNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),source.position&&(this.position=source.position),this.color=source.color,this.roughness=source.roughness,this.metalness=source.metalness,source.mask&&(this.mask=source.mask),source.alpha&&(this.alpha=source.alpha),source.normal&&(this.normal=source.normal),source.clearCoat&&(this.clearCoat=source.clearCoat),source.clearCoatRoughness&&(this.clearCoatRoughness=source.clearCoatRoughness),source.reflectivity&&(this.reflectivity=source.reflectivity),source.light&&(this.light=source.light),source.shadow&&(this.shadow=source.shadow),source.ao&&(this.ao=source.ao),source.emissive&&(this.emissive=source.emissive),source.ambient&&(this.ambient=source.ambient),source.environment&&(this.environment=source.environment)},StandardNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),this.position&&(data.position=this.position.toJSON(meta).uuid),data.color=this.color.toJSON(meta).uuid,data.roughness=this.roughness.toJSON(meta).uuid,data.metalness=this.metalness.toJSON(meta).uuid,this.mask&&(data.mask=this.mask.toJSON(meta).uuid),this.alpha&&(data.alpha=this.alpha.toJSON(meta).uuid),this.normal&&(data.normal=this.normal.toJSON(meta).uuid),this.clearCoat&&(data.clearCoat=this.clearCoat.toJSON(meta).uuid),this.clearCoatRoughness&&(data.clearCoatRoughness=this.clearCoatRoughness.toJSON(meta).uuid),this.reflectivity&&(data.reflectivity=this.reflectivity.toJSON(meta).uuid),this.light&&(data.light=this.light.toJSON(meta).uuid),this.shadow&&(data.shadow=this.shadow.toJSON(meta).uuid),this.ao&&(data.ao=this.ao.toJSON(meta).uuid),this.emissive&&(data.emissive=this.emissive.toJSON(meta).uuid),this.ambient&&(data.ambient=this.ambient.toJSON(meta).uuid),this.environment&&(data.environment=this.environment.toJSON(meta).uuid)),data},SwitchNode.prototype=Object.create(Node$1.prototype),SwitchNode.prototype.constructor=SwitchNode,SwitchNode.prototype.nodeType="Switch",SwitchNode.prototype.getType=function(e){return e.getTypeFromLength(this.components.length)},SwitchNode.prototype.generate=function(e,output){var t=this.node.getType(e),r=this.node.build(e,t),n=e.getTypeLength(t)-1;if(n>0){var i,o=0,l=e.colorToVectorProperties(this.components),c=l.length;for(i=0;i<c;i++)o=Math.max(o,e.getIndexByElement(l.charAt(i)));for(o>n&&(o=n),r+=".",i=0;i<c;i++){l.charAt(i);var h=e.getIndexByElement(l.charAt(i));h>o&&(h=o),r+=e.getElementByIndex(h)}return e.format(r,this.getType(e),output)}return e.format(r,t,output)},SwitchNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),this.node=source.node,this.components=source.components},SwitchNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).node=this.node.toJSON(meta).uuid,data.components=this.components),data},NormalMapNode.Nodes={perturbNormal2Arb:new FunctionNode(["vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 map, vec2 mUv, vec2 normalScale ) {","\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );","\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );","\tvec2 st0 = dFdx( mUv.st );","\tvec2 st1 = dFdy( mUv.st );","\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );","\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );","\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );","\tvec3 N = normalize( surf_norm );","\tmat3 tsn = mat3( S, T, N );","\tvec3 mapN = map * 2.0 - 1.0;","\tmapN.xy *= normalScale;","\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );","\treturn normalize( tsn * mapN );","}"].join("\n"),null,{derivatives:!0})},NormalMapNode.prototype=Object.create(TempNode.prototype),NormalMapNode.prototype.constructor=NormalMapNode,NormalMapNode.prototype.nodeType="NormalMap",NormalMapNode.prototype.generate=function(e,output){if(e.isShader("fragment")){var t=e.include(NormalMapNode.Nodes.perturbNormal2Arb);return this.normal=this.normal||new NormalNode$1,this.position=this.position||new PositionNode(PositionNode.VIEW),this.uv=this.uv||new UVNode,e.format(t+"( -"+this.position.build(e,"v3")+", "+this.normal.build(e,"v3")+", "+this.value.build(e,"v3")+", "+this.uv.build(e,"v2")+", "+this.scale.build(e,"v2")+" )",this.getType(e),output)}return console.warn("NormalMapNode is not compatible with "+e.shader+" shader."),e.format("vec3( 0.0 )",this.getType(e),output)},NormalMapNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.value=source.value,this.scale=source.scale},NormalMapNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value.toJSON(meta).uuid,data.scale=this.scale.toJSON(meta).uuid),data},MeshStandardNode.prototype=Object.create(StandardNode.prototype),MeshStandardNode.prototype.constructor=MeshStandardNode,MeshStandardNode.prototype.nodeType="MeshStandard",MeshStandardNode.prototype.build=function(e){var t=this.properties,r=this.inputs;if(e.isShader("fragment")){var n=e.findNode(t.color,r.color),map=e.resolve(t.map);this.color=map?new OperatorNode(n,map,OperatorNode.MUL):n;var o=e.findNode(t.roughness,r.roughness),l=e.resolve(t.roughnessMap);this.roughness=l?new OperatorNode(o,new SwitchNode(l,"g"),OperatorNode.MUL):o;var c=e.findNode(t.metalness,r.metalness),h=e.resolve(t.metalnessMap);this.metalness=h?new OperatorNode(c,new SwitchNode(h,"b"),OperatorNode.MUL):c,t.normalMap?(this.normal=new NormalMapNode(e.resolve(t.normalMap)),this.normal.scale=e.findNode(t.normalScale,r.normalScale)):this.normal=void 0,this.environment=e.resolve(t.envMap)}return StandardNode.prototype.build.call(this,e)},MeshStandardNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),console.warn(".toJSON not implemented in",this)),data},MeshStandardNodeMaterial.prototype=Object.create(NodeMaterial.prototype),MeshStandardNodeMaterial.prototype.constructor=MeshStandardNodeMaterial,NodeUtils.addShortcuts(MeshStandardNodeMaterial.prototype,"properties",["color","roughness","metalness","map","normalMap","normalScale","metalnessMap","roughnessMap","envMap"]),PhongNode.prototype=Object.create(Node$1.prototype),PhongNode.prototype.constructor=PhongNode,PhongNode.prototype.nodeType="Phong",PhongNode.prototype.build=function(e){var code;if(e.define("PHONG"),e.requires.lights=!0,e.isShader("vertex")){var t=this.position?this.position.parseAndBuildCode(e,"v3",{cache:"position"}):void 0;e.mergeUniform(UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights])),e.addParsCode(["varying vec3 vViewPosition;","#ifndef FLAT_SHADED","\tvarying vec3 vNormal;","#endif","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));var output=["#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","\tvNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>"];t&&output.push(t.code,t.result?"transformed = "+t.result+";":""),output.push("\t#include <morphtarget_vertex>","\t#include <skinning_vertex>","\t#include <project_vertex>","\t#include <fog_vertex>","\t#include <logdepthbuf_vertex>","\t#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","\t#include <worldpos_vertex>","\t#include <shadowmap_vertex>","\t#include <fog_vertex>"),code=output.join("\n")}else{this.mask&&this.mask.parse(e),this.color.parse(e,{slot:"color"}),this.specular.parse(e),this.shininess.parse(e),this.alpha&&this.alpha.parse(e),this.normal&&this.normal.parse(e),this.light&&this.light.parse(e,{cache:"light"}),this.ao&&this.ao.parse(e),this.ambient&&this.ambient.parse(e),this.shadow&&this.shadow.parse(e),this.emissive&&this.emissive.parse(e,{slot:"emissive"}),this.environment&&this.environment.parse(e,{slot:"environment"}),this.environmentAlpha&&this.environment&&this.environmentAlpha.parse(e);var mask=this.mask?this.mask.buildCode(e,"b"):void 0,r=this.color.buildCode(e,"c",{slot:"color"}),n=this.specular.buildCode(e,"c"),o=this.shininess.buildCode(e,"f"),l=this.alpha?this.alpha.buildCode(e,"f"):void 0,c=this.normal?this.normal.buildCode(e,"v3"):void 0,h=this.light?this.light.buildCode(e,"v3",{cache:"light"}):void 0,d=this.ao?this.ao.buildCode(e,"f"):void 0,f=this.ambient?this.ambient.buildCode(e,"c"):void 0,shadow=this.shadow?this.shadow.buildCode(e,"c"):void 0,m=this.emissive?this.emissive.buildCode(e,"c",{slot:"emissive"}):void 0,v=this.environment?this.environment.buildCode(e,"c",{slot:"environment"}):void 0,y=this.environmentAlpha&&this.environment?this.environmentAlpha.buildCode(e,"f"):void 0;e.requires.transparent=null!=l,e.addParsCode(["#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_phong_pars_fragment>","#include <shadowmap_pars_fragment>","#include <logdepthbuf_pars_fragment>"].join("\n"));output=["#include <normal_fragment_begin>","\tBlinnPhongMaterial material;"];mask&&output.push(mask.code,"if ( ! "+mask.result+" ) discard;"),output.push(r.code,"\tvec3 diffuseColor = "+r.result+";","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","#include <logdepthbuf_fragment>",n.code,"\tvec3 specular = "+n.result+";",o.code,"\tfloat shininess = max( 0.0001, "+o.result+" );","\tfloat specularStrength = 1.0;"),l&&output.push(l.code,"#ifdef ALPHATEST","if ( "+l.result+" <= ALPHATEST ) discard;","#endif"),c&&output.push(c.code,"normal = "+c.result+";"),output.push("material.diffuseColor = "+(h?"vec3( 1.0 )":"diffuseColor")+";"),output.push("material.specularColor = specular;","material.specularShininess = shininess;","material.specularStrength = specularStrength;","#include <lights_fragment_begin>","#include <lights_fragment_end>"),h&&(output.push(h.code,"reflectedLight.directDiffuse = "+h.result+";"),output.push("reflectedLight.directDiffuse *= diffuseColor;","reflectedLight.indirectDiffuse *= diffuseColor;")),d&&output.push(d.code,"reflectedLight.indirectDiffuse *= "+d.result+";"),f&&output.push(f.code,"reflectedLight.indirectDiffuse += "+f.result+";"),shadow&&output.push(shadow.code,"reflectedLight.directDiffuse *= "+shadow.result+";","reflectedLight.directSpecular *= "+shadow.result+";"),m&&output.push(m.code,"reflectedLight.directDiffuse += "+m.result+";"),output.push("vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular;"),v&&(output.push(v.code),y?output.push(y.code,"outgoingLight = mix( outgoingLight, "+v.result+", "+y.result+" );"):output.push("outgoingLight = "+v.result+";")),l?output.push("gl_FragColor = vec4( outgoingLight, "+l.result+" );"):output.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),output.push("#include <premultiplied_alpha_fragment>","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>"),code=output.join("\n")}return code},PhongNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),source.position&&(this.position=source.position),this.color=source.color,this.specular=source.specular,this.shininess=source.shininess,source.mask&&(this.mask=source.mask),source.alpha&&(this.alpha=source.alpha),source.normal&&(this.normal=source.normal),source.light&&(this.light=source.light),source.shadow&&(this.shadow=source.shadow),source.ao&&(this.ao=source.ao),source.emissive&&(this.emissive=source.emissive),source.ambient&&(this.ambient=source.ambient),source.environment&&(this.environment=source.environment),source.environmentAlpha&&(this.environmentAlpha=source.environmentAlpha)},PhongNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),this.position&&(data.position=this.position.toJSON(meta).uuid),data.color=this.color.toJSON(meta).uuid,data.specular=this.specular.toJSON(meta).uuid,data.shininess=this.shininess.toJSON(meta).uuid,this.mask&&(data.mask=this.mask.toJSON(meta).uuid),this.alpha&&(data.alpha=this.alpha.toJSON(meta).uuid),this.normal&&(data.normal=this.normal.toJSON(meta).uuid),this.light&&(data.light=this.light.toJSON(meta).uuid),this.ao&&(data.ao=this.ao.toJSON(meta).uuid),this.ambient&&(data.ambient=this.ambient.toJSON(meta).uuid),this.shadow&&(data.shadow=this.shadow.toJSON(meta).uuid),this.emissive&&(data.emissive=this.emissive.toJSON(meta).uuid),this.environment&&(data.environment=this.environment.toJSON(meta).uuid),this.environmentAlpha&&(data.environmentAlpha=this.environmentAlpha.toJSON(meta).uuid)),data},SpriteNode.prototype=Object.create(Node$1.prototype),SpriteNode.prototype.constructor=SpriteNode,SpriteNode.prototype.nodeType="Sprite",SpriteNode.prototype.build=function(e){if(e.define("SPRITE"),e.requires.lights=!1,e.requires.transparent=void 0!==this.alpha,e.isShader("vertex")){var t=this.position?this.position.parseAndBuildCode(e,"v3",{cache:"position"}):void 0;e.mergeUniform(UniformsUtils.merge([UniformsLib.fog])),e.addParsCode(["#include <fog_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n")),output=["#include <clipping_planes_fragment>","#include <begin_vertex>"],t&&output.push(t.code,t.result?"transformed = "+t.result+";":""),output.push("#include <project_vertex>","#include <fog_vertex>","mat4 modelViewMtx = modelViewMatrix;","mat4 modelMtx = modelMatrix;","modelMtx[3][0] = 0.0;","modelMtx[3][1] = 0.0;","modelMtx[3][2] = 0.0;"),this.spherical||output.push("modelMtx[1][1] = 1.0;"),output.push("modelViewMtx[0][0] = 1.0;","modelViewMtx[0][1] = 0.0;","modelViewMtx[0][2] = 0.0;"),this.spherical&&output.push("modelViewMtx[1][0] = 0.0;","modelViewMtx[1][1] = 1.0;","modelViewMtx[1][2] = 0.0;"),output.push("modelViewMtx[2][0] = 0.0;","modelViewMtx[2][1] = 0.0;","modelViewMtx[2][2] = 1.0;","gl_Position = projectionMatrix * modelViewMtx * modelMtx * vec4( transformed, 1.0 );","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","#include <fog_vertex>")}else{e.addParsCode(["#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>"].join("\n")),e.addCode(["#include <clipping_planes_fragment>","#include <logdepthbuf_fragment>"].join("\n")),this.mask&&this.mask.parse(e),this.alpha&&this.alpha.parse(e),this.color.parse(e,{slot:"color"});var mask=this.mask?this.mask.buildCode(e,"b"):void 0,r=this.alpha?this.alpha.buildCode(e,"f"):void 0,n=this.color.buildCode(e,"c",{slot:"color"}),output=[];mask&&output.push(mask.code,"if ( ! "+mask.result+" ) discard;"),r?output.push(r.code,"#ifdef ALPHATEST","if ( "+r.result+" <= ALPHATEST ) discard;","#endif",n.code,"gl_FragColor = vec4( "+n.result+", "+r.result+" );"):output.push(n.code,"gl_FragColor = vec4( "+n.result+", 1.0 );"),output.push("#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>")}return output.join("\n")},SpriteNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),source.position&&(this.position=source.position),this.color=source.color,void 0!==source.spherical&&(this.spherical=source.spherical),source.mask&&(this.mask=source.mask),source.alpha&&(this.alpha=source.alpha)},SpriteNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),this.position&&(data.position=this.position.toJSON(meta).uuid),data.color=this.color.toJSON(meta).uuid,!1===this.spherical&&(data.spherical=!1),this.mask&&(data.mask=this.mask.toJSON(meta).uuid),this.alpha&&(data.alpha=this.alpha.toJSON(meta).uuid)),data},PhongNodeMaterial.prototype=Object.create(NodeMaterial.prototype),PhongNodeMaterial.prototype.constructor=PhongNodeMaterial,NodeUtils.addShortcuts(PhongNodeMaterial.prototype,"fragment",["color","alpha","specular","shininess","normal","emissive","ambient","light","shadow","ao","environment","environmentAlpha","mask","position"]),SpriteNodeMaterial.prototype=Object.create(NodeMaterial.prototype),SpriteNodeMaterial.prototype.constructor=SpriteNodeMaterial,NodeUtils.addShortcuts(SpriteNodeMaterial.prototype,"fragment",["color","alpha","mask","position","spherical"]),StandardNodeMaterial.prototype=Object.create(NodeMaterial.prototype),StandardNodeMaterial.prototype.constructor=StandardNodeMaterial,NodeUtils.addShortcuts(StandardNodeMaterial.prototype,"fragment",["color","alpha","roughness","metalness","reflectivity","clearCoat","clearCoatRoughness","normal","emissive","ambient","light","shadow","ao","environment","mask","position"]),CondNode.EQUAL="==",CondNode.NOT_EQUAL="!=",CondNode.GREATER=">",CondNode.GREATER_EQUAL=">=",CondNode.LESS="<",CondNode.LESS_EQUAL="<=",CondNode.prototype=Object.create(TempNode.prototype),CondNode.prototype.constructor=CondNode,CondNode.prototype.nodeType="Cond",CondNode.prototype.getType=function(e){if(this.ifNode){var t=this.ifNode.getType(e),r=this.elseNode.getType(e);return e.getTypeLength(r)>e.getTypeLength(t)?r:t}return"b"},CondNode.prototype.getCondType=function(e){return e.getTypeLength(this.b.getType(e))>e.getTypeLength(this.a.getType(e))?this.b.getType(e):this.a.getType(e)},CondNode.prototype.generate=function(e,output){var code,t=this.getType(e),r=this.getCondType(e),a=this.a.build(e,r),b=this.b.build(e,r);if(this.ifNode){var n=this.ifNode.build(e,t),o=this.elseNode.build(e,t);code="( "+[a,this.op,b,"?",n,":",o].join(" ")+" )"}else code="( "+a+" "+this.op+" "+b+" )";return e.format(code,this.getType(e),output)},CondNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.a=source.a,this.b=source.b,this.op=source.op,this.ifNode=source.ifNode,this.elseNode=source.elseNode},CondNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).a=this.a.toJSON(meta).uuid,data.b=this.b.toJSON(meta).uuid,data.op=this.op,data.ifNode&&(data.ifNode=this.ifNode.toJSON(meta).uuid),data.elseNode&&(data.elseNode=this.elseNode.toJSON(meta).uuid)),data},Math1Node.RAD="radians",Math1Node.DEG="degrees",Math1Node.EXP="exp",Math1Node.EXP2="exp2",Math1Node.LOG="log",Math1Node.LOG2="log2",Math1Node.SQRT="sqrt",Math1Node.INV_SQRT="inversesqrt",Math1Node.FLOOR="floor",Math1Node.CEIL="ceil",Math1Node.NORMALIZE="normalize",Math1Node.FRACT="fract",Math1Node.SATURATE="saturate",Math1Node.SIN="sin",Math1Node.COS="cos",Math1Node.TAN="tan",Math1Node.ASIN="asin",Math1Node.ACOS="acos",Math1Node.ARCTAN="atan",Math1Node.ABS="abs",Math1Node.SIGN="sign",Math1Node.LENGTH="length",Math1Node.NEGATE="negate",Math1Node.INVERT="invert",Math1Node.prototype=Object.create(TempNode.prototype),Math1Node.prototype.constructor=Math1Node,Math1Node.prototype.nodeType="Math1",Math1Node.prototype.getType=function(e){switch(this.method){case Math1Node.LENGTH:return"f"}return this.a.getType(e)},Math1Node.prototype.generate=function(e,output){var t=this.getType(e),r=this.a.build(e,t);switch(this.method){case Math1Node.NEGATE:r="( -"+r+" )";break;case Math1Node.INVERT:r="( 1.0 - "+r+" )";break;default:r=this.method+"( "+r+" )"}return e.format(r,t,output)},Math1Node.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.a=source.a,this.method=source.method},Math1Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).a=this.a.toJSON(meta).uuid,data.method=this.method),data},Math2Node.MIN="min",Math2Node.MAX="max",Math2Node.MOD="mod",Math2Node.STEP="step",Math2Node.REFLECT="reflect",Math2Node.DISTANCE="distance",Math2Node.DOT="dot",Math2Node.CROSS="cross",Math2Node.POW="pow",Math2Node.prototype=Object.create(TempNode.prototype),Math2Node.prototype.constructor=Math2Node,Math2Node.prototype.nodeType="Math2",Math2Node.prototype.getInputType=function(e){return e.getTypeLength(this.b.getType(e))>e.getTypeLength(this.a.getType(e))?this.b.getType(e):this.a.getType(e)},Math2Node.prototype.getType=function(e){switch(this.method){case Math2Node.DISTANCE:case Math2Node.DOT:return"f";case Math2Node.CROSS:return"v3"}return this.getInputType(e)},Math2Node.prototype.generate=function(e,output){var a,b,t=this.getInputType(e),r=e.getTypeLength(this.a.getType(e)),n=e.getTypeLength(this.b.getType(e));switch(this.method){case Math2Node.CROSS:a=this.a.build(e,"v3"),b=this.b.build(e,"v3");break;case Math2Node.STEP:a=this.a.build(e,1===r?"f":t),b=this.b.build(e,t);break;case Math2Node.MIN:case Math2Node.MAX:case Math2Node.MOD:a=this.a.build(e,t),b=this.b.build(e,1===n?"f":t);break;default:a=this.a.build(e,t),b=this.b.build(e,t)}return e.format(this.method+"( "+a+", "+b+" )",this.getType(e),output)},Math2Node.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.a=source.a,this.b=source.b,this.method=source.method},Math2Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).a=this.a.toJSON(meta).uuid,data.b=this.b.toJSON(meta).uuid,data.method=this.method),data},Math3Node.MIX="mix",Math3Node.CLAMP="clamp",Math3Node.REFRACT="refract",Math3Node.SMOOTHSTEP="smoothstep",Math3Node.FACEFORWARD="faceforward",Math3Node.prototype=Object.create(TempNode.prototype),Math3Node.prototype.constructor=Math3Node,Math3Node.prototype.nodeType="Math3",Math3Node.prototype.getType=function(e){var a=e.getTypeLength(this.a.getType(e)),b=e.getTypeLength(this.b.getType(e)),t=e.getTypeLength(this.c.getType(e));return a>b&&a>t?this.a.getType(e):b>t?this.b.getType(e):this.c.getType(e)},Math3Node.prototype.generate=function(e,output){e.getTypeLength(this.a.getType(e)),e.getTypeLength(this.b.getType(e));var a,b,t,r=e.getTypeLength(this.c.getType(e)),n=this.getType(e);switch(this.method){case Math3Node.REFRACT:a=this.a.build(e,n),b=this.b.build(e,n),t=this.c.build(e,"f");break;case Math3Node.MIX:a=this.a.build(e,n),b=this.b.build(e,n),t=this.c.build(e,1===r?"f":n);break;default:a=this.a.build(e,n),b=this.b.build(e,n),t=this.c.build(e,n)}return e.format(this.method+"( "+a+", "+b+", "+t+" )",n,output)},Math3Node.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.a=source.a,this.b=source.b,this.c=source.c,this.method=source.method},Math3Node.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).a=this.a.toJSON(meta).uuid,data.b=this.b.toJSON(meta).uuid,data.c=this.c.toJSON(meta).uuid,data.method=this.method),data},BumpMapNode.Nodes=(dHdxy_fwd=new FunctionNode(["vec2 dHdxy_fwd( sampler2D bumpMap, vec2 vUv, float bumpScale ) {","\tvec2 dSTdx = dFdx( vUv );","\tvec2 dSTdy = dFdy( vUv );","\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;","\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","\treturn vec2( dBx, dBy );","}"].join("\n"),null,{derivatives:!0}),{dHdxy_fwd:dHdxy_fwd,perturbNormalArb:new FunctionNode(["vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );","\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );","\tvec3 vN = surf_norm;","\tvec3 R1 = cross( vSigmaY, vN );","\tvec3 R2 = cross( vN, vSigmaX );","\tfloat fDet = dot( vSigmaX, R1 );","\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );","\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","\treturn normalize( abs( fDet ) * surf_norm - vGrad );","}"].join("\n"),[dHdxy_fwd],{derivatives:!0}),bumpToNormal:new FunctionNode(["vec3 bumpToNormal( sampler2D bumpMap, vec2 uv, float scale ) {","\tvec2 dSTdx = dFdx( uv );","\tvec2 dSTdy = dFdy( uv );","\tfloat Hll = texture2D( bumpMap, uv ).x;","\tfloat dBx = texture2D( bumpMap, uv + dSTdx ).x - Hll;","\tfloat dBy = texture2D( bumpMap, uv + dSTdy ).x - Hll;","\treturn vec3( .5 - ( dBx * scale ), .5 - ( dBy * scale ), 1.0 );","}"].join("\n"),null,{derivatives:!0})}),BumpMapNode.prototype=Object.create(TempNode.prototype),BumpMapNode.prototype.constructor=BumpMapNode,BumpMapNode.prototype.nodeType="BumpMap",BumpMapNode.prototype.generate=function(e,output){if(e.isShader("fragment")){if(this.toNormalMap){var t=e.include(BumpMapNode.Nodes.bumpToNormal);return e.format(t+"( "+this.value.build(e,"sampler2D")+", "+this.value.uv.build(e,"v2")+", "+this.scale.build(e,"f")+" )",this.getType(e),output)}var r=e.include(BumpMapNode.Nodes.dHdxy_fwd),n=e.include(BumpMapNode.Nodes.perturbNormalArb);this.normal=this.normal||new NormalNode$1,this.position=this.position||new PositionNode(PositionNode.VIEW);var o=r+"( "+this.value.build(e,"sampler2D")+", "+this.value.uv.build(e,"v2")+", "+this.scale.build(e,"f")+" )";return e.format(n+"( -"+this.position.build(e,"v3")+", "+this.normal.build(e,"v3")+", "+o+" )",this.getType(e),output)}return console.warn("BumpMapNode is not compatible with "+e.shader+" shader."),e.format("vec3( 0.0 )",this.getType(e),output)},BumpMapNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.value=source.value,this.scale=source.scale},BumpMapNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).value=this.value.toJSON(meta).uuid,data.scale=this.scale.toJSON(meta).uuid),data};var Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1};Object.assign(Pass.prototype,{setSize:function(e,t){},render:function(e,t,r,n,o){console.error("Pass: .render() must be implemented in derived pass.")}});var ShaderPass=function(e,t){Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=UniformsUtils.clone(e.uniforms),this.material=new ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};function NodePass(){ShaderPass.call(this),this.name="",this.uuid=_Math.generateUUID(),this.userData={},this.textureID="renderTexture",this.input=new ScreenNode,this.material=new NodeMaterial,this.needsUpdate=!0}function NodePostProcessing(e,t){if(void 0===t){var r={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat,stencilBuffer:!1},n=e.getDrawingBufferSize(new Vector2);t=new WebGLRenderTarget(n.width,n.height,r)}this.renderer=e,this.renderTarget=t,this.output=new ScreenNode,this.material=new NodeMaterial,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),this.material),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.needsUpdate=!0}function CheckerNode(e){TempNode.call(this,"f"),this.uv=e||new UVNode}function NoiseNode(e){TempNode.call(this,"f"),this.uv=e||new UVNode}function BypassNode(code,e){Node$1.call(this),this.code=code,this.value=e}ShaderPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:ShaderPass,render:function(e,t,r,n,o){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.quad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera))}}),NodePass.prototype=Object.create(ShaderPass.prototype),NodePass.prototype.constructor=NodePass,NodePass.prototype.render=function(){this.needsUpdate&&(this.material.dispose(),this.material.fragment.value=this.input,this.needsUpdate=!1),this.uniforms=this.material.uniforms,ShaderPass.prototype.render.apply(this,arguments)},NodePass.prototype.copy=function(source){this.input=source.input},NodePass.prototype.toJSON=function(meta){if((void 0===meta||"string"==typeof meta)&&(meta={nodes:{}}),meta&&!meta.passes&&(meta.passes={}),!meta.passes[this.uuid]){var data={};data.uuid=this.uuid,data.type="NodePass",meta.passes[this.uuid]=data,""!==this.name&&(data.name=this.name),"{}"!==JSON.stringify(this.userData)&&(data.userData=this.userData),data.input=this.input.toJSON(meta).uuid}return meta.pass=this.uuid,meta},NodePostProcessing.prototype={constructor:NodePostProcessing,render:function(e,t,r){this.needsUpdate&&(this.material.dispose(),this.material.fragment.value=this.output,this.material.build(),this.material.uniforms.renderTexture&&(this.material.uniforms.renderTexture.value=this.renderTarget.texture),this.needsUpdate=!1),r.setRenderer(this.renderer).setRenderTexture(this.renderTarget.texture),this.renderer.setRenderTarget(this.renderTarget),this.renderer.render(e,t),r.updateNode(this.material),this.renderer.setRenderTarget(null),this.renderer.render(this.scene,this.camera)},setSize:function(e,t){this.renderTarget.setSize(e,t),this.renderer.setSize(e,t)},copy:function(source){this.output=source.output},toJSON:function(meta){if((void 0===meta||"string"==typeof meta)&&(meta={nodes:{}}),meta&&!meta.post&&(meta.post={}),!meta.post[this.uuid]){var data={};data.uuid=this.uuid,data.type="NodePostProcessing",meta.post[this.uuid]=data,""!==this.name&&(data.name=this.name),"{}"!==JSON.stringify(this.userData)&&(data.userData=this.userData),data.output=this.output.toJSON(meta).uuid}return meta.post=this.uuid,meta}},CheckerNode.prototype=Object.create(TempNode.prototype),CheckerNode.prototype.constructor=CheckerNode,CheckerNode.prototype.nodeType="Noise",CheckerNode.Nodes={checker:new FunctionNode(["float checker( vec2 uv ) {","\tfloat cx = floor( uv.x );","\tfloat cy = floor( uv.y ); ","\tfloat result = mod( cx + cy, 2.0 );","\treturn sign( result );","}"].join("\n"))},CheckerNode.prototype.generate=function(e,output){var t=e.include(CheckerNode.Nodes.checker);return e.format(t+"( "+this.uv.build(e,"v2")+" )",this.getType(e),output)},CheckerNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.uv=source.uv},CheckerNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).uv=this.uv.toJSON(meta).uuid),data},NoiseNode.prototype=Object.create(TempNode.prototype),NoiseNode.prototype.constructor=NoiseNode,NoiseNode.prototype.nodeType="Noise",NoiseNode.Nodes={snoise:new FunctionNode(["float snoise(vec2 co) {","\treturn fract( sin( dot( co.xy, vec2( 12.9898, 78.233 ) ) ) * 43758.5453 );","}"].join("\n"))},NoiseNode.prototype.generate=function(e,output){var t=e.include(NoiseNode.Nodes.snoise);return e.format(t+"( "+this.uv.build(e,"v2")+" )",this.getType(e),output)},NoiseNode.prototype.copy=function(source){TempNode.prototype.copy.call(this,source),this.uv=source.uv},NoiseNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).uv=this.uv.toJSON(meta).uuid),data},BypassNode.prototype=Object.create(Node$1.prototype),BypassNode.prototype.constructor=BypassNode,BypassNode.prototype.nodeType="Bypass",BypassNode.prototype.getType=function(e){return this.value?this.value.getType(e):e.isShader("fragment")?"f":"void"},BypassNode.prototype.generate=function(e,output){var code=this.code.build(e,output)+";";return e.addNodeCode(code),e.isShader("vertex")?this.value?this.value.build(e,output):void 0:this.value?this.value.build(e,output):e.format("0.0","f",output)},BypassNode.prototype.copy=function(source){Node$1.prototype.copy.call(this,source),this.code=source.code,this.value=source.value},BypassNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).code=this.code.toJSON(meta).uuid,this.value&&(data.value=this.value.toJSON(meta).uuid)),data};var inputs=NodeUtils.elements;function JoinNode(e,t,r,n){TempNode.call(this,"f"),this.x=e,this.y=t,this.z=r,this.w=n}function TimerNode(e,t,r){FloatNode.call(this),this.scale=void 0!==e?e:1,this.scope=t||TimerNode.GLOBAL,this.timeScale=void 0!==r?r:void 0!==e}function UVTransformNode(e,t){ExpressionNode.call(this,"( uvTransform * vec3( uvNode, 1 ) ).xy","vec2"),this.uv=e||new UVNode,this.position=t||new Matrix3Node}function VelocityNode(e,t){Vector3Node.call(this),this.params={},this.velocity=new Vector3,this.setTarget(e),this.setParams(t)}function Clock(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}JoinNode.prototype=Object.create(TempNode.prototype),JoinNode.prototype.constructor=JoinNode,JoinNode.prototype.nodeType="Join",JoinNode.prototype.getNumElements=function(){for(var i=inputs.length;i--;)if(void 0!==this[inputs[i]]){++i;break}return Math.max(i,2)},JoinNode.prototype.getType=function(e){return e.getTypeFromLength(this.getNumElements())},JoinNode.prototype.generate=function(e,output){for(var t=this.getType(e),r=this.getNumElements(),n=[],i=0;i<r;i++){var o=this[inputs[i]];n.push(o?o.build(e,"f"):"0.0")}var code=(r>1?e.getConstructorFromLength(r):"")+"( "+n.join(", ")+" )";return e.format(code,t,output)},JoinNode.prototype.copy=function(source){for(var e in TempNode.prototype.copy.call(this,source),source.inputs)this[e]=source.inputs[e]},JoinNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);if(!data){(data=this.createJSONNode(meta)).inputs={};for(var e=this.getNumElements(),i=0;i<e;i++){var t=this[inputs[i]];t&&(data.inputs[inputs[i]]=t.toJSON(meta).uuid)}}return data},TimerNode.GLOBAL="global",TimerNode.LOCAL="local",TimerNode.DELTA="delta",TimerNode.prototype=Object.create(FloatNode.prototype),TimerNode.prototype.constructor=TimerNode,TimerNode.prototype.nodeType="Timer",TimerNode.prototype.getReadonly=function(){return!1},TimerNode.prototype.getUnique=function(){return this.timeScale&&(this.scope===TimerNode.GLOBAL||this.scope===TimerNode.DELTA)},TimerNode.prototype.updateFrame=function(e){var t=this.timeScale?this.scale:1;switch(this.scope){case TimerNode.LOCAL:this.value+=e.delta*t;break;case TimerNode.DELTA:this.value=e.delta*t;break;default:this.value=e.time*t}},TimerNode.prototype.copy=function(source){FloatNode.prototype.copy.call(this,source),this.scope=source.scope,this.scale=source.scale,this.timeScale=source.timeScale},TimerNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).scope=this.scope,data.scale=this.scale,data.timeScale=this.timeScale),data},NodeLib.addKeyword("time",(function(){return new TimerNode})),UVTransformNode.prototype=Object.create(ExpressionNode.prototype),UVTransformNode.prototype.constructor=UVTransformNode,UVTransformNode.prototype.nodeType="UVTransform",UVTransformNode.prototype.generate=function(e,output){return this.keywords.uvNode=this.uv,this.keywords.uvTransform=this.position,ExpressionNode.prototype.generate.call(this,e,output)},UVTransformNode.prototype.setUvTransform=function(e,t,r,n,o,l,c){l=void 0!==l?l:.5,c=void 0!==c?c:.5,this.position.value.setUvTransform(e,t,r,n,o,l,c)},UVTransformNode.prototype.copy=function(source){ExpressionNode.prototype.copy.call(this,source),this.uv=source.uv,this.position=source.position},UVTransformNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||((data=this.createJSONNode(meta)).uv=this.uv.toJSON(meta).uuid,data.position=this.position.toJSON(meta).uuid),data},VelocityNode.prototype=Object.create(Vector3Node.prototype),VelocityNode.prototype.constructor=VelocityNode,VelocityNode.prototype.nodeType="Velocity",VelocityNode.prototype.getReadonly=function(e){return!1},VelocityNode.prototype.setParams=function(e){switch(this.params.type){case"elastic":delete this.moment,delete this.speed,delete this.springVelocity,delete this.lastVelocity}switch(this.params=e||{},this.params.type){case"elastic":this.moment=new Vector3,this.speed=new Vector3,this.springVelocity=new Vector3,this.lastVelocity=new Vector3}},VelocityNode.prototype.setTarget=function(e){this.target&&(delete this.position,delete this.oldPosition),this.target=e,e&&(this.position=e.getWorldPosition(this.position||new Vector3),this.oldPosition=this.position.clone())},VelocityNode.prototype.updateFrameVelocity=function(e){this.target&&(this.position=this.target.getWorldPosition(this.position||new Vector3),this.velocity.subVectors(this.position,this.oldPosition),this.oldPosition.copy(this.position))},VelocityNode.prototype.updateFrame=function(e){switch(this.updateFrameVelocity(e),this.params.type){case"elastic":var t=e.delta*(this.params.fps||60),r=Math.pow(this.params.spring,t),n=Math.pow(this.params.damping,t);this.velocity.multiplyScalar(Math.exp(-this.params.damping*t)),this.velocity.add(this.springVelocity),this.velocity.add(this.speed.multiplyScalar(n).multiplyScalar(1-r)),this.speed.subVectors(this.velocity,this.lastVelocity),this.springVelocity.add(this.speed),this.springVelocity.multiplyScalar(r),this.moment.add(this.springVelocity),this.moment.multiplyScalar(n),this.lastVelocity.copy(this.velocity),this.value.copy(this.moment);break;default:this.value.copy(this.velocity)}},VelocityNode.prototype.copy=function(source){Vector3Node.prototype.copy.call(this,source),source.target&&object.setTarget(source.target),object.setParams(source.params)},VelocityNode.prototype.toJSON=function(meta){var data=this.getJSONNode(meta);return data||(data=this.createJSONNode(meta),this.target&&(data.target=this.target.uuid),data.params=JSON.parse(JSON.stringify(this.params))),data},Object.assign(Clock.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}});var Fire=function(e,t){Mesh.call(this,e),this.type="Fire",this.clock=new Clock;var r=(t=t||{}).textureWidth||512,n=t.textureHeight||512,o=1/r,l=1/n,c=void 0!==t.debug&&t.debug;this.color1=t.color1||new Color(16777215),this.color2=t.color2||new Color(16752640),this.color3=t.color3||new Color(0),this.colorBias=void 0===t.colorBias?.8:t.colorBias,this.diffuse=void 0===t.diffuse?1.33:t.diffuse,this.viscosity=void 0===t.viscosity?.25:t.viscosity,this.expansion=void 0===t.expansion?-.25:t.expansion,this.swirl=void 0===t.swirl?50:t.swirl,this.burnRate=void 0===t.burnRate?.3:t.burnRate,this.drag=void 0===t.drag?.35:t.drag,this.airSpeed=void 0===t.airSpeed?6:t.airSpeed,this.windVector=t.windVector||new Vector2(0,.75),this.speed=void 0===t.speed?500:t.speed,this.massConservation=void 0!==t.massConservation&&t.massConservation;var h=r*n;this.sourceData=new Uint8Array(4*h),this.clearSources=function(){for(var e=0;e<n;e++)for(var t=0;t<r;t++){var o=4*(e*r+t);this.sourceData[o]=0,this.sourceData[o+1]=0,this.sourceData[o+2]=0,this.sourceData[o+3]=0}return this.sourceMaterial.uniforms.sourceMap.value=this.internalSource,this.sourceMaterial.needsUpdate=!0,this.sourceData},this.addSource=function(u,e,t,c,h,d){void 0===c&&(c=null),void 0===h&&(h=null),void 0===d&&(d=null);for(var f=Math.max(Math.floor((u-t)*r),0),m=Math.max(Math.floor((e-t)*n),0),v=Math.min(Math.floor((u+t)*r),r),y=Math.min(Math.floor((e+t)*n),n),x=m;x<y;x++)for(var w=f;w<v;w++){var M=w*o-u,S=x*l-e;if(M*M+S*S<t*t){var A,T=4*(x*r+w);if(null!=c&&(this.sourceData[T]=255*Math.min(Math.max(c,0),1)),null!=h)A=(A=Math.min(Math.max(h,-1),1))<0?Math.floor(127*A)+255:Math.floor(127*A),this.sourceData[T+1]=A;if(null!=d)A=(A=Math.min(Math.max(d,-1),1))<0?Math.floor(127*A)+255:Math.floor(127*A),this.sourceData[T+2]=A}}return this.internalSource.needsUpdate=!0,this.sourceData},this.setSourceMap=function(e){this.sourceMaterial.uniforms.sourceMap.value=e};var d={minFilter:NearestFilter,magFilter:NearestFilter,depthBuffer:!1,stencilBuffer:!1};this.field0=new WebGLRenderTarget(r,n,d),this.field0.background=new Color(0),this.field1=new WebGLRenderTarget(r,n,d),this.field0.background=new Color(0),this.fieldProj=new WebGLRenderTarget(r,n,d),this.field0.background=new Color(0),_Math.isPowerOfTwo(r)&&_Math.isPowerOfTwo(n)||(this.field0.texture.generateMipmaps=!1,this.field1.texture.generateMipmaps=!1,this.fieldProj.texture.generateMipmaps=!1),this.fieldScene=new Scene,this.fieldScene.background=new Color(0),this.orthoCamera=new OrthographicCamera(r/-2,r/2,n/2,n/-2,1,2),this.orthoCamera.position.z=1,this.fieldGeometry=new PlaneBufferGeometry(r,n),this.internalSource=new DataTexture(this.sourceData,r,n,RGBAFormat);var f=Fire.SourceShader;this.sourceMaterial=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.clearSources(),this.sourceMesh=new Mesh(this.fieldGeometry,this.sourceMaterial),this.fieldScene.add(this.sourceMesh);f=Fire.DiffuseShader;this.diffuseMaterial=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.diffuseMaterial.uniforms.oneOverWidth.value=o,this.diffuseMaterial.uniforms.oneOverHeight.value=l,this.diffuseMesh=new Mesh(this.fieldGeometry,this.diffuseMaterial),this.fieldScene.add(this.diffuseMesh),f=Fire.DriftShader,this.driftMaterial=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.driftMaterial.uniforms.oneOverWidth.value=o,this.driftMaterial.uniforms.oneOverHeight.value=l,this.driftMesh=new Mesh(this.fieldGeometry,this.driftMaterial),this.fieldScene.add(this.driftMesh),f=Fire.ProjectionShader1,this.projMaterial1=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.projMaterial1.uniforms.oneOverWidth.value=o,this.projMaterial1.uniforms.oneOverHeight.value=l,this.projMesh1=new Mesh(this.fieldGeometry,this.projMaterial1),this.fieldScene.add(this.projMesh1),f=Fire.ProjectionShader2,this.projMaterial2=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.projMaterial2.uniforms.oneOverWidth.value=o,this.projMaterial2.uniforms.oneOverHeight.value=l,this.projMesh2=new Mesh(this.fieldGeometry,this.projMaterial2),this.fieldScene.add(this.projMesh2),f=Fire.ProjectionShader3,this.projMaterial3=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!1}),this.projMaterial3.uniforms.oneOverWidth.value=o,this.projMaterial3.uniforms.oneOverHeight.value=l,this.projMesh3=new Mesh(this.fieldGeometry,this.projMaterial3),this.fieldScene.add(this.projMesh3),f=c?Fire.DebugShader:Fire.ColorShader,this.material=new ShaderMaterial({uniforms:f.uniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,transparent:!0}),this.material.uniforms.densityMap.value=this.field1.texture,this.configShaders=function(dt){this.diffuseMaterial.uniforms.diffuse.value=.05*dt*this.diffuse,this.diffuseMaterial.uniforms.viscosity.value=.05*dt*this.viscosity,this.diffuseMaterial.uniforms.expansion.value=Math.exp(-1*this.expansion),this.diffuseMaterial.uniforms.swirl.value=Math.exp(-.1*this.swirl),this.diffuseMaterial.uniforms.drag.value=Math.exp(-.1*this.drag),this.diffuseMaterial.uniforms.burnRate.value=this.burnRate*dt*.01,this.driftMaterial.uniforms.windVector.value=this.windVector,this.driftMaterial.uniforms.airSpeed.value=dt*this.airSpeed*.001*n,this.material.uniforms.color1.value=this.color1,this.material.uniforms.color2.value=this.color2,this.material.uniforms.color3.value=this.color3,this.material.uniforms.colorBias.value=this.colorBias},this.clearDiffuse=function(){this.diffuseMaterial.uniforms.expansion.value=1,this.diffuseMaterial.uniforms.swirl.value=1,this.diffuseMaterial.uniforms.drag.value=1,this.diffuseMaterial.uniforms.burnRate.value=0},this.swapTextures=function(){var e=this.field0;this.field0=this.field1,this.field1=e},this.saveRenderState=function(e){this.savedRenderTarget=e.getRenderTarget(),this.savedVrEnabled=e.vr.enabled,this.savedShadowAutoUpdate=e.shadowMap.autoUpdate,this.savedAntialias=e.antialias,this.savedToneMapping=e.toneMapping},this.restoreRenderState=function(e){e.vr.enabled=this.savedVrEnabled,e.shadowMap.autoUpdate=this.savedShadowAutoUpdate,e.setRenderTarget(this.savedRenderTarget),e.antialias=this.savedAntialias,e.toneMapping=this.savedToneMapping},this.renderSource=function(e){this.sourceMesh.visible=!0,this.sourceMaterial.uniforms.densityMap.value=this.field0.texture,e.setRenderTarget(this.field1),e.render(this.fieldScene,this.orthoCamera),this.sourceMesh.visible=!1,this.swapTextures()},this.renderDiffuse=function(e){this.diffuseMesh.visible=!0,this.diffuseMaterial.uniforms.densityMap.value=this.field0.texture,e.setRenderTarget(this.field1),e.render(this.fieldScene,this.orthoCamera),this.diffuseMesh.visible=!1,this.swapTextures()},this.renderDrift=function(e){this.driftMesh.visible=!0,this.driftMaterial.uniforms.densityMap.value=this.field0.texture,e.setRenderTarget(this.field1),e.render(this.fieldScene,this.orthoCamera),this.driftMesh.visible=!1,this.swapTextures()},this.renderProject=function(e){this.projMesh1.visible=!0,this.projMaterial1.uniforms.densityMap.value=this.field0.texture,e.setRenderTarget(this.fieldProj),e.render(this.fieldScene,this.orthoCamera),this.projMesh1.visible=!1,this.projMaterial2.uniforms.densityMap.value=this.fieldProj.texture,this.projMesh2.visible=!0;for(var i=0;i<20;i++){e.setRenderTarget(this.field1),e.render(this.fieldScene,this.orthoCamera);var t=this.field1;this.field1=this.fieldProj,this.fieldProj=t,this.projMaterial2.uniforms.densityMap.value=this.fieldProj.texture}this.projMesh2.visible=!1,this.projMaterial3.uniforms.densityMap.value=this.field0.texture,this.projMaterial3.uniforms.projMap.value=this.fieldProj.texture,this.projMesh3.visible=!0,e.setRenderTarget(this.field1),e.render(this.fieldScene,this.orthoCamera),this.projMesh3.visible=!1,this.swapTextures()},this.onBeforeRender=function(e,t,r){var n=this.clock.getDelta();n>.1&&(n=.1);var dt=n*(.1*this.speed);this.configShaders(dt),this.saveRenderState(e),e.vr.enabled=!1,e.shadowMap.autoUpdate=!1,e.antialias=!1,e.toneMapping=NoToneMapping,this.sourceMesh.visible=!1,this.diffuseMesh.visible=!1,this.driftMesh.visible=!1,this.projMesh1.visible=!1,this.projMesh2.visible=!1,this.projMesh3.visible=!1,this.renderSource(e),this.clearDiffuse();for(var i=0;i<21;i++)this.renderDiffuse(e);this.configShaders(dt),this.renderDiffuse(e),this.renderDrift(e),this.massConservation&&(this.renderProject(e),this.renderProject(e)),this.material.map=this.field1.texture,this.material.transparent=!0,this.material.minFilter=LinearFilter,this.material.magFilter=LinearFilter,this.restoreRenderState(e)}};function Box2(e,t){this.min=void 0!==e?e:new Vector2(1/0,1/0),this.max=void 0!==t?t:new Vector2(-1/0,-1/0)}Fire.prototype=Object.create(Mesh.prototype),Fire.prototype.constructor=Fire,Fire.SourceShader={uniforms:{sourceMap:{type:"t",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D sourceMap;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    vec4 source = texture2D( sourceMap, vUv );","    vec4 current = texture2D( densityMap, vUv );","    vec2 v0 = (current.gb - step(0.5, current.gb)) * 2.0;","    vec2 v1 = (source.gb - step(0.5, source.gb)) * 2.0;","    vec2 newVel = v0 + v1;","    newVel = clamp(newVel, -0.99, 0.99);","    newVel = newVel * 0.5 + step(0.0, -newVel);","    float newDensity = source.r + current.a;","    float newTemp = source.r + current.r;","    newDensity = clamp(newDensity, 0.0, 1.0);","    newTemp = clamp(newTemp, 0.0, 1.0);","    gl_FragColor = vec4(newTemp, newVel.xy, newDensity);","}"].join("\n")},Fire.DiffuseShader={uniforms:{oneOverWidth:{type:"f",value:null},oneOverHeight:{type:"f",value:null},diffuse:{type:"f",value:null},viscosity:{type:"f",value:null},expansion:{type:"f",value:null},swirl:{type:"f",value:null},drag:{type:"f",value:null},burnRate:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float oneOverWidth;","uniform float oneOverHeight;","uniform float diffuse;","uniform float viscosity;","uniform float expansion;","uniform float swirl;","uniform float burnRate;","uniform float drag;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    vec4 dC = texture2D( densityMap, vUv );","    vec4 dL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) );","    vec4 dR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) );","    vec4 dU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) );","    vec4 dD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) );","    vec4 dUL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y - oneOverHeight) );","    vec4 dUR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y - oneOverHeight) );","    vec4 dDL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y + oneOverHeight) );","    vec4 dDR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y + oneOverHeight) );","    dC.yz = (dC.yz - step(0.5, dC.yz)) * 2.0;","    dL.yz = (dL.yz - step(0.5, dL.yz)) * 2.0;","    dR.yz = (dR.yz - step(0.5, dR.yz)) * 2.0;","    dU.yz = (dU.yz - step(0.5, dU.yz)) * 2.0;","    dD.yz = (dD.yz - step(0.5, dD.yz)) * 2.0;","    dUL.yz = (dUL.yz - step(0.5, dUL.yz)) * 2.0;","    dUR.yz = (dUR.yz - step(0.5, dUR.yz)) * 2.0;","    dDL.yz = (dDL.yz - step(0.5, dDL.yz)) * 2.0;","    dDR.yz = (dDR.yz - step(0.5, dDR.yz)) * 2.0;","    vec4 result = (dC + vec4(diffuse, viscosity, viscosity, diffuse) * ( dL + dR + dU + dD + dUL + dUR + dDL + dDR )) / (1.0 + 8.0 * vec4(diffuse, viscosity, viscosity, diffuse)) - vec4(0.0, 0.0, 0.0, 0.001);","    float temperature = result.r;","    temperature = clamp(temperature - burnRate, 0.0, 1.0);","    vec2 velocity = result.yz;","    vec2 expansionVec = vec2(dL.w - dR.w, dU.w - dD.w);","    vec2 swirlVec = vec2((dL.z - dR.z) * 0.5, (dU.y - dD.y) * 0.5);","    velocity = velocity + (1.0 - expansion) * expansionVec + (1.0 - swirl) * swirlVec;","    velocity = velocity - (1.0 - drag) * velocity;","    gl_FragColor = vec4(temperature, velocity * 0.5 + step(0.0, -velocity), result.w);","    gl_FragColor = gl_FragColor * step(oneOverWidth, vUv.x);","    gl_FragColor = gl_FragColor * step(oneOverHeight, vUv.y);","    gl_FragColor = gl_FragColor * step(vUv.x, 1.0 - oneOverWidth);","    gl_FragColor = gl_FragColor * step(vUv.y, 1.0 - oneOverHeight);","}"].join("\n")},Fire.DriftShader={uniforms:{oneOverWidth:{type:"f",value:null},oneOverHeight:{type:"f",value:null},windVector:{type:"v2",value:new Vector2(0,0)},airSpeed:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float oneOverWidth;","uniform float oneOverHeight;","uniform vec2 windVector;","uniform float airSpeed;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    vec2 velocity = texture2D( densityMap, vUv ).gb;","    velocity = (velocity - step(0.5, velocity)) * 2.0;","    velocity = velocity + windVector;","    vec2 sourcePos = vUv - airSpeed * vec2(oneOverWidth, oneOverHeight) * velocity;","    vec2 units = sourcePos / vec2(oneOverWidth, oneOverHeight);","    vec2 intPos = floor(units);","    vec2 frac = units - intPos;","    intPos = intPos * vec2(oneOverWidth, oneOverHeight);","    vec4 dX0Y0 = texture2D( densityMap, intPos + vec2(0.0, -oneOverHeight) );","    vec4 dX1Y0 = texture2D( densityMap, intPos + vec2(oneOverWidth, 0.0) );","    vec4 dX0Y1 = texture2D( densityMap, intPos + vec2(0.0, oneOverHeight) );","    vec4 dX1Y1 = texture2D( densityMap, intPos + vec2(oneOverWidth, oneOverHeight) );","    dX0Y0.gb = (dX0Y0.gb - step(0.5, dX0Y0.gb)) * 2.0;","    dX1Y0.gb = (dX1Y0.gb - step(0.5, dX1Y0.gb)) * 2.0;","    dX0Y1.gb = (dX0Y1.gb - step(0.5, dX0Y1.gb)) * 2.0;","    dX1Y1.gb = (dX1Y1.gb - step(0.5, dX1Y1.gb)) * 2.0;","    vec4 source = mix(mix(dX0Y0, dX1Y0, frac.x), mix(dX0Y1, dX1Y1, frac.x), frac.y);","    source.gb = source.gb * 0.5 + step(0.0, -source.gb);","    gl_FragColor = source;","}"].join("\n")},Fire.ProjectionShader1={uniforms:{oneOverWidth:{type:"f",value:null},oneOverHeight:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float oneOverWidth;","uniform float oneOverHeight;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    float dL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;","    float dR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;","    float dU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) ).b;","    float dD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) ).b;","    dL = (dL - step(0.5, dL)) * 2.0;","    dR = (dR - step(0.5, dR)) * 2.0;","    dU = (dU - step(0.5, dU)) * 2.0;","    dD = (dD - step(0.5, dD)) * 2.0;","    float h = (oneOverWidth + oneOverHeight) * 0.5;","    float div = -0.5 * h * (dR - dL + dD - dU);","    gl_FragColor = vec4( 0.0, 0.0, div * 0.5 + step(0.0, -div), 0.0);","}"].join("\n")},Fire.ProjectionShader2={uniforms:{oneOverWidth:{type:"f",value:null},oneOverHeight:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float oneOverWidth;","uniform float oneOverHeight;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    float div = texture2D( densityMap, vUv ).b;","    float pL = texture2D( densityMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;","    float pR = texture2D( densityMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;","    float pU = texture2D( densityMap, vec2(vUv.x, vUv.y - oneOverHeight) ).g;","    float pD = texture2D( densityMap, vec2(vUv.x, vUv.y + oneOverHeight) ).g;","    float divNorm = (div - step(0.5, div)) * 2.0;","    pL = (pL - step(0.5, pL)) * 2.0;","    pR = (pR - step(0.5, pR)) * 2.0;","    pU = (pU - step(0.5, pU)) * 2.0;","    pD = (pD - step(0.5, pD)) * 2.0;","    float p = (divNorm + pR + pL + pD + pU) * 0.25;","    gl_FragColor = vec4( 0.0, p * 0.5 + step(0.0, -p), div, 0.0);","}"].join("\n")},Fire.ProjectionShader3={uniforms:{oneOverWidth:{type:"f",value:null},oneOverHeight:{type:"f",value:null},densityMap:{type:"t",value:null},projMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float oneOverWidth;","uniform float oneOverHeight;","uniform sampler2D densityMap;","uniform sampler2D projMap;","varying vec2 vUv;","void main() {","    vec4 orig = texture2D(densityMap, vUv);","    float pL = texture2D( projMap, vec2(vUv.x - oneOverWidth, vUv.y) ).g;","    float pR = texture2D( projMap, vec2(vUv.x + oneOverWidth, vUv.y) ).g;","    float pU = texture2D( projMap, vec2(vUv.x, vUv.y - oneOverHeight) ).g;","    float pD = texture2D( projMap, vec2(vUv.x, vUv.y + oneOverHeight) ).g;","    float uNorm = (orig.g - step(0.5, orig.g)) * 2.0;","    float vNorm = (orig.b - step(0.5, orig.b)) * 2.0;","    pL = (pL - step(0.5, pL)) * 2.0;","    pR = (pR - step(0.5, pR)) * 2.0;","    pU = (pU - step(0.5, pU)) * 2.0;","    pD = (pD - step(0.5, pD)) * 2.0;","    float h = (oneOverWidth + oneOverHeight) * 0.5;","    float u = uNorm - (0.5 * (pR - pL) / h);","    float v = vNorm - (0.5 * (pD - pU) / h);","    gl_FragColor = vec4( orig.r, u * 0.5 + step(0.0, -u), v * 0.5 + step(0.0, -v), orig.a);","}"].join("\n")},Fire.ColorShader={uniforms:{color1:{type:"c",value:null},color2:{type:"c",value:null},color3:{type:"c",value:null},colorBias:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color1;","uniform vec3 color2;","uniform vec3 color3;","uniform float colorBias;","uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    float density = texture2D( densityMap, vUv ).a;","    float temperature = texture2D( densityMap, vUv ).r;","    float bias = clamp(colorBias, 0.0001, 0.9999);","    vec3 blend1 = mix(color3, color2, temperature / bias) * (1.0 - step(bias, temperature));","    vec3 blend2 = mix(color2, color1, (temperature - bias) / (1.0 - bias) ) * step(bias, temperature);","    gl_FragColor = vec4(blend1 + blend2, density);","}"].join("\n")},Fire.DebugShader={uniforms:{color1:{type:"c",value:null},color2:{type:"c",value:null},color3:{type:"c",value:null},colorBias:{type:"f",value:null},densityMap:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {"," \t  vUv = uv;","     vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","     gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D densityMap;","varying vec2 vUv;","void main() {","    float density;","    density = texture2D( densityMap, vUv ).a;","    vec2 vel = texture2D( densityMap, vUv ).gb;","    vel = (vel - step(0.5, vel)) * 2.0;","    float r = density;","    float g = max(abs(vel.x), density * 0.5);","    float b = max(abs(vel.y), density * 0.5);","    float a = max(density * 0.5, max(abs(vel.x), abs(vel.y)));","    gl_FragColor = vec4(r, g, b, a);","}"].join("\n")},Object.assign(Box2.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var i=0,t=e.length;i<t;i++)this.expandByPoint(e[i]);return this},setFromCenterAndSize:function(){var e=new Vector2;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){return void 0===e&&(console.warn("Box2: .getCenter() target is now required"),e=new Vector2),this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){return void 0===e&&(console.warn("Box2: .getSize() target is now required"),e=new Vector2),this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return void 0===t&&(console.warn("Box2: .getParameter() target is now required"),t=new Vector2),t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return void 0===t&&(console.warn("Box2: .clampPoint() target is now required"),t=new Vector2),t.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector2;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}});var Lensflare=function(){Mesh.call(this,Lensflare.Geometry,new MeshBasicMaterial({opacity:0,transparent:!0})),this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;var e=new Vector3,t=new Vector3,r=new DataTexture(new Uint8Array(768),16,16,RGBFormat);r.minFilter=NearestFilter,r.magFilter=NearestFilter,r.wrapS=ClampToEdgeWrapping,r.wrapT=ClampToEdgeWrapping,r.needsUpdate=!0;var n=new DataTexture(new Uint8Array(768),16,16,RGBFormat);n.minFilter=NearestFilter,n.magFilter=NearestFilter,n.wrapS=ClampToEdgeWrapping,n.wrapT=ClampToEdgeWrapping,n.needsUpdate=!0;var o=Lensflare.Geometry,l=new RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","void main() {","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","void main() {","\tgl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );","}"].join("\n"),depthTest:!0,depthWrite:!1,transparent:!1}),c=new RawShaderMaterial({uniforms:{map:{value:r},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","varying vec2 vUV;","void main() {","\tgl_FragColor = texture2D( map, vUV );","}"].join("\n"),depthTest:!1,depthWrite:!1,transparent:!1}),h=new Mesh(o,l),d=[],f=LensflareElement.Shader,m=new RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:n},color:{value:new Color(16777215)},scale:{value:new Vector2},screenPosition:{value:new Vector3}},vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,blending:AdditiveBlending,transparent:!0,depthWrite:!1}),v=new Mesh(o,m);this.addElement=function(element){d.push(element)};var y=new Vector2,x=new Vector2,w=new Box2,M=new Vector4;this.onBeforeRender=function(f,S,A){f.getCurrentViewport(M);var T=M.w/M.z,_=M.z/2,L=M.w/2,C=16/M.w;if(y.set(C*T,C),w.min.set(M.x,M.y),w.max.set(M.x+(M.z-16),M.y+(M.w-16)),t.setFromMatrixPosition(this.matrixWorld),t.applyMatrix4(A.matrixWorldInverse),!(t.z>0)&&(e.copy(t).applyMatrix4(A.projectionMatrix),x.x=M.x+e.x*_+_-8,x.y=M.y+e.y*L+L-8,w.containsPoint(x))){f.copyFramebufferToTexture(x,r),(D=l.uniforms).scale.value=y,D.screenPosition.value=e,f.renderBufferDirect(A,null,o,l,h,null),f.copyFramebufferToTexture(x,n),(D=c.uniforms).scale.value=y,D.screenPosition.value=e,f.renderBufferDirect(A,null,o,c,h,null);for(var N=2*-e.x,P=2*-e.y,i=0,E=d.length;i<E;i++){var D,element=d[i];(D=m.uniforms).color.value.copy(element.color),D.map.value=element.texture,D.screenPosition.value.x=e.x+N*element.distance,D.screenPosition.value.y=e.y+P*element.distance;C=element.size/M.w,T=M.w/M.z;D.scale.value.set(C*T,C),m.uniformsNeedUpdate=!0,f.renderBufferDirect(A,null,o,m,v,null)}}},this.dispose=function(){l.dispose(),c.dispose(),m.dispose(),r.dispose(),n.dispose();for(var i=0,e=d.length;i<e;i++)d[i].texture.dispose()}};Lensflare.prototype=Object.create(Mesh.prototype),Lensflare.prototype.constructor=Lensflare,Lensflare.prototype.isLensflare=!0;var LensflareElement=function(e,t,r,n){this.texture=e,this.size=t||1,this.distance=r||0,this.color=n||new Color(16777215)};LensflareElement.Shader={uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:["precision highp float;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform sampler2D occlusionMap;","attribute vec3 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvUV = uv;","\tvec2 pos = position.xy;","\tvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","\tvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","\tvVisibility =        visibility.r / 9.0;","\tvVisibility *= 1.0 - visibility.g / 9.0;","\tvVisibility *=       visibility.b / 9.0;","\tgl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","uniform sampler2D map;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","\tvec4 texture = texture2D( map, vUV );","\ttexture.a *= vVisibility;","\tgl_FragColor = texture;","\tgl_FragColor.rgb *= color;","}"].join("\n")},Lensflare.Geometry=function(){var e=new BufferGeometry,t=new InterleavedBuffer(new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),5);return e.setIndex([0,1,2,0,2,3]),e.addAttribute("position",new InterleavedBufferAttribute(t,3,0,!1)),e.addAttribute("uv",new InterleavedBufferAttribute(t,2,3,!1)),e}();var LightningStorm=function(e){Object3D.call(this),e=e||{},this.stormParams=e,e.size=void 0!==e.size?e.size:1e3,e.minHeight=void 0!==e.minHeight?e.minHeight:80,e.maxHeight=void 0!==e.maxHeight?e.maxHeight:100,e.maxSlope=void 0!==e.maxSlope?e.maxSlope:1.1,e.maxLightnings=void 0!==e.maxLightnings?e.maxLightnings:3,e.lightningMinPeriod=void 0!==e.lightningMinPeriod?e.lightningMinPeriod:3,e.lightningMaxPeriod=void 0!==e.lightningMaxPeriod?e.lightningMaxPeriod:7,e.lightningMinDuration=void 0!==e.lightningMinDuration?e.lightningMinDuration:1,e.lightningMaxDuration=void 0!==e.lightningMaxDuration?e.lightningMaxDuration:2.5,this.lightningParameters=LightningStrike.copyParameters(e.lightningParameters,e.lightningParameters),this.lightningParameters.isEternal=!1,this.lightningMaterial=void 0!==e.lightningMaterial?e.lightningMaterial:new MeshBasicMaterial({color:11599871}),void 0!==e.onRayPosition?this.onRayPosition=e.onRayPosition:this.onRayPosition=function(source,t){t.set((Math.random()-.5)*e.size,0,(Math.random()-.5)*e.size);var r=_Math.lerp(e.minHeight,e.maxHeight,Math.random());source.set(e.maxSlope*(2*Math.random()-1),1,e.maxSlope*(2*Math.random()-1)).multiplyScalar(r).add(t)},this.onLightningDown=e.onLightningDown,this.inited=!1,this.nextLightningTime=0,this.lightningsMeshes=[],this.deadLightningsMeshes=[];for(var i=0;i<this.stormParams.maxLightnings;i++){var t=new Mesh(new LightningStrike(LightningStrike.copyParameters({},this.lightningParameters)),this.lightningMaterial);this.deadLightningsMeshes.push(t)}};LightningStorm.prototype=Object.create(Object3D.prototype),LightningStorm.prototype.constructor=LightningStorm,LightningStorm.prototype.isLightningStorm=!0,LightningStorm.prototype.update=function(time){if(this.inited||(this.nextLightningTime=this.getNextLightningTime(time)*Math.random(),this.inited=!0),time>=this.nextLightningTime){var e=this.deadLightningsMeshes.pop();if(e){var t=LightningStrike.copyParameters(e.geometry.rayParameters,this.lightningParameters);t.birthTime=time,t.deathTime=time+_Math.lerp(this.stormParams.lightningMinDuration,this.stormParams.lightningMaxDuration,Math.random()),this.onRayPosition(t.sourceOffset,t.destOffset),t.noiseSeed=Math.random(),this.add(e),this.lightningsMeshes.push(e)}this.nextLightningTime=this.getNextLightningTime(time)}var i=0;for(il=this.lightningsMeshes.length;i<il;){var r=this.lightningsMeshes[i],n=r.geometry,o=n.state;n.update(time),o===LightningStrike.RAY_PROPAGATING&&n.state>o&&this.onLightningDown&&this.onLightningDown(n),n.state===LightningStrike.RAY_EXTINGUISHED?(this.lightningsMeshes.splice(this.lightningsMeshes.indexOf(r),1),this.deadLightningsMeshes.push(r),this.remove(r),il--):i++}},LightningStorm.prototype.getNextLightningTime=function(e){return e+_Math.lerp(this.stormParams.lightningMinPeriod,this.stormParams.lightningMaxPeriod,Math.random())/(this.stormParams.maxLightnings+1)},LightningStorm.prototype.copy=function(source){return Object3D.prototype.copy.call(this,source),this.stormParams.size=source.stormParams.size,this.stormParams.minHeight=source.stormParams.minHeight,this.stormParams.maxHeight=source.stormParams.maxHeight,this.stormParams.maxSlope=source.stormParams.maxSlope,this.stormParams.maxLightnings=source.stormParams.maxLightnings,this.stormParams.lightningMinPeriod=source.stormParams.lightningMinPeriod,this.stormParams.lightningMaxPeriod=source.stormParams.lightningMaxPeriod,this.stormParams.lightningMinDuration=source.stormParams.lightningMinDuration,this.stormParams.lightningMaxDuration=source.stormParams.lightningMaxDuration,this.lightningParameters=LightningStrike.copyParameters({},source.lightningParameters),this.lightningMaterial=source.stormParams.lightningMaterial,this.onLightningDown=source.onLightningDown,this},LightningStrike.prototype.clone=function(){return new this.constructor(this.stormParams).copy(this)};var Reflector=function(e,t){Mesh.call(this,e),this.type="Reflector";var r=this,n=void 0!==(t=t||{}).color?new Color(t.color):new Color(8355711),o=t.textureWidth||512,l=t.textureHeight||512,c=t.clipBias||0,h=t.shader||Reflector.ReflectorShader,d=void 0!==t.recursion?t.recursion:0,f=new Plane,m=new Vector3,v=new Vector3,y=new Vector3,x=new Matrix4,w=new Vector3(0,0,-1),M=new Vector4,S=new Vector4,view=new Vector3,A=new Vector3,q=new Vector4,T=new Vector2,_=new Matrix4,L=new PerspectiveCamera,C=new WebGLRenderTarget(o,l,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat,stencilBuffer:!1});_Math.isPowerOfTwo(o)&&_Math.isPowerOfTwo(l)||(C.texture.generateMipmaps=!1);var N=new ShaderMaterial({uniforms:UniformsUtils.clone(h.uniforms),fragmentShader:h.fragmentShader,vertexShader:h.vertexShader});N.uniforms.tDiffuse.value=C.texture,N.uniforms.color.value=n,N.uniforms.textureMatrix.value=_,this.material=N,this.onBeforeRender=function(e,t,n){if("recursion"in n.userData){if(n.userData.recursion===d)return;n.userData.recursion++}if(v.setFromMatrixPosition(r.matrixWorld),y.setFromMatrixPosition(n.matrixWorld),x.extractRotation(r.matrixWorld),m.set(0,0,1),m.applyMatrix4(x),view.subVectors(v,y),!(view.dot(m)>0)){view.reflect(m).negate(),view.add(v),x.extractRotation(n.matrixWorld),w.set(0,0,-1),w.applyMatrix4(x),w.add(y),A.subVectors(v,w),A.reflect(m).negate(),A.add(v),L.position.copy(view),L.up.set(0,1,0),L.up.applyMatrix4(x),L.up.reflect(m),L.lookAt(A),L.far=n.far,L.updateMatrixWorld(),L.projectionMatrix.copy(n.projectionMatrix),L.userData.recursion=0,_.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),_.multiply(L.projectionMatrix),_.multiply(L.matrixWorldInverse),_.multiply(r.matrixWorld),f.setFromNormalAndCoplanarPoint(m,v),f.applyMatrix4(L.matrixWorldInverse),M.set(f.normal.x,f.normal.y,f.normal.z,f.constant);var o=L.projectionMatrix;q.x=(Math.sign(M.x)+o.elements[8])/o.elements[0],q.y=(Math.sign(M.y)+o.elements[9])/o.elements[5],q.z=-1,q.w=(1+o.elements[10])/o.elements[14],M.multiplyScalar(2/M.dot(q)),o.elements[2]=M.x,o.elements[6]=M.y,o.elements[10]=M.z+1-c,o.elements[14]=M.w,r.visible=!1;var l=e.getRenderTarget(),h=e.vr.enabled,N=e.shadowMap.autoUpdate;e.vr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(C),e.clear(),e.render(t,L),e.vr.enabled=h,e.shadowMap.autoUpdate=N,e.setRenderTarget(l);var P=n.bounds;if(void 0!==P){e.getSize(T);var E=e.getPixelRatio();S.x=P.x*T.width*E,S.y=P.y*T.height*E,S.z=P.z*T.width*E,S.w=P.w*T.height*E,e.state.viewport(S)}r.visible=!0}},this.getRenderTarget=function(){return C}};Reflector.prototype=Object.create(Mesh.prototype),Reflector.prototype.constructor=Reflector,Reflector.ReflectorShader={uniforms:{color:{type:"c",value:null},tDiffuse:{type:"t",value:null},textureMatrix:{type:"m4",value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","\tvUv = textureMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","\tvec4 base = texture2DProj( tDiffuse, vUv );","\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")};var ReflectorRTT=function(e,t){Reflector.call(this,e,t),this.geometry.setDrawRange(0,0)};ReflectorRTT.prototype=Object.create(Reflector.prototype);var Refractor=function(e,t){Mesh.call(this,e),this.type="Refractor";var r=this,n=void 0!==(t=t||{}).color?new Color(t.color):new Color(8355711),o=t.textureWidth||512,l=t.textureHeight||512,c=t.clipBias||0,h=t.shader||Refractor.RefractorShader,d=new PerspectiveCamera;d.matrixAutoUpdate=!1,d.userData.refractor=!0;var f=new Plane,m=new Matrix4,v=new WebGLRenderTarget(o,l,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat,stencilBuffer:!1});_Math.isPowerOfTwo(o)&&_Math.isPowerOfTwo(l)||(v.texture.generateMipmaps=!1),this.material=new ShaderMaterial({uniforms:UniformsUtils.clone(h.uniforms),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,transparent:!0}),this.material.uniforms.color.value=n,this.material.uniforms.tDiffuse.value=v.texture,this.material.uniforms.textureMatrix.value=m;var y,x,w,view,M,S=(y=new Vector3,x=new Vector3,w=new Matrix4,view=new Vector3,M=new Vector3,function(e){return y.setFromMatrixPosition(r.matrixWorld),x.setFromMatrixPosition(e.matrixWorld),view.subVectors(y,x),w.extractRotation(r.matrixWorld),M.set(0,0,1),M.applyMatrix4(w),view.dot(M)<0}),A=function(){var e=new Vector3,t=new Vector3,n=new Quaternion,o=new Vector3;return function(){r.matrixWorld.decompose(t,n,o),e.set(0,0,1).applyQuaternion(n).normalize(),e.negate(),f.setFromNormalAndCoplanarPoint(e,t)}}(),T=function(){var e=new Plane,t=new Vector4,q=new Vector4;return function(r){d.matrixWorld.copy(r.matrixWorld),d.matrixWorldInverse.getInverse(d.matrixWorld),d.projectionMatrix.copy(r.projectionMatrix),d.far=r.far,e.copy(f),e.applyMatrix4(d.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);var n=d.projectionMatrix;q.x=(Math.sign(t.x)+n.elements[8])/n.elements[0],q.y=(Math.sign(t.y)+n.elements[9])/n.elements[5],q.z=-1,q.w=(1+n.elements[10])/n.elements[14],t.multiplyScalar(2/t.dot(q)),n.elements[2]=t.x,n.elements[6]=t.y,n.elements[10]=t.z+1-c,n.elements[14]=t.w}}();var _,L,C=(_=new Vector4,L=new Vector2,function(e,t,n){r.visible=!1;var o=e.getRenderTarget(),l=e.vr.enabled,c=e.shadowMap.autoUpdate;e.vr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(v),e.clear(),e.render(t,d),e.vr.enabled=l,e.shadowMap.autoUpdate=c,e.setRenderTarget(o);var h=n.bounds;if(void 0!==h){e.getSize(L);var f=e.getPixelRatio();_.x=h.x*L.width*f,_.y=h.y*L.height*f,_.z=h.z*L.width*f,_.w=h.w*L.height*f,e.state.viewport(_)}r.visible=!0});this.onBeforeRender=function(e,t,n){!0!==n.userData.refractor&&!0!=!S(n)&&(A(),function(e){m.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),m.multiply(e.projectionMatrix),m.multiply(e.matrixWorldInverse),m.multiply(r.matrixWorld)}(n),T(n),C(e,t,n))},this.getRenderTarget=function(){return v}};Refractor.prototype=Object.create(Mesh.prototype),Refractor.prototype.constructor=Refractor,Refractor.RefractorShader={uniforms:{color:{type:"c",value:null},tDiffuse:{type:"t",value:null},textureMatrix:{type:"m4",value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","\tvUv = textureMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","\tvec4 base = texture2DProj( tDiffuse, vUv );","\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")};var ShadowMesh=function(e){var t=new MeshBasicMaterial({color:0,transparent:!0,opacity:.6,depthWrite:!1});Mesh.call(this,e.geometry,t),this.meshMatrix=e.matrixWorld,this.frustumCulled=!1,this.matrixAutoUpdate=!1},shadowMatrix;ShadowMesh.prototype=Object.create(Mesh.prototype),ShadowMesh.prototype.constructor=ShadowMesh,ShadowMesh.prototype.update=(shadowMatrix=new Matrix4,function(e,t){var r=e.normal.x*t.x+e.normal.y*t.y+e.normal.z*t.z+-e.constant*t.w,n=shadowMatrix.elements;n[0]=r-t.x*e.normal.x,n[4]=-t.x*e.normal.y,n[8]=-t.x*e.normal.z,n[12]=-t.x*-e.constant,n[1]=-t.y*e.normal.x,n[5]=r-t.y*e.normal.y,n[9]=-t.y*e.normal.z,n[13]=-t.y*-e.constant,n[2]=-t.z*e.normal.x,n[6]=-t.z*e.normal.y,n[10]=r-t.z*e.normal.z,n[14]=-t.z*-e.constant,n[3]=-t.w*e.normal.x,n[7]=-t.w*e.normal.y,n[11]=-t.w*e.normal.z,n[15]=r-t.w*-e.constant,this.matrix.multiplyMatrices(shadowMatrix,this.meshMatrix)});var Sky=function(){var e=Sky.SkyShader,t=new ShaderMaterial({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:UniformsUtils.clone(e.uniforms),side:BackSide});Mesh.call(this,new BoxBufferGeometry(1,1,1),t)};Sky.prototype=Object.create(Mesh.prototype),Sky.SkyShader={uniforms:{luminance:{value:1},turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new Vector3}},vertexShader:["uniform vec3 sunPosition;","uniform float rayleigh;","uniform float turbidity;","uniform float mieCoefficient;","varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );","const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );","const float v = 4.0;","const vec3 K = vec3( 0.686, 0.678, 0.666 );","const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );","const float cutoffAngle = 1.6110731556870734;","const float steepness = 1.5;","const float EE = 1000.0;","float sunIntensity( float zenithAngleCos ) {","\tzenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );","\treturn EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );","}","vec3 totalMie( float T ) {","\tfloat c = ( 0.2 * T ) * 10E-18;","\treturn 0.434 * c * MieConst;","}","void main() {","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvWorldPosition = worldPosition.xyz;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","\tgl_Position.z = gl_Position.w;","\tvSunDirection = normalize( sunPosition );","\tvSunE = sunIntensity( dot( vSunDirection, up ) );","\tvSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );","\tfloat rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );","\tvBetaR = totalRayleigh * rayleighCoefficient;","\tvBetaM = totalMie( turbidity ) * mieCoefficient;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","varying vec3 vSunDirection;","varying float vSunfade;","varying vec3 vBetaR;","varying vec3 vBetaM;","varying float vSunE;","uniform float luminance;","uniform float mieDirectionalG;","const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003;","const float N = 2.545E25;","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const vec3 up = vec3( 0.0, 1.0, 0.0 );","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","const float THREE_OVER_SIXTEENPI = 0.05968310365946075;","const float ONE_OVER_FOURPI = 0.07957747154594767;","float rayleighPhase( float cosTheta ) {","\treturn THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );","}","float hgPhase( float cosTheta, float g ) {","\tfloat g2 = pow( g, 2.0 );","\tfloat inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );","\treturn ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );","}","const float A = 0.15;","const float B = 0.50;","const float C = 0.10;","const float D = 0.20;","const float E = 0.02;","const float F = 0.30;","const float whiteScale = 1.0748724675633854;","vec3 Uncharted2Tonemap( vec3 x ) {","\treturn ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;","}","void main() {","\tfloat zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );","\tfloat inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );","\tfloat sR = rayleighZenithLength * inverse;","\tfloat sM = mieZenithLength * inverse;","\tvec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );","\tfloat cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );","\tfloat rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );","\tvec3 betaRTheta = vBetaR * rPhase;","\tfloat mPhase = hgPhase( cosTheta, mieDirectionalG );","\tvec3 betaMTheta = vBetaM * mPhase;","\tvec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );","\tLin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );","\tvec3 direction = normalize( vWorldPosition - cameraPos );","\tfloat theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]","\tfloat phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]","\tvec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );","\tvec3 L0 = vec3( 0.1 ) * Fex;","\tfloat sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );","\tL0 += ( vSunE * 19000.0 * Fex ) * sundisk;","\tvec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );","\tvec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( luminance, 4.0 ) ) ) * texColor );","\tvec3 color = curr * whiteScale;","\tvec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );","\tgl_FragColor = vec4( retColor, 1.0 );","}"].join("\n")};var Water=function(e,t){Mesh.call(this,e);var r=this,n=void 0!==(t=t||{}).textureWidth?t.textureWidth:512,o=void 0!==t.textureHeight?t.textureHeight:512,l=void 0!==t.clipBias?t.clipBias:0,c=void 0!==t.alpha?t.alpha:1,time=void 0!==t.time?t.time:0,h=void 0!==t.waterNormals?t.waterNormals:null,d=void 0!==t.sunDirection?t.sunDirection:new Vector3(.70707,.70707,0),f=new Color(void 0!==t.sunColor?t.sunColor:16777215),m=new Color(void 0!==t.waterColor?t.waterColor:8355711),v=void 0!==t.eye?t.eye:new Vector3(0,0,0),y=void 0!==t.distortionScale?t.distortionScale:20,x=void 0!==t.side?t.side:FrontSide,w=void 0!==t.fog&&t.fog,M=new Plane,S=new Vector3,A=new Vector3,T=new Vector3,_=new Matrix4,L=new Vector3(0,0,-1),C=new Vector4,view=new Vector3,N=new Vector3,q=new Vector4,P=new Matrix4,E=new PerspectiveCamera,D=new WebGLRenderTarget(n,o,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat,stencilBuffer:!1});_Math.isPowerOfTwo(n)&&_Math.isPowerOfTwo(o)||(D.texture.generateMipmaps=!1);var F={uniforms:UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:1},distortionScale:{value:20},textureMatrix:{value:new Matrix4},sunColor:{value:new Color(8355711)},sunDirection:{value:new Vector3(.70707,.70707,0)},eye:{value:new Vector3},waterColor:{value:new Color(5592405)}}]),vertexShader:["uniform mat4 textureMatrix;","uniform float time;","varying vec4 mirrorCoord;","varying vec4 worldPosition;",ShaderChunk.fog_pars_vertex,ShaderChunk.shadowmap_pars_vertex,"void main() {","\tmirrorCoord = modelMatrix * vec4( position, 1.0 );","\tworldPosition = mirrorCoord.xyzw;","\tmirrorCoord = textureMatrix * mirrorCoord;","\tvec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * mvPosition;",ShaderChunk.fog_vertex,ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float size;","uniform float distortionScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec4 worldPosition;","vec4 getNoise( vec2 uv ) {","\tvec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);","\tvec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );","\tvec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );","\tvec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );","\tvec4 noise = texture2D( normalSampler, uv0 ) +","\t\ttexture2D( normalSampler, uv1 ) +","\t\ttexture2D( normalSampler, uv2 ) +","\t\ttexture2D( normalSampler, uv3 );","\treturn noise * 0.5 - 1.0;","}","void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection, float shiny, float spec, float diffuse, inout vec3 diffuseColor, inout vec3 specularColor ) {","\tvec3 reflection = normalize( reflect( -sunDirection, surfaceNormal ) );","\tfloat direction = max( 0.0, dot( eyeDirection, reflection ) );","\tspecularColor += pow( direction, shiny ) * sunColor * spec;","\tdiffuseColor += max( dot( sunDirection, surfaceNormal ), 0.0 ) * sunColor * diffuse;","}",ShaderChunk.common,ShaderChunk.packing,ShaderChunk.bsdfs,ShaderChunk.fog_pars_fragment,ShaderChunk.lights_pars_begin,ShaderChunk.shadowmap_pars_fragment,ShaderChunk.shadowmask_pars_fragment,"void main() {","\tvec4 noise = getNoise( worldPosition.xz * size );","\tvec3 surfaceNormal = normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) );","\tvec3 diffuseLight = vec3(0.0);","\tvec3 specularLight = vec3(0.0);","\tvec3 worldToEye = eye-worldPosition.xyz;","\tvec3 eyeDirection = normalize( worldToEye );","\tsunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );","\tfloat distance = length(worldToEye);","\tvec2 distortion = surfaceNormal.xz * ( 0.001 + 1.0 / distance ) * distortionScale;","\tvec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );","\tfloat theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );","\tfloat rf0 = 0.3;","\tfloat reflectance = rf0 + ( 1.0 - rf0 ) * pow( ( 1.0 - theta ), 5.0 );","\tvec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;","\tvec3 albedo = mix( ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(), ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ), reflectance);","\tvec3 outgoingLight = albedo;","\tgl_FragColor = vec4( outgoingLight, alpha );",ShaderChunk.tonemapping_fragment,ShaderChunk.fog_fragment,"}"].join("\n")},R=new ShaderMaterial({fragmentShader:F.fragmentShader,vertexShader:F.vertexShader,uniforms:UniformsUtils.clone(F.uniforms),transparent:!0,lights:!0,side:x,fog:w});R.uniforms.mirrorSampler.value=D.texture,R.uniforms.textureMatrix.value=P,R.uniforms.alpha.value=c,R.uniforms.time.value=time,R.uniforms.normalSampler.value=h,R.uniforms.sunColor.value=f,R.uniforms.waterColor.value=m,R.uniforms.sunDirection.value=d,R.uniforms.distortionScale.value=y,R.uniforms.eye.value=v,r.material=R,r.onBeforeRender=function(e,t,n){if(A.setFromMatrixPosition(r.matrixWorld),T.setFromMatrixPosition(n.matrixWorld),_.extractRotation(r.matrixWorld),S.set(0,0,1),S.applyMatrix4(_),view.subVectors(A,T),!(view.dot(S)>0)){view.reflect(S).negate(),view.add(A),_.extractRotation(n.matrixWorld),L.set(0,0,-1),L.applyMatrix4(_),L.add(T),N.subVectors(A,L),N.reflect(S).negate(),N.add(A),E.position.copy(view),E.up.set(0,1,0),E.up.applyMatrix4(_),E.up.reflect(S),E.lookAt(N),E.far=n.far,E.updateMatrixWorld(),E.projectionMatrix.copy(n.projectionMatrix),P.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),P.multiply(E.projectionMatrix),P.multiply(E.matrixWorldInverse),M.setFromNormalAndCoplanarPoint(S,A),M.applyMatrix4(E.matrixWorldInverse),C.set(M.normal.x,M.normal.y,M.normal.z,M.constant);var o=E.projectionMatrix;q.x=(Math.sign(C.x)+o.elements[8])/o.elements[0],q.y=(Math.sign(C.y)+o.elements[9])/o.elements[5],q.z=-1,q.w=(1+o.elements[10])/o.elements[14],C.multiplyScalar(2/C.dot(q)),o.elements[2]=C.x,o.elements[6]=C.y,o.elements[10]=C.z+1-l,o.elements[14]=C.w,v.setFromMatrixPosition(n.matrixWorld);var c=e.getRenderTarget(),h=e.vr.enabled,d=e.shadowMap.autoUpdate;r.visible=!1,e.vr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(D),e.clear(),e.render(t,E),r.visible=!0,e.vr.enabled=h,e.shadowMap.autoUpdate=d,e.setRenderTarget(c)}}};function Water2(e,t){Mesh.call(this,e),this.type="Water2";var r=this,n=void 0!==(t=t||{}).color?new Color(t.color):new Color(16777215),o=t.textureWidth||512,l=t.textureHeight||512,c=t.clipBias||0,h=t.flowDirection||new Vector2(1,0),d=t.flowSpeed||.03,f=t.reflectivity||.02,m=t.scale||1,v=t.shader||Water2.Water2Shader,y=new TextureLoader,x=t.flowMap||void 0,w=t.normalMap0||y.load("textures/water/Water2_1_M_Normal.jpg"),M=t.normalMap1||y.load("textures/water/Water2_2_M_Normal.jpg"),S=.15,A=.5*S,T=new Matrix4,_=new Clock;if(void 0!==Reflector)if(void 0!==Refractor){var L=new Reflector(e,{textureWidth:o,textureHeight:l,clipBias:c}),C=new Refractor(e,{textureWidth:o,textureHeight:l,clipBias:c});L.matrixAutoUpdate=!1,C.matrixAutoUpdate=!1,this.material=new ShaderMaterial({uniforms:UniformsUtils.merge([UniformsLib.fog,v.uniforms]),vertexShader:v.vertexShader,fragmentShader:v.fragmentShader,transparent:!0,fog:!0}),void 0!==x?(this.material.defines.USE_FLOWMAP="",this.material.uniforms.tFlowMap={type:"t",value:x}):this.material.uniforms.flowDirection={type:"v2",value:h},w.wrapS=w.wrapT=RepeatWrapping,M.wrapS=M.wrapT=RepeatWrapping,this.material.uniforms.tReflectionMap.value=L.getRenderTarget().texture,this.material.uniforms.tRefractionMap.value=C.getRenderTarget().texture,this.material.uniforms.tNormalMap0.value=w,this.material.uniforms.tNormalMap1.value=M,this.material.uniforms.color.value=n,this.material.uniforms.reflectivity.value=f,this.material.uniforms.textureMatrix.value=T,this.material.uniforms.config.value.x=0,this.material.uniforms.config.value.y=A,this.material.uniforms.config.value.z=A,this.material.uniforms.config.value.w=m,this.onBeforeRender=function(e,t,n){var o,l;!function(e){T.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),T.multiply(e.projectionMatrix),T.multiply(e.matrixWorldInverse),T.multiply(r.matrixWorld)}(n),o=_.getDelta(),(l=r.material.uniforms.config).value.x+=d*o,l.value.y=l.value.x+A,l.value.x>=S?(l.value.x=0,l.value.y=A):l.value.y>=S&&(l.value.y=l.value.y-S),r.visible=!1,L.matrixWorld.copy(r.matrixWorld),C.matrixWorld.copy(r.matrixWorld),L.onBeforeRender(e,t,n),C.onBeforeRender(e,t,n),r.visible=!0}}else console.error("Water2: Required component Refractor not found.");else console.error("Water2: Required component Reflector not found.")}Water.prototype=Object.create(Mesh.prototype),Water.prototype.constructor=Water,Water2.prototype=Object.create(Mesh.prototype),Water2.prototype.constructor=Water2,Water2.Water2Shader={uniforms:{color:{type:"c",value:null},reflectivity:{type:"f",value:0},tReflectionMap:{type:"t",value:null},tRefractionMap:{type:"t",value:null},tNormalMap0:{type:"t",value:null},tNormalMap1:{type:"t",value:null},textureMatrix:{type:"m4",value:null},config:{type:"v4",value:new Vector4}},vertexShader:["#include <fog_pars_vertex>","uniform mat4 textureMatrix;","varying vec4 vCoord;","varying vec2 vUv;","varying vec3 vToEye;","void main() {","\tvUv = uv;","\tvCoord = textureMatrix * vec4( position, 1.0 );","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvToEye = cameraPosition - worldPosition.xyz;","\tvec4 mvPosition =  viewMatrix * worldPosition;","\tgl_Position = projectionMatrix * mvPosition;","\t#include <fog_vertex>","}"].join("\n"),fragmentShader:["#include <common>","#include <fog_pars_fragment>","uniform sampler2D tReflectionMap;","uniform sampler2D tRefractionMap;","uniform sampler2D tNormalMap0;","uniform sampler2D tNormalMap1;","#ifdef USE_FLOWMAP","\tuniform sampler2D tFlowMap;","#else","\tuniform vec2 flowDirection;","#endif","uniform vec3 color;","uniform float reflectivity;","uniform vec4 config;","varying vec4 vCoord;","varying vec2 vUv;","varying vec3 vToEye;","void main() {","\tfloat flowMapOffset0 = config.x;","\tfloat flowMapOffset1 = config.y;","\tfloat halfCycle = config.z;","\tfloat scale = config.w;","\tvec3 toEye = normalize( vToEye );","\tvec2 flow;","\t#ifdef USE_FLOWMAP","\t\tflow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;","\t#else","\t\tflow = flowDirection;","\t#endif","\tflow.x *= - 1.0;","\tvec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );","\tvec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );","\tfloat flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;","\tvec4 normalColor = mix( normalColor0, normalColor1, flowLerp );","\tvec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );","\tfloat theta = max( dot( toEye, normal ), 0.0 );","\tfloat reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );","\tvec3 coord = vCoord.xyz / vCoord.w;","\tvec2 uv = coord.xy + coord.z * normal.xz * 0.05;","\tvec4 reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uv.x, uv.y ) );","\tvec4 refractColor = texture2D( tRefractionMap, uv );","\tgl_FragColor = vec4( color, 1.0 ) * mix( refractColor, reflectColor, reflectance );","\t#include <tonemapping_fragment>","\t#include <encodings_fragment>","\t#include <fog_fragment>","}"].join("\n")};var Ocean=function(e,t,r,n){function o(e,t){return void 0!==e?e:t}this.changed=!0,this.initial=!0,this.oceanCamera=new OrthographicCamera,this.oceanCamera.position.z=1,this.renderer=e,this.renderer.clearColor(16777215),this.scene=new Scene,n=n||{},this.clearColor=o(n.CLEAR_COLOR,[1,1,1,0]),this.geometryOrigin=o(n.GEOMETRY_ORIGIN,[-1e3,-1e3]),this.sunDirectionX=o(n.SUN_DIRECTION[0],-1),this.sunDirectionY=o(n.SUN_DIRECTION[1],1),this.sunDirectionZ=o(n.SUN_DIRECTION[2],1),this.oceanColor=o(n.OCEAN_COLOR,new Vector3(.004,.016,.047)),this.skyColor=o(n.SKY_COLOR,new Vector3(3.2,9.6,12.8)),this.exposure=o(n.EXPOSURE,.35),this.geometryResolution=o(n.GEOMETRY_RESOLUTION,32),this.geometrySize=o(n.GEOMETRY_SIZE,2e3),this.resolution=o(n.RESOLUTION,64),this.floatSize=o(n.SIZE_OF_FLOAT,4),this.windX=o(n.INITIAL_WIND[0],10),this.windY=o(n.INITIAL_WIND[1],10),this.size=o(n.INITIAL_SIZE,250),this.choppiness=o(n.INITIAL_CHOPPINESS,1.5),this.matrixNeedsUpdate=!1;var l=o(n.USE_HALF_FLOAT,!1)?HalfFloatType:FloatType,c={minFilter:LinearFilter,magFilter:LinearFilter,wrapS:ClampToEdgeWrapping,wrapT:ClampToEdgeWrapping,format:RGBAFormat,stencilBuffer:!1,depthBuffer:!1,premultiplyAlpha:!1,type:l},h={minFilter:NearestFilter,magFilter:NearestFilter,wrapS:ClampToEdgeWrapping,wrapT:ClampToEdgeWrapping,format:RGBAFormat,stencilBuffer:!1,depthBuffer:!1,premultiplyAlpha:!1,type:l},d={minFilter:NearestFilter,magFilter:NearestFilter,wrapS:RepeatWrapping,wrapT:RepeatWrapping,format:RGBAFormat,stencilBuffer:!1,depthBuffer:!1,premultiplyAlpha:!1,type:l};this.initialSpectrumFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,d),this.spectrumFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,h),this.pingPhaseFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,h),this.pongPhaseFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,h),this.pingTransformFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,h),this.pongTransformFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,h),this.displacementMapFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,c),this.normalMapFramebuffer=new WebGLRenderTarget(this.resolution,this.resolution,c);var f=ShaderLib.ocean_sim_vertex,m=ShaderLib.ocean_subtransform,v=UniformsUtils.clone(m.uniforms);this.materialOceanHorizontal=new ShaderMaterial({uniforms:v,vertexShader:f.vertexShader,fragmentShader:"#define HORIZONTAL \n"+m.fragmentShader}),this.materialOceanHorizontal.uniforms.u_transformSize={value:this.resolution},this.materialOceanHorizontal.uniforms.u_subtransformSize={value:null},this.materialOceanHorizontal.uniforms.u_input={value:null},this.materialOceanHorizontal.depthTest=!1;var y=ShaderLib.ocean_subtransform,x=UniformsUtils.clone(y.uniforms);this.materialOceanVertical=new ShaderMaterial({uniforms:x,vertexShader:f.vertexShader,fragmentShader:y.fragmentShader}),this.materialOceanVertical.uniforms.u_transformSize={value:this.resolution},this.materialOceanVertical.uniforms.u_subtransformSize={value:null},this.materialOceanVertical.uniforms.u_input={value:null},this.materialOceanVertical.depthTest=!1;var w=ShaderLib.ocean_initial_spectrum,M=UniformsUtils.clone(w.uniforms);this.materialInitialSpectrum=new ShaderMaterial({uniforms:M,vertexShader:w.vertexShader,fragmentShader:w.fragmentShader}),this.materialInitialSpectrum.uniforms.u_wind={value:new Vector2},this.materialInitialSpectrum.uniforms.u_resolution={value:this.resolution},this.materialInitialSpectrum.depthTest=!1;var S=ShaderLib.ocean_phase,A=UniformsUtils.clone(S.uniforms);this.materialPhase=new ShaderMaterial({uniforms:A,vertexShader:f.vertexShader,fragmentShader:S.fragmentShader}),this.materialPhase.uniforms.u_resolution={value:this.resolution},this.materialPhase.depthTest=!1;var T=ShaderLib.ocean_spectrum,_=UniformsUtils.clone(T.uniforms);this.materialSpectrum=new ShaderMaterial({uniforms:_,vertexShader:f.vertexShader,fragmentShader:T.fragmentShader}),this.materialSpectrum.uniforms.u_initialSpectrum={value:null},this.materialSpectrum.uniforms.u_resolution={value:this.resolution},this.materialSpectrum.depthTest=!1;var L=ShaderLib.ocean_normals,C=UniformsUtils.clone(L.uniforms);this.materialNormal=new ShaderMaterial({uniforms:C,vertexShader:f.vertexShader,fragmentShader:L.fragmentShader}),this.materialNormal.uniforms.u_displacementMap={value:null},this.materialNormal.uniforms.u_resolution={value:this.resolution},this.materialNormal.depthTest=!1;var N=ShaderLib.ocean_main,P=UniformsUtils.clone(N.uniforms);this.materialOcean=new ShaderMaterial({uniforms:P,vertexShader:N.vertexShader,fragmentShader:N.fragmentShader}),this.materialOcean.uniforms.u_geometrySize={value:this.resolution},this.materialOcean.uniforms.u_displacementMap={value:this.displacementMapFramebuffer.texture},this.materialOcean.uniforms.u_normalMap={value:this.normalMapFramebuffer.texture},this.materialOcean.uniforms.u_oceanColor={value:this.oceanColor},this.materialOcean.uniforms.u_skyColor={value:this.skyColor},this.materialOcean.uniforms.u_sunDirection={value:new Vector3(this.sunDirectionX,this.sunDirectionY,this.sunDirectionZ)},this.materialOcean.uniforms.u_exposure={value:this.exposure},this.materialOceanHorizontal.blending=0,this.materialOceanVertical.blending=0,this.materialInitialSpectrum.blending=0,this.materialPhase.blending=0,this.materialSpectrum.blending=0,this.materialNormal.blending=0,this.materialOcean.blending=0,this.screenQuad=new Mesh(new PlaneBufferGeometry(2,2)),this.scene.add(this.screenQuad),this.generateSeedPhaseTexture(),this.generateMesh()};Ocean.prototype.generateMesh=function(){var e=new PlaneBufferGeometry(this.geometrySize,this.geometrySize,this.geometryResolution,this.geometryResolution);e.rotateX(-Math.PI/2),this.oceanMesh=new Mesh(e,this.materialOcean)},Ocean.prototype.render=function(){var e=this.renderer.getRenderTarget();this.scene.overrideMaterial=null,this.changed&&this.renderInitialSpectrum(),this.renderWavePhase(),this.renderSpectrum(),this.renderSpectrumFFT(),this.renderNormalMap(),this.scene.overrideMaterial=null,this.renderer.setRenderTarget(e)},Ocean.prototype.generateSeedPhaseTexture=function(){this.pingPhase=!0;for(var e=new window.Float32Array(this.resolution*this.resolution*4),i=0;i<this.resolution;i++)for(var t=0;t<this.resolution;t++)e[i*this.resolution*4+4*t]=2*Math.random()*Math.PI,e[i*this.resolution*4+4*t+1]=0,e[i*this.resolution*4+4*t+2]=0,e[i*this.resolution*4+4*t+3]=0;this.pingPhaseTexture=new DataTexture(e,this.resolution,this.resolution,RGBAFormat),this.pingPhaseTexture.wrapS=ClampToEdgeWrapping,this.pingPhaseTexture.wrapT=ClampToEdgeWrapping,this.pingPhaseTexture.type=FloatType,this.pingPhaseTexture.needsUpdate=!0},Ocean.prototype.renderInitialSpectrum=function(){this.scene.overrideMaterial=this.materialInitialSpectrum,this.materialInitialSpectrum.uniforms.u_wind.value.set(this.windX,this.windY),this.materialInitialSpectrum.uniforms.u_size.value=this.size,this.renderer.setRenderTarget(this.initialSpectrumFramebuffer),this.renderer.clear(),this.renderer.render(this.scene,this.oceanCamera)},Ocean.prototype.renderWavePhase=function(){this.scene.overrideMaterial=this.materialPhase,this.screenQuad.material=this.materialPhase,this.initial?(this.materialPhase.uniforms.u_phases.value=this.pingPhaseTexture,this.initial=!1):this.materialPhase.uniforms.u_phases.value=this.pingPhase?this.pingPhaseFramebuffer.texture:this.pongPhaseFramebuffer.texture,this.materialPhase.uniforms.u_deltaTime.value=this.deltaTime,this.materialPhase.uniforms.u_size.value=this.size,this.renderer.setRenderTarget(this.pingPhase?this.pongPhaseFramebuffer:this.pingPhaseFramebuffer),this.renderer.render(this.scene,this.oceanCamera),this.pingPhase=!this.pingPhase},Ocean.prototype.renderSpectrum=function(){this.scene.overrideMaterial=this.materialSpectrum,this.materialSpectrum.uniforms.u_initialSpectrum.value=this.initialSpectrumFramebuffer.texture,this.materialSpectrum.uniforms.u_phases.value=this.pingPhase?this.pingPhaseFramebuffer.texture:this.pongPhaseFramebuffer.texture,this.materialSpectrum.uniforms.u_choppiness.value=this.choppiness,this.materialSpectrum.uniforms.u_size.value=this.size,this.renderer.setRenderTarget(this.spectrumFramebuffer),this.renderer.render(this.scene,this.oceanCamera)},Ocean.prototype.renderSpectrumFFT=function(){var e=Math.log(this.resolution)/Math.log(2);this.scene.overrideMaterial=this.materialOceanHorizontal;for(var i=0;i<e;i++)0===i?(this.materialOceanHorizontal.uniforms.u_input.value=this.spectrumFramebuffer.texture,this.materialOceanHorizontal.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.pingTransformFramebuffer),this.renderer.render(this.scene,this.oceanCamera)):i%2==1?(this.materialOceanHorizontal.uniforms.u_input.value=this.pingTransformFramebuffer.texture,this.materialOceanHorizontal.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.pongTransformFramebuffer),this.renderer.render(this.scene,this.oceanCamera)):(this.materialOceanHorizontal.uniforms.u_input.value=this.pongTransformFramebuffer.texture,this.materialOceanHorizontal.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.pingTransformFramebuffer),this.renderer.render(this.scene,this.oceanCamera));this.scene.overrideMaterial=this.materialOceanVertical;for(i=e;i<2*e;i++)i===2*e-1?(this.materialOceanVertical.uniforms.u_input.value=e%2==0?this.pingTransformFramebuffer.texture:this.pongTransformFramebuffer.texture,this.materialOceanVertical.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.displacementMapFramebuffer),this.renderer.render(this.scene,this.oceanCamera)):i%2==1?(this.materialOceanVertical.uniforms.u_input.value=this.pingTransformFramebuffer.texture,this.materialOceanVertical.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.pongTransformFramebuffer),this.renderer.render(this.scene,this.oceanCamera)):(this.materialOceanVertical.uniforms.u_input.value=this.pongTransformFramebuffer.texture,this.materialOceanVertical.uniforms.u_subtransformSize.value=Math.pow(2,i%e+1),this.renderer.setRenderTarget(this.pingTransformFramebuffer),this.renderer.render(this.scene,this.oceanCamera))},Ocean.prototype.renderNormalMap=function(){this.scene.overrideMaterial=this.materialNormal,this.changed&&(this.materialNormal.uniforms.u_size.value=this.size),this.materialNormal.uniforms.u_displacementMap.value=this.displacementMapFramebuffer.texture,this.renderer.setRenderTarget(this.normalMapFramebuffer),this.renderer.clear(),this.renderer.render(this.scene,this.oceanCamera)};var PMREMCubeUVPacker=function(){var e,t=new OrthographicCamera,r=new Scene,n=((e=new ShaderMaterial({uniforms:{faceIndex:{value:0},mapSize:{value:0},envMap:{value:null},testColor:{value:new Vector3(1,1,1)}},vertexShader:"precision highp float;        varying vec2 vUv;        void main() {          vUv = uv;          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );        }",fragmentShader:"precision highp float;        varying vec2 vUv;        uniform samplerCube envMap;        uniform float mapSize;        uniform vec3 testColor;        uniform int faceIndex;                void main() {          vec3 sampleDirection;          vec2 uv = vUv;          uv = uv * 2.0 - 1.0;          uv.y *= -1.0;          if(faceIndex == 0) {            sampleDirection = normalize(vec3(1.0, uv.y, -uv.x));          } else if(faceIndex == 1) {            sampleDirection = normalize(vec3(uv.x, 1.0, uv.y));          } else if(faceIndex == 2) {            sampleDirection = normalize(vec3(uv.x, uv.y, 1.0));          } else if(faceIndex == 3) {            sampleDirection = normalize(vec3(-1.0, uv.y, uv.x));          } else if(faceIndex == 4) {            sampleDirection = normalize(vec3(uv.x, -1.0, -uv.y));          } else {            sampleDirection = normalize(vec3(-uv.x, uv.y, -1.0));          }          vec4 color = envMapTexelToLinear( textureCube( envMap, sampleDirection ) );          gl_FragColor = linearToOutputTexel( color );        }",blending:NoBlending})).type="PMREMCubeUVPacker",e),o=function(e){this.cubeLods=e;var t=4*e[0].width,r=e[0].texture,o={format:r.format,magFilter:r.magFilter,minFilter:r.minFilter,type:r.type,generateMipmaps:r.generateMipmaps,anisotropy:r.anisotropy,encoding:r.encoding===RGBEEncoding?RGBM16Encoding:r.encoding};o.encoding===RGBM16Encoding&&(o.magFilter=LinearFilter,o.minFilter=LinearFilter),this.CubeUVRenderTarget=new WebGLRenderTarget(t,t,o),this.CubeUVRenderTarget.texture.name="PMREMCubeUVPacker.cubeUv",this.CubeUVRenderTarget.texture.mapping=CubeUVReflectionMapping,this.objects=[];var l=new PlaneBufferGeometry(1,1),c=[];c.push(new Vector2(0,0)),c.push(new Vector2(1,0)),c.push(new Vector2(2,0)),c.push(new Vector2(0,1)),c.push(new Vector2(1,1)),c.push(new Vector2(2,1));var h=t;t=e[0].width;var d=0,f=4;this.numLods=Math.log(e[0].width)/Math.log(2)-2;for(var i=0;i<this.numLods;i++){var m=.5*(h-h/f);t>16&&(f*=2);for(var v=t>16?6:1,y=0,x=0,w=t,M=0;M<v;M++){for(var S=0;S<6;S++){var A=n.clone();A.uniforms.envMap.value=this.cubeLods[i].texture,A.envMap=this.cubeLods[i].texture,A.uniforms.faceIndex.value=S,A.uniforms.mapSize.value=w;var T=new Mesh(l,A);T.position.x=c[S].x*w-m+y,T.position.y=c[S].y*w-m+d+x,T.material.side=BackSide,T.scale.setScalar(w),this.objects.push(T)}x+=1.75*w,y+=1.25*w,w/=2}d+=2*t,t>16&&(t/=2)}};return o.prototype={constructor:o,update:function(e){var n=4*this.cubeLods[0].width;t.left=.5*-n,t.right=.5*n,t.top=.5*-n,t.bottom=.5*n,t.near=0,t.far=1,t.updateProjectionMatrix();for(var i=0;i<this.objects.length;i++)r.add(this.objects[i]);var o=e.gammaInput,l=e.gammaOutput,c=e.toneMapping,h=e.toneMappingExposure,d=e.getRenderTarget();e.gammaInput=!1,e.gammaOutput=!1,e.toneMapping=LinearToneMapping,e.toneMappingExposure=1,e.setRenderTarget(this.CubeUVRenderTarget),e.render(r,t),e.setRenderTarget(d),e.toneMapping=c,e.toneMappingExposure=h,e.gammaInput=o,e.gammaOutput=l;for(i=0;i<this.objects.length;i++)r.remove(this.objects[i])},dispose:function(){for(var i=0,e=this.objects.length;i<e;i++)this.objects[i].material.dispose();this.objects[0].geometry.dispose()}},o}(),PMREMGenerator=function(){var e,t=((e=new ShaderMaterial({defines:{SAMPLES_PER_LEVEL:20},uniforms:{faceIndex:{value:0},roughness:{value:.5},mapSize:{value:.5},envMap:{value:null},tFlip:{value:-1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform int faceIndex;\n\t\t\t\tuniform float roughness;\n\t\t\t\tuniform samplerCube envMap;\n\t\t\t\tuniform float mapSize;\n\t\t\t\tuniform float tFlip;\n\t\t\t\t\n\t\t\t\tfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\t\t\t\t\tfloat a = ggxRoughness + 0.0001;\n\t\t\t\t\ta *= a;\n\t\t\t\t\treturn ( 2.0 / a - 2.0 );\n\t\t\t\t}\n\t\t\t\tvec3 ImportanceSamplePhong(vec2 uv, mat3 vecSpace, float specPow) {\n\t\t\t\t\tfloat phi = uv.y * 2.0 * PI;\n\t\t\t\t\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\t\t\t\t\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\t\t\t\t\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\t\t\t\t\treturn vecSpace * sampleDir;\n\t\t\t\t}\n\t\t\t\tvec3 ImportanceSampleGGX( vec2 uv, mat3 vecSpace, float Roughness )\n\t\t\t\t{\n\t\t\t\t\tfloat a = Roughness * Roughness;\n\t\t\t\t\tfloat Phi = 2.0 * PI * uv.x;\n\t\t\t\t\tfloat CosTheta = sqrt( (1.0 - uv.y) / ( 1.0 + (a*a - 1.0) * uv.y ) );\n\t\t\t\t\tfloat SinTheta = sqrt( 1.0 - CosTheta * CosTheta );\n\t\t\t\t\treturn vecSpace * vec3(SinTheta * cos( Phi ), SinTheta * sin( Phi ), CosTheta);\n\t\t\t\t}\n\t\t\t\tmat3 matrixFromVector(vec3 n) {\n\t\t\t\t\tfloat a = 1.0 / (1.0 + n.z);\n\t\t\t\t\tfloat b = -n.x * n.y * a;\n\t\t\t\t\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\t\t\t\t\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\t\t\t\t\treturn mat3(b1, b2, n);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvec4 testColorMap(float Roughness) {\n\t\t\t\t\tvec4 color;\n\t\t\t\t\tif(faceIndex == 0)\n\t\t\t\t\t\tcolor = vec4(1.0,0.0,0.0,1.0);\n\t\t\t\t\telse if(faceIndex == 1)\n\t\t\t\t\t\tcolor = vec4(0.0,1.0,0.0,1.0);\n\t\t\t\t\telse if(faceIndex == 2)\n\t\t\t\t\t\tcolor = vec4(0.0,0.0,1.0,1.0);\n\t\t\t\t\telse if(faceIndex == 3)\n\t\t\t\t\t\tcolor = vec4(1.0,1.0,0.0,1.0);\n\t\t\t\t\telse if(faceIndex == 4)\n\t\t\t\t\t\tcolor = vec4(0.0,1.0,1.0,1.0);\n\t\t\t\t\telse\n\t\t\t\t\t\tcolor = vec4(1.0,0.0,1.0,1.0);\n\t\t\t\t\tcolor *= ( 1.0 - Roughness );\n\t\t\t\t\treturn color;\n\t\t\t\t}\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec3 sampleDirection;\n\t\t\t\t\tvec2 uv = vUv*2.0 - 1.0;\n\t\t\t\t\tfloat offset = -1.0/mapSize;\n\t\t\t\t\tconst float a = -1.0;\n\t\t\t\t\tconst float b = 1.0;\n\t\t\t\t\tfloat c = -1.0 + offset;\n\t\t\t\t\tfloat d = 1.0 - offset;\n\t\t\t\t\tfloat bminusa = b - a;\n\t\t\t\t\tuv.x = (uv.x - a)/bminusa * d - (uv.x - b)/bminusa * c;\n\t\t\t\t\tuv.y = (uv.y - a)/bminusa * d - (uv.y - b)/bminusa * c;\n\t\t\t\t\tif (faceIndex==0) {\n\t\t\t\t\t\tsampleDirection = vec3(1.0, -uv.y, -uv.x);\n\t\t\t\t\t} else if (faceIndex==1) {\n\t\t\t\t\t\tsampleDirection = vec3(-1.0, -uv.y, uv.x);\n\t\t\t\t\t} else if (faceIndex==2) {\n\t\t\t\t\t\tsampleDirection = vec3(uv.x, 1.0, uv.y);\n\t\t\t\t\t} else if (faceIndex==3) {\n\t\t\t\t\t\tsampleDirection = vec3(uv.x, -1.0, -uv.y);\n\t\t\t\t\t} else if (faceIndex==4) {\n\t\t\t\t\t\tsampleDirection = vec3(uv.x, -uv.y, 1.0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tsampleDirection = vec3(-uv.x, -uv.y, -1.0);\n\t\t\t\t\t}\n\t\t\t\t\tvec3 correctedDirection = vec3( tFlip * sampleDirection.x, sampleDirection.yz );\n\t\t\t\t\tmat3 vecSpace = matrixFromVector( normalize( correctedDirection ) );\n\t\t\t\t\tvec3 rgbColor = vec3(0.0);\n\t\t\t\t\tconst int NumSamples = SAMPLES_PER_LEVEL;\n\t\t\t\t\tvec3 vect;\n\t\t\t\t\tfloat weight = 0.0;\n\t\t\t\t\tfor( int i = 0; i < NumSamples; i ++ ) {\n\t\t\t\t\t\tfloat sini = sin(float(i));\n\t\t\t\t\t\tfloat cosi = cos(float(i));\n\t\t\t\t\t\tfloat r = rand(vec2(sini, cosi));\n\t\t\t\t\t\tvect = ImportanceSampleGGX(vec2(float(i) / float(NumSamples), r), vecSpace, roughness);\n\t\t\t\t\t\tfloat dotProd = dot(vect, normalize(sampleDirection));\n\t\t\t\t\t\tweight += dotProd;\n\t\t\t\t\t\tvec3 color = envMapTexelToLinear(textureCube(envMap, vect)).rgb;\n\t\t\t\t\t\trgbColor.rgb += color;\n\t\t\t\t\t}\n\t\t\t\t\trgbColor /= float(NumSamples);\n\t\t\t\t\t//rgbColor = testColorMap( roughness ).rgb;\n\t\t\t\t\tgl_FragColor = linearToOutputTexel( vec4( rgbColor, 1.0 ) );\n\t\t\t\t}",blending:NoBlending})).type="PMREMGenerator",e),r=new OrthographicCamera(-1,1,1,-1,0,1e3),n=new Scene,o=new Mesh(new PlaneBufferGeometry(2,2,0),t);o.material.side=DoubleSide,n.add(o),n.add(r);var l=function(e,t,r){this.sourceTexture=e,this.resolution=void 0!==r?r:256,this.samplesPerLevel=void 0!==t?t:32;var n=this.sourceTexture.encoding===LinearEncoding||this.sourceTexture.encoding===GammaEncoding||this.sourceTexture.encoding===sRGBEncoding;this.sourceTexture.minFilter=n?LinearFilter:NearestFilter,this.sourceTexture.magFilter=n?LinearFilter:NearestFilter,this.sourceTexture.generateMipmaps=this.sourceTexture.generateMipmaps&&n,this.cubeLods=[];var o=this.resolution,l={format:this.sourceTexture.format,magFilter:this.sourceTexture.magFilter,minFilter:this.sourceTexture.minFilter,type:this.sourceTexture.type,generateMipmaps:this.sourceTexture.generateMipmaps,anisotropy:this.sourceTexture.anisotropy,encoding:this.sourceTexture.encoding};this.numLods=Math.log(o)/Math.log(2)-2;for(var i=0;i<this.numLods;i++){var c=new WebGLRenderTargetCube(o,o,l);c.texture.name="PMREMGenerator.cube"+i,this.cubeLods.push(c),o=Math.max(16,o/2)}};return l.prototype={constructor:l,update:function(e){var r=this.sourceTexture.isCubeTexture?-1:1;t.defines.SAMPLES_PER_LEVEL=this.samplesPerLevel,t.uniforms.faceIndex.value=0,t.uniforms.envMap.value=this.sourceTexture,t.envMap=this.sourceTexture,t.needsUpdate=!0;var n=e.gammaInput,o=e.gammaOutput,l=e.toneMapping,c=e.toneMappingExposure,h=e.getRenderTarget();e.toneMapping=LinearToneMapping,e.toneMappingExposure=1,e.gammaInput=!1,e.gammaOutput=!1;for(var i=0;i<this.numLods;i++){var d=i/(this.numLods-1);t.uniforms.roughness.value=.9*d,t.uniforms.tFlip.value=0==i?r:1;var f=this.cubeLods[i].width;t.uniforms.mapSize.value=f,this.renderToCubeMapTarget(e,this.cubeLods[i]),i<5&&(t.uniforms.envMap.value=this.cubeLods[i].texture)}e.setRenderTarget(h),e.toneMapping=l,e.toneMappingExposure=c,e.gammaInput=n,e.gammaOutput=o},renderToCubeMapTarget:function(e,t){for(var i=0;i<6;i++)this.renderToCubeMapTargetFace(e,t,i)},renderToCubeMapTargetFace:function(e,o,l){t.uniforms.faceIndex.value=l,e.setRenderTarget(o,l),e.clear(),e.render(n,r)},dispose:function(){for(var i=0,e=this.cubeLods.length;i<e;i++)this.cubeLods[i].dispose()}},l}(),CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},LuminosityShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","float l = linearToRelativeLuminance( texel.rgb );","gl_FragColor = vec4( l, l, l, texel.w );","}"].join("\n")},ToneMapShader={uniforms:{tDiffuse:{value:null},averageLuminance:{value:1},luminanceMap:{value:null},maxLuminance:{value:16},minLuminance:{value:.01},middleGrey:{value:.6}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform float middleGrey;","uniform float minLuminance;","uniform float maxLuminance;","#ifdef ADAPTED_LUMINANCE","uniform sampler2D luminanceMap;","#else","uniform float averageLuminance;","#endif","vec3 ToneMap( vec3 vColor ) {","#ifdef ADAPTED_LUMINANCE","float fLumAvg = texture2D(luminanceMap, vec2(0.5, 0.5)).r;","#else","float fLumAvg = averageLuminance;","#endif","float fLumPixel = linearToRelativeLuminance( vColor );","float fLumScaled = (fLumPixel * middleGrey) / max( minLuminance, fLumAvg );","float fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (maxLuminance * maxLuminance)))) / (1.0 + fLumScaled);","return fLumCompressed * vColor;","}","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = vec4( ToneMap( texel.xyz ), texel.w );","}"].join("\n")},AdaptiveToneMappingPass=function(e,t){Pass.call(this),this.resolution=void 0!==t?t:256,this.needsInit=!0,this.adaptive=void 0===e||!!e,this.luminanceRT=null,this.previousLuminanceRT=null,this.currentLuminanceRT=null,void 0===CopyShader&&console.error("AdaptiveToneMappingPass relies on CopyShader");var r=CopyShader;this.copyUniforms=UniformsUtils.clone(r.uniforms),this.materialCopy=new ShaderMaterial({uniforms:this.copyUniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,blending:NoBlending,depthTest:!1}),void 0===LuminosityShader&&console.error("AdaptiveToneMappingPass relies on LuminosityShader"),this.materialLuminance=new ShaderMaterial({uniforms:UniformsUtils.clone(LuminosityShader.uniforms),vertexShader:LuminosityShader.vertexShader,fragmentShader:LuminosityShader.fragmentShader,blending:NoBlending}),this.adaptLuminanceShader={defines:{MIP_LEVEL_1X1:(Math.log(this.resolution)/Math.log(2)).toFixed(1)},uniforms:{lastLum:{value:null},currentLum:{value:null},minLuminance:{value:.01},delta:{value:.016},tau:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D lastLum;","uniform sampler2D currentLum;","uniform float minLuminance;","uniform float delta;","uniform float tau;","void main() {","\tvec4 lastLum = texture2D( lastLum, vUv, MIP_LEVEL_1X1 );","\tvec4 currentLum = texture2D( currentLum, vUv, MIP_LEVEL_1X1 );","\tfloat fLastLum = max( minLuminance, lastLum.r );","\tfloat fCurrentLum = max( minLuminance, currentLum.r );","\tfCurrentLum *= fCurrentLum;","\tfloat fAdaptedLum = fLastLum + (fCurrentLum - fLastLum) * (1.0 - exp(-delta * tau));","\tgl_FragColor.r = fAdaptedLum;","}"].join("\n")},this.materialAdaptiveLum=new ShaderMaterial({uniforms:UniformsUtils.clone(this.adaptLuminanceShader.uniforms),vertexShader:this.adaptLuminanceShader.vertexShader,fragmentShader:this.adaptLuminanceShader.fragmentShader,defines:Object.assign({},this.adaptLuminanceShader.defines),blending:NoBlending}),void 0===ToneMapShader&&console.error("AdaptiveToneMappingPass relies on ToneMapShader"),this.materialToneMap=new ShaderMaterial({uniforms:UniformsUtils.clone(ToneMapShader.uniforms),vertexShader:ToneMapShader.vertexShader,fragmentShader:ToneMapShader.fragmentShader,blending:NoBlending}),this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};AdaptiveToneMappingPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:AdaptiveToneMappingPass,render:function(e,t,r,n,o){this.needsInit&&(this.reset(e),this.luminanceRT.texture.type=r.texture.type,this.previousLuminanceRT.texture.type=r.texture.type,this.currentLuminanceRT.texture.type=r.texture.type,this.needsInit=!1),this.adaptive&&(this.quad.material=this.materialLuminance,this.materialLuminance.uniforms.tDiffuse.value=r.texture,e.setRenderTarget(this.currentLuminanceRT),e.render(this.scene,this.camera),this.quad.material=this.materialAdaptiveLum,this.materialAdaptiveLum.uniforms.delta.value=n,this.materialAdaptiveLum.uniforms.lastLum.value=this.previousLuminanceRT.texture,this.materialAdaptiveLum.uniforms.currentLum.value=this.currentLuminanceRT.texture,e.setRenderTarget(this.luminanceRT),e.render(this.scene,this.camera),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.luminanceRT.texture,e.setRenderTarget(this.previousLuminanceRT),e.render(this.scene,this.camera)),this.quad.material=this.materialToneMap,this.materialToneMap.uniforms.tDiffuse.value=r.texture,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))},reset:function(e){this.luminanceRT&&this.luminanceRT.dispose(),this.currentLuminanceRT&&this.currentLuminanceRT.dispose(),this.previousLuminanceRT&&this.previousLuminanceRT.dispose();var t={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat};this.luminanceRT=new WebGLRenderTarget(this.resolution,this.resolution,t),this.luminanceRT.texture.name="AdaptiveToneMappingPass.l",this.luminanceRT.texture.generateMipmaps=!1,this.previousLuminanceRT=new WebGLRenderTarget(this.resolution,this.resolution,t),this.previousLuminanceRT.texture.name="AdaptiveToneMappingPass.pl",this.previousLuminanceRT.texture.generateMipmaps=!1,t.minFilter=LinearMipMapLinearFilter,t.generateMipmaps=!0,this.currentLuminanceRT=new WebGLRenderTarget(this.resolution,this.resolution,t),this.currentLuminanceRT.texture.name="AdaptiveToneMappingPass.cl",this.adaptive&&(this.materialToneMap.defines.ADAPTED_LUMINANCE="",this.materialToneMap.uniforms.luminanceMap.value=this.luminanceRT.texture),this.quad.material=new MeshBasicMaterial({color:7829367}),this.materialLuminance.needsUpdate=!0,this.materialAdaptiveLum.needsUpdate=!0,this.materialToneMap.needsUpdate=!0},setAdaptive:function(e){e?(this.adaptive=!0,this.materialToneMap.defines.ADAPTED_LUMINANCE="",this.materialToneMap.uniforms.luminanceMap.value=this.luminanceRT.texture):(this.adaptive=!1,delete this.materialToneMap.defines.ADAPTED_LUMINANCE,this.materialToneMap.uniforms.luminanceMap.value=null),this.materialToneMap.needsUpdate=!0},setAdaptionRate:function(e){e&&(this.materialAdaptiveLum.uniforms.tau.value=Math.abs(e))},setMinLuminance:function(e){e&&(this.materialToneMap.uniforms.minLuminance.value=e,this.materialAdaptiveLum.uniforms.minLuminance.value=e)},setMaxLuminance:function(e){e&&(this.materialToneMap.uniforms.maxLuminance.value=e)},setAverageLuminance:function(e){e&&(this.materialToneMap.uniforms.averageLuminance.value=e)},setMiddleGrey:function(e){e&&(this.materialToneMap.uniforms.middleGrey.value=e)},dispose:function(){this.luminanceRT&&this.luminanceRT.dispose(),this.previousLuminanceRT&&this.previousLuminanceRT.dispose(),this.currentLuminanceRT&&this.currentLuminanceRT.dispose(),this.materialLuminance&&this.materialLuminance.dispose(),this.materialAdaptiveLum&&this.materialAdaptiveLum.dispose(),this.materialCopy&&this.materialCopy.dispose(),this.materialToneMap&&this.materialToneMap.dispose()}});var AfterimageShader={uniforms:{damp:{value:.96},tOld:{value:null},tNew:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float damp;","uniform sampler2D tOld;","uniform sampler2D tNew;","varying vec2 vUv;","vec4 when_gt( vec4 x, float y ) {","return max( sign( x - y ), 0.0 );","}","void main() {","vec4 texelOld = texture2D( tOld, vUv );","vec4 texelNew = texture2D( tNew, vUv );","texelOld *= damp * when_gt( texelOld, 0.1 );","gl_FragColor = max(texelNew, texelOld);","}"].join("\n")},AfterimagePass=function(e){Pass.call(this),void 0===AfterimageShader&&console.error("AfterimagePass relies on AfterimageShader"),this.shader=AfterimageShader,this.uniforms=UniformsUtils.clone(this.shader.uniforms),this.uniforms.damp.value=void 0!==e?e:.96,this.textureComp=new WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:LinearFilter,magFilter:NearestFilter,format:RGBAFormat}),this.textureOld=new WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:LinearFilter,magFilter:NearestFilter,format:RGBAFormat}),this.shaderMaterial=new ShaderMaterial({uniforms:this.uniforms,vertexShader:this.shader.vertexShader,fragmentShader:this.shader.fragmentShader}),this.sceneComp=new Scene,this.scene=new Scene,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.camera.position.z=1;var t=new PlaneBufferGeometry(2,2);this.quadComp=new Mesh(t,this.shaderMaterial),this.sceneComp.add(this.quadComp);var r=new Mesh(t,new MeshBasicMaterial({map:this.textureComp.texture}));this.scene.add(r)};AfterimagePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:AfterimagePass,render:function(e,t,r){this.uniforms.tOld.value=this.textureOld.texture,this.uniforms.tNew.value=r.texture,this.quadComp.material=this.shaderMaterial,e.setRenderTarget(this.textureComp),e.render(this.sceneComp,this.camera),e.setRenderTarget(this.textureOld),e.render(this.scene,this.camera),this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))}});var ConvolutionShader={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},uniforms:{tDiffuse:{value:null},uImageIncrement:{value:new Vector2(.001953125,0)},cKernel:{value:[]}},vertexShader:["uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * uImageIncrement;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0, 0.0, 0.0, 0.0 );","for( int i = 0; i < KERNEL_SIZE_INT; i ++ ) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","imageCoord += uImageIncrement;","}","gl_FragColor = sum;","}"].join("\n"),buildKernel:function(e){function t(e,t){return Math.exp(-e*e/(2*t*t))}var i,r,n,o,l=2*Math.ceil(3*e)+1;for(l>25&&(l=25),o=.5*(l-1),r=new Array(l),n=0,i=0;i<l;++i)r[i]=t(i-o,e),n+=r[i];for(i=0;i<l;++i)r[i]/=n;return r}},BloomPass=function(e,t,r,n){Pass.call(this),e=void 0!==e?e:1,t=void 0!==t?t:25,r=void 0!==r?r:4,n=void 0!==n?n:256;var o={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat};this.renderTargetX=new WebGLRenderTarget(n,n,o),this.renderTargetX.texture.name="BloomPass.x",this.renderTargetY=new WebGLRenderTarget(n,n,o),this.renderTargetY.texture.name="BloomPass.y",void 0===CopyShader&&console.error("BloomPass relies on CopyShader");var l=CopyShader;this.copyUniforms=UniformsUtils.clone(l.uniforms),this.copyUniforms.opacity.value=e,this.materialCopy=new ShaderMaterial({uniforms:this.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:AdditiveBlending,transparent:!0}),void 0===ConvolutionShader&&console.error("BloomPass relies on ConvolutionShader");var c=ConvolutionShader;this.convolutionUniforms=UniformsUtils.clone(c.uniforms),this.convolutionUniforms.uImageIncrement.value=BloomPass.blurX,this.convolutionUniforms.cKernel.value=ConvolutionShader.buildKernel(r),this.materialConvolution=new ShaderMaterial({uniforms:this.convolutionUniforms,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,defines:{KERNEL_SIZE_FLOAT:t.toFixed(1),KERNEL_SIZE_INT:t.toFixed(0)}}),this.needsSwap=!1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};BloomPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:BloomPass,render:function(e,t,r,n,o){o&&e.context.disable(e.context.STENCIL_TEST),this.quad.material=this.materialConvolution,this.convolutionUniforms.tDiffuse.value=r.texture,this.convolutionUniforms.uImageIncrement.value=BloomPass.blurX,e.setRenderTarget(this.renderTargetX),e.clear(),e.render(this.scene,this.camera),this.convolutionUniforms.tDiffuse.value=this.renderTargetX.texture,this.convolutionUniforms.uImageIncrement.value=BloomPass.blurY,e.setRenderTarget(this.renderTargetY),e.clear(),e.render(this.scene,this.camera),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetY.texture,o&&e.context.enable(e.context.STENCIL_TEST),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera)}}),BloomPass.blurX=new Vector2(.001953125,0),BloomPass.blurY=new Vector2(0,.001953125);var BokehPass=function(e,t,r){Pass.call(this),this.scene=e,this.camera=t;var n=void 0!==r.focus?r.focus:1,o=void 0!==r.aspect?r.aspect:t.aspect,l=void 0!==r.aperture?r.aperture:.025,c=void 0!==r.maxblur?r.maxblur:1,h=r.width||window.innerWidth||1,d=r.height||window.innerHeight||1;this.renderTargetColor=new WebGLRenderTarget(h,d,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat}),this.renderTargetColor.texture.name="BokehPass.color",this.renderTargetDepth=this.renderTargetColor.clone(),this.renderTargetDepth.texture.name="BokehPass.depth",this.materialDepth=new MeshDepthMaterial,this.materialDepth.depthPacking=RGBADepthPacking,this.materialDepth.blending=NoBlending,void 0===BokehShader&&console.error("BokehPass relies on BokehShader");var f=BokehShader,m=UniformsUtils.clone(f.uniforms);m.tDepth.value=this.renderTargetDepth.texture,m.focus.value=n,m.aspect.value=o,m.aperture.value=l,m.maxblur.value=c,m.nearClip.value=t.near,m.farClip.value=t.far,this.materialBokeh=new ShaderMaterial({defines:Object.assign({},f.defines),uniforms:m,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader}),this.uniforms=m,this.needsSwap=!1,this.camera2=new OrthographicCamera(-1,1,1,-1,0,1),this.scene2=new Scene,this.quad2=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad2.frustumCulled=!1,this.scene2.add(this.quad2),this.oldClearColor=new Color,this.oldClearAlpha=1};BokehPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:BokehPass,render:function(e,t,r,n,o){this.quad2.material=this.materialBokeh,this.scene.overrideMaterial=this.materialDepth,this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();e.autoClear;e.autoClear=!1,e.setClearColor(16777215),e.setClearAlpha(1),e.setRenderTarget(this.renderTargetDepth),e.clear(),e.render(this.scene,this.camera),this.uniforms.tColor.value=r.texture,this.uniforms.nearClip.value=this.camera.near,this.uniforms.farClip.value=this.camera.far,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene2,this.camera2)):(e.setRenderTarget(t),e.clear(),e.render(this.scene2,this.camera2)),this.scene.overrideMaterial=null,e.setClearColor(this.oldClearColor),e.setClearAlpha(this.oldClearAlpha),e.autoClear=this.oldAutoClear}});var ClearPass=function(e,t){Pass.call(this),this.needsSwap=!1,this.clearColor=void 0!==e?e:0,this.clearAlpha=void 0!==t?t:0};ClearPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:ClearPass,render:function(e,t,r,n,o){var l,c;this.clearColor&&(l=e.getClearColor().getHex(),c=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.setRenderTarget(this.renderToScreen?null:r),e.clear(),this.clearColor&&e.setClearColor(l,c)}});var CubeTexturePass=function(e,t,r){Pass.call(this),this.camera=e,this.needsSwap=!1,this.cubeShader=ShaderLib.cube,this.cubeMesh=new Mesh(new BoxBufferGeometry(10,10,10),new ShaderMaterial({uniforms:this.cubeShader.uniforms,vertexShader:this.cubeShader.vertexShader,fragmentShader:this.cubeShader.fragmentShader,depthTest:!1,depthWrite:!1,side:BackSide})),this.envMap=t,this.opacity=void 0!==r?r:1,this.cubeScene=new Scene,this.cubeCamera=new PerspectiveCamera,this.cubeScene.add(this.cubeMesh)};CubeTexturePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:CubeTexturePass,render:function(e,t,r,n,o){var l=e.autoClear;e.autoClear=!1,this.cubeCamera.projectionMatrix.copy(this.camera.projectionMatrix),this.cubeCamera.quaternion.setFromRotationMatrix(this.camera.matrixWorld),this.cubeMesh.material.uniforms.tCube.value=this.envMap,this.cubeMesh.material.uniforms.opacity.value=this.opacity,this.cubeMesh.material.transparent=this.opacity<1,e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(),e.render(this.cubeScene,this.cubeCamera),e.autoClear=l}});var DotScreenShader={uniforms:{tDiffuse:{value:null},tSize:{value:new Vector2(256,256)},center:{value:new Vector2(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},DotScreenPass=function(e,t,r){Pass.call(this),void 0===DotScreenShader&&console.error("DotScreenPass relies on DotScreenShader");var n=DotScreenShader;this.uniforms=UniformsUtils.clone(n.uniforms),void 0!==e&&this.uniforms.center.value.copy(e),void 0!==t&&(this.uniforms.angle.value=t),void 0!==r&&(this.uniforms.scale.value=r),this.material=new ShaderMaterial({uniforms:this.uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader}),this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};DotScreenPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:DotScreenPass,render:function(e,t,r,n,o){this.uniforms.tDiffuse.value=r.texture,this.uniforms.tSize.value.set(r.width,r.height),this.quad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))}});var MaskPass=function(e,t){Pass.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1};MaskPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:MaskPass,render:function(e,t,r,n,o){var l,c,h=e.context,d=e.state;d.buffers.color.setMask(!1),d.buffers.depth.setMask(!1),d.buffers.color.setLocked(!0),d.buffers.depth.setLocked(!0),this.inverse?(l=0,c=1):(l=1,c=0),d.buffers.stencil.setTest(!0),d.buffers.stencil.setOp(h.REPLACE,h.REPLACE,h.REPLACE),d.buffers.stencil.setFunc(h.ALWAYS,l,4294967295),d.buffers.stencil.setClear(c),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),d.buffers.color.setLocked(!1),d.buffers.depth.setLocked(!1),d.buffers.stencil.setFunc(h.EQUAL,1,4294967295),d.buffers.stencil.setOp(h.KEEP,h.KEEP,h.KEEP)}});var ClearMaskPass=function(){Pass.call(this),this.needsSwap=!1};ClearMaskPass.prototype=Object.create(Pass.prototype),Object.assign(ClearMaskPass.prototype,{render:function(e,t,r,n,o){e.state.buffers.stencil.setTest(!1)}});var EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var r={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat,stencilBuffer:!1},n=e.getDrawingBufferSize(new Vector2);(t=new WebGLRenderTarget(n.width,n.height,r)).texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===CopyShader&&console.error("EffectComposer relies on CopyShader"),void 0===ShaderPass&&console.error("EffectComposer relies on ShaderPass"),this.copyPass=new ShaderPass(CopyShader),this._previousFrameTime=Date.now()};Object.assign(EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getDrawingBufferSize(new Vector2);e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){void 0===e&&(e=.001*(Date.now()-this._previousFrameTime)),this._previousFrameTime=Date.now();var t,i,r=this.renderer.getRenderTarget(),n=!1,o=this.passes.length;for(i=0;i<o;i++)if(!1!==(t=this.passes[i]).enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),t.needsSwap){if(n){var l=this.renderer.context;l.stencilFunc(l.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),l.stencilFunc(l.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==MaskPass&&(t instanceof MaskPass?n=!0:t instanceof ClearMaskPass&&(n=!1))}this.renderer.setRenderTarget(r)},reset:function(e){if(void 0===e){var t=this.renderer.getDrawingBufferSize(new Vector2);(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}});var FilmShader={uniforms:{tDiffuse:{value:null},time:{value:0},nIntensity:{value:.5},sIntensity:{value:.05},sCount:{value:4096},grayscale:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform float sIntensity;","uniform float sCount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","float dx = rand( vUv + time );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx, 0.0, 1.0 );","vec2 sc = vec2( sin( vUv.y * sCount ), cos( vUv.y * sCount ) );","cResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * sIntensity;","cResult = cTextureScreen.rgb + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );","if( grayscale ) {","cResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );","}","gl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")},FilmPass=function(e,t,r,n){Pass.call(this),void 0===FilmShader&&console.error("FilmPass relies on FilmShader");var o=FilmShader;this.uniforms=UniformsUtils.clone(o.uniforms),this.material=new ShaderMaterial({uniforms:this.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}),void 0!==n&&(this.uniforms.grayscale.value=n),void 0!==e&&(this.uniforms.nIntensity.value=e),void 0!==t&&(this.uniforms.sIntensity.value=t),void 0!==r&&(this.uniforms.sCount.value=r),this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};FilmPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:FilmPass,render:function(e,t,r,n,o){this.uniforms.tDiffuse.value=r.texture,this.uniforms.time.value+=n,this.quad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))}});var DigitalGlitch={uniforms:{tDiffuse:{value:null},tDisp:{value:null},byp:{value:0},amount:{value:.08},angle:{value:.02},seed:{value:.02},seed_x:{value:.02},seed_y:{value:.02},distortion_x:{value:.5},distortion_y:{value:.6},col_s:{value:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform int byp;","uniform sampler2D tDiffuse;","uniform sampler2D tDisp;","uniform float amount;","uniform float angle;","uniform float seed;","uniform float seed_x;","uniform float seed_y;","uniform float distortion_x;","uniform float distortion_y;","uniform float col_s;","varying vec2 vUv;","float rand(vec2 co){","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","if(byp<1) {","vec2 p = vUv;","float xs = floor(gl_FragCoord.x / 0.5);","float ys = floor(gl_FragCoord.y / 0.5);","vec4 normal = texture2D (tDisp, p*seed*seed);","if(p.y<distortion_x+col_s && p.y>distortion_x-col_s*seed) {","if(seed_x>0.){","p.y = 1. - (p.y + distortion_y);","}","else {","p.y = distortion_y;","}","}","if(p.x<distortion_y+col_s && p.x>distortion_y-col_s*seed) {","if(seed_y>0.){","p.x=distortion_x;","}","else {","p.x = 1. - (p.x + distortion_x);","}","}","p.x+=normal.x*seed_x*(seed/5.);","p.y+=normal.y*seed_y*(seed/5.);","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, p + offset);","vec4 cga = texture2D(tDiffuse, p);","vec4 cb = texture2D(tDiffuse, p - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","vec4 snow = 200.*amount*vec4(rand(vec2(xs * seed,ys * seed*50.))*0.2);","gl_FragColor = gl_FragColor+ snow;","}","else {","gl_FragColor=texture2D (tDiffuse, vUv);","}","}"].join("\n")},GlitchPass=function(e){Pass.call(this),void 0===DigitalGlitch&&console.error("GlitchPass relies on DigitalGlitch");var t=DigitalGlitch;this.uniforms=UniformsUtils.clone(t.uniforms),null==e&&(e=64),this.uniforms.tDisp.value=this.generateHeightmap(e),this.material=new ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.goWild=!1,this.curF=0,this.generateTrigger()};GlitchPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:GlitchPass,render:function(e,t,r,n,o){this.uniforms.tDiffuse.value=r.texture,this.uniforms.seed.value=Math.random(),this.uniforms.byp.value=0,this.curF%this.randX==0||1==this.goWild?(this.uniforms.amount.value=Math.random()/30,this.uniforms.angle.value=_Math.randFloat(-Math.PI,Math.PI),this.uniforms.seed_x.value=_Math.randFloat(-1,1),this.uniforms.seed_y.value=_Math.randFloat(-1,1),this.uniforms.distortion_x.value=_Math.randFloat(0,1),this.uniforms.distortion_y.value=_Math.randFloat(0,1),this.curF=0,this.generateTrigger()):this.curF%this.randX<this.randX/5?(this.uniforms.amount.value=Math.random()/90,this.uniforms.angle.value=_Math.randFloat(-Math.PI,Math.PI),this.uniforms.distortion_x.value=_Math.randFloat(0,1),this.uniforms.distortion_y.value=_Math.randFloat(0,1),this.uniforms.seed_x.value=_Math.randFloat(-.3,.3),this.uniforms.seed_y.value=_Math.randFloat(-.3,.3)):0==this.goWild&&(this.uniforms.byp.value=1),this.curF++,this.quad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))},generateTrigger:function(){this.randX=_Math.randInt(120,240)},generateHeightmap:function(e){for(var t=new Float32Array(e*e*3),r=e*e,i=0;i<r;i++){var n=_Math.randFloat(0,1);t[3*i+0]=n,t[3*i+1]=n,t[3*i+2]=n}var o=new DataTexture(t,e,e,RGBFormat,FloatType);return o.needsUpdate=!0,o}});var HalftoneShader={uniforms:{tDiffuse:{value:null},shape:{value:1},radius:{value:4},rotateR:{value:Math.PI/12*1},rotateG:{value:Math.PI/12*2},rotateB:{value:Math.PI/12*3},scatter:{value:0},width:{value:1},height:{value:1},blending:{value:1},blendingMode:{value:1},greyscale:{value:!1},disable:{value:!1}},vertexShader:["varying vec2 vUV;","void main() {","vUV = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#define SQRT2_MINUS_ONE 0.41421356","#define SQRT2_HALF_MINUS_ONE 0.20710678","#define PI2 6.28318531","#define SHAPE_DOT 1","#define SHAPE_ELLIPSE 2","#define SHAPE_LINE 3","#define SHAPE_SQUARE 4","#define BLENDING_LINEAR 1","#define BLENDING_MULTIPLY 2","#define BLENDING_ADD 3","#define BLENDING_LIGHTER 4","#define BLENDING_DARKER 5","uniform sampler2D tDiffuse;","uniform float radius;","uniform float rotateR;","uniform float rotateG;","uniform float rotateB;","uniform float scatter;","uniform float width;","uniform float height;","uniform int shape;","uniform bool disable;","uniform float blending;","uniform int blendingMode;","varying vec2 vUV;","uniform bool greyscale;","const int samples = 8;","float blend( float a, float b, float t ) {","return a * ( 1.0 - t ) + b * t;","}","float hypot( float x, float y ) {","return sqrt( x * x + y * y );","}","float rand( vec2 seed ){","return fract( sin( dot( seed.xy, vec2( 12.9898, 78.233 ) ) ) * 43758.5453 );","}","float distanceToDotRadius( float channel, vec2 coord, vec2 normal, vec2 p, float angle, float rad_max ) {","float dist = hypot( coord.x - p.x, coord.y - p.y );","float rad = channel;","if ( shape == SHAPE_DOT ) {","rad = pow( abs( rad ), 1.125 ) * rad_max;","} else if ( shape == SHAPE_ELLIPSE ) {","rad = pow( abs( rad ), 1.125 ) * rad_max;","if ( dist != 0.0 ) {","float dot_p = abs( ( p.x - coord.x ) / dist * normal.x + ( p.y - coord.y ) / dist * normal.y );","dist = ( dist * ( 1.0 - SQRT2_HALF_MINUS_ONE ) ) + dot_p * dist * SQRT2_MINUS_ONE;","}","} else if ( shape == SHAPE_LINE ) {","rad = pow( abs( rad ), 1.5) * rad_max;","float dot_p = ( p.x - coord.x ) * normal.x + ( p.y - coord.y ) * normal.y;","dist = hypot( normal.x * dot_p, normal.y * dot_p );","} else if ( shape == SHAPE_SQUARE ) {","float theta = atan( p.y - coord.y, p.x - coord.x ) - angle;","float sin_t = abs( sin( theta ) );","float cos_t = abs( cos( theta ) );","rad = pow( abs( rad ), 1.4 );","rad = rad_max * ( rad + ( ( sin_t > cos_t ) ? rad - sin_t * rad : rad - cos_t * rad ) );","}","return rad - dist;","}","struct Cell {","vec2 normal;","vec2 p1;","vec2 p2;","vec2 p3;","vec2 p4;","float samp2;","float samp1;","float samp3;","float samp4;","};","vec4 getSample( vec2 point ) {","vec4 tex = texture2D( tDiffuse, vec2( point.x / width, point.y / height ) );","float base = rand( vec2( floor( point.x ), floor( point.y ) ) ) * PI2;","float step = PI2 / float( samples );","float dist = radius * 0.66;","for ( int i = 0; i < samples; ++i ) {","float r = base + step * float( i );","vec2 coord = point + vec2( cos( r ) * dist, sin( r ) * dist );","tex += texture2D( tDiffuse, vec2( coord.x / width, coord.y / height ) );","}","tex /= float( samples ) + 1.0;","return tex;","}","float getDotColour( Cell c, vec2 p, int channel, float angle, float aa ) {","float dist_c_1, dist_c_2, dist_c_3, dist_c_4, res;","if ( channel == 0 ) {","c.samp1 = getSample( c.p1 ).r;","c.samp2 = getSample( c.p2 ).r;","c.samp3 = getSample( c.p3 ).r;","c.samp4 = getSample( c.p4 ).r;","} else if (channel == 1) {","c.samp1 = getSample( c.p1 ).g;","c.samp2 = getSample( c.p2 ).g;","c.samp3 = getSample( c.p3 ).g;","c.samp4 = getSample( c.p4 ).g;","} else {","c.samp1 = getSample( c.p1 ).b;","c.samp3 = getSample( c.p3 ).b;","c.samp2 = getSample( c.p2 ).b;","c.samp4 = getSample( c.p4 ).b;","}","dist_c_1 = distanceToDotRadius( c.samp1, c.p1, c.normal, p, angle, radius );","dist_c_2 = distanceToDotRadius( c.samp2, c.p2, c.normal, p, angle, radius );","dist_c_3 = distanceToDotRadius( c.samp3, c.p3, c.normal, p, angle, radius );","dist_c_4 = distanceToDotRadius( c.samp4, c.p4, c.normal, p, angle, radius );","res = ( dist_c_1 > 0.0 ) ? clamp( dist_c_1 / aa, 0.0, 1.0 ) : 0.0;","res += ( dist_c_2 > 0.0 ) ? clamp( dist_c_2 / aa, 0.0, 1.0 ) : 0.0;","res += ( dist_c_3 > 0.0 ) ? clamp( dist_c_3 / aa, 0.0, 1.0 ) : 0.0;","res += ( dist_c_4 > 0.0 ) ? clamp( dist_c_4 / aa, 0.0, 1.0 ) : 0.0;","res = clamp( res, 0.0, 1.0 );","return res;","}","Cell getReferenceCell( vec2 p, vec2 origin, float grid_angle, float step ) {","Cell c;","vec2 n = vec2( cos( grid_angle ), sin( grid_angle ) );","float threshold = step * 0.5;","float dot_normal = n.x * ( p.x - origin.x ) + n.y * ( p.y - origin.y );","float dot_line = -n.y * ( p.x - origin.x ) + n.x * ( p.y - origin.y );","vec2 offset = vec2( n.x * dot_normal, n.y * dot_normal );","float offset_normal = mod( hypot( offset.x, offset.y ), step );","float normal_dir = ( dot_normal < 0.0 ) ? 1.0 : -1.0;","float normal_scale = ( ( offset_normal < threshold ) ? -offset_normal : step - offset_normal ) * normal_dir;","float offset_line = mod( hypot( ( p.x - offset.x ) - origin.x, ( p.y - offset.y ) - origin.y ), step );","float line_dir = ( dot_line < 0.0 ) ? 1.0 : -1.0;","float line_scale = ( ( offset_line < threshold ) ? -offset_line : step - offset_line ) * line_dir;","c.normal = n;","c.p1.x = p.x - n.x * normal_scale + n.y * line_scale;","c.p1.y = p.y - n.y * normal_scale - n.x * line_scale;","if ( scatter != 0.0 ) {","float off_mag = scatter * threshold * 0.5;","float off_angle = rand( vec2( floor( c.p1.x ), floor( c.p1.y ) ) ) * PI2;","c.p1.x += cos( off_angle ) * off_mag;","c.p1.y += sin( off_angle ) * off_mag;","}","float normal_step = normal_dir * ( ( offset_normal < threshold ) ? step : -step );","float line_step = line_dir * ( ( offset_line < threshold ) ? step : -step );","c.p2.x = c.p1.x - n.x * normal_step;","c.p2.y = c.p1.y - n.y * normal_step;","c.p3.x = c.p1.x + n.y * line_step;","c.p3.y = c.p1.y - n.x * line_step;","c.p4.x = c.p1.x - n.x * normal_step + n.y * line_step;","c.p4.y = c.p1.y - n.y * normal_step - n.x * line_step;","return c;","}","float blendColour( float a, float b, float t ) {","if ( blendingMode == BLENDING_LINEAR ) {","return blend( a, b, 1.0 - t );","} else if ( blendingMode == BLENDING_ADD ) {","return blend( a, min( 1.0, a + b ), t );","} else if ( blendingMode == BLENDING_MULTIPLY ) {","return blend( a, max( 0.0, a * b ), t );","} else if ( blendingMode == BLENDING_LIGHTER ) {","return blend( a, max( a, b ), t );","} else if ( blendingMode == BLENDING_DARKER ) {","return blend( a, min( a, b ), t );","} else {","return blend( a, b, 1.0 - t );","}","}","void main() {","if ( ! disable ) {","vec2 p = vec2( vUV.x * width, vUV.y * height );","vec2 origin = vec2( 0, 0 );","float aa = ( radius < 2.5 ) ? radius * 0.5 : 1.25;","Cell cell_r = getReferenceCell( p, origin, rotateR, radius );","Cell cell_g = getReferenceCell( p, origin, rotateG, radius );","Cell cell_b = getReferenceCell( p, origin, rotateB, radius );","float r = getDotColour( cell_r, p, 0, rotateR, aa );","float g = getDotColour( cell_g, p, 1, rotateG, aa );","float b = getDotColour( cell_b, p, 2, rotateB, aa );","vec4 colour = texture2D( tDiffuse, vUV );","r = blendColour( r, colour.r, blending );","g = blendColour( g, colour.g, blending );","b = blendColour( b, colour.b, blending );","if ( greyscale ) {","r = g = b = (r + b + g) / 3.0;","}","gl_FragColor = vec4( r, g, b, 1.0 );","} else {","gl_FragColor = texture2D( tDiffuse, vUV );","}","}"].join("\n")},HalftonePass=function(e,t,r){for(var n in Pass.call(this),void 0===HalftoneShader&&console.error("HalftonePass requires HalftoneShader"),this.uniforms=UniformsUtils.clone(HalftoneShader.uniforms),this.material=new ShaderMaterial({uniforms:this.uniforms,fragmentShader:HalftoneShader.fragmentShader,vertexShader:HalftoneShader.vertexShader}),this.uniforms.width.value=e,this.uniforms.height.value=t,r)r.hasOwnProperty(n)&&this.uniforms.hasOwnProperty(n)&&(this.uniforms[n].value=r[n]);this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};HalftonePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:HalftonePass,render:function(e,t,r,n,o){this.material.uniforms.tDiffuse.value=r.texture,this.quad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))},setSize:function(e,t){this.uniforms.width.value=e,this.uniforms.height.value=t}});var OutlinePass=function(e,t,r,n){this.renderScene=t,this.renderCamera=r,this.selectedObjects=void 0!==n?n:[],this.visibleEdgeColor=new Color(1,1,1),this.hiddenEdgeColor=new Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,Pass.call(this),this.resolution=void 0!==e?new Vector2(e.x,e.y):new Vector2(256,256);var o={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat},l=Math.round(this.resolution.x/this.downSampleRatio),c=Math.round(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new MeshBasicMaterial({color:16777215}),this.maskBufferMaterial.side=DoubleSide,this.renderTargetMaskBuffer=new WebGLRenderTarget(this.resolution.x,this.resolution.y,o),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new MeshDepthMaterial,this.depthMaterial.side=DoubleSide,this.depthMaterial.depthPacking=RGBADepthPacking,this.depthMaterial.blending=NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=DoubleSide,this.prepareMaskMaterial.fragmentShader=function(e,t){var r=t.isPerspectiveCamera?"perspective":"orthographic";return e.replace(/DEPTH_TO_VIEW_Z/g,r+"DepthToViewZ")}(this.prepareMaskMaterial.fragmentShader,this.renderCamera),this.renderTargetDepthBuffer=new WebGLRenderTarget(this.resolution.x,this.resolution.y,o),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new WebGLRenderTarget(l,c,o),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new WebGLRenderTarget(l,c,o),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new WebGLRenderTarget(Math.round(l/2),Math.round(c/2),o),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new WebGLRenderTarget(l,c,o),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new WebGLRenderTarget(Math.round(l/2),Math.round(c/2),o),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new Vector2(l,c),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(4),this.separableBlurMaterial2.uniforms.texSize.value=new Vector2(Math.round(l/2),Math.round(c/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=4,this.overlayMaterial=this.getOverlayMaterial(),void 0===CopyShader&&console.error("OutlinePass relies on CopyShader");var h=CopyShader;this.copyUniforms=UniformsUtils.clone(h.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new ShaderMaterial({uniforms:this.copyUniforms,vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,blending:NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new Color,this.oldClearAlpha=1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.tempPulseColor1=new Color,this.tempPulseColor2=new Color,this.textureMatrix=new Matrix4};OutlinePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:OutlinePass,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(e,t){this.renderTargetMaskBuffer.setSize(e,t);var r=Math.round(e/this.downSampleRatio),n=Math.round(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(r,n),this.renderTargetBlurBuffer1.setSize(r,n),this.renderTargetEdgeBuffer1.setSize(r,n),this.separableBlurMaterial1.uniforms.texSize.value=new Vector2(r,n),r=Math.round(r/2),n=Math.round(n/2),this.renderTargetBlurBuffer2.setSize(r,n),this.renderTargetEdgeBuffer2.setSize(r,n),this.separableBlurMaterial2.uniforms.texSize.value=new Vector2(r,n)},changeVisibilityOfSelectedObjects:function(e){function t(object){object.isMesh&&(e?(object.visible=object.userData.oldVisible,delete object.userData.oldVisible):(object.userData.oldVisible=object.visible,object.visible=e))}for(var i=0;i<this.selectedObjects.length;i++){this.selectedObjects[i].traverse(t)}},changeVisibilityOfNonSelectedObjects:function(e){var t=[];function r(object){object.isMesh&&t.push(object)}for(var i=0;i<this.selectedObjects.length;i++){this.selectedObjects[i].traverse(r)}this.renderScene.traverse((function(object){if(object.isMesh||object.isLine||object.isSprite){for(var r=!1,i=0;i<t.length;i++){if(t[i].id===object.id){r=!0;break}}if(!r){var n=object.visible;e&&!object.bVisible||(object.visible=e),object.bVisible=n}}}))},updateTextureMatrix:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)},render:function(e,t,r,n,o){if(this.selectedObjects.length>0){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var l=e.autoClear;e.autoClear=!1,o&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(16777215,1),this.changeVisibilityOfSelectedObjects(!1);var c=this.renderScene.background;if(this.renderScene.background=null,this.renderScene.overrideMaterial=this.depthMaterial,e.setRenderTarget(this.renderTargetDepthBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.changeVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.setRenderTarget(this.renderTargetMaskBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this.renderScene.background=c,this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.setRenderTarget(this.renderTargetMaskDownSampleBuffer),e.clear(),e.render(this.scene,this.camera),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),this.pulsePeriod>0){var h=.625+.75*Math.cos(.01*performance.now()/this.pulsePeriod)/2;this.tempPulseColor1.multiplyScalar(h),this.tempPulseColor2.multiplyScalar(h)}this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),e.render(this.scene,this.camera),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=OutlinePass.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.setRenderTarget(this.renderTargetBlurBuffer1),e.clear(),e.render(this.scene,this.camera),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=OutlinePass.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),e.render(this.scene,this.camera),this.quad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=OutlinePass.BlurDirectionX,e.setRenderTarget(this.renderTargetBlurBuffer2),e.clear(),e.render(this.scene,this.camera),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=OutlinePass.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer2),e.clear(),e.render(this.scene,this.camera),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,o&&e.context.enable(e.context.STENCIL_TEST),e.setRenderTarget(r),e.render(this.scene,this.camera),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=l}this.renderToScreen&&(this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=r.texture,e.setRenderTarget(null),e.render(this.scene,this.camera))},getPrepareMaskMaterial:function(){return new ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new Vector2(.5,.5)},textureMatrix:{value:new Matrix4}},vertexShader:["varying vec4 projTexCoord;","varying vec4 vPosition;","uniform mat4 textureMatrix;","void main() {","\tvPosition = modelViewMatrix * vec4( position, 1.0 );","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tprojTexCoord = textureMatrix * worldPosition;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <packing>","varying vec4 vPosition;","varying vec4 projTexCoord;","uniform sampler2D depthTexture;","uniform vec2 cameraNearFar;","void main() {","\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));","\tfloat viewZ = - DEPTH_TO_VIEW_Z( depth, cameraNearFar.x, cameraNearFar.y );","\tfloat depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;","\tgl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);","}"].join("\n")})},getEdgeDetectionMaterial:function(){return new ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new Vector2(.5,.5)},visibleEdgeColor:{value:new Vector3(1,1,1)},hiddenEdgeColor:{value:new Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec3 visibleEdgeColor;\t\t\t\tuniform vec3 hiddenEdgeColor;\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\t\t\t\t\tfloat a1 = min(c1.g, c2.g);\t\t\t\t\tfloat a2 = min(c3.g, c4.g);\t\t\t\t\tfloat visibilityFactor = min(a1, a2);\t\t\t\t\tvec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\t\t\t\t}"})},getSeperableBlurMaterial:function(e){return new ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new Vector2(.5,.5)},direction:{value:new Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\t\t\t\tuniform sampler2D colorTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\tuniform float kernelRadius;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, kernelRadius);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\t\t\t\t\tvec2 uvOffset = delta;\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\t\t\t\t\t\tfloat w = gaussianPdf(uvOffset.x, kernelRadius);\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\t\t\t\t\t\tweightSum += (2.0 * w);\t\t\t\t\t\tuvOffset += delta;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\t\t\t\t}"})},getOverlayMaterial:function(){return new ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform sampler2D edgeTexture1;\t\t\t\tuniform sampler2D edgeTexture2;\t\t\t\tuniform sampler2D patternTexture;\t\t\t\tuniform float edgeStrength;\t\t\t\tuniform float edgeGlow;\t\t\t\tuniform bool usePatternTexture;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tvec4 edgeValue1 = texture2D(edgeTexture1, vUv);\t\t\t\t\tvec4 edgeValue2 = texture2D(edgeTexture2, vUv);\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\t\t\t\t\tvec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\t\t\t\t\tfloat visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\t\t\t\t\tvec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\t\t\t\t\tif(usePatternTexture)\t\t\t\t\t\tfinalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\t\t\t\t\tgl_FragColor = finalColor;\t\t\t\t}",blending:AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),OutlinePass.BlurDirectionX=new Vector2(1,0),OutlinePass.BlurDirectionY=new Vector2(0,1);var RenderPass=function(e,t,r,n,o){Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=n,this.clearAlpha=void 0!==o?o:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1};function DepthTexture(e,t,r,n,o,l,c,h,d,f){if((f=void 0!==f?f:DepthFormat)!==DepthFormat&&f!==DepthStencilFormat)throw new Error("DepthTexture format must be either DepthFormat or DepthStencilFormat");void 0===r&&f===DepthFormat&&(r=UnsignedShortType),void 0===r&&f===DepthStencilFormat&&(r=UnsignedInt248Type),Texture.call(this,null,n,o,l,c,h,f,r,d),this.image={width:e,height:t},this.magFilter=void 0!==c?c:NearestFilter,this.minFilter=void 0!==h?h:NearestFilter,this.flipY=!1,this.generateMipmaps=!1}RenderPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:RenderPass,render:function(e,t,r,n,o){var l,c,h=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(l=e.getClearColor().getHex(),c=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(l,c),this.scene.overrideMaterial=null,e.autoClear=h}}),DepthTexture.prototype=Object.create(Texture.prototype),DepthTexture.prototype.constructor=DepthTexture,DepthTexture.prototype.isDepthTexture=!0;var SAOShader={defines:{NUM_SAMPLES:7,NUM_RINGS:4,NORMAL_TEXTURE:0,DIFFUSE_TEXTURE:0,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{type:"t",value:null},tDiffuse:{type:"t",value:null},tNormal:{type:"t",value:null},size:{type:"v2",value:new Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},cameraProjectionMatrix:{type:"m4",value:new Matrix4},cameraInverseProjectionMatrix:{type:"m4",value:new Matrix4},scale:{type:"f",value:1},intensity:{type:"f",value:.1},bias:{type:"f",value:.5},minResolution:{type:"f",value:0},kernelRadius:{type:"f",value:100},randomSeed:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","varying vec2 vUv;","#if DIFFUSE_TEXTURE == 1","uniform sampler2D tDiffuse;","#endif","uniform sampler2D tDepth;","#if NORMAL_TEXTURE == 1","uniform sampler2D tNormal;","#endif","uniform float cameraNear;","uniform float cameraFar;","uniform mat4 cameraProjectionMatrix;","uniform mat4 cameraInverseProjectionMatrix;","uniform float scale;","uniform float intensity;","uniform float bias;","uniform float kernelRadius;","uniform float minResolution;","uniform vec2 size;","uniform float randomSeed;","// RGBA depth","#include <packing>","vec4 getDefaultColor( const in vec2 screenPosition ) {","\t#if DIFFUSE_TEXTURE == 1","\treturn texture2D( tDiffuse, vUv );","\t#else","\treturn vec4( 1.0 );","\t#endif","}","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","vec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {","\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];","\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );","\tclipPosition *= clipW; // unprojection.","\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;","}","vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPosition ) {","\t#if NORMAL_TEXTURE == 1","\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );","\t#else","\treturn normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );","\t#endif","}","float scaleDividedByCameraFar;","float minResolutionMultipliedByCameraFar;","float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {","\tvec3 viewDelta = sampleViewPosition - centerViewPosition;","\tfloat viewDistance = length( viewDelta );","\tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;","\treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - bias) / (1.0 + pow2( scaledScreenDistance ) );","}","// moving costly divides into consts","const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );","const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );","float getAmbientOcclusion( const in vec3 centerViewPosition ) {","\t// precompute some variables require in getOcclusion.","\tscaleDividedByCameraFar = scale / cameraFar;","\tminResolutionMultipliedByCameraFar = minResolution * cameraFar;","\tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUv );","\t// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/","\tfloat angle = rand( vUv + randomSeed ) * PI2;","\tvec2 radius = vec2( kernelRadius * INV_NUM_SAMPLES ) / size;","\tvec2 radiusStep = radius;","\tfloat occlusionSum = 0.0;","\tfloat weightSum = 0.0;","\tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {","\t\tvec2 sampleUv = vUv + vec2( cos( angle ), sin( angle ) ) * radius;","\t\tradius += radiusStep;","\t\tangle += ANGLE_STEP;","\t\tfloat sampleDepth = getDepth( sampleUv );","\t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {","\t\t\tcontinue;","\t\t}","\t\tfloat sampleViewZ = getViewZ( sampleDepth );","\t\tvec3 sampleViewPosition = getViewPosition( sampleUv, sampleDepth, sampleViewZ );","\t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );","\t\tweightSum += 1.0;","\t}","\tif( weightSum == 0.0 ) discard;","\treturn occlusionSum * ( intensity / weightSum );","}","void main() {","\tfloat centerDepth = getDepth( vUv );","\tif( centerDepth >= ( 1.0 - EPSILON ) ) {","\t\tdiscard;","\t}","\tfloat centerViewZ = getViewZ( centerDepth );","\tvec3 viewPosition = getViewPosition( vUv, centerDepth, centerViewZ );","\tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );","\tgl_FragColor = getDefaultColor( vUv );","\tgl_FragColor.xyz *=  1.0 - ambientOcclusion;","}"].join("\n")},DepthLimitedBlurShader={defines:{KERNEL_RADIUS:4,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDiffuse:{type:"t",value:null},size:{type:"v2",value:new Vector2(512,512)},sampleUvOffsets:{type:"v2v",value:[new Vector2(0,0)]},sampleWeights:{type:"1fv",value:[1]},tDepth:{type:"t",value:null},cameraNear:{type:"f",value:10},cameraFar:{type:"f",value:1e3},depthCutoff:{type:"f",value:10}},vertexShader:["#include <common>","uniform vec2 size;","varying vec2 vUv;","varying vec2 vInvSize;","void main() {","\tvUv = uv;","\tvInvSize = 1.0 / size;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","#include <packing>","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","uniform float cameraNear;","uniform float cameraFar;","uniform float depthCutoff;","uniform vec2 sampleUvOffsets[ KERNEL_RADIUS + 1 ];","uniform float sampleWeights[ KERNEL_RADIUS + 1 ];","varying vec2 vUv;","varying vec2 vInvSize;","float getDepth( const in vec2 screenPosition ) {","\t#if DEPTH_PACKING == 1","\treturn unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );","\t#else","\treturn texture2D( tDepth, screenPosition ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","void main() {","\tfloat depth = getDepth( vUv );","\tif( depth >= ( 1.0 - EPSILON ) ) {","\t\tdiscard;","\t}","\tfloat centerViewZ = -getViewZ( depth );","\tbool rBreak = false, lBreak = false;","\tfloat weightSum = sampleWeights[0];","\tvec4 diffuseSum = texture2D( tDiffuse, vUv ) * weightSum;","\tfor( int i = 1; i <= KERNEL_RADIUS; i ++ ) {","\t\tfloat sampleWeight = sampleWeights[i];","\t\tvec2 sampleUvOffset = sampleUvOffsets[i] * vInvSize;","\t\tvec2 sampleUv = vUv + sampleUvOffset;","\t\tfloat viewZ = -getViewZ( getDepth( sampleUv ) );","\t\tif( abs( viewZ - centerViewZ ) > depthCutoff ) rBreak = true;","\t\tif( ! rBreak ) {","\t\t\tdiffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;","\t\t\tweightSum += sampleWeight;","\t\t}","\t\tsampleUv = vUv - sampleUvOffset;","\t\tviewZ = -getViewZ( getDepth( sampleUv ) );","\t\tif( abs( viewZ - centerViewZ ) > depthCutoff ) lBreak = true;","\t\tif( ! lBreak ) {","\t\t\tdiffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;","\t\t\tweightSum += sampleWeight;","\t\t}","\t}","\tgl_FragColor = diffuseSum / weightSum;","}"].join("\n")},BlurShaderUtils={createSampleWeights:function(e,t){for(var r=function(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)},n=[],i=0;i<=e;i++)n.push(r(i,t));return n},createSampleOffsets:function(e,t){for(var r=[],i=0;i<=e;i++)r.push(t.clone().multiplyScalar(i));return r},configure:function(e,t,r,n){e.defines.KERNEL_RADIUS=t,e.uniforms.sampleUvOffsets.value=BlurShaderUtils.createSampleOffsets(t,n),e.uniforms.sampleWeights.value=BlurShaderUtils.createSampleWeights(t,r),e.needsUpdate=!0}},UnpackDepthRGBAShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","#include <packing>","void main() {","float depth = 1.0 - unpackRGBAToDepth( texture2D( tDiffuse, vUv ) );","gl_FragColor = vec4( vec3( depth ), opacity );","}"].join("\n")},SAOPass=function(e,t,r,n,o){(Pass.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.supportsDepthTextureExtension=void 0!==r&&r,this.supportsNormalTexture=void 0!==n&&n,this.originalClearColor=new Color,this.oldClearColor=new Color,this.oldClearAlpha=1,this.params={output:0,saoBias:.5,saoIntensity:.18,saoScale:1,saoKernelRadius:100,saoMinResolution:0,saoBlur:!0,saoBlurRadius:8,saoBlurStdDev:4,saoBlurDepthCutoff:.01},this.resolution=void 0!==o?new Vector2(o.x,o.y):new Vector2(256,256),this.saoRenderTarget=new WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat}),this.blurIntermediateRenderTarget=this.saoRenderTarget.clone(),this.beautyRenderTarget=this.saoRenderTarget.clone(),this.normalRenderTarget=new WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat}),this.depthRenderTarget=this.normalRenderTarget.clone(),this.supportsDepthTextureExtension)&&((r=new DepthTexture).type=UnsignedShortType,r.minFilter=NearestFilter,r.maxFilter=NearestFilter,this.beautyRenderTarget.depthTexture=r,this.beautyRenderTarget.depthBuffer=!0);this.depthMaterial=new MeshDepthMaterial,this.depthMaterial.depthPacking=RGBADepthPacking,this.depthMaterial.blending=NoBlending,this.normalMaterial=new MeshNormalMaterial,this.normalMaterial.blending=NoBlending,void 0===SAOShader&&console.error("SAOPass relies on SAOShader"),this.saoMaterial=new ShaderMaterial({defines:Object.assign({},SAOShader.defines),fragmentShader:SAOShader.fragmentShader,vertexShader:SAOShader.vertexShader,uniforms:UniformsUtils.clone(SAOShader.uniforms)}),this.saoMaterial.extensions.derivatives=!0,this.saoMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.saoMaterial.defines.NORMAL_TEXTURE=this.supportsNormalTexture?1:0,this.saoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.saoMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?r:this.depthRenderTarget.texture,this.saoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.saoMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.blending=NoBlending,void 0===DepthLimitedBlurShader&&console.error("SAOPass relies on DepthLimitedBlurShader"),this.vBlurMaterial=new ShaderMaterial({uniforms:UniformsUtils.clone(DepthLimitedBlurShader.uniforms),defines:Object.assign({},DepthLimitedBlurShader.defines),vertexShader:DepthLimitedBlurShader.vertexShader,fragmentShader:DepthLimitedBlurShader.fragmentShader}),this.vBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.vBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.vBlurMaterial.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.vBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?r:this.depthRenderTarget.texture,this.vBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.vBlurMaterial.blending=NoBlending,this.hBlurMaterial=new ShaderMaterial({uniforms:UniformsUtils.clone(DepthLimitedBlurShader.uniforms),defines:Object.assign({},DepthLimitedBlurShader.defines),vertexShader:DepthLimitedBlurShader.vertexShader,fragmentShader:DepthLimitedBlurShader.fragmentShader}),this.hBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.hBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.hBlurMaterial.uniforms.tDiffuse.value=this.blurIntermediateRenderTarget.texture,this.hBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?r:this.depthRenderTarget.texture,this.hBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.hBlurMaterial.blending=NoBlending,void 0===CopyShader&&console.error("SAOPass relies on CopyShader"),this.materialCopy=new ShaderMaterial({uniforms:UniformsUtils.clone(CopyShader.uniforms),vertexShader:CopyShader.vertexShader,fragmentShader:CopyShader.fragmentShader,blending:NoBlending}),this.materialCopy.transparent=!0,this.materialCopy.depthTest=!1,this.materialCopy.depthWrite=!1,this.materialCopy.blending=CustomBlending,this.materialCopy.blendSrc=DstColorFactor,this.materialCopy.blendDst=ZeroFactor,this.materialCopy.blendEquation=AddEquation,this.materialCopy.blendSrcAlpha=DstAlphaFactor,this.materialCopy.blendDstAlpha=ZeroFactor,this.materialCopy.blendEquationAlpha=AddEquation,void 0===CopyShader&&console.error("SAOPass relies on UnpackDepthRGBAShader"),this.depthCopy=new ShaderMaterial({uniforms:UniformsUtils.clone(UnpackDepthRGBAShader.uniforms),vertexShader:UnpackDepthRGBAShader.vertexShader,fragmentShader:UnpackDepthRGBAShader.fragmentShader,blending:NoBlending}),this.quadCamera=new OrthographicCamera(-1,1,1,-1,0,1),this.quadScene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quadScene.add(this.quad)};SAOPass.OUTPUT={Beauty:1,Default:0,SAO:2,Depth:3,Normal:4},SAOPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:SAOPass,render:function(e,t,r,n,o){if(this.renderToScreen&&(this.materialCopy.blending=NoBlending,this.materialCopy.uniforms.tDiffuse.value=r.texture,this.materialCopy.needsUpdate=!0,this.renderPass(e,this.materialCopy,null)),1!==this.params.output){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var l=e.autoClear;e.autoClear=!1,e.setRenderTarget(this.depthRenderTarget),e.clear(),this.saoMaterial.uniforms.bias.value=this.params.saoBias,this.saoMaterial.uniforms.intensity.value=this.params.saoIntensity,this.saoMaterial.uniforms.scale.value=this.params.saoScale,this.saoMaterial.uniforms.kernelRadius.value=this.params.saoKernelRadius,this.saoMaterial.uniforms.minResolution.value=this.params.saoMinResolution,this.saoMaterial.uniforms.cameraNear.value=this.camera.near,this.saoMaterial.uniforms.cameraFar.value=this.camera.far;var c=this.params.saoBlurDepthCutoff*(this.camera.far-this.camera.near);this.vBlurMaterial.uniforms.depthCutoff.value=c,this.hBlurMaterial.uniforms.depthCutoff.value=c,this.vBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.vBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.hBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.hBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.params.saoBlurRadius=Math.floor(this.params.saoBlurRadius),this.prevStdDev===this.params.saoBlurStdDev&&this.prevNumSamples===this.params.saoBlurRadius||(BlurShaderUtils.configure(this.vBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new Vector2(0,1)),BlurShaderUtils.configure(this.hBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new Vector2(1,0)),this.prevStdDev=this.params.saoBlurStdDev,this.prevNumSamples=this.params.saoBlurRadius),e.setClearColor(0),e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.supportsDepthTextureExtension||this.renderOverride(e,this.depthMaterial,this.depthRenderTarget,0,1),this.supportsNormalTexture&&this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.renderPass(e,this.saoMaterial,this.saoRenderTarget,16777215,1),this.params.saoBlur&&(this.renderPass(e,this.vBlurMaterial,this.blurIntermediateRenderTarget,16777215,1),this.renderPass(e,this.hBlurMaterial,this.saoRenderTarget,16777215,1));var h=this.materialCopy;3===this.params.output?this.supportsDepthTextureExtension?(this.materialCopy.uniforms.tDiffuse.value=this.beautyRenderTarget.depthTexture,this.materialCopy.needsUpdate=!0):(this.depthCopy.uniforms.tDiffuse.value=this.depthRenderTarget.texture,this.depthCopy.needsUpdate=!0,h=this.depthCopy):4===this.params.output?(this.materialCopy.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.materialCopy.needsUpdate=!0):(this.materialCopy.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.materialCopy.needsUpdate=!0),0===this.params.output?h.blending=CustomBlending:h.blending=NoBlending,this.renderPass(e,h,this.renderToScreen?null:r),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=l}},renderPass:function(e,t,r,n,o){this.originalClearColor.copy(e.getClearColor());var l=e.getClearAlpha(),c=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=n&&(e.setClearColor(n),e.setClearAlpha(o||0),e.clear()),this.quad.material=t,e.render(this.quadScene,this.quadCamera),e.autoClear=c,e.setClearColor(this.originalClearColor),e.setClearAlpha(l)},renderOverride:function(e,t,r,n,o){this.originalClearColor.copy(e.getClearColor());var l=e.getClearAlpha(),c=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,n=t.clearColor||n,o=t.clearAlpha||o,null!=n&&(e.setClearColor(n),e.setClearAlpha(o||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=c,e.setClearColor(this.originalClearColor),e.setClearAlpha(l)},setSize:function(e,t){this.beautyRenderTarget.setSize(e,t),this.saoRenderTarget.setSize(e,t),this.blurIntermediateRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.depthRenderTarget.setSize(e,t),this.saoMaterial.uniforms.size.value.set(e,t),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.needsUpdate=!0,this.vBlurMaterial.uniforms.size.value.set(e,t),this.vBlurMaterial.needsUpdate=!0,this.hBlurMaterial.uniforms.size.value.set(e,t),this.hBlurMaterial.needsUpdate=!0}});var SavePass=function(e){Pass.call(this),void 0===CopyShader&&console.error("SavePass relies on CopyShader");var t=CopyShader;this.textureID="tDiffuse",this.uniforms=UniformsUtils.clone(t.uniforms),this.material=new ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.renderTarget=e,void 0===this.renderTarget&&(this.renderTarget=new WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBFormat,stencilBuffer:!1}),this.renderTarget.texture.name="SavePass.rt"),this.needsSwap=!1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};SavePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:SavePass,render:function(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.quad.material=this.material,e.setRenderTarget(this.renderTarget),this.clear&&e.clear(),e.render(this.scene,this.camera)}});var SMAAShader=[{defines:{SMAA_THRESHOLD:"0.1"},uniforms:{tDiffuse:{value:null},resolution:{value:new Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","void SMAAEdgeDetectionVS( vec2 texcoord ) {","vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );","vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );","vOffset[ 2 ] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );","}","void main() {","vUv = uv;","SMAAEdgeDetectionVS( vUv );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {","vec2 threshold = vec2( SMAA_THRESHOLD, SMAA_THRESHOLD );","vec4 delta;","vec3 C = texture2D( colorTex, texcoord ).rgb;","vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;","vec3 t = abs( C - Cleft );","delta.x = max( max( t.r, t.g ), t.b );","vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;","t = abs( C - Ctop );","delta.y = max( max( t.r, t.g ), t.b );","vec2 edges = step( threshold, delta.xy );","if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )","discard;","vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;","t = abs( C - Cright );","delta.z = max( max( t.r, t.g ), t.b );","vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;","t = abs( C - Cbottom );","delta.w = max( max( t.r, t.g ), t.b );","float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );","vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;","t = abs( C - Cleftleft );","delta.z = max( max( t.r, t.g ), t.b );","vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;","t = abs( C - Ctoptop );","delta.w = max( max( t.r, t.g ), t.b );","maxDelta = max( max( maxDelta, delta.z ), delta.w );","edges.xy *= step( 0.5 * maxDelta, delta.xy );","return vec4( edges, 0.0, 0.0 );","}","void main() {","gl_FragColor = SMAAColorEdgeDetectionPS( vUv, vOffset, tDiffuse );","}"].join("\n")},{defines:{SMAA_MAX_SEARCH_STEPS:"8",SMAA_AREATEX_MAX_DISTANCE:"16",SMAA_AREATEX_PIXEL_SIZE:"( 1.0 / vec2( 160.0, 560.0 ) )",SMAA_AREATEX_SUBTEX_SIZE:"( 1.0 / 7.0 )"},uniforms:{tDiffuse:{value:null},tArea:{value:null},tSearch:{value:null},resolution:{value:new Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 3 ];","varying vec2 vPixcoord;","void SMAABlendingWeightCalculationVS( vec2 texcoord ) {","vPixcoord = texcoord / resolution;","vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );","vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );","vOffset[ 2 ] = vec4( vOffset[ 0 ].xz, vOffset[ 1 ].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( SMAA_MAX_SEARCH_STEPS );","}","void main() {","vUv = uv;","SMAABlendingWeightCalculationVS( vUv );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define SMAASampleLevelZeroOffset( tex, coord, offset ) texture2D( tex, coord + float( offset ) * resolution, 0.0 )","uniform sampler2D tDiffuse;","uniform sampler2D tArea;","uniform sampler2D tSearch;","uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[3];","varying vec2 vPixcoord;","vec2 round( vec2 x ) {","return sign( x ) * floor( abs( x ) + 0.5 );","}","float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {","e.r = bias + e.r * scale;","return 255.0 * texture2D( searchTex, e, 0.0 ).r;","}","float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","vec2 e = vec2( 0.0, 1.0 );","for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","e = texture2D( edgesTex, texcoord, 0.0 ).rg;","texcoord -= vec2( 2.0, 0.0 ) * resolution;","if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;","}","texcoord.x += 0.25 * resolution.x;","texcoord.x += resolution.x;","texcoord.x += 2.0 * resolution.x;","texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);","return texcoord.x;","}","float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","vec2 e = vec2( 0.0, 1.0 );","for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","e = texture2D( edgesTex, texcoord, 0.0 ).rg;","texcoord += vec2( 2.0, 0.0 ) * resolution;","if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;","}","texcoord.x -= 0.25 * resolution.x;","texcoord.x -= resolution.x;","texcoord.x -= 2.0 * resolution.x;","texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );","return texcoord.x;","}","float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","vec2 e = vec2( 1.0, 0.0 );","for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","e = texture2D( edgesTex, texcoord, 0.0 ).rg;","texcoord += vec2( 0.0, 2.0 ) * resolution;","if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;","}","texcoord.y -= 0.25 * resolution.y;","texcoord.y -= resolution.y;","texcoord.y -= 2.0 * resolution.y;","texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );","return texcoord.y;","}","float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {","vec2 e = vec2( 1.0, 0.0 );","for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) {","e = texture2D( edgesTex, texcoord, 0.0 ).rg;","texcoord -= vec2( 0.0, 2.0 ) * resolution;","if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;","}","texcoord.y += 0.25 * resolution.y;","texcoord.y += resolution.y;","texcoord.y += 2.0 * resolution.y;","texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );","return texcoord.y;","}","vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {","vec2 texcoord = float( SMAA_AREATEX_MAX_DISTANCE ) * round( 4.0 * vec2( e1, e2 ) ) + dist;","texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );","texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;","return texture2D( areaTex, texcoord, 0.0 ).rg;","}","vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {","vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );","vec2 e = texture2D( edgesTex, texcoord ).rg;","if ( e.g > 0.0 ) {","vec2 d;","vec2 coords;","coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );","coords.y = offset[ 1 ].y;","d.x = coords.x;","float e1 = texture2D( edgesTex, coords, 0.0 ).r;","coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );","d.y = coords.x;","d = d / resolution.x - pixcoord.x;","vec2 sqrt_d = sqrt( abs( d ) );","coords.y -= 1.0 * resolution.y;","float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 1, 0 ) ).r;","weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );","}","if ( e.r > 0.0 ) {","vec2 d;","vec2 coords;","coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );","coords.x = offset[ 0 ].x;","d.x = coords.y;","float e1 = texture2D( edgesTex, coords, 0.0 ).g;","coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );","d.y = coords.y;","d = d / resolution.y - pixcoord.y;","vec2 sqrt_d = sqrt( abs( d ) );","coords.y -= 1.0 * resolution.y;","float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 0, 1 ) ).g;","weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );","}","return weights;","}","void main() {","gl_FragColor = SMAABlendingWeightCalculationPS( vUv, vPixcoord, vOffset, tDiffuse, tArea, tSearch, ivec4( 0.0 ) );","}"].join("\n")},{uniforms:{tDiffuse:{value:null},tColor:{value:null},resolution:{value:new Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 2 ];","void SMAANeighborhoodBlendingVS( vec2 texcoord ) {","vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );","vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );","}","void main() {","vUv = uv;","SMAANeighborhoodBlendingVS( vUv );","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tColor;","uniform vec2 resolution;","varying vec2 vUv;","varying vec4 vOffset[ 2 ];","vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {","vec4 a;","a.xz = texture2D( blendTex, texcoord ).xz;","a.y = texture2D( blendTex, offset[ 1 ].zw ).g;","a.w = texture2D( blendTex, offset[ 1 ].xy ).a;","if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {","return texture2D( colorTex, texcoord, 0.0 );","} else {","vec2 offset;","offset.x = a.a > a.b ? a.a : -a.b;","offset.y = a.g > a.r ? -a.g : a.r;","if ( abs( offset.x ) > abs( offset.y )) {","offset.y = 0.0;","} else {","offset.x = 0.0;","}","vec4 C = texture2D( colorTex, texcoord, 0.0 );","texcoord += sign( offset ) * resolution;","vec4 Cop = texture2D( colorTex, texcoord, 0.0 );","float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );","C.xyz = pow(C.xyz, vec3(2.2));","Cop.xyz = pow(Cop.xyz, vec3(2.2));","vec4 mixed = mix(C, Cop, s);","mixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));","return mixed;","}","}","void main() {","gl_FragColor = SMAANeighborhoodBlendingPS( vUv, vOffset, tColor, tDiffuse );","}"].join("\n")}],SMAAPass=function(e,t){Pass.call(this),this.edgesRT=new WebGLRenderTarget(e,t,{depthBuffer:!1,stencilBuffer:!1,generateMipmaps:!1,minFilter:LinearFilter,format:RGBFormat}),this.edgesRT.texture.name="SMAAPass.edges",this.weightsRT=new WebGLRenderTarget(e,t,{depthBuffer:!1,stencilBuffer:!1,generateMipmaps:!1,minFilter:LinearFilter,format:RGBAFormat}),this.weightsRT.texture.name="SMAAPass.weights";var r=this,n=new Image;n.src=this.getAreaTexture(),n.onload=function(){r.areaTexture.needsUpdate=!0},this.areaTexture=new Texture,this.areaTexture.name="SMAAPass.area",this.areaTexture.image=n,this.areaTexture.format=RGBFormat,this.areaTexture.minFilter=LinearFilter,this.areaTexture.generateMipmaps=!1,this.areaTexture.flipY=!1;var o=new Image;o.src=this.getSearchTexture(),o.onload=function(){r.searchTexture.needsUpdate=!0},this.searchTexture=new Texture,this.searchTexture.name="SMAAPass.search",this.searchTexture.image=o,this.searchTexture.magFilter=NearestFilter,this.searchTexture.minFilter=NearestFilter,this.searchTexture.generateMipmaps=!1,this.searchTexture.flipY=!1,void 0===SMAAShader&&console.error("SMAAPass relies on SMAAShader"),this.uniformsEdges=UniformsUtils.clone(SMAAShader[0].uniforms),this.uniformsEdges.resolution.value.set(1/e,1/t),this.materialEdges=new ShaderMaterial({defines:Object.assign({},SMAAShader[0].defines),uniforms:this.uniformsEdges,vertexShader:SMAAShader[0].vertexShader,fragmentShader:SMAAShader[0].fragmentShader}),this.uniformsWeights=UniformsUtils.clone(SMAAShader[1].uniforms),this.uniformsWeights.resolution.value.set(1/e,1/t),this.uniformsWeights.tDiffuse.value=this.edgesRT.texture,this.uniformsWeights.tArea.value=this.areaTexture,this.uniformsWeights.tSearch.value=this.searchTexture,this.materialWeights=new ShaderMaterial({defines:Object.assign({},SMAAShader[1].defines),uniforms:this.uniformsWeights,vertexShader:SMAAShader[1].vertexShader,fragmentShader:SMAAShader[1].fragmentShader}),this.uniformsBlend=UniformsUtils.clone(SMAAShader[2].uniforms),this.uniformsBlend.resolution.value.set(1/e,1/t),this.uniformsBlend.tDiffuse.value=this.weightsRT.texture,this.materialBlend=new ShaderMaterial({uniforms:this.uniformsBlend,vertexShader:SMAAShader[2].vertexShader,fragmentShader:SMAAShader[2].fragmentShader}),this.needsSwap=!1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};SMAAPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:SMAAPass,render:function(e,t,r,n,o){this.uniformsEdges.tDiffuse.value=r.texture,this.quad.material=this.materialEdges,e.setRenderTarget(this.edgesRT),this.clear&&e.clear(),e.render(this.scene,this.camera),this.quad.material=this.materialWeights,e.setRenderTarget(this.weightsRT),this.clear&&e.clear(),e.render(this.scene,this.camera),this.uniformsBlend.tColor.value=r.texture,this.quad.material=this.materialBlend,this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera))},setSize:function(e,t){this.edgesRT.setSize(e,t),this.weightsRT.setSize(e,t),this.materialEdges.uniforms.resolution.value.set(1/e,1/t),this.materialWeights.uniforms.resolution.value.set(1/e,1/t),this.materialBlend.uniforms.resolution.value.set(1/e,1/t)},getAreaTexture:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAIAAACOVPcQAACBeklEQVR42u39W4xlWXrnh/3WWvuciIzMrKxrV8/0rWbY0+SQFKcb4owIkSIFCjY9AC1BT/LYBozRi+EX+cV+8IMsYAaCwRcBwjzMiw2jAWtgwC8WR5Q8mDFHZLNHTarZGrLJJllt1W2qKrsumZWZcTvn7L3W54e1vrXX3vuciLPPORFR1XE2EomorB0nVuz//r71re/y/1eMvb4Cb3N11xV/PP/2v4UBAwJG/7H8urx6/25/Gf8O5hypMQ0EEEQwAqLfoN/Z+97f/SW+/NvcgQk4sGBJK6H7N4PFVL+K+e0N11yNfkKvwUdwdlUAXPHHL38oa15f/i/46Ih6SuMSPmLAYAwyRKn7dfMGH97jaMFBYCJUgotIC2YAdu+LyW9vvubxAP8kAL8H/koAuOKP3+q6+xGnd5kdYCeECnGIJViwGJMAkQKfDvB3WZxjLKGh8VSCCzhwEWBpMc5/kBbjawT4HnwJfhr+pPBIu7uu+OOTo9vsmtQcniMBGkKFd4jDWMSCRUpLjJYNJkM+IRzQ+PQvIeAMTrBS2LEiaiR9b/5PuT6Ap/AcfAFO4Y3dA3DFH7/VS+M8k4baEAQfMI4QfbVDDGIRg7GKaIY52qAjTAgTvGBAPGIIghOCYAUrGFNgzA7Q3QhgCwfwAnwe5vDejgG44o/fbm1C5ZlYQvQDARPAIQGxCWBM+wWl37ZQESb4gImexGMDouhGLx1Cst0Saa4b4AqO4Hk4gxo+3DHAV/nx27p3JziPM2pVgoiia5MdEzCGULprIN7gEEeQ5IQxEBBBQnxhsDb5auGmAAYcHMA9eAAz8PBol8/xij9+C4Djlim4gJjWcwZBhCBgMIIYxGAVIkH3ZtcBuLdtRFMWsPGoY9rN+HoBji9VBYdwD2ZQg4cnO7OSq/z4rU5KKdwVbFAjNojCQzTlCLPFSxtamwh2jMUcEgg2Wm/6XgErIBhBckQtGN3CzbVacERgCnfgLswhnvqf7QyAq/z4rRZm1YglYE3affGITaZsdIe2FmMIpnOCap25I6jt2kCwCW0D1uAD9sZctNGXcQIHCkINDQgc78aCr+zjtw3BU/ijdpw3zhCwcaONwBvdeS2YZKkJNJsMPf2JKEvC28RXxxI0ASJyzQCjCEQrO4Q7sFArEzjZhaFc4cdv+/JFdKULM4px0DfUBI2hIsy06BqLhGTQEVdbfAIZXYMPesq6VoCHICzUyjwInO4Y411//LYLs6TDa9wvg2CC2rElgAnpTBziThxaL22MYhzfkghz6GAs2VHbbdM91VZu1MEEpupMMwKyVTb5ij9+u4VJG/5EgEMMmFF01cFai3isRbKbzb+YaU/MQbAm2XSMoUPAmvZzbuKYRIFApbtlrfFuUGd6vq2hXNnH78ZLh/iFhsQG3T4D1ib7k5CC6vY0DCbtrohgLEIClXiGtl10zc0CnEGIhhatLBva7NP58Tvw0qE8yWhARLQ8h4+AhQSP+I4F5xoU+VilGRJs6wnS7ruti/4KvAY/CfdgqjsMy4pf8fodQO8/gnuX3f/3xi3om1/h7THr+co3x93PP9+FBUfbNUjcjEmhcrkT+8K7ml7V10Jo05mpIEFy1NmCJWx9SIKKt+EjAL4Ez8EBVOB6havuT/rByPvHXK+9zUcfcbb254+9fydJknYnRr1oGfdaiAgpxu1Rx/Rek8KISftx3L+DfsLWAANn8Hvw0/AFeAGO9DFV3c6D+CcWbL8Dj9e7f+T1k8AZv/d7+PXWM/Z+VvdCrIvuAKO09RpEEQJM0Ci6+B4xhTWr4cZNOvhktabw0ta0rSJmqz3Yw5/AKXwenod7cAhTmBSPKf6JBdvH8IP17h95pXqw50/+BFnj88fev4NchyaK47OPhhtI8RFSvAfDSNh0Ck0p2gLxGkib5NJj/JWCr90EWQJvwBzO4AHcgztwAFN1evHPUVGwfXON+0debT1YeGON9Yy9/63X+OguiwmhIhQhD7l4sMqlG3D86Suc3qWZ4rWjI1X7u0Ytw6x3rIMeIOPDprfe2XzNgyj6PahhBjO4C3e6puDgXrdg+/5l948vF3bqwZetZ+z9Rx9zdIY5pInPK4Nk0t+l52xdK2B45Qd87nM8fsD5EfUhIcJcERw4RdqqH7Yde5V7m1vhNmtedkz6EDzUMF/2jJYWbC+4fzzA/Y+/8PPH3j9dcBAPIRP8JLXd5BpAu03aziOL3VVHZzz3CXWDPWd+SH2AnxIqQoTZpo9Ckc6HIrFbAbzNmlcg8Ag8NFDDAhbJvTBZXbC94P7t68EXfv6o+21gUtPETU7bbkLxvNKRFG2+KXzvtObonPP4rBvsgmaKj404DlshFole1Glfh02fE7bYR7dZ82oTewIBGn1Md6CG6YUF26X376oevOLzx95vhUmgblI6LBZwTCDY7vMq0op5WVXgsObOXJ+1x3qaBl9j1FeLxbhU9w1F+Wiba6s1X/TBz1LnUfuYDi4r2C69f1f14BWfP+p+W2GFKuC9phcELMYRRLur9DEZTUdEH+iEqWdaM7X4WOoPGI+ZYD2+wcQ+y+ioHUZ9dTDbArzxmi/bJI9BND0Ynd6lBdve/butBw8+f/T9D3ABa3AG8W3VPX4hBin+bj8dMMmSpp5pg7fJ6xrBFE2WQQEWnV8Qg3FbAWzYfM1rREEnmvkN2o1+acG2d/9u68GDzx91v3mAjb1zkpqT21OipPKO0b9TO5W0nTdOmAQm0TObts3aBKgwARtoPDiCT0gHgwnbArzxmtcLc08HgF1asN0C4Ms/fvD5I+7PhfqyXE/b7RbbrGyRQRT9ARZcwAUmgdoz0ehJ9Fn7QAhUjhDAQSw0bV3T3WbNa59jzmiP6GsWbGXDX2ytjy8+f9T97fiBPq9YeLdBmyuizZHaqXITnXiMUEEVcJ7K4j3BFPurtB4bixW8wTpweL8DC95szWMOqucFYGsWbGU7p3TxxxefP+r+oTVktxY0v5hbq3KiOKYnY8ddJVSBxuMMVffNbxwIOERShst73HZ78DZrHpmJmH3K6sGz0fe3UUj0eyRrSCGTTc+rjVNoGzNSv05srAxUBh8IhqChiQgVNIIBH3AVPnrsnXQZbLTm8ammv8eVXn/vWpaTem5IXRlt+U/LA21zhSb9cye6jcOfCnOwhIAYXAMVTUNV0QhVha9xjgA27ODJbLbmitt3tRN80lqG6N/khgot4ZVlOyO4WNg3OIMzhIZQpUEHieg2im6F91hB3I2tubql6BYNN9Hj5S7G0G2tahslBWKDnOiIvuAEDzakDQKDNFQT6gbn8E2y4BBubM230YIpBnDbMa+y3dx0n1S0BtuG62lCCXwcY0F72T1VRR3t2ONcsmDjbmzNt9RFs2LO2hQNyb022JisaI8rAWuw4HI3FuAIhZdOGIcdjLJvvObqlpqvWTJnnQbyi/1M9O8UxWhBs//H42I0q1Yb/XPGONzcmm+ri172mHKvZBpHkJaNJz6v9jxqiklDj3U4CA2ugpAaYMWqNXsdXbmJNd9egCnJEsphXNM+MnK3m0FCJ5S1kmJpa3DgPVbnQnPGWIDspW9ozbcO4K/9LkfaQO2KHuqlfFXSbdNzcEcwoqNEFE9zcIXu9/6n/ym/BC/C3aJLzEKPuYVlbFnfhZ8kcWxV3dbv4bKl28566wD+8C53aw49lTABp9PWbsB+knfc/Li3eVizf5vv/xmvnPKg5ihwKEwlrcHqucuVcVOxEv8aH37E3ZqpZypUulrHEtIWKUr+txHg+ojZDGlwnqmkGlzcVi1dLiNSJiHjfbRNOPwKpx9TVdTn3K05DBx4psIk4Ei8aCkJahRgffk4YnEXe07T4H2RR1u27E6wfQsBDofUgjFUFnwC2AiVtA+05J2zpiDK2Oa0c5fmAecN1iJzmpqFZxqYBCYhFTCsUNEmUnIcZ6aEA5rQVhEywG6w7HSW02XfOoBlQmjwulOFQAg66SvJblrTEX1YtJ3uG15T/BH1OfOQeuR8g/c0gdpT5fx2SKbs9EfHTKdM8A1GaJRHLVIwhcGyydZsbifAFVKl5EMKNU2Hryo+06BeTgqnxzYjThVySDikbtJPieco75lYfKAJOMEZBTjoITuWHXXZVhcUDIS2hpiXHV9Ku4u44bN5OYLDOkJo8w+xJSMbhBRHEdEs9JZUCkQrPMAvaHyLkxgkEHxiNkx/x2YB0mGsQ8EUWj/stW5YLhtS5SMu+/YBbNPDCkGTUybN8krRLBGPlZkVOA0j+a1+rkyQKWGaPHPLZOkJhioQYnVZ2hS3zVxMtgC46KuRwbJNd9nV2PHgb36F194ecf/Yeu2vAFe5nm/bRBFrnY4BauE8ERmZRFUn0k8hbftiVYSKMEme2dJCJSCGYAlNqh87bXOPdUkGy24P6d1ll21MBqqx48Fvv8ZHH8HZFY7j/uAq1xMJUFqCSUlJPmNbIiNsmwuMs/q9CMtsZsFO6SprzCS1Z7QL8xCQClEelpjTduDMsmWD8S1PT152BtvmIGvUeDA/yRn83u/x0/4qxoPHjx+PXY9pqX9bgMvh/Nz9kpP4pOe1/fYf3axUiMdHLlPpZCNjgtNFAhcHEDxTumNONhHrBduW+vOyY++70WWnPXj98eA4kOt/mj/5E05l9+O4o8ePx67HFqyC+qSSnyselqjZGaVK2TadbFLPWAQ4NBhHqDCCV7OTpo34AlSSylPtIdd2AJZlyzYQrDJ5lcWGNceD80CunPLGGzsfD+7wRb95NevJI5docQ3tgCyr5bGnyaPRlmwNsFELViOOx9loebGNq2moDOKpHLVP5al2cymWHbkfzGXL7kfRl44H9wZy33tvt+PB/Xnf93e+nh5ZlU18wCiRUa9m7kib9LYuOk+hudQNbxwm0AQqbfloimaB2lM5fChex+ylMwuTbfmXQtmWlenZljbdXTLuOxjI/fDDHY4Hjx8/Hrse0zXfPFxbUN1kKqSCCSk50m0Ajtx3ub9XHBKHXESb8iO6E+qGytF4nO0OG3SXzbJlhxBnKtKyl0NwybjvYCD30aMdjgePHz8eu56SVTBbgxJMliQ3Oauwg0QHxXE2Ez/EIReLdQj42Gzb4CLS0YJD9xUx7bsi0vJi5mUbW1QzL0h0PFk17rtiIPfJk52MB48fPx67npJJwyrBa2RCCQRTbGZSPCxTPOiND4G2pYyOQ4h4jINIJh5wFU1NFZt+IsZ59LSnDqBjZ2awbOku+yInunLcd8VA7rNnOxkPHj9+PGY9B0MWJJNozOJmlglvDMXDEozdhQWbgs/U6oBanGzLrdSNNnZFjOkmbi5bNt1lX7JLLhn3vXAg9/h4y/Hg8ePHI9dzQMEkWCgdRfYykYKnkP7D4rIujsujaKPBsB54vE2TS00ccvFY/Tth7JXeq1hz+qgVy04sAJawTsvOknHfCwdyT062HA8eP348Zj0vdoXF4pilKa2BROed+9fyw9rWRXeTFXESMOanvDZfJuJaSXouQdMdDJZtekZcLLvEeK04d8m474UDuaenW44Hjx8/Xns9YYqZpszGWB3AN/4VHw+k7WSFtJ3Qicuqb/NlVmgXWsxh570xg2UwxUw3WfO6B5nOuO8aA7lnZxuPB48fPx6znm1i4bsfcbaptF3zNT78eFPtwi1OaCNOqp1x3zUGcs/PN++AGD1+fMXrSVm2baTtPhPahbPhA71wIHd2bXzRa69nG+3CraTtPivahV/55tXWg8fyRY/9AdsY8VbSdp8V7cKrrgdfM//z6ILQFtJ2nxHtwmuoB4/kf74+gLeRtvvMaBdeSz34+vifx0YG20jbfTa0C6+tHrwe//NmOG0L8EbSdp8R7cLrrQe/996O+ai3ujQOskpTNULa7jOjXXj99eCd8lHvoFiwsbTdZ0a78PrrwTvlo966pLuRtB2fFe3Cm6oHP9kNH/W2FryxtN1nTLvwRurBO+Kj3pWXHidtx2dFu/Bm68Fb81HvykuPlrb7LGkX3mw9eGs+6h1Y8MbSdjegXcguQLjmevDpTQLMxtJ2N6NdyBZu9AbrwVvwUW+LbteULUpCdqm0HTelXbhNPe8G68Gb8lFvVfYfSNuxvrTdTWoXbozAzdaDZzfkorOj1oxVxlIMlpSIlpLrt8D4hrQL17z+c3h6hU/wv4Q/utps4+bm+6P/hIcf0JwQ5oQGPBL0eKPTYEXTW+eL/2DKn73J9BTXYANG57hz1cEMviVf/4tf5b/6C5pTQkMIWoAq7hTpOJjtAM4pxKu5vg5vXeUrtI09/Mo/5H+4z+Mp5xULh7cEm2QbRP2tFIKR7WM3fPf/jZ3SWCqLM2l4NxID5zB72HQXv3jj/8mLR5xXNA5v8EbFQEz7PpRfl1+MB/hlAN65qgDn3wTgH13hK7T59bmP+NIx1SHHU84nLOITt3iVz8mNO+lPrjGAnBFqmioNn1mTyk1ta47R6d4MrX7tjrnjYUpdUbv2rVr6YpVfsGG58AG8Ah9eyUN8CX4WfgV+G8LVWPDGb+Zd4cU584CtqSbMKxauxTg+dyn/LkVgA+IR8KHtejeFKRtTmLLpxN6mYVLjYxwXf5x2VofiZcp/lwKk4wGOpYDnoIZPdg/AAbwMfx0+ge9dgZvYjuqKe4HnGnykYo5TvJbG0Vj12JagRhwKa44H95ShkZa5RyLGGdfYvG7aw1TsF6iapPAS29mNS3NmsTQZCmgTzFwgL3upCTgtBTRwvGMAKrgLn4evwin8+afJRcff+8izUGUM63GOOuAs3tJkw7J4kyoNreqrpO6cYLQeFUd7TTpr5YOTLc9RUUogUOVJQ1GYJaFLAW0oTmKyYS46ZooP4S4EON3xQ5zC8/CX4CnM4c1PE8ApexpoYuzqlP3d4S3OJP8ZDK7cKWNaTlqmgDiiHwl1YsE41w1zT4iRTm3DBqxvOUsbMKKDa/EHxagtnta072ejc3DOIh5ojvh8l3tk1JF/AV6FU6jh3U8HwEazLgdCLYSQ+MYiAI2ltomkzttUb0gGHdSUUgsIYjTzLG3mObX4FBRaYtpDVNZrih9TgTeYOBxsEnN1gOCTM8Bsw/ieMc75w9kuAT6A+/AiHGvN/+Gn4KRkiuzpNNDYhDGFndWRpE6SVfm8U5bxnSgVV2jrg6JCKmneqey8VMFgq2+AM/i4L4RUbfSi27lNXZ7R7W9RTcq/q9fk4Xw3AMQd4I5ifAZz8FcVtm9SAom/dyN4lczJQW/kC42ZrHgcCoIf1oVMKkVItmMBi9cOeNHGLqOZk+QqQmrbc5YmYgxELUUN35z2iohstgfLIFmcMV7s4CFmI74L9+EFmGsi+tGnAOD4Yk9gIpo01Y4cA43BWGygMdr4YZekG3OBIUXXNukvJS8tqa06e+lSDCtnqqMFu6hWHXCF+WaYt64m9QBmNxi7Ioy7D+fa1yHw+FMAcPt7SysFLtoG4PXAk7JOA3aAxBRqUiAdU9Yp5lK3HLSRFtOim0sa8euEt08xvKjYjzeJ2GU7YawexrnKI9tmobInjFXCewpwriY9+RR4aaezFhMhGCppKwom0ChrgFlKzyPKkGlTW1YQrE9HJqu8hKGgMc6hVi5QRq0PZxNfrYNgE64utmRv6KKHRpxf6VDUaOvNP5jCEx5q185My/7RKz69UQu2im5k4/eownpxZxNLwiZ1AZTO2ZjWjkU9uaB2HFn6Q3u0JcsSx/qV9hTEApRzeBLDJQXxYmTnq7bdLa3+uqFrxLJ5w1TehnNHx5ECvCh2g2c3hHH5YsfdaSKddztfjQ6imKFGSyFwlLzxEGPp6r5IevVjk1AMx3wMqi1NxDVjLBiPs9tbsCkIY5we5/ML22zrCScFxnNtzsr9Wcc3CnD+pYO+4VXXiDE0oc/vQQ/fDK3oPESJMYXNmJa/DuloJZkcTpcYE8lIH8Dz8DJMiynNC86Mb2lNaaqP/+L7f2fcE/yP7/Lde8xfgSOdMxvOixZf/9p3+M4hT1+F+zApxg9XfUvYjc8qX2lfOOpK2gNRtB4flpFu9FTKCp2XJRgXnX6olp1zyYjTKJSkGmLE2NjUr1bxFM4AeAAHBUFIeSLqXR+NvH/M9fOnfHzOD2vCSyQJKzfgsCh+yi/Mmc35F2fUrw7miW33W9hBD1vpuUojFphIyvg7aTeoymDkIkeW3XLHmguMzbIAJejN6B5MDrhipE2y6SoFRO/AK/AcHHZHNIfiWrEe/C6cr3f/yOvrQKB+zMM55/GQdLDsR+ifr5Fiuu+/y+M78LzOE5dsNuXC3PYvYWd8NXvphLSkJIasrlD2/HOqQ+RjcRdjKTGWYhhVUm4yxlyiGPuMsZR7sMCHUBeTuNWA7if+ifXgc/hovftHXs/DV+Fvwe+f8shzMiMcweFgBly3//vwJfg5AN4450fn1Hd1Rm1aBLu22Dy3y3H2+OqMemkbGZ4jozcDjJf6596xOLpC0eMTHbKnxLxH27uZ/bMTGs2jOaMOY4m87CfQwF0dw53oa1k80JRuz/XgS+8fX3N9Af4qPIMfzKgCp4H5TDGe9GGeFPzSsZz80SlPTxXjgwJmC45njzgt2vbQ4b4OAdUK4/vWhO8d8v6EE8fMUsfakXbPpFJeLs2ubM/qdm/la3WP91uWhxXHjoWhyRUq2iJ/+5mA73zwIIo+LoZ/SgvIRjAd1IMvvn98PfgOvAJfhhm8scAKVWDuaRaK8aQ9f7vuPDH6Bj47ZXau7rqYJ66mTDwEDU6lLbCjCK0qTXyl5mnDoeNRxanj3FJbaksTk0faXxHxLrssgPkWB9LnA/MFleXcJozzjwsUvUG0X/QCve51qkMDXp9mtcyOy3rwBfdvVJK7D6/ACSzg3RoruIq5UDeESfEmVclDxnniU82vxMLtceD0hGZWzBNPMM/jSPne2OVatiTKUpY5vY7gc0LdUAWeWM5tH+O2I66AOWw9xT2BuyRVLGdoDHUsVRXOo/c+ZdRXvFfnxWyIV4upFLCl9eAL7h8Zv0QH8Ry8pA2cHzQpGesctVA37ZtklBTgHjyvdSeKY/RZw/kJMk0Y25cSNRWSigQtlULPTw+kzuJPeYEkXjQRpoGZobYsLF79pyd1dMRHInbgFTZqNLhDqiIsTNpoex2WLcy0/X6rHcdMMQvFSd5dWA++4P7xv89deACnmr36uGlL69bRCL6BSZsS6c0TU2TKK5gtWCzgAOOwQcurqk9j8whvziZSMLcq5hbuwBEsYjopUBkqw1yYBGpLA97SRElEmx5MCInBY5vgLk94iKqSWmhIGmkJ4Bi9m4L645J68LyY4wsFYBfUg5feP/6gWWm58IEmKQM89hq7KsZNaKtP5TxxrUZZVkNmMJtjbKrGxLNEbHPJxhqy7lAmbC32ZqeF6lTaknRWcYaFpfLUBh/rwaQycCCJmW15Kstv6jRHyJFry2C1ahkkIW0LO75s61+owxK1y3XqweX9m5YLM2DPFeOjn/iiqCKJ+yKXF8t5Yl/kNsqaSCryxPq5xWTFIaP8KSW0RYxqupaUf0RcTNSSdJZGcKYdYA6kdtrtmyBckfKXwqk0pHpUHlwWaffjNRBYFPUDWa8e3Lt/o0R0CdisKDM89cX0pvRHEfM8ca4t0s2Xx4kgo91MPQJ/0c9MQYq0co8MBh7bz1fio0UUHLR4aAIOvOmoYO6kwlEVODSSTliWtOtH6sPkrtctF9ZtJ9GIerBskvhdVS5cFNv9s1BU0AbdUgdK4FG+dRnjFmDTzniRMdZO1QhzMK355vigbdkpz9P6qjUGE5J2qAcXmwJ20cZUiAD0z+pGMx6xkzJkmEf40Hr4qZfVg2XzF9YOyoV5BjzVkUJngKf8lgNYwKECEHrCNDrWZzMlflS3yBhr/InyoUgBc/lKT4pxVrrC6g1YwcceK3BmNxZcAtz3j5EIpqguh9H6wc011YN75cKDLpFDxuwkrPQmUwW4KTbj9mZTwBwLq4aQMUZbHm1rylJ46dzR0dua2n3RYCWZsiHROeywyJGR7mXKlpryyCiouY56sFkBWEnkEB/raeh/Sw4162KeuAxMQpEkzy5alMY5wamMsWKKrtW2WpEWNnReZWONKWjrdsKZarpFjqCslq773PLmEhM448Pc3+FKr1+94vv/rfw4tEcu+lKTBe4kZSdijBrykwv9vbCMPcLQTygBjzVckSLPRVGslqdunwJ4oegtFOYb4SwxNgWLCmD7T9kVjTv5YDgpo0XBmN34Z/rEHp0sgyz7lngsrm4lvMm2Mr1zNOJYJ5cuxuQxwMGJq/TP5emlb8fsQBZviK4t8hFL+zbhtlpwaRSxQRWfeETjuauPsdGxsBVdO7nmP4xvzSoT29pRl7kGqz+k26B3Oy0YNV+SXbbQas1ctC/GarskRdFpKczVAF1ZXnLcpaMuzVe6lZ2g/1ndcvOVgRG3sdUAY1bKD6achijMPdMxV4muKVorSpiDHituH7rSTs7n/4y5DhRXo4FVBN4vO/zbAcxhENzGbHCzU/98Mcx5e7a31kWjw9FCe/zNeYyQjZsWb1uc7U33pN4Mji6hCLhivqfa9Ss6xLg031AgfesA/l99m9fgvnaF9JoE6bYKmkGNK3aPbHB96w3+DnxFm4hs0drLsk7U8kf/N/CvwQNtllna0rjq61sH8L80HAuvwH1tvBy2ChqWSCaYTaGN19sTvlfzFD6n+iKTbvtayfrfe9ueWh6GJFoxLdr7V72a5ZpvHcCPDzma0wTO4EgbLyedxstO81n57LYBOBzyfsOhUKsW1J1BB5vr/tz8RyqOFylQP9Tvst2JALsC5lsH8PyQ40DV4ANzYa4dedNiKNR1s+x2wwbR7q4/4cTxqEk4LWDebfisuo36JXLiWFjOtLrlNWh3K1rRS4xvHcDNlFnNmWBBAl5SWaL3oPOfnvbr5pdjVnEaeBJSYjuLEkyLLsWhKccadmOphZkOPgVdalj2QpSmfOsADhMWE2ZBu4+EEJI4wKTAuCoC4xwQbWXBltpxbjkXJtKxxabo9e7tyhlgb6gNlSbUpMh+l/FaqzVwewGu8BW1Zx7pTpQDJUjb8tsUTW6+GDXbMn3mLbXlXJiGdggxFAoUrtPS3wE4Nk02UZG2OOzlk7fRs7i95QCLo3E0jtrjnM7SR3uS1p4qtS2nJ5OwtQVHgOvArLBFijZUV9QtSl8dAY5d0E0hM0w3HS2DpIeB6m/A1+HfhJcGUq4sOxH+x3f5+VO+Ds9rYNI7zPXOYWPrtf8bYMx6fuOAX5jzNR0PdsuON+X1f7EERxMJJoU6GkTEWBvVolVlb5lh3tKCg6Wx1IbaMDdJ+9sUCc5KC46hKGCk3IVOS4TCqdBNfUs7Kd4iXf2RjnT/LLysJy3XDcHLh/vde3x8DoGvwgsa67vBk91G5Pe/HbOe7xwym0NXbtiuuDkGO2IJDh9oQvJ4cY4vdoqLDuoH9Zl2F/ofsekn8lkuhIlhQcffUtSjytFyp++p6NiE7Rqx/lodgKVoceEp/CP4FfjrquZaTtj2AvH5K/ywpn7M34K/SsoYDAdIN448I1/0/wveW289T1/lX5xBzc8N5IaHr0XMOQdHsIkDuJFifj20pBm5jzwUv9e2FhwRsvhAbalCIuIw3bhJihY3p6nTFFIZgiSYjfTf3aXuOjmeGn4bPoGvwl+CFzTRczBIuHBEeImHc37/lGfwZR0cXzVDOvaKfNHvwe+suZ771K/y/XcBlsoN996JpBhoE2toYxOznNEOS5TJc6Id5GEXLjrWo+LEWGNpPDU4WAwsIRROu+1vM+0oW37z/MBN9kqHnSArwPfgFJ7Cq/Ai3Ie7g7ncmI09v8sjzw9mzOAEXoIHxURueaAce5V80f/DOuuZwHM8vsMb5wBzOFWM7wymTXPAEvm4vcFpZ2ut0VZRjkiP2MlmLd6DIpbGSiHOjdnUHN90hRYmhTnmvhzp1iKDNj+b7t5hi79lWGwQ+HN9RsfFMy0FXbEwhfuczKgCbyxYwBmcFhhvo/7a44v+i3XWcwDP86PzpGQYdWh7csP5dBvZ1jNzdxC8pBGuxqSW5vw40nBpj5JhMwvOzN0RWqERHMr4Lv1kWX84xLR830G3j6yqZ1a8UstTlW+qJPOZ+sZ7xZPKTJLhiNOAFd6tk+jrTH31ncLOxid8+nzRb128HhUcru/y0Wn6iT254YPC6FtVSIMoW2sk727AhvTtrWKZTvgsmckfXYZWeNRXx/3YQ2OUxLDrbHtN11IwrgXT6c8dATDwLniYwxzO4RzuQqTKSC5gAofMZ1QBK3zQ4JWobFbcvJm87FK+6JXrKahLn54m3p+McXzzYtP8VF/QpJuh1OwieElEoI1pRxPS09FBrkq2tWCU59+HdhNtTIqKm8EBrw2RTOEDpG3IKo2Y7mFdLm3ZeVjYwVw11o/oznceMve4CgMfNym/utA/d/ILMR7gpXzRy9eDsgLcgbs8O2Va1L0zzIdwGGemTBuwROHeoMShkUc7P+ISY3KH5ZZeWqO8mFTxQYeXTNuzvvK5FGPdQfuu00DwYFY9dyhctEt+OJDdnucfpmyhzUJzfsJjr29l8S0bXBfwRS9ZT26tmMIdZucch5ZboMz3Nio3nIOsYHCGoDT4kUA9MiXEp9Xsui1S8th/kbWIrMBxDGLodWUQIWcvnXy+9M23xPiSMOiRPqM+YMXkUN3gXFrZJwXGzUaMpJfyRS9ZT0lPe8TpScuRlbMHeUmlaKDoNuy62iWNTWNFYjoxFzuJs8oR+RhRx7O4SVNSXpa0ZJQ0K1LAHDQ+D9IepkMXpcsq5EVCvClBUIzDhDoyKwDw1Lc59GbTeORivugw1IcuaEOaGWdNm+Ps5fQ7/tm0DjMegq3yM3vb5j12qUId5UZD2oxDSEWOZMSqFl/W+5oynWDa/aI04tJRQ2eTXusg86SQVu/nwSYwpW6wLjlqIzwLuxGIvoAvul0PS+ZNz0/akp/pniO/8JDnGyaCkzbhl6YcqmK/69prxPqtpx2+Km9al9sjL+rwMgHw4jE/C8/HQ3m1vBuL1fldbzd8mOueVJ92syqdEY4KJjSCde3mcRw2TA6szxedn+zwhZMps0XrqEsiUjnC1hw0TELC2Ek7uAAdzcheXv1BYLagspxpzSAoZZUsIzIq35MnFQ9DOrlNB30jq3L4pkhccKUAA8/ocvN1Rzx9QyOtERs4CVsJRK/DF71kPYrxYsGsm6RMh4cps5g1DOmM54Ly1ii0Hd3Y/BMk8VWFgBVmhqrkJCPBHAolwZaWzLR9Vb7bcWdX9NyUYE+uB2BKfuaeBUcjDljbYVY4DdtsVWvzRZdWnyUzDpjNl1Du3aloAjVJTNDpcIOVVhrHFF66lLfJL1zJr9PQ2nFJSBaKoDe+sAvLufZVHVzYh7W0h/c6AAZ+7Tvj6q9j68G/cTCS/3n1vLKHZwNi+P+pS0WkZNMBMUl+LDLuiE4omZy71r3UFMwNJV+VJ/GC5ixVUkBStsT4gGKh0Gm4Oy3qvq7Lbmq24nPdDuDR9deR11XzP4vFu3TYzfnIyiSVmgizUYGqkIXNdKTY9pgb9D2Ix5t0+NHkVzCdU03suWkkVZAoCONCn0T35gAeW38de43mf97sMOpSvj4aa1KYUm58USI7Wxxes03bAZdRzk6UtbzMaCQ6IxO0dy7X+XsjoD16hpsBeGz9dfzHj+R/Hp8nCxZRqkEDTaCKCSywjiaoMJ1TITE9eg7Jqnq8HL6gDwiZb0u0V0Rr/rmvqjxKuaLCX7ZWXTvAY+uvm3z8CP7nzVpngqrJpZKwWnCUjIviYVlirlGOzPLI3SMVyp/elvBUjjDkNhrtufFFErQ8pmdSlbK16toBHlt/HV8uHMX/vEGALkV3RJREiSlopxwdMXOZPLZ+ix+kAHpMKIk8UtE1ygtquttwxNhphrIZ1IBzjGF3IIGxGcBj6q8bHJBG8T9vdsoWrTFEuebEZuVxhhClH6P5Zo89OG9fwHNjtNQTpD0TG9PJLEYqvEY6Rlxy+ZZGfL0Aj62/bnQCXp//eeM4KzfQVJbgMQbUjlMFIm6TpcfWlZje7NBSV6IsEVmumWIbjiloUzQX9OzYdo8L1wjw2PrrpimONfmfNyzKklrgnEkSzT5QWYQW40YShyzqsRmMXbvVxKtGuYyMKaU1ugenLDm5Ily4iT14fP11Mx+xJv+zZ3MvnfdFqxU3a1W/FTB4m3Qfsyc1XUcdVhDeUDZXSFHHLQj/Y5jtC7ZqM0CXGwB4bP11i3LhOvzPGygYtiUBiwQV/4wFO0majijGsafHyRLu0yG6q35cL1rOpVxr2s5cM2jJYMCdc10Aj6q/blRpWJ//+dmm5psMl0KA2+AFRx9jMe2WbC4jQxnikd4DU8TwUjRVacgdlhmr3bpddzuJ9zXqr2xnxJfzP29RexdtjDVZqzkqa6PyvcojGrfkXiJ8SEtml/nYskicv0ivlxbqjemwUjMw5evdg8fUX9nOiC/lf94Q2i7MURk9nW1MSj5j8eAyV6y5CN2S6qbnw3vdA1Iwq+XOSCl663udN3IzLnrt+us25cI1+Z83SXQUldqQq0b5XOT17bGpLd6ssN1VMPf8c+jG8L3NeCnMdF+Ra3fRa9dft39/LuZ/3vwHoHrqGmQFafmiQw6eyzMxS05K4bL9uA+SKUQzCnSDkqOGokXyJvbgJ/BHI+qvY69//4rl20NsmK2ou2dTsyIALv/91/8n3P2Aao71WFGi8KKv1fRC5+J67Q/507/E/SOshqN5TsmYIjVt+kcjAx98iz/4SaojbIV1rexE7/C29HcYD/DX4a0rBOF5VTu7omsb11L/AWcVlcVZHSsqGuXLLp9ha8I//w3Mv+T4Ew7nTBsmgapoCrNFObIcN4pf/Ob/mrvHTGqqgAupL8qWjWPS9m/31jAe4DjA+4+uCoQoT/zOzlrNd3qd4SdphFxsUvYwGWbTWtISc3wNOWH+kHBMfc6kpmpwPgHWwqaSUG2ZWWheYOGQGaHB+eQ/kn6b3pOgLV+ODSn94wDvr8Bvb70/LLuiPPEr8OGVWfDmr45PZyccEmsVXZGe1pRNX9SU5+AVQkNTIVPCHF/jGmyDC9j4R9LfWcQvfiETmgMMUCMN1uNCakkweZsowdYobiMSlnKA93u7NzTXlSfe+SVbfnPQXmg9LpYAQxpwEtONyEyaueWM4FPjjyjG3uOaFmBTWDNgBXGEiQpsaWhnAqIijB07Dlsy3fUGeP989xbWkyf+FF2SNEtT1E0f4DYYVlxFlbaSMPIRMk/3iMU5pME2SIWJvjckciebkQuIRRyhUvkHg/iUljG5kzVog5hV7vIlCuBrmlhvgPfNHQM8lCf+FEGsYbMIBC0qC9a0uuy2wLXVbLBaP5kjHokCRxapkQyzI4QEcwgYHRZBp+XEFTqXFuNVzMtjXLJgX4gAid24Hjwc4N3dtVSe+NNiwTrzH4WVUOlDobUqr1FuAgYllc8pmzoVrELRHSIW8ViPxNy4xwjBpyR55I6J220qQTZYR4guvUICJiSpr9gFFle4RcF/OMB7BRiX8sSfhpNSO3lvEZCQfLUVTKT78Ek1LRLhWN+yLyTnp8qWUZ46b6vxdRGXfHVqx3eI75YaLa4iNNiK4NOW7wPW6lhbSOF9/M9qw8e/aoB3d156qTzxp8pXx5BKAsYSTOIIiPkp68GmTq7sZtvyzBQaRLNxIZ+paozHWoLFeExIhRBrWitHCAHrCF7/thhD8JhYz84wg93QRV88wLuLY8zF8sQ36qF1J455bOlgnELfshKVxYOXKVuKx0jaj22sczTQqPqtV/XDgpswmGTWWMSDw3ssyUunLLrVPGjYRsH5ggHeHSWiV8kT33ycFSfMgkoOK8apCye0J6VW6GOYvffgU9RWsukEi2kUV2nl4dOYUzRik9p7bcA4ggdJ53LxKcEe17B1R8eqAd7dOepV8sTXf5lhejoL85hUdhDdknPtKHFhljOT+bdq0hxbm35p2nc8+Ja1Iw+tJykgp0EWuAAZYwMVwac5KzYMslhvgHdHRrxKnvhTYcfKsxTxtTETkjHO7rr3zjoV25lAQHrqpV7bTiy2aXMmUhTBnKS91jhtR3GEoF0oLnWhWNnYgtcc4N0FxlcgT7yz3TgNIKkscx9jtV1ZKpWW+Ub1tc1eOv5ucdgpx+FJy9pgbLE7xDyXb/f+hLHVGeitHOi6A7ybo3sF8sS7w7cgdk0nJaOn3hLj3uyD0Zp5pazFIUXUpuTTU18d1EPkDoX8SkmWTnVIozEdbTcZjoqxhNHf1JrSS/AcvHjZ/SMHhL/7i5z+POsTUh/8BvNfYMTA8n+yU/MlTZxSJDRStqvEuLQKWwDctMTQogUDyQRoTQG5Kc6oQRE1yV1jCA7ri7jdZyK0sYTRjCR0Hnnd+y7nHxNgTULqw+8wj0mQKxpYvhjm9uSUxg+TTy7s2GtLUGcywhXSKZN275GsqlclX90J6bRI1aouxmgL7Q0Nen5ziM80SqMIo8cSOo+8XplT/5DHNWsSUr/6lLN/QQ3rDyzLruEW5enpf7KqZoShEduuSFOV7DLX7Ye+GmXb6/hnNNqKsVXuMDFpb9Y9eH3C6NGEzuOuI3gpMH/I6e+zDiH1fXi15t3vA1czsLws0TGEtmPEJdiiFPwlwKbgLHAFk4P6ZyPdymYYHGE0dutsChQBl2JcBFlrEkY/N5bQeXQ18gjunuMfMfsBlxJSx3niO485fwO4fGD5T/+3fPQqkneWVdwnw/3bMPkW9Wbqg+iC765Zk+xcT98ibKZc2EdgHcLoF8cSOo/Oc8fS+OyEULF4g4sJqXVcmfMfsc7A8v1/yfGXmL9I6Fn5pRwZhsPv0TxFNlAfZCvG+Oohi82UC5f/2IsJo0cTOm9YrDoKhFPEUr/LBYTUNht9zelHXDqwfPCIw4owp3mOcIQcLttWXFe3VZ/j5H3cIc0G6oPbCR+6Y2xF2EC5cGUm6wKC5tGEzhsWqw5hNidUiKX5gFWE1GXh4/Qplw4sVzOmx9QxU78g3EF6wnZlEN4FzJ1QPSLEZz1KfXC7vd8ssGdIbNUYpVx4UapyFUHzJoTOo1McSkeNn1M5MDQfs4qQuhhX5vQZFw8suwWTcyYTgioISk2YdmkhehG4PkE7w51inyAGGaU+uCXADabGzJR1fn3lwkty0asIo8cROm9Vy1g0yDxxtPvHDAmpu+PKnM8Ix1wwsGw91YJqhteaWgjYBmmQiebmSpwKKzE19hx7jkzSWOm66oPbzZ8Yj6kxVSpYjVAuvLzYMCRo3oTQecOOjjgi3NQ4l9K5/hOGhNTdcWVOTrlgYNkEXINbpCkBRyqhp+LdRB3g0OU6rMfW2HPCFFMV9nSp+uB2woepdbLBuJQyaw/ZFysXrlXwHxI0b0LovEkiOpXGA1Ijagf+KUNC6rKNa9bQnLFqYNkEnMc1uJrg2u64ELPBHpkgWbmwKpJoDhMwNbbGzAp7Yg31wS2T5rGtzit59PrKhesWG550CZpHEzpv2NGRaxlNjbMqpmEIzygJqQfjypycs2pg2cS2RY9r8HUqkqdEgKTWtWTKoRvOBPDYBltja2SO0RGjy9UHtxwRjA11ujbKF+ti5cIR9eCnxUg6owidtyoU5tK4NLji5Q3HCtiyF2IqLGYsHViOXTXOYxucDqG0HyttqYAKqYo3KTY1ekyDXRAm2AWh9JmsVh/ccg9WJ2E8YjG201sPq5ULxxX8n3XLXuMInbft2mk80rRGjCGctJ8/GFdmEQ9Ug4FlE1ll1Y7jtiraqm5Fe04VV8lvSVBL8hiPrfFVd8+7QH3Qbu2ipTVi8cvSGivc9cj8yvH11YMHdNSERtuOslM97feYFOPKzGcsI4zW0YGAbTAOaxCnxdfiYUmVWslxiIblCeAYr9VYR1gM7GmoPrilunSxxeT3DN/2eBQ9H11+nk1adn6VK71+5+Jfct4/el10/7KBZfNryUunWSCPxPECk1rdOv1WVSrQmpC+Tl46YD3ikQYcpunSQgzVB2VHFhxHVGKDgMEY5GLlQnP7FMDzw7IacAWnO6sBr12u+XanW2AO0wQ8pknnFhsL7KYIqhkEPmEXFkwaN5KQphbkUmG72wgw7WSm9RiL9QT925hkjiVIIhphFS9HKI6/8QAjlpXqg9W2C0apyaVDwKQwrwLY3j6ADR13ZyUNByQXHQu6RY09Hu6zMqXRaNZGS/KEJs0cJEe9VH1QdvBSJv9h09eiRmy0V2uJcqHcShcdvbSNg5fxkenkVprXM9rDVnX24/y9MVtncvbKY706anNl3ASll9a43UiacVquXGhvq4s2FP62NGKfQLIQYu9q1WmdMfmUrDGt8eDS0cXozH/fjmUH6Jruvm50hBDSaEU/2Ru2LEN/dl006TSc/g7tfJERxGMsgDUEr104pfWH9lQaN+M4KWQjwZbVc2rZVNHsyHal23wZtIs2JJqtIc/WLXXRFCpJkfE9jvWlfFbsNQ9pP5ZBS0zKh4R0aMFj1IjTcTnvi0Zz2rt7NdvQb2mgbju1plsH8MmbnEk7KbK0b+wC2iy3aX3szW8xeZvDwET6hWZYwqTXSSG+wMETKum0Dq/q+x62gt2ua2ppAo309TRk9TPazfV3qL9H8z7uhGqGqxNVg/FKx0HBl9OVUORn8Q8Jx9gFttGQUDr3tzcXX9xGgN0EpzN9mdZ3GATtPhL+CjxFDmkeEU6x56kqZRusLzALXVqkCN7zMEcqwjmywDQ6OhyUe0Xao1Qpyncrg6wKp9XfWDsaZplElvQ/b3sdweeghorwBDlHzgk1JmMc/wiERICVy2VJFdMjFuLQSp3S0W3+sngt2njwNgLssFGVQdJ0tu0KH4ky1LW4yrbkuaA6Iy9oz/qEMMXMMDWyIHhsAyFZc2peV9hc7kiKvfULxCl9iddfRK1f8kk9qvbdOoBtOg7ZkOZ5MsGrSHsokgLXUp9y88smniwWyuFSIRVmjplga3yD8Uij5QS1ZiM4U3Qw5QlSm2bXjFe6jzzBFtpg+/YBbLAWG7OPynNjlCw65fukGNdkJRf7yM1fOxVzbxOJVocFoYIaGwH22mIQkrvu1E2nGuebxIgW9U9TSiukPGU+Lt++c3DJPKhyhEEbXCQLUpae2exiKy6tMPe9mDRBFCEMTWrtwxN8qvuGnt6MoihKWS5NSyBhbH8StXoAz8PLOrRgLtOT/+4vcu+7vDLnqNvztOq7fmd8sMmY9Xzn1zj8Dq8+XVdu2Nv0IIySgEdQo3xVHps3Q5i3fLFsV4aiqzAiBhbgMDEd1uh8qZZ+lwhjkgokkOIv4xNJmyncdfUUzgB4oFMBtiu71Xumpz/P+cfUP+SlwFExwWW62r7b+LSPxqxn/gvMZ5z9C16t15UbNlq+jbGJtco7p8wbYlL4alSyfWdeuu0j7JA3JFNuVAwtst7F7FhWBbPFNKIUORndWtLraFLmMu7KFVDDOzqkeaiN33YAW/r76wR4XDN/yN1z7hejPau06EddkS/6XThfcz1fI/4K736fO48vlxt2PXJYFaeUkFS8U15XE3428xdtn2kc8GQlf1vkIaNRRnOMvLTWrZbElEHeLWi1o0dlKPAh1MVgbbVquPJ5+Cr8LU5/H/+I2QlHIU2ClXM9G8v7Rr7oc/hozfUUgsPnb3D+I+7WF8kNO92GY0SNvuxiE+2Bt8prVJTkzE64sfOstxuwfxUUoyk8VjcTlsqe2qITSFoSj6Epd4KsT6BZOWmtgE3hBfir8IzZDwgV4ZTZvD8VvPHERo8v+vL1DASHTz/i9OlKueHDjK5Rnx/JB1Vb1ioXdBra16dmt7dgik10yA/FwJSVY6XjA3oy4SqM2frqDPPSRMex9qs3XQtoWxMj7/Er8GWYsXgjaVz4OYumP2+9kbxvny/6kvWsEBw+fcb5bInc8APdhpOSs01tEqIkoiZjbAqKMruLbJYddHuHFRIyJcbdEdbl2sVLaySygunutBg96Y2/JjKRCdyHV+AEFtTvIpbKIXOamknYSiB6KV/0JetZITgcjjk5ZdaskBtWO86UF0ap6ozGXJk2WNiRUlCPFir66lzdm/SLSuK7EUdPz8f1z29Skq6F1fXg8+5UVR6bszncP4Tn4KUkkdJ8UFCY1zR1i8RmL/qQL3rlei4THG7OODlnKko4oI01kd3CaM08Ia18kC3GNoVaO9iDh+hWxSyTXFABXoau7Q6q9OxYg/OVEMw6jdbtSrJ9cBcewGmaZmg+bvkUnUUaGr+ZfnMH45Ivevl61hMcXsxYLFTu1hTm2zViCp7u0o5l+2PSUh9bDj6FgYypufBDhqK2+oXkiuHFHR3zfj+9PtA8oR0xnqX8qn+sx3bFODSbbF0X8EUvWQ8jBIcjo5bRmLOljDNtcqNtOe756h3l0VhKa9hDd2l1eqmsnh0MNMT/Cqnx6BInumhLT8luljzQ53RiJeA/0dxe5NK0o2fA1+GLXr6eNQWHNUOJssQaTRlGpLHKL9fD+IrQzTOMZS9fNQD4AnRNVxvTdjC+fJdcDDWQcyB00B0t9BDwTxXgaAfzDZ/DBXzRnfWMFRwuNqocOmX6OKNkY63h5n/fFcB28McVHqnXZVI27K0i4rDLNE9lDKV/rT+udVbD8dFFu2GGZ8mOt0kAXcoX3ZkIWVtw+MNf5NjR2FbivROHmhV1/pj2egv/fMGIOWTIWrV3Av8N9imV9IWml36H6cUjqEWNv9aNc+veb2sH46PRaHSuMBxvtW+twxctq0z+QsHhux8Q7rCY4Ct8lqsx7c6Sy0dl5T89rIeEuZKoVctIk1hNpfavER6yyH1Vvm3MbsUHy4ab4hWr/OZPcsRBphnaV65/ZcdYPNNwsjN/djlf9NqCw9U5ExCPcdhKxUgLSmfROpLp4WSUr8ojdwbncbvCf+a/YzRaEc6QOvXcGO256TXc5Lab9POvB+AWY7PigWYjzhifbovuunzRawsO24ZqQQAqguBtmpmPB7ysXJfyDDaV/aPGillgz1MdQg4u5MYaEtBNNHFjkRlSpd65lp4hd2AVPTfbV7FGpyIOfmNc/XVsPfg7vzaS/3nkvLL593ANLvMuRMGpQIhiF7kUEW9QDpAUbTWYBcbp4WpacHHY1aacqQyjGZS9HI3yCBT9kUZJhVOD+zUDvEH9ddR11fzPcTDQ5TlgB0KwqdXSavk9BC0pKp0WmcuowSw07VXmXC5guzSa4p0UvRw2lbDiYUx0ExJJRzWzi6Gm8cnEkfXXsdcG/M/jAJa0+bmCgdmQ9CYlNlSYZOKixmRsgiFxkrmW4l3KdFKv1DM8tk6WxPYJZhUUzcd8Kdtgrw/gkfXXDT7+avmfVak32qhtkg6NVdUS5wgkru1YzIkSduTW1FDwVWV3JQVJVuieTc0y4iDpFwc7/BvSalvKdQM8sv662cevz/+8sQVnjVAT0W2wLllw1JiMhJRxgDjCjLQsOzSFSgZqx7lAW1JW0e03yAD3asC+GD3NbQhbe+mN5GXH1F83KDOM4n/e5JIuH4NpdQARrFPBVptUNcjj4cVMcFSRTE2NpR1LEYbYMmfWpXgP9KejaPsLUhuvLCsVXznAG9dfx9SR1ud/3hZdCLHb1GMdPqRJgqDmm76mHbvOXDtiO2QPUcKo/TWkQ0i2JFXpBoo7vij1i1Lp3ADAo+qvG3V0rM//vFnnTE4hxd5Ka/Cor5YEdsLVJyKtDgVoHgtW11pWSjolPNMnrlrVj9Fv2Qn60twMwKPqr+N/wvr8z5tZcDsDrv06tkqyzESM85Ycv6XBWA2birlNCXrI6VbD2lx2L0vQO0QVTVVLH4SE67fgsfVXv8n7sz7/85Z7cMtbE6f088wSaR4kCkCm10s6pKbJhfqiUNGLq+0gLWC6eUAZFPnLjwqtKd8EwGvWX59t7iPW4X/eAN1svgRVSY990YZg06BD1ohLMtyFTI4pKTJsS9xREq9EOaPWiO2gpms7397x6nQJkbh+Fz2q/rqRROX6/M8bJrqlVW4l6JEptKeUFuMYUbtCQ7CIttpGc6MY93x1r1vgAnRXvY5cvwWPqb9uWQm+lP95QxdNMeWhOq1x0Db55C7GcUv2ZUuN6n8iKzsvOxibC//Yfs9Na8r2Rlz02vXXDT57FP/zJi66/EJSmsJKa8QxnoqW3VLQ+jZVUtJwJ8PNX1NQCwfNgdhhHD9on7PdRdrdGPF28rJr1F+3LBdeyv+8yYfLoMYet1vX4upNAjVvwOUWnlNXJXlkzk5Il6kqeoiL0C07qno+/CYBXq/+utlnsz7/Mzvy0tmI4zm4ag23PRN3t/CWryoUVJGm+5+K8RJ0V8Hc88/XHUX/HfiAq7t+BH+x6v8t438enWmdJwFA6ZINriLGKv/95f8lT9/FnyA1NMVEvQyaXuu+gz36f/DD73E4pwqpLcvm/o0Vle78n//+L/NPvoefp1pTJye6e4A/D082FERa5/opeH9zpvh13cNm19/4v/LDe5xMWTi8I0Ta0qKlK27AS/v3/r+/x/2GO9K2c7kVMonDpq7//jc5PKCxeNPpFVzaRr01wF8C4Pu76hXuX18H4LduTr79guuFD3n5BHfI+ZRFhY8w29TYhbbLi/bvBdqKE4fUgg1pBKnV3FEaCWOWyA+m3WpORZr/j+9TKJtW8yBTF2/ZEODI9/QavHkVdGFp/Pjn4Q+u5hXapsP5sOH+OXXA1LiKuqJxiMNbhTkbdJTCy4llEt6NnqRT4dhg1V3nbdrm6dYMecA1yTOL4PWTE9L5VzPFlLBCvlG58AhehnN4uHsAYinyJ+AZ/NkVvELbfOBUuOO5syBIEtiqHU1k9XeISX5bsimrkUUhnGDxourN8SgUsCZVtKyGbyGzHXdjOhsAvOAswSRyIBddRdEZWP6GZhNK/yjwew9ehBo+3jEADu7Ay2n8mDc+TS7awUHg0OMzR0LABhqLD4hJEh/BEGyBdGlSJoXYXtr+3HS4ijzVpgi0paWXtdruGTknXBz+11qT1Q2inxaTzQCO46P3lfLpyS4fou2PH/PupwZgCxNhGlj4IvUuWEsTkqMWm6i4xCSMc9N1RDQoCVcuGItJ/MRWefais+3synowi/dESgJjkilnWnBTGvRWmaw8oR15257t7CHmCf8HOn7cwI8+NQBXMBEmAa8PMRemrNCEhLGEhDQKcGZWS319BX9PFBEwGTbRBhLbDcaV3drFcDqk5kCTd2JF1Wp0HraqBx8U0wwBTnbpCadwBA/gTH/CDrcCs93LV8E0YlmmcyQRQnjBa8JESmGUfIjK/7fkaDJpmD2QptFNVJU1bbtIAjjWQizepOKptRjbzR9Kag6xZmMLLjHOtcLT3Tx9o/0EcTT1XN3E45u24AiwEypDJXihKjQxjLprEwcmRKclaDNZCVqr/V8mYWyFADbusiY5hvgFoU2vio49RgJLn5OsReRFN6tabeetiiy0V7KFHT3HyZLx491u95sn4K1QQSPKM9hNT0wMVvAWbzDSVdrKw4zRjZMyJIHkfq1VAVCDl/bUhNKlGq0zGr05+YAceXVPCttVk0oqjVwMPt+BBefx4yPtGVkUsqY3CHDPiCM5ngupUwCdbkpd8kbPrCWHhkmtIKLEetF2499eS1jZlIPGYnlcPXeM2KD9vLS0bW3ktYNqUllpKLn5ZrsxlIzxvDu5eHxzGLctkZLEY4PgSOg2IUVVcUONzUDBEpRaMoXNmUc0tFZrTZquiLyKxrSm3DvIW9Fil+AkhXu5PhEPx9mUNwqypDvZWdKlhIJQY7vn2OsnmBeOWnYZ0m1iwbbw1U60by5om47iHRV6fOgzjMf/DAZrlP40Z7syxpLK0lJ0gqaAK1c2KQKu7tabTXkLFz0sCftuwX++MyNeNn68k5Buq23YQhUh0SNTJa1ioQ0p4nUG2y0XilF1JqODqdImloPS4Bp111DEWT0jJjVv95uX9BBV7eB3bUWcu0acSVM23YZdd8R8UbQUxJ9wdu3oMuhdt929ME+mh6JXJ8di2RxbTi6TbrDquqV4aUKR2iwT6aZbyOwEXN3DUsWr8Hn4EhwNyHuXHh7/pdaUjtR7vnDh/d8c9xD/s5f501eQ1+CuDiCvGhk1AN/4Tf74RfxPwD3toLarR0zNtsnPzmS64KIRk861dMWCU8ArasG9T9H0ZBpsDGnjtAOM2+/LuIb2iIUGXNgl5ZmKD/Tw8TlaAuihaFP5yrw18v4x1898zIdP+DDAX1bM3GAMvPgRP/cJn3zCW013nrhHkrITyvYuwOUkcHuKlRSW5C6rzIdY4ppnF7J8aAJbQepgbJYBjCY9usGXDKQxq7RZfh9eg5d1UHMVATRaD/4BHK93/1iAgYZ/+jqPn8Dn4UExmWrpa3+ZOK6MvM3bjwfzxNWA2dhs8+51XHSPJiaAhGSpWevEs5xHLXcEGFXYiCONySH3fPWq93JIsBiSWvWyc3CAN+EcXoT7rCSANloPPoa31rt/5PUA/gp8Q/jDD3hyrjzlR8VkanfOvB1XPubt17vzxAfdSVbD1pzAnfgyF3ycadOTOTXhpEUoLC1HZyNGW3dtmjeXgr2r56JNmRwdNNWaQVBddd6rh4MhviEB9EFRD/7RGvePvCbwAL4Mx/D6M541hHO4D3e7g6PafdcZVw689z7NGTwo5om7A8sPhccT6qKcl9NJl9aM/9kX+e59Hh1yPqGuCCZxuITcsmNaJ5F7d0q6J3H48TO1/+M57085q2icdu2U+W36Ldllz9Agiv4YGljoEN908EzvDOrBF98/vtJwCC/BF2AG75xxEmjmMIcjxbjoaxqOK3/4hPOZzhMPBpYPG44CM0dTVm1LjLtUWWVz1Bcf8tEx0zs8O2A2YVHRxKYOiy/aOVoAaMu0i7ubu43njjmd4ibMHU1sIDHaQNKrZND/FZYdk54oCXetjq7E7IVl9eAL7t+oHnwXXtLx44czzoRFHBztYVwtH1d+NOMkupZ5MTM+gUmq90X+Bh9zjRlmaQ+m7YMqUL/veemcecAtOJ0yq1JnVlN27di2E0+Klp1tAJ4KRw1eMI7aJjsO3R8kPSI3fUFXnIOfdQe86sIIVtWDL7h//Ok6vj8vwDk08NEcI8zz7OhBy+WwalzZeZ4+0XniRfst9pAJqQHDGLzVQ2pheZnnv1OWhwO43/AgcvAEXEVVpa4db9sGvNK8wjaENHkfFQ4Ci5i7dqnQlPoLQrHXZDvO3BIXZbJOBrOaEbML6sFL798I4FhKihjHMsPjBUZYCMFr6nvaArxqXPn4lCa+cHfSa2cP27g3Z3ziYTRrcbQNGLQmGF3F3cBdzzzX7AILx0IB9rbwn9kx2G1FW3Inic+ZLIsVvKR8Zwfj0l1fkqo8LWY1M3IX14OX3r9RKTIO+d9XzAI8qRPGPn/4NC2n6o4rN8XJ82TOIvuVA8zLKUHRFgBCetlDZlqR1gLKjS39xoE7Bt8UvA6BxuEDjU3tFsEijgA+615tmZkXKqiEENrh41iLDDZNq4pKTWR3LZfnos81LOuNa15cD956vLMsJd1rqYp51gDUQqMYm2XsxnUhD2jg1DM7SeuJxxgrmpfISSXVIJIS5qJJSvJPEQ49DQTVIbYWJ9QWa/E2+c/oPK1drmC7WSfJRNKBO5Yjvcp7Gc3dmmI/Xh1kDTEuiSnWqQf37h+fTMhGnDf6dsS8SQfQWlqqwXXGlc/PEZ/SC5mtzIV0nAshlQdM/LvUtYutrEZ/Y+EAFtq1k28zQhOwLr1AIeANzhF8t9qzTdZf2qRKO6MWE9ohBYwibbOmrFtNmg3mcS+tB28xv2uKd/agYCvOP+GkSc+0lr7RXzyufL7QbkUpjLjEWFLqOIkAGu2B0tNlO9Eau2W1qcOUvVRgKzypKIQZ5KI3q0MLzqTNRYqiZOqmtqloIRlmkBHVpHmRYV6/HixbO6UC47KOFJnoMrVyr7wYz+SlW6GUaghYbY1I6kkxA2W1fSJokUdSh2LQ1GAimRGm0MT+uu57H5l7QgOWxERpO9moLRPgTtquWCfFlGlIjQaRly9odmzMOWY+IBO5tB4sW/0+VWGUh32qYk79EidWKrjWuiLpiVNGFWFRJVktyeXWmbgBBzVl8anPuXyNJlBJOlKLTgAbi/EYHVHxWiDaVR06GnHQNpJcWcK2jJtiCfG2sEHLzuI66sGrMK47nPIInPnu799935aOK2cvmvubrE38ZzZjrELCmXM2hM7UcpXD2oC3+ECVp7xtIuxptJ0jUr3sBmBS47TVxlvJ1Sqb/E0uLdvLj0lLr29ypdd/eMX3f6lrxGlKwKQxEGvw0qHbkbwrF3uHKwVENbIV2wZ13kNEF6zD+x24aLNMfDTCbDPnEikZFyTNttxWBXDaBuM8KtI2rmaMdUY7cXcUPstqTGvBGSrFWIpNMfbdea990bvAOC1YX0qbc6smDS1mPxSJoW4fwEXvjMmhlijDRq6qale6aJEuFGoppYDoBELQzLBuh/mZNx7jkinv0EtnUp50lO9hbNK57lZaMAWuWR5Yo9/kYwcYI0t4gWM47Umnl3YmpeBPqSyNp3K7s2DSAS/39KRuEN2bS4xvowV3dFRMx/VFcp2Yp8w2nTO9hCXtHG1kF1L4KlrJr2wKfyq77R7MKpFKzWlY9UkhYxyHWW6nBWPaudvEAl3CGcNpSXPZ6R9BbBtIl6cHL3gIBi+42CYXqCx1gfGWe7Ap0h3luyXdt1MKy4YUT9xSF01G16YEdWsouW9mgDHd3veyA97H+Ya47ZmEbqMY72oPztCGvK0onL44AvgC49saZKkWRz4veWljE1FHjbRJaWv6ZKKtl875h4CziFCZhG5rx7tefsl0aRT1bMHZjm8dwL/6u7wCRysaQblQoG5yAQN5zpatMNY/+yf8z+GLcH/Qn0iX2W2oEfXP4GvwQHuIL9AYGnaO3zqAX6946nkgqZNnUhx43DIdQtMFeOPrgy/y3Yd85HlJWwjLFkU3kFwq28xPnuPhMWeS+tDLV9Otllq7pQCf3uXJDN9wFDiUTgefHaiYbdfi3b3u8+iY6TnzhgehI1LTe8lcd7s1wJSzKbahCRxKKztTLXstGAiu3a6rPuQs5pk9TWAan5f0BZmGf7Ylxzzk/A7PAs4QPPPAHeFQ2hbFHszlgZuKZsJcUmbDC40sEU403cEjczstOEypa+YxevL4QBC8oRYqWdK6b7sK25tfE+oDZgtOQ2Jg8T41HGcBE6fTWHn4JtHcu9S7uYgU5KSCkl/mcnq+5/YBXOEr6lCUCwOTOM1taOI8mSxx1NsCXBEmLKbMAg5MkwbLmpBaFOPrNSlO2HnLiEqW3tHEwd8AeiQLmn+2gxjC3k6AxREqvKcJbTEzlpLiw4rNZK6oJdidbMMGX9FULKr0AkW+2qDEPBNNm5QAt2Ik2nftNWHetubosHLo2nG4vQA7GkcVCgVCgaDixHqo9UUn1A6OshapaNR/LPRYFV8siT1cCtJE0k/3WtaNSuUZYKPnsVIW0xXWnMUxq5+En4Kvw/MqQmVXnAXj9Z+9zM98zM/Agy7F/qqj2Nh67b8HjFnPP3iBn/tkpdzwEJX/whIcQUXOaikeliCRGUk7tiwF0rItwMEhjkZ309hikFoRAmLTpEXWuHS6y+am/KB/fM50aLEhGnSMwkpxzOov4H0AvgovwJ1iGzDLtJn/9BU+fAINfwUe6FHSLhu83viV/+/HrOePX+STT2B9uWGbrMHHLldRBlhS/CJQmcRxJFqZica01XixAZsYiH1uolZxLrR/SgxVIJjkpQP4PE9sE59LKLr7kltSBogS5tyszzH8Fvw8/AS8rNOg0xUS9fIaHwb+6et8Q/gyvKRjf5OusOzGx8evA/BP4IP11uN/grca5O0lcsPLJ5YjwI4QkJBOHa0WdMZYGxPbh2W2nR9v3WxEWqgp/G3+6VZbRLSAAZ3BhdhAaUL33VUSw9yjEsvbaQ9u4A/gGXwZXoEHOuU1GSj2chf+Mo+f8IcfcAxfIKVmyunRbYQVnoevwgfw3TXXcw++xNuP4fhyueEUNttEduRVaDttddoP0eSxLe2LENk6itYxlrxBNBYrNNKSQmeaLcm9c8UsaB5WyO6675yyQIAWSDpBVoA/gxmcwEvwoDv0m58UE7gHn+fJOa8/Ywan8EKRfjsopF83eCglX/Sfr7OeaRoQfvt1CGvIDccH5BCvw1sWIzRGC/66t0VTcLZQZtm6PlAasbOJ9iwWtUo7biktTSIPxnR24jxP1ZKaqq+2RcXM9OrBAm/AAs7hDJ5bNmGb+KIfwCs8a3jnjBrOFeMjHSCdbKr+2uOLfnOd9eiA8Hvvwwq54VbP2OqwkB48Ytc4YEOiH2vTXqodabfWEOzso4qxdbqD5L6tbtNPECqbhnA708DZH4QOJUXqScmUlks7Ot6FBuZw3n2mEbaUX7kDzxHOOQk8nKWMzAzu6ZZ8sOFw4RK+6PcuXo9tB4SbMz58ApfKDXf3szjNIIbGpD5TKTRxGkEMLjLl+K3wlWXBsCUxIDU+jbOiysESqAy1MGUJpXgwbTWzNOVEziIXZrJ+VIztl1PUBxTSo0dwn2bOmfDRPD3TRTGlfbCJvO9KvuhL1hMHhB9wPuPRLGHcdOWG2xc0U+5bQtAJT0nRTewXL1pgk2+rZAdeWmz3jxAqfNQQdzTlbF8uJ5ecEIWvTkevAHpwz7w78QujlD/Lr491bD8/1vhM2yrUQRrWXNQY4fGilfctMWYjL72UL/qS9eiA8EmN88nbNdour+PBbbAjOjIa4iBhfFg6rxeKdEGcL6p3EWR1Qq2Qkhs2DrnkRnmN9tG2EAqmgPw6hoL7Oza7B+3SCrR9tRftko+Lsf2F/mkTndN2LmzuMcKTuj/mX2+4Va3ki16+nnJY+S7MefpkidxwnV+4wkXH8TKnX0tsYzYp29DOOoSW1nf7nTh2akYiWmcJOuTidSaqESrTYpwjJJNVGQr+rLI7WsqerHW6Kp/oM2pKuV7T1QY9gjqlZp41/WfKpl56FV/0kvXQFRyeQ83xaTu5E8p5dNP3dUF34ihyI3GSpeCsywSh22ZJdWto9winhqifb7VRvgktxp13vyjrS0EjvrRfZ62uyqddSWaWYlwTPAtJZ2oZ3j/Sgi/mi+6vpzesfAcWNA0n8xVyw90GVFGuZjTXEQy+6GfLGLMLL523f5E0OmxVjDoOuRiH91RKU+vtoCtH7TgmvBLvtFXWLW15H9GTdVw8ow4IlRLeHECN9ym1e9K0I+Cbnhgv4Yu+aD2HaQJ80XDqOzSGAV4+4yCqBxrsJAX6ZTIoX36QnvzhhzzMfFW2dZVLOJfo0zbce5OvwXMFaZ81mOnlTVXpDZsQNuoYWveketKb5+6JOOsgX+NTm7H49fUTlx+WLuWL7qxnOFh4BxpmJx0p2gDzA/BUARuS6phR+pUsY7MMboAHx5xNsSVfVZcYSwqCKrqon7zM+8ecCkeS4nm3rINuaWvVNnMRI1IRpxTqx8PZUZ0Br/UEduo3B3hNvmgZfs9gQPj8vIOxd2kndir3awvJ6BLvoUuOfFWNYB0LR1OQJoUySKb9IlOBx74q1+ADC2G6rOdmFdJcD8BkfualA+BdjOOzP9uUhGUEX/TwhZsUduwRr8wNuXKurCixLBgpQI0mDbJr9dIqUuV+92ngkJZ7xduCk2yZKbfWrH1VBiTg9VdzsgRjW3CVXCvAwDd+c1z9dWw9+B+8MJL/eY15ZQ/HqvTwVdsZn5WQsgRRnMaWaecu3jFvMBEmgg+FJFZsnSl0zjB9OqPYaBD7qmoVyImFvzi41usesV0julaAR9dfR15Xzv9sEruRDyk1nb+QaLU67T885GTls6YgcY+UiMa25M/pwGrbCfzkvR3e0jjtuaFtnwuagHTSb5y7boBH119HXhvwP487jJLsLJ4XnUkHX5sLbS61dpiAXRoZSCrFJ+EjpeU3puVfitngYNo6PJrAigKktmwjyQdZpfq30mmtulaAx9Zfx15Xzv+cyeuiBFUs9zq8Kq+XB9a4PVvph3GV4E3y8HENJrN55H1X2p8VyqSKwVusJDKzXOZzplWdzBUFK9e+B4+uv468xvI/b5xtSAkBHQaPvtqWzllVvEOxPbuiE6+j2pvjcKsbvI7txnRErgfH7LdXqjq0IokKzga14GzQ23SSbCQvO6r+Or7SMIr/efOkkqSdMnj9mBx2DRsiY29Uj6+qK9ZrssCKaptR6HKURdwUYeUWA2kPzVKQO8ku2nU3Anhs/XWkBx3F/7wJtCTTTIKftthue1ty9xvNYLY/zo5KSbIuKbXpbEdSyeRyYdAIwKY2neyoc3+k1XUaufYga3T9daMUx/r8z1s10ITknIO0kuoMt+TB8jK0lpayqqjsJ2qtXAYwBU932zinimgmd6mTRDnQfr88q36NAI+tv24E8Pr8zxtasBqx0+xHH9HhlrwsxxNUfKOHQaZBITNf0uccj8GXiVmXAuPEAKSdN/4GLHhs/XWj92dN/uetNuBMnVR+XWDc25JLjo5Mg5IZIq226tmCsip2zZliL213YrTlL2hcFjpCduyim3M7/eB16q/blQsv5X/esDRbtJeabLIosWy3ycavwLhtxdWzbMmHiBTiVjJo6lCLjXZsi7p9PEPnsq6X6wd4bP11i0rD5fzPm/0A6brrIsllenZs0lCJlU4abakR59enZKrKe3BZihbTxlyZ2zl1+g0wvgmA166/bhwDrcn/7Ddz0eWZuJvfSESug6NzZsox3Z04FIxz0mUjMwVOOVTq1CQ0AhdbBGVdjG/CgsfUX7esJl3K/7ytWHRv683praW/8iDOCqWLLhpljDY1ZpzK75QiaZoOTpLKl60auHS/97oBXrv+umU9+FL+5+NtLFgjqVLCdbmj7pY5zPCPLOHNCwXGOcLquOhi8CmCWvbcuO73XmMUPab+ug3A6/A/78Bwe0bcS2+tgHn4J5pyS2WbOck0F51Vq3LcjhLvZ67p1ABbaL2H67bg78BfjKi/jr3+T/ABV3ilLmNXTI2SpvxWBtt6/Z//D0z/FXaGbSBgylzlsEGp+5//xrd4/ae4d8DUUjlslfIYS3t06HZpvfQtvv0N7AHWqtjP2pW08QD/FLy//da38vo8PNlKHf5y37Dxdfe/oj4kVIgFq3koLReSR76W/bx//n9k8jonZxzWTANVwEniDsg87sOSd/z7//PvMp3jQiptGVWFX2caezzAXwfgtzYUvbr0iozs32c3Uge7varH+CNE6cvEYmzbPZ9hMaYDdjK4V2iecf6EcEbdUDVUARda2KzO/JtCuDbNQB/iTeL0EG1JSO1jbXS+nLxtPMDPw1fh5+EPrgSEKE/8Gry5A73ui87AmxwdatyMEBCPNOCSKUeRZ2P6Myb5MRvgCHmA9ywsMifU+AYXcB6Xa5GibUC5TSyerxyh0j6QgLVpdyhfArRTTLqQjwe4HOD9s92D4Ap54odXAPBWLAwB02igG5Kkc+piN4lvODIFGAZgT+EO4Si1s7fjSR7vcQETUkRm9O+MXyo9OYhfe4xt9STQ2pcZRLayCV90b4D3jR0DYAfyxJ+eywg2IL7NTMXna7S/RpQ63JhWEM8U41ZyQGjwsVS0QBrEKLu8xwZsbi4wLcCT+OGidPIOCe1PiSc9Qt+go+vYqB7cG+B9d8cAD+WJPz0Am2gxXgU9IneOqDpAAXOsOltVuMzpdakJXrdPCzXiNVUpCeOos5cxnpQT39G+XVLhs1osQVvJKPZyNq8HDwd4d7pNDuWJPxVX7MSzqUDU6gfadKiNlUFTzLeFHHDlzO4kpa7aiKhBPGKwOqxsBAmYkOIpipyXcQSPlRTf+Tii0U3EJGaZsDER2qoB3h2hu0qe+NNwUooYU8y5mILbJe6OuX+2FTKy7bieTDAemaQyQ0CPthljSWO+xmFDIYiESjM5xKd6Ik5lvLq5GrQ3aCMLvmCA9wowLuWJb9xF59hVVP6O0CrBi3ZjZSNOvRy+I6klNVRJYRBaEzdN+imiUXQ8iVF8fsp+W4JXw7WISW7fDh7lptWkCwZ4d7QTXyBPfJMYK7SijjFppGnlIVJBJBYj7eUwtiP1IBXGI1XCsjNpbjENVpSAJ2hq2LTywEly3hUYazt31J8w2+aiLx3g3fohXixPfOMYm6zCGs9LVo9MoW3MCJE7R5u/WsOIjrqBoHUO0bJE9vxBpbhsd3+Nb4/vtPCZ4oZYCitNeYuC/8UDvDvy0qvkiW/cgqNqRyzqSZa/s0mqNGjtKOoTm14zZpUauiQgVfqtQiZjq7Q27JNaSK5ExRcrGCXO1FJYh6jR6CFqK7bZdQZ4t8g0rSlPfP1RdBtqaa9diqtzJkQ9duSryi2brQXbxDwbRUpFMBHjRj8+Nt7GDKgvph9okW7LX47gu0SpGnnFQ1S1lYldOsC7hYteR574ZuKs7Ei1lBsfdz7IZoxzzCVmmVqaSySzQbBVAWDek+N4jh9E/4VqZrJjPwiv9BC1XcvOWgO8275CVyBPvAtTVlDJfZkaZGU7NpqBogAj/xEHkeAuJihWYCxGN6e8+9JtSegFXF1TrhhLGP1fak3pebgPz192/8gB4d/6WT7+GdYnpH7hH/DJzzFiYPn/vjW0SgNpTNuPIZoAEZv8tlGw4+RLxy+ZjnKa5NdFoC7UaW0aduoYse6+bXg1DLg6UfRYwmhGEjqPvF75U558SANrElK/+MdpXvmqBpaXOa/MTZaa1DOcSiLaw9j0NNNst3c+63c7EKTpkvKHzu6bPbP0RkuHAVcbRY8ijP46MIbQeeT1mhA+5PV/inyDdQipf8LTvMXbwvoDy7IruDNVZKTfV4CTSRUYdybUCnGU7KUTDxLgCknqUm5aAW6/1p6eMsOYsphLzsHrE0Y/P5bQedx1F/4yPHnMB3/IOoTU9+BL8PhtjuFKBpZXnYNJxTuv+2XqolKR2UQgHhS5novuxVySJhBNRF3SoKK1XZbbXjVwWNyOjlqWJjrWJIy+P5bQedyldNScP+HZ61xKSK3jyrz+NiHG1hcOLL/+P+PDF2gOkekKGiNWKgJ+8Z/x8Iv4DdQHzcpZyF4v19I27w9/yPGDFQvmEpKtqv/TLiWMfn4sofMm9eAH8Ao0zzh7h4sJqYtxZd5/D7hkYPneDzl5idlzNHcIB0jVlQ+8ULzw/nc5/ojzl2juE0apD7LRnJxe04dMz2iOCFNtGFpTuXA5AhcTRo8mdN4kz30nVjEC4YTZQy4gpC7GlTlrePKhGsKKgeXpCYeO0MAd/GH7yKQUlXPLOasOH3FnSphjHuDvEu4gB8g66oNbtr6eMbFIA4fIBJkgayoXriw2XEDQPJrQeROAlY6aeYOcMf+IVYTU3XFlZufMHinGywaW3YLpObVBAsbjF4QJMsVUSayjk4voPsHJOQfPWDhCgDnmDl6XIRerD24HsGtw86RMHOLvVSHrKBdeVE26gKB5NKHzaIwLOmrqBWJYZDLhASG16c0Tn+CdRhWDgWXnqRZUTnPIHuMJTfLVpkoYy5CzylHVTGZMTwkGAo2HBlkQplrJX6U+uF1wZz2uwS1SQ12IqWaPuO4baZaEFBdukksJmkcTOm+YJSvoqPFzxFA/YUhIvWxcmSdPWTWwbAKVp6rxTtPFUZfKIwpzm4IoMfaYQLWgmlG5FME2gdBgm+J7J+rtS/XBbaVLsR7bpPQnpMFlo2doWaVceHk9+MkyguZNCJ1He+kuHTWyQAzNM5YSUg/GlTk9ZunAsg1qELVOhUSAK0LABIJHLKbqaEbHZLL1VA3VgqoiOKXYiS+HRyaEKgsfIqX64HYWbLRXy/qWoylIV9gudL1OWBNgBgTNmxA6b4txDT4gi3Ri7xFSLxtXpmmYnzAcWDZgY8d503LFogz5sbonDgkKcxGsWsE1OI+rcQtlgBBCSOKD1mtqYpIU8cTvBmAT0yZe+zUzeY92fYjTtGipXLhuR0ePoHk0ofNWBX+lo8Z7pAZDk8mEw5L7dVyZZoE/pTewbI6SNbiAL5xeygW4xPRuLCGbhcO4RIeTMFYHEJkYyEO9HmJfXMDEj/LaH781wHHZEtqSQ/69UnGpzH7LKIAZEDSPJnTesJTUa+rwTepI9dLJEawYV+ZkRn9g+QirD8vF8Mq0jFQ29js6kCS3E1+jZIhgPNanHdHFqFvPJLHqFwQqbIA4jhDxcNsOCCQLDomaL/dr5lyJaJU6FxPFjO3JOh3kVMcROo8u+C+jo05GjMF3P3/FuDLn5x2M04xXULPwaS6hBYki+MrMdZJSgPHlcB7nCR5bJ9Kr5ACUn9jk5kivdd8tk95SOGrtqu9lr2IhK65ZtEl7ZKrp7DrqwZfRUSN1el7+7NJxZbywOC8neNKTch5vsTEMNsoCCqHBCqIPRjIPkm0BjvFODGtto99rCl+d3wmHkW0FPdpZtC7MMcVtGFQjJLX5bdQ2+x9ypdc313uj8xlsrfuLgWXz1cRhZvJYX0iNVBRcVcmCXZs6aEf3RQF2WI/TcCbKmGU3IOoDJGDdDub0+hYckt6PlGu2BcxmhbTdj/klhccLGJMcqRjMJP1jW2ETqLSWJ/29MAoORluJ+6LPffBZbi5gqi5h6catQpmOT7/OFf5UorRpLzCqcMltBLhwd1are3kztrSzXO0LUbXRQcdLh/RdSZ+swRm819REDrtqzC4es6Gw4JCKlSnjYVpo0xeq33PrADbFLL3RuCmObVmPN+24kfa+AojDuM4umKe2QwCf6EN906HwjujaitDs5o0s1y+k3lgbT2W2i7FJdnwbLXhJUBq/9liTctSmFC/0OqUinb0QddTWamtjbHRFuWJJ6NpqZ8vO3fZJ37Db+2GkaPYLGHs7XTTdiFQJ68SkVJFVmY6McR5UycflNCsccHFaV9FNbR4NttLxw4pQ7wJd066Z0ohVbzihaxHVExd/ay04oxUKWt+AsdiQ9OUyZ2krzN19IZIwafSTFgIBnMV73ADj7V/K8u1MaY2sJp2HWm0f41tqwajEvdHWOJs510MaAqN4aoSiPCXtN2KSi46dUxHdaMquar82O1x5jqhDGvqmoE9LfxcY3zqA7/x3HA67r9ZG4O6Cuxu12/+TP+eLP+I+HErqDDCDVmBDO4larujNe7x8om2rMug0MX0rL1+IWwdwfR+p1TNTyNmVJ85ljWzbWuGv8/C7HD/izjkHNZNYlhZcUOKVzKFUxsxxN/kax+8zPWPSFKw80rJr9Tizyj3o1gEsdwgWGoxPezDdZ1TSENE1dLdNvuKL+I84nxKesZgxXVA1VA1OcL49dFlpFV5yJMhzyCmNQ+a4BqusPJ2bB+xo8V9u3x48VVIEPS/mc3DvAbXyoYr6VgDfh5do5hhHOCXMqBZUPhWYbWZECwVJljLgMUWOCB4MUuMaxGNUQDVI50TQ+S3kFgIcu2qKkNSHVoM0SHsgoZxP2d5HH8B9woOk4x5bPkKtAHucZsdykjxuIpbUrSILgrT8G7G5oCW+K0990o7E3T6AdW4TilH5kDjds+H64kS0mz24grtwlzDHBJqI8YJQExotPvoC4JBq0lEjjQkyBZ8oH2LnRsQ4Hu1QsgDTJbO8fQDnllitkxuVskoiKbRF9VwzMDvxHAdwB7mD9yCplhHFEyUWHx3WtwCbSMMTCUCcEmSGlg4gTXkHpZXWQ7kpznK3EmCHiXInqndkQjunG5kxTKEeGye7jWz9cyMR2mGiFQ15ENRBTbCp+Gh86vAyASdgmJq2MC6hoADQ3GosP0QHbnMHjyBQvQqfhy/BUbeHd5WY/G/9LK/8Ka8Jd7UFeNWEZvzPb458Dn8DGLOe3/wGL/4xP+HXlRt+M1PE2iLhR8t+lfgxsuh7AfO2AOf+owWhSZRYQbd622hbpKWKuU+XuvNzP0OseRDa+mObgDHJUSc/pKx31QdKffQ5OIJpt8GWjlgTwMc/w5MPCR/yl1XC2a2Yut54SvOtMev55Of45BOat9aWG27p2ZVORRvnEk1hqWMVUmqa7S2YtvlIpspuF1pt0syuZS2NV14mUidCSfzQzg+KqvIYCMljIx2YK2AO34fX4GWdu5xcIAb8MzTw+j/lyWM+Dw/gjs4GD6ehNgA48kX/AI7XXM/XAN4WHr+9ntywqoCakCqmKP0rmQrJJEErG2Upg1JObr01lKQy4jskWalKYfJ/EDLMpjNSHFEUAde2fltaDgmrNaWQ9+AAb8I5vKjz3L1n1LriB/BXkG/wwR9y/oRX4LlioHA4LzP2inzRx/DWmutRweFjeP3tNeSGlaE1Fde0OS11yOpmbIp2u/jF1n2RRZviJM0yBT3IZl2HWImKjQOxIyeU325b/qWyU9Moj1o07tS0G7qJDoGHg5m8yeCxMoEH8GU45tnrNM84D2l297DQ9t1YP7jki/7RmutRweEA77/HWXOh3HCxkRgldDQkAjNTMl2Iloc1qN5JfJeeTlyTRzxURTdn1Ixv2uKjs12AbdEWlBtmVdk2k7FFwj07PCZ9XAwW3dG+8xKzNFr4EnwBZpy9Qzhh3jDXebBpYcpuo4fQ44u+fD1dweEnHzI7v0xuuOALRUV8rXpFyfSTQYkhd7IHm07jpyhlkCmI0ALYqPTpUxXS+z4jgDj1Pflvmz5ecuItpIBxyTHpSTGWd9g1ApfD/bvwUhL4nT1EzqgX7cxfCcNmb3mPL/qi9SwTHJ49oj5ZLjccbTG3pRmlYi6JCG0mQrAt1+i2UXTZ2dv9IlQpN5naMYtviaXlTrFpoMsl3bOAFEa8sqPj2WCMrx3Yjx99qFwO59Aw/wgx+HlqNz8oZvA3exRDvuhL1jMQHPaOJ0+XyA3fp1OfM3qObEVdhxjvynxNMXQV4+GJyvOEFqeQBaIbbO7i63rpxCltdZShPFxkjM2FPVkn3TG+Rp9pO3l2RzFegGfxGDHIAh8SteR0C4HopXzRF61nheDw6TFN05Ebvq8M3VKKpGjjO6r7nhudTEGMtYM92HTDaR1FDMXJ1eThsbKfywyoWwrzRSXkc51flG3vIid62h29bIcFbTGhfV+faaB+ohj7dPN0C2e2lC96+XouFByen9AsunLDJZ9z7NExiUc0OuoYW6UZkIyx2YUR2z6/TiRjyKMx5GbbjLHvHuf7YmtKghf34LJfx63Yg8vrvN2zC7lY0x0tvKezo4HmGYDU+Gab6dFL+KI761lDcNifcjLrrr9LWZJctG1FfU1uwhoQE22ObjdfkSzY63CbU5hzs21WeTddH2BaL11Gi7lVdlxP1nkxqhnKhVY6knS3EPgVGg1JpN5cP/hivujOelhXcPj8HC/LyI6MkteVjlolBdMmF3a3DbsuAYhL44dxzthWSN065xxUd55Lmf0wRbOYOqH09/o9WbO2VtFdaMb4qBgtFJoT1SqoN8wPXMoXLb3p1PUEhxfnnLzGzBI0Ku7FxrKsNJj/8bn/H8fPIVOd3rfrklUB/DOeO+nkghgSPzrlPxluCMtOnDL4Yml6dK1r3vsgMxgtPOrMFUZbEUbTdIzii5beq72G4PD0DKnwjmBULUVFmy8t+k7fZ3pKc0Q4UC6jpVRqS9Umv8bxw35flZVOU1X7qkjnhZlsMbk24qQ6Hz7QcuL6sDC0iHHki96Uh2UdvmgZnjIvExy2TeJdMDZNSbdZyAHe/Yd1xsQhHiKzjh7GxQ4yqMPaywPkjMamvqrYpmO7Knad+ZQC5msCuAPWUoxrxVhrGv7a+KLXFhyONdTMrZ7ke23qiO40ZJUyzgYyX5XyL0mV7NiUzEs9mjtbMN0dERqwyAJpigad0B3/zRV7s4PIfXSu6YV/MK7+OrYe/JvfGMn/PHJe2fyUdtnFrKRNpXV0Y2559aWPt/G4BlvjTMtXlVIWCnNyA3YQBDmYIodFz41PvXPSa6rq9lWZawZ4dP115HXV/M/tnFkkrBOdzg6aP4pID+MZnTJ1SuuB6iZlyiox4HT2y3YBtkUKWooacBQUDTpjwaDt5poBHl1/HXltwP887lKKXxNUEyPqpGTyA699UqY/lt9yGdlUKra0fFWS+36iylVWrAyd7Uw0CZM0z7xKTOduznLIjG2Hx8cDPLb+OvK6Bv7n1DYci4CxUuRxrjBc0bb4vD3rN5Zz36ntLb83eVJIB8LiIzCmn6SMPjlX+yNlTjvIGjs+QzHPf60Aj62/jrzG8j9vYMFtm1VoRWCJdmw7z9N0t+c8cxZpPeK4aTRicS25QhrVtUp7U578chk4q04Wx4YoQSjFryUlpcQ1AbxZ/XVMknIU//OGl7Q6z9Zpxi0+3yFhSkjUDpnCIUhLWVX23KQ+L9vKvFKI0ZWFQgkDLvBoylrHNVmaw10zwCPrr5tlodfnf94EWnQ0lFRWy8pW9LbkLsyUVDc2NSTHGDtnD1uMtchjbCeb1mpxFP0YbcClhzdLu6lfO8Bj6q+bdT2sz/+8SZCV7VIxtt0DUn9L7r4cLYWDSXnseEpOGFuty0qbOVlS7NNzs5FOGJUqQpl2Q64/yBpZf90sxbE+//PGdZ02HSipCbmD6NItmQ4Lk5XUrGpDMkhbMm2ZVheNYV+VbUWTcv99+2NyX1VoafSuC+AN6q9bFIMv5X/eagNWXZxEa9JjlMwNWb00akGUkSoepp1/yRuuqHGbUn3UdBSTxBU6SEVklzWRUkPndVvw2PrrpjvxOvzPmwHc0hpmq82npi7GRro8dXp0KXnUQmhZbRL7NEVp1uuZmO45vuzKsHrktS3GLWXODVjw+vXXLYx4Hf7njRPd0i3aoAGX6W29GnaV5YdyDj9TFkakje7GHYzDoObfddHtOSpoi2SmzJHrB3hM/XUDDEbxP2/oosszcRlehWXUvzHv4TpBVktHqwenFo8uLVmy4DKLa5d3RtLrmrM3aMFr1183E4sewf+85VWeg1c5ag276NZrM9IJVNcmLEvDNaV62aq+14IAOGFsBt973Ra8Xv11YzXwNfmft7Jg2oS+XOyoC8/cwzi66Dhmgk38kUmP1CUiYWOX1bpD2zWXt2FCp7uq8703APAa9dfNdscR/M/bZLIyouVxqJfeWvG9Je+JVckHQ9+CI9NWxz+blX/KYYvO5n2tAP/vrlZ7+8/h9y+9qeB/Hnt967e5mevX10rALDWK//FaAT5MXdBXdP0C/BAes792c40H+AiAp1e1oH8HgH94g/Lttx1gp63op1eyoM/Bvw5/G/7xFbqJPcCXnmBiwDPb/YKO4FX4OjyCb289db2/Noqicw4i7N6TVtoz8tNwDH+8x/i6Ae7lmaQVENzJFb3Di/BFeAwz+Is9SjeQySpPqbLFlNmyz47z5a/AF+AYFvDmHqibSXTEzoT4Gc3OALaqAP4KPFUJ6n+1x+rGAM6Zd78bgJ0a8QN4GU614vxwD9e1Amy6CcskNrczLx1JIp6HE5UZD/DBHrFr2oNlgG4Odv226BodoryjGJ9q2T/AR3vQrsOCS0ctXZi3ruLlhpFDJYl4HmYtjQCP9rhdn4suySLKDt6wLcC52h8xPlcjju1fn+yhuw4LZsAGUuo2b4Fx2UwQu77uqRHXGtg92aN3tQCbFexc0uk93vhTXbct6y7MulLycoUljx8ngDMBg1tvJjAazpEmOtxlzclvj1vQf1Tx7QlPDpGpqgtdSKz/d9/hdy1vTfFHSmC9dGDZbLiezz7Ac801HirGZsWjydfZyPvHXL/Y8Mjzg8BxTZiuwKz4Eb8sBE9zznszmjvFwHKPIWUnwhqfVRcd4Ck0K6ate48m1oOfrX3/yOtvAsJ8zsPAM89sjnddmuLuDPjX9Bu/L7x7xpMzFk6nWtyQfPg278Gn4Aekz2ZgOmU9eJ37R14vwE/BL8G3aibCiWMWWDQ0ZtkPMnlcGeAu/Ag+8ZyecU5BPuy2ILD+sQqyZhAKmn7XZd+jIMTN9eBL7x95xVLSX4On8EcNlXDqmBlqS13jG4LpmGbkF/0CnOi3H8ETOIXzmnmtb0a16Tzxj1sUvQCBiXZGDtmB3KAefPH94xcUa/6vwRn80GOFyjEXFpba4A1e8KQfFF+259tx5XS4egYn8fQsLGrqGrHbztr+uByTahWuL1NUGbDpsnrwBfePPwHHIf9X4RnM4Z2ABWdxUBlqQ2PwhuDxoS0vvqB1JzS0P4h2nA/QgTrsJFn+Y3AOjs9JFC07CGWX1oNX3T/yHOzgDjwPn1PM3g9Jk9lZrMEpxnlPmBbjyo2+KFXRU52TJM/2ALcY57RUzjObbjqxVw++4P6RAOf58pcVsw9Daje3htriYrpDOonre3CudSe6bfkTEgHBHuDiyu5MCsc7BHhYDx7ePxLjqigXZsw+ijMHFhuwBmtoTPtOxOrTvYJDnC75dnUbhfwu/ZW9AgYd+peL68HD+0emKquiXHhWjJg/UrkJYzuiaL3E9aI/ytrCvAd4GcYZMCkSQxfUg3v3j8c4e90j5ZTPdvmJJGHnOCI2nHS8081X013pHuBlV1gB2MX1YNmWLHqqGN/TWmG0y6clJWthxNUl48q38Bi8vtMKyzzpFdSDhxZ5WBA5ZLt8Jv3895DduBlgbPYAj8C4B8hO68FDkoh5lydC4FiWvBOVqjYdqjiLv92t8yPDjrDaiHdUD15qkSURSGmXJwOMSxWAXYwr3zaAufJ66l+94vv3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/wHuD9tQd4f+0B3l97gPfXHuD9tQd4f+0B3l97gG8LwP8G/AL8O/A5OCq0Ys2KIdv/qOIXG/4mvFAMF16gZD+2Xvu/B8as5+8bfllWyg0zaNO5bfXj6vfhhwD86/Aq3NfRS9t9WPnhfnvCIw/CT8GLcFTMnpntdF/z9V+PWc/vWoIH+FL3Znv57PitcdGP4R/C34avw5fgRVUInCwbsn1yyA8C8zm/BH8NXoXnVE6wVPjdeCI38kX/3+Ct9dbz1pTmHFRu+Hm4O9Ch3clr99negxfwj+ER/DR8EV6B5+DuQOnTgUw5rnkY+FbNU3gNXh0o/JYTuWOvyBf9FvzX663HH/HejO8LwAl8Hl5YLTd8q7sqA3wbjuExfAFegQdwfyDoSkWY8swzEf6o4Qyewefg+cHNbqMQruSL/u/WWc+E5g7vnnEXgDmcDeSGb/F4cBcCgT+GGRzDU3hZYburAt9TEtHgbM6JoxJ+6NMzzTcf6c2bycv2+KK/f+l6LBzw5IwfqZJhA3M472pWT/ajKxnjv4AFnMEpnBTPND6s2J7qHbPAqcMK74T2mZ4VGB9uJA465It+/eL1WKhYOD7xHOkr1ajK7d0C4+ke4Hy9qXZwpgLr+Znm/uNFw8xQOSy8H9IzjUrd9+BIfenYaylf9FsXr8fBAadnPIEDna8IBcwlxnuA0/Wv6GAWPd7dDIKjMdSWueAsBj4M7TOd06qBbwDwKr7oleuxMOEcTuEZTHWvDYUO7aHqAe0Bbq+HEFRzOz7WVoTDQkVds7A4sIIxfCQdCefFRoIOF/NFL1mPab/nvOakSL/Q1aFtNpUb/nFOVX6gzyg/1nISyDfUhsokIzaBR9Kxm80s5mK+6P56il1jXic7nhQxsxSm3OwBHl4fFdLqi64nDQZvqE2at7cWAp/IVvrN6/BFL1mPhYrGMBfOi4PyjuSGf6wBBh7p/FZTghCNWGgMzlBbrNJoPJX2mW5mwZfyRffXo7OFi5pZcS4qZUrlViptrXtw+GQoyhDPS+ANjcGBNRiLCQDPZPMHuiZfdFpPSTcQwwKYdRNqpkjm7AFeeT0pJzALgo7g8YYGrMHS0iocy+YTm2vyRUvvpXCIpQ5pe666TJrcygnScUf/p0NDs/iAI/nqDHC8TmQT8x3NF91l76oDdQGwu61Z6E0ABv7uO1dbf/37Zlv+Zw/Pbh8f1s4Avur6657/+YYBvur6657/+YYBvur6657/+YYBvur6657/+aYBvuL6657/+VMA8FXWX/f8zzcN8BXXX/f8zzcNMFdbf93zP38KLPiK6697/uebtuArrr/u+Z9vGmCusP6653/+1FjwVdZf9/zPN7oHX339dc//fNMu+irrr3v+50+Bi+Zq6697/uebA/jz8Pudf9ht/fWv517J/XUzAP8C/BAeX9WCDrUpZ3/dEMBxgPcfbtTVvsYV5Yn32u03B3Ac4P3b8I+vxNBKeeL9dRMAlwO83959qGO78sT769oB7g3w/vGVYFzKE++v6wV4OMD7F7tckFkmT7y/rhHgpQO8b+4Y46XyxPvrugBeNcB7BRiX8sT767oAvmCA9woAHsoT76+rBJjLBnh3txOvkifeX1dswZcO8G6N7sXyxPvr6i340gHe3TnqVfLE++uKAb50gHcXLnrX8sR7gNdPRqwzwLu7Y/FO5Yn3AK9jXCMGeHdgxDuVJ75VAI8ljP7PAb3/RfjcZfePHBB+79dpfpH1CanN30d+mT1h9GqAxxJGM5LQeeQ1+Tb+EQJrElLb38VHQ94TRq900aMIo8cSOo+8Dp8QfsB8zpqE1NO3OI9Zrj1h9EV78PqE0WMJnUdeU6E+Jjyk/hbrEFIfeWbvId8H9oTRFwdZaxJGvziW0Hn0gqYB/wyZ0PwRlxJST+BOw9m77Amj14ii1yGM/txYQudN0qDzGe4EqfA/5GJCagsHcPaEPWH0esekSwmjRxM6b5JEcZ4ww50ilvAOFxBSx4yLW+A/YU8YvfY5+ALC6NGEzhtmyZoFZoarwBLeZxUhtY4rc3bKnjB6TKJjFUHzJoTOozF2YBpsjcyxDgzhQ1YRUse8+J4wenwmaylB82hC5w0zoRXUNXaRBmSMQUqiWSWkLsaVqc/ZE0aPTFUuJWgeTei8SfLZQeMxNaZSIzbII4aE1Nmr13P2hNHjc9E9guYNCZ032YlNwESMLcZiLQHkE4aE1BFg0yAR4z1h9AiAGRA0jyZ03tyIxWMajMPWBIsxYJCnlITU5ShiHYdZ94TR4wCmSxg9jtB5KyPGYzymAYexWEMwAPIsAdYdV6aObmNPGD0aYLoEzaMJnTc0Ygs+YDw0GAtqxBjkuP38bMRWCHn73xNGjz75P73WenCEJnhwyVe3AEe8TtKdJcYhBl97wuhNAObK66lvD/9J9NS75v17wuitAN5fe4D31x7g/bUHeH/tAd5fe4D3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/w/toDvAd4f/24ABzZ8o+KLsSLS+Pv/TqTb3P4hKlQrTGh+fbIBT0Axqznnb+L/V2mb3HkN5Mb/nEHeK7d4IcDld6lmDW/iH9E+AH1MdOw/Jlu2T1xNmY98sv4wHnD7D3uNHu54WUuOsBTbQuvBsPT/UfzNxGYzwkP8c+Yz3C+r/i6DcyRL/rZ+utRwWH5PmfvcvYEt9jLDS/bg0/B64DWKrQM8AL8FPwS9beQCe6EMKNZYJol37jBMy35otdaz0Bw2H/C2Smc7+WGB0HWDELBmOByA3r5QONo4V+DpzR/hFS4U8wMW1PXNB4TOqYz9urxRV++ntWCw/U59Ty9ebdWbrgfRS9AYKKN63ZokZVygr8GZ/gfIhZXIXPsAlNjPOLBby5c1eOLvmQ9lwkOy5x6QV1j5TYqpS05JtUgUHUp5toHGsVfn4NX4RnMCe+AxTpwmApTYxqMxwfCeJGjpXzRF61nbcHhUBPqWze9svwcHJ+S6NPscKrEjug78Dx8Lj3T8D4YxGIdxmJcwhi34fzZUr7olevZCw5vkOhoClq5zBPZAnygD/Tl9EzDh6kl3VhsHYcDEb+hCtJSvuiV69kLDm+WycrOTArHmB5/VYyP6jOVjwgGawk2zQOaTcc1L+aLXrKeveDwZqlKrw8U9Y1p66uK8dEzdYwBeUQAY7DbyYNezBfdWQ97weEtAKYQg2xJIkuveAT3dYeLGH+ShrWNwZgN0b2YL7qznr3g8JYAo5bQBziPjx7BPZ0d9RCQp4UZbnFdzBddor4XHN4KYMrB2qHFRIzzcLAHQZ5the5ovui94PCWAPefaYnxIdzRwdHCbuR4B+tbiy96Lzi8E4D7z7S0mEPd+eqO3cT53Z0Y8SV80XvB4Z0ADJi/f7X113f+7p7/+UYBvur6657/+YYBvur6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+VMA8FXWX/f8z58OgK+y/rrnf75RgLna+uue//lTA/CV1V/3/M837aKvvv6653++UQvmauuve/7nTwfAV1N/3fM/fzr24Cuuv+75nz8FFnxl9dc9//MOr/8/glixwRuUfM4AAAAASUVORK5CYII="},getSearchTexture:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}});var SSAARenderPass=function(e,t,r,n){Pass.call(this),this.scene=e,this.camera=t,this.sampleLevel=4,this.unbiased=!0,this.clearColor=void 0!==r?r:0,this.clearAlpha=void 0!==n?n:0,void 0===CopyShader&&console.error("SSAARenderPass relies on CopyShader");var o=CopyShader;this.copyUniforms=UniformsUtils.clone(o.uniforms),this.copyMaterial=new ShaderMaterial({uniforms:this.copyUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,premultipliedAlpha:!0,transparent:!0,blending:AdditiveBlending,depthTest:!1,depthWrite:!1}),this.camera2=new OrthographicCamera(-1,1,1,-1,0,1),this.scene2=new Scene,this.quad2=new Mesh(new PlaneBufferGeometry(2,2),this.copyMaterial),this.quad2.frustumCulled=!1,this.scene2.add(this.quad2)};SSAARenderPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:SSAARenderPass,dispose:function(){this.sampleRenderTarget&&(this.sampleRenderTarget.dispose(),this.sampleRenderTarget=null)},setSize:function(e,t){this.sampleRenderTarget&&this.sampleRenderTarget.setSize(e,t)},render:function(e,t,r){this.sampleRenderTarget||(this.sampleRenderTarget=new WebGLRenderTarget(r.width,r.height,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat}),this.sampleRenderTarget.texture.name="SSAARenderPass.sample");var n=SSAARenderPass.JitterVectors[Math.max(0,Math.min(this.sampleLevel,5))],o=e.autoClear;e.autoClear=!1;var l=e.getClearColor().getHex(),c=e.getClearAlpha(),h=1/n.length;this.copyUniforms.tDiffuse.value=this.sampleRenderTarget.texture;for(var d=r.width,f=r.height,i=0;i<n.length;i++){var m=n[i];this.camera.setViewOffset&&this.camera.setViewOffset(d,f,.0625*m[0],.0625*m[1],d,f);var v=h;if(this.unbiased)v+=1/32*((i+.5)/n.length-.5);this.copyUniforms.opacity.value=v,e.setClearColor(this.clearColor,this.clearAlpha),e.setRenderTarget(this.sampleRenderTarget),e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(this.renderToScreen?null:t),0===i&&(e.setClearColor(0,0),e.clear()),e.render(this.scene2,this.camera2)}this.camera.clearViewOffset&&this.camera.clearViewOffset(),e.autoClear=o,e.setClearColor(l,c)}}),SSAARenderPass.JitterVectors=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];var SSAOShader={defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new Vector2},cameraProjectionMatrix:{value:new Matrix4},cameraInverseProjectionMatrix:{value:new Matrix4},kernelRadius:{value:8},minDistance:{value:.005},maxDistance:{value:.05}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tDepth;","uniform sampler2D tNoise;","uniform vec3 kernel[ KERNEL_SIZE ];","uniform vec2 resolution;","uniform float cameraNear;","uniform float cameraFar;","uniform mat4 cameraProjectionMatrix;","uniform mat4 cameraInverseProjectionMatrix;","uniform float kernelRadius;","uniform float minDistance;","uniform float maxDistance;","varying vec2 vUv;","#include <packing>","float getDepth( const in vec2 screenPosition ) {","\treturn texture2D( tDepth, screenPosition ).x;","}","float getLinearDepth( const in vec2 screenPosition ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;","\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );","\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );","\t#else","\t\treturn texture2D( depthSampler, coord ).x;","\t#endif","}","float getViewZ( const in float depth ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );","\t#else","\t\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );","\t#endif","}","vec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {","\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];","\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );","\tclipPosition *= clipW; // unprojection.","\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;","}","vec3 getViewNormal( const in vec2 screenPosition ) {","\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );","}","void main() {","\tfloat depth = getDepth( vUv );","\tfloat viewZ = getViewZ( depth );","\tvec3 viewPosition = getViewPosition( vUv, depth, viewZ );","\tvec3 viewNormal = getViewNormal( vUv );"," vec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );","\tvec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;","\tvec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );","\tvec3 bitangent = cross( viewNormal, tangent );","\tmat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );"," float occlusion = 0.0;"," for ( int i = 0; i < KERNEL_SIZE; i ++ ) {","\t\tvec3 sampleVector = kernelMatrix * kernel[ i ];","\t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );","\t\tvec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 );","\t\tsamplePointNDC /= samplePointNDC.w;","\t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;","\t\tfloat realDepth = getLinearDepth( samplePointUv );","\t\tfloat sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );","\t\tfloat delta = sampleDepth - realDepth;","\t\tif ( delta > minDistance && delta < maxDistance ) {","\t\t\tocclusion += 1.0;","\t\t}","\t}","\tocclusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );","\tgl_FragColor = vec4( vec3( 1.0 - occlusion ), 1.0 );","}"].join("\n")},SSAODepthShader={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","uniform float cameraNear;","uniform float cameraFar;","varying vec2 vUv;","#include <packing>","float getLinearDepth( const in vec2 screenPosition ) {","\t#if PERSPECTIVE_CAMERA == 1","\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;","\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );","\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );","\t#else","\t\treturn texture2D( depthSampler, coord ).x;","\t#endif","}","void main() {","\tfloat depth = getLinearDepth( vUv );","\tgl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );","}"].join("\n")},SSAOBlurShader={uniforms:{tDiffuse:{value:null},resolution:{value:new Vector2}},vertexShader:["varying vec2 vUv;","void main() {","\tvUv = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","void main() {","\tvec2 texelSize = ( 1.0 / resolution );","\tfloat result = 0.0;","\tfor ( int i = - 2; i <= 2; i ++ ) {","\t\tfor ( int j = - 2; j <= 2; j ++ ) {","\t\t\tvec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;","\t\t\tresult += texture2D( tDiffuse, vUv + offset ).r;","\t\t}","\t}","\tgl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );","}"].join("\n")},SSAOPass=function(e,t,r,n){Pass.call(this),this.width=void 0!==r?r:512,this.height=void 0!==n?n:512,this.clear=!0,this.camera=t,this.scene=e,this.kernelRadius=8,this.kernelSize=32,this.kernel=[],this.noiseTexture=null,this.output=0,this.minDistance=.005,this.maxDistance=.1,this.generateSampleKernel(),this.generateRandomKernelRotations();var o=new DepthTexture;o.type=UnsignedShortType,o.minFilter=NearestFilter,o.maxFilter=NearestFilter,this.beautyRenderTarget=new WebGLRenderTarget(this.width,this.height,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat,depthTexture:o,depthBuffer:!0}),this.normalRenderTarget=new WebGLRenderTarget(this.width,this.height,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat}),this.ssaoRenderTarget=new WebGLRenderTarget(this.width,this.height,{minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat}),this.blurRenderTarget=this.ssaoRenderTarget.clone(),void 0===SSAOShader&&console.error("SSAOPass: The pass relies on SSAOShader."),this.ssaoMaterial=new ShaderMaterial({defines:Object.assign({},SSAOShader.defines),uniforms:UniformsUtils.clone(SSAOShader.uniforms),vertexShader:SSAOShader.vertexShader,fragmentShader:SSAOShader.fragmentShader,blending:NoBlending}),this.ssaoMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssaoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssaoMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.ssaoMaterial.uniforms.cameraNear.value=this.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=this.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.normalMaterial=new MeshNormalMaterial,this.normalMaterial.blending=NoBlending,this.blurMaterial=new ShaderMaterial({defines:Object.assign({},SSAOBlurShader.defines),uniforms:UniformsUtils.clone(SSAOBlurShader.uniforms),vertexShader:SSAOBlurShader.vertexShader,fragmentShader:SSAOBlurShader.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new ShaderMaterial({defines:Object.assign({},SSAODepthShader.defines),uniforms:UniformsUtils.clone(SSAODepthShader.uniforms),vertexShader:SSAODepthShader.vertexShader,fragmentShader:SSAODepthShader.fragmentShader,blending:NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new ShaderMaterial({uniforms:UniformsUtils.clone(CopyShader.uniforms),vertexShader:CopyShader.vertexShader,fragmentShader:CopyShader.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:DstColorFactor,blendDst:ZeroFactor,blendEquation:AddEquation,blendSrcAlpha:DstAlphaFactor,blendDstAlpha:ZeroFactor,blendEquationAlpha:AddEquation}),this.quadCamera=new OrthographicCamera(-1,1,1,-1,0,1),this.quadScene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quadScene.add(this.quad),this.originalClearColor=new Color};SSAOPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:SSAOPass,dispose:function(){this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.quad.geometry.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose()},render:function(e,t){switch(e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.renderPass(e,this.ssaoMaterial,this.ssaoRenderTarget),this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.output){case SSAOPass.OUTPUT.SSAO:this.copyMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.copyMaterial.blending=NoBlending,this.renderPass(e,this.copyMaterial,null);break;case SSAOPass.OUTPUT.Blur:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=NoBlending,this.renderPass(e,this.copyMaterial,null);break;case SSAOPass.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=NoBlending,this.renderPass(e,this.copyMaterial,null);break;case SSAOPass.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,null);break;case SSAOPass.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=NoBlending,this.renderPass(e,this.copyMaterial,null);break;case SSAOPass.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=NoBlending,this.renderPass(e,this.copyMaterial,null),this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=CustomBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("SSAOPass: Unknown output type.")}},renderPass:function(e,t,r,n,o){this.originalClearColor.copy(e.getClearColor());var l=e.getClearAlpha(),c=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=n&&(e.setClearColor(n),e.setClearAlpha(o||0),e.clear()),this.quad.material=t,e.render(this.quadScene,this.quadCamera),e.autoClear=c,e.setClearColor(this.originalClearColor),e.setClearAlpha(l)},renderOverride:function(e,t,r,n,o){this.originalClearColor.copy(e.getClearColor());var l=e.getClearAlpha(),c=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,n=t.clearColor||n,o=t.clearAlpha||o,null!=n&&(e.setClearColor(n),e.setClearAlpha(o||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=c,e.setClearColor(this.originalClearColor),e.setClearAlpha(l)},setSize:function(e,t){this.width=e,this.height=t,this.beautyRenderTarget.setSize(e,t),this.ssaoRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.ssaoMaterial.uniforms.resolution.value.set(e,t),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.getInverse(this.camera.projectionMatrix),this.blurMaterial.uniforms.resolution.value.set(e,t)},generateSampleKernel:function(){for(var e=this.kernelSize,t=this.kernel,i=0;i<e;i++){var r=new Vector3;r.x=2*Math.random()-1,r.y=2*Math.random()-1,r.z=Math.random(),r.normalize();var n=i/e;n=_Math.lerp(.1,1,n*n),r.multiplyScalar(n),t.push(r)}},generateRandomKernelRotations:function(){void 0===SimplexNoise&&console.error("SSAOPass: The pass relies on SimplexNoise.");for(var e=new SimplexNoise,data=new Float32Array(64),i=0;i<16;i++){var t=4*i,r=2*Math.random()-1,n=2*Math.random()-1,o=e.noise3d(r,n,0);data[t]=o,data[t+1]=o,data[t+2]=o,data[t+3]=1}this.noiseTexture=new DataTexture(data,4,4,RGBAFormat,FloatType),this.noiseTexture.wrapS=RepeatWrapping,this.noiseTexture.wrapT=RepeatWrapping,this.noiseTexture.needsUpdate=!0}}),SSAOPass.OUTPUT={Default:0,SSAO:1,Blur:2,Beauty:3,Depth:4,Normal:5};var TAARenderPass=function(e,t,r){void 0===SSAARenderPass&&console.error("TAARenderPass relies on SSAARenderPass"),SSAARenderPass.call(this,e,t,r),this.sampleLevel=0,this.accumulate=!1};TAARenderPass.JitterVectors=SSAARenderPass.JitterVectors,TAARenderPass.prototype=Object.assign(Object.create(SSAARenderPass.prototype),{constructor:TAARenderPass,render:function(e,t,r,n){if(!this.accumulate)return SSAARenderPass.prototype.render.call(this,e,t,r,n),void(this.accumulateIndex=-1);var o=TAARenderPass.JitterVectors[5];this.sampleRenderTarget||(this.sampleRenderTarget=new WebGLRenderTarget(r.width,r.height,this.params),this.sampleRenderTarget.texture.name="TAARenderPass.sample"),this.holdRenderTarget||(this.holdRenderTarget=new WebGLRenderTarget(r.width,r.height,this.params),this.holdRenderTarget.texture.name="TAARenderPass.hold"),this.accumulate&&-1===this.accumulateIndex&&(SSAARenderPass.prototype.render.call(this,e,this.holdRenderTarget,r,n),this.accumulateIndex=0);var l=e.autoClear;e.autoClear=!1;var c=1/o.length;if(this.accumulateIndex>=0&&this.accumulateIndex<o.length){this.copyUniforms.opacity.value=c,this.copyUniforms.tDiffuse.value=t.texture;for(var h=Math.pow(2,this.sampleLevel),i=0;i<h;i++){var d=o[this.accumulateIndex];if(this.camera.setViewOffset&&this.camera.setViewOffset(r.width,r.height,.0625*d[0],.0625*d[1],r.width,r.height),e.setRenderTarget(t),e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(this.sampleRenderTarget),0===this.accumulateIndex&&e.clear(),e.render(this.scene2,this.camera2),this.accumulateIndex++,this.accumulateIndex>=o.length)break}this.camera.clearViewOffset&&this.camera.clearViewOffset()}var f=this.accumulateIndex*c;f>0&&(this.copyUniforms.opacity.value=1,this.copyUniforms.tDiffuse.value=this.sampleRenderTarget.texture,e.setRenderTarget(t),e.clear(),e.render(this.scene2,this.camera2)),f<1&&(this.copyUniforms.opacity.value=1-f,this.copyUniforms.tDiffuse.value=this.holdRenderTarget.texture,e.setRenderTarget(t),0===f&&e.clear(),e.render(this.scene2,this.camera2)),e.autoClear=l}});var TexturePass=function(map,e){Pass.call(this),void 0===CopyShader&&console.error("TexturePass relies on CopyShader");var t=CopyShader;this.map=map,this.opacity=void 0!==e?e:1,this.uniforms=UniformsUtils.clone(t.uniforms),this.material=new ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,depthTest:!1,depthWrite:!1}),this.needsSwap=!1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};TexturePass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:TexturePass,render:function(e,t,r,n,o){var l=e.autoClear;e.autoClear=!1,this.quad.material=this.material,this.uniforms.opacity.value=this.opacity,this.uniforms.tDiffuse.value=this.map,this.material.transparent=this.opacity<1,e.setRenderTarget(this.renderToScreen?null:r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.autoClear=l}});var LuminosityHighPassShader={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{type:"t",value:null},luminosityThreshold:{type:"f",value:1},smoothWidth:{type:"f",value:1},defaultColor:{type:"c",value:new Color(0)},defaultOpacity:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","gl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},UnrealBloomPass=function(e,t,r,n){Pass.call(this),this.strength=void 0!==t?t:1,this.radius=r,this.threshold=n,this.resolution=void 0!==e?new Vector2(e.x,e.y):new Vector2(256,256),this.clearColor=new Color(0,0,0);var o={minFilter:LinearFilter,magFilter:LinearFilter,format:RGBAFormat};this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2);this.renderTargetBright=new WebGLRenderTarget(l,c,o),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(var i=0;i<this.nMips;i++){var h=new WebGLRenderTarget(l,c,o);h.texture.name="UnrealBloomPass.h"+i,h.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(h);var d=new WebGLRenderTarget(l,c,o);d.texture.name="UnrealBloomPass.v"+i,d.texture.generateMipmaps=!1,this.renderTargetsVertical.push(d),l=Math.round(l/2),c=Math.round(c/2)}void 0===LuminosityHighPassShader&&console.error("UnrealBloomPass relies on LuminosityHighPassShader");var f=LuminosityHighPassShader;this.highPassUniforms=UniformsUtils.clone(f.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:f.vertexShader,fragmentShader:f.fragmentShader,defines:{}}),this.separableBlurMaterials=[];var m=[3,5,7,9,11];for(l=Math.round(this.resolution.x/2),c=Math.round(this.resolution.y/2),i=0;i<this.nMips;i++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(m[i])),this.separableBlurMaterials[i].uniforms.texSize.value=new Vector2(l,c),l=Math.round(l/2),c=Math.round(c/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new Vector3(1,1,1),new Vector3(1,1,1),new Vector3(1,1,1),new Vector3(1,1,1),new Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,void 0===CopyShader&&console.error("BloomPass relies on CopyShader");var v=CopyShader;this.copyUniforms=UniformsUtils.clone(v.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new ShaderMaterial({uniforms:this.copyUniforms,vertexShader:v.vertexShader,fragmentShader:v.fragmentShader,blending:AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new Color,this.oldClearAlpha=1,this.camera=new OrthographicCamera(-1,1,1,-1,0,1),this.scene=new Scene,this.basic=new MeshBasicMaterial,this.quad=new Mesh(new PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)};UnrealBloomPass.prototype=Object.assign(Object.create(Pass.prototype),{constructor:UnrealBloomPass,dispose:function(){for(var i=0;i<this.renderTargetsHorizontal.length;i++)this.renderTargetsHorizontal[i].dispose();for(i=0;i<this.renderTargetsVertical.length;i++)this.renderTargetsVertical[i].dispose();this.renderTargetBright.dispose()},setSize:function(e,t){var r=Math.round(e/2),n=Math.round(t/2);this.renderTargetBright.setSize(r,n);for(var i=0;i<this.nMips;i++)this.renderTargetsHorizontal[i].setSize(r,n),this.renderTargetsVertical[i].setSize(r,n),this.separableBlurMaterials[i].uniforms.texSize.value=new Vector2(r,n),r=Math.round(r/2),n=Math.round(n/2)},render:function(e,t,r,n,o){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var l=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),o&&e.context.disable(e.context.STENCIL_TEST),this.renderToScreen&&(this.quad.material=this.basic,this.basic.map=r.texture,e.setRenderTarget(null),e.clear(),e.render(this.scene,this.camera)),this.highPassUniforms.tDiffuse.value=r.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.quad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),e.render(this.scene,this.camera);for(var c=this.renderTargetBright,i=0;i<this.nMips;i++)this.quad.material=this.separableBlurMaterials[i],this.separableBlurMaterials[i].uniforms.colorTexture.value=c.texture,this.separableBlurMaterials[i].uniforms.direction.value=UnrealBloomPass.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[i]),e.clear(),e.render(this.scene,this.camera),this.separableBlurMaterials[i].uniforms.colorTexture.value=this.renderTargetsHorizontal[i].texture,this.separableBlurMaterials[i].uniforms.direction.value=UnrealBloomPass.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[i]),e.clear(),e.render(this.scene,this.camera),c=this.renderTargetsVertical[i];this.quad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),e.render(this.scene,this.camera),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,o&&e.context.enable(e.context.STENCIL_TEST),this.renderToScreen?(e.setRenderTarget(null),e.render(this.scene,this.camera)):(e.setRenderTarget(r),e.render(this.scene,this.camera)),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=l},getSeperableBlurMaterial:function(e){return new ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new Vector2(.5,.5)},direction:{value:new Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat fSigma = float(SIGMA);\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\t\t\t\t\t\tfloat x = float(i);\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\t\t\t\t\t\tweightSum += 2.0 * w;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})},getCompositeMaterial:function(e){return new ShaderMaterial({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D blurTexture1;\t\t\t\tuniform sampler2D blurTexture2;\t\t\t\tuniform sampler2D blurTexture3;\t\t\t\tuniform sampler2D blurTexture4;\t\t\t\tuniform sampler2D blurTexture5;\t\t\t\tuniform sampler2D dirtTexture;\t\t\t\tuniform float bloomStrength;\t\t\t\tuniform float bloomRadius;\t\t\t\tuniform float bloomFactors[NUM_MIPS];\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\t\t\t\t\t\t\t\tfloat lerpBloomFactor(const in float factor) { \t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\t\t\t\t}\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\t\t\t\t}"})}}),UnrealBloomPass.BlurDirectionX=new Vector2(1,0),UnrealBloomPass.BlurDirectionY=new Vector2(0,1);var PRNG=function(){this.seed=1,this.next=function(){return this.gen()/2147483647},this.nextRange=function(e,t){return e+(t-e)*this.next()},this.gen=function(){return this.seed=16807*this.seed%2147483647}},CSS2DObject=function(element){Object3D.call(this),this.element=element,this.element.style.position="absolute",this.addEventListener("removed",(function(e){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)}))};CSS2DObject.prototype=Object.create(Object3D.prototype),CSS2DObject.prototype.constructor=CSS2DObject;var CSS2DRenderer=function(){var e,t,r,n;console.log("CSS2DRenderer",REVISION);var o=new Vector3,l=new Matrix4,c=new Matrix4,h={objects:new WeakMap},d=document.createElement("div");d.style.overflow="hidden",this.domElement=d,this.getSize=function(){return{width:e,height:t}},this.setSize=function(o,l){r=(e=o)/2,n=(t=l)/2,d.style.width=o+"px",d.style.height=l+"px"};var a,b,f=function(object,e){if(object instanceof CSS2DObject){o.setFromMatrixPosition(object.matrixWorld),o.applyMatrix4(c);var element=object.element,style="translate(-50%,-50%) translate("+(o.x*r+r)+"px,"+(-o.y*n+n)+"px)";element.style.WebkitTransform=style,element.style.MozTransform=style,element.style.oTransform=style,element.style.transform=style;var t={distanceToCameraSquared:m(e,object)};h.objects.set(object,t),element.parentNode!==d&&d.appendChild(element)}for(var i=0,l=object.children.length;i<l;i++)f(object.children[i],e)},m=(a=new Vector3,b=new Vector3,function(e,t){return a.setFromMatrixPosition(e.matrixWorld),b.setFromMatrixPosition(t.matrixWorld),a.distanceToSquared(b)}),v=function(e){for(var t=function(e){var t=[];return e.traverse((function(object){object instanceof CSS2DObject&&t.push(object)})),t}(e).sort((function(a,b){return h.objects.get(a).distanceToCameraSquared-h.objects.get(b).distanceToCameraSquared})),r=t.length,i=0,n=t.length;i<n;i++)t[i].element.style.zIndex=r-i};this.render=function(e,t){e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),l.copy(t.matrixWorldInverse),c.multiplyMatrices(t.projectionMatrix,l),f(e,t),v(e)}},CSS3DObject=function(element){Object3D.call(this),this.element=element,this.element.style.position="absolute",this.addEventListener("removed",(function(){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)}))};CSS3DObject.prototype=Object.create(Object3D.prototype),CSS3DObject.prototype.constructor=CSS3DObject;var CSS3DSprite=function(element){CSS3DObject.call(this,element)};CSS3DSprite.prototype=Object.create(CSS3DObject.prototype),CSS3DSprite.prototype.constructor=CSS3DSprite;var CSS3DRenderer=function(){var e,t,r,n;console.log("CSS3DRenderer",REVISION);var o=new Matrix4,l={camera:{fov:0,style:""},objects:new WeakMap},c=document.createElement("div");c.style.overflow="hidden",this.domElement=c;var h=document.createElement("div");h.style.WebkitTransformStyle="preserve-3d",h.style.transformStyle="preserve-3d",c.appendChild(h);var d=/Trident/i.test(navigator.userAgent);function f(e){return Math.abs(e)<1e-10?0:e}function m(e){var t=e.elements;return"matrix3d("+f(t[0])+","+f(-t[1])+","+f(t[2])+","+f(t[3])+","+f(t[4])+","+f(-t[5])+","+f(t[6])+","+f(t[7])+","+f(t[8])+","+f(-t[9])+","+f(t[10])+","+f(t[11])+","+f(t[12])+","+f(-t[13])+","+f(t[14])+","+f(t[15])+")"}function v(e,t){var o=e.elements,l="matrix3d("+f(o[0])+","+f(o[1])+","+f(o[2])+","+f(o[3])+","+f(-o[4])+","+f(-o[5])+","+f(-o[6])+","+f(-o[7])+","+f(o[8])+","+f(o[9])+","+f(o[10])+","+f(o[11])+","+f(o[12])+","+f(o[13])+","+f(o[14])+","+f(o[15])+")";return d?"translate(-50%,-50%)translate("+r+"px,"+n+"px)"+t+l:"translate(-50%,-50%)"+l}this.getSize=function(){return{width:e,height:t}},this.setSize=function(o,l){r=(e=o)/2,n=(t=l)/2,c.style.width=o+"px",c.style.height=l+"px",h.style.width=o+"px",h.style.height=l+"px"};var a,b,y=(a=new Vector3,b=new Vector3,function(e,t){return a.setFromMatrixPosition(e.matrixWorld),b.setFromMatrixPosition(t.matrixWorld),a.distanceToSquared(b)});function x(e){for(var t=function(e){var t=[];return e.traverse((function(object){object instanceof CSS3DObject&&t.push(object)})),t}(e).sort((function(a,b){return l.objects.get(a).distanceToCameraSquared-l.objects.get(b).distanceToCameraSquared})),r=t.length,i=0,n=t.length;i<n;i++)t[i].element.style.zIndex=r-i}this.render=function(e,t){var w=t.projectionMatrix.elements[5]*n;if(l.camera.fov!==w&&(t.isPerspectiveCamera&&(c.style.WebkitPerspective=w+"px",c.style.perspective=w+"px"),l.camera.fov=w),e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.isOrthographicCamera)var M=-(t.right+t.left)/2,S=(t.top+t.bottom)/2;var A=t.isOrthographicCamera?"scale("+w+")translate("+f(M)+"px,"+f(S)+"px)"+m(t.matrixWorldInverse):"translateZ("+w+"px)"+m(t.matrixWorldInverse),style=A+"translate("+r+"px,"+n+"px)";l.camera.style===style||d||(h.style.WebkitTransform=style,h.style.transform=style,l.camera.style=style),function e(object,t,r){if(object instanceof CSS3DObject){var style;object instanceof CSS3DSprite?(o.copy(t.matrixWorldInverse),o.transpose(),o.copyPosition(object.matrixWorld),o.scale(object.scale),o.elements[3]=0,o.elements[7]=0,o.elements[11]=0,o.elements[15]=1,style=v(o,r)):style=v(object.matrixWorld,r);var element=object.element,n=l.objects.get(object);if(void 0===n||n.style!==style){element.style.WebkitTransform=style,element.style.transform=style;var c={style:style};d&&(c.distanceToCameraSquared=y(t,object)),l.objects.set(object,c)}element.parentNode!==h&&h.appendChild(element)}for(var i=0,f=object.children.length;i<f;i++)e(object.children[i],t,r)}(e,t,A),d&&x(e)}},RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},RenderableFace=function(){this.id=0,this.v1=new RenderableVertex,this.v2=new RenderableVertex,this.v3=new RenderableVertex,this.normalModel=new Vector3,this.vertexNormalsModel=[new Vector3,new Vector3,new Vector3],this.vertexNormalsLength=0,this.color=new Color,this.material=null,this.uvs=[new Vector2,new Vector2,new Vector2],this.z=0,this.renderOrder=0},RenderableVertex=function(){this.position=new Vector3,this.positionWorld=new Vector3,this.positionScreen=new Vector4,this.visible=!0};RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)};var RenderableLine=function(){this.id=0,this.v1=new RenderableVertex,this.v2=new RenderableVertex,this.vertexColors=[new Color,new Color],this.material=null,this.z=0,this.renderOrder=0},RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new Vector2,this.material=null,this.renderOrder=0},Projector=function(){var e,t,r,n,o,l,c,h,d,f,m,v=[],y=0,x=[],w=0,M=[],S=0,A=[],T=0,_=[],L=0,C={objects:[],lights:[],elements:[]},N=new Vector3,P=new Vector4,E=new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1)),D=new Box3,F=new Array(3),R=new Matrix4,O=new Matrix4,B=new Matrix4,I=new Matrix3,U=new Frustum,V=new Vector4,k=new Vector4;this.projectVector=function(e,t){console.warn("Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("Projector: .pickingRay() is now raycaster.setFromCamera().")};var G=new function(){var e=[],t=[],n=[],object=null,l=new Matrix3;function h(e){var t=e.position,r=e.positionWorld,n=e.positionScreen;r.copy(t).applyMatrix4(m),n.copy(r).applyMatrix4(O);var o=1/n.w;n.x*=o,n.y*=o,n.z*=o,e.visible=n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1}function d(e,t,r){return!0===e.visible||!0===t.visible||!0===r.visible||(F[0]=e.positionScreen,F[1]=t.positionScreen,F[2]=r.positionScreen,E.intersectsBox(D.setFromPoints(F)))}function f(e,t,r){return(r.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(r.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(r){(object=r).material,l.getNormalMatrix(object.matrixWorld),e.length=0,t.length=0,n.length=0},projectVertex:h,checkTriangleVisibility:d,checkBackfaceCulling:f,pushVertex:function(e,t,n){(r=W()).position.set(e,t,n),h(r)},pushNormal:function(t,r,n){e.push(t,r,n)},pushColor:function(e,g,b){t.push(e,g,b)},pushUv:function(e,t){n.push(e,t)},pushLine:function(a,b){var e=x[a],r=x[b];e.positionScreen.copy(e.position).applyMatrix4(B),r.positionScreen.copy(r.position).applyMatrix4(B),!0===Q(e.positionScreen,r.positionScreen)&&(e.positionScreen.multiplyScalar(1/e.positionScreen.w),r.positionScreen.multiplyScalar(1/r.positionScreen.w),(c=X()).id=object.id,c.v1.copy(e),c.v2.copy(r),c.z=Math.max(e.positionScreen.z,r.positionScreen.z),c.renderOrder=object.renderOrder,c.material=object.material,object.material.vertexColors===VertexColors&&(c.vertexColors[0].fromArray(t,3*a),c.vertexColors[1].fromArray(t,3*b)),C.elements.push(c))},pushTriangle:function(a,b,r,c){var h=arguments,m=x[a],v=x[b],y=x[r];if(!1!==d(m,v,y)&&(c.side===DoubleSide||!0===f(m,v,y))){(o=H()).id=object.id,o.v1.copy(m),o.v2.copy(v),o.v3.copy(y),o.z=(m.positionScreen.z+v.positionScreen.z+y.positionScreen.z)/3,o.renderOrder=object.renderOrder,N.subVectors(y.position,v.position),P.subVectors(m.position,v.position),N.cross(P),o.normalModel.copy(N),o.normalModel.applyMatrix3(l).normalize();for(var i=0;i<3;i++){var w=o.vertexNormalsModel[i];w.fromArray(e,3*h[i]),w.applyMatrix3(l).normalize(),o.uvs[i].fromArray(n,2*h[i])}o.vertexNormalsLength=3,o.material=c,c.vertexColors!==FaceColors&&c.vertexColors!==VertexColors||o.color.fromArray(t,3*a),C.elements.push(o)}}}};function z(object){(e=function(){if(t===y){var object=new RenderableObject;return v.push(object),y++,t++,object}return v[t++]}()).id=object.id,e.object=object,N.setFromMatrixPosition(object.matrixWorld),N.applyMatrix4(O),e.z=N.z,e.renderOrder=object.renderOrder,C.objects.push(e)}function j(e,object,t){var r=1/e.w;e.z*=r,e.z>=-1&&e.z<=1&&((d=function(){if(f===L){var e=new RenderableSprite;return _.push(e),L++,f++,e}return _[f++]}()).id=object.id,d.x=e.x*r,d.y=e.y*r,d.z=e.z,d.renderOrder=object.renderOrder,d.object=object,d.rotation=object.rotation,d.scale.x=object.scale.x*Math.abs(d.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12])),d.scale.y=object.scale.y*Math.abs(d.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13])),d.material=object.material,C.elements.push(d))}function W(){if(n===w){var e=new RenderableVertex;return x.push(e),w++,n++,e}return x[n++]}function H(){if(l===S){var e=new RenderableFace;return M.push(e),S++,l++,e}return M[l++]}function X(){if(h===T){var line=new RenderableLine;return A.push(line),T++,h++,line}return A[h++]}function Y(a,b){return a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function Q(e,t){var r=0,n=1,o=e.z+e.w,l=t.z+t.w,c=-e.z+e.w,h=-t.z+t.w;return o>=0&&l>=0&&c>=0&&h>=0||!(o<0&&l<0||c<0&&h<0)&&(o<0?r=Math.max(r,o/(o-l)):l<0&&(n=Math.min(n,o/(o-l))),c<0?r=Math.max(r,c/(c-h)):h<0&&(n=Math.min(n,c/(c-h))),!(n<r)&&(e.lerp(t,r),t.lerp(e,1-n),!0))}this.projectScene=function(e,r,d,v){l=0,h=0,f=0,C.elements.length=0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===r.parent&&r.updateMatrixWorld(),R.copy(r.matrixWorldInverse),O.multiplyMatrices(r.projectionMatrix,R),U.setFromMatrix(O),t=0,C.objects.length=0,C.lights.length=0,function e(object){if(!1!==object.visible){if(object instanceof Light)C.lights.push(object);else if(object instanceof Mesh||object instanceof Line||object instanceof Points){if(!1===object.material.visible)return;if(!0===object.frustumCulled&&!1===U.intersectsObject(object))return;z(object)}else if(object instanceof Sprite){if(!1===object.material.visible)return;if(!0===object.frustumCulled&&!1===U.intersectsSprite(object))return;z(object)}for(var t=object.children,i=0,r=t.length;i<r;i++)e(t[i])}}(e),!0===d&&C.objects.sort(Y);for(var y=C.objects,w=0,ol=y.length;w<ol;w++){var object=y[w].object,M=object.geometry;if(G.setObject(object),m=object.matrixWorld,n=0,object instanceof Mesh){if(M instanceof BufferGeometry){var S=object.material,A=Array.isArray(S),T=M.attributes,_=M.groups;if(void 0===T.position)continue;for(var i=0,L=(Ce=T.position.array).length;i<L;i+=3){var E=Ce[i],D=Ce[i+1],F=Ce[i+2];if(!0===S.morphTargets)for(var K=M.morphAttributes.position,J=object.morphTargetInfluences,Z=0,$=K.length;Z<$;Z++){if(0!==(ue=J[Z]))E+=((he=K[Z]).getX(i/3)-Ce[i])*ue,D+=(he.getY(i/3)-Ce[i+1])*ue,F+=(he.getZ(i/3)-Ce[i+2])*ue}G.pushVertex(E,D,F)}if(void 0!==T.normal){var ee=T.normal.array;for(i=0,L=ee.length;i<L;i+=3)G.pushNormal(ee[i],ee[i+1],ee[i+2])}if(void 0!==T.color)for(i=0,L=(_e=T.color.array).length;i<L;i+=3)G.pushColor(_e[i],_e[i+1],_e[i+2]);if(void 0!==T.uv){var te=T.uv.array;for(i=0,L=te.length;i<L;i+=2)G.pushUv(te[i],te[i+1])}if(null!==M.index){var re=M.index.array;if(_.length>0)for(var g=0;g<_.length;g++){var ie=_[g];if(void 0!==(S=!0===A?object.material[ie.materialIndex]:object.material))for(i=ie.start,L=ie.start+ie.count;i<L;i+=3)G.pushTriangle(re[i],re[i+1],re[i+2],S)}else for(i=0,L=re.length;i<L;i+=3)G.pushTriangle(re[i],re[i+1],re[i+2],S)}else if(_.length>0)for(g=0;g<_.length;g++){ie=_[g];if(void 0!==(S=!0===A?object.material[ie.materialIndex]:object.material))for(i=ie.start,L=ie.start+ie.count;i<L;i+=3)G.pushTriangle(i,i+1,i+2,S)}else for(i=0,L=Ce.length/3;i<L;i+=3)G.pushTriangle(i,i+1,i+2,S)}else if(M instanceof Geometry){var ne=M.vertices,ae=M.faces,oe=M.faceVertexUvs[0];I.getNormalMatrix(m);S=object.material,A=Array.isArray(S);for(var se=0,le=ne.length;se<le;se++){var ce=ne[se];if(N.copy(ce),!0===S.morphTargets)for(K=M.morphTargets,J=object.morphTargetInfluences,Z=0,$=K.length;Z<$;Z++){var ue;if(0!==(ue=J[Z])){var he,de=(he=K[Z]).vertices[se];N.x+=(de.x-ce.x)*ue,N.y+=(de.y-ce.y)*ue,N.z+=(de.z-ce.z)*ue}}G.pushVertex(N.x,N.y,N.z)}for(var pe=0,fe=ae.length;pe<fe;pe++){var me=ae[pe];if(void 0!==(S=!0===A?object.material[me.materialIndex]:object.material)){var ve=S.side,ge=x[me.a],ye=x[me.b],xe=x[me.c];if(!1!==G.checkTriangleVisibility(ge,ye,xe)){var be=G.checkBackfaceCulling(ge,ye,xe);if(ve!==DoubleSide){if(ve===FrontSide&&!1===be)continue;if(ve===BackSide&&!0===be)continue}(o=H()).id=object.id,o.v1.copy(ge),o.v2.copy(ye),o.v3.copy(xe),o.normalModel.copy(me.normal),!1!==be||ve!==BackSide&&ve!==DoubleSide||o.normalModel.negate(),o.normalModel.applyMatrix3(I).normalize();for(var we=me.vertexNormals,Me=0,Se=Math.min(we.length,3);Me<Se;Me++){var Ae=o.vertexNormalsModel[Me];Ae.copy(we[Me]),!1!==be||ve!==BackSide&&ve!==DoubleSide||Ae.negate(),Ae.applyMatrix3(I).normalize()}o.vertexNormalsLength=we.length;var Te=oe[pe];if(void 0!==Te)for(var u=0;u<3;u++)o.uvs[u].copy(Te[u]);o.color=me.color,o.material=S,o.z=(ge.positionScreen.z+ye.positionScreen.z+xe.positionScreen.z)/3,o.renderOrder=object.renderOrder,C.elements.push(o)}}}}}else if(object instanceof Line){if(B.multiplyMatrices(O,m),M instanceof BufferGeometry){if(void 0!==(T=M.attributes).position){for(i=0,L=(Ce=T.position.array).length;i<L;i+=3)G.pushVertex(Ce[i],Ce[i+1],Ce[i+2]);if(void 0!==T.color){var _e;for(i=0,L=(_e=T.color.array).length;i<L;i+=3)G.pushColor(_e[i],_e[i+1],_e[i+2])}if(null!==M.index)for(i=0,L=(re=M.index.array).length;i<L;i+=2)G.pushLine(re[i],re[i+1]);else{var Le=object instanceof LineSegments?2:1;for(i=0,L=Ce.length/3-1;i<L;i+=Le)G.pushLine(i,i+1)}}}else if(M instanceof Geometry){if(0===(ne=object.geometry.vertices).length)continue;(ge=W()).positionScreen.copy(ne[0]).applyMatrix4(B);for(Le=object instanceof LineSegments?2:1,se=1,le=ne.length;se<le;se++)(ge=W()).positionScreen.copy(ne[se]).applyMatrix4(B),(se+1)%Le>0||(ye=x[n-2],V.copy(ge.positionScreen),k.copy(ye.positionScreen),!0===Q(V,k)&&(V.multiplyScalar(1/V.w),k.multiplyScalar(1/k.w),(c=X()).id=object.id,c.v1.positionScreen.copy(V),c.v2.positionScreen.copy(k),c.z=Math.max(V.z,k.z),c.renderOrder=object.renderOrder,c.material=object.material,object.material.vertexColors===VertexColors&&(c.vertexColors[0].copy(object.geometry.colors[se]),c.vertexColors[1].copy(object.geometry.colors[se-1])),C.elements.push(c)))}}else if(object instanceof Points){if(B.multiplyMatrices(O,m),M instanceof Geometry)for(se=0,le=(ne=object.geometry.vertices).length;se<le;se++){ce=ne[se];P.set(ce.x,ce.y,ce.z,1),P.applyMatrix4(B),j(P,object,r)}else if(M instanceof BufferGeometry){if(void 0!==(T=M.attributes).position){var Ce;for(i=0,L=(Ce=T.position.array).length;i<L;i+=3)P.set(Ce[i],Ce[i+1],Ce[i+2],1),P.applyMatrix4(B),j(P,object,r)}}}else object instanceof Sprite&&(object.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,object.matrixWorld),P.set(m.elements[12],m.elements[13],m.elements[14],1),P.applyMatrix4(O),j(P,object,r))}return!0===v&&C.elements.sort(Y),C}},RaytracingRenderer=function(e){console.log("RaytracingRenderer",REVISION),e=e||{};var t,r,n=this,o=[],l=!1,canvas=document.createElement("canvas"),c=canvas.getContext("2d",{alpha:!0===e.alpha}),h=new Color(0);this.domElement=canvas,this.autoClear=!0;var d=e.workers,f=e.blockSize||64;this.randomize=e.randomize;var m,v,y,x=[],w=0,M=0;function S(e){e.postMessage({init:[t,r],worker:e.id,blockSize:f})}function A(e){if(!x.length)return l=!1,n.dispatchEvent({type:"complete"});var t=x.pop(),r=t%v*f,o=(t/v|0)*f;e.postMessage({render:!0,x:r,y:o,sceneId:M}),c.fillStyle="#"+e.color,c.fillRect(r,o,f,f)}console.log("%cSpinning off "+d+" Workers ","font-size: 20px; background: black; color: white; font-family: monospace;"),this.setWorkers=function(t){for(d=t||navigator.hardwareConcurrency||4;o.length<d;){var r=new Worker(e.workerPath);r.id=w++,r.onmessage=function(e){var data=e.data;if(data&&data.blockSize&&M==data.sceneId){var t=new ImageData(new Uint8ClampedArray(data.data),data.blockSize,data.blockSize);if(c.putImageData(t,data.blockX,data.blockY),console.log("Worker "+this.id,data.time/1e3,(Date.now()-L)/1e3+" s"),o.length>d)return o.splice(o.indexOf(this),1),this.terminate();A(this)}},r.color=(new Color).setHSL(Math.random(),.8,.8).getHexString(),o.push(r),S(r),l&&(r.postMessage({scene:T,camera:_,annex:C,sceneId:M}),A(r))}if(!l)for(;o.length>d;)o.pop().terminate()},this.setWorkers(d),this.setClearColor=function(e){h.set(e)},this.setPixelRatio=function(){},this.setSize=function(e,n){canvas.width=e,canvas.height=n,t=canvas.width,r=canvas.height,c.fillStyle="white",o.forEach(S)},this.setSize(canvas.width,canvas.height),this.clear=function(){};var T,_,L,C={},N={mirror:1,reflectivity:1,refractionRatio:1,glass:1};function P(e){var t=e.material;if(t&&!(t.uuid in C)){var r={};for(var n in N)void 0!==t[n]&&(r[n]=t[n]);C[t.uuid]=r}}this.render=function(e,h){l=!0,!0===e.autoUpdate&&e.updateMatrixWorld(),null===h.parent&&h.updateMatrixWorld(),T=e.toJSON(),_=h.toJSON(),++M,e.traverse(P),o.forEach((function(e){e.postMessage({scene:T,camera:_,annex:C,sceneId:M})})),c.clearRect(0,0,t,r),L=Date.now(),v=Math.ceil(t/f),y=Math.ceil(r/f),m=v*y,x=[];for(var i=0;i<m;i++)x.push(i);if(n.randomize)for(i=0;i<m;i++){var d=Math.random()*m|0,w=x[d];x[d]=x[i],x[i]=w}o.forEach(A)}};Object.assign(RaytracingRenderer.prototype,EventDispatcher.prototype);var SoftwareRenderer=function(e){console.log("SoftwareRenderer",REVISION);var t,r,n,o,l,c,h,d,f,m,v,data,y,x,w,M,canvas=void 0!==(e=e||{}).canvas?e.canvas:document.createElement("canvas"),S=canvas.getContext("2d",{alpha:!0===e.alpha}),A={},T={},_=new Color(0),L=!0===e.alpha?0:1,C=1,N=2,P=4,E=(1<<P)-1,D=3,F=1<<D,R=1<<24,O=!1,B=new Vector3(0,0,1),I=new Vector3,U=1/0,V=1/0,k=0,G=0,z=1/0,j=1/0,W=0,H=0,X=new Projector,Y=new Vector4,Q=new Vector4,K=new Vector4,J=new Vector2,Z=new Vector2,$=new Vector2,ee=[],te=0,re=[],ie=0,ne=[],ae=0,oe=this;function se(){return!0===e.alpha?L:1}function le(e){for(var n=t*r*4,i=0;i<n;i+=4)data[i]=255*e.r|0,data[i+1]=255*e.g|0,data[i+2]=255*e.b|0,data[i+3]=255*se()|0;S.fillStyle="rgba("+(255*_.r|0)+","+(255*_.g|0)+","+(255*_.b|0)+","+se()+")",S.fillRect(0,0,t,r)}function ce(e,t){var i=0,r=0,n=255*e.color.r,o=255*e.color.g,l=255*e.color.b,c=new Uint8Array(768);if(t){for(;i<204;)c[r++]=Math.min(i*n/204,255),c[r++]=Math.min(i*o/204,255),c[r++]=Math.min(i*l/204,255),++i;for(;i<256;)c[r++]=Math.min(n+(i-204)*(255-n)/82,255),c[r++]=Math.min(o+(i-204)*(255-o)/82,255),c[r++]=Math.min(l+(i-204)*(255-l)/82,255),++i}else for(;i<256;)c[r++]=Math.min(i*n/255,255),c[r++]=Math.min(i*o/255,255),c[r++]=Math.min(i*l/255,255),++i;return c}function ue(e,t,r,n,u,o,l,c,h){var d=4*r,f=T[h.map.id];if(f.data){var m=f.width,v=h.transparent,y=m-1,x=f.data,w=4*((o*m&y)*m+(u*m&y));if(v){var M=x[w],S=x[w+1],A=x[w+2],_=x[w+3]*h.opacity/255,L=e[d],C=e[d+1],N=e[d+2];e[d]=M*_+L*(1-_),e[d+1]=S*_+C*(1-_),e[d+2]=A*_+N*(1-_),e[d+3]=(h.opacity<<8)-1,255==e[d+3]&&(t[r]=n)}else e[d]=x[w],e[d+1]=x[w+1],e[d+2]=x[w+2],e[d+3]=(h.opacity<<8)-1,t[r]=n}}function he(e,t,r,n,u,o,l,c,h){var d=4*r,f=T[h.map.id];if(f.data){var m=f.width,v=h.transparent,y=3*(l>0?~~l:0),x=m-1,w=f.data,M=4*((o*m&x)*m+(u*m&x));if(v){var S=h.palette[y]*w[M],A=h.palette[y+1]*w[M+1],_=h.palette[y+2]*w[M+2],L=w[M+3]*h.opacity/256,C=e[d],N=e[d+1],P=e[d+2];e[d]=S*L+C*(1-L),e[d+1]=A*L+N*(1-L),e[d+2]=_*L+P*(1-L),e[d+3]=(h.opacity<<8)-1,255==e[d+3]&&(t[r]=n)}else e[d]=h.palette[y]*w[M]>>8,e[d+1]=h.palette[y+1]*w[M+1]>>8,e[d+2]=h.palette[y+2]*w[M+2]>>8,e[d+3]=(h.opacity<<8)-1,t[r]=n}}function de(e){var t=e.id,r=A[t];if(r&&e.map&&!T[e.map.id]&&delete A[t],void 0===A[t]||!0===e.needsUpdate){if(e instanceof MeshBasicMaterial||e instanceof MeshLambertMaterial||e instanceof MeshPhongMaterial||e instanceof SpriteMaterial)if(e instanceof MeshLambertMaterial?e.palette||(e.palette=ce(e,!1)):e instanceof MeshPhongMaterial&&(e.palette||(e.palette=ce(e,!0))),e.map){var n=new SoftwareRenderer.Texture;if(n.fromImage(e.map.image),!n.data)return;T[e.map.id]=n,r=e instanceof MeshBasicMaterial||e instanceof SpriteMaterial?ue:he}else o=e.vertexColors===FaceColors||e.vertexColors===VertexColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),r=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",o);else if(e instanceof LineBasicMaterial){var o=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * (color1.r+color2.r) * 0.5 * 255;","buffer[ colorOffset + 1 ] = material.color.g * (color1.g+color2.g) * 0.5 * 255;","buffer[ colorOffset + 2 ] = material.color.b * (color1.b+color2.b) * 0.5 * 255;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");r=new Function("buffer, depthBuf, offset, depth, color1, color2, material",o)}else{o=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");r=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",o)}A[t]=r,e.needsUpdate=!1}return r}function pe(e,o,v,x,S,A,T,_,L){if(!(e.z<-1||e.z>1||o.z<-1||o.z>1||v.z<-1||v.z>1)){var R=1<<P,O=e.x*l+d|0,B=o.x*l+d|0,I=v.x*l+d|0,z=e.y*c+f|0,j=o.y*c+f|0,W=v.y*c+f|0,H=_.vertexNormalsModel&&_.vertexNormalsModel.length,X=x&&S&&A,Y=Math.max(Math.sqrt((O-B)*(O-B)+(z-j)*(z-j)),Math.sqrt((B-I)*(B-I)+(j-W)*(j-W)),Math.sqrt((I-O)*(I-O)+(W-z)*(W-z)));if(!(_ instanceof RenderableSprite)&&Y>100*R){var Q,K,J,Z,$,oe,se,le,ce,ue,he={vertexNormalsModel:[],color:_.color};if(X)ae===ne.length?(Q=new Vector2,ne.push(Q),++ae,K=new Vector2,ne.push(K),++ae,J=new Vector2,ne.push(J),++ae):(Q=ne[ae],++ae,K=ne[ae],++ae,J=ne[ae],++ae),Z=(1+o.z)*(o.w/e.w)/(1+e.z),Q.copy(x).multiplyScalar(Z).add(S).multiplyScalar(1/(Z+1)),Z=(1+v.z)*(v.w/o.w)/(1+o.z),K.copy(S).multiplyScalar(Z).add(A).multiplyScalar(1/(Z+1)),Z=(1+e.z)*(e.w/v.w)/(1+v.z),J.copy(A).multiplyScalar(Z).add(x).multiplyScalar(1/(Z+1));return te===ee.length?($=new Vector4,ee.push($),++te,oe=new Vector4,ee.push(oe),++te,se=new Vector4,ee.push(se),++te):($=ee[te],++te,oe=ee[te],++te,se=ee[te],++te),$.copy(e).add(o).multiplyScalar(.5),oe.copy(o).add(v).multiplyScalar(.5),se.copy(v).add(e).multiplyScalar(.5),H&&(ie===re.length?(le=new Vector3,re.push(le),++ie,ce=new Vector3,re.push(ce),++ie,ue=new Vector3,re.push(ue),++ie):(le=re[ie],++ie,ce=re[ie],++ie,ue=re[ie],++ie),le.copy(_.vertexNormalsModel[0]).add(_.vertexNormalsModel[1]).normalize(),ce.copy(_.vertexNormalsModel[1]).add(_.vertexNormalsModel[2]).normalize(),ue.copy(_.vertexNormalsModel[2]).add(_.vertexNormalsModel[0]).normalize()),H&&(he.vertexNormalsModel[0]=_.vertexNormalsModel[0],he.vertexNormalsModel[1]=le,he.vertexNormalsModel[2]=ue),pe(e,$,se,x,Q,J,T,he,L),H&&(he.vertexNormalsModel[0]=_.vertexNormalsModel[1],he.vertexNormalsModel[1]=ce,he.vertexNormalsModel[2]=le),pe(o,oe,$,S,K,Q,T,he,L),H&&(he.vertexNormalsModel[0]=le,he.vertexNormalsModel[1]=ce,he.vertexNormalsModel[2]=ue),pe($,oe,se,Q,K,J,T,he,L),H&&(he.vertexNormalsModel[0]=_.vertexNormalsModel[2],he.vertexNormalsModel[1]=ue,he.vertexNormalsModel[2]=ce),void pe(v,se,oe,A,J,K,T,he,L)}var de,fe,ve,ge,ye,xe,be,we,Me,Se,Ae,Te,_e=e.z*h+m|0,Le=o.z*h+m|0,Ce=v.z*h+m|0;X=!1;x&&S&&A&&(X=!0,de=x.x,fe=1-x.y,ve=S.x,ge=1-S.y,ye=A.x,xe=1-A.y),H&&(be=_.vertexNormalsModel[0],we=_.vertexNormalsModel[1],Me=_.vertexNormalsModel[2],Se=255*be.z,Ae=255*we.z,Te=255*Me.z);var Ne=O-B,Pe=j-z,Ee=B-I,De=W-j,Fe=I-O,Re=z-W,Oe=Math.max(Math.min(O,B,I)+E>>P,0),Be=Math.min(Math.max(O,B,I)+E>>P,t),Ie=Math.max(Math.min(z,j,W)+E>>P,0),Ue=Math.min(Math.max(z,j,W)+E>>P,r);U=Math.min(Oe,U),k=Math.max(Be,k),V=Math.min(Ie,V),G=Math.max(Ue,G);var q=F,Ve=(Oe&=~(q-1))<<P,ke=(Ie&=~(q-1))<<P,Ge=Pe*(Ve-O)+Ne*(ke-z),ze=De*(Ve-B)+Ee*(ke-j),je=Re*(Ve-I)+Fe*(ke-W);(Pe>0||0==Pe&&Ne>0)&&Ge++,(De>0||0==De&&Ee>0)&&ze++,(Re>0||0==Re&&Fe>0)&&je++;var We,He,Xe,Ye,qe,Qe=_e-Le,Ke=Ce-_e,Je=1/(Ne*Re-Fe*Pe),Ze=Je*(Qe*Re-Ke*Pe),$e=Je*(Qe*Fe-Ne*Ke),et=_e+(Ve-O)*Ze+(ke-z)*$e|0;if(X){var tt=de-ve,it=ye-de,nt=Je*(tt*Re-it*Pe),at=Je*(tt*Fe-Ne*it),ot=fe-ge,st=xe-fe;Xe=de+(Ve-O)*nt+(ke-z)*at,Ye=fe+(Ve-O)*(We=Je*(ot*Re-st*Pe))+(ke-z)*(He=Je*(ot*Fe-Ne*st)),nt*=R,at*=R,We*=R,He*=R}if(H){var lt,ct=Se-Ae,ut=Te-Se,ht=Je*(ct*Re-ut*Pe);qe=Se+(Ve-O)*ht+(ke-z)*(lt=Je*(ct*Fe-Ne*ut)),ht*=R,lt*=R}var pt=q-1,ft=0,mt=0,vt=0,gt=0,yt=0,xt=0,bt=0,wt=0;Ne>=0?mt-=pt*Ne:ft-=pt*Ne,Pe>=0?mt-=pt*Pe:ft-=pt*Pe,Ee>=0?gt-=pt*Ee:vt-=pt*Ee,De>=0?gt-=pt*De:vt-=pt*De,Fe>=0?xt-=pt*Fe:yt-=pt*Fe,Re>=0?xt-=pt*Re:yt-=pt*Re,(Ze=Ze*R|0)>=0?wt+=pt*Ze:bt+=pt*Ze,($e=$e*R|0)>=0?wt+=pt*$e:bt+=pt*$e;var Mt,St,At,Tt=t-q,_t=Ge=Ge-1>>P,Lt=ze=ze-1>>P,Ct=je=je-1>>P,Nt=et,Pt=-q,Et=Pt*Pe,Dt=Pt*De,Ft=Pt*Re,Rt=Pt*Ze;X&&(Mt=Pt*nt,St=Pt*We),H&&(At=Pt*ht);for(var Ot=Oe,Bt=Ie;Bt<Ue;Bt+=q){for(;Ot>=Oe&&Ot<Be&&_t>=mt&&Lt>=gt&&Ct>=xt;)Ot+=Pt,_t+=Et,Lt+=Dt,Ct+=Ft,Nt+=Rt,X&&(Xe+=Mt,Ye+=St),H&&(qe+=At);for(Pt=-Pt,Et=-Et,Dt=-Dt,Ft=-Ft,Rt=-Rt,X&&(Mt=-Mt,St=-St),H&&(At=-At);_t+=Et,Lt+=Dt,Ct+=Ft,Nt+=Rt,X&&(Xe+=Mt,Ye+=St),H&&(qe+=At),!((Ot+=Pt)<Oe||Ot>=Be);)if(_t<mt){if(Et<0)break}else if(Lt<gt){if(Dt<0)break}else if(Ct<xt){if(Ft<0)break}else{var It=Ot>>D,Ut=Bt>>D,Vt=It+Ut*n,kt=Nt+bt;if(!(w[Vt]<kt)){var Gt=M[Vt];Gt&N&&me(It,Ut),M[Vt]=Gt&~(C|N);var zt=Ot+Bt*t;if(_t>=ft&&Lt>=vt&&Ct>=yt){var jt=Nt+wt;w[Vt]=Math.min(w[Vt],jt);var Wt=_t,Ht=Lt,Xt=Nt;X&&(Zt=Xe,$t=Ye),H&&(er=qe);for(var Yt=0;Yt<q;Yt++){var qt=Wt,Qt=Ht,Kt=Xt;X&&(ir=Zt,nr=$t),H&&(ar=er);for(var Jt=0;Jt<q;Jt++){(sr=Kt)<y[zt]&&T(data,y,zt,sr,ir,nr,ar,_,L),qt+=Pe,Qt+=De,Kt+=Ze,X&&(ir+=nt,nr+=We),H&&(ar+=ht),zt++}Wt+=Ne,Ht+=Ee,Xt+=$e,X&&(Zt+=at,$t+=He),H&&(er+=lt),zt+=Tt}}else{Wt=_t,Ht=Lt;var Zt,$t,er,rr=Ct;Xt=Nt;X&&(Zt=Xe,$t=Ye),H&&(er=qe);for(Yt=0;Yt<q;Yt++){qt=Wt,Qt=Ht;var ir,nr,ar,or=rr;Kt=Xt;X&&(ir=Zt,nr=$t),H&&(ar=er);for(Jt=0;Jt<q;Jt++){var sr;if((qt|Qt|or)>=0)(sr=Kt)<y[zt]&&T(data,y,zt,sr,ir,nr,ar,_,L);qt+=Pe,Qt+=De,or+=Re,Kt+=Ze,X&&(ir+=nt,nr+=We),H&&(ar+=ht),zt++}Wt+=Ne,Ht+=Ee,rr+=Fe,Xt+=$e,X&&(Zt+=at,$t+=He),H&&(er+=lt),zt+=Tt}}}}_t+=q*Ne,Lt+=q*Ee,Ct+=q*Fe,Nt+=q*$e,X&&(Xe+=q*at,Ye+=q*He),H&&(qe+=q*lt)}}}function fe(e,o,v,x,S,A){if(O||(O=!0,F=1<<(D=0),oe.setSize(canvas.width,canvas.height)),!(e.z<-1||e.z>1||o.z<-1||o.z>1)){var T=Math.floor(.5*(A.linewidth-1)),_=e.x*l+d|0,L=o.x*l+d|0,R=e.y*c+f|0,z=o.y*c+f|0,j=e.z*h+m|0,W=o.z*h+m|0,H=_-L,X=R-z,Y=j-W,Q=Math.max(Math.min(_,L)+E>>P,0),K=Math.min(Math.max(_,L)+E>>P,t),J=Math.max(Math.min(R,z)+E>>P,0),Z=Math.min(Math.max(R,z)+E>>P,r),$=Math.max(Math.min(j,W)+E>>P,0),ee=Math.max(j,W)+E>>P;U=Math.min(Q,U),k=Math.max(K,k),V=Math.min(J,V),G=Math.max(Z,G);var te,re,ie,ne,ae,se=Math.sqrt(X*X+H*H),le=H/se,ce=X/se,ue=Y/se;for(I.set(le,ce,ue),I.cross(B),I.normalize();se>0;){te=(te=L+se*le)+E>>P,re=(re=z+se*ce)+E>>P,ae=W+se*ue+E>>P;for(var i=-T;i<=T;++i)if(ie=Math.floor(te+I.x*i),ne=Math.floor(re+I.y*i),!(U>=ie||k<=ie||V>=ne||G<=ne)){var he=ie>>D,de=ne>>D,pe=he+de*n;if(!(w[pe]<$)){w[pe]=Math.min(w[pe],ee);var fe=M[pe];fe&N&&me(he,de),M[pe]=fe&~(C|N);var ve=ie+ne*t;ae<y[ve]&&S(data,y,ve,ae,v,x,A)}}--se}}}function me(e,r){for(var n=e*F+r*F*t,o=4*n,l=t-F,c=4*l,h=0;h<F;h++){for(var d=0;d<F;d++)y[n++]=R,data[o++]=255*_.r|0,data[o++]=255*_.g|0,data[o++]=255*_.b|0,data[o++]=255*se()|0;n+=l,o+=c}}this.domElement=canvas,this.autoClear=!0,this.setClearColor=function(e,t){_.set(e),L=t,le(_)},this.setPixelRatio=function(){},this.setSize=function(e,A){n=Math.floor(e/F),o=Math.floor(A/F);var T=1<<P;l=T*(t=n*F)/2,c=-T*(r=o*F)/2,h=R/2,d=T*t/2+.5,f=T*r/2+.5,m=R/2+.5,canvas.width=t,canvas.height=r,v=S.getImageData(0,0,t,r),data=v.data,y=new Int32Array(data.length/4),x=n*o,w=new Int32Array(x),M=new Uint8Array(x);for(var i=0,L=y.length;i<L;i++)y[i]=R;for(i=0;i<x;i++)M[i]=C;le(_)},this.clear=function(){U=1/0,V=1/0,k=0,G=0,te=0,ie=0,ae=0;for(var i=0;i<x;i++)w[i]=R,M[i]=M[i]&C?C:N},this.render=function(e,t){this.clear();var r=e.background;r&&r.isColor&&le(r);for(var l=X.projectScene(e,t,!1,!1).elements,c=0,h=l.length;c<h;c++){var element=l[c],d=element.material;if(y=de(d))if(element instanceof RenderableFace)element.uvs?pe(element.v1.positionScreen,element.v2.positionScreen,element.v3.positionScreen,element.uvs[0],element.uvs[1],element.uvs[2],y,element,d):pe(element.v1.positionScreen,element.v2.positionScreen,element.v3.positionScreen,null,null,null,y,element,d);else if(element instanceof RenderableSprite){var f=.5*element.scale.x,m=.5*element.scale.y;Y.copy(element),Y.x-=f,Y.y+=m,Q.copy(element),Q.x-=f,Q.y-=m,K.copy(element),K.x+=f,K.y+=m,d.map?(J.set(0,1),Z.set(0,0),$.set(1,1),pe(Y,Q,K,J,Z,$,y,element,d)):pe(Y,Q,K,null,null,null,y,element,d),Y.copy(element),Y.x+=f,Y.y+=m,Q.copy(element),Q.x-=f,Q.y-=m,K.copy(element),K.x+=f,K.y-=m,d.map?(J.set(1,1),Z.set(0,0),$.set(1,0),pe(Y,Q,K,J,Z,$,y,element,d)):pe(Y,Q,K,null,null,null,y,element,d)}else if(element instanceof RenderableLine){var y=de(d);fe(element.v1.positionScreen,element.v2.positionScreen,element.vertexColors[0],element.vertexColors[1],y,d)}}!function(){for(var e=0,t=0;t<o;t++)for(var r=0;r<n;r++)M[e]&N&&(me(r,t),M[e]=C),e++}();var x=Math.min(U,z),w=Math.min(V,j),A=Math.max(k,W)-x,T=Math.max(G,H)-w;x!==1/0&&S.putImageData(v,0,0,x,w,A,T),z=U,j=V,W=k,H=G}};SoftwareRenderer.Texture=function(){var canvas;this.fromImage=function(image){if(!(!image||image.width<=0||image.height<=0)){void 0===canvas&&(canvas=document.createElement("canvas"));var e=image.width>image.height?image.width:image.height;e=_Math.ceilPowerOfTwo(e),canvas.width==e&&canvas.height==e||(canvas.width=e,canvas.height=e);var t=canvas.getContext("2d");t.clearRect(0,0,e,e),t.drawImage(image,0,0,e,e);var r=t.getImageData(0,0,e,e);this.data=r.data,this.width=e,this.height=e,this.srcUrl=image.src}}};var SVGObject=function(e){Object3D.call(this),this.node=e};SVGObject.prototype=Object.create(Object3D.prototype),SVGObject.prototype.constructor=SVGObject;var SVGRenderer=function(){console.log("SVGRenderer",REVISION);var e,t,r,n,o,l,c,h,d,f,m,v,y,x=this,w=new Projector,M=document.createElementNS("http://www.w3.org/2000/svg","svg"),S=new Box2,A=new Box2,T=new Color,_=new Color,L=new Color,C=new Color,N=new Color,P=new Color,E=1,D=new Vector3,F=new Vector3,R=new Vector3,O=new Matrix3,B=new Matrix4,I=new Matrix4,U=[],V=0,k=1,G=null;function z(){for(V=0;M.childNodes.length>0;)M.removeChild(M.childNodes[0])}function j(e,t){var r=Math.floor(255*e.r)+","+Math.floor(255*e.g)+","+Math.floor(255*e.b);return void 0===t||1===t?"rgb("+r+")":"rgb("+r+"); fill-opacity: "+t}function W(e){return null!==G?e.toFixed(G):e}function H(e,element,t){var r=element.scale.x*l,n=element.scale.y*c;t.isPointsMaterial&&(r*=t.size,n*=t.size);var path="M"+W(e.x-.5*r)+","+W(e.y-.5*n)+"h"+W(r)+"v"+W(n)+"h"+W(-r)+"z",style="";(t.isSpriteMaterial||t.isPointsMaterial)&&(style="fill:"+j(t.color,t.opacity)),Q(style,path)}function X(e,t,element,r){var path="M"+W(e.positionScreen.x)+","+W(e.positionScreen.y)+"L"+W(t.positionScreen.x)+","+W(t.positionScreen.y);if(r.isLineBasicMaterial){var style="fill:none;stroke:"+j(r.color,r.opacity)+";stroke-width:"+r.linewidth+";stroke-linecap:"+r.linecap;r.isLineDashedMaterial&&(style=style+";stroke-dasharray:"+r.dashSize+","+r.gapSize),Q(style,path)}}function Y(e,t,n,element,o){x.info.render.vertices+=3,x.info.render.faces++;var path="M"+W(e.positionScreen.x)+","+W(e.positionScreen.y)+"L"+W(t.positionScreen.x)+","+W(t.positionScreen.y)+"L"+W(n.positionScreen.x)+","+W(n.positionScreen.y)+"z";o.isMeshBasicMaterial?(T.copy(o.color),o.vertexColors!==FaceColors&&o.vertexColors!==VertexColors||T.multiply(element.color)):o.isMeshLambertMaterial||o.isMeshPhongMaterial||o.isMeshStandardMaterial?(_.copy(o.color),o.vertexColors!==FaceColors&&o.vertexColors!==VertexColors||_.multiply(element.color),T.copy(L),F.copy(e.positionWorld).add(t.positionWorld).add(n.positionWorld).divideScalar(3),function(e,t,r,n){for(var o=0,l=e.length;o<l;o++){var c=e[o],h=c.color;if(c.isDirectionalLight){var d=D.setFromMatrixPosition(c.matrixWorld).normalize();if((f=r.dot(d))<=0)continue;f*=c.intensity,n.r+=h.r*f,n.g+=h.g*f,n.b+=h.b*f}else if(c.isPointLight){var f;d=D.setFromMatrixPosition(c.matrixWorld);if((f=r.dot(D.subVectors(d,t).normalize()))<=0)continue;if(0==(f*=0==c.distance?1:1-Math.min(t.distanceTo(d)/c.distance,1)))continue;f*=c.intensity,n.r+=h.r*f,n.g+=h.g*f,n.b+=h.b*f}}}(r,F,element.normalModel,T),T.multiply(_).add(o.emissive)):o.isMeshNormalMaterial&&(R.copy(element.normalModel).applyMatrix3(O),T.setRGB(R.x,R.y,R.z).multiplyScalar(.5).addScalar(.5)),Q(o.wireframe?"fill:none;stroke:"+j(T,o.opacity)+";stroke-width:"+o.wireframeLinewidth+";stroke-linecap:"+o.wireframeLinecap+";stroke-linejoin:"+o.wireframeLinejoin:"fill:"+j(T,o.opacity),path)}function Q(style,path){y===style?v+=path:(K(),y=style,v=path)}function K(){v&&((m=function(e){if(null==U[e])return U[e]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==k&&U[e].setAttribute("shape-rendering","crispEdges"),U[e];return U[e]}(V++)).setAttribute("d",v),m.setAttribute("style",y),M.appendChild(m)),v="",y=""}this.domElement=M,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":k=1;break;case"low":k=0}},this.setClearColor=function(e,t){P.set(e),E=void 0!==t?t:1},this.setPixelRatio=function(){},this.setSize=function(e,t){l=(n=e)/2,c=(o=t)/2,M.setAttribute("viewBox",-l+" "+-c+" "+n+" "+o),M.setAttribute("width",n),M.setAttribute("height",o),S.min.set(-l,-c),S.max.set(l,c)},this.setPrecision=function(e){G=e},this.clear=function(){z(),M.style.backgroundColor=j(P,E)},this.render=function(n,o){if(o instanceof Camera!=!1){var m=n.background;m&&m.isColor?(z(),M.style.backgroundColor=j(m)):!0===this.autoClear&&this.clear(),x.info.render.vertices=0,x.info.render.faces=0,B.copy(o.matrixWorldInverse),I.multiplyMatrices(o.projectionMatrix,B),e=w.projectScene(n,o,this.sortObjects,this.sortElements),t=e.elements,r=e.lights,O.getNormalMatrix(o.matrixWorldInverse),function(e){L.setRGB(0,0,0),C.setRGB(0,0,0),N.setRGB(0,0,0);for(var t=0,r=e.length;t<r;t++){var n=e[t],o=n.color;n.isAmbientLight?(L.r+=o.r,L.g+=o.g,L.b+=o.b):n.isDirectionalLight?(C.r+=o.r,C.g+=o.g,C.b+=o.b):n.isPointLight&&(N.r+=o.r,N.g+=o.g,N.b+=o.b)}}(r),v="",y="";for(var T=0,_=t.length;T<_;T++){var element=t[T],P=element.material;if(void 0!==P&&0!==P.opacity)if(A.makeEmpty(),element instanceof RenderableSprite)(h=element).x*=l,h.y*=-c,H(h,element,P);else if(element instanceof RenderableLine)h=element.v1,d=element.v2,h.positionScreen.x*=l,h.positionScreen.y*=-c,d.positionScreen.x*=l,d.positionScreen.y*=-c,A.setFromPoints([h.positionScreen,d.positionScreen]),!0===S.intersectsBox(A)&&X(h,d,element,P);else if(element instanceof RenderableFace){if(h=element.v1,d=element.v2,f=element.v3,h.positionScreen.z<-1||h.positionScreen.z>1)continue;if(d.positionScreen.z<-1||d.positionScreen.z>1)continue;if(f.positionScreen.z<-1||f.positionScreen.z>1)continue;h.positionScreen.x*=l,h.positionScreen.y*=-c,d.positionScreen.x*=l,d.positionScreen.y*=-c,f.positionScreen.x*=l,f.positionScreen.y*=-c,A.setFromPoints([h.positionScreen,d.positionScreen,f.positionScreen]),!0===S.intersectsBox(A)&&Y(h,d,f,element,P)}}K(),n.traverseVisible((function(object){if(object instanceof SVGObject){if(D.setFromMatrixPosition(object.matrixWorld),D.applyMatrix4(I),D.z<-1||D.z>1)return;var e=D.x*l,t=-D.y*c,r=object.node;r.setAttribute("transform","translate("+e+","+t+")"),M.appendChild(r)}}))}else console.error("SVGRenderer.render: camera is not an instance of Camera.")}};function WebGLAnimation(){var e=null,t=!1,r=null;function n(time,o){!1!==t&&(r(time,o),e.requestAnimationFrame(n))}return{start:function(){!0!==t&&null!==r&&(e.requestAnimationFrame(n),t=!0)},stop:function(){t=!1},setAnimationLoop:function(e){r=e},setContext:function(t){e=t}}}function WebGLAttributes(e){var t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(r){r.isInterleavedBufferAttribute&&(r=r.data);var data=t.get(r);data&&(e.deleteBuffer(data.buffer),t.delete(r))},update:function(r,n){r.isInterleavedBufferAttribute&&(r=r.data);var data=t.get(r);void 0===data?t.set(r,function(t,r){var n=t.array,o=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,l=e.createBuffer();e.bindBuffer(r,l),e.bufferData(r,n,o),t.onUploadCallback();var c=e.FLOAT;return n instanceof Float32Array?c=e.FLOAT:n instanceof Float64Array?console.warn("WebGLAttributes: Unsupported data buffer format: Float64Array."):n instanceof Uint16Array?c=e.UNSIGNED_SHORT:n instanceof Int16Array?c=e.SHORT:n instanceof Uint32Array?c=e.UNSIGNED_INT:n instanceof Int32Array?c=e.INT:n instanceof Int8Array?c=e.BYTE:n instanceof Uint8Array&&(c=e.UNSIGNED_BYTE),{buffer:l,type:c,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version}}(r,n)):data.version<r.version&&(!function(t,r,n){var o=r.array,l=r.updateRange;e.bindBuffer(n,t),!1===r.dynamic?e.bufferData(n,o,e.STATIC_DRAW):-1===l.count?e.bufferSubData(n,0,o):0===l.count?console.error("WebGLObjects.updateBuffer: dynamic BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(n,l.offset*o.BYTES_PER_ELEMENT,o.subarray(l.offset,l.offset+l.count)),l.count=-1)}(data.buffer,r,n),data.version=r.version)}}}function WebGLBackground(e,t,r,n){var o,l,c=new Color(0),h=0,d=null,f=0;function m(e,r){t.buffers.color.setClear(e.r,e.g,e.b,r,n)}return{getClearColor:function(){return c},setClearColor:function(e,t){c.set(e),m(c,h=void 0!==t?t:1)},getClearAlpha:function(){return h},setClearAlpha:function(e){m(c,h=e)},render:function(t,n,v,y){var x=n.background;if(null===x?(m(c,h),d=null,f=0):x&&x.isColor&&(m(x,1),y=!0,d=null,f=0),(e.autoClear||y)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),x&&(x.isCubeTexture||x.isWebGLRenderTargetCube)){void 0===l&&((l=new Mesh(new BoxBufferGeometry(1,1,1),new ShaderMaterial({type:"BackgroundCubeMaterial",uniforms:cloneUniforms(ShaderLib.cube.uniforms),vertexShader:ShaderLib.cube.vertexShader,fragmentShader:ShaderLib.cube.fragmentShader,side:BackSide,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),l.geometry.removeAttribute("uv"),l.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.tCube.value}}),r.update(l));var w=x.isWebGLRenderTargetCube?x.texture:x;l.material.uniforms.tCube.value=w,l.material.uniforms.tFlip.value=x.isWebGLRenderTargetCube?1:-1,d===x&&f===w.version||(l.material.needsUpdate=!0,d=x,f=w.version),t.unshift(l,l.geometry,l.material,0,0,null)}else x&&x.isTexture&&(void 0===o&&((o=new Mesh(new PlaneBufferGeometry(2,2),new ShaderMaterial({type:"BackgroundMaterial",uniforms:cloneUniforms(ShaderLib.background.uniforms),vertexShader:ShaderLib.background.vertexShader,fragmentShader:ShaderLib.background.fragmentShader,side:FrontSide,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),Object.defineProperty(o.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(o)),o.material.uniforms.t2D.value=x,!0===x.matrixAutoUpdate&&x.updateMatrix(),o.material.uniforms.uvTransform.value.copy(x.matrix),d===x&&f===x.version||(o.material.needsUpdate=!0,d=x,f=x.version),t.unshift(o,o.geometry,o.material,0,0,null))}}}function WebGLBufferRenderer(e,t,r,n){var o;this.setMode=function(e){o=e},this.render=function(t,n){e.drawArrays(o,t,n),r.update(n,o)},this.renderInstances=function(l,c,h){var d;if(n.isWebGL2)d=e;else if(null===(d=t.get("ANGLE_instanced_arrays")))return void console.error("WebGLBufferRenderer: using InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");d[n.isWebGL2?"drawArraysInstanced":"drawArraysInstancedANGLE"](o,c,h,l.maxInstancedCount),r.update(h,o,l.maxInstancedCount)}}function WebGLCapabilities(e,t,r){var n;function o(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var l="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext,c=void 0!==r.precision?r.precision:"highp",h=o(c);h!==c&&(console.warn("WebGLRenderer:",c,"not supported, using",h,"instead."),c=h);var d=!0===r.logarithmicDepthBuffer,f=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),m=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),v=e.getParameter(e.MAX_TEXTURE_SIZE),y=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),x=e.getParameter(e.MAX_VERTEX_ATTRIBS),w=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),M=e.getParameter(e.MAX_VARYING_VECTORS),S=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),A=m>0,T=l||!!t.get("OES_texture_float");return{isWebGL2:l,getMaxAnisotropy:function(){if(void 0!==n)return n;var r=t.get("EXT_texture_filter_anisotropic");return n=null!==r?e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:o,precision:c,logarithmicDepthBuffer:d,maxTextures:f,maxVertexTextures:m,maxTextureSize:v,maxCubemapSize:y,maxAttributes:x,maxVertexUniforms:w,maxVaryings:M,maxFragmentUniforms:S,vertexTextures:A,floatFragmentTextures:T,floatVertexTextures:A&&T,maxSamples:l?e.getParameter(e.MAX_SAMPLES):0}}function WebGLClipping(){var e=this,t=null,r=0,n=!1,o=!1,l=new Plane,c=new Matrix3,h={value:null,needsUpdate:!1};function d(){h.value!==t&&(h.value=t,h.needsUpdate=r>0),e.numPlanes=r,e.numIntersection=0}function f(t,r,n,o){var d=null!==t?t.length:0,f=null;if(0!==d){if(f=h.value,!0!==o||null===f){var m=n+4*d,v=r.matrixWorldInverse;c.getNormalMatrix(v),(null===f||f.length<m)&&(f=new Float32Array(m));for(var i=0,y=n;i!==d;++i,y+=4)l.copy(t[i]).applyMatrix4(v,c),l.normal.toArray(f,y),f[y+3]=l.constant}h.value=f,h.needsUpdate=!0}return e.numPlanes=d,f}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(e,o,l){var c=0!==e.length||o||0!==r||n;return n=o,t=f(e,l,0),r=e.length,c},this.beginShadows=function(){o=!0,f(null)},this.endShadows=function(){o=!1,d()},this.setState=function(e,l,c,m,v,y){if(!n||null===e||0===e.length||o&&!c)o?f(null):d();else{var x=o?0:r,w=4*x,M=v.clippingState||null;h.value=M,M=f(e,m,w,y);for(var i=0;i!==w;++i)M[i]=t[i];v.clippingState=M,this.numIntersection=l?this.numPlanes:0,this.numPlanes+=x}}}function WebGLExtensions(e){var t={};return{get:function(r){if(void 0!==t[r])return t[r];var n;switch(r){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(r)}return null===n&&console.warn("WebGLRenderer: "+r+" extension not supported."),t[r]=n,n}}}function WebGLGeometries(e,t,r){var n={},o={};function l(e){var c=e.target,h=n[c.id];for(var d in null!==h.index&&t.remove(h.index),h.attributes)t.remove(h.attributes[d]);c.removeEventListener("dispose",l),delete n[c.id];var f=o[h.id];f&&(t.remove(f),delete o[h.id]),r.memory.geometries--}return{get:function(object,e){var t=n[e.id];return t||(e.addEventListener("dispose",l),e.isBufferGeometry?t=e:e.isGeometry&&(void 0===e._bufferGeometry&&(e._bufferGeometry=(new BufferGeometry).setFromObject(object)),t=e._bufferGeometry),n[e.id]=t,r.memory.geometries++,t)},update:function(r){var n=r.index,o=r.attributes;for(var l in null!==n&&t.update(n,e.ELEMENT_ARRAY_BUFFER),o)t.update(o[l],e.ARRAY_BUFFER);var c=r.morphAttributes;for(var l in c)for(var h=c[l],i=0,d=h.length;i<d;i++)t.update(h[i],e.ARRAY_BUFFER)},getWireframeAttribute:function(r){var n=o[r.id];if(n)return n;var l,c=[],h=r.index,d=r.attributes;if(null!==h)for(var i=0,f=(l=h.array).length;i<f;i+=3){var a=l[i+0],b=l[i+1],m=l[i+2];c.push(a,b,b,m,m,a)}else for(i=0,f=(l=d.position.array).length/3-1;i<f;i+=3){a=i+0,b=i+1,m=i+2;c.push(a,b,b,m,m,a)}return n=new(arrayMax(c)>65535?Uint32BufferAttribute:Uint16BufferAttribute)(c,1),t.update(n,e.ELEMENT_ARRAY_BUFFER),o[r.id]=n,n}}}function WebGLIndexedBufferRenderer(e,t,r,n){var o,l,c;this.setMode=function(e){o=e},this.setIndex=function(e){l=e.type,c=e.bytesPerElement},this.render=function(t,n){e.drawElements(o,n,l,t*c),r.update(n,o)},this.renderInstances=function(h,d,f){var m;if(n.isWebGL2)m=e;else if(null===(m=t.get("ANGLE_instanced_arrays")))return void console.error("WebGLIndexedBufferRenderer: using InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");m[n.isWebGL2?"drawElementsInstanced":"drawElementsInstancedANGLE"](o,f,l,d*c,h.maxInstancedCount),r.update(f,o,h.maxInstancedCount)}}function WebGLInfo(e){var t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(r,n,o){switch(o=o||1,t.calls++,n){case e.TRIANGLES:t.triangles+=o*(r/3);break;case e.TRIANGLE_STRIP:case e.TRIANGLE_FAN:t.triangles+=o*(r-2);break;case e.LINES:t.lines+=o*(r/2);break;case e.LINE_STRIP:t.lines+=o*(r-1);break;case e.LINE_LOOP:t.lines+=o*r;break;case e.POINTS:t.points+=o*r;break;default:console.error("WebGLInfo: Unknown draw mode:",n)}}}}function absNumericalSort(a,b){return Math.abs(b[1])-Math.abs(a[1])}function WebGLMorphtargets(e){var t={},r=new Float32Array(8);return{update:function(object,n,o,l){var c=object.morphTargetInfluences,h=c.length,d=t[n.id];if(void 0===d){d=[];for(var i=0;i<h;i++)d[i]=[i,0];t[n.id]=d}var f=o.morphTargets&&n.morphAttributes.position,m=o.morphNormals&&n.morphAttributes.normal;for(i=0;i<h;i++){0!==(v=d[i])[1]&&(f&&n.removeAttribute("morphTarget"+i),m&&n.removeAttribute("morphNormal"+i))}for(i=0;i<h;i++){(v=d[i])[0]=i,v[1]=c[i]}for(d.sort(absNumericalSort),i=0;i<8;i++){var v;if(v=d[i]){var y=v[0],x=v[1];if(x){f&&n.addAttribute("morphTarget"+i,f[y]),m&&n.addAttribute("morphNormal"+i,m[y]),r[i]=x;continue}}r[i]=0}l.getUniforms().setValue(e,"morphTargetInfluences",r)}}}function WebGLObjects(e,t){var r={};return{update:function(object){var n=t.render.frame,o=object.geometry,l=e.get(object,o);return r[l.id]!==n&&(o.isGeometry&&l.updateFromObject(object),e.update(l),r[l.id]=n),l},dispose:function(){r={}}}}function DataTexture3D(data,e,t,r){Texture.call(this,null),this.image={data:data,width:e,height:t,depth:r},this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.wrapR=ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1}DataTexture3D.prototype=Object.create(Texture.prototype),DataTexture3D.prototype.constructor=DataTexture3D,DataTexture3D.prototype.isDataTexture3D=!0;var emptyTexture=new Texture,emptyTexture3d=new DataTexture3D,emptyCubeTexture=new CubeTexture;function UniformContainer(){this.seq=[],this.map={}}var arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9),mat2array=new Float32Array(4);function flatten(e,t,r){var n=e[0];if(n<=0||n>0)return e;var o=t*r,l=arrayCacheF32[o];if(void 0===l&&(l=new Float32Array(o),arrayCacheF32[o]=l),0!==t){n.toArray(l,0);for(var i=1,c=0;i!==t;++i)c+=r,e[i].toArray(l,c)}return l}function arraysEqual(a,b){if(a.length!==b.length)return!1;for(var i=0,e=a.length;i<e;i++)if(a[i]!==b[i])return!1;return!0}function copyArray(a,b){for(var i=0,e=b.length;i<e;i++)a[i]=b[i]}function allocTexUnits(e,t){var r=arrayCacheI32[t];void 0===r&&(r=new Int32Array(t),arrayCacheI32[t]=r);for(var i=0;i!==t;++i)r[i]=e.allocTextureUnit();return r}function setValue1f(e,t){var r=this.cache;r[0]!==t&&(e.uniform1f(this.addr,t),r[0]=t)}function setValue1i(e,t){var r=this.cache;r[0]!==t&&(e.uniform1i(this.addr,t),r[0]=t)}function setValue2fv(e,t){var r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),r[0]=t.x,r[1]=t.y);else{if(arraysEqual(r,t))return;e.uniform2fv(this.addr,t),copyArray(r,t)}}function setValue3fv(e,t){var r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y&&r[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),r[0]=t.x,r[1]=t.y,r[2]=t.z);else if(void 0!==t.r)r[0]===t.r&&r[1]===t.g&&r[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),r[0]=t.r,r[1]=t.g,r[2]=t.b);else{if(arraysEqual(r,t))return;e.uniform3fv(this.addr,t),copyArray(r,t)}}function setValue4fv(e,t){var r=this.cache;if(void 0!==t.x)r[0]===t.x&&r[1]===t.y&&r[2]===t.z&&r[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w);else{if(arraysEqual(r,t))return;e.uniform4fv(this.addr,t),copyArray(r,t)}}function setValue2fm(e,t){var r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix2fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat2array.set(n),e.uniformMatrix2fv(this.addr,!1,mat2array),copyArray(r,n)}}function setValue3fm(e,t){var r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix3fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat3array.set(n),e.uniformMatrix3fv(this.addr,!1,mat3array),copyArray(r,n)}}function setValue4fm(e,t){var r=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(r,t))return;e.uniformMatrix4fv(this.addr,!1,t),copyArray(r,t)}else{if(arraysEqual(r,n))return;mat4array.set(n),e.uniformMatrix4fv(this.addr,!1,mat4array),copyArray(r,n)}}function setValueT1(e,t,r){var n=this.cache,o=r.allocTextureUnit();n[0]!==o&&(e.uniform1i(this.addr,o),n[0]=o),r.setTexture2D(t||emptyTexture,o)}function setValueT3D1(e,t,r){var n=this.cache,o=r.allocTextureUnit();n[0]!==o&&(e.uniform1i(this.addr,o),n[0]=o),r.setTexture3D(t||emptyTexture3d,o)}function setValueT6(e,t,r){var n=this.cache,o=r.allocTextureUnit();n[0]!==o&&(e.uniform1i(this.addr,o),n[0]=o),r.setTextureCube(t||emptyCubeTexture,o)}function setValue2iv(e,t){var r=this.cache;arraysEqual(r,t)||(e.uniform2iv(this.addr,t),copyArray(r,t))}function setValue3iv(e,t){var r=this.cache;arraysEqual(r,t)||(e.uniform3iv(this.addr,t),copyArray(r,t))}function setValue4iv(e,t){var r=this.cache;arraysEqual(r,t)||(e.uniform4iv(this.addr,t),copyArray(r,t))}function getSingularSetter(e){switch(e){case 5126:return setValue1f;case 35664:return setValue2fv;case 35665:return setValue3fv;case 35666:return setValue4fv;case 35674:return setValue2fm;case 35675:return setValue3fm;case 35676:return setValue4fm;case 35678:case 36198:return setValueT1;case 35679:return setValueT3D1;case 35680:return setValueT6;case 5124:case 35670:return setValue1i;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function setValue1fv(e,t){var r=this.cache;arraysEqual(r,t)||(e.uniform1fv(this.addr,t),copyArray(r,t))}function setValue1iv(e,t){var r=this.cache;arraysEqual(r,t)||(e.uniform1iv(this.addr,t),copyArray(r,t))}function setValueV2a(e,t){var r=this.cache,data=flatten(t,this.size,2);arraysEqual(r,data)||(e.uniform2fv(this.addr,data),this.updateCache(data))}function setValueV3a(e,t){var r=this.cache,data=flatten(t,this.size,3);arraysEqual(r,data)||(e.uniform3fv(this.addr,data),this.updateCache(data))}function setValueV4a(e,t){var r=this.cache,data=flatten(t,this.size,4);arraysEqual(r,data)||(e.uniform4fv(this.addr,data),this.updateCache(data))}function setValueM2a(e,t){var r=this.cache,data=flatten(t,this.size,4);arraysEqual(r,data)||(e.uniformMatrix2fv(this.addr,!1,data),this.updateCache(data))}function setValueM3a(e,t){var r=this.cache,data=flatten(t,this.size,9);arraysEqual(r,data)||(e.uniformMatrix3fv(this.addr,!1,data),this.updateCache(data))}function setValueM4a(e,t){var r=this.cache,data=flatten(t,this.size,16);arraysEqual(r,data)||(e.uniformMatrix4fv(this.addr,!1,data),this.updateCache(data))}function setValueT1a(e,t,r){var n=this.cache,o=t.length,l=allocTexUnits(r,o);!1===arraysEqual(n,l)&&(e.uniform1iv(this.addr,l),copyArray(n,l));for(var i=0;i!==o;++i)r.setTexture2D(t[i]||emptyTexture,l[i])}function setValueT6a(e,t,r){var n=this.cache,o=t.length,l=allocTexUnits(r,o);!1===arraysEqual(n,l)&&(e.uniform1iv(this.addr,l),copyArray(n,l));for(var i=0;i!==o;++i)r.setTextureCube(t[i]||emptyCubeTexture,l[i])}function getPureArraySetter(e){switch(e){case 5126:return setValue1fv;case 35664:return setValueV2a;case 35665:return setValueV3a;case 35666:return setValueV4a;case 35674:return setValueM2a;case 35675:return setValueM3a;case 35676:return setValueM4a;case 35678:return setValueT1a;case 35680:return setValueT6a;case 5124:case 35670:return setValue1iv;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function SingleUniform(e,t,r){this.id=e,this.addr=r,this.cache=[],this.setValue=getSingularSetter(t.type)}function PureArrayUniform(e,t,r){this.id=e,this.addr=r,this.cache=[],this.size=t.size,this.setValue=getPureArraySetter(t.type)}function StructuredUniform(e){this.id=e,UniformContainer.call(this)}PureArrayUniform.prototype.updateCache=function(data){var e=this.cache;data instanceof Float32Array&&e.length!==data.length&&(this.cache=new Float32Array(data.length)),copyArray(e,data)},StructuredUniform.prototype.setValue=function(e,t,r){for(var n=this.seq,i=0,o=n.length;i!==o;++i){var u=n[i];u.setValue(e,t[u.id],r)}};var RePathPart=/([\w\d_]+)(\])?(\[|\.)?/g;function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,r){var path=e.name,n=path.length;for(RePathPart.lastIndex=0;;){var o=RePathPart.exec(path),l=RePathPart.lastIndex,c=o[1],h="]"===o[2],d=o[3];if(h&&(c|=0),void 0===d||"["===d&&l+2===n){addUniform(r,void 0===d?new SingleUniform(c,e,t):new PureArrayUniform(c,e,t));break}var f=r.map[c];void 0===f&&addUniform(r,f=new StructuredUniform(c)),r=f}}function WebGLUniforms(e,t,r){UniformContainer.call(this),this.renderer=r;for(var n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var o=e.getActiveUniform(t,i);parseUniform(o,e.getUniformLocation(t,o.name),this)}}function addLineNumbers(e){for(var t=e.split("\n"),i=0;i<t.length;i++)t[i]=i+1+": "+t[i];return t.join("\n")}function WebGLShader(e,t,r){var n=e.createShader(t);return e.shaderSource(n,r),e.compileShader(n),!1===e.getShaderParameter(n,e.COMPILE_STATUS)&&console.error("WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(n)&&console.warn("WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(n),addLineNumbers(r)),n}WebGLUniforms.prototype.setValue=function(e,t,r){var u=this.map[t];void 0!==u&&u.setValue(e,r,this.renderer)},WebGLUniforms.prototype.setOptional=function(e,object,t){var r=object[t];void 0!==r&&this.setValue(e,t,r)},WebGLUniforms.upload=function(e,t,r,n){for(var i=0,o=t.length;i!==o;++i){var u=t[i],l=r[u.id];!1!==l.needsUpdate&&u.setValue(e,l.value,n)}},WebGLUniforms.seqWithValue=function(e,t){for(var r=[],i=0,n=e.length;i!==n;++i){var u=e[i];u.id in t&&r.push(u)}return r};var programIdCount=0;function getEncodingComponents(e){switch(e){case LinearEncoding:return["Linear","( value )"];case sRGBEncoding:return["sRGB","( value )"];case RGBEEncoding:return["RGBE","( value )"];case RGBM7Encoding:return["RGBM","( value, 7.0 )"];case RGBM16Encoding:return["RGBM","( value, 16.0 )"];case RGBDEncoding:return["RGBD","( value, 256.0 )"];case GammaEncoding:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function getTexelDecodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function getTexelEncodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}function getToneMappingFunction(e,t){var r;switch(t){case LinearToneMapping:r="Linear";break;case ReinhardToneMapping:r="Reinhard";break;case Uncharted2ToneMapping:r="Uncharted2";break;case CineonToneMapping:r="OptimizedCineon";break;case ACESFilmicToneMapping:r="ACESFilmic";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}function generateExtensions(e,t,r){return[(e=e||{}).derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap&&!t.objectSpaceNormalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&r.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&r.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&r.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(filterEmptyLine).join("\n")}function generateDefines(e){var t=[];for(var r in e){var n=e[r];!1!==n&&t.push("#define "+r+" "+n)}return t.join("\n")}function fetchAttributeLocations(e,t){for(var r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;i++){var o=e.getActiveAttrib(t,i).name;r[o]=e.getAttribLocation(t,o)}return r}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function replaceClippingPlaneNums(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}function parseIncludes(e){return e.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(e,t){var r=ShaderChunk[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return parseIncludes(r)}))}function unrollLoops(e){return e.replace(/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,(function(e,t,r,n){for(var o="",i=parseInt(t);i<parseInt(r);i++)o+=n.replace(/\[ i \]/g,"[ "+i+" ]");return o}))}function WebGLProgram(e,t,code,r,n,o,l){var c=e.context,h=r.defines,d=n.vertexShader,f=n.fragmentShader,m="SHADOWMAP_TYPE_BASIC";o.shadowMapType===PCFShadowMap?m="SHADOWMAP_TYPE_PCF":o.shadowMapType===PCFSoftShadowMap&&(m="SHADOWMAP_TYPE_PCF_SOFT");var v="ENVMAP_TYPE_CUBE",y="ENVMAP_MODE_REFLECTION",x="ENVMAP_BLENDING_MULTIPLY";if(o.envMap){switch(r.envMap.mapping){case CubeReflectionMapping:case CubeRefractionMapping:v="ENVMAP_TYPE_CUBE";break;case CubeUVReflectionMapping:case CubeUVRefractionMapping:v="ENVMAP_TYPE_CUBE_UV";break;case EquirectangularReflectionMapping:case EquirectangularRefractionMapping:v="ENVMAP_TYPE_EQUIREC";break;case SphericalReflectionMapping:v="ENVMAP_TYPE_SPHERE"}switch(r.envMap.mapping){case CubeRefractionMapping:case EquirectangularRefractionMapping:y="ENVMAP_MODE_REFRACTION"}switch(r.combine){case MultiplyOperation:x="ENVMAP_BLENDING_MULTIPLY";break;case MixOperation:x="ENVMAP_BLENDING_MIX";break;case AddOperation:x="ENVMAP_BLENDING_ADD"}}var w,M,S=e.gammaFactor>0?e.gammaFactor:1,A=l.isWebGL2?"":generateExtensions(r.extensions,o,t),T=generateDefines(h),_=c.createProgram();if(r.isRawShaderMaterial?((w=[T].filter(filterEmptyLine).join("\n")).length>0&&(w+="\n"),(M=[A,T].filter(filterEmptyLine).join("\n")).length>0&&(M+="\n")):(w=["precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,T,o.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+S,"#define MAX_BONES "+o.maxBones,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+y:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.normalMap&&o.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",o.displacementMap&&o.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexTangents?"#define USE_TANGENT":"",o.vertexColors?"#define USE_COLOR":"",o.flatShading?"#define FLAT_SHADED":"",o.skinning?"#define USE_SKINNING":"",o.useVertexTexture?"#define BONE_TEXTURE":"",o.morphTargets?"#define USE_MORPHTARGETS":"",o.morphNormals&&!1===o.flatShading?"#define USE_MORPHNORMALS":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+m:"",o.sizeAttenuation?"#define USE_SIZEATTENUATION":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&(l.isWebGL2||t.get("EXT_frag_depth"))?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),M=[A,"precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,T,o.alphaTest?"#define ALPHATEST "+o.alphaTest+(o.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+S,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.matcap?"#define USE_MATCAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+v:"",o.envMap?"#define "+y:"",o.envMap?"#define "+x:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.normalMap&&o.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexTangents?"#define USE_TANGENT":"",o.vertexColors?"#define USE_COLOR":"",o.gradientMap?"#define USE_GRADIENTMAP":"",o.flatShading?"#define FLAT_SHADED":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+m:"",o.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",o.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&(l.isWebGL2||t.get("EXT_frag_depth"))?"#define USE_LOGDEPTHBUF_EXT":"",o.envMap&&(l.isWebGL2||t.get("EXT_shader_texture_lod"))?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",o.toneMapping!==NoToneMapping?"#define TONE_MAPPING":"",o.toneMapping!==NoToneMapping?ShaderChunk.tonemapping_pars_fragment:"",o.toneMapping!==NoToneMapping?getToneMappingFunction("toneMapping",o.toneMapping):"",o.dithering?"#define DITHERING":"",o.outputEncoding||o.mapEncoding||o.matcapEncoding||o.envMapEncoding||o.emissiveMapEncoding?ShaderChunk.encodings_pars_fragment:"",o.mapEncoding?getTexelDecodingFunction("mapTexelToLinear",o.mapEncoding):"",o.matcapEncoding?getTexelDecodingFunction("matcapTexelToLinear",o.matcapEncoding):"",o.envMapEncoding?getTexelDecodingFunction("envMapTexelToLinear",o.envMapEncoding):"",o.emissiveMapEncoding?getTexelDecodingFunction("emissiveMapTexelToLinear",o.emissiveMapEncoding):"",o.outputEncoding?getTexelEncodingFunction("linearToOutputTexel",o.outputEncoding):"",o.depthPacking?"#define DEPTH_PACKING "+r.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),d=replaceClippingPlaneNums(d=replaceLightNums(d=parseIncludes(d),o),o),f=replaceClippingPlaneNums(f=replaceLightNums(f=parseIncludes(f),o),o),d=unrollLoops(d),f=unrollLoops(f),l.isWebGL2&&!r.isRawShaderMaterial){var L=!1,C=/^\s*#version\s+300\s+es\s*\n/;r.isShaderMaterial&&null!==d.match(C)&&null!==f.match(C)&&(L=!0,d=d.replace(C,""),f=f.replace(C,"")),w=["#version 300 es\n","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+w,M=["#version 300 es\n","#define varying in",L?"":"out highp vec4 pc_fragColor;",L?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+M}var N=w+d,P=M+f,E=WebGLShader(c,c.VERTEX_SHADER,N),D=WebGLShader(c,c.FRAGMENT_SHADER,P);c.attachShader(_,E),c.attachShader(_,D),void 0!==r.index0AttributeName?c.bindAttribLocation(_,0,r.index0AttributeName):!0===o.morphTargets&&c.bindAttribLocation(_,0,"position"),c.linkProgram(_);var F,R,O=c.getProgramInfoLog(_).trim(),B=c.getShaderInfoLog(E).trim(),I=c.getShaderInfoLog(D).trim(),U=!0,V=!0;return!1===c.getProgramParameter(_,c.LINK_STATUS)?(U=!1,console.error("WebGLProgram: shader error: ",c.getError(),"gl.VALIDATE_STATUS",c.getProgramParameter(_,c.VALIDATE_STATUS),"gl.getProgramInfoLog",O,B,I)):""!==O?console.warn("WebGLProgram: gl.getProgramInfoLog()",O):""!==B&&""!==I||(V=!1),V&&(this.diagnostics={runnable:U,material:r,programLog:O,vertexShader:{log:B,prefix:w},fragmentShader:{log:I,prefix:M}}),c.deleteShader(E),c.deleteShader(D),this.getUniforms=function(){return void 0===F&&(F=new WebGLUniforms(c,_,e)),F},this.getAttributes=function(){return void 0===R&&(R=fetchAttributeLocations(c,_)),R},this.destroy=function(){c.deleteProgram(_),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.name=n.name,this.id=programIdCount++,this.code=code,this.usedTimes=1,this.program=_,this.vertexShader=E,this.fragmentShader=D,this}function WebGLPrograms(e,t,r){var n=[],o={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},l=["precision","supportsVertexTextures","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];function c(map,e){var t;return map?map.isTexture?t=map.encoding:map.isWebGLRenderTarget&&(console.warn("WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),t=map.texture.encoding):t=LinearEncoding,t===LinearEncoding&&e&&(t=GammaEncoding),t}this.getParameters=function(t,n,l,h,d,f,object){var m=o[t.type],v=object.isSkinnedMesh?function(object){var e=object.skeleton.bones;if(r.floatVertexTextures)return 1024;var t=r.maxVertexUniforms,n=Math.floor((t-20)/4),o=Math.min(n,e.length);return o<e.length?(console.warn("WebGLRenderer: Skeleton has "+e.length+" bones. This GPU supports "+o+"."),0):o}(object):0,y=r.precision;null!==t.precision&&(y=r.getMaxPrecision(t.precision))!==t.precision&&console.warn("WebGLProgram.getParameters:",t.precision,"not supported, using",y,"instead.");var x=e.getRenderTarget();return{shaderID:m,precision:y,supportsVertexTextures:r.vertexTextures,outputEncoding:c(x?x.texture:null,e.gammaOutput),map:!!t.map,mapEncoding:c(t.map,e.gammaInput),matcap:!!t.matcap,matcapEncoding:c(t.matcap,e.gammaInput),envMap:!!t.envMap,envMapMode:t.envMap&&t.envMap.mapping,envMapEncoding:c(t.envMap,e.gammaInput),envMapCubeUV:!!t.envMap&&(t.envMap.mapping===CubeUVReflectionMapping||t.envMap.mapping===CubeUVRefractionMapping),lightMap:!!t.lightMap,aoMap:!!t.aoMap,emissiveMap:!!t.emissiveMap,emissiveMapEncoding:c(t.emissiveMap,e.gammaInput),bumpMap:!!t.bumpMap,normalMap:!!t.normalMap,objectSpaceNormalMap:t.normalMapType===ObjectSpaceNormalMap,displacementMap:!!t.displacementMap,roughnessMap:!!t.roughnessMap,metalnessMap:!!t.metalnessMap,specularMap:!!t.specularMap,alphaMap:!!t.alphaMap,gradientMap:!!t.gradientMap,combine:t.combine,vertexTangents:t.normalMap&&t.vertexTangents,vertexColors:t.vertexColors,fog:!!h,useFog:t.fog,fogExp:h&&h.isFogExp2,flatShading:t.flatShading,sizeAttenuation:t.sizeAttenuation,logarithmicDepthBuffer:r.logarithmicDepthBuffer,skinning:t.skinning&&v>0,maxBones:v,useVertexTexture:r.floatVertexTextures,morphTargets:t.morphTargets,morphNormals:t.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:n.directional.length,numPointLights:n.point.length,numSpotLights:n.spot.length,numRectAreaLights:n.rectArea.length,numHemiLights:n.hemi.length,numClippingPlanes:d,numClipIntersection:f,dithering:t.dithering,shadowMapEnabled:e.shadowMap.enabled&&object.receiveShadow&&l.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:t.premultipliedAlpha,alphaTest:t.alphaTest,doubleSided:t.side===DoubleSide,flipSided:t.side===BackSide,depthPacking:void 0!==t.depthPacking&&t.depthPacking}},this.getProgramCode=function(t,r){var n=[];if(r.shaderID?n.push(r.shaderID):(n.push(t.fragmentShader),n.push(t.vertexShader)),void 0!==t.defines)for(var o in t.defines)n.push(o),n.push(t.defines[o]);for(var i=0;i<l.length;i++)n.push(r[l[i]]);return n.push(t.onBeforeCompile.toString()),n.push(e.gammaOutput),n.push(e.gammaFactor),n.join()},this.acquireProgram=function(o,l,c,code){for(var h,p=0,d=n.length;p<d;p++){var f=n[p];if(f.code===code){++(h=f).usedTimes;break}}return void 0===h&&(h=new WebGLProgram(e,t,code,o,l,c,r),n.push(h)),h},this.releaseProgram=function(e){if(0==--e.usedTimes){var i=n.indexOf(e);n[i]=n[n.length-1],n.pop(),e.destroy()}},this.programs=n}function WebGLProperties(){var e=new WeakMap;return{get:function(object){var map=e.get(object);return void 0===map&&(map={},e.set(object,map)),map},remove:function(object){e.delete(object)},update:function(object,t,r){e.get(object)[t]=r},dispose:function(){e=new WeakMap}}}function painterSortStable(a,b){return a.groupOrder!==b.groupOrder?a.groupOrder-b.groupOrder:a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.program&&b.program&&a.program!==b.program?a.program.id-b.program.id:a.material.id!==b.material.id?a.material.id-b.material.id:a.z!==b.z?a.z-b.z:a.id-b.id}function reversePainterSortStable(a,b){return a.groupOrder!==b.groupOrder?a.groupOrder-b.groupOrder:a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.z!==b.z?b.z-a.z:a.id-b.id}function WebGLRenderList(){var e=[],t=0,r=[],n=[];function o(object,r,n,o,l,c){var h=e[t];return void 0===h?(h={id:object.id,object:object,geometry:r,material:n,program:n.program,groupOrder:o,renderOrder:object.renderOrder,z:l,group:c},e[t]=h):(h.id=object.id,h.object=object,h.geometry=r,h.material=n,h.program=n.program,h.groupOrder=o,h.renderOrder=object.renderOrder,h.z=l,h.group=c),t++,h}return{opaque:r,transparent:n,init:function(){t=0,r.length=0,n.length=0},push:function(object,e,t,l,c,h){var d=o(object,e,t,l,c,h);(!0===t.transparent?n:r).push(d)},unshift:function(object,e,t,l,c,h){var d=o(object,e,t,l,c,h);(!0===t.transparent?n:r).unshift(d)},sort:function(){r.length>1&&r.sort(painterSortStable),n.length>1&&n.sort(reversePainterSortStable)}}}function WebGLRenderLists(){var e={};function t(r){var n=r.target;n.removeEventListener("dispose",t),delete e[n.id]}return{get:function(r,n){var o,l=e[r.id];return void 0===l?(o=new WebGLRenderList,e[r.id]={},e[r.id][n.id]=o,r.addEventListener("dispose",t)):void 0===(o=l[n.id])&&(o=new WebGLRenderList,l[n.id]=o),o},dispose:function(){e={}}}}function UniformsCache(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var r;switch(t.type){case"DirectionalLight":r={direction:new Vector3,color:new Color,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"SpotLight":r={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":r={position:new Vector3,color:new Color,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":r={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":r={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return e[t.id]=r,r}}}var count=0;function WebGLLights(){var e=new UniformsCache,t={id:count++,hash:{stateID:-1,directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,shadowsLength:-1},ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},r=new Vector3,n=new Matrix4,o=new Matrix4;return{setup:function(l,c,h){for(var d=0,g=0,b=0,f=0,m=0,v=0,y=0,x=0,w=h.matrixWorldInverse,i=0,M=l.length;i<M;i++){var S=l[i],A=S.color,T=S.intensity,_=S.distance,L=S.shadow&&S.shadow.map?S.shadow.map.texture:null;if(S.isAmbientLight)d+=A.r*T,g+=A.g*T,b+=A.b*T;else if(S.isDirectionalLight){if((C=e.get(S)).color.copy(S.color).multiplyScalar(S.intensity),C.direction.setFromMatrixPosition(S.matrixWorld),r.setFromMatrixPosition(S.target.matrixWorld),C.direction.sub(r),C.direction.transformDirection(w),C.shadow=S.castShadow,S.castShadow){var shadow=S.shadow;C.shadowBias=shadow.bias,C.shadowRadius=shadow.radius,C.shadowMapSize=shadow.mapSize}t.directionalShadowMap[f]=L,t.directionalShadowMatrix[f]=S.shadow.matrix,t.directional[f]=C,f++}else if(S.isSpotLight){if((C=e.get(S)).position.setFromMatrixPosition(S.matrixWorld),C.position.applyMatrix4(w),C.color.copy(A).multiplyScalar(T),C.distance=_,C.direction.setFromMatrixPosition(S.matrixWorld),r.setFromMatrixPosition(S.target.matrixWorld),C.direction.sub(r),C.direction.transformDirection(w),C.coneCos=Math.cos(S.angle),C.penumbraCos=Math.cos(S.angle*(1-S.penumbra)),C.decay=S.decay,C.shadow=S.castShadow,S.castShadow){shadow=S.shadow;C.shadowBias=shadow.bias,C.shadowRadius=shadow.radius,C.shadowMapSize=shadow.mapSize}t.spotShadowMap[v]=L,t.spotShadowMatrix[v]=S.shadow.matrix,t.spot[v]=C,v++}else if(S.isRectAreaLight){(C=e.get(S)).color.copy(A).multiplyScalar(T),C.position.setFromMatrixPosition(S.matrixWorld),C.position.applyMatrix4(w),o.identity(),n.copy(S.matrixWorld),n.premultiply(w),o.extractRotation(n),C.halfWidth.set(.5*S.width,0,0),C.halfHeight.set(0,.5*S.height,0),C.halfWidth.applyMatrix4(o),C.halfHeight.applyMatrix4(o),t.rectArea[y]=C,y++}else if(S.isPointLight){if((C=e.get(S)).position.setFromMatrixPosition(S.matrixWorld),C.position.applyMatrix4(w),C.color.copy(S.color).multiplyScalar(S.intensity),C.distance=S.distance,C.decay=S.decay,C.shadow=S.castShadow,S.castShadow){shadow=S.shadow;C.shadowBias=shadow.bias,C.shadowRadius=shadow.radius,C.shadowMapSize=shadow.mapSize,C.shadowCameraNear=shadow.camera.near,C.shadowCameraFar=shadow.camera.far}t.pointShadowMap[m]=L,t.pointShadowMatrix[m]=S.shadow.matrix,t.point[m]=C,m++}else if(S.isHemisphereLight){var C;(C=e.get(S)).direction.setFromMatrixPosition(S.matrixWorld),C.direction.transformDirection(w),C.direction.normalize(),C.skyColor.copy(S.color).multiplyScalar(T),C.groundColor.copy(S.groundColor).multiplyScalar(T),t.hemi[x]=C,x++}}t.ambient[0]=d,t.ambient[1]=g,t.ambient[2]=b,t.directional.length=f,t.spot.length=v,t.rectArea.length=y,t.point.length=m,t.hemi.length=x,t.hash.stateID=t.id,t.hash.directionalLength=f,t.hash.pointLength=m,t.hash.spotLength=v,t.hash.rectAreaLength=y,t.hash.hemiLength=x,t.hash.shadowsLength=c.length},state:t}}function WebGLRenderState(){var e=new WebGLLights,t=[],r=[];return{init:function(){t.length=0,r.length=0},state:{lightsArray:t,shadowsArray:r,lights:e},setupLights:function(n){e.setup(t,r,n)},pushLight:function(e){t.push(e)},pushShadow:function(e){r.push(e)}}}function WebGLRenderStates(){var e={};function t(r){var n=r.target;n.removeEventListener("dispose",t),delete e[n.id]}return{get:function(r,n){var o;return void 0===e[r.id]?(o=new WebGLRenderState,e[r.id]={},e[r.id][n.id]=o,r.addEventListener("dispose",t)):void 0===e[r.id][n.id]?(o=new WebGLRenderState,e[r.id][n.id]=o):o=e[r.id][n.id],o},dispose:function(){e={}}}}function WebGLShadowMap(e,t,r){for(var n=new Frustum,o=new Matrix4,l=new Vector2,c=new Vector2(r,r),h=new Vector3,d=new Vector3,f=1,m=2,v=1+(f|m),y=new Array(v),x=new Array(v),w={},M={0:BackSide,1:FrontSide,2:DoubleSide},S=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],A=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)],T=[new Vector4,new Vector4,new Vector4,new Vector4,new Vector4,new Vector4],i=0;i!==v;++i){var _=0!=(i&f),L=0!=(i&m),C=new MeshDepthMaterial({depthPacking:RGBADepthPacking,morphTargets:_,skinning:L});y[i]=C;var N=new MeshDistanceMaterial({morphTargets:_,skinning:L});x[i]=N}var P=this;function E(object,t,r,n,o,l){var c=object.geometry,h=null,d=y,v=object.customDepthMaterial;if(r&&(d=x,v=object.customDistanceMaterial),v)h=v;else{var S=!1;t.morphTargets&&(c&&c.isBufferGeometry?S=c.morphAttributes&&c.morphAttributes.position&&c.morphAttributes.position.length>0:c&&c.isGeometry&&(S=c.morphTargets&&c.morphTargets.length>0)),object.isSkinnedMesh&&!1===t.skinning&&console.warn("WebGLShadowMap: SkinnedMesh with material.skinning set to false:",object);var A=object.isSkinnedMesh&&t.skinning,T=0;S&&(T|=f),A&&(T|=m),h=d[T]}if(e.localClippingEnabled&&!0===t.clipShadows&&0!==t.clippingPlanes.length){var _=h.uuid,L=t.uuid,C=w[_];void 0===C&&(C={},w[_]=C);var N=C[L];void 0===N&&(N=h.clone(),C[L]=N),h=N}return h.visible=t.visible,h.wireframe=t.wireframe,h.side=null!=t.shadowSide?t.shadowSide:M[t.side],h.clipShadows=t.clipShadows,h.clippingPlanes=t.clippingPlanes,h.clipIntersection=t.clipIntersection,h.wireframeLinewidth=t.wireframeLinewidth,h.linewidth=t.linewidth,r&&h.isMeshDistanceMaterial&&(h.referencePosition.copy(n),h.nearDistance=o,h.farDistance=l),h}function D(object,r,o,l){if(!1!==object.visible){if(object.layers.test(r.layers)&&(object.isMesh||object.isLine||object.isPoints)&&object.castShadow&&(!object.frustumCulled||n.intersectsObject(object))){object.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,object.matrixWorld);var c=t.update(object),h=object.material;if(Array.isArray(h))for(var f=c.groups,m=0,v=f.length;m<v;m++){var y=f[m],x=h[y.materialIndex];if(x&&x.visible){var w=E(object,x,l,d,o.near,o.far);e.renderBufferDirect(o,null,c,w,object,y)}}else if(h.visible){w=E(object,h,l,d,o.near,o.far);e.renderBufferDirect(o,null,c,w,object,null)}}for(var M=object.children,i=0,S=M.length;i<S;i++)D(M[i],r,o,l)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=PCFShadowMap,this.render=function(t,r,f){if(!1!==P.enabled&&(!1!==P.autoUpdate||!1!==P.needsUpdate)&&0!==t.length){var m,v=e.getRenderTarget(),y=e.state;y.setBlending(NoBlending),y.buffers.color.setClear(1,1,1,1),y.buffers.depth.setTest(!0),y.setScissorTest(!1);for(var i=0,x=t.length;i<x;i++){var w=t[i],shadow=w.shadow,M=w&&w.isPointLight;if(void 0!==shadow){var _=shadow.camera;if(l.copy(shadow.mapSize),l.min(c),M){var L=l.x,C=l.y;T[0].set(2*L,C,L,C),T[1].set(0,C,L,C),T[2].set(3*L,C,L,C),T[3].set(L,C,L,C),T[4].set(3*L,0,L,C),T[5].set(L,0,L,C),l.x*=4,l.y*=2}if(null===shadow.map){var N={minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat};shadow.map=new WebGLRenderTarget(l.x,l.y,N),shadow.map.texture.name=w.name+".shadowMap",_.updateProjectionMatrix()}shadow.isSpotLightShadow&&shadow.update(w);var E=shadow.map,F=shadow.matrix;d.setFromMatrixPosition(w.matrixWorld),_.position.copy(d),M?(m=6,F.makeTranslation(-d.x,-d.y,-d.z)):(m=1,h.setFromMatrixPosition(w.target.matrixWorld),_.lookAt(h),_.updateMatrixWorld(),F.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),F.multiply(_.projectionMatrix),F.multiply(_.matrixWorldInverse)),e.setRenderTarget(E),e.clear();for(var R=0;R<m;R++){if(M){h.copy(_.position),h.add(S[R]),_.up.copy(A[R]),_.lookAt(h),_.updateMatrixWorld();var O=T[R];y.viewport(O)}o.multiplyMatrices(_.projectionMatrix,_.matrixWorldInverse),n.setFromMatrix(o),D(r,f,_,M)}}else console.warn("WebGLShadowMap:",w,"has no shadow.")}P.needsUpdate=!1,e.setRenderTarget(v)}}}function WebGLState(e,t,r,n){var o=new function(){var t=!1,r=new Vector4,n=null,o=new Vector4(0,0,0,0);return{setMask:function(r){n===r||t||(e.colorMask(r,r,r,r),n=r)},setLocked:function(e){t=e},setClear:function(t,g,b,a,n){!0===n&&(t*=a,g*=a,b*=a),r.set(t,g,b,a),!1===o.equals(r)&&(e.clearColor(t,g,b,a),o.copy(r))},reset:function(){t=!1,n=null,o.set(-1,0,0,0)}}},l=new function(){var t=!1,r=null,n=null,o=null;return{setTest:function(t){t?X(e.DEPTH_TEST):Y(e.DEPTH_TEST)},setMask:function(n){r===n||t||(e.depthMask(n),r=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case NeverDepth:e.depthFunc(e.NEVER);break;case AlwaysDepth:e.depthFunc(e.ALWAYS);break;case LessDepth:e.depthFunc(e.LESS);break;case LessEqualDepth:e.depthFunc(e.LEQUAL);break;case EqualDepth:e.depthFunc(e.EQUAL);break;case GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case GreaterDepth:e.depthFunc(e.GREATER);break;case NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);n=t}},setLocked:function(e){t=e},setClear:function(t){o!==t&&(e.clearDepth(t),o=t)},reset:function(){t=!1,r=null,n=null,o=null}}},c=new function(){var t=!1,r=null,n=null,o=null,l=null,c=null,h=null,d=null,f=null;return{setTest:function(t){t?X(e.STENCIL_TEST):Y(e.STENCIL_TEST)},setMask:function(n){r===n||t||(e.stencilMask(n),r=n)},setFunc:function(t,r,c){n===t&&o===r&&l===c||(e.stencilFunc(t,r,c),n=t,o=r,l=c)},setOp:function(t,r,n){c===t&&h===r&&d===n||(e.stencilOp(t,r,n),c=t,h=r,d=n)},setLocked:function(e){t=e},setClear:function(t){f!==t&&(e.clearStencil(t),f=t)},reset:function(){t=!1,r=null,n=null,o=null,l=null,c=null,h=null,d=null,f=null}}},h=e.getParameter(e.MAX_VERTEX_ATTRIBS),d=new Uint8Array(h),f=new Uint8Array(h),m=new Uint8Array(h),v={},y=null,x=null,w=null,M=null,S=null,A=null,T=null,_=null,L=null,C=null,N=!1,P=null,E=null,D=null,F=null,R=null,O=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),B=!1,I=0,U=e.getParameter(e.VERSION);-1!==U.indexOf("WebGL")?(I=parseFloat(/^WebGL\ ([0-9])/.exec(U)[1]),B=I>=1):-1!==U.indexOf("OpenGL ES")&&(I=parseFloat(/^OpenGL\ ES\ ([0-9])/.exec(U)[1]),B=I>=2);var V=null,k={},G=new Vector4,z=new Vector4;function j(t,r,n){var data=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var i=0;i<n;i++)e.texImage2D(r+i,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,data);return o}var W={};function H(r,o){(d[r]=1,0===f[r]&&(e.enableVertexAttribArray(r),f[r]=1),m[r]!==o)&&((n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](r,o),m[r]=o)}function X(t){!0!==v[t]&&(e.enable(t),v[t]=!0)}function Y(t){!1!==v[t]&&(e.disable(t),v[t]=!1)}function Q(t,n,o,l,c,h,d,f){if(t!==NoBlending){if(w||(X(e.BLEND),w=!0),t===CustomBlending)c=c||n,h=h||o,d=d||l,n===S&&c===_||(e.blendEquationSeparate(r.convert(n),r.convert(c)),S=n,_=c),o===A&&l===T&&h===L&&d===C||(e.blendFuncSeparate(r.convert(o),r.convert(l),r.convert(h),r.convert(d)),A=o,T=l,L=h,C=d),M=t,N=null;else if(t!==M||f!==N){if(S===AddEquation&&_===AddEquation||(e.blendEquation(e.FUNC_ADD),S=AddEquation,_=AddEquation),f)switch(t){case NormalBlending:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:e.blendFunc(e.ONE,e.ONE);break;case SubtractiveBlending:e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA);break;case MultiplyBlending:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("WebGLState: Invalid blending: ",t)}else switch(t){case NormalBlending:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case SubtractiveBlending:e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR);break;case MultiplyBlending:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("WebGLState: Invalid blending: ",t)}A=null,T=null,L=null,C=null,M=t,N=f}}else w&&(Y(e.BLEND),w=!1)}function K(t){P!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),P=t)}function J(t){t!==CullFaceNone?(X(e.CULL_FACE),t!==E&&(t===CullFaceBack?e.cullFace(e.BACK):t===CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):Y(e.CULL_FACE),E=t}function Z(t,r,n){t?(X(e.POLYGON_OFFSET_FILL),F===r&&R===n||(e.polygonOffset(r,n),F=r,R=n)):Y(e.POLYGON_OFFSET_FILL)}function $(t){void 0===t&&(t=e.TEXTURE0+O-1),V!==t&&(e.activeTexture(t),V=t)}return W[e.TEXTURE_2D]=j(e.TEXTURE_2D,e.TEXTURE_2D,1),W[e.TEXTURE_CUBE_MAP]=j(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),o.setClear(0,0,0,1),l.setClear(1),c.setClear(0),X(e.DEPTH_TEST),l.setFunc(LessEqualDepth),K(!1),J(CullFaceBack),X(e.CULL_FACE),Q(NoBlending),{buffers:{color:o,depth:l,stencil:c},initAttributes:function(){for(var i=0,e=d.length;i<e;i++)d[i]=0},enableAttribute:function(e){H(e,0)},enableAttributeAndDivisor:H,disableUnusedAttributes:function(){for(var i=0,t=f.length;i!==t;++i)f[i]!==d[i]&&(e.disableVertexAttribArray(i),f[i]=0)},enable:X,disable:Y,getCompressedTextureFormats:function(){if(null===y&&(y=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")||t.get("WEBGL_compressed_texture_astc")))for(var r=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),i=0;i<r.length;i++)y.push(r[i]);return y},useProgram:function(t){return x!==t&&(e.useProgram(t),x=t,!0)},setBlending:Q,setMaterial:function(t,r){t.side===DoubleSide?Y(e.CULL_FACE):X(e.CULL_FACE);var n=t.side===BackSide;r&&(n=!n),K(n),t.blending===NormalBlending&&!1===t.transparent?Q(NoBlending):Q(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),l.setFunc(t.depthFunc),l.setTest(t.depthTest),l.setMask(t.depthWrite),o.setMask(t.colorWrite),Z(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)},setFlipSided:K,setCullFace:J,setLineWidth:function(t){t!==D&&(B&&e.lineWidth(t),D=t)},setPolygonOffset:Z,setScissorTest:function(t){t?X(e.SCISSOR_TEST):Y(e.SCISSOR_TEST)},activeTexture:$,bindTexture:function(t,r){null===V&&$();var n=k[V];void 0===n&&(n={type:void 0,texture:void 0},k[V]=n),n.type===t&&n.texture===r||(e.bindTexture(t,r||W[t]),n.type=t,n.texture=r)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("WebGLState:",e)}},scissor:function(t){!1===G.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),G.copy(t))},viewport:function(t){!1===z.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),z.copy(t))},reset:function(){for(var i=0;i<f.length;i++)1===f[i]&&(e.disableVertexAttribArray(i),f[i]=0);v={},y=null,V=null,k={},x=null,M=null,P=null,E=null,o.reset(),l.reset(),c.reset()}}}function WebGLTextures(e,t,r,n,o,l,c){var h,d={},f="undefined"!=typeof OffscreenCanvas;function m(e,t){return f?new OffscreenCanvas(e,t):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function v(image,e,t,r){var n=1;if((image.width>r||image.height>r)&&(n=r/Math.max(image.width,image.height)),n<1||!0===e){if(image instanceof ImageBitmap||image instanceof HTMLImageElement||image instanceof HTMLCanvasElement){var o=e?_Math.floorPowerOfTwo:Math.floor,l=o(n*image.width),c=o(n*image.height);void 0===h&&(h=m(l,c));var canvas=t?m(l,c):h;return canvas.width=l,canvas.height=c,canvas.getContext("2d").drawImage(image,0,0,l,c),console.warn("WebGLRenderer: Texture has been resized from ("+image.width+"x"+image.height+") to ("+l+"x"+c+")."),f?canvas.transferToImageBitmap():canvas}return"data"in image&&console.warn("WebGLRenderer: Image in DataTexture is too big ("+image.width+"x"+image.height+")."),image}return image}function y(image){return _Math.isPowerOfTwo(image.width)&&_Math.isPowerOfTwo(image.height)}function x(e,t){return e.generateMipmaps&&t&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter}function w(t,r,o,l){e.generateMipmap(t),n.get(r).__maxMipLevel=Math.log(Math.max(o,l))*Math.LOG2E}function M(r,n){if(!o.isWebGL2)return r;var l=r;return r===e.RED&&(n===e.FLOAT&&(l=e.R32F),n===e.HALF_FLOAT&&(l=e.R16F),n===e.UNSIGNED_BYTE&&(l=e.R8)),r===e.RGB&&(n===e.FLOAT&&(l=e.RGB32F),n===e.HALF_FLOAT&&(l=e.RGB16F),n===e.UNSIGNED_BYTE&&(l=e.RGB8)),r===e.RGBA&&(n===e.FLOAT&&(l=e.RGBA32F),n===e.HALF_FLOAT&&(l=e.RGBA16F),n===e.UNSIGNED_BYTE&&(l=e.RGBA8)),l===e.R16F||l===e.R32F||l===e.RGBA16F||l===e.RGBA32F?t.get("EXT_color_buffer_float"):l!==e.RGB16F&&l!==e.RGB32F||console.warn("WebGLRenderer: Floating point textures with RGB format not supported. Please use RGBA instead."),l}function S(t){return t===NearestFilter||t===NearestMipMapNearestFilter||t===NearestMipMapLinearFilter?e.NEAREST:e.LINEAR}function A(t){var r=t.target;r.removeEventListener("dispose",A),function(t){var r=n.get(t);if(void 0===r.__webglInit)return;e.deleteTexture(r.__webglTexture),n.remove(t)}(r),r.isVideoTexture&&delete d[r.id],c.memory.textures--}function T(t){var r=t.target;r.removeEventListener("dispose",T),function(t){var r=n.get(t),o=n.get(t.texture);if(!t)return;void 0!==o.__webglTexture&&e.deleteTexture(o.__webglTexture);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLRenderTargetCube)for(var i=0;i<6;i++)e.deleteFramebuffer(r.__webglFramebuffer[i]),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[i]);else e.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer);n.remove(t.texture),n.remove(t)}(r),c.memory.textures--}function _(t,slot){var o=n.get(t);if(t.isVideoTexture&&function(e){var t=e.id,r=c.render.frame;d[t]!==r&&(d[t]=r,e.update())}(t),t.version>0&&o.__version!==t.version){var image=t.image;if(void 0===image)console.warn("WebGLRenderer: Texture marked for update but image is undefined");else{if(!1!==image.complete)return void N(o,t,slot);console.warn("WebGLRenderer: Texture marked for update but image is incomplete")}}r.activeTexture(e.TEXTURE0+slot),r.bindTexture(e.TEXTURE_2D,o.__webglTexture)}function L(r,c,h){var d;if(h?(e.texParameteri(r,e.TEXTURE_WRAP_S,l.convert(c.wrapS)),e.texParameteri(r,e.TEXTURE_WRAP_T,l.convert(c.wrapT)),r===e.TEXTURE_3D&&e.texParameteri(r,e.TEXTURE_WRAP_R,l.convert(c.wrapR)),e.texParameteri(r,e.TEXTURE_MAG_FILTER,l.convert(c.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,l.convert(c.minFilter))):(e.texParameteri(r,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(r,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),r===e.TEXTURE_3D&&e.texParameteri(r,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),c.wrapS===ClampToEdgeWrapping&&c.wrapT===ClampToEdgeWrapping||console.warn("WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to ClampToEdgeWrapping."),e.texParameteri(r,e.TEXTURE_MAG_FILTER,S(c.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,S(c.minFilter)),c.minFilter!==NearestFilter&&c.minFilter!==LinearFilter&&console.warn("WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to NearestFilter or LinearFilter.")),d=t.get("EXT_texture_filter_anisotropic")){if(c.type===FloatType&&null===t.get("OES_texture_float_linear"))return;if(c.type===HalfFloatType&&null===(o.isWebGL2||t.get("OES_texture_half_float_linear")))return;(c.anisotropy>1||n.get(c).__currentAnisotropy)&&(e.texParameterf(r,d.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(c.anisotropy,o.getMaxAnisotropy())),n.get(c).__currentAnisotropy=c.anisotropy)}}function C(t,r){void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",A),t.__webglTexture=e.createTexture(),c.memory.textures++)}function N(t,n,slot){var c=n.isDataTexture3D?e.TEXTURE_3D:e.TEXTURE_2D;C(t,n),r.activeTexture(e.TEXTURE0+slot),r.bindTexture(c,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment);var h=function(e){return!o.isWebGL2&&(e.wrapS!==ClampToEdgeWrapping||e.wrapT!==ClampToEdgeWrapping||e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter)}(n)&&!1===y(n.image),image=v(n.image,h,!1,o.maxTextureSize),d=y(image)||o.isWebGL2,f=l.convert(n.format),m=l.convert(n.type),S=M(f,m);L(c,n,d);var A,T=n.mipmaps;if(n.isDepthTexture){if(S=e.DEPTH_COMPONENT,n.type===FloatType){if(!o.isWebGL2)throw new Error("Float Depth Texture only supported in WebGL2.0");S=e.DEPTH_COMPONENT32F}else o.isWebGL2&&(S=e.DEPTH_COMPONENT16);n.format===DepthFormat&&S===e.DEPTH_COMPONENT&&n.type!==UnsignedShortType&&n.type!==UnsignedIntType&&(console.warn("WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=UnsignedShortType,m=l.convert(n.type)),n.format===DepthStencilFormat&&(S=e.DEPTH_STENCIL,n.type!==UnsignedInt248Type&&(console.warn("WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=UnsignedInt248Type,m=l.convert(n.type))),r.texImage2D(e.TEXTURE_2D,0,S,image.width,image.height,0,f,m,null)}else if(n.isDataTexture)if(T.length>0&&d){for(var i=0,_=T.length;i<_;i++)A=T[i],r.texImage2D(e.TEXTURE_2D,i,S,A.width,A.height,0,f,m,A.data);n.generateMipmaps=!1,t.__maxMipLevel=T.length-1}else r.texImage2D(e.TEXTURE_2D,0,S,image.width,image.height,0,f,m,image.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(i=0,_=T.length;i<_;i++)A=T[i],n.format!==RGBAFormat&&n.format!==RGBFormat?r.getCompressedTextureFormats().indexOf(f)>-1?r.compressedTexImage2D(e.TEXTURE_2D,i,S,A.width,A.height,0,A.data):console.warn("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):r.texImage2D(e.TEXTURE_2D,i,S,A.width,A.height,0,f,m,A.data);t.__maxMipLevel=T.length-1}else if(n.isDataTexture3D)r.texImage3D(e.TEXTURE_3D,0,S,image.width,image.height,image.depth,0,f,m,image.data),t.__maxMipLevel=0;else if(T.length>0&&d){for(i=0,_=T.length;i<_;i++)A=T[i],r.texImage2D(e.TEXTURE_2D,i,S,f,m,A);n.generateMipmaps=!1,t.__maxMipLevel=T.length-1}else r.texImage2D(e.TEXTURE_2D,0,S,f,m,image),t.__maxMipLevel=0;x(n,d)&&w(e.TEXTURE_2D,n,image.width,image.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function P(t,o,c,h){var d=l.convert(o.texture.format),f=l.convert(o.texture.type),m=M(d,f);r.texImage2D(h,0,m,o.width,o.height,0,d,f,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,c,h,n.get(o.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function E(t,r,n){if(e.bindRenderbuffer(e.RENDERBUFFER,t),r.depthBuffer&&!r.stencilBuffer){if(n){var o=F(r);e.renderbufferStorageMultisample(e.RENDERBUFFER,o,e.DEPTH_COMPONENT16,r.width,r.height)}else e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,r.width,r.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}else if(r.depthBuffer&&r.stencilBuffer){if(n){o=F(r);e.renderbufferStorageMultisample(e.RENDERBUFFER,o,e.DEPTH_STENCIL,r.width,r.height)}else e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,r.width,r.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)}else{var c=M(l.convert(r.texture.format),l.convert(r.texture.type));if(n){o=F(r);e.renderbufferStorageMultisample(e.RENDERBUFFER,o,c,r.width,r.height)}else e.renderbufferStorage(e.RENDERBUFFER,c,r.width,r.height)}e.bindRenderbuffer(e.RENDERBUFFER,null)}function D(t){var r=n.get(t),o=!0===t.isWebGLRenderTargetCube;if(t.depthTexture){if(o)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),_(r.depthTexture,0);var o=n.get(r.depthTexture).__webglTexture;if(r.depthTexture.format===DepthFormat)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);else{if(r.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0)}}(r.__webglFramebuffer,t)}else if(o){r.__webglDepthbuffer=[];for(var i=0;i<6;i++)e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[i]),r.__webglDepthbuffer[i]=e.createRenderbuffer(),E(r.__webglDepthbuffer[i],t)}else e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),E(r.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}function F(e){return o.isWebGL2&&e.isWebGLMultisampleRenderTarget?Math.min(o.maxSamples,e.samples):0}this.setTexture2D=_,this.setTexture3D=function(t,slot){var o=n.get(t);t.version>0&&o.__version!==t.version?N(o,t,slot):(r.activeTexture(e.TEXTURE0+slot),r.bindTexture(e.TEXTURE_3D,o.__webglTexture))},this.setTextureCube=function(t,slot){var c=n.get(t);if(6===t.image.length)if(t.version>0&&c.__version!==t.version){C(c,t),r.activeTexture(e.TEXTURE0+slot),r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var h=t&&t.isCompressedTexture,d=t.image[0]&&t.image[0].isDataTexture,f=[],i=0;i<6;i++)f[i]=h||d?d?t.image[i].image:t.image[i]:v(t.image[i],!1,!0,o.maxCubemapSize);var image=f[0],m=y(image)||o.isWebGL2,S=l.convert(t.format),A=l.convert(t.type),T=M(S,A);L(e.TEXTURE_CUBE_MAP,t,m);for(i=0;i<6;i++)if(h)for(var _,N=f[i].mipmaps,P=0,E=N.length;P<E;P++)_=N[P],t.format!==RGBAFormat&&t.format!==RGBFormat?r.getCompressedTextureFormats().indexOf(S)>-1?r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,P,T,_.width,_.height,0,_.data):console.warn("WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,P,T,_.width,_.height,0,S,A,_.data);else d?r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,T,f[i].width,f[i].height,0,S,A,f[i].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,T,S,A,f[i]);c.__maxMipLevel=h?N.length-1:0,x(t,m)&&w(e.TEXTURE_CUBE_MAP,t,image.width,image.height),c.__version=t.version,t.onUpdate&&t.onUpdate(t)}else r.activeTexture(e.TEXTURE0+slot),r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture)},this.setTextureCubeDynamic=function(t,slot){r.activeTexture(e.TEXTURE0+slot),r.bindTexture(e.TEXTURE_CUBE_MAP,n.get(t).__webglTexture)},this.setupRenderTarget=function(t){var h=n.get(t),d=n.get(t.texture);t.addEventListener("dispose",T),d.__webglTexture=e.createTexture(),c.memory.textures++;var f=!0===t.isWebGLRenderTargetCube,m=!0===t.isWebGLMultisampleRenderTarget,v=y(t)||o.isWebGL2;if(f){h.__webglFramebuffer=[];for(var i=0;i<6;i++)h.__webglFramebuffer[i]=e.createFramebuffer()}else if(h.__webglFramebuffer=e.createFramebuffer(),m)if(o.isWebGL2){h.__webglMultisampledFramebuffer=e.createFramebuffer(),h.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,h.__webglColorRenderbuffer);var S=M(l.convert(t.texture.format),l.convert(t.texture.type)),A=F(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,A,S,t.width,t.height),e.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer),e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(h.__webglDepthRenderbuffer=e.createRenderbuffer(),E(h.__webglDepthRenderbuffer,t,!0)),e.bindFramebuffer(e.FRAMEBUFFER,null)}else console.warn("WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(f){r.bindTexture(e.TEXTURE_CUBE_MAP,d.__webglTexture),L(e.TEXTURE_CUBE_MAP,t.texture,v);for(i=0;i<6;i++)P(h.__webglFramebuffer[i],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i);x(t.texture,v)&&w(e.TEXTURE_CUBE_MAP,t.texture,t.width,t.height),r.bindTexture(e.TEXTURE_CUBE_MAP,null)}else r.bindTexture(e.TEXTURE_2D,d.__webglTexture),L(e.TEXTURE_2D,t.texture,v),P(h.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),x(t.texture,v)&&w(e.TEXTURE_2D,t.texture,t.width,t.height),r.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&D(t)},this.updateRenderTargetMipmap=function(t){var l=t.texture;if(x(l,y(t)||o.isWebGL2)){var c=t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,h=n.get(l).__webglTexture;r.bindTexture(c,h),w(c,l,t.width,t.height),r.bindTexture(c,null)}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget)if(o.isWebGL2){var r=n.get(t);e.bindFramebuffer(e.READ_FRAMEBUFFER,r.__webglMultisampledFramebuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,r.__webglFramebuffer);var l=t.width,c=t.height,mask=e.COLOR_BUFFER_BIT;t.depthBuffer&&(mask|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&(mask|=e.STENCIL_BUFFER_BIT),e.blitFramebuffer(0,0,l,c,0,0,l,c,mask,e.NEAREST)}else console.warn("WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")}}function WebGLUtils(e,t,r){return{convert:function(p){var n;if(p===RepeatWrapping)return e.REPEAT;if(p===ClampToEdgeWrapping)return e.CLAMP_TO_EDGE;if(p===MirroredRepeatWrapping)return e.MIRRORED_REPEAT;if(p===NearestFilter)return e.NEAREST;if(p===NearestMipMapNearestFilter)return e.NEAREST_MIPMAP_NEAREST;if(p===NearestMipMapLinearFilter)return e.NEAREST_MIPMAP_LINEAR;if(p===LinearFilter)return e.LINEAR;if(p===LinearMipMapNearestFilter)return e.LINEAR_MIPMAP_NEAREST;if(p===LinearMipMapLinearFilter)return e.LINEAR_MIPMAP_LINEAR;if(p===UnsignedByteType)return e.UNSIGNED_BYTE;if(p===UnsignedShort4444Type)return e.UNSIGNED_SHORT_4_4_4_4;if(p===UnsignedShort5551Type)return e.UNSIGNED_SHORT_5_5_5_1;if(p===UnsignedShort565Type)return e.UNSIGNED_SHORT_5_6_5;if(p===ByteType)return e.BYTE;if(p===ShortType)return e.SHORT;if(p===UnsignedShortType)return e.UNSIGNED_SHORT;if(p===IntType)return e.INT;if(p===UnsignedIntType)return e.UNSIGNED_INT;if(p===FloatType)return e.FLOAT;if(p===HalfFloatType){if(r.isWebGL2)return e.HALF_FLOAT;if(null!==(n=t.get("OES_texture_half_float")))return n.HALF_FLOAT_OES}if(p===AlphaFormat)return e.ALPHA;if(p===RGBFormat)return e.RGB;if(p===RGBAFormat)return e.RGBA;if(p===LuminanceFormat)return e.LUMINANCE;if(p===LuminanceAlphaFormat)return e.LUMINANCE_ALPHA;if(p===DepthFormat)return e.DEPTH_COMPONENT;if(p===DepthStencilFormat)return e.DEPTH_STENCIL;if(p===RedFormat)return e.RED;if(p===AddEquation)return e.FUNC_ADD;if(p===SubtractEquation)return e.FUNC_SUBTRACT;if(p===ReverseSubtractEquation)return e.FUNC_REVERSE_SUBTRACT;if(p===ZeroFactor)return e.ZERO;if(p===OneFactor)return e.ONE;if(p===SrcColorFactor)return e.SRC_COLOR;if(p===OneMinusSrcColorFactor)return e.ONE_MINUS_SRC_COLOR;if(p===SrcAlphaFactor)return e.SRC_ALPHA;if(p===OneMinusSrcAlphaFactor)return e.ONE_MINUS_SRC_ALPHA;if(p===DstAlphaFactor)return e.DST_ALPHA;if(p===OneMinusDstAlphaFactor)return e.ONE_MINUS_DST_ALPHA;if(p===DstColorFactor)return e.DST_COLOR;if(p===OneMinusDstColorFactor)return e.ONE_MINUS_DST_COLOR;if(p===SrcAlphaSaturateFactor)return e.SRC_ALPHA_SATURATE;if((p===RGB_S3TC_DXT1_Format||p===RGBA_S3TC_DXT1_Format||p===RGBA_S3TC_DXT3_Format||p===RGBA_S3TC_DXT5_Format)&&null!==(n=t.get("WEBGL_compressed_texture_s3tc"))){if(p===RGB_S3TC_DXT1_Format)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(p===RGBA_S3TC_DXT1_Format)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(p===RGBA_S3TC_DXT3_Format)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(p===RGBA_S3TC_DXT5_Format)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((p===RGB_PVRTC_4BPPV1_Format||p===RGB_PVRTC_2BPPV1_Format||p===RGBA_PVRTC_4BPPV1_Format||p===RGBA_PVRTC_2BPPV1_Format)&&null!==(n=t.get("WEBGL_compressed_texture_pvrtc"))){if(p===RGB_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(p===RGB_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(p===RGBA_PVRTC_4BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(p===RGBA_PVRTC_2BPPV1_Format)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(p===RGB_ETC1_Format&&null!==(n=t.get("WEBGL_compressed_texture_etc1")))return n.COMPRESSED_RGB_ETC1_WEBGL;if((p===RGBA_ASTC_4x4_Format||p===RGBA_ASTC_5x4_Format||p===RGBA_ASTC_5x5_Format||p===RGBA_ASTC_6x5_Format||p===RGBA_ASTC_6x6_Format||p===RGBA_ASTC_8x5_Format||p===RGBA_ASTC_8x6_Format||p===RGBA_ASTC_8x8_Format||p===RGBA_ASTC_10x5_Format||p===RGBA_ASTC_10x6_Format||p===RGBA_ASTC_10x8_Format||p===RGBA_ASTC_10x10_Format||p===RGBA_ASTC_12x10_Format||p===RGBA_ASTC_12x12_Format)&&null!==(n=t.get("WEBGL_compressed_texture_astc")))return p;if(p===MinEquation||p===MaxEquation){if(r.isWebGL2){if(p===MinEquation)return e.MIN;if(p===MaxEquation)return e.MAX}if(null!==(n=t.get("EXT_blend_minmax"))){if(p===MinEquation)return n.MIN_EXT;if(p===MaxEquation)return n.MAX_EXT}}if(p===UnsignedInt248Type){if(r.isWebGL2)return e.UNSIGNED_INT_24_8;if(null!==(n=t.get("WEBGL_depth_texture")))return n.UNSIGNED_INT_24_8_WEBGL}return 0}}}function ArrayCamera(e){PerspectiveCamera.call(this),this.cameras=e||[]}ArrayCamera.prototype=Object.assign(Object.create(PerspectiveCamera.prototype),{constructor:ArrayCamera,isArrayCamera:!0});var cameraLPos=new Vector3,cameraRPos=new Vector3;function setProjectionFromUnion(e,t,r){cameraLPos.setFromMatrixPosition(t.matrixWorld),cameraRPos.setFromMatrixPosition(r.matrixWorld);var n=cameraLPos.distanceTo(cameraRPos),o=t.projectionMatrix.elements,l=r.projectionMatrix.elements,c=o[14]/(o[10]-1),h=o[14]/(o[10]+1),d=(o[9]+1)/o[5],f=(o[9]-1)/o[5],m=(o[8]-1)/o[0],v=(l[8]+1)/l[0],y=c*m,x=c*v,w=n/(-m+v),M=w*-m;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(M),e.translateZ(w),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.getInverse(e.matrixWorld);var S=c+w,A=h+w,T=y-M,_=x+(n-M),L=d*h/A*S,C=f*h/A*S;e.projectionMatrix.makePerspective(T,_,L,C,S,A)}function WebVRManager(e){var t=this,r=null,n=null,o=null,l=[],c=new Matrix4,h=new Matrix4,d=1,f="stage";"undefined"!=typeof window&&"VRFrameData"in window&&(n=new window.VRFrameData,window.addEventListener("vrdisplaypresentchange",_,!1));var m=new Matrix4,v=new Quaternion,y=new Vector3,x=new PerspectiveCamera;x.bounds=new Vector4(0,0,.5,1),x.layers.enable(1);var w=new PerspectiveCamera;w.bounds=new Vector4(.5,0,.5,1),w.layers.enable(2);var M=new ArrayCamera([x,w]);function S(){return null!==r&&!0===r.isPresenting}M.layers.enable(1),M.layers.enable(2);var A,T=new Vector2;function _(){if(S()){var n=r.getEyeParameters("left"),o=n.renderWidth*d,l=n.renderHeight*d;A=e.getPixelRatio(),e.getSize(T),e.setDrawingBufferSize(2*o,l,1),N.start()}else t.enabled&&e.setDrawingBufferSize(T.width,T.height,A),N.stop()}var L=[];function C(e){for(var t=navigator.getGamepads&&navigator.getGamepads(),i=0,r=0,n=t.length;i<n;i++){var o=t[i];if(o&&("Daydream Controller"===o.id||"Gear VR Controller"===o.id||"Oculus Go Controller"===o.id||"OpenVR Gamepad"===o.id||o.id.startsWith("Oculus Touch")||o.id.startsWith("Spatial Controller"))){if(r===e)return o;r++}}}this.enabled=!1,this.getController=function(e){var t=l[e];return void 0===t&&((t=new Group).matrixAutoUpdate=!1,t.visible=!1,l[e]=t),t},this.getDevice=function(){return r},this.setDevice=function(e){void 0!==e&&(r=e),N.setContext(e)},this.setFramebufferScaleFactor=function(e){d=e},this.setFrameOfReferenceType=function(e){f=e},this.setPoseTarget=function(object){void 0!==object&&(o=object)},this.getCamera=function(e){var t="stage"===f?1.6:0;if(!1===S())return e.position.set(0,t,0),e.rotation.set(0,0,0),e;if(r.depthNear=e.near,r.depthFar=e.far,r.getFrameData(n),"stage"===f){var d=r.stageParameters;d?c.fromArray(d.sittingToStandingTransform):c.makeTranslation(0,t,0)}var A=n.pose,T=null!==o?o:e;T.matrix.copy(c),T.matrix.decompose(T.position,T.quaternion,T.scale),null!==A.orientation&&(v.fromArray(A.orientation),T.quaternion.multiply(v)),null!==A.position&&(v.setFromRotationMatrix(c),y.fromArray(A.position),y.applyQuaternion(v),T.position.add(y)),T.updateMatrixWorld(),x.near=e.near,w.near=e.near,x.far=e.far,w.far=e.far,x.matrixWorldInverse.fromArray(n.leftViewMatrix),w.matrixWorldInverse.fromArray(n.rightViewMatrix),h.getInverse(c),"stage"===f&&(x.matrixWorldInverse.multiply(h),w.matrixWorldInverse.multiply(h));var _=T.parent;null!==_&&(m.getInverse(_.matrixWorld),x.matrixWorldInverse.multiply(m),w.matrixWorldInverse.multiply(m)),x.matrixWorld.getInverse(x.matrixWorldInverse),w.matrixWorld.getInverse(w.matrixWorldInverse),x.projectionMatrix.fromArray(n.leftProjectionMatrix),w.projectionMatrix.fromArray(n.rightProjectionMatrix),setProjectionFromUnion(M,x,w);var N=r.getLayers();if(N.length){var P=N[0];null!==P.leftBounds&&4===P.leftBounds.length&&x.bounds.fromArray(P.leftBounds),null!==P.rightBounds&&4===P.rightBounds.length&&w.bounds.fromArray(P.rightBounds)}return function(){for(var i=0;i<l.length;i++){var e=l[i],t=C(i);if(void 0!==t&&void 0!==t.pose){if(null===t.pose)return;var r=t.pose;!1===r.hasPosition&&e.position.set(.2,-.6,-.05),null!==r.position&&e.position.fromArray(r.position),null!==r.orientation&&e.quaternion.fromArray(r.orientation),e.matrix.compose(e.position,e.quaternion,e.scale),e.matrix.premultiply(c),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorldNeedsUpdate=!0,e.visible=!0;var n="Daydream Controller"===t.id?0:1;L[i]!==t.buttons[n].pressed&&(L[i]=t.buttons[n].pressed,!0===L[i]?e.dispatchEvent({type:"selectstart"}):(e.dispatchEvent({type:"selectend"}),e.dispatchEvent({type:"select"})))}else e.visible=!1}}(),M},this.getStandingMatrix=function(){return c},this.isPresenting=S;var N=new WebGLAnimation;this.setAnimationLoop=function(e){N.setAnimationLoop(e)},this.submitFrame=function(){S()&&r.submitFrame()},this.dispose=function(){"undefined"!=typeof window&&window.removeEventListener("vrdisplaypresentchange",_)}}function WebXRManager(e){var t=e.context,r=null,n=null,o=1,l=null,c="stage",h=null,d=[],f=[];function m(){return null!==n&&null!==l}var v=new PerspectiveCamera;v.layers.enable(1),v.viewport=new Vector4;var y=new PerspectiveCamera;y.layers.enable(2),y.viewport=new Vector4;var x=new ArrayCamera([v,y]);function w(e){var t=d[f.indexOf(e.inputSource)];t&&t.dispatchEvent({type:e.type})}function M(){e.setFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),T.stop()}function S(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.getInverse(e.matrixWorld)}x.layers.enable(1),x.layers.enable(2),this.enabled=!1,this.getController=function(e){var t=d[e];return void 0===t&&((t=new Group).matrixAutoUpdate=!1,t.visible=!1,d[e]=t),t},this.getDevice=function(){return r},this.setDevice=function(e){void 0!==e&&(r=e),e instanceof XRDevice&&t.setCompatibleXRDevice(e)},this.setFramebufferScaleFactor=function(e){o=e},this.setFrameOfReferenceType=function(e){c=e},this.setSession=function(r){null!==(n=r)&&(n.addEventListener("select",w),n.addEventListener("selectstart",w),n.addEventListener("selectend",w),n.addEventListener("end",M),n.baseLayer=new XRWebGLLayer(n,t,{framebufferScaleFactor:o}),n.requestFrameOfReference(c).then((function(t){l=t,e.setFramebuffer(n.baseLayer.framebuffer),T.setContext(n),T.start()})),f=n.getInputSources(),n.addEventListener("inputsourceschange",(function(){f=n.getInputSources(),console.log(f);for(var i=0;i<d.length;i++){d[i].userData.inputSource=f[i]}})))},this.getCamera=function(e){if(m()){var t=e.parent,r=x.cameras;S(x,t);for(var i=0;i<r.length;i++)S(r[i],t);e.matrixWorld.copy(x.matrixWorld);for(var n=e.children,o=(i=0,n.length);i<o;i++)n[i].updateMatrixWorld(!0);return setProjectionFromUnion(x,v,y),x}return e},this.isPresenting=m;var A=null;var T=new WebGLAnimation;T.setAnimationLoop((function(time,e){if(null!==(h=e.getDevicePose(l)))for(var t=n.baseLayer,r=e.views,i=0;i<r.length;i++){var view=r[i],o=t.getViewport(view),c=h.getViewMatrix(view),m=x.cameras[i];m.matrix.fromArray(c).getInverse(m.matrix),m.projectionMatrix.fromArray(view.projectionMatrix),m.viewport.set(o.x,o.y,o.width,o.height),0===i&&x.matrix.copy(m.matrix)}for(i=0;i<d.length;i++){var v=d[i],y=f[i];if(y){var w=e.getInputPose(y,l);if(null!==w){"targetRay"in w?v.matrix.elements=w.targetRay.transformMatrix:"pointerMatrix"in w&&(v.matrix.elements=w.pointerMatrix),v.matrix.decompose(v.position,v.rotation,v.scale),v.visible=!0;continue}}v.visible=!1}A&&A(time)})),this.setAnimationLoop=function(e){A=e},this.dispose=function(){},this.getStandingMatrix=function(){return console.warn("WebXRManager: getStandingMatrix() is no longer needed."),new Matrix4},this.submitFrame=function(){}}function WebGLRenderer(e){console.log("WebGLRenderer",REVISION);var t=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),r=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,o=void 0===e.depth||e.depth,l=void 0===e.stencil||e.stencil,c=void 0!==e.antialias&&e.antialias,h=void 0===e.premultipliedAlpha||e.premultipliedAlpha,d=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,f=void 0!==e.powerPreference?e.powerPreference:"default",m=null,v=null;this.domElement=t,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=LinearToneMapping,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var y,x,w,M,S,A,T,_,L,C,N,P,E,D,F,R,O,B,I=this,U=!1,V=null,k=null,G=null,z=-1,j={geometry:null,program:null,wireframe:!1},W=null,H=null,X=new Vector4,Y=new Vector4,Q=null,K=0,J=t.width,Z=t.height,$=1,ee=new Vector4(0,0,J,Z),te=new Vector4(0,0,J,Z),re=!1,ie=new Frustum,ne=new WebGLClipping,ae=!1,oe=!1,se=new Matrix4,le=new Vector3;function ce(){return null===k?$:1}try{var ue={alpha:n,depth:o,stencil:l,antialias:c,premultipliedAlpha:h,preserveDrawingBuffer:d,powerPreference:f};if(t.addEventListener("webglcontextlost",fe,!1),t.addEventListener("webglcontextrestored",me,!1),null===(y=r||t.getContext("webgl",ue)||t.getContext("experimental-webgl",ue)))throw null!==t.getContext("webgl")?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.");void 0===y.getShaderPrecisionFormat&&(y.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(e){throw console.error("WebGLRenderer: "+e.message),e}function he(){x=new WebGLExtensions(y),(w=new WebGLCapabilities(y,x,e)).isWebGL2||(x.get("WEBGL_depth_texture"),x.get("OES_texture_float"),x.get("OES_texture_half_float"),x.get("OES_texture_half_float_linear"),x.get("OES_standard_derivatives"),x.get("OES_element_index_uint"),x.get("ANGLE_instanced_arrays")),x.get("OES_texture_float_linear"),B=new WebGLUtils(y,x,w),(M=new WebGLState(y,x,B,w)).scissor(Y.copy(te).multiplyScalar($)),M.viewport(X.copy(ee).multiplyScalar($)),S=new WebGLInfo(y),A=new WebGLProperties,T=new WebGLTextures(y,x,M,A,w,B,S),_=new WebGLAttributes(y),L=new WebGLGeometries(y,_,S),C=new WebGLObjects(L,S),F=new WebGLMorphtargets(y),N=new WebGLPrograms(I,x,w),P=new WebGLRenderLists,E=new WebGLRenderStates,D=new WebGLBackground(I,M,C,h),R=new WebGLBufferRenderer(y,x,S,w),O=new WebGLIndexedBufferRenderer(y,x,S,w),S.programs=N.programs,I.context=y,I.capabilities=w,I.extensions=x,I.properties=A,I.renderLists=P,I.state=M,I.info=S}he();var de=null;"undefined"!=typeof navigator&&(de="xr"in navigator?new WebXRManager(I):new WebVRManager(I)),this.vr=de;var pe=new WebGLShadowMap(I,C,w.maxTextureSize);function fe(e){e.preventDefault(),console.log("WebGLRenderer: Context Lost."),U=!0}function me(){console.log("WebGLRenderer: Context Restored."),U=!1,he()}function ve(e){var t=e.target;t.removeEventListener("dispose",ve),function(e){ge(e),A.remove(e)}(t)}function ge(e){var t=A.get(e).program;e.program=void 0,void 0!==t&&N.releaseProgram(t)}this.shadowMap=pe,this.getContext=function(){return y},this.getContextAttributes=function(){return y.getContextAttributes()},this.forceContextLoss=function(){var e=x.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){var e=x.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return $},this.setPixelRatio=function(e){void 0!==e&&($=e,this.setSize(J,Z,!1))},this.getSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),e=new Vector2),e.set(J,Z)},this.setSize=function(e,r,n){de.isPresenting()?console.warn("WebGLRenderer: Can't change size while VR device is presenting."):(J=e,Z=r,t.width=e*$,t.height=r*$,!1!==n&&(t.style.width=e+"px",t.style.height=r+"px"),this.setViewport(0,0,e,r))},this.getDrawingBufferSize=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),e=new Vector2),e.set(J*$,Z*$)},this.setDrawingBufferSize=function(e,r,n){J=e,Z=r,$=n,t.width=e*n,t.height=r*n,this.setViewport(0,0,e,r)},this.getCurrentViewport=function(e){return void 0===e&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),e=new Vector4),e.copy(X)},this.getViewport=function(e){return e.copy(ee)},this.setViewport=function(e,t,r,n){e.isVector4?ee.set(e.x,e.y,e.z,e.w):ee.set(e,t,r,n),M.viewport(X.copy(ee).multiplyScalar($))},this.getScissor=function(e){return e.copy(te)},this.setScissor=function(e,t,r,n){e.isVector4?te.set(e.x,e.y,e.z,e.w):te.set(e,t,r,n),M.scissor(Y.copy(te).multiplyScalar($))},this.getScissorTest=function(){return re},this.setScissorTest=function(e){M.setScissorTest(re=e)},this.getClearColor=function(){return D.getClearColor()},this.setClearColor=function(){D.setClearColor.apply(D,arguments)},this.getClearAlpha=function(){return D.getClearAlpha()},this.setClearAlpha=function(){D.setClearAlpha.apply(D,arguments)},this.clear=function(e,t,r){var n=0;(void 0===e||e)&&(n|=y.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=y.DEPTH_BUFFER_BIT),(void 0===r||r)&&(n|=y.STENCIL_BUFFER_BIT),y.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",fe,!1),t.removeEventListener("webglcontextrestored",me,!1),P.dispose(),E.dispose(),A.dispose(),C.dispose(),de.dispose(),be.stop()},this.renderBufferImmediate=function(object,e){M.initAttributes();var t=A.get(object);object.hasPositions&&!t.position&&(t.position=y.createBuffer()),object.hasNormals&&!t.normal&&(t.normal=y.createBuffer()),object.hasUvs&&!t.uv&&(t.uv=y.createBuffer()),object.hasColors&&!t.color&&(t.color=y.createBuffer());var r=e.getAttributes();object.hasPositions&&(y.bindBuffer(y.ARRAY_BUFFER,t.position),y.bufferData(y.ARRAY_BUFFER,object.positionArray,y.DYNAMIC_DRAW),M.enableAttribute(r.position),y.vertexAttribPointer(r.position,3,y.FLOAT,!1,0,0)),object.hasNormals&&(y.bindBuffer(y.ARRAY_BUFFER,t.normal),y.bufferData(y.ARRAY_BUFFER,object.normalArray,y.DYNAMIC_DRAW),M.enableAttribute(r.normal),y.vertexAttribPointer(r.normal,3,y.FLOAT,!1,0,0)),object.hasUvs&&(y.bindBuffer(y.ARRAY_BUFFER,t.uv),y.bufferData(y.ARRAY_BUFFER,object.uvArray,y.DYNAMIC_DRAW),M.enableAttribute(r.uv),y.vertexAttribPointer(r.uv,2,y.FLOAT,!1,0,0)),object.hasColors&&(y.bindBuffer(y.ARRAY_BUFFER,t.color),y.bufferData(y.ARRAY_BUFFER,object.colorArray,y.DYNAMIC_DRAW),M.enableAttribute(r.color),y.vertexAttribPointer(r.color,3,y.FLOAT,!1,0,0)),M.disableUnusedAttributes(),y.drawArrays(y.TRIANGLES,0,object.count),object.count=0},this.renderBufferDirect=function(e,t,r,n,object,o){var l=object.isMesh&&object.matrixWorld.determinant()<0;M.setMaterial(n,l);var c=Te(e,t,n,object),h=!1;j.geometry===r.id&&j.program===c.id&&j.wireframe===(!0===n.wireframe)||(j.geometry=r.id,j.program=c.id,j.wireframe=!0===n.wireframe,h=!0),object.morphTargetInfluences&&(F.update(object,r,n,c),h=!0);var d,f=r.index,m=r.attributes.position,v=1;!0===n.wireframe&&(f=L.getWireframeAttribute(r),v=2);var S=R;null!==f&&(d=_.get(f),(S=O).setIndex(d)),h&&(!function(e,t,r){if(r&&r.isInstancedBufferGeometry&&!w.isWebGL2&&null===x.get("ANGLE_instanced_arrays"))return void console.error("WebGLRenderer.setupVertexAttributes: using InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");M.initAttributes();var n=r.attributes,o=t.getAttributes(),l=e.defaultAttributeValues;for(var c in o){var h=o[c];if(h>=0){var d=n[c];if(void 0!==d){var f=d.normalized,m=d.itemSize,v=_.get(d);if(void 0===v)continue;var S=v.buffer,A=v.type,T=v.bytesPerElement;if(d.isInterleavedBufferAttribute){var data=d.data,L=data.stride,C=d.offset;data&&data.isInstancedInterleavedBuffer?(M.enableAttributeAndDivisor(h,data.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=data.meshPerAttribute*data.count)):M.enableAttribute(h),y.bindBuffer(y.ARRAY_BUFFER,S),y.vertexAttribPointer(h,m,A,f,L*T,C*T)}else d.isInstancedBufferAttribute?(M.enableAttributeAndDivisor(h,d.meshPerAttribute),void 0===r.maxInstancedCount&&(r.maxInstancedCount=d.meshPerAttribute*d.count)):M.enableAttribute(h),y.bindBuffer(y.ARRAY_BUFFER,S),y.vertexAttribPointer(h,m,A,f,0,0)}else if(void 0!==l){var N=l[c];if(void 0!==N)switch(N.length){case 2:y.vertexAttrib2fv(h,N);break;case 3:y.vertexAttrib3fv(h,N);break;case 4:y.vertexAttrib4fv(h,N);break;default:y.vertexAttrib1fv(h,N)}}}}M.disableUnusedAttributes()}(n,c,r),null!==f&&y.bindBuffer(y.ELEMENT_ARRAY_BUFFER,d.buffer));var A=1/0;null!==f?A=f.count:void 0!==m&&(A=m.count);var T=r.drawRange.start*v,C=r.drawRange.count*v,N=null!==o?o.start*v:0,P=null!==o?o.count*v:1/0,E=Math.max(T,N),D=Math.min(A,T+C,N+P)-1,B=Math.max(0,D-E+1);if(0!==B){if(object.isMesh)if(!0===n.wireframe)M.setLineWidth(n.wireframeLinewidth*ce()),S.setMode(y.LINES);else switch(object.drawMode){case TrianglesDrawMode:S.setMode(y.TRIANGLES);break;case TriangleStripDrawMode:S.setMode(y.TRIANGLE_STRIP);break;case TriangleFanDrawMode:S.setMode(y.TRIANGLE_FAN)}else if(object.isLine){var I=n.linewidth;void 0===I&&(I=1),M.setLineWidth(I*ce()),object.isLineSegments?S.setMode(y.LINES):object.isLineLoop?S.setMode(y.LINE_LOOP):S.setMode(y.LINE_STRIP)}else object.isPoints?S.setMode(y.POINTS):object.isSprite&&S.setMode(y.TRIANGLES);r&&r.isInstancedBufferGeometry?r.maxInstancedCount>0&&S.renderInstances(r,E,B):S.render(E,B)}},this.compile=function(e,t){(v=E.get(e,t)).init(),e.traverse((function(object){object.isLight&&(v.pushLight(object),object.castShadow&&v.pushShadow(object))})),v.setupLights(t),e.traverse((function(object){if(object.material)if(Array.isArray(object.material))for(var i=0;i<object.material.length;i++)Ae(object.material[i],e.fog,object);else Ae(object.material,e.fog,object)}))};var ye=null;var xe,be=new WebGLAnimation;function we(object,e,t,r){if(!1!==object.visible){if(object.layers.test(e.layers))if(object.isGroup)t=object.renderOrder;else if(object.isLight)v.pushLight(object),object.castShadow&&v.pushShadow(object);else if(object.isSprite){if(!object.frustumCulled||ie.intersectsSprite(object)){r&&le.setFromMatrixPosition(object.matrixWorld).applyMatrix4(se);var n=C.update(object),o=object.material;m.push(object,n,o,t,le.z,null)}}else if(object.isImmediateRenderObject)r&&le.setFromMatrixPosition(object.matrixWorld).applyMatrix4(se),m.push(object,null,object.material,t,le.z,null);else if((object.isMesh||object.isLine||object.isPoints)&&(object.isSkinnedMesh&&object.skeleton.update(),!object.frustumCulled||ie.intersectsObject(object))){r&&le.setFromMatrixPosition(object.matrixWorld).applyMatrix4(se);n=C.update(object),o=object.material;if(Array.isArray(o))for(var l=n.groups,i=0,c=l.length;i<c;i++){var h=l[i],d=o[h.materialIndex];d&&d.visible&&m.push(object,n,d,t,le.z,h)}else o.visible&&m.push(object,n,o,t,le.z,null)}var f=object.children;for(i=0,c=f.length;i<c;i++)we(f[i],e,t,r)}}function Me(e,t,r,n){for(var i=0,o=e.length;i<o;i++){var l=e[i],object=l.object,c=l.geometry,h=void 0===n?l.material:n,d=l.group;if(r.isArrayCamera){H=r;for(var f=r.cameras,m=0,y=f.length;m<y;m++){var x=f[m];if(object.layers.test(x.layers)){if("viewport"in x)M.viewport(X.copy(x.viewport));else{var w=x.bounds,S=w.x*J,A=w.y*Z,T=w.z*J,_=w.w*Z;M.viewport(X.set(S,A,T,_).multiplyScalar($))}v.setupLights(x),Se(object,t,x,c,h,d)}}}else H=null,Se(object,t,r,c,h,d)}}function Se(object,e,t,r,n,o){if(object.onBeforeRender(I,e,t,r,n,o),v=E.get(e,H||t),object.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),object.isImmediateRenderObject){M.setMaterial(n);var l=Te(t,e.fog,n,object);j.geometry=null,j.program=null,j.wireframe=!1,function(object,e){object.render((function(object){I.renderBufferImmediate(object,e)}))}(object,l)}else I.renderBufferDirect(t,e.fog,r,n,object,o);object.onAfterRender(I,e,t,r,n,o),v=E.get(e,H||t)}function Ae(e,t,object){var r=A.get(e),n=v.state.lights,o=v.state.shadowsArray,l=r.lightsHash,c=n.state.hash,h=N.getParameters(e,n.state,o,t,ne.numPlanes,ne.numIntersection,object),code=N.getProgramCode(e,h),d=r.program,f=!0;if(void 0===d)e.addEventListener("dispose",ve);else if(d.code!==code)ge(e);else if(l.stateID!==c.stateID||l.directionalLength!==c.directionalLength||l.pointLength!==c.pointLength||l.spotLength!==c.spotLength||l.rectAreaLength!==c.rectAreaLength||l.hemiLength!==c.hemiLength||l.shadowsLength!==c.shadowsLength)l.stateID=c.stateID,l.directionalLength=c.directionalLength,l.pointLength=c.pointLength,l.spotLength=c.spotLength,l.rectAreaLength=c.rectAreaLength,l.hemiLength=c.hemiLength,l.shadowsLength=c.shadowsLength,f=!1;else{if(void 0!==h.shaderID)return;f=!1}if(f){if(h.shaderID){var m=ShaderLib[h.shaderID];r.shader={name:e.type,uniforms:cloneUniforms(m.uniforms),vertexShader:m.vertexShader,fragmentShader:m.fragmentShader}}else r.shader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.onBeforeCompile(r.shader,I),code=N.getProgramCode(e,h),d=N.acquireProgram(e,r.shader,h,code),r.program=d,e.program=d}var y=d.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var i=0;i<I.maxMorphTargets;i++)y["morphTarget"+i]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(i=0;i<I.maxMorphNormals;i++)y["morphNormal"+i]>=0&&e.numSupportedMorphNormals++}var x=r.shader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(r.numClippingPlanes=ne.numPlanes,r.numIntersection=ne.numIntersection,x.clippingPlanes=ne.uniform),r.fog=t,void 0===l&&(r.lightsHash=l={}),l.stateID=c.stateID,l.directionalLength=c.directionalLength,l.pointLength=c.pointLength,l.spotLength=c.spotLength,l.rectAreaLength=c.rectAreaLength,l.hemiLength=c.hemiLength,l.shadowsLength=c.shadowsLength,e.lights&&(x.ambientLightColor.value=n.state.ambient,x.directionalLights.value=n.state.directional,x.spotLights.value=n.state.spot,x.rectAreaLights.value=n.state.rectArea,x.pointLights.value=n.state.point,x.hemisphereLights.value=n.state.hemi,x.directionalShadowMap.value=n.state.directionalShadowMap,x.directionalShadowMatrix.value=n.state.directionalShadowMatrix,x.spotShadowMap.value=n.state.spotShadowMap,x.spotShadowMatrix.value=n.state.spotShadowMatrix,x.pointShadowMap.value=n.state.pointShadowMap,x.pointShadowMatrix.value=n.state.pointShadowMatrix);var w=r.program.getUniforms(),M=WebGLUniforms.seqWithValue(w.seq,x);r.uniformsList=M}function Te(e,t,r,object){K=0;var n=A.get(r),o=v.state.lights,l=n.lightsHash,c=o.state.hash;if(ae&&(oe||e!==W)){var h=e===W&&r.id===z;ne.setState(r.clippingPlanes,r.clipIntersection,r.clipShadows,e,n,h)}!1===r.needsUpdate&&(void 0===n.program?r.needsUpdate=!0:r.fog&&n.fog!==t?r.needsUpdate=!0:(!r.lights||l.stateID===c.stateID&&l.directionalLength===c.directionalLength&&l.pointLength===c.pointLength&&l.spotLength===c.spotLength&&l.rectAreaLength===c.rectAreaLength&&l.hemiLength===c.hemiLength&&l.shadowsLength===c.shadowsLength)&&(void 0===n.numClippingPlanes||n.numClippingPlanes===ne.numPlanes&&n.numIntersection===ne.numIntersection)||(r.needsUpdate=!0)),r.needsUpdate&&(Ae(r,t,object),r.needsUpdate=!1);var d,f,m=!1,x=!1,S=!1,T=n.program,_=T.getUniforms(),L=n.shader.uniforms;if(M.useProgram(T.program)&&(m=!0,x=!0,S=!0),r.id!==z&&(z=r.id,x=!0),m||W!==e){if(_.setValue(y,"projectionMatrix",e.projectionMatrix),w.logarithmicDepthBuffer&&_.setValue(y,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),W!==e&&(W=e,x=!0,S=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.envMap){var C=_.map.cameraPosition;void 0!==C&&C.setValue(y,le.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.skinning)&&_.setValue(y,"viewMatrix",e.matrixWorldInverse)}if(r.skinning){_.setOptional(y,object,"bindMatrix"),_.setOptional(y,object,"bindMatrixInverse");var N=object.skeleton;if(N){var P=N.bones;if(w.floatVertexTextures){if(void 0===N.boneTexture){var E=Math.sqrt(4*P.length);E=_Math.ceilPowerOfTwo(E),E=Math.max(E,4);var D=new Float32Array(E*E*4);D.set(N.boneMatrices);var F=new DataTexture(D,E,E,RGBAFormat,FloatType);F.needsUpdate=!0,N.boneMatrices=D,N.boneTexture=F,N.boneTextureSize=E}_.setValue(y,"boneTexture",N.boneTexture),_.setValue(y,"boneTextureSize",N.boneTextureSize)}else _.setOptional(y,N,"boneMatrices")}}return x&&(_.setValue(y,"toneMappingExposure",I.toneMappingExposure),_.setValue(y,"toneMappingWhitePoint",I.toneMappingWhitePoint),r.lights&&(f=S,(d=L).ambientLightColor.needsUpdate=f,d.directionalLights.needsUpdate=f,d.pointLights.needsUpdate=f,d.spotLights.needsUpdate=f,d.rectAreaLights.needsUpdate=f,d.hemisphereLights.needsUpdate=f),t&&r.fog&&function(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}(L,t),r.isMeshBasicMaterial?_e(L,r):r.isMeshLambertMaterial?(_e(L,r),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(L,r)):r.isMeshPhongMaterial?(_e(L,r),r.isMeshToonMaterial?function(e,t){Le(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(L,r):Le(L,r)):r.isMeshStandardMaterial?(_e(L,r),r.isMeshPhysicalMaterial?function(e,t){Ce(e,t),e.reflectivity.value=t.reflectivity,e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness}(L,r):Ce(L,r)):r.isMeshMatcapMaterial?(_e(L,r),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(L,r)):r.isMeshDepthMaterial?(_e(L,r),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(L,r)):r.isMeshDistanceMaterial?(_e(L,r),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(L,r)):r.isMeshNormalMaterial?(_e(L,r),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(L,r)):r.isLineBasicMaterial?(function(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}(L,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(L,r)):r.isPointsMaterial?function(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*$,e.scale.value=.5*Z,e.map.value=t.map,null!==t.map&&(!0===t.map.matrixAutoUpdate&&t.map.updateMatrix(),e.uvTransform.value.copy(t.map.matrix))}(L,r):r.isSpriteMaterial?function(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity,e.rotation.value=t.rotation,e.map.value=t.map,null!==t.map&&(!0===t.map.matrixAutoUpdate&&t.map.updateMatrix(),e.uvTransform.value.copy(t.map.matrix))}(L,r):r.isShadowMaterial&&(L.color.value=r.color,L.opacity.value=r.opacity),void 0!==L.ltc_1&&(L.ltc_1.value=UniformsLib.LTC_1),void 0!==L.ltc_2&&(L.ltc_2.value=UniformsLib.LTC_2),WebGLUniforms.upload(y,n.uniformsList,L,I)),r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(WebGLUniforms.upload(y,n.uniformsList,L,I),r.uniformsNeedUpdate=!1),r.isSpriteMaterial&&_.setValue(y,"center",object.center),_.setValue(y,"modelViewMatrix",object.modelViewMatrix),_.setValue(y,"normalMatrix",object.normalMatrix),_.setValue(y,"modelMatrix",object.matrixWorld),T}function _e(e,t){var r;e.opacity.value=t.opacity,t.color&&(e.diffuse.value=t.color),t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),t.map&&(e.map.value=t.map),t.alphaMap&&(e.alphaMap.value=t.alphaMap),t.specularMap&&(e.specularMap.value=t.specularMap),t.envMap&&(e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio,e.maxMipLevel.value=A.get(t.envMap).__maxMipLevel),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity),t.map?r=t.map:t.specularMap?r=t.specularMap:t.displacementMap?r=t.displacementMap:t.normalMap?r=t.normalMap:t.bumpMap?r=t.bumpMap:t.roughnessMap?r=t.roughnessMap:t.metalnessMap?r=t.metalnessMap:t.alphaMap?r=t.alphaMap:t.emissiveMap&&(r=t.emissiveMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix))}function Le(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1)),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate()),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function Ce(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,t.side===BackSide&&(e.bumpScale.value*=-1)),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),t.side===BackSide&&e.normalScale.value.negate()),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}be.setAnimationLoop((function(time){de.isPresenting()||ye&&ye(time)})),"undefined"!=typeof window&&be.setContext(window),this.setAnimationLoop=function(e){ye=e,de.setAnimationLoop(e),be.start()},this.render=function(e,t){var r,n;if(void 0!==arguments[2]&&(console.warn("WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),r=arguments[2]),void 0!==arguments[3]&&(console.warn("WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),n=arguments[3]),t&&t.isCamera){if(!U){j.geometry=null,j.program=null,j.wireframe=!1,z=-1,W=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),de.enabled&&(t=de.getCamera(t)),(v=E.get(e,t)).init(),e.onBeforeRender(I,e,t,r||k),se.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ie.setFromMatrix(se),oe=this.localClippingEnabled,ae=ne.init(this.clippingPlanes,oe,t),(m=P.get(e,t)).init(),we(e,t,0,I.sortObjects),!0===I.sortObjects&&m.sort(),ae&&ne.beginShadows();var o=v.state.shadowsArray;pe.render(o,e,t),v.setupLights(t),ae&&ne.endShadows(),this.info.autoReset&&this.info.reset(),void 0!==r&&this.setRenderTarget(r),D.render(m,e,t,n);var l=m.opaque,c=m.transparent;if(e.overrideMaterial){var h=e.overrideMaterial;l.length&&Me(l,e,t,h),c.length&&Me(c,e,t,h)}else l.length&&Me(l,e,t),c.length&&Me(c,e,t);null!==k&&(T.updateRenderTargetMipmap(k),T.updateMultisampleRenderTarget(k)),M.buffers.depth.setTest(!0),M.buffers.depth.setMask(!0),M.buffers.color.setMask(!0),M.setPolygonOffset(!1),e.onAfterRender(I,e,t),de.enabled&&de.submitFrame(),m=null,v=null}}else console.error("WebGLRenderer.render: camera is not an instance of Camera.")},this.allocTextureUnit=function(){var e=K;return e>=w.maxTextures&&console.warn("WebGLRenderer: Trying to use "+e+" texture units while this GPU supports only "+w.maxTextures),K+=1,e},this.setTexture2D=(xe=!1,function(e,slot){e&&e.isWebGLRenderTarget&&(xe||(console.warn("WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),xe=!0),e=e.texture),T.setTexture2D(e,slot)}),this.setTexture3D=function(e,slot){T.setTexture3D(e,slot)},this.setTexture=function(){var e=!1;return function(t,slot){e||(console.warn("WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),T.setTexture2D(t,slot)}}(),this.setTextureCube=function(){var e=!1;return function(t,slot){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?T.setTextureCube(t,slot):T.setTextureCubeDynamic(t,slot)}}(),this.setFramebuffer=function(e){V=e},this.getRenderTarget=function(){return k},this.setRenderTarget=function(e,t,r){k=e,e&&void 0===A.get(e).__webglFramebuffer&&T.setupRenderTarget(e);var n=V,o=!1;if(e){var l=A.get(e).__webglFramebuffer;e.isWebGLRenderTargetCube?(n=l[t||0],o=!0):n=e.isWebGLMultisampleRenderTarget?A.get(e).__webglMultisampledFramebuffer:l,X.copy(e.viewport),Y.copy(e.scissor),Q=e.scissorTest}else X.copy(ee).multiplyScalar($),Y.copy(te).multiplyScalar($),Q=re;if(G!==n&&(y.bindFramebuffer(y.FRAMEBUFFER,n),G=n),M.viewport(X),M.scissor(Y),M.setScissorTest(Q),o){var c=A.get(e.texture);y.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_CUBE_MAP_POSITIVE_X+t||0,c.__webglTexture,r||0)}},this.readRenderTargetPixels=function(e,t,r,n,o,l){if(e&&e.isWebGLRenderTarget){var c=A.get(e).__webglFramebuffer;if(c){var h=!1;c!==G&&(y.bindFramebuffer(y.FRAMEBUFFER,c),h=!0);try{var d=e.texture,f=d.format,m=d.type;if(f!==RGBAFormat&&B.convert(f)!==y.getParameter(y.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(m===UnsignedByteType||B.convert(m)===y.getParameter(y.IMPLEMENTATION_COLOR_READ_TYPE)||m===FloatType&&(w.isWebGL2||x.get("OES_texture_float")||x.get("WEBGL_color_buffer_float"))||m===HalfFloatType&&(w.isWebGL2?x.get("EXT_color_buffer_float"):x.get("EXT_color_buffer_half_float"))))return void console.error("WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");y.checkFramebufferStatus(y.FRAMEBUFFER)===y.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-n&&r>=0&&r<=e.height-o&&y.readPixels(t,r,n,o,B.convert(f),B.convert(m),l):console.error("WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{h&&y.bindFramebuffer(y.FRAMEBUFFER,G)}}}else console.error("WebGLRenderer.readRenderTargetPixels: renderTarget is not WebGLRenderTarget.")},this.copyFramebufferToTexture=function(e,t,r){var n=t.image.width,o=t.image.height,l=B.convert(t.format);this.setTexture2D(t,0),y.copyTexImage2D(y.TEXTURE_2D,r||0,l,e.x,e.y,n,o,0)},this.copyTextureToTexture=function(e,t,r,n){var o=t.image.width,l=t.image.height,c=B.convert(r.format),h=B.convert(r.type);this.setTexture2D(r,0),t.isDataTexture?y.texSubImage2D(y.TEXTURE_2D,n||0,e.x,e.y,o,l,c,h,t.image.data):y.texSubImage2D(y.TEXTURE_2D,n||0,e.x,e.y,c,h,t.image)}}function Uniform(e){"string"==typeof e&&(console.warn("Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}Uniform.prototype.clone=function(){return new Uniform(void 0===this.value.clone?this.value:this.value.clone())};var FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","","","","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","","#if (FXAA_PC == 1)","","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","","                    }","                    #endif","","                }","                #endif","","            }","            #endif","","        }","        #endif","","    }","    #endif","","                        }","                        #endif","","                    }","                    #endif","","                }","                #endif","","            }","            #endif","","        }","        #endif","","    }","","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")},WebGLDeferredRenderer=function(e){e=e||{};var t,r,n,o,l,c,h,d,f,m,v,y,x,w,M,S,A,T,_,L,C,N,P=this,E=!1,D=!1,F=!1,R=!1,O=new ShaderMaterial({visible:!1}),B=new Vector3,I={},U={},V={},k={},G={},z={},j={},W={},H={},X=60,Y={},Q={},K={};function J(e){var t,r,n,o=I[e.uuid],c=U[e.uuid];void 0===o&&((s=new Scene).userData.lights={},(o=De()).scene=s,I[e.uuid]=o);if(void 0===c){var s;(s=new Scene).userData.lights={};var h=(t=ShaderDeferred.emissiveLight,r=new ShaderMaterial({uniforms:Object.assign({},t.uniforms),vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,blending:NoBlending,depthWrite:!1}),(n=new Mesh(new PlaneBufferGeometry(2,2),r)).onBeforeRender=function(e,t,r,n,o,c){o.uniforms.samplerColor.value=l.renderTarget2.texture},n);s.userData.emissiveLight=h,s.add(h),(c=De()).scene=s,U[e.uuid]=c}o.used=!0,c.used=!0;var d=o.scene,f=c.scene;f.userData.emissiveLight.visible=!F,C=d,N=f}function Z(e,t,r,n){var data=t[e.uuid];return void 0===data&&((data=De()).material=r(e),t[e.uuid]=data),data.used=!0,n(data.material,e),Y[data.material.uuid]=e,data.material}function $(object,e,t){if(void 0!==object.material){if(Array.isArray(object.material))for(var i=0,r=object.material.length;i<r;i++)object.material[i]=e(object.material[i]);else object.material=e(object.material);object.onBeforeRender=t}}function ee(object){if(void 0!==object.material)if(Array.isArray(object.material))for(var i=0,e=object.material.length;i<e;i++)object.material[i]=Y[object.material[i].uuid];else object.material=Y[object.material.uuid]}function te(object){$(object,re,ae)}function re(e){return Z(e,F?k:V,ie,ne)}function ie(e){var t=F?ShaderDeferred.normalDepthShininess:ShaderDeferred.normalDepth;return new ShaderMaterial({uniforms:Object.assign({},t.uniforms),fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,blending:NoBlending})}function ne(e,t){void 0!==t.skinning&&(e.skinning=t.skinning),void 0!==t.morphTargets&&(e.morphTargets=t.morphTargets),!0===t.visible?e.visible=!t.transparent:e.visible=!1}function ae(e,t,r,n,o,l){if(F){var c=Y[o.uuid];void 0!==c&&void 0!==c.shininess&&(o.uniforms.shininess.value=c.shininess)}}function oe(object){$(object,se,ue)}function se(e){return Z(e,G,le,ce)}function le(e){var t=ShaderDeferred.color,r=new ShaderMaterial({uniforms:Object.assign({},t.uniforms),fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,blending:NoBlending});return void 0!==e.map&&(r.map=e.map),r}function ce(e,t){void 0!==t.map&&(e.map=t.map),void 0!==t.skinning&&(e.skinning=t.skinning),void 0!==t.morphTargets&&(e.morphTargets=t.morphTargets),!0===t.visible?e.visible=!t.transparent:e.visible=!1}function ue(e,t,r,n,o,l){var c,h,d=Y[o.uuid],f=o.uniforms;!0===d.isMeshBasicMaterial?h=d.color:(c=d.color,h=d.emissive);var m=d.specular,v=d.shininess,map=d.map;void 0!==c&&f.diffuse.value.copy(c),void 0!==h&&f.emissive.value.copy(h),void 0!==m&&f.specular.value.copy(m),void 0!==v&&void 0!==f.shininess&&(f.shininess.value=v),void 0!==map&&(f.map.value=map)}function he(object){$(object,de,me)}function de(e){return!0===e.transparent?(Y[e.uuid]=e,e):Z(e,z,pe,fe)}function pe(e){var t=ShaderDeferred.reconstruction,r=new ShaderMaterial({uniforms:Object.assign({},t.uniforms),fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,blending:NoBlending});return void 0!==e.map&&(r.map=e.map),r}function fe(e,t){ce(e,t)}function me(e,t,r,n,o,l){if(!0!==o.transparent)ue(0,0,0,0,o),o.uniforms.samplerLight.value=y.renderTarget2.texture;else{var c=Q[this.uuid];c&&c.call(this,e,t,r,n,o,l)}}function ve(object){if(void 0!==object.material)if(Array.isArray(object.material))for(var i=0,e=object.material.length;i<e;i++)void 0===K[object.material[i].uuid]&&(K[object.material[i].uuid]=object.material[i].visible,object.material[i].visible=object.material[i].transparent&&object.material[i].visible);else void 0===K[object.material.uuid]&&(K[object.material.uuid]=object.material.visible,object.material.visible=object.material.transparent&&object.material.visible)}function ge(object){if(void 0!==object.material)if(Array.isArray(object.material))for(var i=0,e=object.material.length;i<e;i++)object.material[i].visible=K[object.material[i].uuid];else object.material.visible=K[object.material.uuid]}function ye(e){return e.isPointLight?((t=Me(e,new SphereBufferGeometry(1,16,8))).onBeforeRender=Te,t):e.isSpotLight?function(e){var t=Me(e,new PlaneBufferGeometry(2,2));return t.onBeforeRender=_e,t}(e):e.isDirectionalLight?function(e){var t=Me(e,new PlaneBufferGeometry(2,2));return t.onBeforeRender=Le,t}(e):null;var t}function xe(e){return e.isPointLight?((t=Se(F?ShaderDeferred.pointLightPre:ShaderDeferred.pointLight)).side=BackSide,t.depthFunc=GreaterEqualDepth,t):e.isSpotLight?function(){var e=Se(F?ShaderDeferred.spotLightPre:ShaderDeferred.spotLight);return e.depthTest=!1,e}():e.isDirectionalLight?function(){var e=Se(F?ShaderDeferred.directionalLightPre:ShaderDeferred.directionalLight);return e.depthTest=!1,e}():null;var t}function be(e){var t=F?H:W,data=t[e.uuid];return void 0===data&&((data=De()).material=xe(e.userData.originalLight),t[e.uuid]=data),data.used=!0,data.material}function we(e){e.userData.originalLight.isPointLight&&function(e){var t=e.userData.originalLight,r=t.distance;r>0&&(e.scale.set(1,1,1).multiplyScalar(r),e.position.setFromMatrixPosition(t.matrixWorld))}(e)}function Me(e,t){var r=new Mesh(t,O);return r.userData.originalLight=e,r}function Se(e){var t=new ShaderMaterial({uniforms:Object.assign({},e.uniforms),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,transparent:!0,blending:AdditiveBlending,depthWrite:!1});return F&&(t.premultipliedAlpha=!0),t}function Ae(e){F?e.samplerNormalDepthShininess.value=v.renderTarget2.texture:(e.samplerNormalDepth.value=v.renderTarget2.texture,e.samplerColor.value=l.renderTarget2.texture)}function Te(e,t,r,n,o,l){var c=this.userData.originalLight,h=c.distance,d=o.uniforms;d.lightColor.value.copy(c.color),h>0?(d.lightRadius.value=h,d.lightIntensity.value=c.intensity,d.lightPositionVS.value.setFromMatrixPosition(c.matrixWorld).applyMatrix4(L.matrixWorldInverse)):d.lightRadius.value=1/0,Ae(d)}function _e(e,t,r,n,o,l){var c=this.userData.originalLight,h=this.material.uniforms;h.lightAngle.value=c.angle,h.lightColor.value.copy(c.color),h.lightIntensity.value=c.intensity,h.lightPositionVS.value.setFromMatrixPosition(c.matrixWorld).applyMatrix4(L.matrixWorldInverse);var d=h.lightDirectionVS.value,f=B;d.setFromMatrixPosition(c.matrixWorld),f.setFromMatrixPosition(c.target.matrixWorld),d.sub(f).normalize().transformDirection(L.matrixWorldInverse),Ae(h)}function Le(e,t,r,n,o,l){var c=this.userData.originalLight,h=this.material.uniforms;h.lightColor.value.copy(c.color),h.lightIntensity.value=c.intensity;var d=h.lightDirectionVS.value,f=B;d.setFromMatrixPosition(c.matrixWorld),f.setFromMatrixPosition(c.target.matrixWorld),d.sub(f).normalize().transformDirection(L.matrixWorldInverse),Ae(h)}function Ce(object){if(void 0!==object.material&&(Q[object.uuid]=object.onBeforeRender,!D&&!F&&object.visible))if(Array.isArray(object.material)){for(var i=0,e=object.material.length;i<e;i++)if(!0===object.material[i].visible&&!0===object.material[i].transparent){D=!0;break}}else!0===object.material.visible&&!0===object.material.transparent&&(D=!0)}function Ne(object){void 0!==object.material&&(object.onBeforeRender=Q[object.uuid])}function Pe(object){if(!0===object.isLight){var data=j[object.uuid];void 0===data&&((data=De()).light=ye(object),j[object.uuid]=data),data.used=!0;var e=data.light;if(null!==e){var t=!0===object.isPointLight?C:N,r=t.userData.lights;void 0===r[e.uuid]&&(t.add(e),r[e.uuid]={light:e,found:!0}),r[e.uuid].found=!0}}}function Ee(e){for(var t=e.userData.lights,r=Object.keys(t),i=0,n=r.length;i<n;i++){var o=r[i];if(!1===t[o].found)e.remove(t[o].light),delete t[o];else{var l=t[o].light;l.material=be(l),we(l),t[o].found=!1}}}function De(){return{used:!0,keepAlive:R,count:0}}function Fe(e){for(var t=Object.keys(e),i=0,r=t.length;i<r;i++){var n=t[i];!1===e[n].used?(e[n].count++,!1===e[n].keepAlive&&e[n].count>X&&delete e[n]):(e[n].used=!1,e[n].count=0)}}function Re(table){for(var e=Object.keys(table),i=0,t=e.length;i<t;i++){table[e[i]]=void 0}}function Oe(e,t){!F&&D&&(e.traverse(ve),e.traverse(Ne),h.scene=e,h.camera=t),F?(h.renderToScreen=!1,h.enabled=!1,d.renderToScreen=!1,d.enabled=!1,E?(A.renderToScreen=!1,T.renderToScreen=!0,T.enabled=!0):(A.renderToScreen=!0,T.renderToScreen=!1,T.enabled=!1)):D?E?(A.renderToScreen=!1,h.renderToScreen=!1,h.enabled=!0,d.renderToScreen=!1,d.enabled=!1,T.renderToScreen=!0,T.enabled=!0):(A.renderToScreen=!1,h.renderToScreen=!1,h.enabled=!0,d.renderToScreen=!0,d.enabled=!0,T.renderToScreen=!1,T.enabled=!1):E?(A.renderToScreen=!1,h.renderToScreen=!1,h.enabled=!1,d.renderToScreen=!1,d.enabled=!1,T.renderToScreen=!0,T.enabled=!0):(A.renderToScreen=!0,h.renderToScreen=!1,h.enabled=!1,d.renderToScreen=!1,d.enabled=!1,T.renderToScreen=!1,T.enabled=!1),P.renderer.autoClearDepth=!1,P.renderer.autoClearStencil=!1,x.render(),!F&&D&&e.traverse(ge)}this.renderer=void 0,this.domElement=void 0,this.forwardRendering=!1,this.setSize=function(e,t){n=e,o=t,this.renderer.setSize(n,o),v.setSize(n,o),l.setSize(n,o),y.setSize(n,o),f.setSize(n,o),x.setSize(n,o),_.image.width=n,_.image.height=o,_.needsUpdate=!0,T.uniforms.resolution.value.set(1/n,1/o)},this.setAntialias=function(e){E=e},this.enableLightPrePass=function(e){F=e,A.uniforms.samplerResult.value=F?f.renderTarget2.texture:y.renderTarget2.texture},this.render=function(e,h){if(this.forwardRendering)this.renderer.render(e,h);else{var d=e.autoUpdate,x=this.renderer.autoClearColor,A=this.renderer.autoClearDepth,T=this.renderer.autoClearStencil;L=h,J(e),e.autoUpdate=!1,e.updateMatrixWorld(),D=!1,e.traverse(Ce),function(e){var t=ShaderDeferredCommon.commonUniforms;t.viewWidth.value=n,t.viewHeight.value=o,t.matProjInverse.value.getInverse(e.projectionMatrix)}(h),function(e,n){e.traverse(te),w.scene=e,w.camera=n,P.renderer.autoClearDepth=!0,P.renderer.autoClearStencil=!0,r.buffers.stencil.setTest(!0),r.buffers.stencil.setFunc(t.ALWAYS,1,4294967295),r.buffers.stencil.setOp(t.REPLACE,t.REPLACE,t.REPLACE),v.render(),e.traverse(ee)}(e,h),F?(function(e,n){e.traverse(Pe),Ee(C),Ee(N),M.scene=C,M.camera=n,S.scene=N,P.renderer.autoClearDepth=!1,P.renderer.autoClearStencil=!1,r.buffers.stencil.setFunc(t.EQUAL,1,4294967295),r.buffers.stencil.setOp(t.KEEP,t.KEEP,t.KEEP),y.render()}(e,h),function(e,t){e.traverse(he),m.scene=e,m.camera=t,P.renderer.autoClearDepth=!1,P.renderer.autoClearStencil=!1,f.render(),r.buffers.stencil.setTest(!1),e.traverse(ee)}(e,h)):(function(e,n){e.traverse(oe),c.scene=e,c.camera=n,P.renderer.autoClearDepth=!1,P.renderer.autoClearStencil=!1,r.buffers.stencil.setFunc(t.EQUAL,1,4294967295),r.buffers.stencil.setOp(t.KEEP,t.KEEP,t.KEEP),l.render(),e.traverse(ee)}(e,h),function(e,t){e.traverse(Pe),Ee(C),Ee(N),M.scene=C,M.camera=t,S.scene=N,P.renderer.autoClearDepth=!1,P.renderer.autoClearStencil=!1,y.render(),r.buffers.stencil.setTest(!1)}(e,h)),Oe(e,h),e.traverse(Ne),Fe(I),Fe(U),Fe(V),Fe(k),Fe(G),Fe(z),Fe(W),Fe(H),Fe(j),Re(Y),Re(Q),Re(K),e.autoUpdate=d,this.renderer.autoClearColor=x,this.renderer.autoClearDepth=A,this.renderer.autoClearStencil=T}},function(e){P.renderer=void 0!==e.renderer?e.renderer:new WebGLRenderer,P.domElement=P.renderer.domElement,t=P.renderer.context,r=P.renderer.state,n=void 0!==e.width?e.width:P.renderer.getSize(new Vector2).width,o=void 0!==e.height?e.height:P.renderer.getSize(new Vector2).height;var L=void 0!==e.antialias&&e.antialias;void 0!==e.cacheKeepAlive&&(R=e.cacheKeepAlive),_=new DepthTexture(n,o,UnsignedInt248Type,void 0,void 0,void 0,void 0,void 0,void 0,DepthStencilFormat),function(){(w=new RenderPass).clear=!0;var rt=new WebGLRenderTarget(n,o,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat,type:FloatType,stencilBuffer:!0,depthTexture:_});rt.texture.generateMipamps=!1,(v=new EffectComposer(P.renderer,rt)).addPass(w)}(),function(){(c=new RenderPass).clear=!0;var rt=new WebGLRenderTarget(n,o,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat,type:FloatType,depthTexture:_});rt.texture.generateMipamps=!1,(l=new EffectComposer(P.renderer,rt)).addPass(c)}(),function(){(S=new RenderPass).clear=!0,S.camera=new OrthographicCamera(-1,1,1,-1,0,1),(M=new RenderPass).clear=!1;var rt=new WebGLRenderTarget(n,o,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat,type:FloatType,depthTexture:_});rt.texture.generateMipamps=!1,(y=new EffectComposer(P.renderer,rt)).addPass(S),y.addPass(M)}(),function(){(m=new RenderPass).clear=!0;var rt=new WebGLRenderTarget(n,o,{minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat,type:FloatType,depthTexture:_});rt.texture.generateMipamps=!1,(f=new EffectComposer(P.renderer,rt)).addPass(m)}(),function(){(A=new ShaderPass(ShaderDeferred.final)).clear=!0,A.uniforms.samplerResult.value=y.renderTarget2.texture,A.material.blending=NoBlending,A.material.depthWrite=!1,A.material.depthTest=!1,(h=new RenderPass).clear=!1,d=new ShaderPass(CopyShader),T=new ShaderPass(FXAAShader);var rt=new WebGLRenderTarget(n,o,{minFilter:NearestFilter,magFilter:LinearFilter,format:RGBFormat,type:UnsignedByteType,depthTexture:_});rt.texture.generateMipamps=!1,(x=new EffectComposer(P.renderer,rt)).addPass(A),x.addPass(h),x.addPass(d),x.addPass(T)}(),P.setSize(n,o),P.setAntialias(L),P.enableLightPrePass(!1)}(e)},DeferredShaderChunk={packVector3:["float vec3_to_float( vec3 data ) {","\tconst float unit = 255.0/256.0;","\thighp float compressed = fract( data.x * unit ) + floor( data.y * unit * 255.0 ) + floor( data.z * unit * 255.0 ) * 255.0;","\treturn compressed;","}"].join("\n"),unpackFloat:["vec3 float_to_vec3( float data ) {","\tconst float unit = 255.0;","\tvec3 uncompressed;","\tuncompressed.x = fract( data );","\tfloat zInt = floor( data / unit );","\tuncompressed.z = fract( zInt / unit );","\tuncompressed.y = fract( floor( data - ( zInt * unit ) ) / unit );","\treturn uncompressed;","}"].join("\n"),packNormal:["vec2 normal_to_vec2( vec3 normal ) {","\treturn normal.xy / sqrt( normal.z * 8.0 + 8.0 ) + 0.5;","}"].join("\n"),unpackVector2:["vec3 vec2_to_normal( vec2 data ) {","\tvec2 fenc = data * 4.0 - 2.0;","\tfloat f = dot( fenc, fenc );","\tfloat g = sqrt( 1.0 - f / 4.0 );","\tvec3 normal;","\tnormal.xy = fenc * g;","\tnormal.z = 1.0 - f / 2.0;","\treturn normal;","}"].join("\n"),computeTextureCoord:["vec2 texCoord = gl_FragCoord.xy / vec2( viewWidth, viewHeight );"].join("\n"),packNormalDepth:["vec4 packedNormalDepth;","packedNormalDepth.xyz = normal * 0.5 + 0.5;","packedNormalDepth.w = position.z / position.w;"].join("\n"),unpackNormalDepth:["vec4 normalDepthMap = texture2D( samplerNormalDepth, texCoord );","float depth = normalDepthMap.w;","if ( depth == 0.0 ) discard;","vec3 normal = normalDepthMap.xyz * 2.0 - 1.0;"].join("\n"),packNormalDepthShininess:["vec4 packedNormalDepthShininess;","packedNormalDepthShininess.xy = normal_to_vec2( normal );","packedNormalDepthShininess.z = shininess;","packedNormalDepthShininess.w = position.z / position.w;"].join("\n"),unpackNormalDepthShininess:["vec4 normalDepthMap = texture2D( samplerNormalDepthShininess, texCoord );","float depth = normalDepthMap.w;","if ( depth == 0.0 ) discard;","vec3 normal = vec2_to_normal( normalDepthMap.xy );","float shininess = normalDepthMap.z;"].join("\n"),packColor:["vec4 packedColor;","packedColor.x = vec3_to_float( diffuseColor.rgb );","packedColor.y = vec3_to_float( emissiveColor );","packedColor.z = vec3_to_float( specularColor );","packedColor.w = shininess;"].join("\n"),unpackColor:["vec4 colorMap = texture2D( samplerColor, texCoord );","vec3 diffuseColor = float_to_vec3( colorMap.x );","vec3 emissiveColor = float_to_vec3( colorMap.y );","vec3 specularColor = float_to_vec3( colorMap.z );","float shininess = colorMap.w;"].join("\n"),packLight:["vec4 packedLight;","packedLight.xyz = lightIntensity * lightColor * max( dot( lightVector, normal ), 0.0 ) * attenuation;","packedLight.w = lightIntensity * specular * max( dot( lightVector, normal ), 0.0 ) * attenuation;"].join("\n"),computeVertexPositionVS:["vec2 xy = texCoord * 2.0 - 1.0;","vec4 vertexPositionProjected = vec4( xy, depth, 1.0 );","vec4 vertexPositionVS = matProjInverse * vertexPositionProjected;","vertexPositionVS.xyz /= vertexPositionVS.w;","vertexPositionVS.w = 1.0;"].join("\n"),computeSpecular:["vec3 halfVector = normalize( lightVector - normalize( vertexPositionVS.xyz ) );","float dotNormalHalf = max( dot( normal, halfVector ), 0.0 );","float specular = 0.31830988618 * ( shininess * 0.5 + 1.0 ) * pow( dotNormalHalf, shininess );"].join("\n"),combine:["gl_FragColor = vec4( lightIntensity * lightColor * max( dot( lightVector, normal ), 0.0 ) * ( diffuseColor + specular * specularColor ) * attenuation, 1.0 );"].join("\n")},ShaderDeferredCommon={commonUniforms:{matProjInverse:new Uniform(new Matrix4),viewWidth:new Uniform(800),viewHeight:new Uniform(600)}},ShaderDeferred={normalDepth:{uniforms:{},vertexShader:["varying vec3 vNormal;","varying vec4 vPosition;","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","void main() {","#include <begin_vertex>","#include <beginnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","\tvNormal = normalize( transformedNormal );","\tvPosition = gl_Position;","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","varying vec4 vPosition;","void main() {","\tvec3 normal = vNormal;","\tvec4 position = vPosition;",DeferredShaderChunk.packNormalDepth,"\tgl_FragColor = packedNormalDepth;","}"].join("\n")},color:{uniforms:{map:new Uniform(null),offsetRepeat:new Uniform(new Vector4(0,0,1,1)),diffuse:new Uniform(new Color(0)),emissive:new Uniform(new Color(0)),specular:new Uniform(new Color(0)),shininess:new Uniform(30)},vertexShader:["#include <uv_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","void main() {","#include <uv_vertex>","#include <begin_vertex>","#include <beginnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","#include <uv_pars_fragment>","#include <map_pars_fragment>",DeferredShaderChunk.packVector3,"void main() {","\tvec4 diffuseColor = vec4( diffuse, 1.0 );","\tvec3 emissiveColor = emissive;","\tvec3 specularColor = specular;","#include <map_fragment>",DeferredShaderChunk.packColor,"\tgl_FragColor = packedColor;","}"].join("\n")},emissiveLight:{uniforms:Object.assign({samplerColor:new Uniform(null)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() { ","\tgl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerColor;","uniform float viewHeight;","uniform float viewWidth;",DeferredShaderChunk.unpackFloat,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackColor,"\tgl_FragColor = vec4( emissiveColor, 1.0 );","}"].join("\n")},pointLight:{uniforms:Object.assign({samplerNormalDepth:new Uniform(null),samplerColor:new Uniform(null),lightColor:new Uniform(new Color(0)),lightPositionVS:new Uniform(new Vector3(0,1,0)),lightIntensity:new Uniform(1),lightRadius:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() {","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepth;","uniform sampler2D samplerColor;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform float lightIntensity;","uniform float lightRadius;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepth,DeferredShaderChunk.computeVertexPositionVS,"\tvec3 lightVector = lightPositionVS - vertexPositionVS.xyz;","\tfloat distance = length( lightVector );","\tif ( distance > lightRadius ) discard;","\tlightVector = normalize( lightVector );",DeferredShaderChunk.unpackColor,DeferredShaderChunk.computeSpecular,"\t//float cutoff = 0.3;","\t//float denom = distance / lightRadius + 1.0;","\t//float attenuation = 1.0 / ( denom * denom );","\t//attenuation = ( attenuation - cutoff ) / ( 1.0 - cutoff );","\t//attenuation = max( attenuation, 0.0 );","\t//attenuation *= attenuation;","\t//diffuseColor *= saturate( -distance / lightRadius + 1.0 );","\t//float attenuation = 1.0;","\tfloat attenuation = saturate( -distance / lightRadius + 1.0 );",DeferredShaderChunk.combine,"}"].join("\n")},spotLight:{uniforms:Object.assign({samplerNormalDepth:new Uniform(null),samplerColor:new Uniform(null),lightColor:new Uniform(new Color(0)),lightDirectionVS:new Uniform(new Vector3(0,1,0)),lightPositionVS:new Uniform(new Vector3(0,1,0)),lightAngle:new Uniform(1),lightIntensity:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() { ","\tgl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepth;","uniform sampler2D samplerColor;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform vec3 lightDirectionVS;","uniform float lightAngle;","uniform float lightIntensity;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepth,DeferredShaderChunk.computeVertexPositionVS,DeferredShaderChunk.unpackColor,"\tvec3 lightVector = normalize( lightPositionVS.xyz - vertexPositionVS.xyz );","\tfloat rho = dot( lightDirectionVS, lightVector );","\tfloat rhoMax = cos( lightAngle );","\tif ( rho <= rhoMax ) discard;","\tfloat theta = rhoMax + 0.0001;","\tfloat phi = rhoMax + 0.05;","\tfloat falloff = 4.0;","\tfloat spot = 0.0;","\tif ( rho >= phi ) {","\t\tspot = 1.0;","\t} else if ( rho <= theta ) {","\t\tspot = 0.0;","\t} else { ","\t\tspot = pow( ( rho - theta ) / ( phi - theta ), falloff );","\t}","\tdiffuseColor *= spot;",DeferredShaderChunk.computeSpecular,"\tconst float attenuation = 1.0;",DeferredShaderChunk.combine,"}"].join("\n")},directionalLight:{uniforms:Object.assign({samplerNormalDepth:new Uniform(null),samplerColor:new Uniform(null),lightColor:new Uniform(new Color(0)),lightDirectionVS:new Uniform(new Vector3(0,1,0)),lightIntensity:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() { ","\tgl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepth;","uniform sampler2D samplerColor;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightDirectionVS;","uniform float lightIntensity;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepth,DeferredShaderChunk.computeVertexPositionVS,DeferredShaderChunk.unpackColor,"\tvec3 lightVector = normalize( lightDirectionVS );",DeferredShaderChunk.computeSpecular,"\tconst float attenuation = 1.0;",DeferredShaderChunk.combine,"}"].join("\n")},normalDepthShininess:{uniforms:{shininess:new Uniform(30)},vertexShader:["varying vec3 vNormal;","varying vec4 vPosition;","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","void main() {","#include <begin_vertex>","#include <beginnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","\tvNormal = normalize( transformedNormal );","\tvPosition = gl_Position;","}"].join("\n"),fragmentShader:["varying vec3 vNormal;","varying vec4 vPosition;","uniform float shininess;",DeferredShaderChunk.packNormal,"void main() {","\tvec3 normal = vNormal;","\tvec4 position = vPosition;",DeferredShaderChunk.packNormalDepthShininess,"\tgl_FragColor = packedNormalDepthShininess;","}"].join("\n")},pointLightPre:{uniforms:Object.assign({samplerNormalDepthShininess:new Uniform(null),lightColor:new Uniform(new Color(0)),lightPositionVS:new Uniform(new Vector3(0,1,0)),lightIntensity:new Uniform(1),lightRadius:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() {","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepthShininess;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform float lightIntensity;","uniform float lightRadius;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,DeferredShaderChunk.unpackVector2,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepthShininess,DeferredShaderChunk.computeVertexPositionVS,"\tvec3 lightVector = lightPositionVS - vertexPositionVS.xyz;","\tfloat distance = length( lightVector );","\tif ( distance > lightRadius ) discard;","\tlightVector = normalize( lightVector );",DeferredShaderChunk.computeSpecular,"\tfloat attenuation = saturate( -distance / lightRadius + 1.0 );",DeferredShaderChunk.packLight,"\tgl_FragColor = packedLight;","}"].join("\n")},spotLightPre:{uniforms:Object.assign({samplerNormalDepthShininess:new Uniform(null),lightColor:new Uniform(new Color(0)),lightDirectionVS:new Uniform(new Vector3(0,1,0)),lightPositionVS:new Uniform(new Vector3(0,1,0)),lightAngle:new Uniform(1),lightIntensity:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() { ","\tgl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepthShininess;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightPositionVS;","uniform vec3 lightDirectionVS;","uniform float lightAngle;","uniform float lightIntensity;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,DeferredShaderChunk.unpackVector2,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepthShininess,DeferredShaderChunk.computeVertexPositionVS,"\tvec3 lightVector = normalize( lightPositionVS.xyz - vertexPositionVS.xyz );","\tfloat rho = dot( lightDirectionVS, lightVector );","\tfloat rhoMax = cos( lightAngle );","\tif ( rho <= rhoMax ) discard;","\tfloat theta = rhoMax + 0.0001;","\tfloat phi = rhoMax + 0.05;","\tfloat falloff = 4.0;","\tfloat spot = 0.0;","\tif ( rho >= phi ) {","\t\tspot = 1.0;","\t} else if ( rho <= theta ) {","\t\tspot = 0.0;","\t} else { ","\t\tspot = pow( ( rho - theta ) / ( phi - theta ), falloff );","\t}",DeferredShaderChunk.computeSpecular,"\tconst float attenuation = 1.0;",DeferredShaderChunk.packLight,"\tgl_FragColor = spot * packedLight;","}"].join("\n")},directionalLightPre:{uniforms:Object.assign({samplerNormalDepthShininess:new Uniform(null),lightColor:new Uniform(new Color(0)),lightDirectionVS:new Uniform(new Vector3(0,1,0)),lightIntensity:new Uniform(1)},ShaderDeferredCommon.commonUniforms),vertexShader:["void main() { ","\tgl_Position = vec4( sign( position.xy ), 0.0, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D samplerNormalDepthShininess;","uniform float viewHeight;","uniform float viewWidth;","uniform vec3 lightColor;","uniform vec3 lightDirectionVS;","uniform float lightIntensity;","uniform mat4 matProjInverse;",DeferredShaderChunk.unpackFloat,DeferredShaderChunk.unpackVector2,"void main() {",DeferredShaderChunk.computeTextureCoord,DeferredShaderChunk.unpackNormalDepthShininess,DeferredShaderChunk.computeVertexPositionVS,"\tvec3 lightVector = normalize( lightDirectionVS );",DeferredShaderChunk.computeSpecular,"\tconst float attenuation = 1.0;",DeferredShaderChunk.packLight,"\tgl_FragColor = packedLight;","}"].join("\n")},reconstruction:{uniforms:Object.assign({samplerLight:new Uniform(null),map:new Uniform(null),offsetRepeat:new Uniform(new Vector4(0,0,1,1)),diffuse:new Uniform(new Color(0)),emissive:new Uniform(new Color(0)),specular:new Uniform(new Color(0)),shininess:new Uniform(30)},ShaderDeferredCommon.commonUniforms),vertexShader:["#include <uv_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","void main() {","#include <uv_vertex>","#include <begin_vertex>","#include <beginnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","}"].join("\n"),fragmentShader:["uniform sampler2D samplerLight;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float viewHeight;","uniform float viewWidth;","#include <uv_pars_fragment>","#include <map_pars_fragment>",DeferredShaderChunk.unpackFloat,"void main() {","\tvec4 diffuseColor = vec4( diffuse, 1.0 );","\tvec3 emissiveColor = emissive;","\tvec3 specularColor = specular;",DeferredShaderChunk.computeTextureCoord,"\tvec4 light = texture2D( samplerLight, texCoord );","#include <map_fragment>","\tvec3 diffuseFinal = diffuseColor.rgb * light.rgb;","\tvec3 emissiveFinal = emissiveColor;","\tvec3 specularFinal = specularColor * light.rgb * light.a;","\tgl_FragColor = vec4( diffuseFinal + emissiveFinal + specularFinal, 1.0 );","}"].join("\n")},final:{uniforms:{samplerResult:new Uniform(null)},vertexShader:["varying vec2 texCoord;","void main() {","\tvec4 pos = vec4( sign( position.xy ), 0.0, 1.0 );","\ttexCoord = pos.xy * vec2( 0.5 ) + 0.5;","\tgl_Position = pos;","}"].join("\n"),fragmentShader:["varying vec2 texCoord;","uniform sampler2D samplerResult;","void main() {","\tgl_FragColor = texture2D( samplerResult, texCoord );","}"].join("\n")}};function RollerCoasterGeometry(e,t){BufferGeometry.call(this);var r=[],n=[],o=[],l=[1,1,1],c=[1,1,0],h=new Vector3(0,1,0),d=new Vector3,f=new Vector3,m=new Quaternion,v=new Quaternion;v.setFromAxisAngle(h,Math.PI/2);var y=new Vector3,x=new Vector3;x.copy(e.getPointAt(0));for(var w=[new Vector3(-.225,0,0),new Vector3(0,-.05,0),new Vector3(0,-.175,0),new Vector3(0,-.05,0),new Vector3(.225,0,0),new Vector3(0,-.175,0)],M=2*Math.PI,S=5,A=[],i=0;i<S;i++){var T=i/S*M;A.push(new Vector3(.06*Math.sin(T),.06*Math.cos(T),0))}S=6;var _=[];for(i=0;i<S;i++){T=i/S*M;_.push(new Vector3(.025*Math.sin(T),.025*Math.cos(T),0))}var L=new Vector3,C=new Vector3;function N(e,t){C.set(0,0,-1).applyQuaternion(m);for(var l=0;l<e.length;l++)L.copy(e[l]),L.applyQuaternion(m),L.add(y),r.push(L.x,L.y,L.z),n.push(C.x,C.y,C.z),o.push(t[0],t[1],t[2]);C.set(0,0,1).applyQuaternion(m);for(l=e.length-1;l>=0;l--)L.copy(e[l]),L.applyQuaternion(m),L.add(y),r.push(L.x,L.y,L.z),n.push(C.x,C.y,C.z),o.push(t[0],t[1],t[2])}var P=new Vector3,E=new Vector3,D=new Vector3,F=new Vector3,R=new Vector3,O=new Vector3,B=new Vector3,I=new Vector3;function U(e,t,l){for(var c=0,h=e.length;c<h;c++){var d=e[c],f=e[(c+1)%h];P.copy(d).add(t),P.applyQuaternion(m),P.add(y),E.copy(f).add(t),E.applyQuaternion(m),E.add(y),D.copy(f).add(t),D.applyQuaternion(v),D.add(x),F.copy(d).add(t),F.applyQuaternion(v),F.add(x),r.push(P.x,P.y,P.z),r.push(E.x,E.y,E.z),r.push(F.x,F.y,F.z),r.push(E.x,E.y,E.z),r.push(D.x,D.y,D.z),r.push(F.x,F.y,F.z),R.copy(d),R.applyQuaternion(m),R.normalize(),O.copy(f),O.applyQuaternion(m),O.normalize(),B.copy(f),B.applyQuaternion(v),B.normalize(),I.copy(d),I.applyQuaternion(v),I.normalize(),n.push(R.x,R.y,R.z),n.push(O.x,O.y,O.z),n.push(I.x,I.y,I.z),n.push(O.x,O.y,O.z),n.push(B.x,B.y,B.z),n.push(I.x,I.y,I.z),o.push(l[0],l[1],l[2]),o.push(l[0],l[1],l[2]),o.push(l[0],l[1],l[2]),o.push(l[0],l[1],l[2]),o.push(l[0],l[1],l[2]),o.push(l[0],l[1],l[2])}}var V=new Vector3;for(i=1;i<=t;i++){y.copy(e.getPointAt(i/t)),h.set(0,1,0),d.subVectors(y,x).normalize(),f.crossVectors(h,d).normalize(),h.crossVectors(d,f);T=Math.atan2(d.x,d.z);m.setFromAxisAngle(h,T),i%2==0&&N(w,c),U(A,V.set(0,-.125,0),c),U(_,V.set(.2,0,0),l),U(_,V.set(-.2,0,0),l),x.copy(y),v.copy(m)}this.addAttribute("position",new BufferAttribute(new Float32Array(r),3)),this.addAttribute("normal",new BufferAttribute(new Float32Array(n),3)),this.addAttribute("color",new BufferAttribute(new Float32Array(o),3))}function RollerCoasterLiftersGeometry(e,t){BufferGeometry.call(this);var r=[],n=[],o=new Quaternion,l=new Vector3(0,1,0),c=new Vector3,h=new Vector3,d=[new Vector3(0,.05,-.05),new Vector3(0,.05,.05),new Vector3(0,-.05,0)],f=[new Vector3(-.05,0,.05),new Vector3(-.05,0,-.05),new Vector3(.05,0,0)],m=[new Vector3(.05,0,-.05),new Vector3(.05,0,.05),new Vector3(-.05,0,0)],v=new Vector3,y=new Vector3,x=new Vector3,w=new Vector3,M=new Vector3,S=new Vector3,A=new Vector3,T=new Vector3;function _(e,t,l){for(var c=0,h=e.length;c<h;c++){var d=e[c],f=e[(c+1)%h];v.copy(d),v.applyQuaternion(o),v.add(t),y.copy(f),y.applyQuaternion(o),y.add(t),x.copy(f),x.applyQuaternion(o),x.add(l),w.copy(d),w.applyQuaternion(o),w.add(l),r.push(v.x,v.y,v.z),r.push(y.x,y.y,y.z),r.push(w.x,w.y,w.z),r.push(y.x,y.y,y.z),r.push(x.x,x.y,x.z),r.push(w.x,w.y,w.z),M.copy(d),M.applyQuaternion(o),M.normalize(),S.copy(f),S.applyQuaternion(o),S.normalize(),A.copy(f),A.applyQuaternion(o),A.normalize(),T.copy(d),T.applyQuaternion(o),T.normalize(),n.push(M.x,M.y,M.z),n.push(S.x,S.y,S.z),n.push(T.x,T.y,T.z),n.push(S.x,S.y,S.z),n.push(A.x,A.y,A.z),n.push(T.x,T.y,T.z)}}for(var L=new Vector3,C=new Vector3,i=1;i<=t;i++){c.copy(e.getPointAt(i/t)),h.copy(e.getTangentAt(i/t));var N=Math.atan2(h.x,h.z);o.setFromAxisAngle(l,N),c.y>10?(L.set(-.75,-.35,0),L.applyQuaternion(o),L.add(c),C.set(.75,-.35,0),C.applyQuaternion(o),C.add(c),_(d,L,C),L.set(-.7,-.3,0),L.applyQuaternion(o),L.add(c),C.set(-.7,-c.y,0),C.applyQuaternion(o),C.add(c),_(f,L,C),L.set(.7,-.3,0),L.applyQuaternion(o),L.add(c),C.set(.7,-c.y,0),C.applyQuaternion(o),C.add(c),_(m,L,C)):(L.set(0,-.2,0),L.applyQuaternion(o),L.add(c),C.set(0,-c.y,0),C.applyQuaternion(o),C.add(c),_(m,L,C))}this.addAttribute("position",new BufferAttribute(new Float32Array(r),3)),this.addAttribute("normal",new BufferAttribute(new Float32Array(n),3))}function RollerCoasterShadowGeometry(e,t){BufferGeometry.call(this);var r=[],n=new Vector3(0,1,0),o=new Vector3,l=new Quaternion,c=new Quaternion;c.setFromAxisAngle(n,Math.PI/2);var h=new Vector3,d=new Vector3;d.copy(e.getPointAt(0)),d.y=0;for(var f=new Vector3,m=new Vector3,v=new Vector3,y=new Vector3,i=1;i<=t;i++){h.copy(e.getPointAt(i/t)),h.y=0,o.subVectors(h,d);var x=Math.atan2(o.x,o.z);l.setFromAxisAngle(n,x),f.set(-.3,0,0),f.applyQuaternion(l),f.add(h),m.set(.3,0,0),m.applyQuaternion(l),m.add(h),v.set(.3,0,0),v.applyQuaternion(c),v.add(d),y.set(-.3,0,0),y.applyQuaternion(c),y.add(d),r.push(f.x,f.y,f.z),r.push(m.x,m.y,m.z),r.push(y.x,y.y,y.z),r.push(m.x,m.y,m.z),r.push(v.x,v.y,v.z),r.push(y.x,y.y,y.z),d.copy(h),c.copy(l)}this.addAttribute("position",new BufferAttribute(new Float32Array(r),3))}function SkyGeometry(){BufferGeometry.call(this);for(var e=[],i=0;i<100;i++){var t=800*Math.random()-400,r=50*Math.random()+50,n=800*Math.random()-400,o=40*Math.random()+20;e.push(t-o,r,n-o),e.push(t+o,r,n-o),e.push(t-o,r,n+o),e.push(t+o,r,n-o),e.push(t+o,r,n+o),e.push(t-o,r,n+o)}this.addAttribute("position",new BufferAttribute(new Float32Array(e),3))}function TreesGeometry(e){BufferGeometry.call(this);var t=[],r=[],n=new Raycaster;n.ray.direction.set(0,-1,0);for(var i=0;i<2e3;i++){var o=500*Math.random()-250,l=500*Math.random()-250;n.ray.origin.set(o,50,l);var c=n.intersectObject(e);if(0!==c.length){var h=c[0].point.y,d=5*Math.random()+.5,f=Math.random()*Math.PI*2;t.push(o+Math.sin(f),h,l+Math.cos(f)),t.push(o,h+d,l),t.push(o+Math.sin(f+Math.PI),h,l+Math.cos(f+Math.PI)),f+=Math.PI/2,t.push(o+Math.sin(f),h,l+Math.cos(f)),t.push(o,h+d,l),t.push(o+Math.sin(f+Math.PI),h,l+Math.cos(f+Math.PI));for(var m=.1*Math.random(),v=0;v<6;v++)r.push(.2+m,.4+m,0)}}this.addAttribute("position",new BufferAttribute(new Float32Array(t),3)),this.addAttribute("color",new BufferAttribute(new Float32Array(r),3))}RollerCoasterGeometry.prototype=Object.create(BufferGeometry.prototype),RollerCoasterLiftersGeometry.prototype=Object.create(BufferGeometry.prototype),RollerCoasterShadowGeometry.prototype=Object.create(BufferGeometry.prototype),SkyGeometry.prototype=Object.create(BufferGeometry.prototype),TreesGeometry.prototype=Object.create(BufferGeometry.prototype);var ShaderGodRays={godrays_depthMask:{uniforms:{tInput:{value:null}},vertexShader:["varying vec2 vUv;","void main() {"," vUv = uv;"," gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tInput;","void main() {","\tgl_FragColor = vec4( 1.0 ) - texture2D( tInput, vUv );","}"].join("\n")},godrays_generate:{uniforms:{tInput:{value:null},fStepSize:{value:1},vSunPositionScreenSpace:{value:new Vector2(.5,.5)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define TAPS_PER_PASS 6.0","varying vec2 vUv;","uniform sampler2D tInput;","uniform vec2 vSunPositionScreenSpace;","uniform float fStepSize;","void main() {","vec2 delta = vSunPositionScreenSpace - vUv;","float dist = length( delta );","vec2 stepv = fStepSize * delta / dist;","float iters = dist/fStepSize;","vec2 uv = vUv.xy;","float col = 0.0;","if ( 0.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","if ( 1.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","if ( 2.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","if ( 3.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","if ( 4.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","if ( 5.0 <= iters && uv.y < 1.0 ) col += texture2D( tInput, uv ).r;","uv += stepv;","gl_FragColor = vec4( col/TAPS_PER_PASS );","gl_FragColor.a = 1.0;","}"].join("\n")},godrays_combine:{uniforms:{tColors:{value:null},tGodRays:{value:null},fGodRayIntensity:{value:.69},vSunPositionScreenSpace:{value:new Vector2(.5,.5)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tColors;","uniform sampler2D tGodRays;","uniform vec2 vSunPositionScreenSpace;","uniform float fGodRayIntensity;","void main() {","gl_FragColor = texture2D( tColors, vUv ) + fGodRayIntensity * vec4( 1.0 - texture2D( tGodRays, vUv ).r );","gl_FragColor.a = 1.0;","}"].join("\n")},godrays_fake_sun:{uniforms:{vSunPositionScreenSpace:{value:new Vector2(.5,.5)},fAspect:{value:1},sunColor:{value:new Color(16772608)},bgColor:{value:new Color(0)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform vec2 vSunPositionScreenSpace;","uniform float fAspect;","uniform vec3 sunColor;","uniform vec3 bgColor;","void main() {","vec2 diff = vUv - vSunPositionScreenSpace;","diff.x *= fAspect;","float prop = clamp( length( diff ) / 0.5, 0.0, 1.0 );","prop = 0.35 * pow( 1.0 - prop, 3.0 );","gl_FragColor.xyz = mix( sunColor, bgColor, 1.0 - prop );","gl_FragColor.w = 1.0;","}"].join("\n")}},BasicShader={uniforms:{},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["void main() {","gl_FragColor = vec4( 1.0, 0.0, 0.0, 0.5 );","}"].join("\n")},BleachBypassShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 base = texture2D( tDiffuse, vUv );","vec3 lumCoeff = vec3( 0.25, 0.65, 0.1 );","float lum = dot( lumCoeff, base.rgb );","vec3 blend = vec3( lum );","float L = min( 1.0, max( 0.0, 10.0 * ( lum - 0.45 ) ) );","vec3 result1 = 2.0 * base.rgb * blend;","vec3 result2 = 1.0 - 2.0 * ( 1.0 - blend ) * ( 1.0 - base.rgb );","vec3 newColor = mix( result1, result2, L );","float A2 = opacity * base.a;","vec3 mixRGB = A2 * newColor.rgb;","mixRGB += ( ( 1.0 - A2 ) * base.rgb );","gl_FragColor = vec4( mixRGB, base.a );","}"].join("\n")},BlendShader={uniforms:{tDiffuse1:{value:null},tDiffuse2:{value:null},mixRatio:{value:.5},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform float mixRatio;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec4 texel1 = texture2D( tDiffuse1, vUv );","vec4 texel2 = texture2D( tDiffuse2, vUv );","gl_FragColor = opacity * mix( texel1, texel2, mixRatio );","}"].join("\n")},BrightnessContrastShader={uniforms:{tDiffuse:{value:null},brightness:{value:0},contrast:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float brightness;","uniform float contrast;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb += brightness;","if (contrast > 0.0) {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - contrast) + 0.5;","} else {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + contrast) + 0.5;","}","}"].join("\n")},ColorCorrectionShader={uniforms:{tDiffuse:{value:null},powRGB:{value:new Vector3(2,2,2)},mulRGB:{value:new Vector3(1,1,1)},addRGB:{value:new Vector3(0,0,0)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 powRGB;","uniform vec3 mulRGB;","uniform vec3 addRGB;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb = mulRGB * pow( ( gl_FragColor.rgb + addRGB ), powRGB );","}"].join("\n")},ColorifyShader={uniforms:{tDiffuse:{value:null},color:{value:new Color(16777215)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","gl_FragColor = vec4( v * color, texel.w );","}"].join("\n")},DOFMipMapShader={uniforms:{tColor:{value:null},tDepth:{value:null},focus:{value:1},maxblur:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float focus;","uniform float maxblur;","uniform sampler2D tColor;","uniform sampler2D tDepth;","varying vec2 vUv;","void main() {","vec4 depth = texture2D( tDepth, vUv );","float factor = depth.x - focus;","vec4 col = texture2D( tColor, vUv, 2.0 * maxblur * abs( focus - depth.x ) );","gl_FragColor = col;","gl_FragColor.a = 1.0;","}"].join("\n")},FocusShader={uniforms:{tDiffuse:{value:null},screenWidth:{value:1024},screenHeight:{value:1024},sampleDistance:{value:.94},waveFactor:{value:.00125}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float screenWidth;","uniform float screenHeight;","uniform float sampleDistance;","uniform float waveFactor;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color, org, tmp, add;","float sample_dist, f;","vec2 vin;","vec2 uv = vUv;","add = color = org = texture2D( tDiffuse, uv );","vin = ( uv - vec2( 0.5 ) ) * vec2( 1.4 );","sample_dist = dot( vin, vin ) * 2.0;","f = ( waveFactor * 100.0 + sample_dist ) * sampleDistance * 4.0;","vec2 sampleSize = vec2(  1.0 / screenWidth, 1.0 / screenHeight ) * vec2( f );","add += tmp = texture2D( tDiffuse, uv + vec2( 0.111964, 0.993712 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.846724, 0.532032 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.943883, -0.330279 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.330279, -0.943883 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.532032, -0.846724 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.993712, -0.111964 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.707107, 0.707107 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","color = color * vec4( 2.0 ) - ( add / vec4( 8.0 ) );","color = color + ( add / vec4( 8.0 ) - color ) * ( vec4( 1.0 ) - vec4( sample_dist * 0.5 ) );","gl_FragColor = vec4( color.rgb * color.rgb * vec3( 0.95 ) + color.rgb, 1.0 );","}"].join("\n")},FreiChenShader={uniforms:{tDiffuse:{value:null},aspect:{value:new Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","mat3 G[9];","const mat3 g0 = mat3( 0.3535533845424652, 0, -0.3535533845424652, 0.5, 0, -0.5, 0.3535533845424652, 0, -0.3535533845424652 );","const mat3 g1 = mat3( 0.3535533845424652, 0.5, 0.3535533845424652, 0, 0, 0, -0.3535533845424652, -0.5, -0.3535533845424652 );","const mat3 g2 = mat3( 0, 0.3535533845424652, -0.5, -0.3535533845424652, 0, 0.3535533845424652, 0.5, -0.3535533845424652, 0 );","const mat3 g3 = mat3( 0.5, -0.3535533845424652, 0, -0.3535533845424652, 0, 0.3535533845424652, 0, 0.3535533845424652, -0.5 );","const mat3 g4 = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","const mat3 g5 = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","const mat3 g6 = mat3( 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.6666666865348816, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204 );","const mat3 g7 = mat3( -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, 0.6666666865348816, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408 );","const mat3 g8 = mat3( 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408 );","void main(void)","{","G[0] = g0,","G[1] = g1,","G[2] = g2,","G[3] = g3,","G[4] = g4,","G[5] = g5,","G[6] = g6,","G[7] = g7,","G[8] = g8;","mat3 I;","float cnv[9];","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","gl_FragColor = vec4(vec3(sqrt(M/S)), 1.0);","}"].join("\n")},FresnelShader={uniforms:{mRefractionRatio:{value:1.02},mFresnelBias:{value:.1},mFresnelPower:{value:2},mFresnelScale:{value:1},tCube:{value:null}},vertexShader:["uniform float mRefractionRatio;","uniform float mFresnelBias;","uniform float mFresnelScale;","uniform float mFresnelPower;","varying vec3 vReflect;","varying vec3 vRefract[3];","varying float vReflectionFactor;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec3 worldNormal = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );","vec3 I = worldPosition.xyz - cameraPosition;","vReflect = reflect( I, worldNormal );","vRefract[0] = refract( normalize( I ), worldNormal, mRefractionRatio );","vRefract[1] = refract( normalize( I ), worldNormal, mRefractionRatio * 0.99 );","vRefract[2] = refract( normalize( I ), worldNormal, mRefractionRatio * 0.98 );","vReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), worldNormal ), mFresnelPower );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","varying vec3 vReflect;","varying vec3 vRefract[3];","varying float vReflectionFactor;","void main() {","vec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","vec4 refractedColor = vec4( 1.0 );","refractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;","refractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;","refractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;","gl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );","}"].join("\n")},GammaCorrectionShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 tex = texture2D( tDiffuse, vec2( vUv.x, vUv.y ) );","gl_FragColor = LinearToGamma( tex, float( GAMMA_FACTOR ) );","}"].join("\n")},HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},HorizontalTiltShiftShader={uniforms:{tDiffuse:{value:null},h:{value:1/512},r:{value:.35}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float hh = h * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * hh, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * hh, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},HueSaturationShader={uniforms:{tDiffuse:{value:null},hue:{value:0},saturation:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float hue;","uniform float saturation;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","float angle = hue * 3.14159265;","float s = sin(angle), c = cos(angle);","vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","float len = length(gl_FragColor.rgb);","gl_FragColor.rgb = vec3(","dot(gl_FragColor.rgb, weights.xyz),","dot(gl_FragColor.rgb, weights.zxy),","dot(gl_FragColor.rgb, weights.yzx)",");","float average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;","if (saturation > 0.0) {","gl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - saturation));","} else {","gl_FragColor.rgb += (average - gl_FragColor.rgb) * (-saturation);","}","}"].join("\n")},KaleidoShader={uniforms:{tDiffuse:{value:null},sides:{value:6},angle:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float sides;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 p = vUv - 0.5;","float r = length(p);","float a = atan(p.y, p.x) + angle;","float tau = 2. * 3.1416 ;","a = mod(a, tau/sides);","a = abs(a - tau/sides/2.) ;","p = r * vec2(cos(a), sin(a));","vec4 color = texture2D(tDiffuse, p + 0.5);","gl_FragColor = color;","}"].join("\n")},MirrorShader={uniforms:{tDiffuse:{value:null},side:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform int side;","varying vec2 vUv;","void main() {","vec2 p = vUv;","if (side == 0){","if (p.x > 0.5) p.x = 1.0 - p.x;","}else if (side == 1){","if (p.x < 0.5) p.x = 1.0 - p.x;","}else if (side == 2){","if (p.y < 0.5) p.y = 1.0 - p.y;","}else if (side == 3){","if (p.y > 0.5) p.y = 1.0 - p.y;","} ","vec4 color = texture2D(tDiffuse, p);","gl_FragColor = color;","}"].join("\n")},NormalMapShader={uniforms:{heightMap:{value:null},resolution:{value:new Vector2(512,512)},scale:{value:new Vector2(1,1)},height:{value:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D( heightMap, vUv ).x;","float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;","float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;","gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );","}"].join("\n")},ParallaxShader={modes:{none:"NO_PARALLAX",basic:"USE_BASIC_PARALLAX",steep:"USE_STEEP_PARALLAX",occlusion:"USE_OCLUSION_PARALLAX",relief:"USE_RELIEF_PARALLAX"},uniforms:{bumpMap:{value:null},map:{value:null},parallaxScale:{value:null},parallaxMinLayers:{value:null},parallaxMaxLayers:{value:null}},vertexShader:["varying vec2 vUv;","varying vec3 vViewPosition;","varying vec3 vNormal;","void main() {","vUv = uv;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vViewPosition = -mvPosition.xyz;","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform sampler2D bumpMap;","uniform sampler2D map;","uniform float parallaxScale;","uniform float parallaxMinLayers;","uniform float parallaxMaxLayers;","varying vec2 vUv;","varying vec3 vViewPosition;","varying vec3 vNormal;","#ifdef USE_BASIC_PARALLAX","vec2 parallaxMap( in vec3 V ) {","float initialHeight = texture2D( bumpMap, vUv ).r;","vec2 texCoordOffset = parallaxScale * V.xy * initialHeight;","return vUv - texCoordOffset;","}","#else","vec2 parallaxMap( in vec3 V ) {","float numLayers = mix( parallaxMaxLayers, parallaxMinLayers, abs( dot( vec3( 0.0, 0.0, 1.0 ), V ) ) );","float layerHeight = 1.0 / numLayers;","float currentLayerHeight = 0.0;","vec2 dtex = parallaxScale * V.xy / V.z / numLayers;","vec2 currentTextureCoords = vUv;","float heightFromTexture = texture2D( bumpMap, currentTextureCoords ).r;","for ( int i = 0; i < 30; i += 1 ) {","if ( heightFromTexture <= currentLayerHeight ) {","break;","}","currentLayerHeight += layerHeight;","currentTextureCoords -= dtex;","heightFromTexture = texture2D( bumpMap, currentTextureCoords ).r;","}","#ifdef USE_STEEP_PARALLAX","return currentTextureCoords;","#elif defined( USE_RELIEF_PARALLAX )","vec2 deltaTexCoord = dtex / 2.0;","float deltaHeight = layerHeight / 2.0;","currentTextureCoords += deltaTexCoord;","currentLayerHeight -= deltaHeight;","const int numSearches = 5;","for ( int i = 0; i < numSearches; i += 1 ) {","deltaTexCoord /= 2.0;","deltaHeight /= 2.0;","heightFromTexture = texture2D( bumpMap, currentTextureCoords ).r;","if( heightFromTexture > currentLayerHeight ) {","currentTextureCoords -= deltaTexCoord;","currentLayerHeight += deltaHeight;","} else {","currentTextureCoords += deltaTexCoord;","currentLayerHeight -= deltaHeight;","}","}","return currentTextureCoords;","#elif defined( USE_OCLUSION_PARALLAX )","vec2 prevTCoords = currentTextureCoords + dtex;","float nextH = heightFromTexture - currentLayerHeight;","float prevH = texture2D( bumpMap, prevTCoords ).r - currentLayerHeight + layerHeight;","float weight = nextH / ( nextH - prevH );","return prevTCoords * weight + currentTextureCoords * ( 1.0 - weight );","#else","return vUv;","#endif","}","#endif","vec2 perturbUv( vec3 surfPosition, vec3 surfNormal, vec3 viewPosition ) {","vec2 texDx = dFdx( vUv );","vec2 texDy = dFdy( vUv );","vec3 vSigmaX = dFdx( surfPosition );","vec3 vSigmaY = dFdy( surfPosition );","vec3 vR1 = cross( vSigmaY, surfNormal );","vec3 vR2 = cross( surfNormal, vSigmaX );","float fDet = dot( vSigmaX, vR1 );","vec2 vProjVscr = ( 1.0 / fDet ) * vec2( dot( vR1, viewPosition ), dot( vR2, viewPosition ) );","vec3 vProjVtex;","vProjVtex.xy = texDx * vProjVscr.x + texDy * vProjVscr.y;","vProjVtex.z = dot( surfNormal, viewPosition );","return parallaxMap( vProjVtex );","}","void main() {","vec2 mapUv = perturbUv( -vViewPosition, normalize( vNormal ), normalize( vViewPosition ) );","gl_FragColor = texture2D( map, mapUv );","}"].join("\n")},PixelShader={uniforms:{tDiffuse:{value:null},resolution:{value:null},pixelSize:{value:1}},vertexShader:["varying highp vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float pixelSize;","uniform vec2 resolution;","varying highp vec2 vUv;","void main(){","vec2 dxy = pixelSize / resolution;","vec2 coord = dxy * floor( vUv / dxy );","gl_FragColor = texture2D(tDiffuse, coord);","}"].join("\n")},RGBShiftShader={uniforms:{tDiffuse:{value:null},amount:{value:.005},angle:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},SepiaShader={uniforms:{tDiffuse:{value:null},amount:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color = texture2D( tDiffuse, vUv );","vec3 c = color.rgb;","color.r = dot( c, vec3( 1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount ) );","color.g = dot( c, vec3( 0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount ) );","color.b = dot( c, vec3( 0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount ) );","gl_FragColor = vec4( min( vec3( 1.0 ), color.rgb ), color.a );","}"].join("\n")},SobelOperatorShader={uniforms:{tDiffuse:{value:null},resolution:{value:new Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","void main() {","vec2 texel = vec2( 1.0 / resolution.x, 1.0 / resolution.y );","const mat3 Gx = mat3( -1, -2, -1, 0, 0, 0, 1, 2, 1 );","const mat3 Gy = mat3( -1, 0, 1, -2, 0, 2, -1, 0, 1 );","float tx0y0 = texture2D( tDiffuse, vUv + texel * vec2( -1, -1 ) ).r;","float tx0y1 = texture2D( tDiffuse, vUv + texel * vec2( -1,  0 ) ).r;","float tx0y2 = texture2D( tDiffuse, vUv + texel * vec2( -1,  1 ) ).r;","float tx1y0 = texture2D( tDiffuse, vUv + texel * vec2(  0, -1 ) ).r;","float tx1y1 = texture2D( tDiffuse, vUv + texel * vec2(  0,  0 ) ).r;","float tx1y2 = texture2D( tDiffuse, vUv + texel * vec2(  0,  1 ) ).r;","float tx2y0 = texture2D( tDiffuse, vUv + texel * vec2(  1, -1 ) ).r;","float tx2y1 = texture2D( tDiffuse, vUv + texel * vec2(  1,  0 ) ).r;","float tx2y2 = texture2D( tDiffuse, vUv + texel * vec2(  1,  1 ) ).r;","float valueGx = Gx[0][0] * tx0y0 + Gx[1][0] * tx1y0 + Gx[2][0] * tx2y0 + ","Gx[0][1] * tx0y1 + Gx[1][1] * tx1y1 + Gx[2][1] * tx2y1 + ","Gx[0][2] * tx0y2 + Gx[1][2] * tx1y2 + Gx[2][2] * tx2y2; ","float valueGy = Gy[0][0] * tx0y0 + Gy[1][0] * tx1y0 + Gy[2][0] * tx2y0 + ","Gy[0][1] * tx0y1 + Gy[1][1] * tx1y1 + Gy[2][1] * tx2y1 + ","Gy[0][2] * tx0y2 + Gy[1][2] * tx1y2 + Gy[2][2] * tx2y2; ","float G = sqrt( ( valueGx * valueGx ) + ( valueGy * valueGy ) );","gl_FragColor = vec4( vec3( G ), 1 );","}"].join("\n")},TechnicolorShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 tex = texture2D( tDiffuse, vec2( vUv.x, vUv.y ) );","vec4 newTex = vec4(tex.r, (tex.g + tex.b) * .5, (tex.g + tex.b) * .5, 1.0);","gl_FragColor = newTex;","}"].join("\n")},TriangleBlurShader={uniforms:{texture:{value:null},delta:{value:new Vector2(1,1)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <common>","#define ITERATIONS 10.0","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 vUv;","void main() {","vec4 color = vec4( 0.0 );","float total = 0.0;","float offset = rand( vUv );","for ( float t = -ITERATIONS; t <= ITERATIONS; t ++ ) {","float percent = ( t + offset - 0.5 ) / ITERATIONS;","float weight = 1.0 - abs( percent );","color += texture2D( texture, vUv + delta * percent ) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")},VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},VerticalTiltShiftShader={uniforms:{tDiffuse:{value:null},v:{value:1/512},r:{value:.35}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float vv = v * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * vv ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * vv ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},VignetteShader={uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")},VolumeRenderShader1={uniforms:{u_size:{value:new Vector3(1,1,1)},u_renderstyle:{value:0},u_renderthreshold:{value:.5},u_clim:{value:new Vector2(1,1)},u_data:{value:null},u_cmdata:{value:null}},vertexShader:["varying vec4 v_nearpos;","varying vec4 v_farpos;","varying vec3 v_position;","mat4 inversemat(mat4 m) {","float","a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],","a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],","a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],","a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],","b00 = a00 * a11 - a01 * a10,","b01 = a00 * a12 - a02 * a10,","b02 = a00 * a13 - a03 * a10,","b03 = a01 * a12 - a02 * a11,","b04 = a01 * a13 - a03 * a11,","b05 = a02 * a13 - a03 * a12,","b06 = a20 * a31 - a21 * a30,","b07 = a20 * a32 - a22 * a30,","b08 = a20 * a33 - a23 * a30,","b09 = a21 * a32 - a22 * a31,","b10 = a21 * a33 - a23 * a31,","b11 = a22 * a33 - a23 * a32,","det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;","return mat4(","a11 * b11 - a12 * b10 + a13 * b09,","a02 * b10 - a01 * b11 - a03 * b09,","a31 * b05 - a32 * b04 + a33 * b03,","a22 * b04 - a21 * b05 - a23 * b03,","a12 * b08 - a10 * b11 - a13 * b07,","a00 * b11 - a02 * b08 + a03 * b07,","a32 * b02 - a30 * b05 - a33 * b01,","a20 * b05 - a22 * b02 + a23 * b01,","a10 * b10 - a11 * b08 + a13 * b06,","a01 * b08 - a00 * b10 - a03 * b06,","a30 * b04 - a31 * b02 + a33 * b00,","a21 * b02 - a20 * b04 - a23 * b00,","a11 * b07 - a10 * b09 - a12 * b06,","a00 * b09 - a01 * b07 + a02 * b06,","a31 * b01 - a30 * b03 - a32 * b00,","a20 * b03 - a21 * b01 + a22 * b00) / det;","}","void main() {","mat4 viewtransformf = viewMatrix;","mat4 viewtransformi = inversemat(viewMatrix);","vec4 position4 = vec4(position, 1.0);","vec4 pos_in_cam = viewtransformf * position4;","pos_in_cam.z = -pos_in_cam.w;","v_nearpos = viewtransformi * pos_in_cam;","pos_in_cam.z = pos_in_cam.w;","v_farpos = viewtransformi * pos_in_cam;","v_position = position;","gl_Position = projectionMatrix * viewMatrix * modelMatrix * position4;","}"].join("\n"),fragmentShader:["precision highp float;","precision mediump sampler3D;","uniform vec3 u_size;","uniform int u_renderstyle;","uniform float u_renderthreshold;","uniform vec2 u_clim;","uniform sampler3D u_data;","uniform sampler2D u_cmdata;","varying vec3 v_position;","varying vec4 v_nearpos;","varying vec4 v_farpos;","const int MAX_STEPS = 887;  // 887 for 512^3, 1774 for 1024^3","const int REFINEMENT_STEPS = 4;","const float relative_step_size = 1.0;","const vec4 ambient_color = vec4(0.2, 0.4, 0.2, 1.0);","const vec4 diffuse_color = vec4(0.8, 0.2, 0.2, 1.0);","const vec4 specular_color = vec4(1.0, 1.0, 1.0, 1.0);","const float shininess = 40.0;","void cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);","void cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);","float sample1(vec3 texcoords);","vec4 apply_colormap(float val);","vec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray);","void main() {","vec3 farpos = v_farpos.xyz / v_farpos.w;","vec3 nearpos = v_nearpos.xyz / v_nearpos.w;","vec3 view_ray = normalize(nearpos.xyz - farpos.xyz);","float distance = dot(nearpos - v_position, view_ray);","distance = max(distance, min((-0.5 - v_position.x) / view_ray.x,","(u_size.x - 0.5 - v_position.x) / view_ray.x));","distance = max(distance, min((-0.5 - v_position.y) / view_ray.y,","(u_size.y - 0.5 - v_position.y) / view_ray.y));","distance = max(distance, min((-0.5 - v_position.z) / view_ray.z,","(u_size.z - 0.5 - v_position.z) / view_ray.z));","vec3 front = v_position + view_ray * distance;","int nsteps = int(-distance / relative_step_size + 0.5);","if ( nsteps < 1 )","discard;","vec3 step = ((v_position - front) / u_size) / float(nsteps);","vec3 start_loc = front / u_size;","if (u_renderstyle == 0)","cast_mip(start_loc, step, nsteps, view_ray);","else if (u_renderstyle == 1)","cast_iso(start_loc, step, nsteps, view_ray);","if (gl_FragColor.a < 0.05)","discard;","}","float sample1(vec3 texcoords) {","","return texture(u_data, texcoords.xyz).r;","}","vec4 apply_colormap(float val) {","val = (val - u_clim[0]) / (u_clim[1] - u_clim[0]);","return texture2D(u_cmdata, vec2(val, 0.5));","}","void cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {","float max_val = -1e6;","int max_i = 100;","vec3 loc = start_loc;","for (int iter=0; iter<MAX_STEPS; iter++) {","if (iter >= nsteps)","break;","float val = sample1(loc);","if (val > max_val) {","max_val = val;","max_i = iter;","}","loc += step;","}","vec3 iloc = start_loc + step * (float(max_i) - 0.5);","vec3 istep = step / float(REFINEMENT_STEPS);","for (int i=0; i<REFINEMENT_STEPS; i++) {","max_val = max(max_val, sample1(iloc));","iloc += istep;","}","gl_FragColor = apply_colormap(max_val);","}","void cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {","gl_FragColor = vec4(0.0);  // init transparent","vec4 color3 = vec4(0.0);  // final color","vec3 dstep = 1.5 / u_size;  // step to sample derivative","vec3 loc = start_loc;","float low_threshold = u_renderthreshold - 0.02 * (u_clim[1] - u_clim[0]);","for (int iter=0; iter<MAX_STEPS; iter++) {","if (iter >= nsteps)","break;","float val = sample1(loc);","if (val > low_threshold) {","vec3 iloc = loc - 0.5 * step;","vec3 istep = step / float(REFINEMENT_STEPS);","for (int i=0; i<REFINEMENT_STEPS; i++) {","val = sample1(iloc);","if (val > u_renderthreshold) {","gl_FragColor = add_lighting(val, iloc, dstep, view_ray);","return;","}","iloc += istep;","}","}","loc += step;","}","}","vec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray)","{","vec3 V = normalize(view_ray);","vec3 N;","float val1, val2;","val1 = sample1(loc + vec3(-step[0], 0.0, 0.0));","val2 = sample1(loc + vec3(+step[0], 0.0, 0.0));","N[0] = val1 - val2;","val = max(max(val1, val2), val);","val1 = sample1(loc + vec3(0.0, -step[1], 0.0));","val2 = sample1(loc + vec3(0.0, +step[1], 0.0));","N[1] = val1 - val2;","val = max(max(val1, val2), val);","val1 = sample1(loc + vec3(0.0, 0.0, -step[2]));","val2 = sample1(loc + vec3(0.0, 0.0, +step[2]));","N[2] = val1 - val2;","val = max(max(val1, val2), val);","float gm = length(N); // gradient magnitude","N = normalize(N);","float Nselect = float(dot(N, V) > 0.0);","N = (2.0 * Nselect - 1.0) * N;  // ==  Nselect * N - (1.0-Nselect)*N;","vec4 ambient_color = vec4(0.0, 0.0, 0.0, 0.0);","vec4 diffuse_color = vec4(0.0, 0.0, 0.0, 0.0);","vec4 specular_color = vec4(0.0, 0.0, 0.0, 0.0);","for (int i=0; i<1; i++)","{","vec3 L = normalize(view_ray);  //lightDirs[i];","float lightEnabled = float( length(L) > 0.0 );","L = normalize(L + (1.0 - lightEnabled));","float lambertTerm = clamp(dot(N, L), 0.0, 1.0);","vec3 H = normalize(L+V); // Halfway vector","float specularTerm = pow(max(dot(H, N), 0.0), shininess);","float mask1 = lightEnabled;","ambient_color +=  mask1 * ambient_color;  // * gl_LightSource[i].ambient;","diffuse_color +=  mask1 * lambertTerm;","specular_color += mask1 * specularTerm * specular_color;","}","vec4 final_color;","vec4 color = apply_colormap(val);","final_color = color * (ambient_color + diffuse_color) + specular_color;","final_color.a = color.a;","return final_color;","}"].join("\n")},WaterRefractionShader={uniforms:{color:{type:"c",value:null},time:{type:"f",value:0},tDiffuse:{type:"t",value:null},tDudv:{type:"t",value:null},textureMatrix:{type:"m4",value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec2 vUv;","varying vec4 vUvRefraction;","void main() {","\tvUv = uv;","\tvUvRefraction = textureMatrix * vec4( position, 1.0 );","\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform float time;","uniform sampler2D tDiffuse;","uniform sampler2D tDudv;","varying vec2 vUv;","varying vec4 vUvRefraction;","float blendOverlay( float base, float blend ) {","\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ),blendOverlay( base.b, blend.b ) );","}","void main() {"," float waveStrength = 0.1;"," float waveSpeed = 0.03;","\tvec2 distortedUv = texture2D( tDudv, vec2( vUv.x + time * waveSpeed, vUv.y ) ).rg * waveStrength;","\tdistortedUv = vUv.xy + vec2( distortedUv.x, distortedUv.y + time * waveSpeed );","\tvec2 distortion = ( texture2D( tDudv, distortedUv ).rg * 2.0 - 1.0 ) * waveStrength;"," vec4 uv = vec4( vUvRefraction );"," uv.xy += distortion;","\tvec4 base = texture2DProj( tDiffuse, uv );","\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")},ShaderSkin={skinSimple:{uniforms:UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights,{enableBump:{value:0},enableSpecular:{value:0},tDiffuse:{value:null},tBeckmann:{value:null},diffuse:{value:new Color(15658734)},specular:{value:new Color(1118481)},opacity:{value:1},uRoughness:{value:.15},uSpecularBrightness:{value:.75},bumpMap:{value:null},bumpScale:{value:1},specularMap:{value:null},offsetRepeat:{value:new Vector4(0,0,1,1)},uWrapRGB:{value:new Vector3(.75,.375,.1875)}}]),fragmentShader:["#define USE_BUMPMAP","uniform bool enableBump;","uniform bool enableSpecular;","uniform vec3 diffuse;","uniform vec3 specular;","uniform float opacity;","uniform float uRoughness;","uniform float uSpecularBrightness;","uniform vec3 uWrapRGB;","uniform sampler2D tDiffuse;","uniform sampler2D tBeckmann;","uniform sampler2D specularMap;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,ShaderChunk.bsdfs,ShaderChunk.packing,ShaderChunk.lights_pars_begin,ShaderChunk.fog_pars_fragment,ShaderChunk.bumpmap_pars_fragment,"float fresnelReflectance( vec3 H, vec3 V, float F0 ) {","float base = 1.0 - dot( V, H );","float exponential = pow( base, 5.0 );","return exponential + F0 * ( 1.0 - exponential );","}","float KS_Skin_Specular( vec3 N,","vec3 L,","vec3 V,","float m,","float rho_s",") {","float result = 0.0;","float ndotl = dot( N, L );","if( ndotl > 0.0 ) {","vec3 h = L + V;","vec3 H = normalize( h );","float ndoth = dot( N, H );","float PH = pow( 2.0 * texture2D( tBeckmann, vec2( ndoth, m ) ).x, 10.0 );","float F = fresnelReflectance( H, V, 0.028 );","float frSpec = max( PH * F / dot( h, h ), 0.0 );","result = ndotl * rho_s * frSpec;","}","return result;","}","void main() {","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","vec4 colDiffuse = texture2D( tDiffuse, vUv );","colDiffuse.rgb *= colDiffuse.rgb;","diffuseColor = diffuseColor * colDiffuse;","vec3 normal = normalize( vNormal );","vec3 viewerDirection = normalize( vViewPosition );","float specularStrength;","if ( enableSpecular ) {","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","} else {","specularStrength = 1.0;","}","#ifdef USE_BUMPMAP","if ( enableBump ) normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","vec3 totalSpecularLight = vec3( 0.0 );","vec3 totalDiffuseLight = vec3( 0.0 );","#if NUM_POINT_LIGHTS > 0","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","vec3 lVector = pointLights[ i ].position + vViewPosition.xyz;","float attenuation = calcLightAttenuation( length( lVector ), pointLights[ i ].distance, pointLights[ i ].decay );","lVector = normalize( lVector );","float pointDiffuseWeightFull = max( dot( normal, lVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, lVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), uWrapRGB );","float pointSpecularWeight = KS_Skin_Specular( normal, lVector, viewerDirection, uRoughness, uSpecularBrightness );","totalDiffuseLight += pointLight[ i ].color * ( pointDiffuseWeight * attenuation );","totalSpecularLight += pointLight[ i ].color * specular * ( pointSpecularWeight * specularStrength * attenuation );","}","#endif","#if NUM_DIR_LIGHTS > 0","for( int i = 0; i < NUM_DIR_LIGHTS; i++ ) {","vec3 dirVector = directionalLights[ i ].direction;","float dirDiffuseWeightFull = max( dot( normal, dirVector ), 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3 ( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), uWrapRGB );","float dirSpecularWeight = KS_Skin_Specular( normal, dirVector, viewerDirection, uRoughness, uSpecularBrightness );","totalDiffuseLight += directionalLights[ i ].color * dirDiffuseWeight;","totalSpecularLight += directionalLights[ i ].color * ( dirSpecularWeight * specularStrength );","}","#endif","#if NUM_HEMI_LIGHTS > 0","for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","vec3 lVector = hemisphereLightDirection[ i ];","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","totalDiffuseLight += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","float hemiSpecularWeight = 0.0;","hemiSpecularWeight += KS_Skin_Specular( normal, lVector, viewerDirection, uRoughness, uSpecularBrightness );","vec3 lVectorGround = -lVector;","hemiSpecularWeight += KS_Skin_Specular( normal, lVectorGround, viewerDirection, uRoughness, uSpecularBrightness );","vec3 hemiSpecularColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","totalSpecularLight += hemiSpecularColor * specular * ( hemiSpecularWeight * specularStrength );","}","#endif","outgoingLight += diffuseColor.xyz * ( totalDiffuseLight + ambientLightColor * diffuse ) + totalSpecularLight;","gl_FragColor = linearToOutputTexel( vec4( outgoingLight, diffuseColor.a ) );",ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["uniform vec4 offsetRepeat;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,ShaderChunk.lights_pars_begin,ShaderChunk.fog_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vViewPosition = -mvPosition.xyz;","vNormal = normalize( normalMatrix * normal );","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","gl_Position = projectionMatrix * mvPosition;",ShaderChunk.fog_vertex,"}"].join("\n")},skin:{uniforms:UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights,{passID:{value:0},tDiffuse:{value:null},tNormal:{value:null},tBlur1:{value:null},tBlur2:{value:null},tBlur3:{value:null},tBlur4:{value:null},tBeckmann:{value:null},uNormalScale:{value:1},diffuse:{value:new Color(15658734)},specular:{value:new Color(1118481)},opacity:{value:1},uRoughness:{value:.15},uSpecularBrightness:{value:.75}}]),fragmentShader:["uniform vec3 diffuse;","uniform vec3 specular;","uniform float opacity;","uniform float uRoughness;","uniform float uSpecularBrightness;","uniform int passID;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tBlur1;","uniform sampler2D tBlur2;","uniform sampler2D tBlur3;","uniform sampler2D tBlur4;","uniform sampler2D tBeckmann;","uniform float uNormalScale;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,ShaderChunk.lights_pars_begin,ShaderChunk.fog_pars_fragment,"float fresnelReflectance( vec3 H, vec3 V, float F0 ) {","float base = 1.0 - dot( V, H );","float exponential = pow( base, 5.0 );","return exponential + F0 * ( 1.0 - exponential );","}","float KS_Skin_Specular( vec3 N,","vec3 L,","vec3 V,","float m,","float rho_s",") {","float result = 0.0;","float ndotl = dot( N, L );","if( ndotl > 0.0 ) {","vec3 h = L + V;","vec3 H = normalize( h );","float ndoth = dot( N, H );","float PH = pow( 2.0 * texture2D( tBeckmann, vec2( ndoth, m ) ).x, 10.0 );","float F = fresnelReflectance( H, V, 0.028 );","float frSpec = max( PH * F / dot( h, h ), 0.0 );","result = ndotl * rho_s * frSpec;","}","return result;","}","void main() {","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","vec4 mSpecular = vec4( specular, opacity );","vec4 colDiffuse = texture2D( tDiffuse, vUv );","colDiffuse *= colDiffuse;","diffuseColor *= colDiffuse;","vec4 posAndU = vec4( -vViewPosition, vUv.x );","vec4 posAndU_dx = dFdx( posAndU ),  posAndU_dy = dFdy( posAndU );","vec3 tangent = posAndU_dx.w * posAndU_dx.xyz + posAndU_dy.w * posAndU_dy.xyz;","vec3 normal = normalize( vNormal );","vec3 binormal = normalize( cross( tangent, normal ) );","tangent = cross( normal, binormal );","mat3 tsb = mat3( tangent, binormal, normal );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","vec3 finalNormal = tsb * normalTex;","normal = normalize( finalNormal );","vec3 viewerDirection = normalize( vViewPosition );","vec3 totalDiffuseLight = vec3( 0.0 );","vec3 totalSpecularLight = vec3( 0.0 );","#if NUM_POINT_LIGHTS > 0","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","vec3 pointVector = normalize( pointLights[ i ].direction );","float attenuation = calcLightAttenuation( length( lVector ), pointLights[ i ].distance, pointLights[ i ].decay );","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","totalDiffuseLight += pointLightColor[ i ] * ( pointDiffuseWeight * attenuation );","if ( passID == 1 ) {","float pointSpecularWeight = KS_Skin_Specular( normal, pointVector, viewerDirection, uRoughness, uSpecularBrightness );","totalSpecularLight += pointLightColor[ i ] * mSpecular.xyz * ( pointSpecularWeight * attenuation );","}","}","#endif","#if NUM_DIR_LIGHTS > 0","for( int i = 0; i < NUM_DIR_LIGHTS; i++ ) {","vec3 dirVector = directionalLights[ i ].direction;","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","totalDiffuseLight += directionalLights[ i ].color * dirDiffuseWeight;","if ( passID == 1 ) {","float dirSpecularWeight = KS_Skin_Specular( normal, dirVector, viewerDirection, uRoughness, uSpecularBrightness );","totalSpecularLight += directionalLights[ i ].color * mSpecular.xyz * dirSpecularWeight;","}","}","#endif","outgoingLight += diffuseColor.rgb * ( totalDiffuseLight + totalSpecularLight );","if ( passID == 0 ) {","outgoingLight = sqrt( outgoingLight );","} else if ( passID == 1 ) {","#ifdef VERSION1","vec3 nonblurColor = sqrt(outgoingLight );","#else","vec3 nonblurColor = outgoingLight;","#endif","vec3 blur1Color = texture2D( tBlur1, vUv ).xyz;","vec3 blur2Color = texture2D( tBlur2, vUv ).xyz;","vec3 blur3Color = texture2D( tBlur3, vUv ).xyz;","vec3 blur4Color = texture2D( tBlur4, vUv ).xyz;","outgoingLight = vec3( vec3( 0.22,  0.437, 0.635 ) * nonblurColor + ","vec3( 0.101, 0.355, 0.365 ) * blur1Color + ","vec3( 0.119, 0.208, 0.0 )   * blur2Color + ","vec3( 0.114, 0.0,   0.0 )   * blur3Color + ","vec3( 0.444, 0.0,   0.0 )   * blur4Color );","outgoingLight *= sqrt( colDiffuse.xyz );","outgoingLight += ambientLightColor * diffuse * colDiffuse.xyz + totalSpecularLight;","#ifndef VERSION1","outgoingLight = sqrt( outgoingLight );","#endif","}","gl_FragColor = vec4( outgoingLight, diffuseColor.a );",ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,ShaderChunk.fog_pars_vertex,"void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vViewPosition = -mvPosition.xyz;","vNormal = normalize( normalMatrix * normal );","vUv = uv;","#ifdef VERTEX_TEXTURES","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","vec4 displacedPosition = vec4( vNormal.xyz * df, 0.0 ) + mvPosition;","gl_Position = projectionMatrix * displacedPosition;","#else","gl_Position = projectionMatrix * mvPosition;","#endif",ShaderChunk.fog_vertex,"}"].join("\n"),vertexShaderUV:["varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,"void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vViewPosition = -mvPosition.xyz;","vNormal = normalize( normalMatrix * normal );","vUv = uv;","gl_Position = vec4( uv.x * 2.0 - 1.0, uv.y * 2.0 - 1.0, 0.0, 1.0 );","}"].join("\n")},beckmann:{uniforms:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","float PHBeckmann( float ndoth, float m ) {","float alpha = acos( ndoth );","float ta = tan( alpha );","float val = 1.0 / ( m * m * pow( ndoth, 4.0 ) ) * exp( -( ta * ta ) / ( m * m ) );","return val;","}","float KSTextureCompute( vec2 tex ) {","return 0.5 * pow( PHBeckmann( tex.x, tex.y ), 0.1 );","}","void main() {","float x = KSTextureCompute( vUv );","gl_FragColor = vec4( x, x, x, 1.0 );","}"].join("\n")}},ShaderTerrain={terrain:{uniforms:UniformsUtils.merge([UniformsLib.fog,UniformsLib.lights,{enableDiffuse1:{value:0},enableDiffuse2:{value:0},enableSpecular:{value:0},enableReflection:{value:0},tDiffuse1:{value:null},tDiffuse2:{value:null},tDetail:{value:null},tNormal:{value:null},tSpecular:{value:null},tDisplacement:{value:null},uNormalScale:{value:1},uDisplacementBias:{value:0},uDisplacementScale:{value:1},diffuse:{value:new Color(15658734)},specular:{value:new Color(1118481)},shininess:{value:30},opacity:{value:1},uRepeatBase:{value:new Vector2(1,1)},uRepeatOverlay:{value:new Vector2(1,1)},uOffset:{value:new Vector2(0,0)}}]),fragmentShader:["uniform vec3 diffuse;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;","uniform bool enableDiffuse1;","uniform bool enableDiffuse2;","uniform bool enableSpecular;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDetail;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tDisplacement;","uniform float uNormalScale;","uniform vec2 uRepeatOverlay;","uniform vec2 uRepeatBase;","uniform vec2 uOffset;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,ShaderChunk.bsdfs,ShaderChunk.lights_pars_begin,ShaderChunk.shadowmap_pars_fragment,ShaderChunk.fog_pars_fragment,"float calcLightAttenuation( float lightDistance, float cutoffDistance, float decayExponent ) {","if ( decayExponent > 0.0 ) {","return pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );","}","return 1.0;","}","void main() {","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","vec3 specularTex = vec3( 1.0 );","vec2 uvOverlay = uRepeatOverlay * vUv + uOffset;","vec2 uvBase = uRepeatBase * vUv;","vec3 normalTex = texture2D( tDetail, uvOverlay ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse1 && enableDiffuse2 ) {","vec4 colDiffuse1 = texture2D( tDiffuse1, uvOverlay );","vec4 colDiffuse2 = texture2D( tDiffuse2, uvOverlay );","colDiffuse1 = GammaToLinear( colDiffuse1, float( GAMMA_FACTOR ) );","colDiffuse2 = GammaToLinear( colDiffuse2, float( GAMMA_FACTOR ) );","diffuseColor *= mix ( colDiffuse1, colDiffuse2, 1.0 - texture2D( tDisplacement, uvBase ) );"," } else if( enableDiffuse1 ) {","diffuseColor *= texture2D( tDiffuse1, uvOverlay );","} else if( enableDiffuse2 ) {","diffuseColor *= texture2D( tDiffuse2, uvOverlay );","}","if( enableSpecular )","specularTex = texture2D( tSpecular, uvOverlay ).xyz;","mat3 tsb = mat3( vTangent, vBinormal, vNormal );","vec3 finalNormal = tsb * normalTex;","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","vec3 totalDiffuseLight = vec3( 0.0 );","vec3 totalSpecularLight = vec3( 0.0 );","#if NUM_POINT_LIGHTS > 0","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","vec3 lVector = pointLights[ i ].position + vViewPosition.xyz;","float attenuation = calcLightAttenuation( length( lVector ), pointLights[ i ].distance, pointLights[ i ].decay );","lVector = normalize( lVector );","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointDiffuseWeight = max( dot( normal, lVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, shininess ), 0.0 );","totalDiffuseLight += attenuation * pointLights[ i ].color * pointDiffuseWeight;","totalSpecularLight += attenuation * pointLights[ i ].color * specular * pointSpecularWeight * pointDiffuseWeight;","}","#endif","#if NUM_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < NUM_DIR_LIGHTS; i++ ) {","vec3 dirVector = directionalLights[ i ].direction;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, shininess ), 0.0 );","totalDiffuseLight += directionalLights[ i ].color * dirDiffuseWeight;","totalSpecularLight += directionalLights[ i ].color * specular * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if NUM_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","vec3 lVector = hemisphereLightDirection[ i ];","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","totalDiffuseLight += mix( hemisphereLights[ i ].groundColor, hemisphereLights[ i ].skyColor, hemiDiffuseWeight );","float hemiSpecularWeight = 0.0;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","totalSpecularLight += specular * mix( hemisphereLights[ i ].groundColor, hemisphereLights[ i ].skyColor, hemiDiffuseWeight ) * hemiSpecularWeight * hemiDiffuseWeight;","}","#endif","outgoingLight += diffuseColor.xyz * ( totalDiffuseLight + ambientLightColor + totalSpecularLight );","gl_FragColor = vec4( outgoingLight, diffuseColor.a );",ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uRepeatBase;","uniform sampler2D tNormal;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.shadowmap_pars_vertex,ShaderChunk.fog_pars_vertex,"void main() {","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","vBinormal = cross( vNormal, vTangent ) * tangent.w;","vBinormal = normalize( vBinormal );","vUv = uv;","vec2 uvBase = uv * uRepeatBase;","#ifdef VERTEX_TEXTURES","vec3 dv = texture2D( tDisplacement, uvBase ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","vec3 displacedPosition = normal * df + position;","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","#else","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;","vViewPosition = -mvPosition.xyz;","vec3 normalTex = texture2D( tNormal, uvBase ).xyz * 2.0 - 1.0;","vNormal = normalMatrix * normalTex;",ShaderChunk.shadowmap_vertex,ShaderChunk.fog_vertex,"}"].join("\n")}},ShaderToon={toon1:{uniforms:{uDirLightPos:{value:new Vector3},uDirLightColor:{value:new Color(15658734)},uAmbientLightColor:{value:new Color(328965)},uBaseColor:{value:new Color(16777215)}},vertexShader:["varying vec3 vNormal;","varying vec3 vRefract;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vec3 worldNormal = normalize ( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );","vNormal = normalize( normalMatrix * normal );","vec3 I = worldPosition.xyz - cameraPosition;","vRefract = refract( normalize( I ), worldNormal, 1.02 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 uBaseColor;","uniform vec3 uDirLightPos;","uniform vec3 uDirLightColor;","uniform vec3 uAmbientLightColor;","varying vec3 vNormal;","varying vec3 vRefract;","void main() {","float directionalLightWeighting = max( dot( normalize( vNormal ), uDirLightPos ), 0.0);","vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;","float intensity = smoothstep( - 0.5, 1.0, pow( length(lightWeighting), 20.0 ) );","intensity += length(lightWeighting) * 0.2;","float cameraWeighting = dot( normalize( vNormal ), vRefract );","intensity += pow( 1.0 - length( cameraWeighting ), 6.0 );","intensity = intensity * 0.2 + 0.3;","if ( intensity < 0.50 ) {","gl_FragColor = vec4( 2.0 * intensity * uBaseColor, 1.0 );","} else {","gl_FragColor = vec4( 1.0 - 2.0 * ( 1.0 - intensity ) * ( 1.0 - uBaseColor ), 1.0 );","}","}"].join("\n")},toon2:{uniforms:{uDirLightPos:{value:new Vector3},uDirLightColor:{value:new Color(15658734)},uAmbientLightColor:{value:new Color(328965)},uBaseColor:{value:new Color(15658734)},uLineColor1:{value:new Color(8421504)},uLineColor2:{value:new Color(0)},uLineColor3:{value:new Color(0)},uLineColor4:{value:new Color(0)}},vertexShader:["varying vec3 vNormal;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","}"].join("\n"),fragmentShader:["uniform vec3 uBaseColor;","uniform vec3 uLineColor1;","uniform vec3 uLineColor2;","uniform vec3 uLineColor3;","uniform vec3 uLineColor4;","uniform vec3 uDirLightPos;","uniform vec3 uDirLightColor;","uniform vec3 uAmbientLightColor;","varying vec3 vNormal;","void main() {","float camera = max( dot( normalize( vNormal ), vec3( 0.0, 0.0, 1.0 ) ), 0.4);","float light = max( dot( normalize( vNormal ), uDirLightPos ), 0.0);","gl_FragColor = vec4( uBaseColor, 1.0 );","if ( length(uAmbientLightColor + uDirLightColor * light) < 1.00 ) {","gl_FragColor *= vec4( uLineColor1, 1.0 );","}","if ( length(uAmbientLightColor + uDirLightColor * camera) < 0.50 ) {","gl_FragColor *= vec4( uLineColor2, 1.0 );","}","}"].join("\n")},hatching:{uniforms:{uDirLightPos:{value:new Vector3},uDirLightColor:{value:new Color(15658734)},uAmbientLightColor:{value:new Color(328965)},uBaseColor:{value:new Color(16777215)},uLineColor1:{value:new Color(0)},uLineColor2:{value:new Color(0)},uLineColor3:{value:new Color(0)},uLineColor4:{value:new Color(0)}},vertexShader:["varying vec3 vNormal;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","}"].join("\n"),fragmentShader:["uniform vec3 uBaseColor;","uniform vec3 uLineColor1;","uniform vec3 uLineColor2;","uniform vec3 uLineColor3;","uniform vec3 uLineColor4;","uniform vec3 uDirLightPos;","uniform vec3 uDirLightColor;","uniform vec3 uAmbientLightColor;","varying vec3 vNormal;","void main() {","float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);","vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;","gl_FragColor = vec4( uBaseColor, 1.0 );","if ( length(lightWeighting) < 1.00 ) {","if ( mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0) {","gl_FragColor = vec4( uLineColor1, 1.0 );","}","}","if ( length(lightWeighting) < 0.75 ) {","if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0) {","gl_FragColor = vec4( uLineColor2, 1.0 );","}","}","if ( length(lightWeighting) < 0.50 ) {","if (mod(gl_FragCoord.x + gl_FragCoord.y - 5.0, 10.0) == 0.0) {","gl_FragColor = vec4( uLineColor3, 1.0 );","}","}","if ( length(lightWeighting) < 0.3465 ) {","if (mod(gl_FragCoord.x - gl_FragCoord.y - 5.0, 10.0) == 0.0) {","gl_FragColor = vec4( uLineColor4, 1.0 );","}","}","}"].join("\n")},dotted:{uniforms:{uDirLightPos:{value:new Vector3},uDirLightColor:{value:new Color(15658734)},uAmbientLightColor:{value:new Color(328965)},uBaseColor:{value:new Color(16777215)},uLineColor1:{value:new Color(0)}},vertexShader:["varying vec3 vNormal;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","}"].join("\n"),fragmentShader:["uniform vec3 uBaseColor;","uniform vec3 uLineColor1;","uniform vec3 uLineColor2;","uniform vec3 uLineColor3;","uniform vec3 uLineColor4;","uniform vec3 uDirLightPos;","uniform vec3 uDirLightColor;","uniform vec3 uAmbientLightColor;","varying vec3 vNormal;","void main() {","float directionalLightWeighting = max( dot( normalize(vNormal), uDirLightPos ), 0.0);","vec3 lightWeighting = uAmbientLightColor + uDirLightColor * directionalLightWeighting;","gl_FragColor = vec4( uBaseColor, 1.0 );","if ( length(lightWeighting) < 1.00 ) {","if ( ( mod(gl_FragCoord.x, 4.001) + mod(gl_FragCoord.y, 4.0) ) > 6.00 ) {","gl_FragColor = vec4( uLineColor1, 1.0 );","}","}","if ( length(lightWeighting) < 0.50 ) {","if ( ( mod(gl_FragCoord.x + 2.0, 4.001) + mod(gl_FragCoord.y + 2.0, 4.0) ) > 6.00 ) {","gl_FragColor = vec4( uLineColor1, 1.0 );","}","}","}"].join("\n")}},TranslucentShader=function(){this.uniforms=UniformsUtils.merge([UniformsLib.common,UniformsLib.lights,{color:{value:new Color(16777215)},diffuse:{value:new Color(16777215)},specular:{value:new Color(16777215)},emissive:{value:new Color(0)},opacity:{value:1},shininess:{value:1},thicknessMap:{value:null},thicknessColor:{value:new Color(16777215)},thicknessDistortion:{value:.1},thicknessAmbient:{value:0},thicknessAttenuation:{value:.1},thicknessPower:{value:2},thicknessScale:{value:10}}]),this.fragmentShader=["#define USE_MAP","#define PHONG","#define TRANSLUCENT","#include <common>","#include <bsdfs>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <lights_phong_pars_fragment>","varying vec3 vColor;","uniform vec3 diffuse;","uniform vec3 specular;","uniform vec3 emissive;","uniform float opacity;","uniform float shininess;","uniform sampler2D thicknessMap;","uniform float thicknessPower;","uniform float thicknessScale;","uniform float thicknessDistortion;","uniform float thicknessAmbient;","uniform float thicknessAttenuation;","uniform vec3 thicknessColor;",ShaderChunk.lights_pars_begin,"void RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in GeometricContext geometry, inout ReflectedLight reflectedLight) {","\tvec3 thickness = thicknessColor * texture2D(thicknessMap, uv).r;","\tvec3 scatteringHalf = normalize(directLight.direction + (geometry.normal * thicknessDistortion));","\tfloat scatteringDot = pow(saturate(dot(geometry.viewDir, -scatteringHalf)), thicknessPower) * thicknessScale;","\tvec3 scatteringIllu = (scatteringDot + thicknessAmbient) * thickness;","\treflectedLight.directDiffuse += scatteringIllu * thicknessAttenuation * directLight.color;","}","void main() {","\tvec3 normal = normalize( vNormal );","\tvec3 viewerDirection = normalize( vViewPosition );","\tvec4 diffuseColor = vec4( diffuse, opacity );","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );",ShaderChunk.map_fragment,ShaderChunk.color_fragment,ShaderChunk.specularmap_fragment,"\tvec3 totalEmissiveRadiance = emissive;",ShaderChunk.lights_phong_fragment,"\tGeometricContext geometry;","\tgeometry.position = - vViewPosition;","\tgeometry.normal = normal;","\tgeometry.viewDir = normalize( vViewPosition );","\tIncidentLight directLight;","\t#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","\t\tPointLight pointLight;","\t\t#pragma unroll_loop","\t\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","\t\t \tpointLight = pointLights[ i ];","\t\t \tgetPointDirectLightIrradiance( pointLight, geometry, directLight );","\t\t\t#ifdef USE_SHADOWMAP","\t\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;","\t\t\t#endif","\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t\t\t#if defined( TRANSLUCENT ) && defined( USE_MAP )","\t\t\tRE_Direct_Scattering(directLight, vUv, geometry, reflectedLight);","\t\t\t#endif","\t\t}","\t\t#endif","\t#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","\t\tDirectionalLight directionalLight;","\t\t#pragma unroll_loop","\t\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","\t\t\tdirectionalLight = directionalLights[ i ];","\t\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","\t\t\t#ifdef USE_SHADOWMAP","\t\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\t\t\t#endif","\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t\t\t#if defined( TRANSLUCENT ) && defined( USE_MAP )","\t\t\tRE_Direct_Scattering(directLight, vUv, geometry, reflectedLight);","\t\t\t#endif","\t\t}","\t#endif","\t#if defined( RE_IndirectDiffuse )","\t\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","\t\t#if ( NUM_HEMI_LIGHTS > 0 )","\t\t\t#pragma unroll_loop","\t\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","\t\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","\t\t\t}","\t\t#endif","\t#endif","\t#if defined( RE_IndirectSpecular )","\t\tvec3 radiance = vec3( 0.0 );","\t\tvec3 clearCoatRadiance = vec3( 0.0 );","\t#endif",ShaderChunk.lights_fragment_end,"\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );",ShaderChunk.encodings_fragment,"}"].join("\n"),this.vertexShader=["varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vViewPosition;",ShaderChunk.common,"void main() {","\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );","\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","\tvViewPosition = -mvPosition.xyz;","\tvNormal = normalize( normalMatrix * normal );","\tvUv = uv;","\tgl_Position = projectionMatrix * mvPosition;","}"].join("\n")},TimelinerController=function(e,t,r){this._scene=e,this._trackInfo=t,this._onUpdate=r,this._mixer=new AnimationMixer(e),this._clip=null,this._action=null,this._tracks={},this._propRefs={},this._channelNames=[]};TimelinerController.prototype={constructor:TimelinerController,init:function(e){for(var t=[],r=this._trackInfo,i=0,n=r.length;i!==n;++i){var o=r[i];t.push(this._addTrack(o.type,o.propertyPath,o.initialValue,o.interpolation))}this._clip=new AnimationClip("editclip",0,t),this._action=this._mixer.clipAction(this._clip).play()},setDisplayTime:function(time){this._action.time=time,this._mixer.update(0),this._onUpdate()},setDuration:function(e){this._clip.duration=e},getChannelNames:function(){return this._channelNames},getChannelKeyTimes:function(e){return this._tracks[e].times},setKeyframe:function(e,time){var track=this._tracks[e],t=track.times,r=Timeliner.binarySearch(t,time),n=track.values,o=track.getValueSize(),l=r*o;if(r<0){l=(r=~r)*o;for(var c=t.length+1,h=n.length+o,i=c-1;i!==r;--i)t[i]=t[i-1];i=h-1;for(var d=l+o-1;i!==d;--i)n[i]=n[i-o]}t[r]=time,this._propRefs[e].getValue(n,l)},delKeyframe:function(e,time){var track=this._tracks[e],t=track.times,r=Timeliner.binarySearch(t,time);if(t.length>1&&r>=0){for(var n=t.length-1,o=track.values,l=track.getValueSize(),c=o.length-l,i=r;i!==n;++i)t[i]=t[i+1];t.pop();for(var h=r*l;h!==c;++h)o[h]=o[h+l];o.length=c}},moveKeyframe:function(e,time,t,r){var track=this._tracks[e],n=track.times,o=Timeliner.binarySearch(n,time);if(o>=0){for(var l=r?n.length:o+1,c=n[o-1]<=time||!r&&time>=n[o+1];o!==l;)n[o++]+=t;c&&this._sort(track)}},serialize:function(){for(var e={duration:this._clip.duration,channels:{}},t=this._channelNames,r=this._tracks,n=e.channels,i=0,o=t.length;i!==o;++i){var l=t[i],track=r[l];n[l]={times:track.times,values:track.values}}return e},deserialize:function(e){var t=this._channelNames,r=this._tracks,n=e.channels;this.setDuration(e.duration);for(var i=0,o=t.length;i!==o;++i){var l=t[i],track=r[l],data=n[l];this._setArray(track.times,data.times),this._setArray(track.values,data.values)}this.setDisplayTime(this._mixer.time)},_sort:function(track){var e=track.times,t=AnimationUtils.getKeyframeOrder(e);this._setArray(e,AnimationUtils.sortedArray(e,1,t));var r=track.values,n=track.getValueSize();this._setArray(r,AnimationUtils.sortedArray(r,n,t))},_setArray:function(e,t){e.length=0,e.push.apply(e,t)},_addTrack:function(e,t,r,n){var track=new e(t,[0],r,n);return track.times=Array.prototype.slice.call(track.times),track.values=Array.prototype.slice.call(track.values),this._channelNames.push(t),this._tracks[t]=track,this._propRefs[t]=new PropertyBinding(this._scene,t),track}};var TypedArrayUtils={quicksortIP:function(e,t,r){for(var i,n,o=[],l=-1,c=0,h=e.length/t-1,d=0,f=0,m=0,v=function(a,b){for(a*=t,b*=t,m=0;m<t;m++)d=e[a+m],e[a+m]=e[b+m],e[b+m]=d},y=new Float32Array(t),x=new Float32Array(t);;)if(h-c<=25){for(n=c+1;n<=h;n++){for(f=0;f<t;f++)y[f]=e[n*t+f];for(i=n-1;i>=c&&e[i*t+r]>y[r];){for(f=0;f<t;f++)e[(i+1)*t+f]=e[i*t+f];i--}for(f=0;f<t;f++)e[(i+1)*t+f]=y[f]}if(-1==l)break;h=o[l--],c=o[l--]}else{for(n=h,v(c+h>>1,i=c+1),e[c*t+r]>e[h*t+r]&&v(c,h),e[i*t+r]>e[h*t+r]&&v(i,h),e[c*t+r]>e[i*t+r]&&v(c,i),f=0;f<t;f++)x[f]=e[i*t+f];for(;;){do{i++}while(e[i*t+r]<x[r]);do{n--}while(e[n*t+r]>x[r]);if(n<i)break;v(i,n)}for(f=0;f<t;f++)e[(c+1)*t+f]=e[n*t+f],e[n*t+f]=x[f];h-i+1>=n-c?(o[++l]=i,o[++l]=h,h=n-1):(o[++l]=c,o[++l]=n-1,c=i)}return e},Kdtree:function(e,t,r){var n=this,o=0,l=function(e,t){return e.subarray(t*r,t*r+r)};this.root=function e(t,c,h,d){var f,m,v=c%r,y=t.length/r;return c>o&&(o=c),0===y?null:1===y?new n.Node(l(t,0),c,h,d):(TypedArrayUtils.quicksortIP(t,r,v),f=Math.floor(y/2),(m=new n.Node(l(t,f),c,h,f+d)).left=e(t.subarray(0,f*r),c+1,m,d),m.right=e(t.subarray((f+1)*r,t.length),c+1,m,d+f+1),m)}(e,0,null,0),this.getMaxDepth=function(){return o},this.nearest=function(e,o,l){var i,c,h;if(h=new TypedArrayUtils.Kdtree.BinaryHeap((function(e){return-e[1]})),l)for(i=0;i<o;i+=1)h.push([null,l]);for(function n(l){var c,d,f,i,m=l.depth%r,v=t(e,l.obj),y=[];function x(e,t){h.push([e,t]),h.size()>o&&h.pop()}for(i=0;i<r;i+=1)i===l.depth%r?y[i]=e[i]:y[i]=l.obj[i];d=t(y,l.obj),null!==l.right||null!==l.left?(n(c=null===l.right?l.left:null===l.left?l.right:e[m]<l.obj[m]?l.left:l.right),(h.size()<o||v<h.peek()[1])&&x(l,v),(h.size()<o||Math.abs(d)<h.peek()[1])&&null!==(f=c===l.left?l.right:l.left)&&n(f)):(h.size()<o||v<h.peek()[1])&&x(l,v)}(n.root),c=[],i=0;i<o;i+=1)h.content[i][0]&&c.push([h.content[i][0],h.content[i][1]]);return c}}};TypedArrayUtils.Kdtree.prototype.Node=function(e,t,r,n){this.obj=e,this.left=null,this.right=null,this.parent=r,this.depth=t,this.pos=n},TypedArrayUtils.Kdtree.BinaryHeap=function(e){this.content=[],this.scoreFunction=e},TypedArrayUtils.Kdtree.BinaryHeap.prototype={push:function(element){this.content.push(element),this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),e},peek:function(){return this.content[0]},remove:function(e){for(var t=this.content.length,i=0;i<t;i++)if(this.content[i]==e){var r=this.content.pop();return void(i!=t-1&&(this.content[i]=r,this.scoreFunction(r)<this.scoreFunction(e)?this.bubbleUp(i):this.sinkDown(i)))}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(e){for(var element=this.content[e];e>0;){var t=Math.floor((e+1)/2)-1,r=this.content[t];if(!(this.scoreFunction(element)<this.scoreFunction(r)))break;this.content[t]=element,this.content[e]=r,e=t}},sinkDown:function(e){for(var t=this.content.length,element=this.content[e],r=this.scoreFunction(element);;){var n=2*(e+1),o=n-1,l=null;if(o<t){var c=this.content[o],h=this.scoreFunction(c);h<r&&(l=o)}if(n<t){var d=this.content[n];this.scoreFunction(d)<(null===l?r:h)&&(l=n)}if(null===l)break;this.content[e]=this.content[l],this.content[l]=element,e=l}}};var GeometryUtils={merge:function(e,t,r){var n;console.warn("GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead."),t instanceof Mesh&&(t.matrixAutoUpdate&&t.updateMatrix(),n=t.matrix,t=t.geometry),e.merge(t,n,r)},randomPointInTriangle:function(){var e=new Vector3;return function(t,r,n){var o=new Vector3,a=Math.random(),b=Math.random();a+b>1&&(a=1-a,b=1-b);var l=1-a-b;return o.copy(t),o.multiplyScalar(a),e.copy(r),e.multiplyScalar(b),o.add(e),e.copy(n),e.multiplyScalar(l),o.add(e),o}}(),randomPointInFace:function(e,t){var r,n,o;return r=t.vertices[e.a],n=t.vertices[e.b],o=t.vertices[e.c],GeometryUtils.randomPointInTriangle(r,n,o)},randomPointsInGeometry:function(e,t){var r,i,n,o,l,c=e.faces,h=e.vertices,d=c.length,f=0,m=[];for(i=0;i<d;i++)n=h[(r=c[i]).a],o=h[r.b],l=h[r.c],r._area=GeometryUtils.triangleArea(n,o,l),f+=r._area,m[i]=f;var v,y,x,w=[];for(i=0;i<t;i++)v=Math.random()*f,x=v,y=function e(t,r){if(r<t)return t;var n=t+Math.floor((r-t)/2);return m[n]>x?e(t,n-1):m[n]<x?e(n+1,r):n}(0,m.length-1),w[i]=GeometryUtils.randomPointInFace(c[y],e);return w},randomPointsInBufferGeometry:function(e,t){var i,r,n,o,l=e.attributes.position.array,c=0,h=[];r=new Vector3,n=new Vector3,o=new Vector3;var d=l.length/9;for(i=0;i<d;i++)r.set(l[9*i+0],l[9*i+1],l[9*i+2]),n.set(l[9*i+3],l[9*i+4],l[9*i+5]),o.set(l[9*i+6],l[9*i+7],l[9*i+8]),c+=GeometryUtils.triangleArea(r,n,o),h.push(c);var f,m,v,y=[];for(i=0;i<t;i++)f=Math.random()*c,v=f,m=function e(t,r){if(r<t)return t;var n=t+Math.floor((r-t)/2);return h[n]>v?e(t,n-1):h[n]<v?e(n+1,r):n}(0,h.length-1),r.set(l[9*m+0],l[9*m+1],l[9*m+2]),n.set(l[9*m+3],l[9*m+4],l[9*m+5]),o.set(l[9*m+6],l[9*m+7],l[9*m+8]),y[i]=GeometryUtils.randomPointInTriangle(r,n,o);return y},triangleArea:(vector1=new Vector3,vector2=new Vector3,function(e,t,r){return vector1.subVectors(t,e),vector2.subVectors(r,e),vector1.cross(vector2),.5*vector1.length()}),center:function(e){return console.warn("GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},vector1,vector2,MathUtils={setQuaternionFromProperEuler:function(q,a,b,e,t){var r=Math.cos,n=Math.sin,o=r(b/2),l=n(b/2),c=r((a+e)/2),h=n((a+e)/2),d=r((a-e)/2),f=n((a-e)/2),m=r((e-a)/2),v=n((e-a)/2);"XYX"===t?q.set(o*h,l*d,l*f,o*c):"YZY"===t?q.set(l*f,o*h,l*d,o*c):"ZXZ"===t?q.set(l*d,l*f,o*h,o*c):"XZX"===t?q.set(o*h,l*v,l*m,o*c):"YXY"===t?q.set(l*m,o*h,l*v,o*c):"ZYZ"===t?q.set(l*v,l*m,o*h,o*c):console.warn("MathUtils: .setQuaternionFromProperEuler() encountered an unknown order.")}},SceneUtils={createMultiMaterialObject:function(e,t){for(var r=new Group,i=0,n=t.length;i<n;i++)r.add(new Mesh(e,t[i]));return r},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(e,t,r){e.applyMatrix((new Matrix4).getInverse(r.matrixWorld)),t.remove(e),r.add(e)}},ShadowMapViewer=function(e){var t,r=this,n=void 0!==e.name&&""!==e.name,o=10,l=10,c=256,h=256,d=new OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,1,10);d.position.set(0,0,2);var f,m,v=new Scene,y=UnpackDepthRGBAShader,x=new UniformsUtils.clone(y.uniforms),w=new ShaderMaterial({uniforms:x,vertexShader:y.vertexShader,fragmentShader:y.fragmentShader}),M=new Mesh(new PlaneBufferGeometry(c,h),w);if(v.add(M),n){var S=(f=document.createElement("canvas")).getContext("2d");S.font="Bold 20px Arial";var A=S.measureText(e.name).width;f.width=A,f.height=25,S.font="Bold 20px Arial",S.fillStyle="rgba( 255, 0, 0, 1 )",S.fillText(e.name,0,20);var T=new Texture(f);T.magFilter=LinearFilter,T.minFilter=LinearFilter,T.needsUpdate=!0;var _=new MeshBasicMaterial({map:T,side:DoubleSide});_.transparent=!0;var L=new PlaneBufferGeometry(f.width,f.height);m=new Mesh(L,_),v.add(m)}this.enabled=!0,this.size={width:c,height:h,set:function(e,t){this.width=e,this.height=t,M.scale.set(this.width/c,this.height/h,1),r.position.set(r.position.x,r.position.y)}},this.position={x:o,y:l,set:function(e,t){this.x=e,this.y=t;var o=r.size.width,l=r.size.height;M.position.set(-window.innerWidth/2+o/2+this.x,window.innerHeight/2-l/2-this.y,0),n&&m.position.set(M.position.x,M.position.y-r.size.height/2+f.height/2,0)}},this.render=function(r){this.enabled&&(x.tDiffuse.value=e.shadow.map.texture,t=r.autoClear,r.autoClear=!1,r.clearDepth(),r.render(v,d),r.autoClear=t)},this.updateForWindowResize=function(){this.enabled&&(d.left=window.innerWidth/-2,d.right=window.innerWidth/2,d.top=window.innerHeight/2,d.bottom=window.innerHeight/-2,d.updateProjectionMatrix(),this.update())},this.update=function(){this.position.set(this.position.x,this.position.y),this.size.set(this.size.width,this.size.height)},this.update()};function getBoneList(object){var e=[];object&&object.isBone&&e.push(object);for(var i=0;i<object.children.length;i++)e.push.apply(e,getBoneList(object.children[i]));return e}function SkeletonHelper(object){for(var e=getBoneList(object),t=new BufferGeometry,r=[],n=[],o=new Color(0,0,1),l=new Color(0,1,0),i=0;i<e.length;i++){var c=e[i];c.parent&&c.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),n.push(o.r,o.g,o.b),n.push(l.r,l.g,l.b))}t.addAttribute("position",new Float32BufferAttribute(r,3)),t.addAttribute("color",new Float32BufferAttribute(n,3));var h=new LineBasicMaterial({vertexColors:VertexColors,depthTest:!1,depthWrite:!1,transparent:!0});LineSegments.call(this,t,h),this.root=object,this.bones=e,this.matrix=object.matrixWorld,this.matrixAutoUpdate=!1}ShadowMapViewer.prototype.constructor=ShadowMapViewer,SkeletonHelper.prototype=Object.create(LineSegments.prototype),SkeletonHelper.prototype.constructor=SkeletonHelper,SkeletonHelper.prototype.updateMatrixWorld=function(){var e=new Vector3,t=new Matrix4,r=new Matrix4;return function(n){var o=this.bones,l=this.geometry,c=l.getAttribute("position");r.getInverse(this.root.matrixWorld);for(var i=0,h=0;i<o.length;i++){var d=o[i];d.parent&&d.parent.isBone&&(t.multiplyMatrices(r,d.matrixWorld),e.setFromMatrixPosition(t),c.setXYZ(h,e.x,e.y,e.z),t.multiplyMatrices(r,d.parent.matrixWorld),e.setFromMatrixPosition(t),c.setXYZ(h+1,e.x,e.y,e.z),h+=2)}l.getAttribute("position").needsUpdate=!0,Object3D.prototype.updateMatrixWorld.call(this,n)}}();var SkeletonUtils={retarget:function(){var e=new Vector3,t=new Quaternion,r=new Vector3,n=new Matrix4,o=new Matrix4,l=new Matrix4;return function(c,source,h){(h=h||{}).preserveMatrix=void 0===h.preserveMatrix||h.preserveMatrix,h.preservePosition=void 0===h.preservePosition||h.preservePosition,h.preserveHipPosition=void 0!==h.preserveHipPosition&&h.preserveHipPosition,h.useTargetMatrix=void 0!==h.useTargetMatrix&&h.useTargetMatrix,h.hip=void 0!==h.hip?h.hip:"hip",h.names=h.names||{};var d,f,m,v,y,i,x=source.isObject3D?source.skeleton.bones:this.getBones(source),w=c.isObject3D?c.skeleton.bones:this.getBones(c);if(c.isObject3D?c.skeleton.pose():(h.useTargetMatrix=!0,h.preserveMatrix=!1),h.preservePosition)for(y=[],i=0;i<w.length;i++)y.push(w[i].position.clone());if(h.preserveMatrix)for(c.updateMatrixWorld(),c.matrixWorld.identity(),i=0;i<c.children.length;++i)c.children[i].updateMatrixWorld(!0);if(h.offsets)for(d=[],i=0;i<w.length;++i)f=w[i],m=h.names[f.name]||f.name,h.offsets&&h.offsets[m]&&(f.matrix.multiply(h.offsets[m]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),d.push(f.matrixWorld.clone());for(i=0;i<w.length;++i){if(f=w[i],m=h.names[f.name]||f.name,v=this.getBoneByName(m,x),l.copy(f.matrixWorld),v){if(v.updateMatrixWorld(),h.useTargetMatrix?o.copy(v.matrixWorld):(o.getInverse(c.matrixWorld),o.multiply(v.matrixWorld)),r.setFromMatrixScale(o),o.scale(r.set(1/r.x,1/r.y,1/r.z)),l.makeRotationFromQuaternion(t.setFromRotationMatrix(o)),c.isObject3D){var M=w.indexOf(f),S=d?d[M]:n.getInverse(c.skeleton.boneInverses[M]);l.multiply(S)}l.copyPosition(o)}f.parent&&f.parent.isBone?(f.matrix.getInverse(f.parent.matrixWorld),f.matrix.multiply(l)):f.matrix.copy(l),h.preserveHipPosition&&m===h.hip&&f.matrix.setPosition(e.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(h.preservePosition)for(i=0;i<w.length;++i)f=w[i],(m=h.names[f.name]||f.name)!==h.hip&&f.position.copy(y[i]);h.preserveMatrix&&c.updateMatrixWorld(!0)}}(),retargetClip:function(e,source,t,r){(r=r||{}).useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],source.isObject3D||(source=this.getHelperFromSkeleton(source));var n,o,l,c,i,h,d=Math.round(t.duration*(r.fps/1e3)*1e3),f=1/r.fps,m=[],v=new AnimationMixer(source),y=this.getBones(e.skeleton),x=[];for(v.clipAction(t).play(),v.update(0),source.updateMatrixWorld(),i=0;i<d;++i){var time=i*f;for(this.retarget(e,source,r),h=0;h<y.length;++h)c=r.names[y[h].name]||y[h].name,this.getBoneByName(c,source.skeleton)&&(o=y[h],l=x[h]=x[h]||{bone:o},r.hip===c&&(l.pos||(l.pos={times:new Float32Array(d),values:new Float32Array(3*d)}),r.useFirstFramePosition&&(0===i&&(n=o.position.clone()),o.position.sub(n)),l.pos.times[i]=time,o.position.toArray(l.pos.values,3*i)),l.quat||(l.quat={times:new Float32Array(d),values:new Float32Array(4*d)}),l.quat.times[i]=time,o.quaternion.toArray(l.quat.values,4*i));v.update(f),source.updateMatrixWorld()}for(i=0;i<x.length;++i)(l=x[i])&&(l.pos&&m.push(new VectorKeyframeTrack(".bones["+l.bone.name+"].position",l.pos.times,l.pos.values)),m.push(new QuaternionKeyframeTrack(".bones["+l.bone.name+"].quaternion",l.quat.times,l.quat.values)));return v.uncacheAction(t),new AnimationClip(t.name,-1,m)},getHelperFromSkeleton:function(e){var source=new SkeletonHelper(e.bones[0]);return source.skeleton=e,source},getSkeletonOffsets:(targetParentPos=new Vector3,targetPos=new Vector3,sourceParentPos=new Vector3,sourcePos=new Vector3,targetDir=new Vector2,sourceDir=new Vector2,function(e,source,t){(t=t||{}).hip=void 0!==t.hip?t.hip:"hip",t.names=t.names||{},source.isObject3D||(source=this.getHelperFromSkeleton(source));var r,n,o,i,l=Object.keys(t.names),c=Object.values(t.names),h=source.isObject3D?source.skeleton.bones:this.getBones(source),d=e.isObject3D?e.skeleton.bones:this.getBones(e),f=[];for(e.skeleton.pose(),i=0;i<d.length;++i)if(r=d[i],o=t.names[r.name]||r.name,(n=this.getBoneByName(o,h))&&o!==t.hip){var m=this.getNearestBone(r.parent,l),v=this.getNearestBone(n.parent,c);m.updateMatrixWorld(),v.updateMatrixWorld(),targetParentPos.setFromMatrixPosition(m.matrixWorld),targetPos.setFromMatrixPosition(r.matrixWorld),sourceParentPos.setFromMatrixPosition(v.matrixWorld),sourcePos.setFromMatrixPosition(n.matrixWorld),targetDir.subVectors(new Vector2(targetPos.x,targetPos.y),new Vector2(targetParentPos.x,targetParentPos.y)).normalize(),sourceDir.subVectors(new Vector2(sourcePos.x,sourcePos.y),new Vector2(sourceParentPos.x,sourceParentPos.y)).normalize();var y=targetDir.angle()-sourceDir.angle(),x=(new Matrix4).makeRotationFromEuler(new Euler(0,0,y));r.matrix.multiply(x),r.matrix.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(),f[o]=x}return f}),renameBones:function(e,t){for(var r=this.getBones(e),i=0;i<r.length;++i){var n=r[i];t[n.name]&&(n.name=t[n.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var i=0,r=this.getBones(t);i<r.length;i++)if(e===r[i].name)return r[i]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){for(var r=/\[(.*)\]\.(.*)/,n={name:e},i=0;i<t.length;++i){var o=r.exec(t[i].name);o&&e===o[1]&&(n[o[2]]=i)}return n},getEqualsBonesNames:function(e,t){var r=this.getBones(e),n=this.getBones(t),o=[];e:for(var i=0;i<r.length;i++)for(var l=r[i].name,c=0;c<n.length;c++)if(l===n[c].name){o.push(l);continue e}return o}},targetParentPos,targetPos,sourceParentPos,sourcePos,targetDir,sourceDir,UVsDebug=function(e,t){var r="abc",a=new Vector2,b=new Vector2,n=[new Vector2,new Vector2,new Vector2],o=[],canvas=document.createElement("canvas"),l=t||1024,c=t||1024;canvas.width=l,canvas.height=c;var h=canvas.getContext("2d");if(h.lineWidth=2,h.strokeStyle="rgba( 0, 0, 0, 1.0 )",h.textAlign="center",h.fillStyle="rgba( 255, 255, 255, 1.0 )",h.fillRect(0,0,l,c),e.isGeometry)for(var d=e.faces,f=e.faceVertexUvs[0],i=0,m=f.length;i<m;i++){o=d[i];var v=f[i];o[0]=o.a,o[1]=o.b,o[2]=o.c,n[0].copy(v[0]),n[1].copy(v[1]),n[2].copy(v[2]),w(o,n,i)}else{var y=e.index,x=e.attributes.uv;if(y)for(i=0,m=y.count;i<m;i+=3)o[0]=y.getX(i),o[1]=y.getX(i+1),o[2]=y.getX(i+2),n[0].fromBufferAttribute(x,o[0]),n[1].fromBufferAttribute(x,o[1]),n[2].fromBufferAttribute(x,o[2]),w(o,n,i);else for(i=0,m=x.count;i<m;i+=3)o[0]=i,o[1]=i+1,o[2]=i+2,n[0].fromBufferAttribute(x,o[0]),n[1].fromBufferAttribute(x,o[1]),n[2].fromBufferAttribute(x,o[2]),w(o,n,i)}return canvas;function w(e,t,n){h.beginPath(),a.set(0,0);for(var o=0,d=t.length;o<d;o++){var f=t[o];a.x+=f.x,a.y+=f.y,0===o?h.moveTo(f.x*l,(1-f.y)*c):h.lineTo(f.x*l,(1-f.y)*c)}for(h.closePath(),h.stroke(),a.divideScalar(t.length),h.font="12pt Arial bold",h.fillStyle="rgba( 0, 0, 0, 1.0 )",h.fillText(n,a.x*l,(1-a.y)*c),a.x>.95&&h.fillText(n,a.x%1*l,(1-a.y)*c),h.font="8pt Arial bold",h.fillStyle="rgba( 0, 0, 0, 1.0 )",o=0,d=t.length;o<d;o++){f=t[o];b.addVectors(a,f).divideScalar(2);var m=e[o];h.fillText(r[o]+m,b.x*l,(1-b.y)*c),b.x>.95&&h.fillText(r[o]+m,b.x%1*l,(1-b.y)*c)}}},VolumeSlice=function(e,t,r){var n=this;this.volume=e,t=t||0,Object.defineProperty(this,"index",{get:function(){return t},set:function(e){return t=e,n.geometryNeedsUpdate=!0,t}}),this.axis=r||"z",this.canvas=document.createElement("canvas"),this.canvasBuffer=document.createElement("canvas"),this.updateGeometry();var o=new Texture(this.canvas);o.minFilter=LinearFilter,o.wrapS=o.wrapT=ClampToEdgeWrapping;var l=new MeshBasicMaterial({map:o,side:DoubleSide,transparent:!0});this.mesh=new Mesh(this.geometry,l),this.geometryNeedsUpdate=!0,this.repaint()};VolumeSlice.prototype={constructor:VolumeSlice,repaint:function(){this.geometryNeedsUpdate&&this.updateGeometry();var e=this.iLength,t=this.jLength,r=this.sliceAccess,n=this.volume,canvas=this.canvasBuffer,o=this.ctxBuffer,l=o.getImageData(0,0,e,t),data=l.data,c=n.data,h=n.upperThreshold,d=n.lowerThreshold,f=n.windowLow,m=n.windowHigh,v=0;if("label"===n.dataType)for(var y=0;y<t;y++)for(var i=0;i<e;i++){var label=c[r(i,y)];label=label>=this.colorMap.length?label%this.colorMap.length+1:label;var x=this.colorMap[label];data[4*v]=x>>24&255,data[4*v+1]=x>>16&255,data[4*v+2]=x>>8&255,data[4*v+3]=255&x,v++}else for(y=0;y<t;y++)for(i=0;i<e;i++){var w=c[r(i,y)],M=255;M=h>=w&&d<=w?M:0,w=(w=Math.floor(255*(w-f)/(m-f)))>255?255:w<0?0:0|w,data[4*v]=w,data[4*v+1]=w,data[4*v+2]=w,data[4*v+3]=M,v++}o.putImageData(l,0,0),this.ctx.drawImage(canvas,0,0,e,t,0,0,this.canvas.width,this.canvas.height),this.mesh.material.map.needsUpdate=!0},updateGeometry:function(){var e=this.volume.extractPerpendicularPlane(this.axis,this.index);this.sliceAccess=e.sliceAccess,this.jLength=e.jLength,this.iLength=e.iLength,this.matrix=e.matrix,this.canvas.width=e.planeWidth,this.canvas.height=e.planeHeight,this.canvasBuffer.width=this.iLength,this.canvasBuffer.height=this.jLength,this.ctx=this.canvas.getContext("2d"),this.ctxBuffer=this.canvasBuffer.getContext("2d"),this.geometry&&this.geometry.dispose(),this.geometry=new PlaneBufferGeometry(e.planeWidth,e.planeHeight),this.mesh&&(this.mesh.geometry=this.geometry,this.mesh.matrix.identity(),this.mesh.applyMatrix(this.matrix)),this.geometryNeedsUpdate=!1}};var DaydreamController=function(){Object3D.call(this);var e,t=this,r=[0,0],n=!1,o=new Vector3;this.matrixAutoUpdate=!1,this.getGamepad=function(){return e},this.getTouchpadState=function(){return n},this.update=function(){if(void 0!==(e=function(){for(var e=navigator.getGamepads&&navigator.getGamepads(),i=0;i<4;i++){var t=e[i];if(t&&"Daydream Controller"===t.id)return t}}())&&void 0!==e.pose){var l=e.pose;if(null===l)return;null!==l.orientation&&t.quaternion.fromArray(l.orientation),t.updateMatrix(),t.visible=!0,null===l.angularVelocity||o.equals(l.angularVelocity)||(o.fromArray(l.angularVelocity),t.dispatchEvent({type:"angularvelocitychanged",angularVelocity:o})),r[0]===e.axes[0]&&r[1]===e.axes[1]||(r[0]=e.axes[0],r[1]=e.axes[1],t.dispatchEvent({type:"axischanged",axes:r})),n!==e.buttons[0].pressed&&(n=e.buttons[0].pressed,t.dispatchEvent({type:n?"touchpaddown":"touchpadup"}))}else t.visible=!1},this.getTouchPadState=function(){return console.warn("DaydreamController: getTouchPadState() is now getTouchpadState()"),n}};DaydreamController.prototype=Object.create(Object3D.prototype),DaydreamController.prototype.constructor=DaydreamController;var GearVRController=function(){Object3D.call(this);var e,t=this,r=[0,0],n=!1,o=!1,l=new Vector3;this.matrixAutoUpdate=!0,this.getGamepad=function(){return e},this.getTouchpadState=function(){return n},this.update=function(){if(void 0!==(e=function(){for(var e=navigator.getGamepads&&navigator.getGamepads(),i=0;i<4;i++){var t=e[i];if(t&&("Gear VR Controller"===t.id||"Oculus Go Controller"===t.id))return t}}())&&void 0!==e.pose){var c=e.pose;if(null===c)return;null!==c.orientation&&t.quaternion.fromArray(c.orientation),t.updateMatrix(),t.visible=!0,null===c.angularVelocity||l.equals(c.angularVelocity)||(l.fromArray(c.angularVelocity),t.dispatchEvent({type:"angularvelocitychanged",angularVelocity:l})),r[0]===e.axes[0]&&r[1]===e.axes[1]||(r[0]=e.axes[0],r[1]=e.axes[1],t.dispatchEvent({type:"axischanged",axes:r})),n!==e.buttons[0].pressed&&(n=e.buttons[0].pressed,t.dispatchEvent({type:n?"touchpaddown":"touchpadup",axes:r})),o!==e.buttons[1].pressed&&(o=e.buttons[1].pressed,t.dispatchEvent({type:o?"triggerdown":"triggerup"}))}else t.visible=!1},this.getTouchPadState=function(){return console.warn("GearVRController: getTouchPadState() is now getTouchpadState()"),n},this.setHand=function(){console.warn("GearVRController: setHand() has been removed.")}};GearVRController.prototype=Object.create(Object3D.prototype),GearVRController.prototype.constructor=GearVRController;var ViveController=function(e){Object3D.call(this);var t,r=this,n=[0,0],o=!1,l=!1,c=!1,h=!1;this.matrixAutoUpdate=!1,this.standingMatrix=new Matrix4,this.getGamepad=function(){return t},this.getButtonState=function(button){return"thumbpad"===button?o:"trigger"===button?l:"grips"===button?c:"menu"===button?h:void 0},this.update=function(){if(void 0!==(t=function(e){for(var t=navigator.getGamepads&&navigator.getGamepads(),i=0,r=0;i<t.length;i++){var n=t[i];if(n&&("OpenVR Gamepad"===n.id||n.id.startsWith("Oculus Touch")||n.id.startsWith("Spatial Controller"))){if(r===e)return n;r++}}}(e))&&void 0!==t.pose){if(null===t.pose)return;var d=t.pose;null!==d.position&&r.position.fromArray(d.position),null!==d.orientation&&r.quaternion.fromArray(d.orientation),r.matrix.compose(r.position,r.quaternion,r.scale),r.matrix.premultiply(r.standingMatrix),r.matrixWorldNeedsUpdate=!0,r.visible=!0,n[0]===t.axes[0]&&n[1]===t.axes[1]||(n[0]=t.axes[0],n[1]=t.axes[1],r.dispatchEvent({type:"axischanged",axes:n})),o!==t.buttons[0].pressed&&(o=t.buttons[0].pressed,r.dispatchEvent({type:o?"thumbpaddown":"thumbpadup",axes:n})),l!==t.buttons[1].pressed&&(l=t.buttons[1].pressed,r.dispatchEvent({type:l?"triggerdown":"triggerup"})),c!==t.buttons[2].pressed&&(c=t.buttons[2].pressed,r.dispatchEvent({type:c?"gripsdown":"gripsup"})),h!==t.buttons[3].pressed&&(h=t.buttons[3].pressed,r.dispatchEvent({type:h?"menudown":"menuup"}))}else r.visible=!1}};function CircleGeometry(e,t,r,n){Geometry.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},this.fromBufferGeometry(new CircleBufferGeometry(e,t,r,n)),this.mergeVertices()}function CircleBufferGeometry(e,t,r,n){BufferGeometry.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},e=e||1,t=void 0!==t?Math.max(3,t):8,r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI;var i,s,o=[],l=[],c=[],h=[],d=new Vector3,f=new Vector2;for(l.push(0,0,0),c.push(0,0,1),h.push(.5,.5),s=0,i=3;s<=t;s++,i+=3){var m=r+s/t*n;d.x=e*Math.cos(m),d.y=e*Math.sin(m),l.push(d.x,d.y,d.z),c.push(0,0,1),f.x=(l[i]/e+1)/2,f.y=(l[i+1]/e+1)/2,h.push(f.x,f.y)}for(i=1;i<=t;i++)o.push(i,i+1,0);this.setIndex(o),this.addAttribute("position",new Float32BufferAttribute(l,3)),this.addAttribute("normal",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(h,2))}function IcosahedronGeometry(e,t){Geometry.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new IcosahedronBufferGeometry(e,t)),this.mergeVertices()}function IcosahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2,n=[-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1];PolyhedronBufferGeometry.call(this,n,[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function ShapeGeometry(e,t){Geometry.call(this),this.type="ShapeGeometry","object"==typeof t&&(console.warn("ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new ShapeBufferGeometry(e,t)),this.mergeVertices()}function ShapeBufferGeometry(e,t){BufferGeometry.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var r=[],n=[],o=[],l=[],c=0,h=0;if(!1===Array.isArray(e))d(e);else for(var i=0;i<e.length;i++)d(e[i]),this.addGroup(c,h,i),c+=h,h=0;function d(e){var i,c,d,f=n.length/3,m=e.extractPoints(t),v=m.shape,y=m.holes;for(!1===ShapeUtils.isClockWise(v)&&(v=v.reverse()),i=0,c=y.length;i<c;i++)d=y[i],!0===ShapeUtils.isClockWise(d)&&(y[i]=d.reverse());var x=ShapeUtils.triangulateShape(v,y);for(i=0,c=y.length;i<c;i++)d=y[i],v=v.concat(d);for(i=0,c=v.length;i<c;i++){var w=v[i];n.push(w.x,w.y,0),o.push(0,0,1),l.push(w.x,w.y)}for(i=0,c=x.length;i<c;i++){var M=x[i],a=M[0]+f,b=M[1]+f,S=M[2]+f;r.push(a,b,S),h+=3}}this.setIndex(r),this.addAttribute("position",new Float32BufferAttribute(n,3)),this.addAttribute("normal",new Float32BufferAttribute(o,3)),this.addAttribute("uv",new Float32BufferAttribute(l,2))}function toJSON(e,data){if(data.shapes=[],Array.isArray(e))for(var i=0,t=e.length;i<t;i++){var r=e[i];data.shapes.push(r.uuid)}else data.shapes.push(e.uuid);return data}ViveController.prototype=Object.create(Object3D.prototype),ViveController.prototype.constructor=ViveController,CircleGeometry.prototype=Object.create(Geometry.prototype),CircleGeometry.prototype.constructor=CircleGeometry,CircleBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CircleBufferGeometry.prototype.constructor=CircleBufferGeometry,IcosahedronGeometry.prototype=Object.create(Geometry.prototype),IcosahedronGeometry.prototype.constructor=IcosahedronGeometry,IcosahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),IcosahedronBufferGeometry.prototype.constructor=IcosahedronBufferGeometry,ShapeGeometry.prototype=Object.create(Geometry.prototype),ShapeGeometry.prototype.constructor=ShapeGeometry,ShapeGeometry.prototype.toJSON=function(){var data=Geometry.prototype.toJSON.call(this);return toJSON(this.parameters.shapes,data)},ShapeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ShapeBufferGeometry.prototype.constructor=ShapeBufferGeometry,ShapeBufferGeometry.prototype.toJSON=function(){var data=BufferGeometry.prototype.toJSON.call(this);return toJSON(this.parameters.shapes,data)};var PaintViveController=function(e){ViveController.call(this,e);var t=2*Math.PI,r={COLOR:0,SIZE:1},n=r.COLOR,o=new Color(1,1,1),l=1;var c=new Mesh(h=new CircleBufferGeometry(1,32),y=new MeshBasicMaterial({map:function(){var canvas=document.createElement("canvas");canvas.width=256,canvas.height=256;for(var e=canvas.getContext("2d"),r=e.getImageData(0,0,256,256),data=r.data,n=new Color,i=0,o=0;i<data.length;i+=4,o++){var l=o%256/256-.5,c=Math.floor(o/256)/256-.5;n.setHSL(Math.atan2(c,l)/t,1,2*(.5-Math.sqrt(l*l+c*c))),data[i+0]=256*n.r,data[i+1]=256*n.g,data[i+2]=256*n.b,data[i+3]=256}return e.putImageData(r,0,0),new CanvasTexture(canvas)}()}));c.position.set(0,.005,.0495),c.rotation.x=-1.45,c.scale.setScalar(.02),this.add(c);var h=new IcosahedronBufferGeometry(.1,2);(y=new MeshBasicMaterial).color=o;var d=new Mesh(h,y);c.add(d);var f=new Group;f.position.set(0,.005,.0495),f.rotation.x=-1.45,f.scale.setScalar(.02),this.add(f);var m=new Shape;m.moveTo(0,-1),m.lineTo(1,1),m.lineTo(-1,1);var v=new Mesh(h=new ShapeBufferGeometry(m),y=new MeshBasicMaterial({color:2236962,wireframe:!0}));v.position.z=.001,w(v.geometry,1),f.add(v);var y;h=new ShapeBufferGeometry(m);(y=new MeshBasicMaterial({side:DoubleSide})).color=o;var x=new Mesh(h,y);function w(e,t){var r=Math.atan(.25),n=1.5*t,o=Math.tan(r)*n*2,l=e.attributes.position;l.setXYZ(0,0,-.75,0),l.setXYZ(1,0+o/2,-.75+n,0),l.setXYZ(2,0-o/2,-.75+n,0),l.needsUpdate=!0}x.position.z=.0011,w(x.geometry,.5),f.add(x),f.visible=!1,this.getColor=function(){return o},this.getSize=function(){return l},this.addEventListener("axischanged",(function(e){if(!1!==this.getButtonState("thumbpad")){var c=e.axes[0]/2,h=-e.axes[1]/2;if(n===r.COLOR&&(o.setHSL(Math.atan2(h,c)/t,1,2*(.5-Math.sqrt(c*c+h*h))),d.position.set(e.axes[0],e.axes[1],0)),n===r.SIZE){var f=.5-h;l=2*f,w(x.geometry,f)}}})),this.addEventListener("gripsdown",(function(){return n===r.COLOR?(n=r.SIZE,c.visible=!1,void(f.visible=!0)):n===r.SIZE?(n=r.COLOR,c.visible=!0,void(f.visible=!1)):void 0}))};PaintViveController.prototype=Object.create(ViveController.prototype),PaintViveController.prototype.constructor=PaintViveController;var WebVR={createButton:function(e,t){function r(t){button.style.display="",button.style.cursor="pointer",button.style.left="calc(50% - 50px)",button.style.width="100px",button.textContent="ENTER VR",button.onmouseenter=function(){button.style.opacity="1.0"},button.onmouseleave=function(){button.style.opacity="0.5"},button.onclick=function(){t.isPresenting?t.exitPresent():t.requestPresent([{source:e.domElement}])},e.vr.setDevice(t)}function n(){button.style.display="",button.style.cursor="auto",button.style.left="calc(50% - 75px)",button.style.width="150px",button.textContent="VR NOT FOUND",button.onmouseenter=null,button.onmouseleave=null,button.onclick=null,e.vr.setDevice(null)}function o(element){element.style.position="absolute",element.style.bottom="20px",element.style.padding="12px 6px",element.style.border="1px solid #fff",element.style.borderRadius="4px",element.style.background="rgba(0,0,0,0.1)",element.style.color="#fff",element.style.font="normal 13px sans-serif",element.style.textAlign="center",element.style.opacity="0.5",element.style.outline="none",element.style.zIndex="999"}var button;if(t&&t.frameOfReferenceType&&e.vr.setFrameOfReferenceType(t.frameOfReferenceType),"xr"in navigator)return(button=document.createElement("button")).style.display="none",o(button),navigator.xr.requestDevice().then((function(t){t.supportsSession({immersive:!0,exclusive:!0}).then((function(){!function(t){var r=null;function n(t){t.addEventListener("end",o),e.vr.setSession(t),button.textContent="EXIT VR",r=t}function o(t){r.removeEventListener("end",o),e.vr.setSession(null),button.textContent="ENTER VR",r=null}button.style.display="",button.style.cursor="pointer",button.style.left="calc(50% - 50px)",button.style.width="100px",button.textContent="ENTER VR",button.onmouseenter=function(){button.style.opacity="1.0"},button.onmouseleave=function(){button.style.opacity="0.5"},button.onclick=function(){null===r?t.requestSession({immersive:!0,exclusive:!0}).then(n):r.end()},e.vr.setDevice(t)}(t)})).catch(n)})).catch(n),button;if("getVRDisplays"in navigator)return(button=document.createElement("button")).style.display="none",o(button),window.addEventListener("vrdisplayconnect",(function(e){r(e.display)}),!1),window.addEventListener("vrdisplaydisconnect",(function(e){n()}),!1),window.addEventListener("vrdisplaypresentchange",(function(e){button.textContent=e.display.isPresenting?"EXIT VR":"ENTER VR"}),!1),window.addEventListener("vrdisplayactivate",(function(t){t.display.requestPresent([{source:e.domElement}])}),!1),navigator.getVRDisplays().then((function(e){e.length>0?r(e[0]):n()})).catch(n),button;var l=document.createElement("a");return l.href="https://webvr.info",l.innerHTML="WEBVR NOT SUPPORTED",l.style.left="calc(50% - 90px)",l.style.width="180px",l.style.textDecoration="none",o(l),l},checkAvailability:function(){return console.warn("WEBVR.checkAvailability has been deprecated."),new Promise((function(){}))},getMessageContainer:function(){return console.warn("WEBVR.getMessageContainer has been deprecated."),document.createElement("div")},getButton:function(){return console.warn("WEBVR.getButton has been deprecated."),document.createElement("div")},getVRDisplay:function(){console.warn("WEBVR.getVRDisplay has been deprecated.")}},WebGL={isWebGLAvailable:function(){try{var canvas=document.createElement("canvas");return!(!window.WebGLRenderingContext||!canvas.getContext("webgl")&&!canvas.getContext("experimental-webgl"))}catch(e){return!1}},isWebGL2Available:function(){try{var canvas=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!canvas.getContext("webgl2"))}catch(e){return!1}},getWebGLErrorMessage:function(){return this.getErrorMessage(1)},getWebGL2ErrorMessage:function(){return this.getErrorMessage(2)},getErrorMessage:function(e){var t={1:window.WebGLRenderingContext,2:window.WebGL2RenderingContext},r='Your $0 does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">$1</a>',element=document.createElement("div");return element.id="webglmessage",element.style.fontFamily="monospace",element.style.fontSize="13px",element.style.fontWeight="normal",element.style.textAlign="center",element.style.background="#fff",element.style.color="#000",element.style.padding="1.5em",element.style.width="400px",element.style.margin="5em auto 0",r=(r=t[e]?r.replace("$0","graphics card"):r.replace("$0","browser")).replace("$1",{1:"WebGL",2:"WebGL 2"}[e]),element.innerHTML=r,element}},context;function AnimationObjectGroup(){var e=arguments;this.uuid=_Math.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var i=0,r=arguments.length;i!==r;++i)t[e[i].uuid]=i;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var n=this;this.stats={objects:{get total(){return n._objects.length},get inUse(){return this.total-n.nCachedObjects_}},get bindingsPerObject(){return n._bindings.length}}}function Audio(e){Object3D.call(this),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.startTime=0,this.offset=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function AudioAnalyser(audio,e){this.analyser=audio.context.createAnalyser(),this.analyser.fftSize=void 0!==e?e:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),audio.getOutput().connect(this.analyser)}Object.assign(AnimationObjectGroup.prototype,{isAnimationObjectGroup:!0,add:function(){for(var e=arguments,t=this._objects,r=t.length,n=this.nCachedObjects_,o=this._indicesByUUID,l=this._paths,c=this._parsedPaths,h=this._bindings,d=h.length,f=void 0,i=0,m=arguments.length;i!==m;++i){var object=e[i],v=object.uuid,y=o[v];if(void 0===y){y=r++,o[v]=y,t.push(object);for(var x=0,w=d;x!==w;++x)h[x].push(new PropertyBinding(object,l[x],c[x]))}else if(y<n){f=t[y];var M=--n,S=t[M];o[S.uuid]=y,t[y]=S,o[v]=M,t[M]=object;for(x=0,w=d;x!==w;++x){var A=h[x],T=A[M],_=A[y];A[y]=T,void 0===_&&(_=new PropertyBinding(object,l[x],c[x])),A[M]=_}}else t[y]!==f&&console.error("AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=n},remove:function(){for(var e=arguments,t=this._objects,r=this.nCachedObjects_,n=this._indicesByUUID,o=this._bindings,l=o.length,i=0,c=arguments.length;i!==c;++i){var object=e[i],h=object.uuid,d=n[h];if(void 0!==d&&d>=r){var f=r++,m=t[f];n[m.uuid]=d,t[d]=m,n[h]=f,t[f]=object;for(var v=0,y=l;v!==y;++v){var x=o[v],w=x[f],M=x[d];x[d]=w,x[f]=M}}}this.nCachedObjects_=r},uncache:function(){for(var e=arguments,t=this._objects,r=t.length,n=this.nCachedObjects_,o=this._indicesByUUID,l=this._bindings,c=l.length,i=0,h=arguments.length;i!==h;++i){var object=e[i],d=object.uuid,f=o[d];if(void 0!==f)if(delete o[d],f<n){var m=--n,v=t[m],y=t[A=--r];o[v.uuid]=f,t[f]=v,o[y.uuid]=m,t[m]=y,t.pop();for(var x=0,w=c;x!==w;++x){var M=(T=l[x])[m],S=T[A];T[f]=M,T[m]=S,T.pop()}}else{var A;o[(y=t[A=--r]).uuid]=f,t[f]=y,t.pop();for(x=0,w=c;x!==w;++x){var T;(T=l[x])[f]=T[A],T.pop()}}}this.nCachedObjects_=n},subscribe_:function(path,e){var t=this._bindingsIndicesByPath,r=t[path],n=this._bindings;if(void 0!==r)return n[r];var o=this._paths,l=this._parsedPaths,c=this._objects,h=c.length,d=this.nCachedObjects_,f=new Array(h);r=n.length,t[path]=r,o.push(path),l.push(e),n.push(f);for(var i=d,m=c.length;i!==m;++i){var object=c[i];f[i]=new PropertyBinding(object,path,e)}return f},unsubscribe_:function(path){var e=this._bindingsIndicesByPath,t=e[path];if(void 0!==t){var r=this._paths,n=this._parsedPaths,o=this._bindings,l=o.length-1,c=o[l];e[path[l]]=t,o[t]=c,o.pop(),n[t]=n[l],n.pop(),r[t]=r[l],r.pop()}}}),Audio.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Audio,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setMediaElementSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying){if(!1!==this.hasPlaybackControl){var source=this.context.createBufferSource();return source.buffer=this.buffer,source.loop=this.loop,source.onended=this.onEnded.bind(this),this.startTime=this.context.currentTime,source.start(this.startTime,this.offset),this.isPlaying=!0,this.source=source,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}console.warn("Audio: this Audio has no playback control.")}else console.warn("Audio: Audio is already playing.")},pause:function(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this.source.stop(),this.source.onended=null,this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.isPlaying=!1),this;console.warn("Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.source.onended=null,this.offset=0,this.isPlaying=!1,this;console.warn("Audio: this Audio has no playback control.")},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var i=1,e=this.filters.length;i<e;i++)this.filters[i-1].connect(this.filters[i]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var i=1,e=this.filters.length;i<e;i++)this.filters[i-1].disconnect(this.filters[i]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},setDetune:function(e){if(this.detune=e,void 0!==this.source.detune)return!0===this.isPlaying&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this},getDetune:function(){return this.detune},getFilter:function(){return this.getFilters()[0]},setFilter:function(filter){return this.setFilters(filter?[filter]:[])},setPlaybackRate:function(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;console.warn("Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}}),Object.assign(AudioAnalyser.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,data=this.getFrequencyData(),i=0;i<data.length;i++)e+=data[i];return e/data.length}});var AudioContext={getContext:function(){return void 0===context&&(context=new(window.AudioContext||window.webkitAudioContext)),context},setContext:function(e){context=e}};function AudioListener(){Object3D.call(this),this.type="AudioListener",this.context=AudioContext.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0}function PositionalAudio(e){Audio.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function InstancedBufferAttribute(e,t,r,n){"number"==typeof r&&(n=r,r=!1,console.error("InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),BufferAttribute.call(this,e,t,r),this.meshPerAttribute=n||1}function Font(data){this.type="Font",this.data=data}function createPaths(text,e,data){for(var t=Array.from?Array.from(text):String(text).split(""),r=e/data.resolution,n=(data.boundingBox.yMax-data.boundingBox.yMin+data.underlineThickness)*r,o=[],l=0,c=0,i=0;i<t.length;i++){var h=t[i];if("\n"===h)l=0,c-=n;else{var d=createPath(h,r,l,c,data);l+=d.offsetX,o.push(d.path)}}return o}function createPath(e,t,r,n,data){var glyph=data.glyphs[e]||data.glyphs["?"];if(glyph){var o,l,c,h,d,f,m,v,path=new ShapePath;if(glyph.o)for(var y=glyph._cachedOutline||(glyph._cachedOutline=glyph.o.split(" ")),i=0,x=y.length;i<x;){switch(y[i++]){case"m":o=y[i++]*t+r,l=y[i++]*t+n,path.moveTo(o,l);break;case"l":o=y[i++]*t+r,l=y[i++]*t+n,path.lineTo(o,l);break;case"q":c=y[i++]*t+r,h=y[i++]*t+n,d=y[i++]*t+r,f=y[i++]*t+n,path.quadraticCurveTo(d,f,c,h);break;case"b":c=y[i++]*t+r,h=y[i++]*t+n,d=y[i++]*t+r,f=y[i++]*t+n,m=y[i++]*t+r,v=y[i++]*t+n,path.bezierCurveTo(d,f,m,v,c,h)}}return{offsetX:glyph.ha*t,path:path}}}function ConeGeometry(e,t,r,n,o,l,c){CylinderGeometry.call(this,0,e,t,r,n,o,l,c),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:l,thetaLength:c}}function ConeBufferGeometry(e,t,r,n,o,l,c){CylinderBufferGeometry.call(this,0,e,t,r,n,o,l,c),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:l,thetaLength:c}}function DodecahedronGeometry(e,t){Geometry.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new DodecahedronBufferGeometry(e,t)),this.mergeVertices()}function DodecahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2,n=1/r,o=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-r,0,-n,r,0,n,-r,0,n,r,-n,-r,0,-n,r,0,n,-r,0,n,r,0,-r,0,-n,r,0,-n,-r,0,n,r,0,n];PolyhedronBufferGeometry.call(this,o,[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function EdgesGeometry(e,t){BufferGeometry.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var r,n,o,l,c=[],h=Math.cos(_Math.DEG2RAD*t),d=[0,0],f={},m=["a","b","c"];e.isBufferGeometry?(l=new Geometry).fromBufferGeometry(e):l=e.clone(),l.mergeVertices(),l.computeFaceNormals();for(var v=l.vertices,y=l.faces,i=0,x=y.length;i<x;i++)for(var w=y[i],M=0;M<3;M++)r=w[m[M]],n=w[m[(M+1)%3]],d[0]=Math.min(r,n),d[1]=Math.max(r,n),void 0===f[o=d[0]+","+d[1]]?f[o]={index1:d[0],index2:d[1],face1:i,face2:void 0}:f[o].face2=i;for(o in f){var S=f[o];if(void 0===S.face2||y[S.face1].normal.dot(y[S.face2].normal)<=h){var A=v[S.index1];c.push(A.x,A.y,A.z),A=v[S.index2],c.push(A.x,A.y,A.z)}}this.addAttribute("position",new Float32BufferAttribute(c,3))}function ExtrudeGeometry(e,t){Geometry.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new ExtrudeBufferGeometry(e,t)),this.mergeVertices()}function ExtrudeBufferGeometry(e,t){BufferGeometry.call(this),this.type="ExtrudeBufferGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];for(var r=this,n=[],o=[],i=0,l=e.length;i<l;i++){c(e[i])}function c(e){var l=[],c=void 0!==t.curveSegments?t.curveSegments:12,h=void 0!==t.steps?t.steps:1,d=void 0!==t.depth?t.depth:100,f=void 0===t.bevelEnabled||t.bevelEnabled,m=void 0!==t.bevelThickness?t.bevelThickness:6,v=void 0!==t.bevelSize?t.bevelSize:m-2,y=void 0!==t.bevelSegments?t.bevelSegments:3,x=t.extrudePath,w=void 0!==t.UVGenerator?t.UVGenerator:WorldUVGenerator;void 0!==t.amount&&(console.warn("ExtrudeBufferGeometry: amount has been renamed to depth."),d=t.amount);var M,S,A,T,_,L,C,N,P=!1;x&&(M=x.getSpacedPoints(h),P=!0,f=!1,S=x.computeFrenetFrames(h,!1),A=new Vector3,T=new Vector3,_=new Vector3),f||(y=0,m=0,v=0);var E=e.extractPoints(c),D=E.shape,F=E.holes;if(!ShapeUtils.isClockWise(D))for(D=D.reverse(),C=0,N=F.length;C<N;C++)L=F[C],ShapeUtils.isClockWise(L)&&(F[C]=L.reverse());var R=ShapeUtils.triangulateShape(D,F),O=D;for(C=0,N=F.length;C<N;C++)L=F[C],D=D.concat(L);function B(e,t,r){return t||console.error("ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}var b,I,U,V,k,G,z=D.length,j=R.length;function W(e,t,r){var n,o,l,c=e.x-t.x,h=e.y-t.y,d=r.x-e.x,f=r.y-e.y,m=c*c+h*h,v=c*f-h*d;if(Math.abs(v)>Number.EPSILON){var y=Math.sqrt(m),x=Math.sqrt(d*d+f*f),w=t.x-h/y,M=t.y+c/y,S=((r.x-f/x-w)*f-(r.y+d/x-M)*d)/(c*f-h*d),A=(n=w+c*S-e.x)*n+(o=M+h*S-e.y)*o;if(A<=2)return new Vector2(n,o);l=Math.sqrt(A/2)}else{var T=!1;c>Number.EPSILON?d>Number.EPSILON&&(T=!0):c<-Number.EPSILON?d<-Number.EPSILON&&(T=!0):Math.sign(h)===Math.sign(f)&&(T=!0),T?(n=-h,o=c,l=Math.sqrt(m)):(n=c,o=h,l=Math.sqrt(m/2))}return new Vector2(n/l,o/l)}for(var H=[],i=0,X=O.length,Y=X-1,Q=i+1;i<X;i++,Y++,Q++)Y===X&&(Y=0),Q===X&&(Q=0),H[i]=W(O[i],O[Y],O[Q]);var K,s,J=[],Z=H.concat();for(C=0,N=F.length;C<N;C++){for(L=F[C],K=[],i=0,Y=(X=L.length)-1,Q=i+1;i<X;i++,Y++,Q++)Y===X&&(Y=0),Q===X&&(Q=0),K[i]=W(L[i],L[Y],L[Q]);J.push(K),Z=Z.concat(K)}for(b=0;b<y;b++){for(U=b/y,V=m*Math.cos(U*Math.PI/2),I=v*Math.sin(U*Math.PI/2),i=0,X=O.length;i<X;i++)ee((k=B(O[i],H[i],I)).x,k.y,-V);for(C=0,N=F.length;C<N;C++)for(L=F[C],K=J[C],i=0,X=L.length;i<X;i++)ee((k=B(L[i],K[i],I)).x,k.y,-V)}for(I=v,i=0;i<z;i++)k=f?B(D[i],Z[i],I):D[i],P?(T.copy(S.normals[0]).multiplyScalar(k.x),A.copy(S.binormals[0]).multiplyScalar(k.y),_.copy(M[0]).add(T).add(A),ee(_.x,_.y,_.z)):ee(k.x,k.y,0);for(s=1;s<=h;s++)for(i=0;i<z;i++)k=f?B(D[i],Z[i],I):D[i],P?(T.copy(S.normals[s]).multiplyScalar(k.x),A.copy(S.binormals[s]).multiplyScalar(k.y),_.copy(M[s]).add(T).add(A),ee(_.x,_.y,_.z)):ee(k.x,k.y,d/h*s);for(b=y-1;b>=0;b--){for(U=b/y,V=m*Math.cos(U*Math.PI/2),I=v*Math.sin(U*Math.PI/2),i=0,X=O.length;i<X;i++)ee((k=B(O[i],H[i],I)).x,k.y,d+V);for(C=0,N=F.length;C<N;C++)for(L=F[C],K=J[C],i=0,X=L.length;i<X;i++)k=B(L[i],K[i],I),P?ee(k.x,k.y+M[h-1].y,M[h-1].x+V):ee(k.x,k.y,d+V)}function $(e,t){var r,n;for(i=e.length;--i>=0;){r=i,(n=i-1)<0&&(n=e.length-1);var s=0,o=h+2*y;for(s=0;s<o;s++){var l=z*s,c=z*(s+1);re(t+r+l,t+n+l,t+n+c,t+r+c)}}}function ee(e,t,r){l.push(e),l.push(t),l.push(r)}function te(a,b,e){ie(a),ie(b),ie(e);var t=n.length/3,o=w.generateTopUV(r,n,t-3,t-2,t-1);ne(o[0]),ne(o[1]),ne(o[2])}function re(a,b,e,t){ie(a),ie(b),ie(t),ie(b),ie(e),ie(t);var o=n.length/3,l=w.generateSideWallUV(r,n,o-6,o-3,o-2,o-1);ne(l[0]),ne(l[1]),ne(l[3]),ne(l[1]),ne(l[2]),ne(l[3])}function ie(e){n.push(l[3*e+0]),n.push(l[3*e+1]),n.push(l[3*e+2])}function ne(e){o.push(e.x),o.push(e.y)}!function(){var e=n.length/3;if(f){var t=0,o=z*t;for(i=0;i<j;i++)te((G=R[i])[2]+o,G[1]+o,G[0]+o);for(o=z*(t=h+2*y),i=0;i<j;i++)te((G=R[i])[0]+o,G[1]+o,G[2]+o)}else{for(i=0;i<j;i++)te((G=R[i])[2],G[1],G[0]);for(i=0;i<j;i++)te((G=R[i])[0]+z*h,G[1]+z*h,G[2]+z*h)}r.addGroup(e,n.length/3-e,0)}(),function(){var e=n.length/3,t=0;for($(O,t),t+=O.length,C=0,N=F.length;C<N;C++)$(L=F[C],t),t+=L.length;r.addGroup(e,n.length/3-e,1)}()}this.addAttribute("position",new Float32BufferAttribute(n,3)),this.addAttribute("uv",new Float32BufferAttribute(o,2)),this.computeVertexNormals()}AudioListener.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:AudioListener,getInput:function(){return this.gain},removeFilter:function(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this},getFilter:function(){return this.filter},setFilter:function(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this},updateMatrixWorld:function(){var e=new Vector3,t=new Quaternion,r=new Vector3,n=new Vector3,o=new Clock;return function(l){Object3D.prototype.updateMatrixWorld.call(this,l);var c=this.context.listener,h=this.up;if(this.timeDelta=o.getDelta(),this.matrixWorld.decompose(e,t,r),n.set(0,0,-1).applyQuaternion(t),c.positionX){var d=this.context.currentTime+this.timeDelta;c.positionX.linearRampToValueAtTime(e.x,d),c.positionY.linearRampToValueAtTime(e.y,d),c.positionZ.linearRampToValueAtTime(e.z,d),c.forwardX.linearRampToValueAtTime(n.x,d),c.forwardY.linearRampToValueAtTime(n.y,d),c.forwardZ.linearRampToValueAtTime(n.z,d),c.upX.linearRampToValueAtTime(h.x,d),c.upY.linearRampToValueAtTime(h.y,d),c.upZ.linearRampToValueAtTime(h.z,d)}else c.setPosition(e.x,e.y,e.z),c.setOrientation(n.x,n.y,n.z,h.x,h.y,h.z)}}()}),PositionalAudio.prototype=Object.assign(Object.create(Audio.prototype),{constructor:PositionalAudio,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){return this.panner.refDistance=e,this},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){return this.panner.rolloffFactor=e,this},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){return this.panner.distanceModel=e,this},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){return this.panner.maxDistance=e,this},setDirectionalCone:function(e,t,r){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=t,this.panner.coneOuterGain=r,this},updateMatrixWorld:function(){var e=new Vector3,t=new Quaternion,r=new Vector3,n=new Vector3;return function(o){if(Object3D.prototype.updateMatrixWorld.call(this,o),!0!==this.hasPlaybackControl||!1!==this.isPlaying){this.matrixWorld.decompose(e,t,r),n.set(0,0,1).applyQuaternion(t);var l=this.panner;if(l.positionX){var c=this.context.currentTime+this.listener.timeDelta;l.positionX.linearRampToValueAtTime(e.x,c),l.positionY.linearRampToValueAtTime(e.y,c),l.positionZ.linearRampToValueAtTime(e.z,c),l.orientationX.linearRampToValueAtTime(n.x,c),l.orientationY.linearRampToValueAtTime(n.y,c),l.orientationZ.linearRampToValueAtTime(n.z,c)}else l.setPosition(e.x,e.y,e.z),l.setOrientation(n.x,n.y,n.z)}}}()}),InstancedBufferAttribute.prototype=Object.assign(Object.create(BufferAttribute.prototype),{constructor:InstancedBufferAttribute,isInstancedBufferAttribute:!0,copy:function(source){return BufferAttribute.prototype.copy.call(this,source),this.meshPerAttribute=source.meshPerAttribute,this}}),Object.assign(Font.prototype,{isFont:!0,generateShapes:function(text,e){void 0===e&&(e=100);for(var t=[],r=createPaths(text,e,this.data),p=0,n=r.length;p<n;p++)Array.prototype.push.apply(t,r[p].toShapes());return t}}),ConeGeometry.prototype=Object.create(CylinderGeometry.prototype),ConeGeometry.prototype.constructor=ConeGeometry,ConeBufferGeometry.prototype=Object.create(CylinderBufferGeometry.prototype),ConeBufferGeometry.prototype.constructor=ConeBufferGeometry,DodecahedronGeometry.prototype=Object.create(Geometry.prototype),DodecahedronGeometry.prototype.constructor=DodecahedronGeometry,DodecahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),DodecahedronBufferGeometry.prototype.constructor=DodecahedronBufferGeometry,EdgesGeometry.prototype=Object.create(BufferGeometry.prototype),EdgesGeometry.prototype.constructor=EdgesGeometry,ExtrudeGeometry.prototype=Object.create(Geometry.prototype),ExtrudeGeometry.prototype.constructor=ExtrudeGeometry,ExtrudeGeometry.prototype.toJSON=function(){var data=Geometry.prototype.toJSON.call(this);return toJSON$1(this.parameters.shapes,this.parameters.options,data)},ExtrudeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ExtrudeBufferGeometry.prototype.constructor=ExtrudeBufferGeometry,ExtrudeBufferGeometry.prototype.toJSON=function(){var data=BufferGeometry.prototype.toJSON.call(this);return toJSON$1(this.parameters.shapes,this.parameters.options,data)};var WorldUVGenerator={generateTopUV:function(e,t,r,n,o){var l=t[3*r],c=t[3*r+1],h=t[3*n],d=t[3*n+1],f=t[3*o],m=t[3*o+1];return[new Vector2(l,c),new Vector2(h,d),new Vector2(f,m)]},generateSideWallUV:function(e,t,r,n,o,l){var c=t[3*r],h=t[3*r+1],d=t[3*r+2],f=t[3*n],m=t[3*n+1],v=t[3*n+2],y=t[3*o],x=t[3*o+1],w=t[3*o+2],M=t[3*l],S=t[3*l+1],A=t[3*l+2];return Math.abs(h-m)<.01?[new Vector2(c,1-d),new Vector2(f,1-v),new Vector2(y,1-w),new Vector2(M,1-A)]:[new Vector2(h,1-d),new Vector2(m,1-v),new Vector2(x,1-w),new Vector2(S,1-A)]}},lineGeometry,coneGeometry,radians,axis;function toJSON$1(e,t,data){if(data.shapes=[],Array.isArray(e))for(var i=0,r=e.length;i<r;i++){var n=e[i];data.shapes.push(n.uuid)}else data.shapes.push(e.uuid);return void 0!==t.extrudePath&&(data.options.extrudePath=t.extrudePath.toJSON()),data}function LatheGeometry(e,t,r,n){Geometry.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},this.fromBufferGeometry(new LatheBufferGeometry(e,t,r,n)),this.mergeVertices()}function LatheBufferGeometry(e,t,r,n){BufferGeometry.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},t=Math.floor(t)||12,r=r||0,n=n||2*Math.PI,n=_Math.clamp(n,0,2*Math.PI);var base,i,o,l=[],c=[],h=[],d=1/t,f=new Vector3,m=new Vector2;for(i=0;i<=t;i++){var v=r+i*d*n,y=Math.sin(v),x=Math.cos(v);for(o=0;o<=e.length-1;o++)f.x=e[o].x*y,f.y=e[o].y,f.z=e[o].x*x,c.push(f.x,f.y,f.z),m.x=i/t,m.y=o/(e.length-1),h.push(m.x,m.y)}for(i=0;i<t;i++)for(o=0;o<e.length-1;o++){var a=base=o+i*e.length,b=base+e.length,w=base+e.length+1,M=base+1;l.push(a,b,M),l.push(b,w,M)}if(this.setIndex(l),this.addAttribute("position",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(h,2)),this.computeVertexNormals(),n===2*Math.PI){var S=this.attributes.normal.array,A=new Vector3,T=new Vector3,_=new Vector3;for(base=t*e.length*3,i=0,o=0;i<e.length;i++,o+=3)A.x=S[o+0],A.y=S[o+1],A.z=S[o+2],T.x=S[base+o+0],T.y=S[base+o+1],T.z=S[base+o+2],_.addVectors(A,T).normalize(),S[o+0]=S[base+o+0]=_.x,S[o+1]=S[base+o+1]=_.y,S[o+2]=S[base+o+2]=_.z}}function ParametricGeometry(e,t,r){Geometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r},this.fromBufferGeometry(new ParametricBufferGeometry(e,t,r)),this.mergeVertices()}function ParametricBufferGeometry(e,t,r){BufferGeometry.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:r};var i,n,o=[],l=[],c=[],h=[],d=new Vector3,f=new Vector3,m=new Vector3,v=new Vector3,y=new Vector3;e.length<3&&console.error("ParametricGeometry: Function must now modify a Vector3 as third parameter.");var x=t+1;for(i=0;i<=r;i++){var w=i/r;for(n=0;n<=t;n++){var u=n/t;e(u,w,f),l.push(f.x,f.y,f.z),u-1e-5>=0?(e(u-1e-5,w,m),v.subVectors(f,m)):(e(u+1e-5,w,m),v.subVectors(m,f)),w-1e-5>=0?(e(u,w-1e-5,m),y.subVectors(f,m)):(e(u,w+1e-5,m),y.subVectors(m,f)),d.crossVectors(v,y).normalize(),c.push(d.x,d.y,d.z),h.push(u,w)}}for(i=0;i<r;i++)for(n=0;n<t;n++){var a=i*x+n,b=i*x+n+1,M=(i+1)*x+n+1,S=(i+1)*x+n;o.push(a,b,S),o.push(b,M,S)}this.setIndex(o),this.addAttribute("position",new Float32BufferAttribute(l,3)),this.addAttribute("normal",new Float32BufferAttribute(c,3)),this.addAttribute("uv",new Float32BufferAttribute(h,2))}function RingGeometry(e,t,r,n,o,l){Geometry.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:o,thetaLength:l},this.fromBufferGeometry(new RingBufferGeometry(e,t,r,n,o,l)),this.mergeVertices()}function RingBufferGeometry(e,t,r,n,o,l){BufferGeometry.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:o,thetaLength:l},e=e||.5,t=t||1,o=void 0!==o?o:0,l=void 0!==l?l:2*Math.PI,r=void 0!==r?Math.max(3,r):8;var c,h,i,d=[],f=[],m=[],v=[],y=e,x=(t-e)/(n=void 0!==n?Math.max(1,n):1),w=new Vector3,M=new Vector2;for(h=0;h<=n;h++){for(i=0;i<=r;i++)c=o+i/r*l,w.x=y*Math.cos(c),w.y=y*Math.sin(c),f.push(w.x,w.y,w.z),m.push(0,0,1),M.x=(w.x/t+1)/2,M.y=(w.y/t+1)/2,v.push(M.x,M.y);y+=x}for(h=0;h<n;h++){var S=h*(r+1);for(i=0;i<r;i++){var a=c=i+S,b=c+r+1,A=c+r+2,T=c+1;d.push(a,b,T),d.push(b,A,T)}}this.setIndex(d),this.addAttribute("position",new Float32BufferAttribute(f,3)),this.addAttribute("normal",new Float32BufferAttribute(m,3)),this.addAttribute("uv",new Float32BufferAttribute(v,2))}function TetrahedronGeometry(e,t){Geometry.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new TetrahedronBufferGeometry(e,t)),this.mergeVertices()}function TetrahedronBufferGeometry(e,t){PolyhedronBufferGeometry.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function TextGeometry(text,e){Geometry.call(this),this.type="TextGeometry",this.parameters={text:text,parameters:e},this.fromBufferGeometry(new TextBufferGeometry(text,e)),this.mergeVertices()}function TextBufferGeometry(text,e){var t=(e=e||{}).font;if(!t||!t.isFont)return console.error("TextGeometry: font parameter is not an instance of Font."),new Geometry;var r=t.generateShapes(text,e.size);e.depth=void 0!==e.height?e.height:50,void 0===e.bevelThickness&&(e.bevelThickness=10),void 0===e.bevelSize&&(e.bevelSize=8),void 0===e.bevelEnabled&&(e.bevelEnabled=!1),ExtrudeBufferGeometry.call(this,r,e),this.type="TextBufferGeometry"}function TorusKnotGeometry(e,t,r,n,p,q,o){Geometry.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:p,q:q},void 0!==o&&console.warn("TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new TorusKnotBufferGeometry(e,t,r,n,p,q)),this.mergeVertices()}function TorusKnotBufferGeometry(e,t,r,n,p,q){BufferGeometry.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:n,p:p,q:q},e=e||1,t=t||.4,r=Math.floor(r)||64,n=Math.floor(n)||8,p=p||2,q=q||3;var i,o,l=[],c=[],h=[],d=[],f=new Vector3,m=new Vector3,v=new Vector3,y=new Vector3,x=new Vector3,w=new Vector3,M=new Vector3;for(i=0;i<=r;++i){var u=i/r*p*Math.PI*2;for(C(u,p,q,e,v),C(u+.01,p,q,e,y),w.subVectors(y,v),M.addVectors(y,v),x.crossVectors(w,M),M.crossVectors(x,w),x.normalize(),M.normalize(),o=0;o<=n;++o){var S=o/n*Math.PI*2,A=-t*Math.cos(S),T=t*Math.sin(S);f.x=v.x+(A*M.x+T*x.x),f.y=v.y+(A*M.y+T*x.y),f.z=v.z+(A*M.z+T*x.z),c.push(f.x,f.y,f.z),m.subVectors(f,v).normalize(),h.push(m.x,m.y,m.z),d.push(i/r),d.push(o/n)}}for(o=1;o<=r;o++)for(i=1;i<=n;i++){var a=(n+1)*(o-1)+(i-1),b=(n+1)*o+(i-1),_=(n+1)*o+i,L=(n+1)*(o-1)+i;l.push(a,b,L),l.push(b,_,L)}function C(u,p,q,e,t){var r=Math.cos(u),n=Math.sin(u),o=q/p*u,l=Math.cos(o);t.x=e*(2+l)*.5*r,t.y=e*(2+l)*n*.5,t.z=e*Math.sin(o)*.5}this.setIndex(l),this.addAttribute("position",new Float32BufferAttribute(c,3)),this.addAttribute("normal",new Float32BufferAttribute(h,3)),this.addAttribute("uv",new Float32BufferAttribute(d,2))}function TubeGeometry(path,e,t,r,n,o){Geometry.call(this),this.type="TubeGeometry",this.parameters={path:path,tubularSegments:e,radius:t,radialSegments:r,closed:n},void 0!==o&&console.warn("TubeGeometry: taper has been removed.");var l=new TubeBufferGeometry(path,e,t,r,n);this.tangents=l.tangents,this.normals=l.normals,this.binormals=l.binormals,this.fromBufferGeometry(l),this.mergeVertices()}function TubeBufferGeometry(path,e,t,r,n){BufferGeometry.call(this),this.type="TubeBufferGeometry",this.parameters={path:path,tubularSegments:e,radius:t,radialSegments:r,closed:n},e=e||64,t=t||1,r=r||8,n=n||!1;var o=path.computeFrenetFrames(e,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;var i,l,c=new Vector3,h=new Vector3,d=new Vector2,f=new Vector3,m=[],v=[],y=[],x=[];function w(i){f=path.getPointAt(i/e,f);var n=o.normals[i],d=o.binormals[i];for(l=0;l<=r;l++){var y=l/r*Math.PI*2,x=Math.sin(y),w=-Math.cos(y);h.x=w*n.x+x*d.x,h.y=w*n.y+x*d.y,h.z=w*n.z+x*d.z,h.normalize(),v.push(h.x,h.y,h.z),c.x=f.x+t*h.x,c.y=f.y+t*h.y,c.z=f.z+t*h.z,m.push(c.x,c.y,c.z)}}!function(){for(i=0;i<e;i++)w(i);w(!1===n?e:0),function(){for(i=0;i<=e;i++)for(l=0;l<=r;l++)d.x=i/e,d.y=l/r,y.push(d.x,d.y)}(),function(){for(l=1;l<=e;l++)for(i=1;i<=r;i++){var a=(r+1)*(l-1)+(i-1),b=(r+1)*l+(i-1),t=(r+1)*l+i,n=(r+1)*(l-1)+i;x.push(a,b,n),x.push(b,t,n)}}()}(),this.setIndex(x),this.addAttribute("position",new Float32BufferAttribute(m,3)),this.addAttribute("normal",new Float32BufferAttribute(v,3)),this.addAttribute("uv",new Float32BufferAttribute(y,2))}function ArrowHelper(e,t,r,n,o,l){Object3D.call(this),void 0===e&&(e=new Vector3(0,0,1)),void 0===t&&(t=new Vector3(0,0,0)),void 0===r&&(r=1),void 0===n&&(n=16776960),void 0===o&&(o=.2*r),void 0===l&&(l=.2*o),void 0===lineGeometry&&((lineGeometry=new BufferGeometry).addAttribute("position",new Float32BufferAttribute([0,0,0,0,1,0],3)),(coneGeometry=new CylinderBufferGeometry(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(t),this.line=new Line(lineGeometry,new LineBasicMaterial({color:n})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Mesh(coneGeometry,new MeshBasicMaterial({color:n})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,o,l)}function AxesHelper(e){var t=[0,0,0,e=e||1,0,0,0,0,0,0,e,0,0,0,0,0,0,e],r=new BufferGeometry;r.addAttribute("position",new Float32BufferAttribute(t,3)),r.addAttribute("color",new Float32BufferAttribute([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));var n=new LineBasicMaterial({vertexColors:VertexColors});LineSegments.call(this,r,n)}function Box3Helper(e,t){this.type="Box3Helper",this.box=e;var r=void 0!==t?t:16776960,n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),o=new BufferGeometry;o.setIndex(new BufferAttribute(n,1)),o.addAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),LineSegments.call(this,o,new LineBasicMaterial({color:r})),this.geometry.computeBoundingSphere()}function BoxHelper(object,e){this.object=object,void 0===e&&(e=16776960);var t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),n=new BufferGeometry;n.setIndex(new BufferAttribute(t,1)),n.addAttribute("position",new BufferAttribute(r,3)),LineSegments.call(this,n,new LineBasicMaterial({color:e})),this.matrixAutoUpdate=!1,this.update()}function CameraHelper(e){var t=new BufferGeometry,r=new LineBasicMaterial({color:16777215,vertexColors:FaceColors}),n=[],o=[],l={},c=new Color(16755200),h=new Color(16711680),d=new Color(43775),f=new Color(16777215),m=new Color(3355443);function v(a,b,e){y(a,e),y(b,e)}function y(e,t){n.push(0,0,0),o.push(t.r,t.g,t.b),void 0===l[e]&&(l[e]=[]),l[e].push(n.length/3-1)}v("n1","n2",c),v("n2","n4",c),v("n4","n3",c),v("n3","n1",c),v("f1","f2",c),v("f2","f4",c),v("f4","f3",c),v("f3","f1",c),v("n1","f1",c),v("n2","f2",c),v("n3","f3",c),v("n4","f4",c),v("p","n1",h),v("p","n2",h),v("p","n3",h),v("p","n4",h),v("u1","u2",d),v("u2","u3",d),v("u3","u1",d),v("c","t",f),v("p","c",m),v("cn1","cn2",m),v("cn3","cn4",m),v("cf1","cf2",m),v("cf3","cf4",m),t.addAttribute("position",new Float32BufferAttribute(n,3)),t.addAttribute("color",new Float32BufferAttribute(o,3)),LineSegments.call(this,t,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=l,this.update()}function DirectionalLightHelper(e,t,r){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r,void 0===t&&(t=1);var n=new BufferGeometry;n.addAttribute("position",new Float32BufferAttribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var o=new LineBasicMaterial({fog:!1});this.lightPlane=new Line(n,o),this.add(this.lightPlane),(n=new BufferGeometry).addAttribute("position",new Float32BufferAttribute([0,0,0,0,0,1],3)),this.targetLine=new Line(n,o),this.add(this.targetLine),this.update()}function FaceNormalsHelper(object,e,t,r){this.object=object,this.size=void 0!==e?e:1;var n=void 0!==t?t:16776960,o=void 0!==r?r:1,l=0,c=this.object.geometry;c&&c.isGeometry?l=c.faces.length:console.warn("FaceNormalsHelper: only Geometry is supported. Use VertexNormalsHelper, instead.");var h=new BufferGeometry,d=new Float32BufferAttribute(2*l*3,3);h.addAttribute("position",d),LineSegments.call(this,h,new LineBasicMaterial({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function GridHelper(e,t,r,n){e=e||10,t=t||10,r=new Color(void 0!==r?r:4473924),n=new Color(void 0!==n?n:8947848);for(var o=t/2,l=e/t,c=e/2,h=[],d=[],i=0,f=0,m=-c;i<=t;i++,m+=l){h.push(-c,0,m,c,0,m),h.push(m,0,-c,m,0,c);var v=i===o?r:n;v.toArray(d,f),f+=3,v.toArray(d,f),f+=3,v.toArray(d,f),f+=3,v.toArray(d,f),f+=3}var y=new BufferGeometry;y.addAttribute("position",new Float32BufferAttribute(h,3)),y.addAttribute("color",new Float32BufferAttribute(d,3));var x=new LineBasicMaterial({vertexColors:VertexColors});LineSegments.call(this,y,x)}function HemisphereLightHelper(e,t,r){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=r;var n=new OctahedronBufferGeometry(t);n.rotateY(.5*Math.PI),this.material=new MeshBasicMaterial({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=VertexColors);var o=n.getAttribute("position"),l=new Float32Array(3*o.count);n.addAttribute("color",new BufferAttribute(l,3)),this.add(new Mesh(n,this.material)),this.update()}function PlaneHelper(e,t,r){this.type="PlaneHelper",this.plane=e,this.size=void 0===t?1:t;var n=void 0!==r?r:16776960,o=new BufferGeometry;o.addAttribute("position",new Float32BufferAttribute([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),o.computeBoundingSphere(),Line.call(this,o,new LineBasicMaterial({color:n}));var l=new BufferGeometry;l.addAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),l.computeBoundingSphere(),this.add(new Mesh(l,new MeshBasicMaterial({color:n,opacity:.2,transparent:!0,depthWrite:!1})))}function PointLightHelper(e,t,r){this.light=e,this.light.updateMatrixWorld(),this.color=r;var n=new SphereBufferGeometry(t,4,2),o=new MeshBasicMaterial({wireframe:!0,fog:!1});Mesh.call(this,n,o),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function PolarGridHelper(e,t,r,n,o,l){e=e||10,t=t||16,r=r||8,n=n||64,o=new Color(void 0!==o?o:4473924),l=new Color(void 0!==l?l:8947848);var c,h,d,i,f,m,v,y=[],x=[];for(i=0;i<=t;i++)d=i/t*(2*Math.PI),c=Math.sin(d)*e,h=Math.cos(d)*e,y.push(0,0,0),y.push(c,0,h),v=1&i?o:l,x.push(v.r,v.g,v.b),x.push(v.r,v.g,v.b);for(i=0;i<=r;i++)for(v=1&i?o:l,m=e-e/r*i,f=0;f<n;f++)d=f/n*(2*Math.PI),c=Math.sin(d)*m,h=Math.cos(d)*m,y.push(c,0,h),x.push(v.r,v.g,v.b),d=(f+1)/n*(2*Math.PI),c=Math.sin(d)*m,h=Math.cos(d)*m,y.push(c,0,h),x.push(v.r,v.g,v.b);var w=new BufferGeometry;w.addAttribute("position",new Float32BufferAttribute(y,3)),w.addAttribute("color",new Float32BufferAttribute(x,3));var M=new LineBasicMaterial({vertexColors:VertexColors});LineSegments.call(this,w,M)}function PositionalAudioHelper(audio,e,t,r){this.audio=audio,this.range=e||1,this.divisionsInnerAngle=t||16,this.divisionsOuterAngle=r||2;var n=new BufferGeometry,o=this.divisionsInnerAngle+2*this.divisionsOuterAngle,l=new Float32Array(3*(3*o+3));n.addAttribute("position",new BufferAttribute(l,3));var c=new LineBasicMaterial({color:65280}),h=new LineBasicMaterial({color:16776960});Line.call(this,n,[h,c]),this.update()}function RectAreaLightHelper(e,t){this.type="RectAreaLightHelper",this.light=e,this.color=t;var r=new BufferGeometry;r.addAttribute("position",new Float32BufferAttribute([1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),r.computeBoundingSphere();var n=new LineBasicMaterial({fog:!1});Line.call(this,r,n);var o=new BufferGeometry;o.addAttribute("position",new Float32BufferAttribute([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),o.computeBoundingSphere(),this.add(new Mesh(o,new MeshBasicMaterial({side:BackSide,fog:!1}))),this.update()}function SpotLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=t;for(var r=new BufferGeometry,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],i=0,o=1;i<32;i++,o++){var l=i/32*Math.PI*2,c=o/32*Math.PI*2;n.push(Math.cos(l),Math.sin(l),1,Math.cos(c),Math.sin(c),1)}r.addAttribute("position",new Float32BufferAttribute(n,3));var h=new LineBasicMaterial({fog:!1});this.cone=new LineSegments(r,h),this.add(this.cone),this.update()}function VertexNormalsHelper(object,e,t,r){this.object=object,this.size=void 0!==e?e:1;var n=void 0!==t?t:16711680,o=void 0!==r?r:1,l=0,c=this.object.geometry;c&&c.isGeometry?l=3*c.faces.length:c&&c.isBufferGeometry&&(l=c.attributes.normal.count);var h=new BufferGeometry,d=new Float32BufferAttribute(2*l*3,3);h.addAttribute("position",d),LineSegments.call(this,h,new LineBasicMaterial({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function RectAreaLight(e,t,r,n){Light.call(this,e,t),this.type="RectAreaLight",this.width=void 0!==r?r:10,this.height=void 0!==n?n:10}function AnimationLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function AudioLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function BufferGeometryLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}LatheGeometry.prototype=Object.create(Geometry.prototype),LatheGeometry.prototype.constructor=LatheGeometry,LatheBufferGeometry.prototype=Object.create(BufferGeometry.prototype),LatheBufferGeometry.prototype.constructor=LatheBufferGeometry,ParametricGeometry.prototype=Object.create(Geometry.prototype),ParametricGeometry.prototype.constructor=ParametricGeometry,ParametricBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ParametricBufferGeometry.prototype.constructor=ParametricBufferGeometry,RingGeometry.prototype=Object.create(Geometry.prototype),RingGeometry.prototype.constructor=RingGeometry,RingBufferGeometry.prototype=Object.create(BufferGeometry.prototype),RingBufferGeometry.prototype.constructor=RingBufferGeometry,TetrahedronGeometry.prototype=Object.create(Geometry.prototype),TetrahedronGeometry.prototype.constructor=TetrahedronGeometry,TetrahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),TetrahedronBufferGeometry.prototype.constructor=TetrahedronBufferGeometry,TextGeometry.prototype=Object.create(Geometry.prototype),TextGeometry.prototype.constructor=TextGeometry,TextBufferGeometry.prototype=Object.create(ExtrudeBufferGeometry.prototype),TextBufferGeometry.prototype.constructor=TextBufferGeometry,TorusKnotGeometry.prototype=Object.create(Geometry.prototype),TorusKnotGeometry.prototype.constructor=TorusKnotGeometry,TorusKnotBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusKnotBufferGeometry.prototype.constructor=TorusKnotBufferGeometry,TubeGeometry.prototype=Object.create(Geometry.prototype),TubeGeometry.prototype.constructor=TubeGeometry,TubeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TubeBufferGeometry.prototype.constructor=TubeBufferGeometry,TubeBufferGeometry.prototype.toJSON=function(){var data=BufferGeometry.prototype.toJSON.call(this);return data.path=this.parameters.path.toJSON(),data},ArrowHelper.prototype=Object.create(Object3D.prototype),ArrowHelper.prototype.constructor=ArrowHelper,ArrowHelper.prototype.setDirection=(axis=new Vector3,function(e){e.y>.99999?this.quaternion.set(0,0,0,1):e.y<-.99999?this.quaternion.set(1,0,0,0):(axis.set(e.z,0,-e.x).normalize(),radians=Math.acos(e.y),this.quaternion.setFromAxisAngle(axis,radians))}),ArrowHelper.prototype.setLength=function(e,t,r){void 0===t&&(t=.2*e),void 0===r&&(r=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()},ArrowHelper.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},ArrowHelper.prototype.copy=function(source){return Object3D.prototype.copy.call(this,source,!1),this.line.copy(source.line),this.cone.copy(source.cone),this},ArrowHelper.prototype.clone=function(){return(new this.constructor).copy(this)},AxesHelper.prototype=Object.create(LineSegments.prototype),AxesHelper.prototype.constructor=AxesHelper,Box3Helper.prototype=Object.create(LineSegments.prototype),Box3Helper.prototype.constructor=Box3Helper,Box3Helper.prototype.updateMatrixWorld=function(e){var t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),Object3D.prototype.updateMatrixWorld.call(this,e))},BoxHelper.prototype=Object.create(LineSegments.prototype),BoxHelper.prototype.constructor=BoxHelper,BoxHelper.prototype.update=function(){var e=new Box3;return function(object){if(void 0!==object&&console.warn("BoxHelper: .update() has no longer arguments."),void 0!==this.object&&e.setFromObject(this.object),!e.isEmpty()){var t=e.min,r=e.max,n=this.geometry.attributes.position,o=n.array;o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=t.x,o[4]=r.y,o[5]=r.z,o[6]=t.x,o[7]=t.y,o[8]=r.z,o[9]=r.x,o[10]=t.y,o[11]=r.z,o[12]=r.x,o[13]=r.y,o[14]=t.z,o[15]=t.x,o[16]=r.y,o[17]=t.z,o[18]=t.x,o[19]=t.y,o[20]=t.z,o[21]=r.x,o[22]=t.y,o[23]=t.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),BoxHelper.prototype.setFromObject=function(object){return this.object=object,this.update(),this},BoxHelper.prototype.copy=function(source){return LineSegments.prototype.copy.call(this,source),this.object=source.object,this},BoxHelper.prototype.clone=function(){return(new this.constructor).copy(this)},CameraHelper.prototype=Object.create(LineSegments.prototype),CameraHelper.prototype.constructor=CameraHelper,CameraHelper.prototype.update=function(){var e,t,r=new Vector3,n=new Camera;function o(o,l,c,h){r.set(l,c,h).unproject(n);var d=t[o];if(void 0!==d)for(var f=e.getAttribute("position"),i=0,m=d.length;i<m;i++)f.setXYZ(d[i],r.x,r.y,r.z)}return function(){e=this.geometry,t=this.pointMap;n.projectionMatrix.copy(this.camera.projectionMatrix),o("c",0,0,-1),o("t",0,0,1),o("n1",-1,-1,-1),o("n2",1,-1,-1),o("n3",-1,1,-1),o("n4",1,1,-1),o("f1",-1,-1,1),o("f2",1,-1,1),o("f3",-1,1,1),o("f4",1,1,1),o("u1",.7,1.1,-1),o("u2",-.7,1.1,-1),o("u3",0,2,-1),o("cf1",-1,0,1),o("cf2",1,0,1),o("cf3",0,-1,1),o("cf4",0,1,1),o("cn1",-1,0,-1),o("cn2",1,0,-1),o("cn3",0,-1,-1),o("cn4",0,1,-1),e.getAttribute("position").needsUpdate=!0}}(),DirectionalLightHelper.prototype=Object.create(Object3D.prototype),DirectionalLightHelper.prototype.constructor=DirectionalLightHelper,DirectionalLightHelper.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},DirectionalLightHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Vector3;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),r.subVectors(t,e),this.lightPlane.lookAt(t),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(t),this.targetLine.scale.z=r.length()}}(),FaceNormalsHelper.prototype=Object.create(LineSegments.prototype),FaceNormalsHelper.prototype.constructor=FaceNormalsHelper,FaceNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Matrix3;return function(){this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);for(var n=this.object.matrixWorld,o=this.geometry.attributes.position,l=this.object.geometry,c=l.vertices,h=l.faces,d=0,i=0,f=h.length;i<f;i++){var m=h[i],v=m.normal;e.copy(c[m.a]).add(c[m.b]).add(c[m.c]).divideScalar(3).applyMatrix4(n),t.copy(v).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),o.setXYZ(d,e.x,e.y,e.z),d+=1,o.setXYZ(d,t.x,t.y,t.z),d+=1}o.needsUpdate=!0}}(),GridHelper.prototype=Object.create(LineSegments.prototype),GridHelper.prototype.constructor=GridHelper,HemisphereLightHelper.prototype=Object.create(Object3D.prototype),HemisphereLightHelper.prototype.constructor=HemisphereLightHelper,HemisphereLightHelper.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},HemisphereLightHelper.prototype.update=function(){var e=new Vector3,t=new Color,r=new Color;return function(){var n=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var o=n.geometry.getAttribute("color");t.copy(this.light.color),r.copy(this.light.groundColor);for(var i=0,l=o.count;i<l;i++){var c=i<l/2?t:r;o.setXYZ(i,c.r,c.g,c.b)}o.needsUpdate=!0}n.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate())}}(),PlaneHelper.prototype=Object.create(Line.prototype),PlaneHelper.prototype.constructor=PlaneHelper,PlaneHelper.prototype.updateMatrixWorld=function(e){var t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.children[0].material.side=t<0?BackSide:FrontSide,this.lookAt(this.plane.normal),Object3D.prototype.updateMatrixWorld.call(this,e)},PointLightHelper.prototype=Object.create(Mesh.prototype),PointLightHelper.prototype.constructor=PointLightHelper,PointLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},PointLightHelper.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},PolarGridHelper.prototype=Object.create(LineSegments.prototype),PolarGridHelper.prototype.constructor=PolarGridHelper,PositionalAudioHelper.prototype=Object.create(Line.prototype),PositionalAudioHelper.prototype.constructor=PositionalAudioHelper,PositionalAudioHelper.prototype.update=function(){var i,e,audio=this.audio,t=this.range,r=this.divisionsInnerAngle,n=this.divisionsOuterAngle,o=_Math.degToRad(audio.panner.coneInnerAngle),l=_Math.degToRad(audio.panner.coneOuterAngle),c=o/2,h=l/2,d=0,f=0,m=this.geometry,v=m.attributes.position;function y(r,n,o,l){var c=(n-r)/o;for(v.setXYZ(d,0,0,0),f++,i=r;i<n;i+=c)e=d+f,v.setXYZ(e,Math.sin(i)*t,0,Math.cos(i)*t),v.setXYZ(e+1,Math.sin(Math.min(i+c,n))*t,0,Math.cos(Math.min(i+c,n))*t),v.setXYZ(e+2,0,0,0),f+=3;m.addGroup(d,f,l),d+=f,f=0}m.clearGroups(),y(-h,-c,n,0),y(-c,c,r,1),y(c,h,n,0),v.needsUpdate=!0,o===l&&(this.material[0].visible=!1)},PositionalAudioHelper.prototype.dispose=function(){this.geometry.dispose(),this.material[0].dispose(),this.material[1].dispose()},RectAreaLightHelper.prototype=Object.create(Line.prototype),RectAreaLightHelper.prototype.constructor=RectAreaLightHelper,RectAreaLightHelper.prototype.update=function(){if(this.scale.set(.5*this.light.width,.5*this.light.height,1),void 0!==this.color)this.material.color.set(this.color),this.children[0].material.color.set(this.color);else{this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity);var e=this.material.color,t=Math.max(e.r,e.g,e.b);t>1&&e.multiplyScalar(1/t),this.children[0].material.color.copy(this.material.color)}},RectAreaLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()},SpotLightHelper.prototype=Object.create(Object3D.prototype),SpotLightHelper.prototype.constructor=SpotLightHelper,SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},SpotLightHelper.prototype.update=function(){var e=new Vector3;return function(){this.light.updateMatrixWorld();var t=this.light.distance?this.light.distance:1e3,r=t*Math.tan(this.light.angle);this.cone.scale.set(r,r,t),e.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(e),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}(),VertexNormalsHelper.prototype=Object.create(LineSegments.prototype),VertexNormalsHelper.prototype.constructor=VertexNormalsHelper,VertexNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Matrix3;return function(){var n=["a","b","c"];this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);var o=this.object.matrixWorld,l=this.geometry.attributes.position,c=this.object.geometry;if(c&&c.isGeometry)for(var h=c.vertices,d=c.faces,f=0,i=0,m=d.length;i<m;i++)for(var v=d[i],y=0,x=v.vertexNormals.length;y<x;y++){var w=h[v[n[y]]],M=v.vertexNormals[y];e.copy(w).applyMatrix4(o),t.copy(M).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),l.setXYZ(f,e.x,e.y,e.z),f+=1,l.setXYZ(f,t.x,t.y,t.z),f+=1}else if(c&&c.isBufferGeometry){var S=c.attributes.position,A=c.attributes.normal;for(f=0,y=0,x=S.count;y<x;y++)e.set(S.getX(y),S.getY(y),S.getZ(y)).applyMatrix4(o),t.set(A.getX(y),A.getY(y),A.getZ(y)),t.applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),l.setXYZ(f,e.x,e.y,e.z),f+=1,l.setXYZ(f,t.x,t.y,t.z),f+=1}l.needsUpdate=!0}}(),RectAreaLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:RectAreaLight,isRectAreaLight:!0,copy:function(source){return Light.prototype.copy.call(this,source),this.width=source.width,this.height=source.height,this},toJSON:function(meta){var data=Light.prototype.toJSON.call(this,meta);return data.object.width=this.width,data.object.height=this.height,data}}),Object.assign(AnimationLoader.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n)},parse:function(e,t){for(var r=[],i=0;i<e.length;i++){var n=AnimationClip.parse(e[i]);r.push(n)}t(r)},setPath:function(e){return this.path=e,this}}),Object.assign(AudioLoader.prototype,{load:function(e,t,r,n){var o=new FileLoader(this.manager);o.setResponseType("arraybuffer"),o.setPath(this.path),o.load(e,(function(e){var r=e.slice(0);AudioContext.getContext().decodeAudioData(r,(function(e){t(e)}))}),r,n)},setPath:function(e){return this.path=e,this}}),Object.assign(BufferGeometryLoader.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(o.manager);l.setPath(o.path),l.load(e,(function(text){t(o.parse(JSON.parse(text)))}),r,n)},parse:function(e){var t=new BufferGeometry,r=e.data.index;if(void 0!==r){var n=new TYPED_ARRAYS[r.type](r.array);t.setIndex(new BufferAttribute(n,1))}var o=e.data.attributes;for(var l in o){var c=o[l],h=new BufferAttribute(n=new TYPED_ARRAYS[c.type](c.array),c.itemSize,c.normalized);void 0!==c.name&&(h.name=c.name),t.addAttribute(l,h)}var d=e.data.morphAttributes;if(d)for(var l in d){for(var f=d[l],m=[],i=0,v=f.length;i<v;i++){c=f[i],h=new BufferAttribute(n=new TYPED_ARRAYS[c.type](c.array),c.itemSize,c.normalized);void 0!==c.name&&(h.name=c.name),m.push(h)}t.morphAttributes[l]=m}var y=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==y){i=0;for(var x=y.length;i!==x;++i){var w=y[i];t.addGroup(w.start,w.count,w.materialIndex)}}var M=e.data.boundingSphere;if(void 0!==M){var S=new Vector3;void 0!==M.center&&S.fromArray(M.center),t.boundingSphere=new Sphere(S,M.radius)}return e.name&&(t.name=e.name),e.userData&&(t.userData=e.userData),t},setPath:function(e){return this.path=e,this}});var TYPED_ARRAYS={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array},matrixPosition;function CubeTextureLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function FontLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager}function ImageBitmapLoader(e){"undefined"==typeof createImageBitmap&&console.warn("ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("ImageBitmapLoader: fetch() not supported."),this.manager=void 0!==e?e:DefaultLoadingManager,this.options=void 0}function LOD(){Object3D.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function Fog(e,t,r){this.name="",this.color=new Color(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3}function FogExp2(e,t){this.name="",this.color=new Color(e),this.density=void 0!==t?t:25e-5}Object.assign(CubeTextureLoader.prototype,{crossOrigin:"anonymous",load:function(e,t,r,n){var o=new CubeTexture,l=new ImageLoader(this.manager);l.setCrossOrigin(this.crossOrigin),l.setPath(this.path);var c=0;function h(i){l.load(e[i],(function(image){o.images[i]=image,6===++c&&(o.needsUpdate=!0,t&&t(o))}),void 0,n)}for(var i=0;i<e.length;++i)h(i);return o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(FontLoader.prototype,{load:function(e,t,r,n){var o=this,l=new FileLoader(this.manager);l.setPath(this.path),l.load(e,(function(text){var e;try{e=JSON.parse(text)}catch(t){console.warn("FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),e=JSON.parse(text.substring(65,text.length-2))}var r=o.parse(e);t&&t(r)}),r,n)},parse:function(e){return new Font(e)},setPath:function(e){return this.path=e,this}}),ImageBitmapLoader.prototype={constructor:ImageBitmapLoader,setOptions:function(e){return this.options=e,this},load:function(e,t,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var o=this,l=Cache.get(e);if(void 0!==l)return o.manager.itemStart(e),setTimeout((function(){t&&t(l),o.manager.itemEnd(e)}),0),l;fetch(e).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,o.options)})).then((function(r){Cache.add(e,r),t&&t(r),o.manager.itemEnd(e)})).catch((function(t){n&&n(t),o.manager.itemError(e),o.manager.itemEnd(e)})),o.manager.itemStart(e)},setCrossOrigin:function(){return this},setPath:function(e){return this.path=e,this}},LOD.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LOD,copy:function(source){Object3D.prototype.copy.call(this,source,!1);for(var e=source.levels,i=0,t=e.length;i<t;i++){var r=e[i];this.addLevel(r.object.clone(),r.distance)}return this},addLevel:function(object,e){void 0===e&&(e=0),e=Math.abs(e);for(var t=this.levels,r=0;r<t.length&&!(e<t[r].distance);r++);t.splice(r,0,{distance:e,object:object}),this.add(object)},getObjectForDistance:function(e){for(var t=this.levels,i=1,r=t.length;i<r&&!(e<t[i].distance);i++);return t[i-1].object},raycast:(matrixPosition=new Vector3,function(e,t){matrixPosition.setFromMatrixPosition(this.matrixWorld);var r=e.ray.origin.distanceTo(matrixPosition);this.getObjectForDistance(r).raycast(e,t)}),update:function(){var e=new Vector3,t=new Vector3;return function(r){var n=this.levels;if(n.length>1){e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var o=e.distanceTo(t);n[0].object.visible=!0;for(var i=1,l=n.length;i<l&&o>=n[i].distance;i++)n[i-1].object.visible=!1,n[i].object.visible=!0;for(;i<l;i++)n[i].object.visible=!1}}}(),toJSON:function(meta){var data=Object3D.prototype.toJSON.call(this,meta);data.object.levels=[];for(var e=this.levels,i=0,t=e.length;i<t;i++){var r=e[i];data.object.levels.push({object:r.object.uuid,distance:r.distance})}return data}}),Object.assign(Fog.prototype,{isFog:!0,clone:function(){return new Fog(this.color,this.near,this.far)},toJSON:function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}),Object.assign(FogExp2.prototype,{isFogExp2:!0,clone:function(){return new FogExp2(this.color,this.density)},toJSON:function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}});var Geometries={WireframeGeometry:WireframeGeometry,TetrahedronGeometry:TetrahedronGeometry,TetrahedronBufferGeometry:TetrahedronBufferGeometry,OctahedronGeometry:OctahedronGeometry,OctahedronBufferGeometry:OctahedronBufferGeometry,IcosahedronGeometry:IcosahedronGeometry,IcosahedronBufferGeometry:IcosahedronBufferGeometry,DodecahedronGeometry:DodecahedronGeometry,DodecahedronBufferGeometry:DodecahedronBufferGeometry,PolyhedronGeometry:PolyhedronGeometry,PolyhedronBufferGeometry:PolyhedronBufferGeometry,TubeGeometry:TubeGeometry,TubeBufferGeometry:TubeBufferGeometry,TorusKnotGeometry:TorusKnotGeometry,TorusGeometry:TorusGeometry,TorusBufferGeometry:TorusBufferGeometry,TextGeometry:TextGeometry,TextBufferGeometry:TextBufferGeometry,SphereGeometry:SphereGeometry,SphereBufferGeometry:SphereBufferGeometry,RingGeometry:RingGeometry,RingBufferGeometry:RingBufferGeometry,PlaneGeometry:PlaneGeometry,PlaneBufferGeometry:PlaneBufferGeometry,LatheGeometry:LatheGeometry,LatheBufferGeometry:LatheBufferGeometry,ShapeGeometry:ShapeGeometry,ShapeBufferGeometry:ShapeBufferGeometry,ExtrudeGeometry:ExtrudeGeometry,ExtrudeBufferGeometry:ExtrudeBufferGeometry,EdgesGeometry:EdgesGeometry,ConeGeometry:ConeGeometry,ConeBufferGeometry:ConeBufferGeometry,CylinderGeometry:CylinderGeometry,CylinderBufferGeometry:CylinderBufferGeometry,CircleGeometry:CircleGeometry,CircleBufferGeometry:CircleBufferGeometry,BoxGeometry:BoxGeometry,BoxBufferGeometry:BoxBufferGeometry};function ObjectLoader(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.resourcePath=""}Object.assign(ObjectLoader.prototype,{crossOrigin:"anonymous",load:function(e,t,r,n){var o=this,path=void 0===this.path?LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||path;var l=new FileLoader(o.manager);l.setPath(this.path),l.load(e,(function(text){var r=null;try{r=JSON.parse(text)}catch(t){return void 0!==n&&n(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var l=r.metadata;void 0!==l&&void 0!==l.type&&"geometry"!==l.type.toLowerCase()?o.parse(r,t):console.error("ObjectLoader: Can't load "+e)}),r,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){var r=this.parseShape(e.shapes),n=this.parseGeometries(e.geometries,r),o=this.parseImages(e.images,(function(){void 0!==t&&t(object)})),l=this.parseTextures(e.textures,o),c=this.parseMaterials(e.materials,l),object=this.parseObject(e.object,n,c);return e.animations&&(object.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(object),object},parseShape:function(e){var t={};if(void 0!==e)for(var i=0,r=e.length;i<r;i++){var n=(new Shape).fromJSON(e[i]);t[n.uuid]=n}return t},parseGeometries:function(e,t){var r={};if(void 0!==e)for(var n=new BufferGeometryLoader,i=0,o=e.length;i<o;i++){var l,data=e[i];switch(data.type){case"PlaneGeometry":case"PlaneBufferGeometry":l=new Geometries[data.type](data.width,data.height,data.widthSegments,data.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":l=new Geometries[data.type](data.width,data.height,data.depth,data.widthSegments,data.heightSegments,data.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":l=new Geometries[data.type](data.radius,data.segments,data.thetaStart,data.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":l=new Geometries[data.type](data.radiusTop,data.radiusBottom,data.height,data.radialSegments,data.heightSegments,data.openEnded,data.thetaStart,data.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":l=new Geometries[data.type](data.radius,data.height,data.radialSegments,data.heightSegments,data.openEnded,data.thetaStart,data.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":l=new Geometries[data.type](data.radius,data.widthSegments,data.heightSegments,data.phiStart,data.phiLength,data.thetaStart,data.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":l=new Geometries[data.type](data.radius,data.detail);break;case"RingGeometry":case"RingBufferGeometry":l=new Geometries[data.type](data.innerRadius,data.outerRadius,data.thetaSegments,data.phiSegments,data.thetaStart,data.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":l=new Geometries[data.type](data.radius,data.tube,data.radialSegments,data.tubularSegments,data.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":l=new Geometries[data.type](data.radius,data.tube,data.tubularSegments,data.radialSegments,data.p,data.q);break;case"TubeGeometry":case"TubeBufferGeometry":l=new Geometries[data.type]((new Curves[data.path.type]).fromJSON(data.path),data.tubularSegments,data.radius,data.radialSegments,data.closed);break;case"LatheGeometry":case"LatheBufferGeometry":l=new Geometries[data.type](data.points,data.segments,data.phiStart,data.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":l=new Geometries[data.type](data.vertices,data.indices,data.radius,data.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":for(var c=[],h=0,d=data.shapes.length;h<d;h++){var f=t[data.shapes[h]];c.push(f)}l=new Geometries[data.type](c,data.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":for(c=[],h=0,d=data.shapes.length;h<d;h++){f=t[data.shapes[h]];c.push(f)}var m=data.options.extrudePath;void 0!==m&&(data.options.extrudePath=(new Curves[m.type]).fromJSON(m)),l=new Geometries[data.type](c,data.options);break;case"BufferGeometry":l=n.parse(data);break;case"Geometry":if("THREE"in window&&"LegacyJSONLoader"in THREE)l=(new LegacyJSONLoader).parse(data,this.resourcePath).geometry;else console.error('ObjectLoader: You have to import LegacyJSONLoader in order load geometry data of type "Geometry".');break;default:console.warn('ObjectLoader: Unsupported geometry type "'+data.type+'"');continue}l.uuid=data.uuid,void 0!==data.name&&(l.name=data.name),!0===l.isBufferGeometry&&void 0!==data.userData&&(l.userData=data.userData),r[data.uuid]=l}return r},parseMaterials:function(e,t){var r={},n={};if(void 0!==e){var o=new MaterialLoader;o.setTextures(t);for(var i=0,l=e.length;i<l;i++){var data=e[i];if("MultiMaterial"===data.type){for(var c=[],h=0;h<data.materials.length;h++){var d=data.materials[h];void 0===r[d.uuid]&&(r[d.uuid]=o.parse(d)),c.push(r[d.uuid])}n[data.uuid]=c}else void 0===r[data.uuid]&&(r[data.uuid]=o.parse(data)),n[data.uuid]=r[data.uuid]}}return n},parseAnimations:function(e){for(var t=[],i=0;i<e.length;i++){var data=e[i],r=AnimationClip.parse(data);void 0!==data.uuid&&(r.uuid=data.uuid),t.push(r)}return t},parseImages:function(e,t){var r=this,n={};function o(e){return r.manager.itemStart(e),l.load(e,(function(){r.manager.itemEnd(e)}),void 0,(function(){r.manager.itemError(e),r.manager.itemEnd(e)}))}if(void 0!==e&&e.length>0){var l=new ImageLoader(new LoadingManager(t));l.setCrossOrigin(this.crossOrigin);for(var i=0,c=e.length;i<c;i++){var image=e[i],h=image.url;if(Array.isArray(h)){n[image.uuid]=[];for(var d=0,f=h.length;d<f;d++){var m=h[d],path=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(m)?m:r.resourcePath+m;n[image.uuid].push(o(path))}}else{path=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(image.url)?image.url:r.resourcePath+image.url;n[image.uuid]=o(path)}}}return n},parseTextures:function(e,t){function r(e,t){return"number"==typeof e?e:(console.warn("ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var n={};if(void 0!==e)for(var i=0,o=e.length;i<o;i++){var l,data=e[i];void 0===data.image&&console.warn('ObjectLoader: No "image" specified for',data.uuid),void 0===t[data.image]&&console.warn("ObjectLoader: Undefined image",data.image),(l=Array.isArray(t[data.image])?new CubeTexture(t[data.image]):new Texture(t[data.image])).needsUpdate=!0,l.uuid=data.uuid,void 0!==data.name&&(l.name=data.name),void 0!==data.mapping&&(l.mapping=r(data.mapping,TEXTURE_MAPPING)),void 0!==data.offset&&l.offset.fromArray(data.offset),void 0!==data.repeat&&l.repeat.fromArray(data.repeat),void 0!==data.center&&l.center.fromArray(data.center),void 0!==data.rotation&&(l.rotation=data.rotation),void 0!==data.wrap&&(l.wrapS=r(data.wrap[0],TEXTURE_WRAPPING),l.wrapT=r(data.wrap[1],TEXTURE_WRAPPING)),void 0!==data.format&&(l.format=data.format),void 0!==data.type&&(l.type=data.type),void 0!==data.encoding&&(l.encoding=data.encoding),void 0!==data.minFilter&&(l.minFilter=r(data.minFilter,TEXTURE_FILTER)),void 0!==data.magFilter&&(l.magFilter=r(data.magFilter,TEXTURE_FILTER)),void 0!==data.anisotropy&&(l.anisotropy=data.anisotropy),void 0!==data.flipY&&(l.flipY=data.flipY),void 0!==data.premultiplyAlpha&&(l.premultiplyAlpha=data.premultiplyAlpha),void 0!==data.unpackAlignment&&(l.unpackAlignment=data.unpackAlignment),n[data.uuid]=l}return n},parseObject:function(data,e,t){var object;function r(t){return void 0===e[t]&&console.warn("ObjectLoader: Undefined geometry",t),e[t]}function n(e){if(void 0!==e){if(Array.isArray(e)){for(var r=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===t[o]&&console.warn("ObjectLoader: Undefined material",o),r.push(t[o])}return r}return void 0===t[e]&&console.warn("ObjectLoader: Undefined material",e),t[e]}}switch(data.type){case"Scene":object=new Scene,void 0!==data.background&&Number.isInteger(data.background)&&(object.background=new Color(data.background)),void 0!==data.fog&&("Fog"===data.fog.type?object.fog=new Fog(data.fog.color,data.fog.near,data.fog.far):"FogExp2"===data.fog.type&&(object.fog=new FogExp2(data.fog.color,data.fog.density)));break;case"PerspectiveCamera":object=new PerspectiveCamera(data.fov,data.aspect,data.near,data.far),void 0!==data.focus&&(object.focus=data.focus),void 0!==data.zoom&&(object.zoom=data.zoom),void 0!==data.filmGauge&&(object.filmGauge=data.filmGauge),void 0!==data.filmOffset&&(object.filmOffset=data.filmOffset),void 0!==data.view&&(object.view=Object.assign({},data.view));break;case"OrthographicCamera":object=new OrthographicCamera(data.left,data.right,data.top,data.bottom,data.near,data.far),void 0!==data.zoom&&(object.zoom=data.zoom),void 0!==data.view&&(object.view=Object.assign({},data.view));break;case"AmbientLight":object=new AmbientLight(data.color,data.intensity);break;case"DirectionalLight":object=new DirectionalLight(data.color,data.intensity);break;case"PointLight":object=new PointLight(data.color,data.intensity,data.distance,data.decay);break;case"RectAreaLight":object=new RectAreaLight(data.color,data.intensity,data.width,data.height);break;case"SpotLight":object=new SpotLight(data.color,data.intensity,data.distance,data.angle,data.penumbra,data.decay);break;case"HemisphereLight":object=new HemisphereLight(data.color,data.groundColor,data.intensity);break;case"SkinnedMesh":console.warn("ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var o=r(data.geometry),l=n(data.material);object=o.bones&&o.bones.length>0?new SkinnedMesh(o,l):new Mesh(o,l),void 0!==data.drawMode&&object.setDrawMode(data.drawMode);break;case"LOD":object=new LOD;break;case"Line":object=new Line(r(data.geometry),n(data.material),data.mode);break;case"LineLoop":object=new LineLoop(r(data.geometry),n(data.material));break;case"LineSegments":object=new LineSegments(r(data.geometry),n(data.material));break;case"PointCloud":case"Points":object=new Points(r(data.geometry),n(data.material));break;case"Sprite":object=new Sprite(n(data.material));break;case"Group":object=new Group;break;default:object=new Object3D}if(object.uuid=data.uuid,void 0!==data.name&&(object.name=data.name),void 0!==data.matrix?(object.matrix.fromArray(data.matrix),void 0!==data.matrixAutoUpdate&&(object.matrixAutoUpdate=data.matrixAutoUpdate),object.matrixAutoUpdate&&object.matrix.decompose(object.position,object.quaternion,object.scale)):(void 0!==data.position&&object.position.fromArray(data.position),void 0!==data.rotation&&object.rotation.fromArray(data.rotation),void 0!==data.quaternion&&object.quaternion.fromArray(data.quaternion),void 0!==data.scale&&object.scale.fromArray(data.scale)),void 0!==data.castShadow&&(object.castShadow=data.castShadow),void 0!==data.receiveShadow&&(object.receiveShadow=data.receiveShadow),data.shadow&&(void 0!==data.shadow.bias&&(object.shadow.bias=data.shadow.bias),void 0!==data.shadow.radius&&(object.shadow.radius=data.shadow.radius),void 0!==data.shadow.mapSize&&object.shadow.mapSize.fromArray(data.shadow.mapSize),void 0!==data.shadow.camera&&(object.shadow.camera=this.parseObject(data.shadow.camera))),void 0!==data.visible&&(object.visible=data.visible),void 0!==data.frustumCulled&&(object.frustumCulled=data.frustumCulled),void 0!==data.renderOrder&&(object.renderOrder=data.renderOrder),void 0!==data.userData&&(object.userData=data.userData),void 0!==data.layers&&(object.layers.mask=data.layers),void 0!==data.children)for(var c=data.children,i=0;i<c.length;i++)object.add(this.parseObject(c[i],e,t));if("LOD"===data.type)for(var h=data.levels,d=0;d<h.length;d++){var f=h[d],m=object.getObjectByProperty("uuid",f.object);void 0!==m&&object.addLevel(m,f.distance)}return object}});var TEXTURE_MAPPING={UVMapping:UVMapping,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,SphericalReflectionMapping:SphericalReflectionMapping,CubeUVReflectionMapping:CubeUVReflectionMapping,CubeUVRefractionMapping:CubeUVRefractionMapping},TEXTURE_WRAPPING={RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MirroredRepeatWrapping:MirroredRepeatWrapping},TEXTURE_FILTER={NearestFilter:NearestFilter,NearestMipMapNearestFilter:NearestMipMapNearestFilter,NearestMipMapLinearFilter:NearestMipMapLinearFilter,LinearFilter:LinearFilter,LinearMipMapNearestFilter:LinearMipMapNearestFilter,LinearMipMapLinearFilter:LinearMipMapLinearFilter};function MeshMatcapMaterial(e){Material$1.call(this),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Color(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.lights=!1,this.setValues(e)}function Cylindrical(e,t,r){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==r?r:0,this}function WebGL2Renderer(e){console.log("WebGL2Renderer",REVISION);var t,r=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),n=void 0!==e.context?e.context:null,o=void 0!==e.alpha&&e.alpha,l=void 0===e.depth||e.depth,c=void 0===e.stencil||e.stencil,h=void 0!==e.antialias&&e.antialias,d=void 0===e.premultipliedAlpha||e.premultipliedAlpha,f=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,m=void 0!==e.powerPreference?e.powerPreference:"default";try{var v={alpha:o,depth:l,stencil:c,antialias:h,premultipliedAlpha:d,preserveDrawingBuffer:f,powerPreference:m};if(r.addEventListener("webglcontextlost",(function(e){e.preventDefault()}),!1),r.addEventListener("webglcontextrestored",(function(){})),null===(t=n||r.getContext("webgl2",v)))throw null!==r.getContext("webgl2")?new Error("Error creating WebGL2 context with your selected attributes."):new Error("Error creating WebGL2 context.")}catch(e){console.error("WebGL2Renderer: "+e.message)}var y=!0,x=!0,w=!0,M=new Color(0),S=0,A=r.width,T=r.height,_=1,L=new Vector4(0,0,A,T),C=new WebGLExtensions(t),N=new WebGLState(t,C,(function(){}));function P(e,t,n){A=e,T=t,r.width=e*_,r.height=t*_,!1!==n&&(r.style.width=e+"px",r.style.height=t+"px"),function(e,t,r,n){N.viewport(L.set(e,t,r,n))}(0,0,e,t)}return{domElement:r,clear:function(e,r,n){var o=0;(void 0===e||e)&&(o|=t.COLOR_BUFFER_BIT),(void 0===r||r)&&(o|=t.DEPTH_BUFFER_BIT),(void 0===n||n)&&(o|=t.STENCIL_BUFFER_BIT),t.clear(o)},setPixelRatio:function(e){void 0!==e&&(_=e,P(L.z,L.w,!1))},setSize:P,render:function(e,t){if(void 0===t||!0===t.isCamera){var r=e.background;null===r?N.buffers.color.setClear(M.r,M.g,M.b,S,d):r&&r.isColor&&N.buffers.color.setClear(r.r,r.g,r.b,1,d),this.clear(y,x,w)}else console.error("WebGL2Renderer.render: camera is not an instance of Camera.")}}}function WebGLMultisampleRenderTarget(e,t,r){WebGLRenderTarget.call(this,e,t,r),this.samples=4}function VideoTexture(video,e,t,r,n,o,l,c,h){Texture.call(this,video,e,t,r,n,o,l,c,h),this.format=void 0!==l?l:RGBFormat,this.minFilter=void 0!==o?o:LinearFilter,this.magFilter=void 0!==n?n:LinearFilter,this.generateMipmaps=!1}MeshMatcapMaterial.prototype=Object.create(Material$1.prototype),MeshMatcapMaterial.prototype.constructor=MeshMatcapMaterial,MeshMatcapMaterial.prototype.isMeshMatcapMaterial=!0,MeshMatcapMaterial.prototype.copy=function(source){return Material$1.prototype.copy.call(this,source),this.defines={MATCAP:""},this.color.copy(source.color),this.matcap=source.matcap,this.map=source.map,this.bumpMap=source.bumpMap,this.bumpScale=source.bumpScale,this.normalMap=source.normalMap,this.normalMapType=source.normalMapType,this.normalScale.copy(source.normalScale),this.displacementMap=source.displacementMap,this.displacementScale=source.displacementScale,this.displacementBias=source.displacementBias,this.alphaMap=source.alphaMap,this.skinning=source.skinning,this.morphTargets=source.morphTargets,this.morphNormals=source.morphNormals,this},Object.assign(Cylindrical.prototype,{set:function(e,t,r){return this.radius=e,this.theta=t,this.y=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.setFromCartesianCoords(e.x,e.y,e.z)},setFromCartesianCoords:function(e,t,r){return this.radius=Math.sqrt(e*e+r*r),this.theta=Math.atan2(e,r),this.y=t,this}}),WebGLMultisampleRenderTarget.prototype=Object.assign(Object.create(WebGLRenderTarget.prototype),{constructor:WebGLMultisampleRenderTarget,isWebGLMultisampleRenderTarget:!0,copy:function(source){return WebGLRenderTarget.prototype.copy.call(this,source),this.samples=source.samples,this}}),VideoTexture.prototype=Object.assign(Object.create(Texture.prototype),{constructor:VideoTexture,isVideoTexture:!0,update:function(){var video=this.image;video.readyState>=video.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}})}}]);